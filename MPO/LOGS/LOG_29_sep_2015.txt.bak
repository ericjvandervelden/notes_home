/ DSVSOL-2719 

/ 7	. 

[eric@localhost bin]$ cat dsvfms-ssh-a.sh 
#!/bin/bash
echo 'h^Zgcyr&Q'
ssh vanderveldene@application-a.intermax.mp-objects.com

[eric@localhost bin]$ cat dsvfms-ssh-t.sh 
#!/bin/bash
echo 'Eric456@MPO'
ssh mposerv11 

[eric@localhost bin]$ cat dsvfms-ssh-db-a.sh
#!/bin/bash
echo 'h^Zgcyr&Q'
ssh vanderveldene@database-a.intermax.mp-objects.com

[eric@localhost bin]$ cat dsvfms-db-a.sh
#!/bin/bash
isql-fb -u sysdba -p +qjweLrf database-a.intermax.mp-objects.com:/local/apps/firebird/dsvfms.fdb


/ 7	. 

/ backup db on acceptance	,

[vanderveldene@application-a dsvfms]$ pwd
/local/apps/jboss-4.0.5.GA/server/dsvfms
[vanderveldene@application-a dsvfms]$ less deploy/firebird-ds.xml 
<datasources>
   <local-tx-datasource>
     <jndi-name>tmsdevDS</jndi-name>
     <connection-url>jdbc:firebirdsql://192.168.173.20//local/apps/firebird/dsvfms.fdb?defaultResultSetHoldable=true&amp;columnLabelForName=true</connection-url>
     <user-name>SYSDBA</user-name>
     <password>+qjweLrf</password>

/ Dit is database-a.intermax.mp-objects.com	,

/ 7	. 


/ TODO (Kan niet login op database-a)	,
[eric@localhost bin]$ cat dsvfms-scp-from-db-a.sh 
#!/usr/bin/bash
# $@=dsvfms.fdb_20150930-002854.fbk.gz
echo "h^Zgcyr&Q"
scp "vanderveldene@database-a.intermax.mp-objects.com:/backup/mpo-backup/db/$@" /home/eric/DB_TAP/Dsvfms/

[eric@localhost bin]$ dsvfms-scp-from-db-a.sh dsvfms.fdb_20151005-003448.fbk.gz
h^Zgcyr&Q
Password: 
/ OK

[eric@localhost bin]$ cat dsvfms-scp-to-db-t.sh
#!/usr/bin/bash
# $@=dsvfms.fdb_20150930-002854.fbk.gz
scp "/home/eric/DB_TAP/Dsvfms/$@" "eric@mposerv8:"

[eric@localhost bin]$ dsvfms-scp-to-db-t.sh dsvfms.fdb_20150930-002854.fbk.gz

/ Lees onze wiki	, 
Database maintenance

[eric@localhost bin]$ dsvfms-ssh-db-t.sh 
Eric456@MPO
eric@mposerv8:~$ gunzip dsvfms.fdb_20150930-002854.fbk.gz  

/ 13. 

/ Let op	,

/ verschillende passwords op mposerv8 en database-a

jboss@mposerv11:~$ less /local/apps/jboss-4.0.5.GA/server/dsvfms/deploy/firebird-ds.xml 
 <datasources>
   <local-tx-datasource>
     <connection-url>jdbc:firebirdsql://192.168.1.8//local/apps/firebird/dsvfms.fdb?no_result_set_tracking&amp;defaultResultSetHoldable=true</connection-url>
     <user-name>SYSDBA</user-name>
     <password>masterkey</password>

[vanderveldene@application-a ~]$ less /local/apps/jboss-4.0.5.GA/server/dsvfms/deploy/firebird-ds.xml 
 <datasources>
   <local-tx-datasource>
     <connection-url>jdbc:firebirdsql://192.168.173.20//local/apps/firebird/dsvfms.fdb?defaultResultSetHoldable=true&amp;columnLabelForName=true</connection-url>
     <user-name>SYSDBA</user-name>
     <password>+qjweLrf</password>

/ vergeet niet forticlient te start als we 
[eric@localhost bin]$ dsvfms-db-a.sh 


/ we stop dsvfms op test	,

[eric@localhost bin]$ dsvfms-ssh-t.sh 
Eric456@MPO
eric@mposerv11:~$ sudo su - jboss
jboss@mposerv11:~$ dsvfms stop

/ op database server	,
eric@mposerv8:~$ gbak -rep -user sysdba -password masterkey dsvfms.fdb_20150930-002854.fbk localhost://local/apps/firebird/dsvfms.fdb 

/ we krijgen ERR	,
gbak: ERROR:validation error for column FINANCIAL_PARTY_SYSTEMID, value "*** null ***"
gbak: ERROR:warning -- record could not be restored

/ 7	. 

/ Intermezzo

http://www.firebirdfaq.org/faq174/

/ 13	. 

/ show al onze tables	, 

SQL> show table rdb$relations;
RDB$VIEW_BLR                    (RDB$VIEW_BLR) BLOB segment 80, subtype BLR Nullable 
RDB$VIEW_SOURCE                 (RDB$SOURCE) BLOB segment 80, subtype TEXT CHARACTER SET UNICODE_FSS Nullable 
RDB$DESCRIPTION                 (RDB$DESCRIPTION) BLOB segment 80, subtype TEXT CHARACTER SET UNICODE_FSS Nullable 
RDB$RELATION_ID                 (RDB$RELATION_ID) SMALLINT Nullable 
RDB$SYSTEM_FLAG                 (RDB$SYSTEM_FLAG) SMALLINT Nullable 
RDB$DBKEY_LENGTH                (RDB$DBKEY_LENGTH) SMALLINT Nullable 
RDB$FORMAT                      (RDB$FORMAT) SMALLINT Nullable 
RDB$FIELD_ID                    (RDB$FIELD_ID) SMALLINT Nullable 
RDB$RELATION_NAME               (RDB$RELATION_NAME) CHAR(31) CHARACTER SET UNICODE_FSS Nullable 
RDB$SECURITY_CLASS              (RDB$SECURITY_CLASS) CHAR(31) CHARACTER SET UNICODE_FSS Nullable 
RDB$EXTERNAL_FILE               (RDB$FILE_NAME) VARCHAR(255) Nullable 
RDB$RUNTIME                     (RDB$RUNTIME) BLOB segment 80, subtype SUMMARY Nullable 
RDB$EXTERNAL_DESCRIPTION        (RDB$EXTERNAL_DESCRIPTION) BLOB segment 80, subtype EXTERNAL_FILE_DESCRIPTION Nullable 
RDB$OWNER_NAME                  (RDB$USER) CHAR(31) CHARACTER SET UNICODE_FSS Nullable 
RDB$DEFAULT_CLASS               (RDB$SECURITY_CLASS) CHAR(31) CHARACTER SET UNICODE_FSS Nullable 
RDB$FLAGS                       (RDB$SYSTEM_FLAG) SMALLINT Nullable 
RDB$RELATION_TYPE               (RDB$RELATION_TYPE) SMALLINT Nullable 

/ met rdb$system_flag krijgen we alle system tables of niet	, 


/ alle system tables	, 
SQL> select rdb$relation_name from rdb$relations where rdb$system_flag=1;

RDB$RELATION_NAME                                                                             
=============================================================================== 
RDB$PAGES                                                                                     
RDB$DATABASE                                                                                  
RDB$FIELDS                                                                                    
...
MON$CONTEXT_VARIABLES                                                                         
MON$MEMORY_USAGE                                                                              

/ alle tables	, 
SQL> select rdb$relation_name from rdb$relations where rdb$system_flag=0 and rdb$view_blr is null;

RDB$RELATION_NAME                                                                             
=============================================================================== 
KEY_GENERATOR                                                                                 
ORGANIZATION                                                                                  
PRICE_TYPE                                                                                    
TMS_USER                                                                                      
USER_ORGANIZATION                                                                             
TMS_ROLE                                                                                      
USER_ROLE                                                                                     
...

/ alle views	, 
SQL> select rdb$relation_name from rdb$relations where rdb$system_flag=0 and rdb$view_blr is not null;

RDB$RELATION_NAME                                                                             
=============================================================================== 
PRIVILEGE_VIEW                                                                                
RPT_PARTIES                                                                                   
RPT_SERVICE_ACTIONS                                                                           
RPT_PATH_CRITERIUM                                                                            
RPT_CONSIGNMENTS            
...

SQL> select r.rdb$relation_name  from rdb$relations r join rdb$relation_fields f on r.rdb$relation_name=f.rdb$relation_name where f.rdb$field_name='FINANCIAL_PARTY_SYSTEMID';

RDB$RELATION_NAME                                                                             
=============================================================================== 
INVOICE_HEADER                                                                                
FINANCIAL_PARTY_COST_TYPE                                                                     
INVOICE_FINANCIAL_PARTY_BINDING                                                               
PRICE_TYPE_TRANSLATION                                                                        
COST_TYPE_TRANSLATION   

SQL> show table invoice_header;
FINANCIAL_PARTY_SYSTEMID        INTEGER Nullable 
CONSTRAINT FK_COUNTRY_RECEIVER_FK:
CONSTRAINT FK_FINANCIAL_PARTY_SYSTEMID:
  Foreign key (FINANCIAL_PARTY_SYSTEMID)    References INVOICE_FINANCIAL_PARTY (SYSTEM_ID)

SQL> show table financial_party_cost_type;
FINANCIAL_PARTY_SYSTEMID        INTEGER Nullable 
CONSTRAINT UNQ_COST_TYPE_FINANCIAL:
  Unique key (FINANCIAL_PARTY_SYSTEMID, COST_TYPE_SYSTEMID)

SQL> show table invoice_financial_party_binding;
FINANCIAL_PARTY_SYSTEMID        INTEGER Not Null 
CONSTRAINT INVOICE_FPB_FP_FK:
  Foreign key (FINANCIAL_PARTY_SYSTEMID)    References INVOICE_FINANCIAL_PARTY (SYSTEM_ID)

SQL> show table price_type_translation;
FINANCIAL_PARTY_SYSTEMID        INTEGER Not Null 
CONSTRAINT FINANCIAL_PARTY_SYSTEMID_FK:
  Foreign key (FINANCIAL_PARTY_SYSTEMID)    References INVOICE_FINANCIAL_PARTY (SYSTEM_ID)

SQL> show table cost_type_translation;
FINANCIAL_PARTY_SYSTEMID        INTEGER Not Null 
CONSTRAINT FINANCIAL_PARTY_SYSTEMID_CTT_FK:
  Foreign key (FINANCIAL_PARTY_SYSTEMID)    References INVOICE_FINANCIAL_PARTY (SYSTEM_ID)

/ Einde Intermezzo

SQL> select count(*) from invoice_header  where financial_party_systemid is null;

       COUNT 
============ 
           0 
SQL> select count(*) from financial_party_cost_type  where financial_party_systemid is null;

       COUNT 
============ 
           0 
SQL> select count(*) from invoice_financial_party_binding  where financial_party_systemid is null;

       COUNT 
============ 
           0 
SQL> select count(*) from price_type_translation  where financial_party_systemid is null;

       COUNT 
============ 
           0 
SQL> select count(*) from cost_type_translation  where financial_party_systemid is null;

       COUNT 
============ 
           1 

SQL> select * from cost_type_translation  where financial_party_systemid is null;

   SYSTEM_ID TRANSLATION                      COST_TYPE_SYSTEMID FINANCIAL_PARTY_SYSTEMID 
============ ================================ ================== ======================== 
    26195454 B10                                         4125779                        0 

/ Dit is een vertaal tabel	, er verwijst naar	, 

SQL> select*from rate_component_type where system_id=4125779;

   SYSTEM_ID CODE                                               DESCRIPTION                                                                                          IS_DELETED REASON_MANDATORY  SEQUENCE_NR RCT_GROUP        
============ ================================================== =============================================================================== ========== ================ ============ ================ 
     4125779 FREIGHT                                            Freight                                                                                                       0                0            1 COST             

/ we rm deze entry	,

SQL> delete from cost_type_translation where system_id=26195454;
SQL> commit;

/ en we gaan een backup maken	,

 



/ Intermezzo

/ 13	. 

SQL> create table x(i int primary key);
SQL> show table x;
I                               INTEGER Not Null 
CONSTRAINT INTEG_9:
  Primary key (I)

SQL> create table x(i int);
QL> show table x;
I                               INTEGER Nullable 
SQL> alter table x add constraint i_pk primary key(i);
/ of	,
SQL> alter table x add constraint primary key(i);
unsuccessful metadata update
-Column: I not defined as NOT NULL - cannot be used in PRIMARY KEY constraint definition

/ als we constraint use	, dan moeten we ook een naam geven	, dus
SQL> alter table x add constraint primary key(i);
/ ERR

/ 13	. 

/ Lees	, 
http://www.firebirdsql.org/manual/nullguide-alter-pop-tables.html#nullguide-make-column-non-nullable
You cannot add NOT NULL to an existing column, but there's a simple workaround. Suppose the current type is int, then this:

/ Vanaf begin	, 
SQL> create table x (i int not null);
SQL> show table x;
I                               INTEGER Not Null 
SQL> alter table x add constraint i_pk primary key(i);
SQL> show table x;
I                               INTEGER Not Null 
CONSTRAINT I_PK:
  Primary key (I)

/ 13	. 

SQL> create table x(i int ,primary key(i));
SQL> show table x;
I                               INTEGER Not Null 
CONSTRAINT INTEG_14:
  Primary key (I)
SQL> insert into x values(7);
SQL> insert into x values(13);

SQL> create table xref(i int, r int,primary key(i), foreign key(r) references x(i));
/ OK
SQL> show table xref;
I                               INTEGER Not Null 
R                               INTEGER Nullable 
CONSTRAINT INTEG_13:
  Foreign key (R)    References X (I)
CONSTRAINT INTEG_12:
  Primary key (I)

SQL> insert into xref values(1,7);
SQL> insert into xref values(1,6);
Statement failed, SQLSTATE = 23000
violation of PRIMARY or UNIQUE KEY constraint "INTEG_12" on table "XREF"
SQL> insert into xref values(1,null);
Statement failed, SQLSTATE = 23000
violation of PRIMARY or UNIQUE KEY constraint "INTEG_12" on table "XREF"

SQL> drop table xref;
unsuccessful metadata update
-object XREF is in use
SQL> commit;
SQL> drop table xref;
SQL> drop table x;
/ OK

/ 13	. 

QL> create table x(i int ,primary key(i));
SQL> insert into x values(7);
SQL> create table xref(i int, r int,primary key(i));
SQL> show table xref;
I                               INTEGER Not Null 
R                               INTEGER Nullable 
CONSTRAINT INTEG_18:
  Primary key (I)
SQL> insert into xref values (1,7);
SQL> insert into xref values (2,null);
SQL> commit;
SQL> alter table xref add foreign key(r) references x(i);
SQL> select*from xref;

           I            R 
============ ============ 
           1            7 
           2       <null> 

SQL> show table xref;
I                               INTEGER Not Null 
R                               INTEGER Nullable 
CONSTRAINT INTEG_20:
  Foreign key (R)    References X (I)
CONSTRAINT INTEG_18:
  Primary key (I)

SQL> insert into xref values (3,null);
/ OK

/ constraint foreign key staat null toe,	

ALTER TABLE table_name MODIFY column_name datatype NOT NULL;

 
 










/ Einde Intermezzo



/ Einde DSVSOL-2719 

/ DSVSOL-2739

jboss@mposerv11:~$ dsvfms heapdump
jboss@mposerv11:~$ gzip dsvfms.20151016-103825.hprof 
jboss@mposerv11:~$ chmod o+r dsvfms.20151016-103825.hprof.gz 

/ we moeten o+r	, want dan kan eric vanaf laptop scp doen	,
[eric@localhost bin]$ scp eric@mposerv11:/home/jboss/dsvfms.20151016-103825.hprof.gz /home/eric/Downloads/
/ OK

/ we kunnen 	,
[eric@localhost bin]$ dsvfms-ssh-t.sh "sha1sum ~jboss/dsvfms.20151016-103825.hprof.gz"
eric@mposerv11's password: 
27ba19b1a7aea234183be4dbd52ec6e1bd1ad2d4  /home/jboss/dsvfms.20151016-103825.hprof.gz

/ en	,
[eric@localhost 2015.03]$ sha1sum ~/Downloads/dsvfms.20151016-103825.hprof.gz 
27ba19b1a7aea234183be4dbd52ec6e1bd1ad2d4  /home/eric/Downloads/dsvfms.20151016-103825.hprof.gz

/ waar	, 
[eric@localhost bin]$ cat dsvfms-ssh-t.sh 
#!/bin/bash
ssh mposerv11 "$@"

[eric@localhost lib]$ gunzip ~/Downloads/dsvfms.20151016-103825.hprof.gz 

/ we kunnen gunzip overal call	, de unzipped file verschijnt in dezelfde dir als waar hij was	, en vervangt de zip file ook	,

/ 13	. 

[eric@localhost 2015.03]$ sudo yum install visualvm

======================================================================================================================================
 Package                              Arch                 Version                                        Repository             Size
======================================================================================================================================
Installing:
 visualvm                             x86_64               1.3.3-1.3.7.fc20.1                             fedora                4.2 M
Installing for dependencies:
 bea-stax-api                         noarch               1.2.0-8.fc20                                   fedora                 31 k
 felix-bundlerepository               noarch               1.6.6-15.fc20                                  fedora                108 k
 felix-framework                      noarch               4.2.1-4.fc20                                   fedora                482 k
 felix-gogo-command                   noarch               0.12.0-9.fc20                                  fedora                 58 k
 felix-gogo-runtime                   noarch               0.10.0-10.fc20                                 fedora                 73 k
 felix-gogo-shell                     noarch               0.10.0-9.fc20                                  fedora                 56 k
 felix-main                           noarch               4.2.0-4.fc20                                   fedora                493 k
 felix-osgi-compendium                noarch               1.4.0-16.fc20                                  fedora                190 k
 felix-osgi-core                      noarch               1.4.0-14.fc20                                  fedora                 97 k
 felix-osgi-foundation                noarch               1.2.0-14.fc20                                  fedora                216 k
 felix-osgi-obr                       noarch               1.0.2-11.fc20                                  fedora                 23 k
 felix-shell                          noarch               1.4.3-4.fc20                                   fedora                 65 k
 felix-utils                          noarch               1.2.0-3.fc20                                   fedora                 67 k
 isorelax                             noarch               1:0-0.14.release20050331.fc20                  fedora                 75 k
 javahelp2                            noarch               2.0.05-15.fc20                                 fedora                552 k
 jna                                  x86_64               4.1.0-7.fc20                                   updates               199 k
 jna-contrib                          noarch               4.1.0-7.fc20                                   updates               584 k
 kxml                                 noarch               2.3.0-3.fc20                                   fedora                151 k
 msv-xsdlib                           noarch               1:2013.5.1-6.fc20                              fedora                219 k
 netbeans-platform                    x86_64               1:7.0.1-9.fc20                                 fedora                3.7 M
 relaxngDatatype                      noarch               1.0-11.5.fc20                                  fedora                 15 k
 stax2-api                            noarch               3.1.1-8.fc20                                   fedora                165 k
 swing-layout                         noarch               1.0.4-8.fc20                                   fedora                 71 k
 woodstox-core                        noarch               4.2.0-2.fc20                                   fedora                490 k
 xpp3                                 noarch               1.1.3.8-10.fc20                                fedora                336 k

/ Geef	,
[eric@localhost 2015.03]$ jvisualvm 
...

/ 13	. 


/ Lees	,
http://www.vogella.com/tutorials/EclipseMemoryAnalyzer/article.html

https://eclipse.org/mat/
/ click Getting Started	,
http://wiki.eclipse.org/index.php/MemoryAnalyzer
/ Click onder 'Getting Started', download page	,
http://www.eclipse.org/mat/downloads.php
/ we zien Stand-alone Eclipse RCP Applications	,
/ kies x86_64	,
[eric@localhost MemoryAnalyzer]$ pwd
/home/eric/Devel/Java/MemoryAnalyzer
[eric@localhost MemoryAnalyzer]$ unzip  ~/Downloads/MemoryAnalyzer-1.5.0.20150527-linux.gtk.x86_64.zip 

[eric@localhost mat]$ pwd
/home/eric/Devel/Java/MemoryAnalyzer/mat
[eric@localhost mat]$ cat MemoryAnalyzer.ini 
-Xmx4096m
[eric@localhost mat]$ ./MemoryAnalyzer 
/ click 'Open a heap dump'	,
/ Kies in ~/Downloads/ de .hprof file	,
/ Duurt lang de 1ste keer	,
/ check in nieuw window  'Leak Suspects Report'	,
/ we zien onder de chart 'Problem suspect 1'	, 
/ click Details	,
/ we zien 1 entry highlighted	, met Shallow heap 120	, de max WH	, Dubbel click	,
/ Kies Java basics, thread details,	
DeferredEventIdentifierCacheRefreshTaskTimerFactory
  at java.lang.Object.hashCode()I (Native Method)
  at java.util.HashMap.put(Ljava/lang/Object;Ljava/lang/Object;)Ljava/lang/Object; (HashMap.java:389)
  at java.util.HashSet.add(Ljava/lang/Object;)Z (HashSet.java:217)
  at org.hibernate.util.IdentityMap.entrySet()Ljava/util/Set; (IdentityMap.java:207)
  at org.hibernate.engine.BatchFetchQueue.getCollectionBatch(Lorg/hibernate/persister/collection/CollectionPersister;Ljava/io/Serializable;ILorg/hibernate/EntityMode;)[Ljava/io/Serializable; (BatchFetchQueue.java:178)
  at org.hibernate.loader.collection.BatchingCollectionInitializer.initialize(Ljava/io/Serializable;Lorg/hibernate/engine/SessionImplementor;)V (BatchingCollectionInitializer.java:73)
  at org.hibernate.persister.collection.AbstractCollectionPersister.initialize(Ljava/io/Serializable;Lorg/hibernate/engine/SessionImplementor;)V (AbstractCollectionPersister.java:627)
  at org.hibernate.event.def.DefaultInitializeCollectionEventListener.onInitializeCollection(Lorg/hibernate/event/InitializeCollectionEvent;)V (DefaultInitializeCollectionEventListener.java:83)
  at org.hibernate.impl.SessionImpl.initializeCollection(Lorg/hibernate/collection/PersistentCollection;Z)V (SessionImpl.java:1863)
  at org.hibernate.collection.AbstractPersistentCollection.forceInitialization()V (AbstractPersistentCollection.java:479)
  at org.hibernate.Hibernate.initialize(Ljava/lang/Object;)V (Hibernate.java:417)
  at org.springframework.orm.hibernate3.HibernateTemplate.initialize(Ljava/lang/Object;)V (HibernateTemplate.java:642)
  at com.mpobjects.event.dao.DeferredEventDAOImpl.findEventsByStatus(Lcom/mpobjects/event/model/DeferredEventStatus;)Ljava/util/List; (DeferredEventDAOImpl.java:67)
  at sun.reflect.NativeMethodAccessorImpl.invoke0(Ljava/lang/reflect/Method;Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object; (Native Method)
  at sun.reflect.NativeMethodAccessorImpl.invoke(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object; (NativeMethodAccessorImpl.java:57)
  at sun.reflect.DelegatingMethodAccessorImpl.invoke(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object; (DelegatingMethodAccessorImpl.java:43)
  at java.lang.reflect.Method.invoke(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object; (Method.java:622)
  at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(Ljava/lang/Object;Ljava/lang/reflect/Method;[Ljava/lang/Object;)Ljava/lang/Object; (AopUtils.java:317)
  at org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint()Ljava/lang/Object; (ReflectiveMethodInvocation.java:183)
  at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed()Ljava/lang/Object; (ReflectiveMethodInvocation.java:150)
  at org.springframework.aop.framework.adapter.MethodBeforeAdviceInterceptor.invoke(Lorg/aopalliance/intercept/MethodInvocation;)Ljava/lang/Object; (MethodBeforeAdviceInterceptor.java:51)
  at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed()Ljava/lang/Object; (ReflectiveMethodInvocation.java:161)
  at org.springframework.transaction.interceptor.TransactionInterceptor$1.proceedWithInvocation()Ljava/lang/Object; (TransactionInterceptor.java:96)
  at org.springframework.transaction.interceptor.TransactionAspectSupport.invokeWithinTransaction(Ljava/lang/reflect/Method;Ljava/lang/Class;Lorg/springframework/transaction/interceptor/TransactionAspectSupport$InvocationCallback;)Ljava/lang/Object; (TransactionAspectSupport.java:260)
  at org.springframework.transaction.interceptor.TransactionInterceptor.invoke(Lorg/aopalliance/intercept/MethodInvocation;)Ljava/lang/Object; (TransactionInterceptor.java:94)
  at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed()Ljava/lang/Object; (ReflectiveMethodInvocation.java:172)
  at org.springframework.aop.interceptor.ExposeInvocationInterceptor.invoke(Lorg/aopalliance/intercept/MethodInvocation;)Ljava/lang/Object; (ExposeInvocationInterceptor.java:91)
  at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed()Ljava/lang/Object; (ReflectiveMethodInvocation.java:172)
  at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(Ljava/lang/Object;Ljava/lang/reflect/Method;[Ljava/lang/Object;)Ljava/lang/Object; (JdkDynamicAopProxy.java:204)
  at com.sun.proxy.$Proxy369.findEventsByStatus(Lcom/mpobjects/event/model/DeferredEventStatus;)Ljava/util/List; (Unknown Source)
  at com.mpobjects.event.dao.DeferredEventIdentifierCache.initialize()V (DeferredEventIdentifierCache.java:78)
  at com.mpobjects.event.dao.DeferredEventIdentifierCache.<init>()V (DeferredEventIdentifierCache.java:36)
  at com.mpobjects.event.dao.DeferredEventIdentifierCache.getInstance()Lcom/mpobjects/event/dao/DeferredEventIdentifierCache; (DeferredEventIdentifierCache.java:41)
  at com.mpobjects.event.service.DeferredEventIdentifierCacheRefreshTask.run()V (DeferredEventIdentifierCacheRefreshTask.java:28)
  at sun.reflect.NativeMethodAccessorImpl.invoke0(Ljava/lang/reflect/Method;Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object; (Native Method)
  at sun.reflect.NativeMethodAccessorImpl.invoke(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object; (NativeMethodAccessorImpl.java:57)
  at sun.reflect.DelegatingMethodAccessorImpl.invoke(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object; (DelegatingMethodAccessorImpl.java:43)
  at java.lang.reflect.Method.invoke(Ljava/lang/Object;[Ljava/lang/Object;)Ljava/lang/Object; (Method.java:622)
  at org.springframework.util.MethodInvoker.invoke()Ljava/lang/Object; (MethodInvoker.java:269)
  at org.springframework.scheduling.support.MethodInvokingRunnable.run()V (MethodInvokingRunnable.java:65)
  at org.springframework.scheduling.timer.DelegatingTimerTask.run()V (DelegatingTimerTask.java:70)
  at java.util.TimerThread.mainLoop()V (Timer.java:534)
  at java.util.TimerThread.run()V (Timer.java:484)
 
/ Deze staat ook in ticket dsvsol-2739	,

/ 7	. 

/ we build 2015.03 locally	, 

/ 13	. 

////////////////////
/ Als we willen import in eclipse	, moet het project een .project file hebben	,

//////////////////////////////
/ Het verschil of we .classpath add of niet is 
right click project	, Build path, Configure	, 

[eric@localhost workspace]$ pwd
/home/eric/Devel/Java/Eclipse/eclipse-jee/workspace

[eric@localhost workspace]$ cp 2015.01/.project 2015.03/
[eric@localhost workspace]$ cat 2015.03/.project 
<?xml version="1.0" encoding="UTF-8"?>
<projectDescription>
	<name>2015.03</name>
...

[eric@localhost workspace]$ cp 2015.01/.classpath 2015.03
/ TODO (edit?)

[eric@localhost workspace]$ cp 2015.01/application.properties 2015.03
[eric@localhost workspace]$ vi 2015.03/application.properties 
base.product=dsvfms

build.war.dir = /home/eric/Devel/Java/JBoss/jboss-4.0.5.GA/server/${base.product}/deploy/tms.war/
jboss.configuration = ${base.product}

jboss.home=/home/eric/Devel/Java/JBoss/jboss-4.0.5.GA
ant.home=/usr/share/ant

/ we zien bij build path	,
2015.03/base-framework/build/generate/java (missing)
/ TODO

[eric@localhost server]$ cp -a dsvfms/ dsvfms-2015.03
[eric@localhost server]$ mv dsvfms dsvfms-2014.0x.0x
[eric@localhost server]$ mv dsvfms-2015.03/ dsvfms

[eric@localhost deploy]$ pwd
/home/eric/Devel/Java/JBoss/jboss-4.0.5.GA/server/dsvfms/deploy
[eric@localhost deploy]$ cat dsvfms-schedule-service.xml 
<?xml version="1.0" encoding="UTF-8"?>
<server>
        <mbean code="org.jboss.varia.scheduler.Scheduler" name=":service=DsvFmsInterfaces">
...

[eric@localhost deploy]$ cat firebird-ds.xml 
<?xml version="1.0" encoding="UTF-8"?>

 <datasources>
   <local-tx-datasource>
     <jndi-name>tmsdevDS</jndi-name>
	<connection-url>jdbc:firebirdsql://127.0.0.1//home/eric/DB_TAP/Firebird/Dsvfms/dsvfms.fdb_20151019-000019.fdb?no_result_set_tracking&amp;defaultResultSetHoldable=true</connection-url>
     <driver-class>org.firebirdsql.jdbc.FBDriver</driver-class>
     <user-name>SYSDBA</user-name>
     <password>masterkey</password>

/ 13	. 

/ we hebben rm	,
[eric@localhost deploy]$ vi dsvfms-schedule-service.xml 
                <depends>jboss.j2ee:jndiName=ejb/EventHandlerFacade,service=EJB</depends>


/ 7	. 

/ we moesten .classpath aanpassen	,
/ we hadden die van 2015.01 cp 	, 
$ vi .classpath

    <classpathentry kind="src" path="module/dataexport/src/java"/>
/ Add
    <classpathentry kind="src" path="module/tax/src/java"/>
/ Add

   	<classpathentry kind="con" path="org.dbpowder.plugins.LIB_CONTAINER/recurse~project/2015.03/base-framework/core/lib/jar"/>
/ 2015.01-> 2015.03
    <classpathentry kind="con" path="org.dbpowder.plugins.LIB_CONTAINER/recurse~project/2015.03/base-framework/buildscripts/build-lib"/>
/ 2015.01-> 2015.03
    <classpathentry kind="con" path="org.dbpowder.plugins.LIB_CONTAINER/recurse~project/2015.03/module/interfacing/lib"/>
/ 2015.01-> 2015.03

/ Nu Geen problems meer	,



/ 7	. 

/ java reports	,

$ vi dsvfms-menu.xml
	<m:add path="finance.revenue.berekeningsformulier" actionUrl="dsvfms/report_dsv_excel_berekeningsformulier_input" privilege="dsv-report.list" index="5700" />
	<m:add path="finance.revenue.warehouseMatching" actionUrl="dsvfms/report_dsv_excel_warehouse_matching_input" privilege="dsv-report.list" index="5700" />


/ 7	. 

/ we kijken op acc	, dsvfms	,

/ Maar dit is 2013.04	, 
/ een ander menu als 2015.03	,

$ dsvfms-ssh-a.sh
...
[jboss@application-a dsvfms]$ pwd
/local/apps/jboss-4.0.5.GA/server/dsvfms
[jboss@application-a dsvfms]$  grep base\.release conf/application.properties
base.release=2013.04

[jboss@application-a dsvfms]$ vi deploy/dsvfms.war/menu.xml 
            <menuItem index="5605">
              <labelId>shipmentOrderRecalc</labelId>
              <module>invoice</module>
              <parent reference="../../.."/>
              <path>finance.revenue.shipmentOrderRecalc</path>
              <privilege>shipment-order-price.recalculate</privilege>
              <type>ITEM</type>
              <url>wicket/?module=invoice&amp;wicketpage=batchrecalc.ShipmentOrderBatchRecalc&amp;emptySession=true</url>
              <visibilityExpr></visibilityExpr>
            </menuItem>
            <menuItem index="5610">
              <labelId>shipmentOrderPrice</labelId>
              <module>oms</module>
              <parent reference="../../.."/>
              <path>finance.revenue.shipmentOrderPrice</path>
              <privilege>invoice.report</privilege>
              <type>ITEM</type>
              <url>oms/report_shipment_order_price_input?emptySession=true</url>
              <visibilityExpr></visibilityExpr>
            </menuItem>
            <menuItem index="5620">
              <labelId>shipmentOrderMargin</labelId>
              <module>oms</module>
              <parent reference="../../.."/>
              <path>finance.revenue.shipmentOrderMargin</path>
              <privilege>invoice.report</privilege>
              <type>ITEM</type>
              <url>oms/report_shipment_order_margin_input?emptySession=true</url>
              <visibilityExpr></visibilityExpr>
            </menuItem>
            <menuItem index="5700">
              <labelId>berekeningsformulier</labelId>
              <module>dsvfms</module>
              <parent reference="../../.."/>
              <path>finance.revenue.berekeningsformulier</path>
              <privilege>dsv-report.list</privilege>
              <type>ITEM</type>
              <url>dsvfms/report_dsv_excel_berekeningsformulier_input?emptySession=true</url>
              <visibilityExpr></visibilityExpr>
            </menuItem>
            <menuItem index="5700">
              <labelId>berekeningsformulierInv</labelId>
              <module>dsvfms</module>
              <parent reference="../../.."/>
              <path>finance.revenue.berekeningsformulierInv</path>
              <privilege>dsv-report.list</privilege>
              <type>ITEM</type>
              <url>dsvfms/report_dsv_excel_invoice_input?emptySession=true</url>
              <visibilityExpr></visibilityExpr>
            </menuItem>
            <menuItem index="5700">
              <labelId>warehouseMatching</labelId>
              <module>dsvfms</module>
              <parent reference="../../.."/>
              <path>finance.revenue.warehouseMatching</path>
              <privilege>dsv-report.list</privilege>
              <type>ITEM</type>
              <url>dsvfms/report_dsv_excel_warehouse_matching_input?emptySession=true</url>
              <visibilityExpr></visibilityExpr>
            </menuItem>
          </children>

/ Dus we zien	,
              <url>wicket/?module=invoice&amp;wicketpage=batchrecalc.ShipmentOrderBatchRecalc&amp;emptySession=true</url>
              <url>oms/report_shipment_order_price_input?emptySession=true</url>
              <url>oms/report_shipment_order_margin_input?emptySession=true</url>
              <url>dsvfms/report_dsv_excel_berekeningsformulier_input?emptySession=true</url>
              <url>dsvfms/report_dsv_excel_invoice_input?emptySession=true</url>
              <url>dsvfms/report_dsv_excel_warehouse_matching_input?emptySession=true</url>

/ 7	.

/ CHANGE SHIPMENT ITEM ID 

/ Nu local	, 
/ we hebben een deployment gedaan	, 
[eric@localhost dsvfms]$ grep base\.release conf/application.properties 
base.release=2015.03

$ vi deploy/tms.war/menu.xml

           <menuItem index="5610">
              <labelId>shipmentOrderPrice</labelId>
              <module>oms</module>
              <parent reference="../../.."/>
              <path>finance.revenue.shipmentOrderPrice</path>
              <privilege>invoice.report</privilege>
              <type>ITEM</type>
              <url>oms/report_shipment_order_price_input?emptySession=true</url>
              <visibilityExpr></visibilityExpr>
            </menuItem>
            <menuItem index="5620">
              <labelId>shipmentOrderMargin</labelId>
              <module>oms</module>
              <parent reference="../../.."/>
              <path>finance.revenue.shipmentOrderMargin</path>
              <privilege>invoice.report</privilege>
              <type>ITEM</type>
              <url>oms/report_shipment_order_margin_input?emptySession=true</url>
              <visibilityExpr></visibilityExpr>
            </menuItem>
            <menuItem index="5700">
              <labelId>berekeningsformulier</labelId>
              <module>dsvfms</module>
              <parent reference="../../.."/>
              <path>finance.revenue.berekeningsformulier</path>
              <privilege>dsv-report.list</privilege>
              <type>ITEM</type>
              <url>dsvfms/report_dsv_excel_berekeningsformulier_input?emptySession=true</url>
              <visibilityExpr></visibilityExpr>
            </menuItem>
            <menuItem index="5700">
              <labelId>berekeningsformulierInv</labelId>
              <module>dsvfms</module>
              <parent reference="../../.."/>
              <path>finance.revenue.berekeningsformulierInv</path>
              <privilege>dsv-report.list</privilege>
              <type>ITEM</type>
              <url>dsvfms/report_dsv_excel_invoice_input?emptySession=true</url>
              <visibilityExpr></visibilityExpr>
            </menuItem>
           <menuItem index="5700">
              <labelId>warehouseMatching</labelId>
              <module>dsvfms</module>
              <parent reference="../../.."/>
              <path>finance.revenue.warehouseMatching</path>
              <privilege>dsv-report.list</privilege>
              <type>ITEM</type>
              <url>dsvfms/report_dsv_excel_warehouse_matching_input?emptySession=true</url>
              <visibilityExpr></visibilityExpr>
            </menuItem>

/ we zien	,

              <labelId>shipmentOrderPrice</labelId>
              <url>oms/report_shipment_order_price_input?emptySession=true</url>
/ jReport

              <labelId>shipmentOrderMargin</labelId>
              <url>oms/report_shipment_order_margin_input?emptySession=true</url>
/ jReport

              <labelId>berekeningsformulier</labelId>
              <url>dsvfms/report_dsv_excel_berekeningsformulier_input?emptySession=true</url>
        			<custom-class>com.mpobjects.dsvfms.view.report.DsvFmsBerekeningsformulierExcelCreator</custom-class>

              <labelId>berekeningsformulierInv</labelId>
              <url>dsvfms/report_dsv_excel_invoice_input?emptySession=true</url>
        			<custom-class>com.mpobjects.dsvfms.view.report.DsvFmsBerekeningsformulierInvExcelCreator</custom-class>

              <labelId>warehouseMatching</labelId>
              <url>dsvfms/report_dsv_excel_warehouse_matching_input?emptySession=true</url>
        			<custom-class>com.mpobjects.dsvfms.view.report.DsvFmsWareHouseMatchingReportExcelCreator</custom-class>

/ we moeten kijken in files die zonder report_ beginnen	,
./deploy/tms.war/dsvfms/report/dsv_excel_berekeningsformulier-input.xml
./deploy/tms.war/dsvfms/report/dsv_excel_invoice-input.xml
./deploy/tms.war/dsvfms/report/dsv_excel_warehouse_matching-input.xml

/ Let op	, grep werkt op een list van files, of als die er niet is op stdin 
/ dus moeten we $(find ...), die een list van files geeft,	 en <(...) omdat grep dan van stdin moet read	,	
[eric@localhost 2013.04.01]$ grep -i matching <(grep  -i warehouse $(find -name "*menu*.xml" ))
./dsvfms/dsvfms/dsvfms-menu.xml:	<m:add path="finance.revenue.warehouseMatching" actionUrl="dsvfms/report_dsv_excel_warehouse_matching_input" privilege="dsv-report.list" index="5700" />

$ vi 2015.03/dsvfms/dsvfms/src/java/com/mpobjects/dsvfms/view/report/DsvFmsBerekeningsformulierExcelCreator.java 
/ No shipmentItemId	,
$ vi 2015.03/dsvfms/dsvfms/src/java/com/mpobjects/dsvfms/view/report/DsvFmsBerekeningsformulierInvExcelCreator.java 
/ No shipmentItemId	,
$ vi ./dsvfms/dsvfms/src/java/com/mpobjects/dsvfms/view/report/DsvFmsWareHouseMatchingReportExcelCreator.java 
/ No shipmentItemId ,

/ we kijken ook in	,
$ vi shipment_order_price_input.xml
<report name="shipment_order_price.jrxml" caption="Shipment Order Price">

$ vi shipment_order_price.jrxml
/ No shipment_item_id

/ we kijken ook in	,
$ vi shipment_order_margin_input.xml
<report name="shipment_order_margin.jrxml" caption="Shipment Order Margin">

$ vi shipment_order_margin.jrxml
/ No shipment_item_id


$ vi dsvfms-sitemap.xmap

			<map:match pattern="dsvfms/report_**_input">
				<map:aggregate element="total-report">
					<map:part src="cocoon:/generate-report-{1}" />
					<map:part src="cocoon:/userInfo" />
				</map:aggregate>
				<map:transform type="defaultresolver" />
				<map:transform src="../core/xsl/report-input.xsl" />
				<map:serialize type="html" />
			</map:match>
/ TODO

/ we moeten naar de menu item kijken	, en gewoon doen	,

[eric@localhost dsvfms]$ pwd
/home/eric/Devel/Java/JBoss/jboss-4.0.5.GA/server/dsvfms
[eric@localhost dsvfms]$ vi deploy/tms.war/menu.xml 
....

$ vi 2015.03/dsvfms/dsvfms/war/dsvfms/report/dsv_excel_berekeningsformulier-input.xml 
        <custom-class>com.mpobjects.dsvfms.view.report.DsvFmsBerekeningsformulierExcelCreator</custom-class>

$ vi ShipmentItem.standard.hbm.xml
	<class name="com.mpobjects.oms.model.shipmentorder.vo.ShipmentItemVO" .. table="SHIPMENT_ITEM">
		<property name="shipmentItemId" type="string" unique="true">
			<column name="SHIPMENT_ITEM_ID" length="80" />
		</property>

/7	. 

/ berekeningsformulier	,

/ Kies 1 dag	, dus Start Date en End Date gelijk	,


/ ga naar	,
http://application-a.intermax.mp-objects.com:8180
/ click JMX console
/ Ga naar 
jboss.system
type=ServerInfo
/ click
java.lang.String listThreadDump()
/ click 
/ Zoek naar Berekeningsformulier	, 
com.mpobjects.dsvfms.view.report.DsvFmsBerekeningsformulierExcelCreator.writeBytes(DsvFmsBerekeningsformulierExcelCreator.java:102)


http://application-a.intermax.mp-objects.com:8180/jmx-console/HtmlAdaptor?action=inspectMBean&name=jboss.system%3Atype%3DServerInfo
/ In JBoss	,

[eric@localhost reports]$ ls
dsv-berekeningsformulier_29-Oct-2015.xls      dsv-warehouse-matching-report_29-Oct-2015.xls
dsv-berekeningsformulier-INV_29-Oct-2015.xls


/ Einde CHANGE SHIPMENT ITEM ID 

/ FIX CHANGE SHIPMENT ITEM ID 

[eric@localhost dsvfms]$ pwd
/home/eric/Devel/Firebird/scripts/dsvfms
$ cp -a local test
$ cd test
[eric@localhost dsvfms]$ for f in $(find -name "*.sh");do awk '/^isql-fb/{$0="isql-fb -u sysdba -p masterkey mposerv8:/local/apps/firebird/dsvfms.fdb"}{print}' "$f"  >tmp;mv tmp "$f";done
[eric@localhost dsvfms]$ chmod u+x $(find -name "*.sh")

eric@localhost test]$ cat def_drops2.sh 
#!/usr/bin/bash
isql-fb -u sysdba -p masterkey mposerv8:/local/apps/firebird/dsvfms.fdb
...

/ we doen	,
[eric@localhost test]$ ./def_drops2.sh 

///////////////////
/ de backup voor de shi id unique	, en pro item id's unique	,
eric@mposerv8:/backup/mpo-backup/db$ pwd
/backup/mpo-backup/db
-rw-rw-r-- 1 mpo-backup mpo-backup 7365378907 Oct 29 02:31 dsvfms.fdb_20151029-000016.fbk.gz

[eric@localhost test]$ ./def_rm_dups_shi_fms.sh 

[eric@localhost bin]$ dsvfms-db-t.sh 
SQL> show procedures;
Procedure Name                    Invalid Dependency, Type
================================= ======= =====================================
DROP_PROCEDURE_IF_EXISTS                  RDB$PROCEDURES, Table
DROP_RELATION_IF_EXISTS                   RDB$RELATIONS, Table
RM_SHIPMENT_ITEM_ID_DUPS                  SHIPMENT_ITEM, Table

[eric@localhost test]$ ./exec_rm_dups_shi_fms.sh 
/ OK
[eric@localhost test]$ ./exec_chk_rm_dups_shi_fms_2.sh 
[eric@localhost test]$ ./exec_chk_rm_dups_shi_fms_2.sh 


/ Einde FIX CHANGE SHIPMENT ITEM ID 

/ 7.	 

/ CHANGE PRODUCT ITEM ID 

/ product item id	,

[eric@localhost dsvfms]$ local-db.sh /home/eric/DB_TAP/Firebird/Dsvfms/dsvfms.fdb_20151019-000019.fdb 

$ vi ProductItem.standard.hbm.xml
	<class name="com.mpobjects.oms.model.shipmentorder.vo.ProductItemVO" table="TMS_PRODUCT_ITEM" lazy="false">
		<property name="productItemId" type="string" unique-key="sho_prIt_uk">
			<column name="PRODUCT_ITEM_ID" length="80" />
		</property>

$ vi ProductItemVO.java
	public String getId() {
		return getProductItemId();
	}
	public String getProductItemId() {
		return theProductItemId;
	}
	public String getStringSequence() {
		return getProductItemId();
	}

$ vi 2015.03/dsvfms/dsvfms/src/java/com/mpobjects/dsvfms/view/report/DsvFmsBerekeningsformulierExcelCreator.java 
	private void createRowsForShipmentOrder(HSSFSheet aSheet, ShipmentOrderVO anOrderVO, boolean isFollowUp, ProductItemVO aProductItem, String aFirstProductItemId) throws Exception {
		} else {
			myHssfCell.setCellValue(new HSSFRichTextString("tog with " + aFirstProductItemId));
/ MULTIPLE TIMES

$ vi 2015.03/dsvfms/dsvfms/src/java/com/mpobjects/dsvfms/view/report/DsvFmsBerekeningsformulierInvExcelCreator.java 
	private void createRow(ShipmentOrderVO aShipmentOrder, ProductItemVO aProductItem) {
		if (myCustomerOrderLine == null) {
			String myMessage = "Order has no customer order line attached [" + aShipmentOrder.getShipmentOrderId() + " - " + aProductItem.getProductItemId()
					+ "]";
/ ONE TIME IN LOG STMT

$ vi ./dsvfms/dsvfms/src/java/com/mpobjects/dsvfms/view/report/DsvFmsWareHouseMatchingReportExcelCreator.java 
	private void createRow(DsvFmsWareHouseMatchingReportLine aLine, ProductItemVO aProductItem) {
		if (myCustomerOrderLine == null) {
			String myMessage = "Order has no customer order line attached [" + aLine.getShipmentOrderId() + " - " + aProductItem.getProductItemId() + "]";
/ ONE TIME IN LOG STMT

QL> select count(*) from tms_product_item;

       COUNT 
============ 
     2107753 

/ we doen	, 
select SHIPMENT_ORDER_SYSTEMID, PRODUCT_ITEM_ID,PART_NUMBER,count(PRODUCT_ITEM_ID)from TMS_PRODUCT_ITEM group by SHIPMENT_ORDER_SYSTEMID, PRODUCT_ITEM_ID,PART_NUMBER having count(PRODUCT_ITEM_ID)>1; 
SHIPMENT_ORDER_SYSTEMID PRODUCT_ITEM_ID                                                                  PART_NUMBER                                                                             COUNT 
======================= =============================================================================== =============================================================================== ============ 
               97675042 39355                                                                            39355                                                                                       2 
               99163789 NMA201A010311004                                                                 NMA201A010311004                                                                            3 
...

/ we zien dus dat de product_item_id column niet OK is	, en gelijk is aan de part_number 	,
/ we hebben een Jira create, DSVSOL-2750	, voor integration	, 
/ Dit is voor acc	, op test is er geen integration	, dus kunnen we de database repair	, maar moeten we wel rapporten aanpassen, waar product_item_id staat moeten we part_number set	,

/ 7	. 

$ ls -ltr ~/Downloads
-rw-r-----. 1 eric eric       5634 Oct 28 16:50 dsv-warehouse-matching-report_28-Oct-2015.xls
-rw-r-----. 1 eric eric     293378 Oct 29 07:56 dsv-berekeningsformulier_29-Oct-2015.xls
-rw-r-----. 1 eric eric       5634 Oct 29 07:58 dsv-berekeningsformulier-INV_29-Oct-2015.xls
-rw-r-----. 1 eric eric       5634 Oct 29 07:58 dsv-warehouse-matching-report_29-Oct-2015.xls

/ 7	. 

/ Vervang in de reports product_item_id door part_number	,

$ vi ProductItem.standard.hbm.xml
	<class name="com.mpobjects.oms.model.shipmentorder.vo.ProductItemVO" table="TMS_PRODUCT_ITEM" lazy="false">
		<property name="productItemId" type="string" unique-key="sho_prIt_uk">
			<column name="PRODUCT_ITEM_ID" length="80" />
		</property>

$ vi ProductItemVO.java

	public String getId() {
		return getProductItemId();
	}
	public String getProductItemId() {
		return theProductItemId;
	}
	@Override
	public String getStringSequence() {
		return getProductItemId();
	}

/ we moeten kijken in files die zonder report_ beginnen	,
./deploy/tms.war/dsvfms/report/dsv_excel_berekeningsformulier-input.xml
./deploy/tms.war/dsvfms/report/dsv_excel_invoice-input.xml
./deploy/tms.war/dsvfms/report/dsv_excel_warehouse_matching-input.xml

/ 13	. 

./deploy/tms.war/dsvfms/report/dsv_excel_berekeningsformulier-input.xml
$ vi 2015.03/dsvfms/dsvfms/src/java/com/mpobjects/dsvfms/view/report/DsvFmsBerekeningsformulierExcelCreator.java 

	private void createInvoiceDetails(HSSFSheet mySheet) throws Exception {
					createRowsForShipmentOrder(mySheet, myOrderVO, !isFirst, myProductItem, myFirstProductItem.getReference3());
/s
	private void createRowsForShipmentOrder(HSSFSheet aSheet, ShipmentOrderVO anOrderVO, boolean isFollowUp, ProductItemVO aProductItem, String aFirstProductItemId) throws Exception {
//////////////////
/ Dus aFirstProductItemId= myFirstProductItem.getReference3()
/ en NIET getProdcutItemId()

/ we veranderen alleen	,
	private void createRowsForShipmentOrder(HSSFSheet aSheet, ShipmentOrderVO anOrderVO, boolean isFollowUp, ProductItemVO aProductItem, String aFirstProductItemId) throws Exception {
		if (myCustomerOrderLine == null) {
			String myMessage = "Order has no customer order line attached [" + anOrderVO.getShipmentOrderId() + " - " + aProductItem.getProductItemId() + "]";
/ In	,
		if (myCustomerOrderLine == null) {
			String myMessage = "Order has no customer order line attached [" + aShipmentOrder.getShipmentOrderId() + " - " + aProductItem.getPartNumber() + "]";

/ 13	. 

./deploy/tms.war/dsvfms/report/dsv_excel_invoice-input.xml
        <custom-class>com.mpobjects.dsvfms.view.report.DsvFmsBerekeningsformulierInvExcelCreator</custom-class>
$ vi DsvFmsBerekeningsformulierInvExcelCreator.java

		CustomerOrderLine myCustomerOrderLine = aProductItem.getCustomerOrderLine();
		if (myCustomerOrderLine == null) {
			String myMessage = "Order has no customer order line attached [" + aShipmentOrder.getShipmentOrderId() + " - " + aProductItem.getProductItemId()
					+ "]";
/ in	,
		if (myCustomerOrderLine == null) {
			String myMessage = "Order has no customer order line attached [" + aShipmentOrder.getShipmentOrderId() + " - " + aProductItem.getPartNumber() + "]";

/ 13	. 

./deploy/tms.war/dsvfms/report/dsv_excel_warehouse_matching-input.xml

$ vi DsvFmsWareHouseMatchingReportExcelCreator.java  
		if (myCustomerOrderLine == null) {
			String myMessage = "Order has no customer order line attached [" + aLine.getShipmentOrderId() + " - " + aProductItem.getPartNumber() + "]";


/ we kijken ook in	,
$ vi shipment_order_price_input.xml
<report name="shipment_order_price.jrxml" caption="Shipment Order Price">

$ vi shipment_order_price.jrxml
/ Geen product_item_id

/ we kijken ook in	,
$ vi shipment_order_margin_input.xml
<report name="shipment_order_margin.jrxml" caption="Shipment Order Margin">

$ vi shipment_order_margin.jrxml
/ No product_item_id

/ Deze reports zijn ui dsvfms acc	,
[eric@localhost reports]$ pwd
/home/eric/DB_TAP/Firebird/Dsvfms/reports
[eric@localhost reports]$ ls
dsv-berekeningsformulier_29-Oct-2015.xls      dsv-warehouse-matching-report_29-Oct-2015.xls
dsv-berekeningsformulier-INV_29-Oct-2015.xls

/ 7	. 

/ Eerst local	,

[eric@localhost local]$  pwd
/home/eric/Devel/Firebird/scripts/dsvfms/local

[eric@localhost local]$ cat exec_chk_rm_dups_pri_fms_2.sh 
#!/usr/bin/bash
isql-fb -user sysdba -password masterkey /home/eric/DB_TAP/Firebird/Dsvfms/dsvfms.fdb_20151019-000019.fdb <<SQL

select shipment_order_systemid, product_item_id, part_number,count(product_item_id)
from tms_product_item 
group by shipment_order_systemid, product_item_id,part_number
having count(product_item_id)>1 ;

rollback;
SQL

[eric@localhost local]$ cat def_rm_dups_pri_fms.sh 
#!/usr/bin/bash
isql-fb -user sysdba -password masterkey /home/eric/DB_TAP/Firebird/Dsvfms/dsvfms.fdb_20151019-000019.fdb <<SQL

execute procedure drop_procedure_if_exists('RM_TMS_PRODUCT_ITEM_ID_DUPS');
commit;

set term ^;
create procedure rm_tms_product_item_id_dups as
declare a int;
begin
    update tms_product_item
    set product_item_id=0;

    for select distinct shipment_order_systemid 
	from tms_product_item 
	into :a do
    begin
        update tms_product_item
        set product_item_id=cast((	
			select max(cast(product_item_id as int))
			from tms_product_item 
			where shipment_order_systemid=:a)
		as int)+1
        where shipment_order_systemid=:a;
    end
end^

set term ;^
commit;
SQL

[eric@localhost local]$ cat  exec_rm_dups_pri_fms.sh 
#!/usr/bin/bash
isql-fb -user sysdba -password masterkey /home/eric/DB_TAP/Firebird/Dsvfms/dsvfms.fdb_20151019-000019.fdb <<SQL

execute procedure rm_tms_product_item_id_dups;
commit;
SQL

/ Eerst	,
[eric@localhost local]$ ./exec_chk_rm_dups_pri_fms_2.sh 
SHIPMENT_ORDER_SYSTEMID PRODUCT_ITEM_ID                                                                  PART_NUMBER                                                                             COUNT 
======================= =============================================================================== =============================================================================== ============ 
               97675042 39355                                                                            39355                                                                                       2 
               99069850 HPE1281120312001                                                                 HPE1281120312001       
...

[eric@localhost local]$ ./def_rm_dups_pri_fms.sh 
[eric@localhost local]$ ./exec_rm_dups_pri_fms.sh 
[eric@localhost local]$ ./exec_chk_rm_dups_pri_fms_2.sh 
/ NIETS	, 
/ OK

/ check met de hand	,
select shipment_order_systemid, product_item_id, part_number
from tms_product_item
where shipment_order_systemid=97675042;

SHIPMENT_ORDER_SYSTEMID PRODUCT_ITEM_ID                                                                  PART_NUMBER                                                                      
======================= =============================================================================== =============================================================================== 
               97675042 1                                                                                39355                                                                            
               97675042 2                                                                                39355                  
/ OK

[eric@localhost local]$ cp -a $(find -name "*pri*sh") ../test/

/ Op test	,

[eric@localhost test]$ cat set_db_location_in_all_scripts.sh 
#!/usr/bin/bash

for f in $(find -name "*.sh");do awk '/^isql-fb/{$0="isql-fb -u sysdba -p masterkey mposerv8:/local/apps/firebird/dsvfms.fdb <<SQL"}{print}' "$f"  >tmp;mv tmp "$f";chmod u+x "$f";done

[eric@localhost test]$ ./exec_chk_rm_dups_pri_fms_2.sh 
[eric@localhost test]$ ./def_rm_dups_pri_fms.sh 
[eric@localhost test]$ ./exec_rm_dups_pri_fms.sh 
[eric@localhost test]$ ./exec_chk_rm_dups_pri_fms_2.sh 

/ we doen met de hand,	
[eric@localhost bin]$ dsvfms-db-t.sh 
Database:  mposerv8:/local/apps/firebird/dsvfms.fdb, User: sysdba
SQL> select shipment_order_systemid, product_item_id, part_number
CON> from tms_product_item
CON> where shipment_order_systemid=97675042;

SHIPMENT_ORDER_SYSTEMID PRODUCT_ITEM_ID                                                                  PART_NUMBER                                                                      
======================= =============================================================================== =============================================================================== 
               97675042 1                                                                                39355                                                                            
               97675042 2                                                                                39355                                          

/ Eerst local	,

/ We doen met de hand	,

/ PATCH-396-SHI_SHOID_UK.SQL

[eric@localhost local]$ cat exec_patch-396.sh 
#!/usr/bin/bash
isql-fb -user sysdba -password masterkey /home/eric/DB_TAP/Firebird/Dsvfms/dsvfms.fdb_20151019-000019.fdb <<SQL

alter table SHIPMENT_ITEM
add constraint SHI_ID_SHO_UK
unique (SHIPMENT_ORDER_SYSTEMID, SHIPMENT_ITEM_ID);

SQL


/ OK
/ Duurt een tijdje	,
/ Check	,
SQL> show table shipment_item;
CONSTRAINT SI_P_FK:
  Foreign key (PARENT_SYSTEMID)    References SHIPMENT_ITEM (SYSTEM_ID) On Delete Set Null

/ we doen met de hand	,

/ PATCH-397-PI_SHOID_UK.SQL 

[eric@localhost local]$ cat exec_patch-397.sh 
#!/usr/bin/bash
isql-fb -user sysdba -password masterkey /home/eric/DB_TAP/Firebird/Dsvfms/dsvfms.fdb_20151019-000019.fdb <<SQL

alter table TMS_PRODUCT_ITEM
add constraint TPI_ID_SHO_UK
unique (SHIPMENT_ORDER_SYSTEMID, PRODUCT_ITEM_ID);

SQL

/ OK
/ Duurt heel kort	, 

/ check	,
SQL> show table TMS_PRODUCT_ITEM;
CONSTRAINT TPI_ID_SHO_UK:
  Unique key (SHIPMENT_ORDER_SYSTEMID, PRODUCT_ITEM_ID)

/ we kunnen ook	,
select rdb$index_name 
from rdb$indices
where rdb$relation_name='SHIPMENT_ITEM';

/ Maar het kan nog beter	,
http://www.alberton.info/firebird_sql_meta_info.html#.VjNINXW9-V4
/ TODO

[eric@localhost local]$ cp -a exec_patch-39* ../test

/ Nu op test	,

[eric@localhost test]$ ./set_db_location_in_all_scripts.sh 

[eric@localhost test]$ ./exec_patch-396.sh 
[eric@localhost test]$ ./exec_patch-397.sh 

/ Check	,
[eric@localhost bin]$ dsvfms-db-t.sh 

SQL> show table shipment_order;
CONSTRAINT SHIPMENT_ORDER_ORG_UK:
  Unique key (SHIPMENT_ORDER_ID, ORGANIZATION_SYSTEMID)

SQL> show table tms_product_item;
CONSTRAINT TPI_ID_SHO_UK:
  Unique key (SHIPMENT_ORDER_SYSTEMID, PRODUCT_ITEM_ID)

/ we moeten ook	, local en op test	,

[eric@localhost local]$ cat exec_update_mpo_scs_patch.sh 
#!/usr/bin/bash
isql-fb -user sysdba -password masterkey /home/eric/DB_TAP/Firebird/Dsvfms/dsvfms.fdb_20151019-000019.fdb <<SQL

update mpo_scs_patch
set status='MANUALLY_APPLIED'
where name in ('patch-396-shi_shoid_uk.sql','patch-397-pi_shoid_uk.sql');
commit;

SQL

[eric@localhost local]$ cp -a exec_update_mpo_scs_patch.sh ../test
$ cd ../test
[eric@localhost test]$ ./set_db_location_in_all_scripts.sh 
[eric@localhost test]$ ./exec_update_mpo_scs_patch.sh 

/ check	,
SQL> select status,name from mpo_scs_patch where name similar to  'patch%39(6|7)%';

STATUS                           NAME                                                                                                                             
================================ =============================================================================== 
SKIPPED                          patch-396-entity-log-blob$oracle.sql                                                                                             
SKIPPED                          patch-396-entity-log-blob$postgresql.sql                                                                                         
MANUALLY_APPLIED                 patch-396-shi_shoid_uk.sql                                                                                                       
MANUALLY_APPLIED                 patch-397-pi_shoid_uk.sql                                                                                              
SQL> select status,name from mpo_scs_patch where name similar to  'patch%39(6-shi|7-pi)%';
Invalid SIMILAR TO pattern
SQL> select status,name from mpo_scs_patch where name similar to  'patch%39(6|7)-%';
/ TODO

/ Einde CHANGE PRODUCT ITEM ID 

/ PATCH-422-SOC-CORRECTION-TYPE-REMOVE.SQL

$ vi patch-422-soc-correction-type-remove.sql

alter table service_order_cost drop correction_type_systemid;

alter table cost_component_specification drop correction_type_systemid;

drop table correction_type;

SQL> select rdb$dependent_name from rdb$dependencies where rdb$field_name ='CORRECTION_TYPE_SYSTEMID';

RDB$DEPENDENT_NAME                                                                            
=============================================================================== 
COSTS_STATUS_PER_SHIPMENT                                                                     
FUEL_DEL_COST_SHIPMENT                                                                        
FUEL_LIN_COST_SHIPMENT                                                                        
FREIGHT_LIN_COST_SHIPMENT                                                                     
OTHER_DEL_COST_SHIPMENT                                                                       
OTHER_LIN_COST_SHIPMENT                                                                       
COSTS_PER_SHIPMENT                                                                            
FREIGHT_DEL_COST_SHIPMENT       

/ Eerder	,

$ vi patch-011_report_view-costactualestimated.sql

RECREATE VIEW COSTS_STATUS_PER_SHIPMENT (SHIPMENT_ORDER_SYSTEMID, ACTUAL_COSTS, ESTIMATED_COSTS)
AS SELECT SHO.SYSTEM_ID AS SHIPMENT_ORDER_SYSTEMID,
SUM(CASE WHEN socp.status = 'ACTUAL' THEN 
(CASE soc.correction_type WHEN 'ADD' THEN SOCP.AMOUNT WHEN 'SUBTRACT' THEN (-1*SOCP.AMOUNT) ELSE 0 END)
 ELSE null END
) AS ACTUAL_COSTS,
SUM (CASE WHEN socp.status = 'ESTIMATED' THEN 
(CASE soc.correction_type WHEN 'ADD' THEN SOCP.AMOUNT WHEN 'SUBTRACT' THEN (-1*SOCP.AMOUNT) ELSE 0 END)
 ELSE null END
) AS ESTIMATED_COSTS
FROM SHIPMENT_ORDER SHO
JOIN SHIPMENT_ORDER_COST_PART SOCP ON SOCP.SHIPMENT_ORDER_SYSTEMID=SHO.SYSTEM_ID
JOIN SERVICE_ORDER_COST SOC ON SOC.SYSTEM_ID=SOCP.SERVICE_ORDER_COST_SYSTEMID
WHERE SOCP.IS_DELETED = 0
GROUP BY SHO.SYSTEM_ID;

/ Einde PATCH-422-SOC-CORRECTION-TYPE-REMOVE.SQL

/ MORGENOCHTEND REPORT

/7	 .

/ TOO MANY UNMATCHED DEFERRED EVENTS IN DSVFMS

/ we start/login (TODO)	, en we vallen in	,

[DeferredEventIdentifierCacheRefreshTaskTimerFactory] (Suspended (entry into method findEventsByStatus in DeferredEventDAOImpl))	
	DeferredEventDAOImpl.findEventsByStatus(DeferredEventStatus) line: 59	
	DeferredEventIdentifierCache.initialize() line: 78	
	DeferredEventIdentifierCache.<init>() line: 36	
	DeferredEventIdentifierCache.getInstance() line: 41	
	DeferredEventIdentifierCacheRefreshTask.run() line: 28	
	TimerThread.run() line: 505	

/ In meer detail	,

DeferredEventIdentifierCacheRefreshTask.run() line: 28	
	public void run() {
		loginService.login();
		DeferredEventIdentifierCache.getInstance().initialize();
/s
DeferredEventIdentifierCache.getInstance() line: 41	
		if (instance == null) {
			instance = new DeferredEventIdentifierCache();
/s
DeferredEventIdentifierCache.<init>() line: 36	
		cache = new HashMap<String, Map<String, Set<Integer>>>();
		initialize();
/s
DeferredEventIdentifierCache.initialize() line: 78	
		cache.clear();
		List<DeferredEvent> myList = MpoBeanFactory.getBean(DeferredEventDAO.class).findEventsByStatus(DeferredEventStatus.UNMATCHED);
/s
DeferredEventDAOImpl.findEventsByStatus(DeferredEventStatus) line: 59	
/=
	public List<DeferredEvent> findEventsByStatus(DeferredEventStatus aStatus) {
/ aStatus=UNMATCHED
		DetachedCriteria myCriteria = DetachedCriteria.forClass(DeferredEvent.class);
		myCriteria.add(Property.forName("status").eq(aStatus));
		HibernateTemplate myTemplate = getHibernateTemplate();
		myTemplate.setCacheQueries(true);
		@SuppressWarnings("unchecked")
		List<DeferredEvent> myDeferredEvents = myTemplate.findByCriteria(myCriteria);
/ komt hier niet uit	,

$ vi DeferredEvent.standard.hbm.xml

	<class name="DeferredEvent" table="DEFERRED_EVENT">

$ vi DeferredEventDAOImpl.java

	@Override
	public List<DeferredEvent> findEventsByStatus(DeferredEventStatus aStatus) {
		DetachedCriteria myCriteria = DetachedCriteria.forClass(DeferredEvent.class);
		myCriteria.add(Property.forName("status").eq(aStatus));
		HibernateTemplate myTemplate = getHibernateTemplate();
		myTemplate.setCacheQueries(true);
		@SuppressWarnings("unchecked")
		List<DeferredEvent> myDeferredEvents = myTemplate.findByCriteria(myCriteria);
		for (DeferredEvent myDeferredEvent : myDeferredEvents) {
			myTemplate.initialize(myDeferredEvent);
			myTemplate.initialize(myDeferredEvent.getIdentifiers());
		}
		return myDeferredEvents;
	}

/ 7	.  

./module/event/src/java/com/mpobjects/event/service/DeferredEventPurgeServiceImpl.java

[eric@localhost 2015.03]$ find -name "*Task*java" | grep -i defer
./module/event/src/java/com/mpobjects/event/service/DeferredEventProcessingTask.java
./module/event/src/java/com/mpobjects/event/service/DeferredEventTriggerTask.java
./module/event/src/java/com/mpobjects/event/service/DeferredEventIdentifierCacheRefreshTask.java

/ 7	. 

[eric@localhost 2015.03]$ vi ./module/event/src/java/event-service.sb.xml

    <bean id="DeferredEventIdentifierCacheRefreshTaskTimerFactory" class="org.springframework.scheduling.timer.TimerFactoryBean">
        <property name="scheduledTimerTasks">
            <bean class="org.springframework.scheduling.timer.ScheduledTimerTask">
                <property name="delay" value="15000" />
                <property name="period" value="7200000" />
                <property name="timerTask" ref="deferredEventIdentifierRefreshRun" />
            </bean>
        </property>
    </bean>

/ MORGENOCHTEND
/ Zoek cron job scheduler in spring config file
/ TODO

/ Verschil cronjobs en task
/ TODO





/	7	.

SQL>  select count(*)from deferred_event;

       COUNT 
============ 
      469901 

SQL>  select count(*)from deferred_event where status='UNMATCHED';

       COUNT 
============ 
      458799 


SQL>  select min(cast(created_on_date as date)) from deferred_event where status='UNMATCHED';

        MIN 
=========== 
2014-03-12  

SQL>  select max(cast(created_on_date as date)) from deferred_event where status='UNMATCHED';

        MAX 
=========== 
2015-10-05 


SQL>  select max(cast(created_on_date as date))-min(cast(created_on_date as date)) from deferred_event where status='UNMATCHED'; 

    SUBTRACT 
============ 
         572 
/ TODO

/ 7	.


SQL>  select count(*)from deferred_event where status='UNMATCHED' and created_on_date between '2014-03-12' and '2014-06-12';

       COUNT 
============ 
       39904 

SQL>  select count(*)from deferred_event where status='UNMATCHED' and created_on_date between '2014-06-12' and '2014-09-12';

       COUNT 
============ 
       53766 

SQL>  select count(*)from deferred_event where status='UNMATCHED' and created_on_date between '2014-09-12' and '2014-12-12';

       COUNT 
============ 
       63055 

SQL>  select count(*)from deferred_event where status='UNMATCHED' and created_on_date between '2014-12-12' and '2015-03-12';

       COUNT 
============ 
      101203 

SQL>  select count(*)from deferred_event where status='UNMATCHED' and created_on_date between '2015-03-12' and '2015-06-12';

       COUNT 
============ 
       71178 

SQL>  select count(*)from deferred_event where status='UNMATCHED' and created_on_date between '2015-06-12' and '2015-09-12';

       COUNT 
============ 
       96745 

SQL>  select count(*)from deferred_event where status='UNMATCHED' and created_on_date between '2015-09-12' and '2015-12-12';

       COUNT 
============ 
       32948 



/ Einde TOO MANY UNMATCHED DEFERRED EVENTS IN DSVFMS


/ 13	. 

/ we halen de patched db over van mposerv8	,

/ ze zijn op mposerv8 in /backup/mpo-backup/db	,

[eric@localhost bin]$ scp eric@mposerv8:/backup/mpo-backup/db/dsvfms.fdb_20151016-000021.fbk.gz /home/eric/DB_TAP/Firebird/

[eric@localhost bin]$ dsvfms-scp-from-db-t.sh dsvfms.fdb_20151016-000021.fbk.gz
Eric789@MPO
/ OK

/ Intermezzo

eric@mposerv8:/backup/mpo-backup/db$ ls -1tr | grep dsvfms | tail -1
dsvfms.fdb_20151019-000019.fbk.gz

eric@mposerv8:/backup/mpo-backup/db$ find $(ls -1tr ) -name "*dsvfms*" | tail -1
dsvfms.fdb_20151019-000019.fbk.gz

/ het 1ste arg van find is een ( list van ) dir of een (list van) file 

eric@mposerv8:/backup/mpo-backup/db$ tail -1 $(find $(ls -1tr ) -name "*dsvfms*" )
tail: option used in invalid context -- 1
eric@mposerv8:/backup/mpo-backup/db$ tail -1 <(find $(ls -1tr ) -name "*dsvfms*" )
dsvfms.fdb_20151019-000019.fbk.gz

/ tail werkt alleen op stdin	, niet op args	,

/ Kijk naar verschil	,

eric@mposerv8:/backup/mpo-backup/db$ cat  <(ls -1tr)
scsdemo.fdb_20130602-000002.fbk.gz
scsdemo.fdb_20130603-000001.fbk.gz
...
eric@mposerv8:/backup/mpo-backup/db$ echo  $(ls -1tr)
scsdemo.fdb_20130602-000002.fbk.gz scsdemo.fdb_20130603-000001.fbk.gz ...

/ find krijgt args	, dus $(ls -1tr)	, 

/ Einde Intermezzo

[eric@localhost bin]$ ssh eric@mposerv8 "cd /backup/mpo-backup/db;ls -1tr | grep dsvfms | tail -1"
/ of	,
[eric@localhost bin]$ ssh eric@mposerv8 'cd /backup/mpo-backup/db;tail -1 <(find $(ls -1tr ) -name "*dsvfms*")'
/ of	,
[eric@localhost bin]$ ssh eric@mposerv8 "cd /backup/mpo-backup/db;tail -1 <(find \$(ls -1tr ) -name \"*dsvfms*\")"
dsvfms.fdb_20151019-000019.fbk.gz

/ we moeten dus ook de $ escape	 tussen ""	, naast de " , maar dat is logisch	,

/ Lees	,
http://www.tldp.org/LDP/abs/html/quotingvar.html
/ we moeten tussen "" escape: $ en  ` en \ 
/ want tussen "" worden special chars niet interpret	, behalve $ en ` en \ 
/ $ wordt wel interpret voor "$var"	,  als we dat niet willen moeten we "\$(ls -ltr)"	, 

/ we maken	, 

$ dsvfms-scp-from-db-t.sh
#!/usr/bin/bash
# $@=dsvfms.fdb_20150930-002854.fbk.gz
echo "Eric789@MPO"
file=$(ssh eric@mposerv8 "cd /backup/mpo-backup/db;ls -1tr | grep dsvfms | tail -1")
scp "eric@mposerv8:/backup/mpo-backup/db/$file" /home/eric/DB_TAP/Dsvfms/
/ OK	,


/ 13	. 

[eric@localhost Dsvfms]$ tr fbk fdb < <(echo "fbk")
fdb
/ tr werkt niet op een file arg	, maar op stdin 	, vandaar de extra <	,

[eric@localhost Dsvfms]$ sed 's/fbk/fdb/g'  < <(echo "fbk")
/ of	,
[eric@localhost Dsvfms]$ sed 's/fbk/fdb/g'  <(echo "fbk")
fdb

/ sed werkt op een file of stdin	,

[eric@localhost Dsvfms]$ awk '{sub(/fbk/,"fdb");print}'  <(echo "fbk")
fdb

/ 13	. 

[eric@localhost Dsvfms]$ if [ -f $(tail -1 < <(ls -1tr)) ] ; then echo OK; fi
OK

/ Intermezzo

/ In sed matching string	, escape . met \

[eric@localhost Dsvfms]$ sed 's/.fbk/Afdb/' <(echo "afbk")
Afdb
/ een . matches alle	,

[eric@localhost Dsvfms]$ sed 's/\.fbk/Afdb/' <(echo "afbk")
/ of	,
[eric@localhost Dsvfms]$ sed 's/\.fbk/\.fdb/' <(echo "afbk")
afbk
/ een \. is inderdaad een .	, "afbk" matches niet	, dus sed geeft deze string onveranderd terug	,

[eric@localhost Dsvfms]$ sed 's/\.fbk/Afdb/' <(echo ".fbk")
Afdb

/ bij awk is hetzelfde	,

[eric@localhost Dsvfms]$ awk '{sub(/.fbk/,"Afdb");print}' <(echo "afbk")
Afdb
[eric@localhost Dsvfms]$ awk '{sub(/\.fbk/,"Afdb");print}' <(echo "afbk")
afbk
[eric@localhost Dsvfms]$ awk '{sub(/\.fbk/,"Afdb");print}' <(echo ".fbk")
Afdb


/ Einde Intermezzo

[eric@localhost Dsvfms]$ awk '{sub(/.fbk/,".fdb");print}' <(echo "afbk")
/ TODO


$ gbak -c -user sysdb -password masterkey 

[eric@localhost Dsvfms]$ sudo chown eric.eric $(tail -1 < <(ls -1tr))

/ Intermezzo

/ grep kijkt altijd in een file	,

[eric@localhost Dsvfms]$ tail -1 < <(grep -e "fbk$" <(ls -1tr))
dsvfms.fdb_20151019-000019.fbk

/ use NIET	,
$ grep $(ls -1tr)	
/ want dan kijkt hij in elk van de files in de list	,

/ we kunnen ook find	, 

[eric@localhost Dsvfms]$ tail -1 <(find $(ls -1tr) -name "*fbk")
dsvfms.fdb_20151019-000019.fbk

/ Einde Intermezzo

[eric@localhost Dsvfms]$ ls -l $(tail -1 <(find $(ls -1tr) -name "*fbk"))
-rw-rw-r--. 1 firebird firebird 18560443392 Oct 19 10:30 dsvfms.fdb_20151019-000019.fbk

[eric@localhost Dsvfms]$ sudo chown eric.eric $(tail -1 <(find $(ls -1tr) -name "*fbk"))

[eric@localhost Dsvfms]$ ls -l $(tail -1 <(find $(ls -1tr) -name "*fbk"))
-rw-rw-r--. 1 eric eric 18560443392 Oct 19 10:30 dsvfms.fdb_20151019-000019.fbk

///////////////////////////////////////////
/ Voor gbak hoeven de de .fbk file NIET naar firebird.firebird te brengen	, 
/ gbak -c kunnen we als eric doen	, de file wordt van firebird	, 
/TODO

/ uiteindelijk 2 nieuwe scripts	,

[eric@localhost bin]$ cat dsvfms-scp-from-db-t.sh
#!/usr/bin/bash
echo "Eric789@MPO"

file=$(ssh eric@mposerv8 "cd /backup/mpo-backup/db;ls -1tr | grep dsvfms | tail -1")
scp "eric@mposerv8:/backup/mpo-backup/db/$file" /home/eric/DB_TAP/Dsvfms/

$ vi dsvfms-gbak-c-local.sh
#!/usr/bin/bash

dir=/home/eric/DB_TAP/Dsvfms
fbk="$(tail -1 < <(grep -e "fbk$" <(ls -1tr $dir)))"
if [ -f "$fbk" ]
then 
    fdb="$(sed 's/\.fbk/\.fdb/' <(echo $fbk))"
fi
if [ -f "$fdb" ]
then
    sudo -u firebird rm "$fdb"
fi
gbak -c -user sysdba -password masterkey "$fbk" "$fdb"

/ we hebben gedaan	, 
[eric@localhost Dsvfms]$ dsvfms-gbak-c-local.sh 
[eric@localhost Dsvfms]$ ls -ltr | tail -2
-rw-rw-r--. 1 eric     eric     18560443392 Oct 19 10:30 dsvfms.fdb_20151019-000019.fbk
-rw-rw----. 1 firebird firebird 26678132736 Oct 19 19:33 dsvfms.fdb_20151019-000019.fdb


/ 	7. 

/ wat moet er in .classpath	?

[eric@localhost 2015.03]$ pwd
/home/eric/Devel/Java/Eclipse/eclipse-jee/workspace/2015.03
/ TODO




 

/ Einde DSVSOL-2739

/ PCT-749

/ Lees	, 

https://ci.apache.org/projects/wicket/guide/7.x/guide/single.html#keepControl_1

6.4 Creating in-line panels with WebMarkupContainer 

/ FIX PCT-749

$ vi UnitListViewPanel.java

<wicket:panel>
	<table>
		<tbody class="panel-field">
			<tr class="panel-field">
				<td wicket:id="thLabel" class="label"><wicket:message key="shipmentitem.labelinfo">Tracking Number</wicket:message></td>
...
			</tr>
			<tr wicket:id="unitlist" class="panel-field">
				<td class="panel-field" wicket:enclosure="label"><span wicket:id="label" /></td>
...

$ vi UnitListViewPanel.java

	protected void init() {

		final boolean labelInfoIsHidden = ApplicationPropertyManager.getInstance().getProperty("module.oms.customerview.labelinfo.hidden", false);

		WebMarkupContainer thLabelInfo = new WebMarkupContainer("thLabelInfo");
		add(thLabelInfo);
		thLabelInfo.setVisible(labelInfoIsHidden);

		RepeatingView myView = new RepeatingView("unitlist") {
			@Override
			protected void onPopulate() {
				for (ShipmentItemVO myItem : model.getObject().getShipmentItemList()) {
					WebMarkupContainer myParent = new WebMarkupContainer(newChildId());
					myParent.add(new Label("unit", new PropertyModel<String>(myItem, "shippingUnit.code")));
					Label labelinfo = new Label("label", new PropertyModel<String>(myItem, "labelInfo"));
					labelinfo.setVisible(labelInfoIsHidden);
					myParent.add(labelinfo);

/ Doordat we wicket compnent "label" visible false hebben set	, wordt de td dat ook , vanwege de wicket:enclosure attribute	, see book (132)	, 
				<td class="panel-field" wicket:enclosure="label"><span wicket:id="label" /></td>

/ create database property

Name: module.oms.customerview.labelinfo.hidden
Code: hide labelInfo column on Unit tab on Customer View screen

/ Einde FIX PCT-749



/ Einde PCT-749

/ PCT-737

/ 7	. 

/ shipment order search	,
/ party

			<map:action logger="shipmentorder" name="shipmentOrderList" src="com.mpobjects.oms.control.shipmentorder.action.ShipmentOrderListAction"/>			
			<map:action logger="party" name="partyList" src="com.mpobjects.oms.control.party.action.PartyListAction"/>

			<map:match pattern="shipment-order_list">
				<map:act type="shipmentOrderList"/>			
				<map:call resource="dynatablePage">
					<map:parameter name="xsp" value="xsp/shipment-order_list.xml"/>
				</map:call>
			</map:match>

			<map:match pattern="party_list">
				<map:act type="partyList"/>
				<map:call resource="dynatablePage">
					<map:parameter name="xsp" value="xsp/party_list.xml"/>
				</map:call>
			</map:match>


/ In xsp/shipment-order_list.xml zien we niets 	, 

$ vi generic-dynatablepage.xsl

	<xsl:import href="generic-search.xsl" />

$ vi generic-search.xsl

					<xsl:apply-templates select="input"></xsl:apply-templates>
                    <button  type="button" class="icon_filter small" href="#" onclick="javascript:filter();">
                    </button>
                    <button type="button" class="icon_filter_clear small" href="#" onclick="javascript:resetFilter();">
                    </button>
                    <xsl:choose>
                        <xsl:when test="$no-refresh='true'">                   
/ NEE
                        </xsl:when>
                        <xsl:otherwise>
                            <xsl:text> </xsl:text>
                            <button type="button" class="icon_refresh small" href="#" onclick="javascript:refresh();">
                            </button>
                        </xsl:otherwise>
                    </xsl:choose>




$ vi dynatable.js

function filter(){
   myAddress = getLocation();
"https://test-pnl.mp-objects.com/pnllogistics/oms/party_list"			/ we filter op de party screen	,
"http://localhost:8080/tms/oms/shipment-order_list"
   var myDoElement = document.getElementById("do");
   
   myDoElement.value="filter";
   
   document.filterform.action=myAddress + '?screenId='+getScreenId();
"https://test-pnl.mp-objects.com/pnllogistics/oms/party_list?screenId=party"
"http://localhost:8080/tms/oms/shipment-order_list?screenId=shipment-order"
   if (maySubmit()) {
       document.filterform.submit();
   }
   alreadySubmitted=true;
}

function refresh(){
   myAddress = getLocation() + '?refresh=true';
"http://localhost:8080/tms/oms/shipment-order_list?refresh=true"
"http://localhost:8080/tms/oms/party_list?refresh=true"
   document.filterform.action=myAddress;
   if (maySubmit()) {
/ JA
       document.filterform.submit();
   }
   alreadySubmitted=true;
}

/ 7	. 

/ Als we filter click 	, zien we 	, 

Query String parameters
screenId: shipment-order

/ Als we refresh click	, dan zien we 	,

Query String parameters
refresh=true


/ Als we filter/refresh click 	, zien we 	,

Form Data

column:
do:filter
base_sessionLevelOffset:0
is_search_header_request:true
usePaginator:true
screenId:shipment-order
selectBox:null;;;;
filter_1:
filter_2:
filter_3:
filter_4:
filter_5:
filter_6:
filter_7:
filter_8:
filter_9:
filter_10:
filter_11:
filter_12:
filter_13:
filter_14:
filter_15:
filter_16:
filter_17:
filter_18:
filter_19:
filter_20:
filter_21:
filter_22:
filter_23:
filter_24:>07-Sep-2015

/ 7	. 

/ Nu bij party's	, 

/ Als we configuration, planning, parties	, 
/ dan Table=party_types

/ click edit button op een van de rows	, 
/ we zien dat refresh=true !

$ vi party-type-preselection-list.xsl

    <xsl:import href="../../core/xsl/generic-dynatablepage.xsl"/>    
    
    <xsl:template name="custom_header">
       <script type="text/javascript">
            function showParties(aSystemId){
              document.location.href="party_list?party_type_systemid=" + aSystemId + "&amp;refresh=true";
            }
        </script>
    </xsl:template>
 
/ we zien in HTML,	
...
<script src="../script/dynatable.js" type="text/javascript"></script>
<script type="text/javascript">
	function showParties(aSystemId){
   		document.location.href="party_list?party_type_systemid=" + aSystemId + "&refresh=true";
    }
</script>

/ de edit button	, 
	<a href="#" onclick="javascript:showParties(26681476)"><img src="../lookandfeel/styles/images/icons/bullet_ball_green16.gif"></a>


/ Einde PCT-737


/ DEBUG PCT-737

/ 7	. 

/ b's

AbstractAction [line: 137] - act(Redirector, SourceResolver, Map, String, Parameters)	
AbstractSaveAction [line: 64] - act()	
AdvancedPathDeterminationServiceImpl [line: 792] - evaluateServiceActionTemplate(int, DateTime, DateTime)	
AutomaticPathAssignmentService [line: 45] - assignPath(ShipmentOrderVO)	
AutomaticPathAssignmentService [line: 61] - assignPath(ShipmentOrderVO)	
DatabaseColumn [line: 106] - setFilter(String)	
DynaQuery [line: 111] - toSQL()	
ListAction [line: 58] - act()	
PartyListAction [line: 30] - getList()	
PartyListByGroupAction [line: 43] - getList()	
PathServiceImpl [line: 338] - getPathsFor(Resource, ShipmentOrderVO, PathSelectionMode, int)	
ServiceActionCache$ServiceActionCacheObject [line: 191] - next(DateTime, DateTime)	
ServiceActionTemplate [line: 821] - setServiceOrderTemplateList(Collection<ServiceOrderVO>)	
Table [line: 112] - Table(String, FilterCache, Request)	
Table [line: 129] - addAction(String, String)	
Table [line: 141] - addAction(TableAction)	
Table [line: 208] - addColumn(String)	
Table [line: 222] - addColumn(String, int)	
Table [line: 233] - addDatabaseColumn(String)	
Table [line: 260] - addDatabaseColumn(String, String, int)	
Table [line: 275] - addDatabaseColumn(String, String, int, boolean)	
Table [line: 280] - addDatabaseJoinColumn(String, String, int)	
Table [line: 301] - addDatabaseJoinColumn(String, String, int, int)	
Table [line: 312] - addHiddenColumn(String)	
Table [line: 327] - addHiddenColumn(String, int)	
Table [line: 339] - addHiddenDatabaseColumn(String, String)	
Table [line: 352] - addHiddenDatabaseColumn(String, String, boolean)	
Table [line: 440] - addRow(Row)	
Table [line: 460] - addRow(RowValue[])	
Table [line: 471] - addRow(String[])	
Table [line: 491] - filter()	
Table [line: 498] - filter()	
Table [line: 679] - mustReload()	
Table [line: 715] - mustReload()	
Table [line: 726] - mustReload()	
Table [line: 741] - reloadFilters()	
Table [line: 777] - resetScreenId()	
Table [line: 805] - setFilter(Map<String, String>)	
Table [line: 812] - setFilter(Map<String, String>)	
Table [line: 883] - setMessage(String, Pair<String, String>...)	
TableManager [line: 39] - flushTableCache(Request)	
TableManager [line: 52] - flushTableCache(Request, String)	
TableManager [line: 63] - getLastUsedTable(Request)	
TableManager [line: 74] - getTable(String, Request)	
TableManager [line: 103] - storeInCache(Session, Table, String)	
DatabaseColumn [access and modification] - theFilter	









/7	. 

/ we click filter op een shipment order	, met alleen system_entry_date filter : > 07-Sep-2015

/ submit form	,
/s
ShipmentOrderListAction(AbstractAction).act(Redirector, SourceResolver, Map, String, Parameters) line: 137	
			String myScreenId = theRequest.getParameter(Table.ATTRIBUTE_SCREEN_ID);
shipment-order

				Map myMap = act();
/s
ShipmentOrderListAction.act() line: 16	

/c
SetAttributesAction(AbstractAction).act(Redirector, SourceResolver, Map, String, Parameters) line: 137	
/ aParameterList=Parameters[r/w]:{overwriteAttributes=false, attributesType=request, dynatableXsl=../core/xsl/generic-dynatablepage.xsl}

				Map myMap = act();
/s
SetAttributesAction.act() line: 34	
		for (String myMyName : myNames) {
[overwriteAttributes, 
dynatableXsl]
			myKey = myMyName;
			myValue = getParameters().getParameter(myKey);
false
../core/xsl/generic-dynatablepage.xsl
			} else {
				if (myMayOverwrite || !myMayOverwrite && ObjectUtils.isEmpty(getRequest().getAttribute(myKey))) {
					getRequest().setAttribute(myKey, myValue);
dynatableXsl: ../core/xsl/generic-dynatablepage.xsl

/c
shipment_order_list_xml.generate() line: 644	
/s
Table.setFilter(Map<String,String>) line: 805	
/=
	public void setFilter(Map<String, String> aMap) {
aMap= {19=, 17=, 22=, 18=, 23=, 15=, 24=>07-Sep-2015, 16=, 13=, 14=, 11=, 12=, 21=, 3=, 2=, 20=, 10=, 1=, 7=, 6=, 5=, 4=, 9=, 8=}
		for (String myKey : aMap.keySet()) {
19
			if (!"".equals(myKey)) {
				int myIndex = Integer.parseInt(myKey);
19
				Column myColumn = myCols[myIndex];
Column:to_country
				String myValue = aMap.get(myKey);
""

			if (StringUtils.equalsIgnoreCase(ALL, myValue) && (
				StringUtils.equalsIgnoreCase("planned_start_after", myColumn.getName()) && StringUtils.equalsIgnoreCase(getName(), "service-order") || 	
				StringUtils.equalsIgnoreCase("system_entry_date", myColumn.getName()) && StringUtils.equalsIgnoreCase(getName(), "shipment-order")
				)) {
/ NEE
				}
				if (myColumn.isPropertyFiltered() && myValue.isEmpty()) {
/ NEE
				} else {
					setFilter(myColumn, myValue, FilterCache.FILTER_TYPE_USER);
/s
Table.setFilter(Column, String, String) line: 1060	
		aColumn.setFilter(aValue);
		String myFilterKey = "" + getScreenId() + "." + getName() + "." + aColumn.getName();
/s
Table.getScreenId() line: 614	
			myAttr = getRequest().getSession().getAttribute(ATTRIBUTE_SCREEN_ID);
shipment-order
/t
		String myFilterKey = "" + getScreenId() + "." + getName() + "." + aColumn.getName();
/d
shipment-order.shipment-order.to_country
		filterCache.setFilterValue(myFilterKey, aValue, aFilterType);
/ aValue=""
/ aFilterType="user_filter"
/s
FilterCache.setFilterValue(String, String, String) line: 130	
/=
	public void setFilterValue(String aKey, String aFilterValue, String aType) {
Key	"shipment-order.shipment-order.to_country" (id=21664)	

		String myProperty = ApplicationPropertyManager.getInstance().getModuleProperty(MODULE_NAME.toLowerCase(),
				getPropertyKey(aKey) + FILTER_CACHE_KEY.toLowerCase(), "both");
/=
		String myProperty = ApplicationPropertyManager.getInstance().getModuleProperty("core_dynatable",
				"shipment-order.shipment-order.filter.cache", "both");

/ Let op	,
getPropertyKey(aKey)="shipment-order.shipment-order."
/ TODO

/s
ApplicationPropertyManager.getProperty(String, String) line: 531	
/=
	public String getProperty(String aKey, String aDefaultValue) {
/ key	 module.core.dynatable.shipment-order.shipment-order.filter.cache

/ Let op:
/ In de code hier vlakvoor wordt module. ervoor set	, en core_dyhatable wordt core.dynatable	,
/ Deze zien we inderdaad in de properties file	,
"none"
/ TODO
		if (FILTER_TYPE_USER.equals(aType) && StringUtils.equals(myProperty.trim().toUpperCase(), FILTER_CACHE_NONE)) {
			skipFilter = true;

/t
Table.setFilter(Column, String, String) line: 1067	

		filterCache.setFilterValue(myFilterKey, aValue, aFilterType);
/d
/ Doet NIETS	,
/ Door de property	 module.core.dynatable.shipment-order.shipment-order.filter.cache=none doet we geen filter caching	,

		// Update the DynaQuery
		if (dynaQuery != null && (aColumn instanceof DatabaseColumn || aColumn instanceof DatabaseJoinColumn)) {
			Filter myFilter = aColumn.getFilter();
			if (myFilter != null) {
/ NEE
				dynaQuery.add(aColumn.getFilter());
/ NIET

/ Intermezzo

this	Table  (id=21066)	
	dynaQuery	DynaQuery  (id=22127)	
		maxResultCount	2000	
		orderByColumn	null	
		orderByDirection	"ASC" (id=22214)	
		theFilterList	ArrayList  (id=22220)	
		theQuery	"SELECT SHO.* FROM SHIPMENT_ORDER SHO WHERE IS_TEMPLATE = 0 AND ORGANIZATION_SYSTEMID IN {USER_ORGANIZATIONS} -#1 AND FROM_COUNTRY_SYSTEMID IN (SELECT SYSTEM_ID FROM COUNTRY WHERE ?)#--#2 AND TO_COUNTRY_SYSTEMID IN (SELECT SYSTEM_ID FROM COUNTRY WHERE ?)#--#3 AND STATUS_CODE_SYSTEMID IN (SELECT SYSTEM_ID FROM ORDER_STATUS WHERE ?)#--#4 AND HOLD_STATUS_SYSTEMID IN (SELECT SYSTEM_ID FROM HOLD_STATUS WHERE ?)#--#5 AND STATUS_CODE_SYSTEMID IN (SELECT SYSTEM_ID FROM ORDER_STATUS WHERE ?)#--#6 AND SYSTEM_ID IN (SELECT SHIPMENT_ORDER_SYSTEMID FROM SHIPMENT_ITEM WHERE ?)#--#7 AND ACT_SERVICE_LEVEL_SYSTEMID IN (SELECT SYSTEM_ID FROM SHIPMENT_SERVICE_LEVEL WHERE ?)#--#8 AND INCO_TERM_SYSTEMID IN (SELECT SYSTEM_ID FROM INCO_TERM WHERE ?)#--#9 AND SYSTEM_ID IN (SELECT SHIPMENT_ORDER_SYSTEMID FROM SHIPMENT_ITEM WHERE ?)#--#10 AND SHIPM_TYPE_SYSTEMID IN (SELECT SYSTEM_ID FROM SHIPMENT_ORDER_TYPE WHERE ?)#--#11 AND ORGANIZATION_SYSTEMID IN (SELECT SYSTEM_ID FROM ORGANIZATION WHERE ?)#--#12 AND CUSTOMER_STATUS_SYSTEMID IN (SELECT SYSTEM_ID FROM CUSTOMER_STATUS WHERE ?)#--#13 AND PREFERED_PARTY_SYSTEMID IN (SELECT SYSTEM_ID FROM PARTY WHERE ?)#--#14 AND ASSIGNEE_SYSTEMID IN (SELECT SYSTEM_ID FROM TMS_USER WHERE ?)#--#15 AND ORDER_PROCESS_SYSTEMID IN (SELECT SYSTEM_ID FROM ORDER_PROCESS WHERE ?)#-" (id=22221)	

/ Einde Intermezzo

/t
Table.setFilter(Map<String,String>) line: 812	

/ volgende	,
		for (String myKey : aMap.keySet()) {
24
			if (!"".equals(myKey)) {
				int myIndex = Integer.parseInt(myKey);
				Column myColumn = myCols[myIndex];
Column:system_entry_date
				String myValue = aMap.get(myKey);
>07-Sep-2015
				} else {
					setFilter(myColumn, myValue, FilterCache.FILTER_TYPE_USER);
/s
Table.setFilter(Column, String, String) line: 1057	
		aColumn.setFilter(aValue);

		// Also update the cache
		String myFilterKey = "" + getScreenId() + "." + getName() + "." + aColumn.getName();
shipment-order.shipment-order.system_entry_date

		filterCache.setFilterValue(myFilterKey, aValue, aFilterType);
/s
FilterCache.setFilterValue(String, String, String) line: 124	

		String myProperty = ApplicationPropertyManager.getInstance().getModuleProperty(MODULE_NAME.toLowerCase(),
				getPropertyKey(aKey) + FILTER_CACHE_KEY.toLowerCase(), "both");
none

		if (FILTER_TYPE_USER.equals(aType) && StringUtils.equals(myProperty.trim().toUpperCase(), FILTER_CACHE_NONE)) {
/ JA
			skipFilter = true;
		}

/t
Table.setFilter(Column, String, String) line: 1070	

		filterCache.setFilterValue(myFilterKey, aValue, aFilterType);
/d
/ Doet NIETS 
/ Door de property	 module.core.dynatable.shipment-order.shipment-order.filter.cache=none doet we geen filter caching	,

		// Update the DynaQuery
		if (dynaQuery != null && (aColumn instanceof DatabaseColumn || aColumn instanceof DatabaseJoinColumn)) {
			Filter myFilter = aColumn.getFilter();
			if (myFilter != null) {
/ JA
				dynaQuery.add(aColumn.getFilter());
dynaQuery	DynaQuery  (id=22127)	
	filterCache.setFilterValue(myFilterKey, aValue, aFilterType);
[>07-Sep-2015]
	theQuery
/ onveranderd	,

/c
Table.filter() line: 491	
		for (Column myCol : columns) {
			myFilterBuffer.append(myCol.getFilterExpression());
			myFilterBuffer.append("#");
		}
########################>07-Sep-2015#		
/ # is scheidingsteken	, staat achter de column filter	,

		if (!myFilterBuffer.toString().equals(oldFilter)) {
/ NEE
		// If the code is executed,data has been refreshed
		forceRefreshFlag = false;

/c
Table.reloadFilters() line: 761	
		if (!StringUtils.equals(oldScreenId, getScreenId())) {
/ NEE
/ Dus doet NIETS	,

/c
/ we zien de query	,
LOG:  execute <unnamed>: SELECT SHO.* FROM SHIPMENT_ORDER SHO WHERE IS_TEMPLATE = 0 AND ORGANIZATION_SYSTEMID IN (0,500,1020,1010,1) 
 and system_entry_date > '2015-09-07' limit $1
////////////////////////////
/ See DynaQuery.toSQL	, 
		// Remove unused join stuff
		while (true) {
			int myStart = myQuery.indexOf("-#");
...

/ 7	. 

/ we geven 29 in shipment_order_id field filter , en laten system_entry_date filter staan	,

/ we click filter	,
/s
Table.setFilter(Map<String,String>) line: 805	

		for (String myKey : aMap.keySet()) {
/ aMap={19=, 17=, 22=, 18=, 23=, 15=, 24=>07-Sep-2015, 16=, 13=, 14=, 11=, 12=, 21=, 3=, 2=29, 20=, 10=, 1=, 7=, 6=, 5=, 4=, 9=, 8=}
myKey	"2" (id=23279)	
				int myIndex = Integer.parseInt(myKey);
2
				Column myColumn = myCols[myIndex];
Column:shipment_order_id
				String myValue = aMap.get(myKey);
29
				} else {
					setFilter(myColumn, myValue, FilterCache.FILTER_TYPE_USER);
/s
Table.setFilter(Column, String, String) line: 1057	
		// Update the DynaQuery
		if (dynaQuery != null && (aColumn instanceof DatabaseColumn || aColumn instanceof DatabaseJoinColumn)) {
			Filter myFilter = aColumn.getFilter();
myFilter	CacheFilter  (id=23368)	
/ TODO
			if (myFilter != null) {
				dynaQuery.add(aColumn.getFilter());
dynaQuery
	theFilterList	ArrayList  (id=22220)	
[>07-Sep-2015, 29]

/c
Table.mustReload() line: 694	
		boolean myResult = false;

		if (forceRefreshFlag) {
/ NEE
		} else if (forceFilterFlag) {
/ NEE
		} else {
			for (Column myColumn : columns) {
				if (myColumn.mustReload()) {
/ TODO
/ NEE
		if (myResult) {
/ NEE

		return myResult;
false

/c
Table.filter() line: 491	
		for (Column myCol : columns) {
			myFilterBuffer.append(myCol.getFilterExpression());
			myFilterBuffer.append("#");
		}
##29######################>07-Sep-2015#

		if (!myFilterBuffer.toString().equals(oldFilter)) {
/ JA
			rows.clear();

			Column[] myCols = getColumns();
			row: for (Row myRow : originalRows) {
/ aantal=20	,
				int i = 0;
				for (RowValue element : myRow.getValues()) {
					if (!myCols[i++].filter(element)) {
						continue row;
/ Als een rij in de een of andere column niet voldoet aan het filter	,

			reshuffle();
/ sort	,

/ 7	. 

/ we click op refresh	, met de shipment_order_id filter op 29 en de system_entry_date=>05-Sep-2015 	,

/c
Table.mustReload() line: 709	
		boolean myResult = false;

		if (forceRefreshFlag) {
			oldFilter = "";
			myResult = true;

this.columns=
[Column:SYSTEMID,
 Column:shipment_order_process,
 Column:shipment_order_id,
 Column:status,
 Column:description,
 Column:hold_status,
 Column:shipment_type,
 Column:total_weight_kg,
 Column:price,
 Column:cost,
 Column:shipmentorder.reference1.pnllogistics.general,
 Column:shipmentorder.reference2.pnllogistics.general,
 Column:shipmentorder.reference3.pnllogistics.general,
 Column:from_name,
 Column:from_city,
 Column:from_country,
 Column:from_postal_code,
 Column:to_name,
 Column:to_city,
 Column:to_country,
 Column:to_postal_code,
 Column:pref_party,
 Column:requested_end_after,
 Column:requested_end_before,
 Column:system_entry_date]

		if (myResult) {
			// The table will be reloaded from the DB, therefore set the DBFilter
			// in all columns
			for (Column myColumn : columns) {
				if (myColumn instanceof DatabaseColumn) {
					DatabaseColumn myDBCol = (DatabaseColumn) myColumn;
Column:shipment_order_process
					myDBCol.setDBFilter();
/s
DatabaseJoinColumn(DatabaseColumn).setDBFilter() line: 100	
		if (theFilter instanceof CacheFilter) {
/ NEE
		theReloadFlag = true;
/t
Table.mustReload() line: 710	

/volgende	,
			for (Column myColumn : columns) {
				if (myColumn instanceof DatabaseColumn) {
					DatabaseColumn myDBCol = (DatabaseColumn) myColumn;
Column:shipment_order_id
					myDBCol.setDBFilter();
/s
DatabaseColumn.setDBFilter() line: 97	
		if (theFilter instanceof CacheFilter) {
/ JA
			theFilter = new DatabaseFilter(theFilter.getFilterExpression(), this);
		}
		theReloadFlag = true;

/t

Table.mustReload() line: 710	
            for (Column myColumn : columns) {
/d
/ allemaal gedaan	,

		return myResult;
true

/c
DynaQuery.toSQL() line: 111	

		String myQuery = theQuery;
SELECT SHO.* FROM SHIPMENT_ORDER SHO WHERE IS_TEMPLATE = 0 AND ORGANIZATION_SYSTEMID IN {USER_ORGANIZATIONS} -#1 AND FROM_COUNTRY_SYSTEMID IN (SELECT SYSTEM_ID FROM COUNTRY WHERE ?)#--#2 AND TO_COUNTRY_SYSTEMID IN (SELECT SYSTEM_ID FROM COUNTRY WHERE ?)#--#3 AND STATUS_CODE_SYSTEMID IN (SELECT SYSTEM_ID FROM ORDER_STATUS WHERE ?)#--#4 AND HOLD_STATUS_SYSTEMID IN (SELECT SYSTEM_ID FROM HOLD_STATUS WHERE ?)#--#5 AND STATUS_CODE_SYSTEMID IN (SELECT SYSTEM_ID FROM ORDER_STATUS WHERE ?)#--#6 AND SYSTEM_ID IN (SELECT SHIPMENT_ORDER_SYSTEMID FROM SHIPMENT_ITEM WHERE ?)#--#7 AND ACT_SERVICE_LEVEL_SYSTEMID IN (SELECT SYSTEM_ID FROM SHIPMENT_SERVICE_LEVEL WHERE ?)#--#8 AND INCO_TERM_SYSTEMID IN (SELECT SYSTEM_ID FROM INCO_TERM WHERE ?)#--#9 AND SYSTEM_ID IN (SELECT SHIPMENT_ORDER_SYSTEMID FROM SHIPMENT_ITEM WHERE ?)#--#10 AND SHIPM_TYPE_SYSTEMID IN (SELECT SYSTEM_ID FROM SHIPMENT_ORDER_TYPE WHERE ?)#--#11 AND ORGANIZATION_SYSTEMID IN (SELECT SYSTEM_ID FROM ORGANIZATION WHERE ?)#--#12 AND CUSTOMER_STATUS_SYSTEMID IN (SELECT SYSTEM_ID FROM CUSTOMER_STATUS WHERE ?)#--#13 AND PREFERED_PARTY_SYSTEMID IN (SELECT SYSTEM_ID FROM PARTY WHERE ?)#--#14 AND ASSIGNEE_SYSTEMID IN (SELECT SYSTEM_ID FROM TMS_USER WHERE ?)#--#15 AND ORDER_PROCESS_SYSTEMID IN (SELECT SYSTEM_ID FROM ORDER_PROCESS WHERE ?)#-

		if (theFilterList.size() > 0) {
[>07-Sep-2015, 29]
			for (Object myElement : theFilterList) {
				myFilter = (Filter) myElement;
				myFilter = new DatabaseFilter(myFilter.getFilterExpression(), (DatabaseColumn) myFilter.getColumn());
				mySQL = myFilter.toSQL();
system_entry_date > '2015-09-07'

				myColumn = myFilter.getColumn();
				if (myColumn instanceof DatabaseJoinColumn) {
/ NEE
				} else {
...
						} else {
							myBuffer.append(" and " + mySQL);

myBuffer	StringBuffer  (id=23938)	
 and system_entry_date > '2015-09-07' and upper(shipment_order_id) LIKE '%29%'

		if (myQuery.indexOf(USER_ORGANIZATIONS) > -1) {
			myQuery = myQuery.replace(USER_ORGANIZATIONS, getUserOrganizations());

SELECT SHO.* FROM SHIPMENT_ORDER SHO WHERE IS_TEMPLATE = 0 AND ORGANIZATION_SYSTEMID IN (0,500,1020,1010,1) -#1 AND FROM_COUNTRY_SYSTEMID IN (SELECT SYSTEM_ID FROM COUNTRY WHERE ?)#--#2 AND TO_COUNTRY_SYSTEMID IN (SELECT SYSTEM_ID FROM COUNTRY WHERE ?)#--#3 AND STATUS_CODE_SYSTEMID IN (SELECT SYSTEM_ID FROM ORDER_STATUS WHERE ?)#--#4 AND HOLD_STATUS_SYSTEMID IN (SELECT SYSTEM_ID FROM HOLD_STATUS WHERE ?)#--#5 AND STATUS_CODE_SYSTEMID IN (SELECT SYSTEM_ID FROM ORDER_STATUS WHERE ?)#--#6 AND SYSTEM_ID IN (SELECT SHIPMENT_ORDER_SYSTEMID FROM SHIPMENT_ITEM WHERE ?)#--#7 AND ACT_SERVICE_LEVEL_SYSTEMID IN (SELECT SYSTEM_ID FROM SHIPMENT_SERVICE_LEVEL WHERE ?)#--#8 AND INCO_TERM_SYSTEMID IN (SELECT SYSTEM_ID FROM INCO_TERM WHERE ?)#--#9 AND SYSTEM_ID IN (SELECT SHIPMENT_ORDER_SYSTEMID FROM SHIPMENT_ITEM WHERE ?)#--#10 AND SHIPM_TYPE_SYSTEMID IN (SELECT SYSTEM_ID FROM SHIPMENT_ORDER_TYPE WHERE ?)#--#11 AND ORGANIZATION_SYSTEMID IN (SELECT SYSTEM_ID FROM ORGANIZATION WHERE ?)#--#12 AND CUSTOMER_STATUS_SYSTEMID IN (SELECT SYSTEM_ID FROM CUSTOMER_STATUS WHERE ?)#--#13 AND PREFERED_PARTY_SYSTEMID IN (SELECT SYSTEM_ID FROM PARTY WHERE ?)#--#14 AND ASSIGNEE_SYSTEMID IN (SELECT SYSTEM_ID FROM TMS_USER WHERE ?)#--#15 AND ORDER_PROCESS_SYSTEMID IN (SELECT SYSTEM_ID FROM ORDER_PROCESS WHERE ?)#-

		// Remove unused join stuff
		while (true) {
			int myStart = myQuery.indexOf("-#");
108
			int myEnd = myQuery.indexOf("#-", myStart);
			myQuery = myQuery.substring(0, myStart) + myQuery.substring(myEnd + 2);

/ rm alles wat tussen de -# en #-'s staat	,  zolang ze er zijn	,

/ TODO (Wanneer zijn de nodige -# en #-'s weggehaald, zodat we nu nog met een aantal zitten?)

			myQuery += myBuffer.toString();

		return myQuery;
SELECT SHO.* FROM SHIPMENT_ORDER SHO WHERE IS_TEMPLATE = 0 AND ORGANIZATION_SYSTEMID IN (0,500,1020,1010,1)  and system_entry_date > '2015-09-07' and upper(shipment_order_id) LIKE '%29%'


/ 7	.

/ SET TABLE RESFRESH

/ we vragen de list van shipment orders, via het menu, met 2 filters , op shipment_order_id en system_entry_date	,

/ als we het menu use, is dat hetzelfde als het scherm laten staan en click op filter button	,

shipment_order_list_xml.generate() line: 393	
/s
TableManager.getTable(String, Request) line: 90	
/=
	public Table getTable(String aTableName, Request aRequest) {
aTableName="shipment-order"
		Table myTable = null;
		String myStartEmptyString = aRequest.getParameter("startempty");
null
		boolean myStartEmpty = myStartEmptyString != null && TRUE.equals(myStartEmptyString);
false
		if (!myStartEmpty) {
			myTable = getFromCache(mySession, aTableName);
/s
TableManager.getFromCache(Session, String) line: 98	
		Table myTable = (Table) aSession.getAttribute(aTableName + TABLE_SUFFIX);
/ aTableName + TABLE_SUFFIX=shipment-order_Table
myTable	Table  (id=21066)	
		aSession.setAttribute(LAST_USED_TABLE, aTableName);
		return myTable;
/t
TableManager.getTable(String, Request) line: 90	
			myTable = getFromCache(mySession, aTableName);
/d
		if (!myStartEmpty) {
/ JA
//////////////////////////////////////////////////
/ GET TABLE RESFRESH
			String myRefreshParam = aRequest.getParameter("refresh");
false
			myTable.setForceRefresh(myRefreshParam != null && TRUE.equals(myRefreshParam));
/s
Table.setForceRefresh(boolean) line: 875	
		forceRefreshFlag = aFlag;
false
/t
			myTable.setForceFilter(myRefreshParam != null && FALSE.equals(myRefreshParam));
/s
Table.setForceFilter(boolean) line: 865	
		forceFilterFlag = aFlag;
true

/c
Table.mustReload() line: 691	
		if (forceRefreshFlag) {
/ NEE
			myResult = true;
/ NIET
		} else if (forceFilterFlag) {
/ JA
			myResult = false;

/ TODO (Wanneer 3de mog?)

		return myResult;

/c
Table.filter() line: 491	
		for (Column myCol : columns) {
			myFilterBuffer.append(myCol.getFilterExpression());
			myFilterBuffer.append("#");
		}
##29######################>07-Sep-2015#

		if (!myFilterBuffer.toString().equals(oldFilter)) {
			rows.clear();

			Column[] myCols = getColumns();
			row: for (Row myRow : originalRows) {
[]
			reshuffle();
/= Collections.sort

		// If the code is executed,data has been refreshed
		forceRefreshFlag = false;
/ Was al bij ons	, want de hadden niet op refresh click	,

/ Geen DynaQuery.toSQL	,

/ 7	. 

/ we click refresh met op de list van shipment orders, met 2 filters , op shipment_order_id en system_entry_date	,

/s
TableManager.getTable(String, Request) line: 74	
		Table myTable = null;
		String myStartEmptyString = aRequest.getParameter("startempty");
		boolean myStartEmpty = myStartEmptyString != null && TRUE.equals(myStartEmptyString);
false
		if (!myStartEmpty) {
			myTable = getFromCache(mySession, aTableName);
		}
		if (!myStartEmpty) {
			String myRefreshParam = aRequest.getParameter("refresh");
true
			myTable.setForceRefresh(myRefreshParam != null && TRUE.equals(myRefreshParam));
true
			myTable.setForceFilter(myRefreshParam != null && FALSE.equals(myRefreshParam));
false

/c
Table.setFilter(Map<String,String>) line: 849	
/ Hetzelfde voor filter/refresh

/c
Table.mustReload() line: 679	
		if (forceRefreshFlag) {
			oldFilter = "";
			myResult = true;

		if (myResult) {
			// The table will be reloaded from the DB, therefore set the DBFilter
			// in all columns
			for (Column myColumn : columns) {
				if (myColumn instanceof DatabaseColumn) {
					DatabaseColumn myDBCol = (DatabaseColumn) myColumn;
					myDBCol.setDBFilter();

		return myResult;
true

/c
DynaQuery.toSQL() line: 111	


/c
Table.filter() line: 493	
		for (Column myCol : columns) {
			myFilterBuffer.append(myCol.getFilterExpression());
			myFilterBuffer.append("#");
		}
##29######################>07-Sep-2015#

/ 7	. 

/ Als we config, planning, parties	, dan krijgen we een list van party types	, 
/ Als we een party type edit,	 is er een refresh=true param	, 
/ Maar we zien geen DynaQuery.toSQL
/ TODO

/ 7	. 

/ party types	,

$ vi party-type_list.xml

            Collection myList = (Collection) request.getAttribute("dynatable_list");
/ query is gedaan NIET met DynaQuery	,

$ vi party-type-preselection-list.xsl

   <xsl:template name="custom_header">
       <script type="text/javascript">
            function showParties(aSystemId){
              document.location.href="party_list?party_type_systemid=" + aSystemId + "&amp;refresh=true";
            }
        </script>
    </xsl:template>
   
    <xsl:template match="row">
        <tr class="list{(position()-1) mod 2}">
            <td class="list" width="20">
                <a href="#">
                    <xsl:attribute name="onclick">
                        <xsl:text>javascript:showParties(</xsl:text>
                        <xsl:value-of select="./column[@name='SYSTEMID']"/>

/ Dus de js is def in de xsl	, NIET in dynatable.js	, 

/ parties	,

$ vi party_list.xml

            Collection myList =  (Collection) request.getAttribute("dynatable_list");
/ query al gedaan in action	, niet DynaQuery.toSQL	,

/ Maar WH altijd generic-dynatablepage.xsl	,
/ TODO
/ Want de refresh, filter buttons komen hieruit	, 
$ vi generic-dynatablepage.xsl

	<xsl:template match="page">
		<html>
			<head>
				<title>
					<xsl:value-of select="dynatable/@recordlabel" />
					management
				</title>
				<div class="dialog" id="dialog" title="please.wait" i18n:attr="title">
            		<p><i18n:text>already.loading</i18n:text></p>
        		</div>
				<link rel="stylesheet" href="../lookandfeel/styles/style.css" type="text/css" />
				<meta http-equiv="Content-Type" content="tex/html; charset=UTF-8" />
				<meta http-equiv="Pragma" content="NO-CACHE" />
				<script type="text/javascript" src="../script/class.pagerequest.js"></script>
				<script type="text/javascript" src="../script/jquery.min.js" />
				<script type="text/javascript" src="../script/jquery-ui.min.js" />
->				<script type="text/javascript" src="../script/dynatable.js"></script>

/ als we filter click op list van party types, 	

$ vi dynatable.js

function filter(){
   myAddress = getLocation();
"https://test-pnl.mp-objects.com/pnllogistics/oms/party-type_preselect_list"

/ myAddress is dus de page waarop je bent	, (als je filter click)	,

/ 7	. 

/ als we config, planning, parties
/s
PartyTypeListAction(AbstractAction).act(Redirector, SourceResolver, Map, String, Parameters) line: 137	




/ 7	. 

/ Als we config, planning, parties	, dan krijgen we een list van party types	, 

$ vi oms-sitemap.xmap

			<map:action logger="party" name="partyTypeList" src="com.mpobjects.oms.control.partytype.action.PartyTypeListAction"/>

			<map:match pattern="party-type_preselect_list">
				<map:act type="partyTypeList"/>
				<map:call resource="dynatablePage">
				    <map:parameter name="xsp" value="xsp/party-type_list.xml"/>
				    <map:parameter name="xsl" value="xsl/party-type-preselection-list.xsl"/>
				    <map:parameter name="edit" value="false"/>
				</map:call>
			</map:match>

/s
PartyTypeListAction(AbstractAction).act(Redirector, SourceResolver, Map, String, Parameters) line: 137	
				Map myMap = act();
/s
PartyTypeListAction(ListAction).act() line: 58	

		String myIdentifier = this.getClass().getPackage().getName() + "." + this.getClass().getName() + "_" + getRequest().getRequestURI();
com.mpobjects.oms.control.partytype.action.com.mpobjects.oms.control.partytype.action.PartyTypeListAction_/tms/oms/party-type_preselect_list


		if (StringUtils.isNotEmpty(getRequest().getParameter("refresh")) 
null
			&& getRequest().getParameter("refresh").equals("true")) {
/ NEE
			resetListLoaded(getSession());
/ NIET
		}
/ Als refresh=true, dan clear attribute LIST_LOADED_ATTRIBUTE	, omdat we opnieuw gaan load	,

		if (!myIdentifier.equals(getSession().getAttribute(LIST_LOADED_ATTRIBUTE))) {
/ JA
/ want !=null	,
/ WH getSession().getAttribute(LIST_LOADED_ATTRIBUTE) betekent: is er nog niet	,
			resetListLoaded(getSession());
/s
		aSession.removeAttribute(LIST_LOADED_ATTRIBUTE);
/t

		if (getSession().getAttribute(LIST_LOADED_ATTRIBUTE) == null) {
LIST_LOADED_ATTRIBUTE=dynatable_list_loaded
			// only load list if refresh=false is NOT added to the url
/ REFRESH
			if (!"false".equals(getRequest().getParameter("refresh"))) {
/ JA	, 
/ false!=null
				Collection myList = getList();
/s
PartyTypeListAction.getList() line: 36	
		return new BeanWrapper<PartyTypeDAO>(PartyTypeDAO.class).getBean().getAll();

/ Dus NIET DynaQuery.toSQL	,
/t
				Collection myList = getList();
/d
[com.mpobjects.oms.model.entity.partytype.PartyType@466c191b[OPDRACHTGEVER,Opdrachtgever (Bill to Party)],
com.mpobjects.oms.model.entity.partytype.PartyType@1d4cf95b[SORTEERHUB,Collectie of Distributiehub (Partner locatie)],
com.mpobjects.oms.model.entity.partytype.PartyType@2886d464[PARTNER,Partner],
com.mpobjects.oms.model.entity.partytype.PartyType@2be20605[RETOURADRES,Retour adres],
com.mpobjects.oms.model.entity.partytype.PartyType@3f948c5[ADRES_VASTE_COLLECT,Adres voor vaste collectie opdracht],
com.mpobjects.oms.model.entity.partytype.PartyType@63187f8c[ADRES,Adres opgeslagen uit Interface]]
/ Dit zijn ze dus allemaal	, 
/ Geen filter hier	,
/ TODO

				getRequest().setAttribute(DYNATABLE_LIST_ATTRIBUTE, myList);
				getSession().setAttribute(LIST_LOADED_ATTRIBUTE, myIdentifier);

		String myDynaListName = getDynatableListName();
/s
			return null;
/t
		String myRecordLabel = getRecordLabelName();
/s
			return null;

		return EMPTY_MAP;

/c
TableManager.getTable(String, Request) line: 74	
/=
	public Table getTable(String aTableName, Request aRequest) {
/ aTableName="party-type"

		boolean myStartEmpty = myStartEmptyString != null && TRUE.equals(myStartEmptyString);
		if (!myStartEmpty) {
			myTable = getFromCache(mySession, aTableName);
null
/ Na reload config	,
/ of, 
myTable	Table  (id=22191)	
	columns	ArrayList  (id=22408)	
[Column:SYSTEMID, Column:code, Column:description]
	dynaQuery	null	
	filterCache	FilterCache  (id=22034)	
	name	"party-type" (id=21974)	
	oldFilter	"###" (id=25347)	
	rowMap	Collections$SynchronizedMap  (id=25380)	
{26820894=com.mpobjects.view.util.table.Row@65b795e3,
 26825641=com.mpobjects.view.util.table.Row@77d19e40,
 26681476=com.mpobjects.view.util.table.Row@62ecb934,
 26681477=com.mpobjects.view.util.table.Row@237337a9,
 26681478=com.mpobjects.view.util.table.Row@614b4a6d,
 26681479=com.mpobjects.view.util.table.Row@16036c02}
	

/ NB
/ Dus het vorige filter	, we hebben nu wel een filter 

		if (myTable == null) {
/ NEE 
		if (myTable == null) {
/ JA
			myTable = new Table(aTableName, new FilterManager().getFilterCache(mySession), aRequest);
/s
new FilterManager().getFilterCache(mySession)=
				FilterCache myCache = (FilterCache) aSession.getAttribute(FILTER_CACHE);
/t
/s
Table.<init>(String, FilterCache, Request) line: 111	
		setRequest(aRequest);
		name = aName;
		filterCache = aFilterCache;
/ de filterCache was er al	,

			storeInCache(mySession, myTable, aTableName);
/s
				aSession.setAttribute(aTableName + TABLE_SUFFIX, aTable);
				aSession.setAttribute(LAST_USED_TABLE, aTableName);
/t
TableManager.getTable(String, Request) line: 88	
		if (myTable == null) {
/ JA
/ of	,
/ NEE
/d
		if (!myStartEmpty) {
/ JA
			String myRefreshParam = aRequest.getParameter("refresh");
null
			myTable.setForceRefresh(myRefreshParam != null && TRUE.equals(myRefreshParam));
false
			myTable.setForceFilter(myRefreshParam != null && FALSE.equals(myRefreshParam));

/c

$ vi party_type_list.xml
           myTable.addHiddenColumn("SYSTEMID");
            myTable.addColumn("code");
            myTable.addColumn("description");
/s
Table.addHiddenColumn(String) line: 312	
		Column myColumn = new CacheColumn(aName);
aName	"SYSTEMID" (id=30020)	
		myColumn.setHidden();
		addColumn(myColumn);
/s
Table.addColumn(Column) line: 999	
		columns.add(aColumn);
		aColumn.setTable(this);

		if (getRequest() != null) {
			// Check if there is a filter in the filter cache.
			String myKey = getScreenId() + "." + getName() + "." + aColumn.getName();
myKey	"party-type.party-type.SYSTEMID" (id=31913)	
			String[] myFilter = filterCache.getFilterValue(myKey);
null
/ want	,
this.filterCache= {
open-crossdock-dashboard-serviceaction-list.dashboard-serviceaction-list.req_start_after.appl_filter=>06-Sep-2015, 
planned-crossdock-dashboard-serviceaction-list.dashboard-serviceaction-list.req_start_after.appl_filter=>06-Sep-2015, 
service_action_template.service_action_template.service_action_type.user_filter=, 
parcel-track-and-trace.parcel-track-and-trace.system_entry_date.appl_filter=>15-Sep-2015, 
shipment-order.shipment-order.system_entry_date.appl_filter=>08-Sep-2015, 
service_action_template.service_action_template.to_city.user_filter=, 
service_action_template.service_action_template.name.user_filter=collect, 
shipment-order-booking-search.shipment-order-booking-search.system_entry_date.appl_filter=>15-Sep-2015, 
shipment-order-list-track.shipment-order-booking-search.system_entry_date.appl_filter=>15-Sep-2015, 
shipment-order-booking-search.shipment-item-list-track.system_entry_date.appl_filter=>15-Sep-2015, 
service_action_template.service_action_template.organization.user_filter=, 
service-order.service-order.status.appl_filter=<9000, 
shipment-item-list-track.shipment-order-booking-search.system_entry_date.appl_filter=>15-Sep-2015, 
file.file.uploaded_date.appl_filter=>29-Sep-2015 09:08, 
shipment-item-list-track.parcel-track-and-trace.system_entry_date.appl_filter=>15-Sep-2015, 
service-order.service-order.planned_start_after.appl_filter=>08-Sep-2015, 
service_action_template.service_action_template.to_country.user_filter=, 
service_action_template.service_action_template.from_country.user_filter=, 
service_action_template.service_action_template.from_city.user_filter=}

/ we zien geen party-type keys	,

			if (myFilter != null) {
/ NEE
				setFilter(aColumn, myFilter[0], myFilter[1]);
/ NIET

/c
Table.addColumn(String) line: 208	
		aName = StringUtils.formatJavaToSql(aName).toString();
code
		Column myColumn = new CacheColumn(aName);
myColumn	CacheColumn  (id=31971)	
	theFilter	null	
	theName	"code" (id=31957)	
	theType	0						/ TYPE_STRING

		addColumn(myColumn);
/s
	private void addColumn(Column aColumn) {
		columns.add(aColumn);
		aColumn.setTable(this);
/ weer geen filter	,



/c
Table.mustReload() line: 693	
		if (forceRefreshFlag) {
/ NEE
		} else if (forceFilterFlag) {
/ NEE
		} else {
			for (Column myColumn : columns) {
Column:SYSTEMID
				if (myColumn.mustReload()) {
/s
CacheColumn.mustReload() line: 60	
		return !theUsedFlag;
!false=true
/t
					myResult = true;
					break;
				}
			}
		}
		if (myResult) {
			// The table will be reloaded from the DB, therefore set the DBFilter
			// in all columns
			for (Column myColumn : columns) {
				if (myColumn instanceof DatabaseColumn) {
/ NEE
					DatabaseColumn myDBCol = (DatabaseColumn) myColumn;
					myDBCol.setDBFilter();
/ NIET

/c
Table.filter() line: 491	

		for (Column myCol : columns) {
			myFilterBuffer.append(myCol.getFilterExpression());
			myFilterBuffer.append("#");
		}

/c
Table.resetScreenId() line: 778	
		oldScreenId = getScreenId();
"party-type"
		getRequest().getSession().setAttribute(ATTRIBUTE_SCREEN_ID, null);


/ 7	. 

/ we zijn op de party types screen, 
/ we fill in party_id "Op",	 
/ we click Filter	,

/s
dynatable.js
function filter(){
   myAddress = getLocation();
"http://localhost:8080/tms/oms/party-type_preselect_list"

   var myDoElement = document.getElementById("do");
   myDoElement.value="filter";
   
   document.filterform.action=myAddress + '?screenId='+getScreenId();
   if (maySubmit()) {
       document.filterform.submit();
   }
   alreadySubmitted=true;

/s
PartyTypeListAction(AbstractAction).act(Redirector, SourceResolver, Map, String, Parameters) line: 137	
				Map myMap = act();
/s
PartyTypeListAction(ListAction).act() line: 58	
		String myIdentifier = this.getClass().getPackage().getName() + "." + this.getClass().getName() + "_" + getRequest().getRequestURI();

		if (StringUtils.isNotEmpty(getRequest().getParameter("refresh")) && getRequest().getParameter("refresh").equals("true")) {
/ NEE

		if (!myIdentifier.equals(getSession().getAttribute(LIST_LOADED_ATTRIBUTE))) {
/ NEE

		if (getSession().getAttribute(LIST_LOADED_ATTRIBUTE) == null) {
/ NEE

/c
TableManager.getTable(String, Request) line: 74	
/=
	public Table getTable(String aTableName, Request aRequest) {
aTableName	"party-type" (id=21974)	

		if (!myStartEmpty) {
			myTable = getFromCache(mySession, aTableName);
myTable	Table  (id=22191)	
	columns	ArrayList  (id=22408)	
[Column:SYSTEMID, Column:code, Column:description]
	name	"party-type" (id=21974)	
	oldFilter	"###" (id=25347)	
	rows	ArrayList  (id=25384)	
[com.mpobjects.view.util.table.Row@62ecb934,
 com.mpobjects.view.util.table.Row@614b4a6d,
 com.mpobjects.view.util.table.Row@16036c02,
 com.mpobjects.view.util.table.Row@65b795e3,
 com.mpobjects.view.util.table.Row@237337a9,
 com.mpobjects.view.util.table.Row@77d19e40]:

		if (myTable == null) {
/ NEE
		}
		if (!myStartEmpty) {
			String myRefreshParam = aRequest.getParameter("refresh");
null
			myTable.setForceRefresh(myRefreshParam != null && TRUE.equals(myRefreshParam));
/ -> false
			myTable.setForceFilter(myRefreshParam != null && FALSE.equals(myRefreshParam));
		}

/c
Table.setFilter(Map<String,String>) line: 805	
/=
	public void setFilter(Map<String, String> aMap) {
{2=, 1=op}
		for (String myKey : aMap.keySet()) {
				Column myColumn = myCols[myIndex];
Column:description
				String myValue = aMap.get(myKey);
""
				} else {
					setFilter(myColumn, myValue, FilterCache.FILTER_TYPE_USER);

		for (String myKey : aMap.keySet()) {
				Column myColumn = myCols[myIndex];
Column:code
				String myValue = aMap.get(myKey);
"op"
				} else {
					setFilter(myColumn, myValue, FilterCache.FILTER_TYPE_USER);
/s
		aColumn.setFilter(aValue);

		// Also update the cache
		String myFilterKey = "" + getScreenId() + "." + getName() + "." + aColumn.getName();
		filterCache.setFilterValue(myFilterKey, aValue, aFilterType);
/ Doet NIETS	,
/ TODO

		// Update the DynaQuery
		if (dynaQuery != null && (aColumn instanceof DatabaseColumn || aColumn instanceof DatabaseJoinColumn)) {
/ NEE

/c
Table.mustReload() line: 715	
/ Doet NIETS	, want	,
		} else {
			for (Column myColumn : columns) {
				if (myColumn.mustReload()) {
/s
					return !theUsedFlag;
false
/ theUsedFlag=true


/c
Table.filter() line: 491	
		for (Column myCol : columns) {
			myFilterBuffer.append(myCol.getFilterExpression());
			myFilterBuffer.append("#");
		}
myFilterBuffer	StringBuffer  (id=26304)	
#op##
		if (!myFilterBuffer.toString().equals(oldFilter)) {
/ JA
			oldFilter = myFilterBuffer.toString();
#op##
			rows.clear();

			Column[] myCols = getColumns();
			row: for (Row myRow : originalRows) {
				int i = 0;
				for (RowValue element : myRow.getValues()) {
element	RowValue  (id=26338)	
	theRow	Row  (id=26313)	
		theValues	ArrayList  (id=26451)	
			elementData	Object[10]  (id=26456)	
				[0]	RowValue  (id=26338)	
					theValue	"26681476" (id=26415)	
				[1]	RowValue  (id=26459)	
					theValue	"OPDRACHTGEVER" (id=26465)	
				[2]	RowValue  (id=26460)	
					theValue	"Opdrachtgever (Bill to Party)" (id=26468)	
			size	3	

					if (!myCols[i++].filter(element)) {
/ NEE
/ Op "" metches alles	, deze rij matches ook op column 1	,  
/ JA	, bij 2de row	, want deze rij matches NIET op column 1	, 
						continue row;
					}
				}
				rows.add(myRow);
/ JA	, voor 1ste row	,
			}

			reshuffle();
/ sort	,

/ we houden maar 1 row over	, 

/ 7	. 

/ we click refresh , ook met deze filter	, op party types screen	, 
/ zonet clicked we filter	,

/s
dynatable.js
  myAddress = getLocation() + '?refresh=true';
"http://localhost:8080/tms/oms/party-type_preselect_list?refresh=true"
   document.filterform.action=myAddress;
   if (maySubmit()) {
       document.filterform.submit();

/s
PartyTypeListAction(AbstractAction).act(Redirector, SourceResolver, Map, String, Parameters) line: 137	

		String myIdentifier = this.getClass().getPackage().getName() + "." + this.getClass().getName() + "_" + getRequest().getRequestURI();

		if (StringUtils.isNotEmpty(getRequest().getParameter("refresh")) && getRequest().getParameter("refresh").equals("true")) {
/ JA
			resetListLoaded(getSession());
/ Dit was bij filter NIET	,

		if (!myIdentifier.equals(getSession().getAttribute(LIST_LOADED_ATTRIBUTE))) {
/ JA
/ Zonet geleegd	,
			resetListLoaded(getSession());

		if (getSession().getAttribute(LIST_LOADED_ATTRIBUTE) == null) {
			// only load list if refresh=false is NOT added to the url
			if (!"false".equals(getRequest().getParameter("refresh"))) {
				Collection myList = getList();
/s
					return new BeanWrapper<PartyTypeDAO>(PartyTypeDAO.class).getBean().getAll();
/////////////////////////////////////////////////////
/ REFRESH GIVES RELOAD	,
/ Inderdaad	, hier gaat opnieuw de query doen	,
//////////////////////////////////////////////////////

/ we zien	,
 429342 LOG:  execute <unnamed>: select this_.SYSTEM_ID as SYSTEM1_75_0_, this_.PARTY_TYPE as PARTY2_75_0_, this_.DESCRIPTION as DESC
 429342 RIPT3_75_0_, this_.IS_DELETED as IS4_75_0_ from PARTY_TYPE this_ where this_.IS_DELETED=$1
 429343 DETAIL:  parameters: $1 = 'f'

/ myList
[
com.mpobjects.oms.model.entity.partytype.PartyType@6526ef67[OPDRACHTGEVER,Opdrachtgever (Bill to Party)], 
com.mpobjects.oms.model.entity.partytype.PartyType@5f2f8712[SORTEERHUB,Collectie of Distributiehub (Partner locatie)], 
com.mpobjects.oms.model.entity.partytype.PartyType@294cdf90[PARTNER,Partner], 
com.mpobjects.oms.model.entity.partytype.PartyType@75e97c1e[RETOURADRES,Retour adres], 
com.mpobjects.oms.model.entity.partytype.PartyType@33d3d20c[ADRES_VASTE_COLLECT,Adres voor vaste collectie opdracht], 
com.mpobjects.oms.model.entity.partytype.PartyType@17832c69[ADRES,Adres opgeslagen uit Interface]]

				getRequest().setAttribute(DYNATABLE_LIST_ATTRIBUTE, myList);
/ Dit is voor	, 
$ vi party-type_list.xml
            Collection myList = (Collection) request.getAttribute("dynatable_list");

				getSession().setAttribute(LIST_LOADED_ATTRIBUTE, myIdentifier);
com.mpobjects.oms.control.partytype.action.com.mpobjects.oms.control.partytype.action.PartyTypeListAction_/tms/oms/party-type_preselect_list
/ TODO (Doet scs hier wat mee?) Want Table.filter uses this.originalRows	)

/c
TableManager.getTable(String, Request) line: 74	
		if (!myStartEmpty) {
			myTable = getFromCache(mySession, aTableName);
myTable	Table  (id=22191)	
	rows	ArrayList  (id=25384)	
[com.mpobjects.view.util.table.Row@62ecb934]
/ 1 row 	, van de vorige filter	,

		if (!myStartEmpty) {
			String myRefreshParam = aRequest.getParameter("refresh");
true
			myTable.setForceRefresh(myRefreshParam != null && TRUE.equals(myRefreshParam));
/s
		forceRefreshFlag = aFlag;
/t
			myTable.setForceFilter(myRefreshParam != null && FALSE.equals(myRefreshParam));
/s
		forceFilterFlag = aFlag;
/t

/c
Table.setFilter(Map<String,String>) line: 805	
/=
	public void setFilter(Map<String, String> aMap) {
{2=, 1=op}

/ set filters op de columns	, 

/c
Table.mustReload() line: 704	
		if (forceRefreshFlag) {
			myResult = true;

		if (myResult) {
			// The table will be reloaded from the DB, therefore set the DBFilter
			// in all columns
			for (Column myColumn : columns) {
				if (myColumn instanceof DatabaseColumn) {
/ NEE
					DatabaseColumn myDBCol = (DatabaseColumn) myColumn;
					myDBCol.setDBFilter();
/ NIET
/ in .setFilter	hadden we fiters op de columns set	, wat gebeurt hier	?
/ TODO

/c
Table.filter() line: 507	
		for (Column myCol : columns) {
			myFilterBuffer.append(myCol.getFilterExpression());
			myFilterBuffer.append("#");
		}
#op##

			Column[] myCols = getColumns();
			row: for (Row myRow : originalRows) {
/ Dit zijn de rows de 1ste keer 	, WH als je config, planning, parties geeft,	 
/ TODO
/ Wat als er een party type bijkomt	?
/ TODO
				int i = 0;
				for (RowValue element : myRow.getValues()) {
					if (!myCols[i++].filter(element)) {

/ PAUL

ListAction.class
	public Map act() throws Exception {

		if (getSession().getAttribute(LIST_LOADED_ATTRIBUTE) == null) {
			if (!"false".equals(getRequest().getParameter("refresh"))) {
				Collection myList = getList();
				getRequest().setAttribute(DYNATABLE_LIST_ATTRIBUTE, myList);
/ Voor in party_list.xml
				getSession().setAttribute(LIST_LOADED_ATTRIBUTE, myIdentifier);
/ TODO

$ vi party_list.xml

    Collection myList =  (Collection) request.getAttribute("dynatable_list");
            for (Iterator myIt = myList.iterator();myIt.hasNext();){
	                myTable.addRow(myRow);
/ Zo komen de rows in Table.originalRows	,



/ Einde PAUL


/ 7	. 

/ we click een edit button  op een party type	,   in de party type 

$ vi party-type_preselect_list.xsl

   <xsl:template name="custom_header">
       <script type="text/javascript">
            function showParties(aSystemId){
              document.location.href="party_list?party_type_systemid=" + aSystemId + "&amp;refresh=true";
            }
        </script>
    </xsl:template>



$ vi oms-sitemap.xmap
			<map:action logger="party" name="partyList" src="com.mpobjects.oms.control.party.action.PartyListAction"/>

			<map:match pattern="party_list">
				<map:act type="partyList"/>
				<map:call resource="dynatablePage">
					<map:parameter name="xsp" value="xsp/party_list.xml"/>
				</map:call>
			</map:match>

/s
PartyListAction(AbstractAction).act(Redirector, SourceResolver, Map, String, Parameters) line: 171	
				Map myMap = act();
/s
PartyListAction(ListAction).act() line: 58	
		String myIdentifier = this.getClass().getPackage().getName() + "." + this.getClass().getName() + "_" + getRequest().getRequestURI();
com.mpobjects.oms.control.party.action.com.mpobjects.oms.control.party.action.PartyListAction_/tms/oms/party_list

		if (StringUtils.isNotEmpty(getRequest().getParameter("refresh")) && getRequest().getParameter("refresh").equals("true")) {
/ JA
			resetListLoaded(getSession());
		}
		if (!myIdentifier.equals(getSession().getAttribute(LIST_LOADED_ATTRIBUTE))) {
/ JA	, 
/ !=null
/ TODO (We hadden hierboven deze attr in session set)	, 
			resetListLoaded(getSession());
		}

			if (!"false".equals(getRequest().getParameter("refresh"))) {
/ JA
/ true!=false
				Collection myList = getList();
/s
PartyListAction.getList() line: 30	
		Util.refreshList(getRequest(), getSession());
/s
Util.refreshList(Request, Session) line: 32	
		String refresh = aRequest.getParameter("refresh");
		if (refresh != null && StringUtils.isTrue(refresh)) {
			new FilterManager().getFilterCache(aSession).flushScreen(PARTY_SCREENID);
/s
FilterCache.flushScreen(String) line: 58	
/=
	public void flushScreen(String aScreenId) {
/ aScreenId="party"
		myKeys.addAll(theFilterMap.keySet());

/ Intermezzo

this	FilterCache  (id=22034)	
	theFilterMap	HashMap  (id=22147)	

{open-crossdock-dashboard-serviceaction-list.dashboard-serviceaction-list.req_start_after.appl_filter=>06-Sep-2015,
 planned-crossdock-dashboard-serviceaction-list.dashboard-serviceaction-list.req_start_after.appl_filter=>06-Sep-2015,
 service_action_template.service_action_template.service_action_type.user_filter=,
 parcel-track-and-trace.parcel-track-and-trace.system_entry_date.appl_filter=>15-Sep-2015,
 shipment-order.shipment-order.system_entry_date.appl_filter=>08-Sep-2015,
 service_action_template.service_action_template.to_city.user_filter=,
 service_action_template.service_action_template.name.user_filter=collect,
 shipment-order-booking-search.shipment-order-booking-search.system_entry_date.appl_filter=>15-Sep-2015,
 shipment-order-list-track.shipment-order-booking-search.system_entry_date.appl_filter=>15-Sep-2015,
 shipment-order-booking-search.shipment-item-list-track.system_entry_date.appl_filter=>15-Sep-2015,
 service_action_template.service_action_template.organization.user_filter=,
 service-order.service-order.status.appl_filter=<9000,
 shipment-item-list-track.shipment-order-booking-search.system_entry_date.appl_filter=>15-Sep-2015,
 file.file.uploaded_date.appl_filter=>29-Sep-2015 09:08,
 shipment-item-list-track.parcel-track-and-trace.system_entry_date.appl_filter=>15-Sep-2015,
 service-order.service-order.planned_start_after.appl_filter=>08-Sep-2015,
 service_action_template.service_action_template.to_country.user_filter=,
 service_action_template.service_action_template.from_country.user_filter=,
 service_action_template.service_action_template.from_city.user_filter=}

/ Einde Intermezzo

/ myKeys=
[open-crossdock-dashboard-serviceaction-list.dashboard-serviceaction-list.req_start_after.appl_filter,
 planned-crossdock-dashboard-serviceaction-list.dashboard-serviceaction-list.req_start_after.appl_filter,
 service_action_template.service_action_template.service_action_type.user_filter,
 parcel-track-and-trace.parcel-track-and-trace.system_entry_date.appl_filter,
 shipment-order.shipment-order.system_entry_date.appl_filter,
 service_action_template.service_action_template.to_city.user_filter,
 service_action_template.service_action_template.name.user_filter,
 shipment-order-booking-search.shipment-order-booking-search.system_entry_date.appl_filter,
 shipment-order-list-track.shipment-order-booking-search.system_entry_date.appl_filter,
 shipment-order-booking-search.shipment-item-list-track.system_entry_date.appl_filter,
 service_action_template.service_action_template.organization.user_filter,
 service-order.service-order.status.appl_filter,
 shipment-item-list-track.shipment-order-booking-search.system_entry_date.appl_filter,
 file.file.uploaded_date.appl_filter,
 shipment-item-list-track.parcel-track-and-trace.system_entry_date.appl_filter,
 service-order.service-order.planned_start_after.appl_filter,
 service_action_template.service_action_template.to_country.user_filter,
 service_action_template.service_action_template.from_country.user_filter,
 service_action_template.service_action_template.from_city.user_filter]

		for (String myKey : myKeys) {
			if (myKey.startsWith(aScreenId)) {
/ NEE

				theFilterMap.remove(myKey);
/t

			new TableManager().flushTableCache(aRequest, PARTY_SCREENID);
/s
				mySession.removeAttribute(aTableName + TABLE_SUFFIX);
/ aTableName="party"

/t
PartyListAction.getList() line: 33	
		Util.refreshList(getRequest(), getSession());
/d
		String myPartyType = (String) getRequest().getAttribute("partyType");
null
		String myPartyTypeSystemid = getRequest().getParameter(PARTY_TYPE_SYSTEM_ID);
	private final String PARTY_TYPE_SYSTEM_ID = "party_type_systemid";
26681478
/ Klopt	, de uri staat in js	, dat zagen we aan het begin in .xsl	,

			} else { // override session attribute with request parameter
				getSession().setAttribute(PARTY_TYPE_SYSTEM_ID, myPartyTypeSystemid);

			return MpoBeanFactory.getBean(PartyDAO.class).getPartyListByTypeSystemid(Integer.parseInt(myPartyTypeSystemid));
/ 26681478 is een system_id van een party_type	,

/ Dus GEEN DynaQuery.toSQL	,

/ we zien dat de query wordt gedaan 	, niet ogv refresh=true	, maar ogv party_type_systemid=... attribute	,
/ TODO

/ we zien	,
select ... 
from PARTY this_ 
left outer join ORGANIZATION organizati2_ on this_.ORGANIZATION_SYSTEMID=organizati2_.SYSTEM_ID 
left outer join ORGANIZATION organizati3_ on organizati2_.ORGANIZATION_GROUP=organizati3_.SYSTEM_ID 
where this_.organization_Systemid in (select uo.organization_systemid from user_organization uo where uo.user_systemid = $1) 
and this_.PARTY_TYPE_SYSTEMID=$2
DETAIL:  parameters: $1 = '26682479', $2 = '26681478'
LOG:  execute S_1: COMMIT

/t
PartyListAction(ListAction).act() line: 72	
				Collection myList = getList();
/d
[
][SystemId: 26681553; Party: ZWA; PartyType: com.mpobjects.oms.model.entity.partytype.PartyType@568e676e[SORTEERHUB,Collectie of Distributiehub (Partner locatie)]], 
][SystemId: 26681529; Party: TBA; PartyType: com.mpobjects.oms.model.entity.partytype.PartyType@568e676e[SORTEERHUB,Collectie of Distributiehub (Partner locatie)]], 
][SystemId: 26681525; Party: EHV; PartyType: com.mpobjects.oms.model.entity.partytype.PartyType@568e676e[SORTEERHUB,Collectie of Distributiehub (Partner locatie)]], 
][SystemId: 26681543; Party: INT; PartyType: com.mpobjects.oms.model.entity.partytype.PartyType@568e676e[SORTEERHUB,Collectie of Distributiehub (Partner locatie)]], 
][SystemId: 26681533; Party: DOR; PartyType: com.mpobjects.oms.model.entity.partytype.PartyType@568e676e[SORTEERHUB,Collectie of Distributiehub (Partner locatie)]], 
][SystemId: 26681539; Party: HOA; PartyType: com.mpobjects.oms.model.entity.partytype.PartyType@568e676e[SORTEERHUB,Collectie of Distributiehub (Partner locatie)]], 
][SystemId: 26681537; Party: ASA; PartyType: com.mpobjects.oms.model.entity.partytype.PartyType@568e676e[SORTEERHUB,Collectie of Distributiehub (Partner locatie)]], 
][SystemId: 26824703; Party: 160213; PartyType: com.mpobjects.oms.model.entity.partytype.PartyType@568e676e[SORTEERHUB,Collectie of Distributiehub (Partner locatie)]], 
][SystemId: 26826681; Party: TEST; PartyType: com.mpobjects.oms.model.entity.partytype.PartyType@568e676e[SORTEERHUB,Collectie of Distributiehub (Partner locatie)]], 
][SystemId: 26820114; Party: BOS1; PartyType: com.mpobjects.oms.model.entity.partytype.PartyType@568e676e[SORTEERHUB,Collectie of Distributiehub (Partner locatie)]], 
][SystemId: 26842295; Party: TBAPR; PartyType: com.mpobjects.oms.model.entity.partytype.PartyType@568e676e[SORTEERHUB,Collectie of Distributiehub (Partner locatie)]], 
][SystemId: 26842325; Party: TBAPC; PartyType: com.mpobjects.oms.model.entity.partytype.PartyType@568e676e[SORTEERHUB,Collectie of Distributiehub (Partner locatie)]]]
				getRequest().setAttribute(DYNATABLE_LIST_ATTRIBUTE, myList);
				getSession().setAttribute(LIST_LOADED_ATTRIBUTE, myIdentifier);

/c
TableManager.getTable(String, Request) line: 74	
/=
	public Table getTable(String aTableName, Request aRequest) {
aTableName	"party" (id=23593)	

			myTable = getFromCache(mySession, aTableName);
		if (myTable == null) {
/ JA
			myTable = new Table(aTableName, new FilterManager().getFilterCache(mySession), aRequest);
myTable.rows=[]
			myTable.startEmpty(myStartEmpty);
			storeInCache(mySession, myTable, aTableName);
/s
				aSession.setAttribute(aTableName + TABLE_SUFFIX, aTable);
				aSession.setAttribute(LAST_USED_TABLE, aTableName);
/t
TableManager.getTable(String, Request) line: 89	
			storeInCache(mySession, myTable, aTableName);
/d
		}
		if (!myStartEmpty) {
			String myRefreshParam = aRequest.getParameter("refresh");
			myTable.setForceRefresh(myRefreshParam != null && TRUE.equals(myRefreshParam));
/s
				forceRefreshFlag = aFlag;
/t
			myTable.setForceFilter(myRefreshParam != null && FALSE.equals(myRefreshParam));

/c
Table.addHiddenColumn(String) line: 312	
aName	"SYSTEMID" (id=19699)	

/c
Table.addColumn(String) line: 208	
aName	"party_type" (id=21368)	

/c
Table.addDatabaseJoinColumn(String, String, int) line: 280	
/=
	public void addDatabaseJoinColumn(String aName, String aDBColumn, int aPosition) {
aName	"organization" (id=21371)	
aDBColumn	"organization_id" (id=21372)	
aPosition	1	

/c
Table.addDatabaseColumn(String) line: 233	
aName	"party_id" (id=21413)	

...


/c
Table.mustReload() line: 679	
		if (forceRefreshFlag) {
/ JA
			myResult = true;

		if (myResult) {
			// The table will be reloaded from the DB, therefore set the DBFilter
			// in all columns
			for (Column myColumn : columns) {
				if (myColumn instanceof DatabaseColumn) {
organization
party_id
					DatabaseColumn myDBCol = (DatabaseColumn) myColumn;
					myDBCol.setDBFilter();
/s
								theReloadFlag = true;
/ want elke column heeft geen theFilter	,
/ TODO


/ we zijn nu NIET langs .setFilter gekomen	, 
/ vergl met PartyTypeList	, daar in setFilter de 2 columns set	, en hier GEEN	,
/ TODO

/c
party_list_xml.generate() line: 545	
...
              			new RowValue(myMask.getReference4()),
	                    new RowValue(myMask.getReference5()),
	                    new RowValue(myMask.getTimeZoneId())
	                };
	                myTable.addRow(myRow);
/s
Table.addRow(RowValue[]) line: 460	
		addRow(new Row(aList));
/s
Table.addRow(Row) line: 440	
		if (originalRows.size() == 0) {
			setColumnTypes(aRow);
/s
Table.setColumnTypes(Row) line: 1034	
		int i = 0;
		for (RowValue myRowValue : aRow.getValues()) {
			Comparable<?> myValue = myRowValue.getValue();
myValue	"26681513" (id=27838)	
myValue	"Opdrachtgever" (id=27819)	
			if (myValue != null && !columns.get(i).isHidden()) {
/ NEE
/ Voor strings	,
				if (myValue instanceof Integer || myValue instanceof BigInteger) {
					columns.get(i).setType(Column.TYPE_INTEGER);
				} else if (myValue instanceof Number) {
					columns.get(i).setType(Column.TYPE_NUMBER);
				}
			}
			i++;
		}

		}
		originalRows.add(aRow);
		rows.add(aRow);
		if (rowMap != null) {
			Comparable<?> value = aRow.getValues().get(systemIdColumnIndex).getValue();
			rowMap.put(value, aRow);
		}

/ c
Table.filter() line: 491	
		for (Column myCol : columns) {
			myFilterBuffer.append(myCol.getFilterExpression());
			myFilterBuffer.append("#");
		}
######################

			rows.clear();
			Column[] myCols = getColumns();
			row: for (Row myRow : originalRows) {
				int i = 0;
				for (RowValue element : myRow.getValues()) {
					if (!myCols[i++].filter(element)) {
						continue row;
					}
				}
				rows.add(myRow);
/ OK
/ Komen er allemaal weer bij	,


/ 7	. 

/ We zijn op de party screen , we click op de filter button 
/ we geven in Name "TNT" bijv	, 
/s
dynatable.js
  myAddress = getLocation() + '?refresh=true';
"http://localhost:8080/tms/oms/party_list"

/s
PartyListAction(AbstractAction).act(Redirector, SourceResolver, Map, String, Parameters) line: 137	
				Map myMap = act();
/s
PartyListAction(ListAction).act() line: 58	
		String myIdentifier = this.getClass().getPackage().getName() + "." + this.getClass().getName() + "_" + getRequest().getRequestURI();
com.mpobjects.oms.control.party.action.com.mpobjects.oms.control.party.action.PartyListAction_/tms/oms/party_list

		if (StringUtils.isNotEmpty(getRequest().getParameter("refresh")) && getRequest().getParameter("refresh").equals("true")) {
/ NEE

		if (!myIdentifier.equals(getSession().getAttribute(LIST_LOADED_ATTRIBUTE))) {
			resetListLoaded(getSession());
		}

		if (getSession().getAttribute(LIST_LOADED_ATTRIBUTE) == null) {
			// only load list if refresh=false is NOT added to the url
			if (!"false".equals(getRequest().getParameter("refresh"))) {
/ JA
/ "false"!=null
/ PAUL
/ Is dit de bedoeling	? 
/ Einde PAUL
				Collection myList = getList();
/s
PartyListAction.getList() line: 44	
		String myPartyType = (String) getRequest().getAttribute("partyType");
null
		String myPartyTypeSystemid = getRequest().getParameter(PARTY_TYPE_SYSTEM_ID);
null
		if (myPartyType != null) { // Not used yet type-TYPENAME_party_selection_list
 /NEE
		} else {
			if (myPartyTypeSystemid == null) {
				myPartyTypeSystemid = (String) getSession().getAttribute(PARTY_TYPE_SYSTEM_ID);
26681476
			} else { // override session attribute with request parameter
		
			return MpoBeanFactory.getBean(PartyDAO.class).getPartyListByTypeSystemid(Integer.parseInt(myPartyTypeSystemid));
select ...
from PARTY this_ 
left outer join ORGANIZATION organizati2_ on this_.ORGANIZATION_SYSTEMID=organizati2_.SYSTEM_ID 
left outer join ORGANIZATION organizati3_ on organizati2_.ORGANIZATION_GROUP=organizati3_.SYSTEM_ID 
where this_.organization_Systemid in (select uo.organization_systemid from user_organization uo where uo.user_systemid = $1) 
and this_.PARTY_TYPE_SYSTEMID=$2
DETAIL:  parameters: $1 = '26682479', $2 = '26681476'

/t
				getRequest().setAttribute(DYNATABLE_LIST_ATTRIBUTE, myList);
				getSession().setAttribute(LIST_LOADED_ATTRIBUTE, myIdentifier);

/c
TableManager.getTable(String, Request) line: 82	
			myTable = getFromCache(mySession, aTableName);
myTable
	originalRows	ArrayList  (id=27652)	
[com.mpobjects.view.util.table.Row@21cddf95, com.mpob... ]

		if (!myStartEmpty) {
			String myRefreshParam = aRequest.getParameter("refresh");
null
			myTable.setForceRefresh(myRefreshParam != null && TRUE.equals(myRefreshParam));
/ -> false
			myTable.setForceFilter(myRefreshParam != null && FALSE.equals(myRefreshParam));

/c
Table.setFilter(Map<String,String>) line: 805	

		Column[] myCols = getColumns();
myCols	Column[22]  (id=30084)	
	[0]	CacheColumn  (id=29898)	
	[1]	CacheColumn  (id=29899)	
	[2]	DatabaseJoinColumn  (id=29900)	
	[3]	DatabaseColumn  (id=29902)	
	[4]	DatabaseColumn  (id=29848)	
	[5]	DatabaseColumn  (id=29903)	
	[6]	DatabaseColumn  (id=29904)	
	[7]	DatabaseColumn  (id=29905)	
	[8]	DatabaseColumn  (id=29906)	
	[9]	DatabaseColumn  (id=29907)	
	[10]	DatabaseColumn  (id=29908)	
	[11]	DatabaseJoinColumn  (id=29909)	
	[12]	DatabaseColumn  (id=29910)	
	[13]	DatabaseColumn  (id=28620)	
	[14]	CacheColumn  (id=29911)	
	[15]	CacheColumn  (id=29912)	
	[16]	CacheColumn  (id=29913)	
	[17]	CacheColumn  (id=29914)	
	[18]	CacheColumn  (id=29915)	
	[19]	CacheColumn  (id=29916)	
	[20]	CacheColumn  (id=29917)	
	[21]	CacheColumn  (id=29918)	

		for (String myKey : aMap.keySet()) {
			if (!"".equals(myKey)) {
				int myIndex = Integer.parseInt(myKey);
				Column myColumn = myCols[myIndex];
				String myValue = aMap.get(myKey);

				} else {
					setFilter(myColumn, myValue, FilterCache.FILTER_TYPE_USER);
myColumn	DatabaseColumn  (id=21486)	
myValue	"TNT" (id=21742)	
/s
Table.setFilter(Column, String, String) line: 1057	
		aColumn.setFilter(aValue);
/s
DatabaseColumn.setFilter(String) line: 106	
		} else {
			if (fitsInOldFilter(aFilter)) {
				// Narrowing down current results, we don't need to go to the DB again
				theReloadFlag = !theUsedFlag;
false
				if (!theReloadFlag) {
/ JA
->					theFilter = new CacheFilter(aFilter, this);

/c
Table.reloadFilters() line: 756	
		if (!StringUtils.equals(oldScreenId, getScreenId())) {
/ JA
oldScreenId=""
getScreenId()="party"

			for (Column myColumn : columns) {
				String[] myFilter = filterCache.getFilterValue(getScreenId() + "." + getName() + "." + myColumn.getName());
/ NEE
				} else {
					myColumn.setFilter("");
/ Hier wordt de filter op Column:name weer op "" set	,
/ CAUSE PCT-737


/c
Table.mustReload() line: 693	
		if (forceRefreshFlag) {
/ NEE
			myResult = true;
		} else if (forceFilterFlag) {
/ NEE
		} else {
			for (Column myColumn : columns) {
				if (myColumn.mustReload()) {
/ NEE
		return myResult;
false


/c
Table.filter() line: 491	
		for (Column myCol : columns) {
			myFilterBuffer.append(myCol.getFilterExpression());
			myFilterBuffer.append("#");
		}
####TNT##################

			rows.clear();

			Column[] myCols = getColumns();
			row: for (Row myRow : originalRows) {
				int i = 0;
				for (RowValue element : myRow.getValues()) {
					if (!myCols[i++].filter(element)) {
						continue row;
					}
				}
				rows.add(myRow);
			}
			reshuffle();

/ 7	.

/ Als we op de refresh button click	op de party screen, met de Name "TNT"	,

/s
dynatable.js
   myAddress = getLocation() + '?refresh=true';
"http://localhost:8080/tms/oms/party_list?refresh=true"
/s
PartyListAction(ListAction).act() line: 71	
		String myIdentifier = this.getClass().getPackage().getName() + "." + this.getClass().getName() + "_" + getRequest().getRequestURI();
com.mpobjects.oms.control.party.action.com.mpobjects.oms.control.party.action.PartyListAction_/tms/oms/party_list

		if (StringUtils.isNotEmpty(getRequest().getParameter("refresh")) && getRequest().getParameter("refresh").equals("true")) {
/ JA
			resetListLoaded(getSession());
		}

		if (!myIdentifier.equals(getSession().getAttribute(LIST_LOADED_ATTRIBUTE))) {
/ JA
			resetListLoaded(getSession());
		}
		if (getSession().getAttribute(LIST_LOADED_ATTRIBUTE) == null) {
			if (!"false".equals(getRequest().getParameter("refresh"))) {
				Collection myList = getList();
/s
PartyListAction.getList() line: 32	
		Util.refreshList(getRequest(), getSession());
/s
Util.refreshList(Request, Session) line: 35	
			new TableManager().flushTableCache(aRequest, PARTY_SCREENID);
/s
TableManager.flushTableCache(Request, String) line: 52	
		Session mySession = aRequest.getSession();
		mySession.removeAttribute(aTableName + TABLE_SUFFIX);
/t
PartyListAction.getList() line: 34	
		String myPartyType = (String) getRequest().getAttribute("partyType");
/d
null
		String myPartyTypeSystemid = getRequest().getParameter(PARTY_TYPE_SYSTEM_ID);
null
		} else {
			if (myPartyTypeSystemid == null) {
				myPartyTypeSystemid = (String) getSession().getAttribute(PARTY_TYPE_SYSTEM_ID);
PARTY_TYPE_SYSTEM_ID=party_type_systemid
26681476
			return MpoBeanFactory.getBean(PartyDAO.class).getPartyListByTypeSystemid(Integer.parseInt(myPartyTypeSystemid));

/ we zien	, 
select ...
from PARTY this_ 
left outer join ORGANIZATION organizati2_ on this_.ORGANIZATION_SYSTEMID=organizati2_.SYSTEM_ID 
left outer join ORGANIZATION organizati3_ on organizati2_.ORGANIZATION_GROUP=organizati3_.SYSTEM_ID 
where this_.organization_Systemid in (select uo.organization_systemid from user_organization uo where uo.user_systemid = $1) 
and this_.PARTY_TYPE_SYSTEMID=$2
DETAIL:  parameters: $1 = '26682479', $2 = '26681476'

/t
				Collection myList = getList();
/d
				getRequest().setAttribute(DYNATABLE_LIST_ATTRIBUTE, myList);
/ voor party_list.xml
				getSession().setAttribute(LIST_LOADED_ATTRIBUTE, myIdentifier);
/ TODO (used?)

/c
TableManager.getTable(String, Request) line: 74	
aTableName="party"
		if (!myStartEmpty) {
			myTable = getFromCache(mySession, aTableName);
null
/ TODO (VREEMD)
		if (myTable == null) {
/ JA
			myTable = new Table(aTableName, new FilterManager().getFilterCache(mySession), aRequest);

			myTable.startEmpty(myStartEmpty);
			storeInCache(mySession, myTable, aTableName);
/s
				aSession.setAttribute(aTableName + TABLE_SUFFIX, aTable);
				aSession.setAttribute(LAST_USED_TABLE, aTableName);

/t
		if (!myStartEmpty) {
			String myRefreshParam = aRequest.getParameter("refresh");
true
			myTable.setForceRefresh(myRefreshParam != null && TRUE.equals(myRefreshParam));
			myTable.setForceFilter(myRefreshParam != null && FALSE.equals(myRefreshParam));

/c
	public void setFilter(Map<String, String> aMap) {
{13=, 11=, 12=, 3=, 2=, 10=, 1=, 7=, 6=, 5=, 4=TNT, 9=, 8=}
				} else {
					setFilter(myColumn, myValue, FilterCache.FILTER_TYPE_USER);
/s
	private void setFilter(Column aColumn, String aValue, String aFilterType) {
aColumn	DatabaseColumn  (id=29848)	
Column:name
aValue	"TNT" (id=29849)	

		// Update the DynaQuery
		if (dynaQuery != null && (aColumn instanceof DatabaseColumn || aColumn instanceof DatabaseJoinColumn)) {
/ NEE
			Filter myFilter = aColumn.getFilter();
			if (myFilter != null) {
				dynaQuery.add(aColumn.getFilter());
/ NIET
			}

/t
Table.setFilter(Map<String,String>) line: 812	
		for (String myKey : aMap.keySet()) {
/ volgende	, 

/c
Table.mustReload() line: 679	

		if (forceRefreshFlag) {
			myResult = true;

		if (myResult) {
			// The table will be reloaded from the DB, therefore set the DBFilter
			// in all columns
			for (Column myColumn : columns) {
				if (myColumn instanceof DatabaseColumn) {
/ JA, sommige wel	,
/ NEE, sommige niet	,
					DatabaseColumn myDBCol = (DatabaseColumn) myColumn;
					myDBCol.setDBFilter();

/c
Table.addRow(Row) line: 440	
/ De originalRows en rows zijn []
/ Nu allemaal erbij	,
/ WH vanuit party_list.xml

/c
Table.filter() line: 491	
		for (Column myCol : columns) {
			myFilterBuffer.append(myCol.getFilterExpression());
myCol	CacheColumn  (id=29898)	

			myFilterBuffer.append("#");
		}
######################
/ Het filter is weg	,

/ 7	. 

/ we click refresh op party screen, op name filter TNT

PartyListAction(ListAction).act() line: 71	
				Collection myList = getList();
/s
PartyListAction.getList() line: 32	
		Util.refreshList(getRequest(), getSession());
/s
Util.refreshList(Request, Session) line: 35	
			new TableManager().flushTableCache(aRequest, PARTY_SCREENID);
/s
TableManager.flushTableCache(Request, String) line: 53	
		mySession.removeAttribute(aTableName + TABLE_SUFFIX);

/c
TableManager.getTable(String, Request) line: 75	
			myTable = getFromCache(mySession, aTableName);
myTable=null

/ CAUSE PCT-737


























/ Intermezzo

/ Bij deze gaat refresh met filters wel OK	,

$ vi FinancialPartyListAction.java
public class FinancialPartyListAction extends ListAction {
	@Override
	public Collection getList() throws Exception {
		return MpoBeanFactory.getBean(FinancialPartyDAOInterface.class).getAll();
	}

$ vi InvoiceDetailListAction.java
public class InvoiceDetailListAction extends ListAction {

	/**
	 * 
	 * overrides method @see com.mpobjects.control.action.ListAction#getList()
	 * 
	 * @return
	 * @throws Exception
	 */
	@Override
	public Collection getList() throws Exception {
		return MpoBeanFactory.getBean(InvoiceDetailDAO.class).getAll();
	}




$ vi PartyListAction.java

public class PartyListAction extends ListAction {


/ Einde Intermezzo































/ Einde DEBUG PCT-737

/ PCT-737 WICKET

/ 7	. 

/ we kijken eerst nog naar	PCT-749

Execution, Customer shipment order search
CustomerOrderSearchPage

/ 7	. 

/ we gaan in Java EE view naar
com.mpobjects.oms.view.wicket.party
/ en click New class
public class PartyListPage extends BaseContextPage {

/ BaseContextPage is in 
com.mpobjects.oms.view.wicket

$ vi oms-menu.xml
	<m:add path="configuration.planning.partyList" privilege="party.list" actionUrl="wicket?module=oms&amp;wicketpage=partytype.PartyListPage" index="1050" />

/ 7	. 

/ Kijk naar wehkamp's 
package com.mpobjects.rfsdms.asnportal.view.wicket;
public abstract class PartyListPage extends AbstractMainPage {

/ we zien deze op RFSDMS (T5/Internal) 
https://test-scs.mp-objects.com/rfsdms/core/index_frameset
/ Kies	,
Portal, Scan ASN

/ we kunnen ook	, 
BatchCreatePage

/ we kunnen ook	,
BillOfMaterialsEditPage	,
configuration, master data, products
/ edit een product	, 
/ Kies onderin : Add bill of materials	,

/ 7	. 

/ we hebben minimale	,

$ vi PartyListPage.java
package com.mpobjects.oms.view.wicket.party;
@Privilege(object = "party", type = "list")
public class PartyListPage extends BaseContextPage {
}

$ vi PartyListPage.html
<wicket:extend>
</wicket:extend>

$ vi oms-menu.xml
	<m:add path="configuration.planning.partyList" privilege="party.list" actionUrl="wicket?module=oms&amp;wicketpage=party.PartyListPage" index="1050" />


/ 7	. 

/ study parent pages	,


public class BatchCreatePage extends AbstractMainPage {

public abstract class AbstractMainPage extends AbstractPage {
	protected FeedbackPanel feedbackPanel;
	protected Label pageTitle;

public abstract class AbstractPage extends BasePage {
	protected Label pageTitleHead;
	protected IModel<String> pageTitleModel;
	protected abstract void createPageComponents();

public class BasePage extends WebPage implements Serializable {

$ vi AbstractMainPage.html

	<wicket:extend>
		<div id="pageHeader">
			<div class="pageTitle" wicket:enclosure="pageTitle">
				<h1>
					<span wicket:id="pageTitle"></span>
				</h1>
			</div>
		</div>

		<div id="pageContent">
			<div wicket:id="feedback"></div>
			<wicket:child />
		</div>

	</wicket:extend>

$ vi AbstractPage.html

<head>
<wicket:head>
	<title wicket:id="pageTitleHead"></title>
</wicket:head>
</head>
<body>
	<wicket:extend>
		<wicket:child />
	</wicket:extend>
</body>

$ vi BasePage.html

<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html>

/ TODO (Al die extends met wicket:head)	, 

$ vi BatchCreatePage.html


/ 7	. 

/ we maken voorlopig	, 

$ vi PartyListPage.html

<wicket:extend>
		<div wicket:id="query"></div>
</wicket:extend>

$ vi PartyListPage.java

@Privilege(object = "party", type = "list")
public class PartyListPage extends AbstractMainPage {

	@Override
	protected void createPageComponents() {
		QueryDefinition myQuery = new QueryDefinition("coshipmentportal-party");
		myQuery.setFromClause("from PartyVO as p");
		myQuery.setWhereClause("p.deleted = 0");

		RegexModelStringFormatter<String> formatter = new RegexModelStringFormatter<String>("^(\\{[^}]*\\})?(.*)$", "$2");

		myQuery.getColumns().add(new IdQueryColumn("systemId", "p.systemId"));
		myQuery.getColumns().add(new QueryColumn<String>("party.partytype.code", "p.partyType.code"));
		myQuery.getColumns().add(new QueryColumn<String>("party.partyid", "p.partyId", formatter));
		myQuery.getColumns().add(new QueryColumn<String>("party.name", "p.name"));
		myQuery.getColumns().add(new QueryColumn<String>("party.country.code", "p.country.code"));
		myQuery.getColumns().add(new QueryColumn<String>("party.contactName", "p.contactName"));


	}

$ vi language_en_GB_pnllogistics.properties
party.partytype.code=Foo Bar
party.partyid=Foo Bar
party.name=Foo Bar
party.name2=Foo Bar
party.address=Foo Bar
party.address2=Foo Bar
party.postalcode=Foo Bar
party.city=Foo Bar
party.regionstate=Foo Bar
party.country.code=Foo Bar
party.contactname=Foo Bar
...

/ we schrijven 
	p.country.code
	p.contactName

/ we kunnen NIET	, terwijl de method getCountryCode() er wel is	,
	p.countryCode

/ Dat komt omdat in Party.standard.hbm.xml 

		<property column="CONTACT_NAME" name="contactName" />
		<many-to-one name="country" column="COUNTRY_SYSTEMID" class="com.mpobjects.oms.model.entity.country.Country" />

/ 7	. 

/ Kijk naar	, 
public class ShipmentOrderListPage extends AbstractMainPage {

/ menu?

/ 7	. 

/ Kijk naar 	,
planning, shipmentorder, massupdate	,

public class ShipmentOrderMassUpdatePage extends AbstractMainPage {
			protected void createRow(List<Object> aRow, QueryColumn myColumn, ListItem<Object> aCell) {
				if (myColumn.getProperty().equals("shipmentOrderId")) {
					String returnUrl = getRequestCycle().urlFor(ShipmentOrderMassUpdatePage.this).toString();
					returnUrl = RequestUtils.toAbsolutePath(returnUrl);
					Integer myId = (Integer) aRow.get(0);
					String shimentOrderLink = "../oms/shipment-order_edit?base_sessionLevelOffset=1&systemid=" + Integer.toString(myId.intValue()) + "&returnUrl=	" + returnUrl;

/ we maken	,

$ vi PartyListPage.java

		myRowActions.add(new RowAction() {

			@Override
			public boolean execute(Object aObject) {

				String returnUrl = getRequestCycle().urlFor(PartyListPage.this).toString();
				returnUrl = RequestUtils.toAbsolutePath(returnUrl);
				getRequestCycle().setRequestTarget(
						new RedirectRequestTarget("../oms/party_edit?" + "base_sessionLevelOffset=1" + "&systemid=" + aObject + "&systemId=" + aObject + "&returnUrl=" + returnUrl));
				return false;

/ we hebben deze url copy van het oude party list scherm , en de returnUrl erachter gezet	,

/ Als we click op de edit-button	, gaan we party_edit doen, dus komen we eerst in PartyFormAction.act	, daar wordt de returnUrl opgepakt, die we hier hebben add aan de url	, en vervolgens vindt de party_edit.jsp hem dan	, 


/en	, 
$ vi oms-sitemap.xmap

			<map:action logger="party" name="partyForm" src="com.mpobjects.oms.control.party.action.PartyFormAction"/>

			<map:match type="regexp" pattern="^party_(edit|create)$">
				<map:act type="partyForm"/>
				<map:read mime-type="text/html" type="jsp" src="jsp/party_edit.jsp"/>
			</map:match>

$ vi PartyFormAction.java
	public Map act() throws java.lang.Exception {
		String returnUrl = getRequestParameter("returnUrl");
		getSession().setAttribute("returnUrl", returnUrl);

$ vi ButtonTag.java

		String returnUrl = (String) getSession().getAttribute("returnUrl");

		} else if (TYPE_CANCEL.equals(getType()) && returnUrl != null) {
			myPrint.append("<input type=\"button\" ");
			myPrint.append(" id=\"cancelBtn\"");
			myPrint.append(" value=\"" + (!readOnly ? getLabel("cancel") : getLabel("back")) + "\"");
			myPrint.append(" onclick=\" " + getForm().getJsFormManager() + ".cancelAndRedirect('" + getCancelMessage() + "', '" + getUrl() + "');\"");

/ Dubbel, returnUrl==getUrl()
/ TODO

/ getUrl() is de url param in 

$ vi  party_edit.jsp
					<mpo:button type="cancel" url="${returnUrl}"/>

/ 7	. 

/ de redirect van Cancel gebeurt in js	,

$ vi ButtonTag.java

		} else if (TYPE_CANCEL.equals(getType()) && returnUrl != null) {
			myPrint.append("<input type=\"button\" ");
			myPrint.append(" id=\"cancelBtn\"");
			myPrint.append(" value=\"" + (!readOnly ? getLabel("cancel") : getLabel("back")) + "\"");
			myPrint.append(" onclick=\" " + getForm().getJsFormManager() + ".cancelAndRedirect('" + getCancelMessage() + "', '" + getUrl() + "');\"");

/ Daarom zien we in HTML	,
<input type="button" id="cancelBtn" value="Cancel" onclick=" theEditFormFormManager.cancelAndRedirect('Loose changes made after last save', 'https://test-pnl.mp-objects.com/pnllogistics/wicket/?wicket:interface=:4::::');">

$ vi class.formmanager.js
    this.cancelAndRedirect = function(aMessage, anUrl) {
        if (confirm(aMessage)) {
        	this.performRedirect(anUrl);
        }
    }
    this.setRedirectUrl = function(anUrl) {
        document.getElementById("redirectTo").value=anUrl;
    }

/ Intermezzo

/ 7	. 

/ save 


$ vi party_edit.jsp

<mpo:button type="save" />

$ vi ButtonTag.java

			} else if (!getType().equals(TYPE_BACK)) {
				myPrint.append("<input type=\"button\"");
				myPrint.append(" name=\"" + getType() + "Btn\"");
				myPrint.append(" id=\"" + getType() + "Btn\"");
				myPrint.append(" value=\"" + getLabel(getType()) + "\"");
				myPrint.append(" onclick=\" " + getForm().getJsFormManager() + ".submit('" + getUrlForType(getType()) + "', " + getDoRedirect() + ", " + getRedirectLevelOffset() + ");\"");
/s
ButtonTag.getUrlForType(String) line: 305	
/=
	protected String getUrlForType(String aType) {
aType="save"
		String myRet = EntityActionUtil.getActionUrl(getRequest(), aType);
/s
EntityActionUtil.getActionUrl(HttpServletRequest, String) line: 33	
/=
	public static String getActionUrl(HttpServletRequest aRequest, String aTargetAction) {
		return getActionUrl(aRequest.getRequestURI(), aTargetAction);
/s
EntityActionUtil.getActionUrl(String, String) line: 55	
/=
	public static String getActionUrl(String aFullUrl, String aTargetAction) {
aFullUrl	"/tms/oms/party_edit" (id=20264)	
aTargetAction	"save" (id=1251)	
...
		return buildActionUrl(myCurrentModule, myCurrentEntityActionParts);
myCurrentModule	"oms" (id=20271)	
myCurrentEntityActionParts	String[2]  (id=20273)	
[party,save]
/ Antwoord:
../oms/party_save

/t
ButtonTag.doStartTag() line: 219	
				myPrint.append(" onclick=\" " + getForm().getJsFormManager() + ".submit('" + getUrlForType(getType()) + "', " + getDoRedirect() + ", " + getRedirectLevelOffset() + ");\"");
/d
/s
getDoRedirect() =false
getRedirectLevelOffset()=0


/ 7	. 

/ save and close

/ WH ButtonTag is onderdeel van JSP: parses de .jsp file	, 

$ vi party_edit.jsp
	<mpo:button type="saveAndClose" url="${returnUrl}" />

ButtonTag.doStartTag() line: 91	

		String returnUrl = (String) getSession().getAttribute("returnUrl");
http://localhost:8080/tms/wicket/?wicket:interface=:1::::

			} else if (getType().equals(TYPE_SUBMIT_AND_CLOSE) || getType().equals(TYPE_SAVE_AND_CLOSE)) {
				myPrint.append("<input type=\"button\"");
				myPrint.append(" id=\"" + getType() + "Btn\"");
				myPrint.append(" value=\"" + getLabel("save_and_close") + "\"");
				myPrint.append(" onclick=\" " + getForm().getJsFormManager() + ".submit('" + getSaveUrl() + "', true, '-1'); return false;\"");
/s
ButtonTag.getSaveUrl() line: 357	
		String myActionUrl = EntityActionUtil.getActionUrl(getRequest(), "save");
../oms/party_save
/ Net als hierboven bij save	,

/ 7	. 

/ cancel

$ vi party_edut.java
		String returnUrl = (String) getSession().getAttribute("returnUrl");
http://localhost:8080/tms/wicket/?wicket:interface=:1::::

/ Maar 
getUrl()=
http://localhost:8080/tms/wicket/?wicket:interface=:1::::

/ Dus dubbel	,
/ TODO

		} else if (TYPE_CANCEL.equals(getType()) && returnUrl != null) {
			myPrint.append("<input type=\"button\" ");
			myPrint.append(" id=\"cancelBtn\"");
			myPrint.append(" value=\"" + (!readOnly ? getLabel("cancel") : getLabel("back")) + "\"");
			myPrint.append(" onclick=\" " + getForm().getJsFormManager() + ".cancelAndRedirect('" + getCancelMessage() + "', '" + getUrl() + "');\"");

			if (!myCanGoBack) {
				myPrint.append(" disabled=\"disabled\" ");
				myPrint.append(" title=\"" + myCanGoBackMessage + "\"");
			}

			myPrint.append("/>");

/ Einde Intermezzo

/ FIX PCT-737

$ vi AbstractSaveAction.java

	protected void afterSave() throws Exception {

		getSession().setAttribute(LIST_MESSAGE_ATTRIBUTE, getSaveMessage());
		if (shouldTakeControl()) {

->			String myRedirectUrl = (String) getSession().getAttribute("returnUrl");
			if (myRedirectUrl == null) {
				myRedirectUrl = getRedirectUrl();
			}
			getRequest().setAttribute("redirectTo", myRedirectUrl);

			RedirectSaveAction.redirect(getRedirector(), getRequest(), myRedirectUrl);
		}
	}



/ Einde FIX PCT-737

/ SAMENVATTING REDIRECTURL PCT-796 PCT-737

$ vi PartyListPage.java
		myRowActions.add(new RowAction() {
			@Override
			public boolean execute(Object aObject) {
				String returnUrl = getRequestCycle().urlFor(PartyListPage.this).toString();
				returnUrl = RequestUtils.toAbsolutePath(returnUrl);
				getRequestCycle().setRequestTarget(
						new RedirectRequestTarget("../oms/party_edit?" + "base_sessionLevelOffset=1" + "&systemid=" + aObject + "&systemId=" + aObject + "&returnUrl=" + returnUrl));
				return false;
			}

		});
/ Voor als we click op de edit-button in een row	,

/ we hebben deze url copy van het oude party list scherm , en de returnUrl erachter gezet	,



/ Als we click op de edit-button	, gaan we party_edit doen, dus komen we eerst in PartyFormAction.act	, daar wordt de returnUrl opgepakt, die we hier hebben add aan de url	, en vervolgens vindt de party_edit.jsp hem dan	, 


/en	, 
$ vi oms-sitemap.xmap

			<map:action logger="party" name="partyForm" src="com.mpobjects.oms.control.party.action.PartyFormAction"/>

			<map:match type="regexp" pattern="^party_(edit|create)$">
				<map:act type="partyForm"/>
				<map:read mime-type="text/html" type="jsp" src="jsp/party_edit.jsp"/>
			</map:match>

$ vi PartyFormAction.java
	public Map act() throws java.lang.Exception {
		String returnUrl = getRequestParameter("returnUrl");
		getRequest).setAttribute("returnUrl", returnUrl);
////////////////
/ Als we click op de edit-button in een row	,

$ vi ButtonTag.java

		String returnUrl = (String) getRequest().getAttribute("returnUrl");

		} else if (TYPE_CANCEL.equals(getType()) && returnUrl != null) {
			myPrint.append("<input type=\"button\" ");
			myPrint.append(" id=\"cancelBtn\"");
			myPrint.append(" value=\"" + (!readOnly ? getLabel("cancel") : getLabel("back")) + "\"");
			myPrint.append(" onclick=\" " + getForm().getJsFormManager() + ".cancelAndRedirect('" + getCancelMessage() + "', '" + getUrl() + "');\"");

/ Dubbel, returnUrl==getUrl()
/ TODO (we kunnen oon <mpo:button type="cancel/saveAndClose" returnUrl/> doen	, en dan use getRequest().isParameter("returnUrl") )

/ getUrl() is de url param in: 

$ vi  party_edit.jsp
					<mpo:button type="cancel" url="${returnUrl}"/>

$ vi FormTag.java

	@Override
	public int doStartTag() throws JspTagException {

		String returnUrl = (String) getRequest().getAttribute("returnUrl");
		if (StringUtils.isEmpty(returnUrl) == false) {
			myPrintString.append("<input type=\"hidden\"");
			myPrintString.append(" name=\"returnUrl\"");
			myPrintString.append(" id=\"returnUrl\"");
			myPrintString.append(" value=\"" + returnUrl + "\"");
			myPrintString.append("/>");
		}

$ vi AbstractSaveAction.java

	protected void afterSave() throws Exception {

		if (shouldTakeControl()) {

			String myRedirectUrl = getRequest().getParameter("returnUrl");
			if (StringUtils.isEmpty(myRedirectUrl)) {
				myRedirectUrl = getRedirectUrl();
			}

			getRequest().setAttribute("redirectTo", myRedirectUrl);

			RedirectSaveAction.redirect(getRedirector(), getRequest(), myRedirectUrl);
		}
	}

/ als we 
Configuration, planning, service order templates
/ click Edit in a row	, a service order template
/ click Save and Close	, we op de list van parties	, 
/ we zien dat in 
AbstractSaveAction de returnUrl nog steeds deze Wicket pagina is	,

/ 	7	. 

/ we hadden misschien ook kunnen use	,

FormTag.getRedirectUrl() line: 624	

	private String getRedirectUrl() {
		String myRedirectTo = "";
		if (getRequest().getAttribute("redirectTo") != null) {
			myRedirectTo = (String) getRequest().getAttribute("redirectTo");
		} else if (getRequest().getParameter("redirectTo") != null) {
			myRedirectTo = getRequest().getParameter("redirectTo");
		} else {
			myRedirectTo = "../core/back?levelOffset=-1";// EntityActionUtil.getActionUrl(getRequest(), "list") +
															// "?refresh=true";
		}
		return myRedirectTo;
	}

/ Einde SAMENVATTING REDIRECTURL PCT-796 PCT-737

/ 7	. 

/ PCT-796

/ opruimen oude schermen	, 

$ vi oms-menu.xml

	<m:add path="configuration.planning.parties" privilege="party.list" actionUrl="oms/party-type_preselect_list" index="1050" />
	<m:add path="configuration.planning.partyList" privilege="party.list" actionUrl="wicket?module=oms&amp;wicketpage=party.PartyListPage" index="1050" />

$ vi oms-sitemap.xml

			<map:action logger="party" name="partyTypeList" src="com.mpobjects.oms.control.partytype.action.PartyTypeListAction"/>
			<map:match pattern="party-type_list">
				<map:act type="partyTypeList"/>
				<map:generate type="serverpages" src="xsp/party-type_list.xml">
                </map:generate>
				<map:call resource="dynatable-styler"/>
			</map:match>
			<!-- A list for clicking through to the parties -->
			<map:match pattern="party-type_preselect_list">
				<map:act type="partyTypeList"/>
				<map:call resource="dynatablePage">
				    <map:parameter name="xsp" value="xsp/party-type_list.xml"/>
				    <map:parameter name="xsl" value="xsl/party-type-preselection-list.xsl"/>
				    <map:parameter name="edit" value="false"/>
				</map:call>
			</map:match>

			<map:match pattern="party-type_selection-list">
				<map:act type="partyTypeList"/>
				<map:generate type="serverpages" src="xsp/party-type_list.xml"/>
				<map:call resource="dynatable-selection-styler"/>
			</map:match>

/ 7	. 
/ we rm uit oms-sitemap.xmap wat hier staat	,

/ 7	. 

/ we rm 
com.mpobjects.oms.control.partytype.action.PartyTypeListAction

/ 7	. 

/ we rm
module/oms/war/oms/xsp/party-type_list.xml 
./module/oms/war/oms/xsl/party-type-preselection-list.xsl

/ 7	. 

$ vi oms-menu.xml
	<m:add path="configuration.planning.parties" privilege="party.list" actionUrl="wicket?module=oms&amp;wicketpage=party.PartyListPage" index="1050" />






/ Einde PCT-796



/ 7	. 

/ redirect Save and close

/ we zien in HTML	,

/ ons form	, 
<form method="post" ...>
	<input type="hidden" name="redirectTo" id="redirectTo" value="../core/back?levelOffset=-1">
	<input type="hidden" name="doRedirect" id="doRedirect">

	<input type="button" id="saveAndCloseBtn" value="Save and Close" onclick=" theEditFormFormManager.submit('../oms/party_save', true, '-1'); return false;">

$ vi class.formmanager.js

   this.submit = function(anAction, aBoolDoRedirect, aRedirectionLevelOffset) {
/ anAction="../oms/party_save"
/ aBoolDoRedirect=true
/ aRedirectionLevelOffset=-1

       	this.lastAction = anAction;
"../oms/party_save"
        this.lastDoRedirect = aBoolDoRedirect;
true

        document.getElementById("base_sessionLevelOffset").value=aRedirectionLevelOffset;
-1
		document.getElementById("doRedirect").value=aBoolDoRedirect;
true

        var myForm = document.getElementById(this.theFormName);

        if(anAction){
        	myForm.action=anAction;
"../oms/party_save"
 

            myForm.submit();

$ vi oms-sitemap.xmap

			<map:action logger="party" name="partySave" src="com.mpobjects.oms.control.party.action.PartySaveAction"/>

			<map:match pattern="party_save">
				<map:act type="partySave"/>
				<map:redirect-to uri="edit_party?systemid={request-attr:systemid}"/>
			</map:match>
 
public class PartySaveAction extends BoundSaveAction implements Callable<Void> {

public abstract class BoundSaveAction extends AbstractSaveAction implements FlowControlledAction {

public abstract class AbstractSaveAction extends AbstractAction implements NonScreenAction {

/s
PartySaveAction(AbstractSaveAction).afterSave() line: 157	
		if (shouldTakeControl()) {
/s
			return !getParameters().isParameter("noRedirect");

			String myRedirectUrl = getRedirectUrl();
/s
PartySaveAction(AbstractSaveAction).getRedirectUrl() line: 495	

/ Intermezzo

/ In devtools' Network zien we 
FormData

	redirectTo:../core/back?levelOffset=-1
/ Klopt	, dit komt uit een hidden field in het form	,
	doRedirect:true
/ Klopt	, dit komt uit een hidden field in het form	,
	base_sessionLevelOffset:-1
/ Set in JS	,

/ Hier kunnen we doen	,
	getRequest().getParameter("redirectTo") 
../core/back?levelOffset=-1
/ Klopt	, dit komt uit een hidden field in het form	,

/ Maar wat is deze ? Zijn dit de params achter de url?
"getParameters()"	 (pending)	
	location	LocationImpl  (id=21684)	
	m_parameters	HashMap  (id=21685)	
	m_readOnly	false	

/ Achter de url zien we geen params	,  


/ Einde Intermezzo

			String myLevelOffsetStr = getRequest().getParameter(RequestManager.SESSION_LEVEL_OFFSET);
			int myLevelOffset = getRequestManager().parseLevel(myLevelOffsetStr);
-1
			} else {
				int myTargetLevel = getRequestManager().getLevel() + myLevelOffset;
0
				BaseRequest myTargetRequest = getRequestManager().getRequestForLevel(myTargetLevel);
				myRet = myTargetRequest.getUrl();
../core/opening_page

				for (Enumeration myEnumeration = getRequest().getParameterNames(); myEnumeration.hasMoreElements();) {
/ we zien form data	,
base_sessionLevelOffset:-1
base_windowToOpenUrl:
base_windowToOpenHeight:
base_windowToOpenWidth:
base_windowToOpenTitle:
base_windowToOpenScrollbar:
					myKey = (String) myEnumeration.nextElement();
					if (myKey.startsWith("base_")) {
						myMap.put(myKey, getRequestParameter(myKey));
					}
				}
				myMap.put(RequestManager.SESSION_LEVEL_OFFSET, myLevelOffsetStr);
				myRet = getRequestUrl(myRet, myMap);
/ Dus heeft myMap erachter gezet	,
../core/opening_page?base_windowToOpenUrl=&randomizingurl=1444293407115&base_windowToOpenTitle=&base_sessionLevelOffset=-1&base_windowToOpenScrollbar=&base_windowToOpenWidth=&base_windowToOpenHeight=

/t
PartySaveAction(AbstractSaveAction).afterSave() line: 158	
		if (shouldTakeControl()) {

			String myRedirectUrl = getRedirectUrl();
/d
../core/opening_page?base_windowToOpenUrl=&randomizingurl=1444293407115&base_windowToOpenTitle=&base_sessionLevelOffset=-1&base_windowToOpenScrollbar=&base_windowToOpenWidth=&base_windowToOpenHeight=

			getRequest().setAttribute("redirectTo", myRedirectUrl);
/ TODO
			RedirectSaveAction.redirect(getRedirector(), getRequest(), myRedirectUrl);
/s
RedirectSaveAction.redirect(Redirector, Request, String, int) line: 43	

		for (Enumeration myEnum = aRequest.getParameterNames(); myEnum.hasMoreElements();) {
			myParameterName = (String) myEnum.nextElement();

			if (myParameterName.startsWith("base_") && StringUtils.isNotEmpty(aRequest.getParameter(myParameterName))) {
base_sessionLevelOffset
				myRememberedParamList.add(myParameterName + "=" + aRequest.getParameter(myParameterName));
			}
		}
		if (aLevelOffset != 0) {
/ NEE
		if (myRememberedParamList.size() > 0) {
			String mySeperator;
			if (anUrl.indexOf('?') > 0) {
/ JA
				mySeperator = "&";

			anUrl += mySeperator + StringUtils.implode(myRememberedParamList.toArray(), "&");
../core/opening_page?base_windowToOpenUrl=&randomizingurl=1444293407115&base_windowToOpenTitle=&base_sessionLevelOffset=-1&base_windowToOpenScrollbar=&base_windowToOpenWidth=&base_windowToOpenHeight=&base_sessionLevelOffset=-1

		aRequest.setAttribute("redirectTo", anUrl);
			String myRedirectPage = "../core/generic_save_redirect?redirectTo=" + URLEncoder.encode(anUrl, "UTF-8");
../core/generic_save_redirect?redirectTo=..%2Fcore%2Fopening_page%3Fbase_windowToOpenUrl%3D%26randomizingurl%3D1444293407115%26base_windowToOpenTitle%3D%26base_sessionLevelOffset%3D-1%26base_windowToOpenScrollbar%3D%26base_windowToOpenWidth%3D%26base_windowToOpenHeight%3D%26base_sessionLevelOffset%3D-1

			aRedirector.redirect(true, myRedirectPage);
/ aRedirector is een cocoon obj	,













/ Einde PCT-737 WICKET

/ OPEN IN WINDOWS

 LOG_8_sep_2014.txt
LOG_6_OCT_2014.txt
LOG_23_jul_2015.txt
LOG_10_aug_2015.txt
LOG_8_sep_2015.txt	 / MORGENOCHTEND
LOG_29_sep_2015.txt	/ PCT-796	,

[eric@localhost eclipse-jee]$ eclipse/eclipse 
/home/eric/Devel/Java/Eclipse/eclipse-jee-test
/home/eric/Devel/Java/Tomcat/apache-tomcat-7.0.57
/home/eric/Devel/Java/Eclipse/eclipse-jee/workspace/2015.03
/home/eric/Devel/Java/JBoss/jboss-4.0.5.GA/server/pnllogistics/lib
/home/eric/Devel/Java/ActiveMQ/apache-activemq-5.10.1
/home/eric/Devel/Java/Hibernate
/home/eric/Devel/Java/Wicket/wicket/wicket-examples
/home/eric/DB_TAP/Firebird

/home/eric/bin
eric@mposerv8:/backup/mpo-backup/db$ 
[eric@localhost bin]$ dsvfms-db-t.sh 
[eric@localhost bin]$ dsvfms-db2-t.sh 


/home/eric/Devel/Postgres/scripts/w3resource
/var/lib/pgsql/data/pg_log
[eric@localhost LOGS]$ PGPASSWORD=mpopostgres@mpo psql -U mpopostgres pnllogistics3
[eric@localhost Firebird]$ isql-fb -user sysdba -password masterkey first.fdb 
[eric@localhost LOGS]$ psql -U foo 

/ Einde OPEN IN WINDOWS 

/ TABS IN CHROME 

/ firebird

http://www.firebirdsql.org/refdocs/langrefupd25-psql-forselect.html
http://www.firebirdsql.org/file/documentation/reference_manuals/reference_material/html/langrefupd25-ddl-table.html#langrefupd25-alter-table
http://stackoverflow.com/questions/15841167/how-to-input-an-array-parameter-of-values-to-firebird-stored-procedure
http://www.janus-software.com/fbmanual/manual.php?book=psql&topic=37
http://www.pp4s.co.uk/main/tu-db-firebird-demo4.html
http://stackoverflow.com/questions/20844485/firebird-and-stored-procedures-if-exists-then-else
http://stackoverflow.com/questions/30196518/tokene-unknown-creating-a-stored-procedure-with-dynamic-table-name
http://www.ibexpert.net/ibe/index.php?n=Doc.WritingStoredProceduresAndTriggers
http://stackoverflow.com/questions/21115720/insert-select-in-firebird
http://www.ibexpert.net/ibe/index.php?n=Doc.WritingStoredProceduresAndTriggers
http://stackoverflow.com/questions/21115720/insert-select-in-firebird

/ andere 	, 

https://scotch.io/tutorials/submitting-ajax-forms-with-jquery


/ Einde FIREBIRD TABS IN CHROME 

/ PAT-267




/ Einde PAT-267

/ WICKET 

/ See	,
http://www.wicket-library.com/wicket-examples-6.0.x

/ Daar kunnen we kiezen	,
http://www.wicket-library.com/wicket-examples-6.0.x/repeater

public abstract class DataView<T> extends DataViewBase<T>
public abstract class DataViewBase<T> extends AbstractPageableView<T>
public abstract class AbstractPageableView<T> extends RefreshingView<T> implements IPageableItems

public class DataTable<T, S> extends Panel implements IPageableItems
	private final DataGridView<T> datagrid;

public class DataGridView<T> extends AbstractDataGridView<T>




/ Einde WICKET

/ CEVA-15059

/ 7	. 

/ cargo test local	,
/ neem sho2991, deze was planned	, 
/ kies een sa	, collect, en click de seo N4907.1
/ geef de actual start date, gisteren, 19 oct	, click save	,
/ deze seo is STARTED, 8000	, 	en de sho2991 dan ook	, (alle sho's waar deze seo de collect van is zijn started)	,
/ ga terug naar de sho2991, en click de linehaul seo	, deze staat nog op planned	,
/ we zien de status van sho2991 STARTED	, 

/ waarom heeft een rc niet de prijs van de sho2991 berekend?
/ TODO

/  op de seo, als we actual end date , vandaag , 20 eoc	, click save	,
/ de seo is nu FINISHED, 9000	, 
/ we zien de status van sho2991 STARTED	, , klopt, de sho2991 is pas FINISHED als alle sa's FINISHED	, 

/ dus als 1 sa STARTED,	 dan is de sho2991 STARTED
/ als ALLE sa FINISHED, is de sho2991 FINISHED


/ maar in de search list is de sho2991 PLANNED
/ TODO

/ we kiezen sho2991	,
/ click in een shipment order, initial/planned/started of niet	, op cost	,
/ click Post-calculated	, create handmatig de prijs van deze sho	, click 'Create'	,

/ 7	. 

/ edit een sho2991	, 
$ vi oms-sitemap.xmap
			<map:match pattern="shipment-order_edit">
				<map:act type="shipmentOrderEdit">
					<map:select type="session-attribute">
						<map:parameter name="attribute-name" value="builder"/>
						<map:when test="jsp">
							<map:read mime-type="text/html" type="jsp" src="jsp/shipment-order_edit.jsp"/>
						</map:when>
						<map:otherwise>
							<map:redirect-to uri="../wicket?module=oms&amp;wicketpage=shipmentorder.edit.ShipmentOrderEditSelectionPage"/>
						</map:otherwise>			
					</map:select>
				</map:act>
			</map:match>

/ we zien de cost button op het scherm	,

		                			<a href="#" target="_self" onclick="return openFinancialDetails();" class="atoButton">
		                				<c:if test="${cf:property('oms', 'shipmentorder.price.hidden', 'false')=='false'}">
		                					<mpo:label name="price" />
		                				</c:if>
		                				<c:if test="${cf:property('oms', 'shipmentorder.cost.hidden', 'false')=='false'}">
		                					<mpo:label name="cost" />
		                				</c:if>
/ In de database staan deze properties  niet	, maar wel in de pnllogistics.properties file	,
$ vi pnllogistics.properties 
module.oms.shipmentorder.price.hidden = true
module.oms.shipmentorder.cost.hidden = false
/ Daarom staat er cost op de button 	, WH	,

/ In devtools doen we een search	, 
$ vi class.shipment-order_edit.js
function openFinancialDetails() {

	var mySystemId =document.getElementById("systemId").value;
	theShipmentorderFormManager.setRedirectUrl("../wicket/?module=oms&wicketpage=shipmentorder.shipmentorderfinancialdetails.ShipmentOrderFinancialPage&shipmentorder_systemid=" 
			+ mySystemId);
	theShipmentorderFormManager.conditionalSubmit(null,true,1);
	return false;
}

/ we komen op een wicket page	, ShipmentOrderFinancialPage	, 

/ 7. 	

/ we zien 4 tabs	, pre-calculated, post-calculated, actual, price	, TDOO
/ op elke tab zien we 4 panels: Cost, Price, Margin, ...
/ we kijken nu naar de Price panel	, dat is een ShipmentOrderPriceListPanel	, 

$ vi ShipmentOrderPriceListPanel.java
...

Daemon Thread [http-0.0.0.0-8080-4] (Suspended)	
	BaseWebSession(Session).getAuthorizationStrategy() line: 543	
		return getApplication().getSecuritySettings().getAuthorizationStrategy();
com.mpobjects.view.wicket.BaseAuthorizationStrategy@173583aa

	ShipmentOrderPriceListPanel$3$1(Component).isActionAuthorized(Action) line: 2097	
		IAuthorizationStrategy authorizationStrategy = getSession().getAuthorizationStrategy();

	ShipmentOrderPriceListPanel$3$1(Component).isEnableAllowed() line: 2124	
		return isActionAuthorized(ENABLE);

	ShipmentOrderPriceListPanel$3$1(Component).isEnabledInHierarchy() line: 4776	
				state = isEnabled() && isEnableAllowed();
/ isEnabled() is is onze code 
/ TODO (ESTIMATED, NOT_INVOICED)

	ShipmentOrderPriceListPanel$3$1(FormComponent).onComponentTag(ComponentTag) line: 1504	
		if (!isEnabledInHierarchy())

	ShipmentOrderPriceListPanel$3$1(Button).onComponentTag(ComponentTag) line: 198	
		super.onComponentTag(tag);

	ShipmentOrderPriceListPanel$3$1(Component).renderComponent(MarkupStream) line: 2696	
	ShipmentOrderPriceListPanel$3$1(MarkupContainer).onRender(MarkupStream) line: 1559	
	ShipmentOrderPriceListPanel$3$1(Component).render(MarkupStream) line: 2525	
	Item(MarkupContainer).renderNext(MarkupStream) line: 1461	
	Item(MarkupContainer).renderComponentTagBody(MarkupStream, ComponentTag) line: 1624	
	Item(MarkupContainer).onComponentTagBody(MarkupStream, ComponentTag) line: 1548	
	Item(Component).renderComponent(MarkupStream) line: 2725	
	Item(MarkupContainer).onRender(MarkupStream) line: 1559	
	Item(Component).render(MarkupStream) line: 2525	
	ShipmentOrderPriceListPanel$3(AbstractRepeater).renderChild(Component) line: 122	
	ShipmentOrderPriceListPanel$3(AbstractRepeater).onRender(MarkupStream) line: 103	
	ShipmentOrderPriceListPanel$3(Component).render(MarkupStream) line: 2525	
	WebMarkupContainer(MarkupContainer).renderNext(MarkupStream) line: 1461	
	WebMarkupContainer(MarkupContainer).renderComponentTagBody(MarkupStream, ComponentTag) line: 1624	
	WebMarkupContainer(MarkupContainer).onComponentTagBody(MarkupStream, ComponentTag) line: 1548	
	WebMarkupContainer(Component).renderComponent(MarkupStream) line: 2725	
	WebMarkupContainer(MarkupContainer).onRender(MarkupStream) line: 1559	
	WebMarkupContainer(Component).render(MarkupStream) line: 2525	
	ShipmentOrderPriceListPanel(MarkupContainer).renderNext(MarkupStream) line: 1461	
	ShipmentOrderPriceListPanel(MarkupContainer).renderComponentTagBody(MarkupStream, ComponentTag) line: 1624	
	ShipmentOrderPriceListPanel(MarkupContainer).renderAssociatedMarkup(String, String) line: 717	
	ShipmentOrderPriceListPanel(Panel).onComponentTagBody(MarkupStream, ComponentTag) line: 114	
	ShipmentOrderPriceListPanel(Component).renderComponent(MarkupStream) line: 2725	
	ShipmentOrderPriceListPanel(MarkupContainer).onRender(MarkupStream) line: 1559	
	ShipmentOrderPriceListPanel(Component).render(MarkupStream) line: 2525	
	ShipmentOrderPriceCostTab(MarkupContainer).renderNext(MarkupStream) line: 1461	
	ShipmentOrderPriceCostTab(MarkupContainer).renderComponentTagBody(MarkupStream, ComponentTag) line: 1624	
	ShipmentOrderPriceCostTab(MarkupContainer).renderAssociatedMarkup(String, String) line: 717	
	ShipmentOrderPriceCostTab(Panel).onComponentTagBody(MarkupStream, ComponentTag) line: 114	
	ShipmentOrderPriceCostTab(Component).renderComponent(MarkupStream) line: 2725	
	ShipmentOrderPriceCostTab(MarkupContainer).onRender(MarkupStream) line: 1559	
	ShipmentOrderPriceCostTab(Component).render(MarkupStream) line: 2525	
	AjaxTabbedPanel(MarkupContainer).renderNext(MarkupStream) line: 1461	
	AjaxTabbedPanel(MarkupContainer).renderComponentTagBody(MarkupStream, ComponentTag) line: 1624	
	AjaxTabbedPanel(MarkupContainer).renderAssociatedMarkup(String, String) line: 717	
	AjaxTabbedPanel(Panel).onComponentTagBody(MarkupStream, ComponentTag) line: 114	
	AjaxTabbedPanel(Component).renderComponent(MarkupStream) line: 2725	
	AjaxTabbedPanel(MarkupContainer).onRender(MarkupStream) line: 1559	
	AjaxTabbedPanel(Component).render(MarkupStream) line: 2525	
	AjaxTabbedPanel(Component).renderComponent() line: 2666	
	AjaxRequestTarget.respondComponent(Response, String, Component) line: 876	
	AjaxRequestTarget.respondComponents(WebResponse) line: 680	
	AjaxRequestTarget.respond(RequestCycle) line: 590	
	WebRequestCycleProcessor(AbstractRequestCycleProcessor).respond(RequestCycle) line: 105	
	MpoWebRequestCycle(RequestCycle).processEventsAndRespond() line: 1287	
	MpoWebRequestCycle(RequestCycle).step() line: 1358	
	MpoWebRequestCycle(RequestCycle).steps() line: 1465	
	MpoWebRequestCycle(RequestCycle).request() line: 545	
	WicketFilter.doGet(HttpServletRequest, HttpServletResponse) line: 486	
	WicketServlet.doGet(HttpServletRequest, HttpServletResponse) line: 138	
	WicketServlet(HttpServlet).service(HttpServletRequest, HttpServletResponse) line: 697	
	WicketServlet(HttpServlet).service(ServletRequest, ServletResponse) line: 810	
	ApplicationFilterChain.internalDoFilter(ServletRequest, ServletResponse) line: 252	
...

/ ShipmentOrderPriceListPanel$3$1 is de edit button	(op een rij),

/ we debug verder	, 
/t
ShipmentOrderPriceListPanel$3$1(Component).isActionAuthorized(Action) line: 2098	
/=
	public final boolean isActionAuthorized(Action action)
action	org.apache.wicket.authorization.Action  (id=32307)	
ENABLE
		IAuthorizationStrategy authorizationStrategy = getSession().getAuthorizationStrategy();
com.mpobjects.view.wicket.BaseAuthorizationStrategy@173583aa
/s
BaseAuthorizationStrategy.isActionAuthorized(Component, Action) line: 65	
		PermissionType myP = getPermissionManager(component).checkPermission(component, action);
/s
BaseAuthorizationStrategy.getPermissionManager(Component) line: 203	

		HttpServletRequest req = ((WebRequest) RequestCycle.get().getRequest()).getHttpServletRequest();
req	org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestWrapper  (id=33081)	
	request	org.springframework.security.web.firewall.RequestWrapper  (id=33086)	
		request	org.apache.catalina.connector.RequestFacade  (id=33089)	
		stripPaths	false	
		strippedPathInfo	"/" (id=33090)	
		strippedServletPath	"/wicket" (id=33091)	
	rolePrefix	null	
	trustResolver	org.springframework.security.authentication.AuthenticationTrustResolverImpl  (id=33087)	

		WicketPermissionManager myManager = (WicketPermissionManager) req.getAttribute("PM");
myManager	com.mpobjects.oms.service.permission.WicketPermissionManager  (id=33012)	
	checkedComponentClasses	java.util.HashSet  (id=33078)	
	groupCache	java.util.HashMap  (id=33079)	
	permissionGroupDAO	null	
	permissionService	null	
	resource	null	

		return myManager;
/t
BaseAuthorizationStrategy.isActionAuthorized(Component, Action) line: 66	
		PermissionType myP = getPermissionManager(component).checkPermission(component, action);
/s
WicketPermissionManager.checkPermission(Component, Action) line: 28	
/=
	public PermissionType checkPermission(Component aComponent, Action anAction) {
		if (isCheckedComponent(aComponent)) {
/ NEE
		return null;
/t
BaseAuthorizationStrategy.isActionAuthorized(Component, Action) line: 88	
		PermissionType myP = getPermissionManager(component).checkPermission(component, action);
null
		if (myP != null) {
/ NEE
		Privilege myPrivilege = component.getClass().getAnnotation(Privilege.class);
null
		if (myPrivilege == null) {
			...
			return true;
...
/t
ShipmentOrderPriceListPanel$3$1(Component).isEnabledInHierarchy() line: 4778	
				state = isEnabled() && isEnableAllowed();
true
/t
ShipmentOrderPriceListPanel$3$1(FormComponent).onComponentTag(ComponentTag) line: 1509	
		if (!isEnabledInHierarchy())
/ NEE
		{
			onDisabled(tag);
/ NIET
		super.onComponentTag(tag);










 

/ Einde CEVA-15059

/ PAT-267

/ we hebben b's set in 	, voor wicket	,
QueryViewPanel
PartyListPanel
FilterBarPanel

/ Einde PAT-267




/ DSVSOL-2716

/ See DSVSOL-2719
/ database van acceptance restore op test,	

/ Ga in Jira naar DEV - Support team dashboard
/ Rechtsonder	, deploy tasks	,

/ DEPLOY TASKS

/ 7	. 

/ CSEDO-2829	, overslaan	,
/ CSEDO-3032	, overslaan	,

/ 7	. 

/ DSVSOL-2231	, overslaan	,  wel op productie !

SQL>  select  u.is_enabled from tms_role r join user_role ur on r.system_id=ur.role_systemid join tms_user u on u.system_id=ur.user_systemid where r.name in ('CUSTOMER', 'CARRIER') ;

IS_ENABLED 
========== 
         1 
         0 
         1 
...

/ 7	. 

/ GEOFLOW-214	, overslaan

/ 7	. 
/ SCS-3304	, al gedaan	,

SQL>  select  status from mpo_scs_patch where name ='patch-304-cost-price-type-merge.sql';

STATUS                           
================================ 
APPLIED   

SQL> select code, count(1) from cost_type group by code having count(1) > 1;
SQL> 
/ Inderdaad	,

/ 7	. 

/ SCS-1810	, done	, 

/ Het is juist NIET gedaan	,

eric@mposerv11:/tmp$ jar xvf /local/apps/jboss-4.0.5.GA/lib/endorsed/xercesImpl.jar 
eric@mposerv11:/tmp$ less META-INF/MANIFEST.MF 
Comment: Xerces-J 2.7.1 

eric@mposerv11:/tmp$ jar xvf /local/apps/jboss-4.0.5.GA/server/dsvfms/lib/xercesImpl.jar 
eric@mposerv11:/tmp$ less META-INF/MANIFEST.MF 
Comment: Xerces-J 2.11.0

/ 7	. 

/ SCS-3032, is al	, 

/ Kijk in server/dsvfms/deploy/	, 

/ 7	. 

/ SCS-2698	, is al,

eric@mposerv11:/local/apps/jboss-4.0.5.GA/server/dsvfms$ less conf//local_application.properties 
...
module.interfacing.jms.server.url=tcp\://jms-test\:61616

/ update ticket	, TODO 

/ 7	. 

/ SCS-3975, done

/ updated ticket	, OK done?  TODO

/ 7	. 

/ SCS-4480	,  LATER 

/ table cost_type kan ik niet drop	,
-there are 3 dependencies

/ 7	. 

/ SCS-3874	, overslaan	, CEVA	,

/ 7	. 

/ SCS-4074	, overslaan	, Naccomfg

/ 7	. 

/ SCS-2703	,  is al	, 

tms-listener-subscriber-schedule-service.xml is niet in deploy/	, 

/ 7	. 

/ SCS-3443	, is al	,

jboss@mposerv11:/local/apps/jboss-4.0.5.GA/server/dsvfms$ find deploy/ -name omscarcon-fetch-carcon-events-service.xml
/ GEEN

/ 	7  

/ SCS-3172 , is al	,

SQL> SELECT fd1.SYSTEM_ID as KEEP, fd2.SYSTEM_ID as TO_BE_REMOVED, fd1.NAME 
CON>   FROM FUNCTION_DEFINITION fd1 join FUNCTION_DEFINITION fd2 
CON>   ON fd1.SYSTEM_ID < fd2.SYSTEM_ID and fd1.NAME = fd2.NAME ORDER BY fd1.NAME, fd1.SYSTEM_ID;
SQL> 

/ 7	. 

/ SCS-4577	, WH overslaan	, Postgres

/ 7	. 

/ SCS-4418

/ 7	. 

SQL> select shipment_order_systemid, shipment_item_id from shipment_item where SHIPMENT_ORDER_SYSTEMID=11551839;

SHIPMENT_ORDER_SYSTEMID SHIPMENT_ITEM_ID                                                                 
======================= =============================================================================== 
               11551839 1                                                                                
               11551839 2                                                                                
               11551839 3                                                                                
               11551839 4                                                                                
               11551839 5                                                                                
               11551839 1                                                                                

/ Met sho's shipment_order_id	,
SQL> select sho.system_id, sho.shipment_order_id,shi.system_id, shi.shipment_item_id from shipment_item shi join shipment_order sho on shi.shipment_order_systemid=sho.system_id where sho.system_id=115

   SYSTEM_ID SHIPMENT_ORDER_ID                                                                   SYSTEM_ID SHIPMENT_ITEM_ID                                                                 
============ =============================================================================== ============ =============================================================================== 
    11551839 SH001051572                                                                          11551843 1                                                                                
    11551839 SH001051572                                                                          11551844 2                                                                                
    11551839 SH001051572                                                                          11551845 3                                                                                
    11551839 SH001051572                                                                          11551846 4                                                                                
    11551839 SH001051572                                                                          11551847 5                                                                                
    11551839 SH001051572                                                                          11552379 1                                    

SQL>  show table shipment_order;
SYSTEM_ID                       INTEGER Nullable 
SHIPMENT_ORDER_ID               VARCHAR(80) Nullable 


SQL> show table shipment_item;
SYSTEM_ID                       INTEGER Nullable 
SHIPMENT_ITEM_ID                VARCHAR(80) Nullable 
SHIPMENT_ORDER_SYSTEMID         INTEGER Nullable 
ONSTRAINT SI_SHIPMENT_ORDER_FK:
  Foreign key (SHIPMENT_ORDER_SYSTEMID)    References SHIPMENT_ORDER (SYSTEM_ID) On Delete Cascade

/ 7	. 

/ we oefenen zelf	,

drop table shi;
drop table sho;
create table sho(sys_id int,sho_id varchar(32),primary key(sys_id));
create table shi(sys_id int,sho_sysid int, shi_id varchar(32),primary key(sys_id),foreign key(sho_sysid)references sho(sys_id));

insert into sho values(11,11);
insert into sho values(12,12);
insert into sho values(13,13);
insert into shi values(1,11,1);
insert into shi values(2,11,1);
insert into shi values(3,11,1);
insert into shi values(4,12,2);
insert into shi values(5,12,2);
insert into shi values(6,12,2);
insert into shi values(7,12,2);
insert into shi values(8,12,3);
insert into shi values(9,12,3);
insert into shi values(10,13,4);
...

/ 7	.

SQL> select*from shi;

      SYS_ID    SHO_SYSID SHI_ID                           
============ ============ ================================ 
           1           11 1                                
           2           11 1                                
           3           11 1                                
           4           12 2                                
           5           12 2                                
           6           12 2                                
           7           12 2                                
           8           12 3                                
           9           12 3                                
          10           13 4      

SQL> select sho_sysid,shi_id,count(shi_id) from shi group by sho_sysid,shi_id ;
/ of	,
SQL> select sho_sysid,shi_id,count(sho_sysid) from shi group by sho_sysid,shi_id ;


   SHO_SYSID SHI_ID                                  COUNT 
============ ================================ ============ 
          11 1                                           3 
          12 2                                           4 
          12 3                                           2 
          13 4                                           1 

/ we willen weten hoeveel verschillende sho's we zien	, hier 2 dus	, 

SQL> select sho_sysid from shi group by sho_sysid,shi_id  having count(shi_id)>1;

   SHO_SYSID 
============ 
          11 
          12 
          12 

SQL> select count(distinct sho_sysid) from shi group by sho_sysid,shi_id  having count(shi_id)>1;

       COUNT 
============ 
           1 
           1 
           1 
/ Deze is dus NIET OK	,

/ 13	. 

SQL> select shi.sho_sysid,shi.shi_id,count(shi.shi_id) 
	from shi 
	group by shi.sho_sysid,shi.shi_id  
	having count(shi.shi_id)>1;

   SHO_SYSID SHI_ID                                  COUNT 
============ ================================ ============ 
          11 1                                           3 
          12 2                                           4 
          12 3                                           2 

SQL> select sho.* from sho join shi on sho.sys_id=shi.sho_sysid group by shi.sho_sysid,shi.shi_id  having count(shi.shi_id)>1;
/ ERR

SQL> select count from (select shi.sho_sysid,shi.shi_id,count(shi.shi_id) as count from shi group by shi.sho_sysid,shi.shi_id  having count(shi.shi_id)>1);
/ ERR

SQL> select count(distinct sho_sysid) from (select shi.sho_sysid from shi group by shi.sho_sysid,shi.shi_id  having count(shi.shi_id)>1);

       COUNT 
============ 
           2 

/ dus we doen	,

SQL> select count(distinct shipment_order_systemid)from ( select shipment_order_systemid from shipment_item group by shipment_order_systemid, shipment_item_id having count(1)>1);

       COUNT 
============ 
       22404 

SQL> select count( shipment_order_systemid)from ( select shipment_order_systemid from shipment_item group by shipment_order_systemid, shipment_item_id having count(1)>1);

       COUNT 
============ 
       65085 



/  7	. 

SQL> update shi set shi_id=0 where sho_sysid=11;
/ OK, TODO (shi_id is varchar )
SQL> select*from shi;

      SYS_ID    SHO_SYSID SHI_ID                           
============ ============ ================================ 
           1           11 0                                
           2           11 0                                
           3           11 0        

/ WH doet hij de where clause 1 keer	, en de set's iedere keer	, iedere keer treft dus een nieuw max aan	,

update shi 
set shi_id=cast((select max(cast(shi_id as int))from shi where sho_sysid=11)as integer)+1
where sys_id in (select sys_id from shi where sho_sysid=11)  
SQL> select*from shi;

      SYS_ID    SHO_SYSID SHI_ID                           
============ ============ ================================ 
           1           11 1                                
           2           11 2                                
           3           11 3                 


update shi 
set shi_id=cast((select max(cast(shi_id as int))from shi where sho_sysid=12)as integer)+1
where sys_id in (select sys_id from shi where sho_sysid=12)  
/ OK



/ 7	.  


update shipment_item 
set shipment_item_id = 0 
where shipment_order_systemid = ?shipment_order_systemid;

update shipment_item 
set shipment_item_id = CAST( (select max(cast(shipment_item_id as int)) from shipment_item where shipment_order_systemid = ?shipment_order_systemid) AS INTEGER) + 1 
where system_id in ( select SYSTEM_ID from shipment_item where shipment_order_systemid = ?shipment_order_systemid);


/ 7	. 

/ we zien bijv	,

SHIPMENT_ORDER_SYSTEMID SHIPMENT_ITEM_ID                                                                        COUNT 
======================= =============================================================================== ============ 
              109910067 10                                                                                          2 
              109910067 11                                                                                          2 
              109910067 12                                                                                          2 
              109910067 13                                                                                          2 
              109910067 2                                                                                           2 
              109910067 3                                                                                           2 
              109910067 4                                                                                           2 
              109910067 5                                                                                           2 
              109910067 6                                                                                           2 
              109910067 7                                                                                           2 
              109910067 8                                                                                           2 
              109910067 9                                                                                           2 

/ we zien	,

SQL> select sho.system_id, sho.shipment_order_id,shi.system_id, shi.shipment_item_id from shipment_item shi join shipment_order sho on shi.shipment_order_systemid=sho.system_id where sho.system_id=109910067;

   SYSTEM_ID SHIPMENT_ORDER_ID                                                                   SYSTEM_ID SHIPMENT_ITEM_ID                                                                 
============ =============================================================================== ============ =============================================================================== 
   109910067 SH003013332                                                                         109910076 1                                                                                
   109910067 SH003013332                                                                         109910077 2                                                                                
   109910067 SH003013332                                                                         109910078 3                                                                                
   109910067 SH003013332                                                                         109910079 4                                                                                
   109910067 SH003013332                                                                         109910080 5                                                                                
   109910067 SH003013332                                                                         109910081 6                                                                                
   109910067 SH003013332                                                                         109910082 7                                                                                
   109910067 SH003013332                                                                         109910083 8                                                                                
   109910067 SH003013332                                                                         109910084 9                                                                                
   109910067 SH003013332                                                                         109910085 10                                                                               
   109910067 SH003013332                                                                         109910086 11                                                                               
   109910067 SH003013332                                                                         109910087 12                                                                               
   109910067 SH003013332                                                                         109910088 13                                                                               
   109910067 SH003013332                                                                         109910089 14                                                                               
   109910067 SH003013332                                                                         109910090 15                                                                               
   109910067 SH003013332                                                                         109914321 1                                                                                
   109910067 SH003013332                                                                         109914322 2                                                                                
   109910067 SH003013332                                                                         109914323 3                                                                                
   109910067 SH003013332                                                                         109914324 4                                                                                
   109910067 SH003013332                                                                         109914325 5                                                                                
   109910067 SH003013332                                                                         109914326 6                                                                                
   109910067 SH003013332                                                                         109914327 7                                                                                
   109910067 SH003013332                                                                         109914328 8                                                                                
   109910067 SH003013332                                                                         109914329 9                                                                                
   109910067 SH003013332                                                                         109914330 10                                                                               
   109910067 SH003013332                                                                         109914331 11                                                                               
   109910067 SH003013332                                                                         109914332 12                                                                               
   109910067 SH003013332                                                                         109914333 13                                                                               
SQL> select shipment_order_systemid, shipment_item_id, count(1) from shipment_item group by shipment_order_systemid, shipment_item_id having count(1)>1 and shipment_order_systemid in (109867716,109902253);

SHIPMENT_ORDER_SYSTEMID SHIPMENT_ITEM_ID                                                                        COUNT 
======================= =============================================================================== ============ 
              109867716 1                                                                                           2 
              109867716 2                                                                                           2 
              109867716 3                                                                                           2 
              109902253 1                                                                                           6 
              109902253 2                                                                                           3 
              109902253 3                                                                                           2 


SQL> select shipment_order_systemid, shipment_item_id from shipment_item where  shipment_order_systemid=109867716;

SHIPMENT_ORDER_SYSTEMID SHIPMENT_ITEM_ID                                                                 
======================= =============================================================================== 
              109867716 1                                                                                
              109867716 2                                                                                
              109867716 3                                                                                
              109867716 1                                                                                
              109867716 2                                                                                
              109867716 3                                                                                
              109867716 4                 

SHIPMENT_ORDER_SYSTEMID SHIPMENT_ITEM_ID                                                                 
======================= =============================================================================== 
              109902253 1                                                                                
              109902253 2                                                                                
              109902253 3                                                                                
              109902253 1                                                                                
              109902253 1                                                                                
              109902253 2                                                                                
              109902253 1                                                                                
              109902253 1                                                                                
              109902253 1                                                                                
              109902253 2                                                                                
              109902253 3                                                                                
              109902253 4                                                                                
/ 7	. 

/ 13	. 

/ Hoe insert line into file	?

eric@localhost scripts]$ cat foo.sh 
#!/usr/bin/bash
echo "$@"

[eric@localhost scripts]$ awk 'NR==2{print "bar"}{print}' foo.sh 
#!/usr/bin/bash
bar
echo "$@"

/ 13	. 

/ grappig	,

eric@localhost scripts]$ awk 'NR==2{print ""}{print}' <(find -name "*.sh")
./local/def_p2.sh

./local/exec_qt3.sh
./local/def_shi_cp.sh
./local/def_p.sh
...

/ 13	. 

[eric@localhost scripts]$ cp foo.sh bar.sh
[eric@localhost scripts]$ awk 'NR==2{print "bar "}{print}' $(find -maxdepth 1 -name "*.sh")
#!/usr/bin/bash
bar 
echo "$@"
#!/usr/bin/bash
echo "$@"

/ De optie is er NIET	, maar, 	

[eric@localhost scripts]$ for i in $(find -maxdepth 1 -name "*.sh");do awk 'NR==2{print "bar "}{print}' $i >tmp;mv tmp $i;done
[eric@localhost scripts]$ cat foo.sh 
#!/usr/bin/bash
bar 
echo "$@"
[eric@localhost scripts]$ cat bar.sh 
#!/usr/bin/bash
bar 
echo "$@"

/ OK 

/ 13	. 

[eric@localhost scripts]$ cat foo.sh 
#!/usr/bin/bash
echo "../../first.db" 

[eric@localhost scripts]$ for f in $(find -maxdepth 1 -name "*.sh");do awk '{sub("\\.\\./\\.\\.","/home/eric/DB_TAP/Firebird/Local")}{print}' $f >tmp;mv tmp $f;done

[eric@localhost scripts]$ cat foo.sh 
#!/usr/bin/bash
echo "/home/eric/DB_TAP/Firebird/Local/first.db" 

/ 13	. 

[eric@localhost local]$ pwd
/home/eric/Devel/Firebird/scripts/local

[eric@localhost local]$ for f in $(find -maxdepth 1 -name "*.sh");do awk '{sub("\\.\\./\\.\\.","/home/eric/DB_TAP/Firebird/Local")}{print}' $f >tmp;mv tmp $f;done

[eric@localhost local]$ chmod u+x $(find -name "*.sh")

[eric@localhost local]$ ./def_drops2.sh 
[eric@localhost local]$ ./def_p4a.sh 
[eric@localhost local]$ ./exec_p4a.sh 
/ OK

/ 13	. 

$ local-db.sh /home/eric/DB_TAP/Firebird/Dsvfms/dsvfms.fdb_20151019-000019_cp.fdb 

/ See FIREBIRD PROCEDURES , SAMENVATTING


/ 7	.

/ SCS-2286, done	,

jboss@mposerv11:/local/apps/jboss-4.0.5.GA/server/dsvfms$ sha1sum lib/shiftone-cache-mpo.jar 
e6b2ce4d80ea53f86ee858af2c07a6565d448530  lib/shiftone-cache-mpo.jar

/ 7	.

/ SCS-2272	, overslaan	,

/ 7	. 

/ SCS-4418	, LATER

/ 7	. 

/ SCS-2286, is al	,

jboss@mposerv11:/local/apps/jboss-4.0.5.GA/server/dsvfms$ sha1sum ./lib/shiftone-cache-mpo.jar
e6b2ce4d80ea53f86ee858af2c07a6565d448530  ./lib/shiftone-cache-mpo.jar

/ 7	. 

/ SCS-2272	, overslaan , = CEVA

/ 7	. 

/ SCS-2694, done

[eric@localhost bin]$ dsvfms-scp-t.sh ~/Downloads/catalina.jar 

/ eric scp to /tmp, of /home/INTERNAL/eric. The permissions of /tmp/catalina.jar are -rw-------	. 
/ catalina.jar heeft toevallig geen r bij other	, dus -rw-r--r--	 bijv	,
/ de jar's uit lib/  hebben wel -rw-r--r--	, dus kunnen we naar ~eric scp	,  en jboss kan ze cp naar dsvfms/lib	,
eric$ chown o+r catalina.jar
eric$ sudo su - jboss
jboss$ cp /tmp/catalina.jar /local/apps/jboss-4.0.5.GA/server/dsvfms/deploy/jbossweb-tomcat55.sar/
/ OK
/ als eric NIET chown	, dan kan jboss de file niet lezen	, en dan Permission error	,

jboss@mposerv11:~$ sha1sum /local/apps/jboss-4.0.5.GA/server/dsvfms/deploy/jbossweb-tomcat55.sar/catalina.jar 
bf6753ec68008553083e5d023d7f25daa22ceea0  /local/apps/jboss-4.0.5.GA/server/dsvfms/deploy/jbossweb-tomcat55.sar/catalina.jar

/ 7	. 

/ SCS-4534	, done

/ edit deploy/firebird-ds.xml


/ 7	. 

/ SCS-4740	, overslaan (is voor dsvcts)	,

/ 7	. 

/ SCS-4799, overslaan, (is voor pnllogistics)	,

/ 7	. 

/ SCS-4848	, overslaan (is niet voor dsvfms)	,

/ 7	. 

/ Lees	,
https://system.mp-objects.com/xwiki/bin/view/Technology/ReleaseTODOList
/ TODO

/ 7	. 

/ build in Jenkins	,

jboss@mposerv11:~/releases$ curl -u eric -O https://system.mp-objects.com/jenkins/job/SCS-OnDemand/3263/artifact/dist/tms-dsvfms-21224-2015.03_build3263.zip
jboss@mposerv11:~/releases$ deploy-dsvfms.sh /local/apps/releases/tms-dsvfms-21224-2015.03_build3263.zip /local/apps/jboss-4.0.5.GA/server/dsvfms/
$ dsvfms start track

jboss@mposerv11:/local/apps/jboss-4.0.5.GA/server/dsvfms$ vi log/server.log
2015-10-13 15:28:51,589 ERROR [com.mpobjects.libcheck.LibCheckService] (main:)    MUST_BE_REMOVED : activeio-core-3.1.2.jar
2015-10-13 15:28:51,589 ERROR [com.mpobjects.libcheck.LibCheckService] (main:)            MISSING : activeio-core-3.1.4.jar
2015-10-13 15:28:51,590 ERROR [com.mpobjects.libcheck.LibCheckService] (main:)            MISSING : activemq-broker-5.10.2.jar
2015-10-13 15:28:51,590 ERROR [com.mpobjects.libcheck.LibCheckService] (main:)            MISSING : activemq-client-5.10.2.jar
2015-10-13 15:28:51,590 ERROR [com.mpobjects.libcheck.LibCheckService] (main:)    MUST_BE_REMOVED : activemq-core-5.3.0.jar
2015-10-13 15:28:51,590 ERROR [com.mpobjects.libcheck.LibCheckService] (main:)            MISSING : activemq-kahadb-store-5.10.2.jar
...

/ we copy server.log naar laotop	,
[eric@localhost bin]$ cat dsvfms-scp-from-t.sh 
#!/bin/bash
echo "Eric789@MPO" 
scp eric@mposerv11:/local/apps/jboss-4.0.5.GA/server/dsvfms/"$@" ~eric/Downloads

/ 13	. 

/ rm jars op mposerv11	,

/ Lees	,
http://www.cyberciti.biz/tips/linux-running-commands-on-a-remote-host.html
/ TODO

[eric@localhost bin]$ dsvfms-exec-t.sh "cd //local/apps/jboss-4.0.5.GA/server/dsvfms;echo $( awk '/MUST_BE_REMOVED/ && /.jar/{print $8}' ~/Downloads/server.log )"
/ server.log locally?
/ TODO

/ op laptop	,
[eric@localhost bin]$ echo $( awk '/MUST_BE_REMOVED/ && /.jar/{print $8}' ~/Downloads/server.log )
activeio-core-3.1.2.jar activemq-core-5.3.0.jar activemq-pool-5.3.0.jar activemq-ra-5.3.0.jar antlr.jar aspectjrt.jar aspectjweaver.jar bcprov-jdk16-139.jar commons-codec-1.4.jar commons-io.jar commons-lang-2.4.jar commons-pool.jar ehcache-1.5.0.jar hibernate-annotations.jar hibernate3.jar javassist.jar joda-time-2.2.jar joda-time-hibernate-1.2.jar postgresql-9.2-1003.jdbc4.jar quartz-1.6.0.jar slf4j-api-1.4.2.jar slf4j-log4j12-1.4.2.jar spring-agent.jar spring-aop.jar spring-aspects.jar spring-beans.jar spring-context-support.jar spring-context.jar spring-core.jar spring-jdbc.jar spring-jms_mpo.jar spring-orm.jar spring-test.jar spring-tomcat-weaver.jar spring-tx.jar spring-web.jar spring-webmvc-portlet.jar spring-webmvc.jar wicket-1.4.19.jar wicket-auth-roles-1.4.19.jar wicket-datetime-1.4.19.jar wicket-devutils-1.4.19.jar wicket-extensions-1.4.19.jar wicket-spring-1.4.19.jar wiquery-1.2.3.jar

/ op mposerv11	,
jboss@mposerv11:/local/apps/jboss-4.0.5.GA/server/dsvfms/lib$ rm -f activeio-core-3.1.2.jar activemq-core-5.3.0.jar activemq-pool-5.3.0.jar activemq-ra-5.3.0.jar antlr.jar aspectjrt.jar aspectjweaver.jar bcprov-jdk16-139.jar commons-codec-1.4.jar commons-io.jar commons-lang-2.4.jar commons-pool.jar ehcache-1.5.0.jar hibernate-annotations.jar hibernate3.jar javassist.jar joda-time-2.2.jar joda-time-hibernate-1.2.jar postgresql-9.2-1003.jdbc4.jar quartz-1.6.0.jar slf4j-api-1.4.2.jar slf4j-log4j12-1.4.2.jar spring-agent.jar spring-aop.jar spring-aspects.jar spring-beans.jar spring-context-support.jar spring-context.jar spring-core.jar spring-jdbc.jar spring-jms_mpo.jar spring-orm.jar spring-test.jar spring-tomcat-weaver.jar spring-tx.jar spring-web.jar spring-webmvc-portlet.jar spring-webmvc.jar wicket-1.4.19.jar wicket-auth-roles-1.4.19.jar wicket-datetime-1.4.19.jar wicket-devutils-1.4.19.jar wicket-extensions-1.4.19.jar wicket-spring-1.4.19.jar wiquery-1.2.3.jar

/ 13	. 

/ add jars to mposerv11 ,


[eric@localhost bin]$ dsvfms-scp-from-t.sh log/server.log

eric@mposerv11:~$ rm $(find -maxdepth 1 -name "*.jar")
$ mkdir Downloads
[eric@localhost bin]$ (cd /home/eric/Devel/Java/JBoss/jboss-4.0.5.GA/server/pnllogistics/lib;dsvfms-scp-to-t.sh $(awk '/MISSING/ && /.jar/{print $8}' ~/Downloads/server.log )) 
Eric789@MPO

/ we keken in de verkeerde dir	, pnllogistics	, 
/ beter is in de svn checkout te kijken	, in ./base-framework/core/lib/jar	, 
/ in trunk is bijv niet hibernate3.6.10.mpo.1.jar	,

[eric@localhost bin]$ (cd /home/eric/Devel/Java/Eclipse/eclipse-jee/workspace/2015.03/./base-framework/core/lib/jar; awk '/MISSING/ && /.jar/{print $8}' ~/Downloads/server.log) 
...
hibernate3.6.10.mpo.1.jar
...

/ Op mopserv11	,
eric@mposerv11:~$ ls Downloads/
activeio-core-3.1.4.jar                jackson-annotations-2.6.0.jar              spring-core-3.2.14.RELEASE.jar
activemq-broker-5.10.2.jar             jackson-core-2.6.0.jar                     spring-expression-3.2.14.RELEASE.jar
activemq-client-5.10.2.jar             jackson-databind-2.6.0.jar                 spring-jdbc-3.2.14.RELEASE.jar
activemq-kahadb-store-5.10.2.jar       javassist-3.12.0.GA.jar                    spring-jms-3.2.14.RELEASE.jar
activemq-openwire-legacy-5.10.2.jar    joda-time-2.3.jar                          spring-orm-3.2.14.RELEASE.jar
activemq-protobuf-1.1.jar              joda-time-hibernate-1.3.jar                spring-security-config-3.2.8.RELEASE.jar
activemq-spring-5.10.2.jar             jta-1.1.jar                                spring-security-core-3.2.8.RELEASE.jar
antlr-2.7.6.jar                        kahadb-5.3.0.jar                           spring-security-saml2-core-1.0.1.RELEASE.jar
aspectjweaver-1.7.4.jar                not-yet-commons-ssl-0.3.9.jar              spring-security-web-3.2.8.RELEASE.jar
bcprov-jdk15on-1.52.jar                opensaml-2.6.1.jar                         spring-test-3.2.14.RELEASE.jar
commons-codec-1.9.jar                  openws-1.5.1.jar                           spring-tx-3.2.14.RELEASE.jar
commons-csv-1.1.jar                    postgresql-9.4-1200.jdbc4.jar              spring-web-3.2.14.RELEASE.jar
commons-io-2.4.jar                     quartz-1.8.6.jar                           velocity-1.7.jar
commons-lang-2.6.jar                   rtcalltree-0.1.0-SNAPSHOT.jar              wicket-1.4.23.jar
commons-lang3-3.3.2.jar                slf4j-api-1.6.1.jar                        wicket-auth-roles-1.4.23.jar
commons-pool-1.5.7.jar                 slf4j-log4j12-1.6.1.jar                    wicket-datetime-1.4.23.jar
disruptor-3.3.0.jar                    spring-aop-3.2.14.RELEASE.jar              wicket-extensions-1.4.23.jar
ehcache-2.10.0.jar                     spring-aspects-3.2.14.RELEASE.jar          wiquery-1.2.3.2-20150604.122120-1.jar
esapi-2.0.1.jar                        spring-beans-3.2.14.RELEASE.jar            xbean-spring-3.18.jar
hawtbuf-1.10.jar                       spring-context-3.2.14.RELEASE.jar          xmlsec-1.5.6.jar
hibernate-jpa-2.0-api-1.0.0.Final.jar  spring-context-support-3.2.14.RELEASE.jar  xmltooling-1.4.1.jar

jboss@mposerv11:/home/INTERNAL/eric/Downloads$ cp $(find -maxdepth 1 -name "*.jar" ) /local/apps/jboss-4.0.5.GA/server/dsvfms/lib

/we repair,	
/ op laptop	,
[eric@localhost 2015.03]$ dsvfms-scp-to-t.sh $(find -name hibernate3.6.10.mpo.1.jar) 
/ op mposerv11	,
jboss@mposerv11:/home/INTERNAL/eric/Downloads$ cp hibernate3.6.10.mpo.1.jar /local/apps/jboss-4.0.5.GA/server/dsvfms/lib




/ 7	. 

/ we start deploy	, en have patch errors	, 

/ we kunnen ze lezen in de mpo_scs_patch table,	 of in de svn chechout	,

[eric@localhost patch]$ pwd
/home/eric/Devel/Java/Eclipse/eclipse-jee/workspace/2015.03/module/oms/src/sql/patch

/ 7	.  

/ PATCH-364-FIX-PARTY-ORG-FK.SQL

/ Insert een aantal rijen in organization table	, zodat we een fk kunnen maken in de party table	, 
/ er zijn in party table rijen met organization_systemid , die geen system_id's zijn in de organization table	, 

$ vi patch-364-fix-party-org-fk.sql

insert into organization
select organization_systemid, 'DO_NOT_USE_' || organization_systemid, 'Dummy organization to fix foreign key problem', 0,1,null
from PARTY 
where ORGANIZATION_SYSTEMID not in (
	select SYSTEM_ID 
	from ORGANIZATION) 
group by organization_systemid;

SQL> show table organization;
SYSTEM_ID                       INTEGER Nullable 
ORGANIZATION_ID                 VARCHAR(20) Nullable 
DESCRIPTION                     VARCHAR(100) Nullable 
AUTOM_RATE_CALC                 SMALLINT Nullable DEFAULT 0
IS_DELETED                      SMALLINT Not Null DEFAULT 0
ORGANIZATION_GROUP              INTEGER Nullable 
SEQUENCE                        INTEGER Not Null DEFAULT 0
CONSTRAINT FK_ORGANIZATION_ORG_GROUP:
  Foreign key (ORGANIZATION_GROUP)    References ORGANIZATION (SYSTEM_ID)
CONSTRAINT ORGANIZATION_PK:
  Primary key (SYSTEM_ID)
CONSTRAINT ORGANIZATION_UK:
  Unique key (ORGANIZATION_ID)

jdbc:firebirdsql://192.168.1.8/local/apps/firebird/dsvfms.fdb

jdbc:firebirdsql://127.0.0.1//home/eric/Devel/Dsvfms/dsvfms.fdb

/ we oefenen	,


/ 1313	,

select organization_systemid
from PARTY 
where ORGANIZATION_SYSTEMID not in (
	select SYSTEM_ID 
	from ORGANIZATION) 
group by organization_systemid;
/=
select distinct organization_systemid
from PARTY 
where ORGANIZATION_SYSTEMID not in (
	select SYSTEM_ID 
	from ORGANIZATION) 

ORGANIZATION_SYSTEMID 
===================== 
                  300 
                  400 
                 3000 
                 3010 
                 3020 
                 3050 
                 3060 
                 3070 
                 3080 
                 3160 
                 3170 

/ 1313	.

/ Inderdaad	,

SQL>  select count(*) from organization where system_id=300;

       COUNT 
============ 
           0 
 

/ 1313	. 

select organization_systemid,count(organization_systemid)
from PARTY 
where ORGANIZATION_SYSTEMID not in (
	select SYSTEM_ID 
	from ORGANIZATION) 
group by organization_systemid

ORGANIZATION_SYSTEMID        COUNT 
===================== ============ 
                  300            3 
                  400            1 
                 3000           23 
                 3010          271 
                 3020          108 
                 3050           30 
                 3060           42 
                 3070           28 
                 3080           12 
                 3160           10 
                 3170           12 

/ 1313	.

select organization_systemid, 'DO_NOT_USE_' || organization_systemid, 'Dummy organization to fix foreign key problem', 0,1,null
from PARTY 
where ORGANIZATION_SYSTEMID not in (
	select SYSTEM_ID 
	from ORGANIZATION) 
group by organization_systemid;

ORGANIZATION_SYSTEMID CONCATENATION          CONSTANT                                          CONSTANT     CONSTANT CONSTANT 
===================== ====================== ============================================= ============ ============ ======== 
                  300 DO_NOT_USE_300         Dummy organization to fix foreign key problem            0            1 <null>   
                  400 DO_NOT_USE_400         Dummy organization to fix foreign key problem            0            1 <null>   
                 3000 DO_NOT_USE_3000        Dummy organization to fix foreign key problem            0            1 <null>   
                 3010 DO_NOT_USE_3010        Dummy organization to fix foreign key problem            0            1 <null>   
                 3020 DO_NOT_USE_3020        Dummy organization to fix foreign key problem            0            1 <null>   
                 3050 DO_NOT_USE_3050        Dummy organization to fix foreign key problem            0            1 <null>   
                 3060 DO_NOT_USE_3060        Dummy organization to fix foreign key problem            0            1 <null>   
                 3070 DO_NOT_USE_3070        Dummy organization to fix foreign key problem            0            1 <null>   
                 3080 DO_NOT_USE_3080        Dummy organization to fix foreign key problem            0            1 <null>   
                 3160 DO_NOT_USE_3160        Dummy organization to fix foreign key problem            0            1 <null>   
                 3170 DO_NOT_USE_3170        Dummy organization to fix foreign key problem            0            1 <null>   

/ 1313	. 

SQL> show table sql_script;
There is no table SQL_SCRIPT in this database
SQL> show table  mpo_scs_patch;
SYSTEM_ID                       INTEGER Not Null 
ENTRY_DATE                      TIMESTAMP Not Null 
MODULE                          VARCHAR(128) Not Null 
NAME                            VARCHAR(128) Not Null 
SQL_SCRIPT                      BLOB segment 80, subtype TEXT Not Null 
STATUS                          VARCHAR(32) Not Null 
PATCH_COMMENT                   VARCHAR(255) Nullable 
CONSTRAINT PK_MPO_SCS_PATCHES:
  Primary key (MODULE, NAME)

/ Daarom ziet er het raar uit	,

SQL> select sql_script from mpo_scs_patch where name='patch-364-fix-party-org-fk.sql';

       SQL_SCRIPT 
================= 
         140:db69 
==============================================================================
SQL_SCRIPT:  
/* This patch fixes the missing foreign key on organization for parties */
insert into organization
select organization_systemid, 'DO_NOT_USE_' || organization_systemid, 'Dummy organization to fix foreign key problem', 0,1,null
from PARTY where ORGANIZATION_SYSTEMID not in (select SYSTEM_ID from ORGANIZATION) group by organization_systemid;

ALTER TABLE PARTY ADD CONSTRAINT PARTY_ORG_FK FOREIGN KEY (ORGANIZATION_SYSTEMID) REFERENCES ORGANIZATION (SYSTEM_ID);

/ TODO

/ 1313	. 

/ In source	,
$ vi base-framework/core/src/java/com/mpobjects/dbpatch/PatchStatus.java

    APPLIED,
    FAILED,
    MANUALLY_APPLIED,
    NOT_APPLIED,
    SKIPPED,
    UNKNOWN;


/ AD FIX patch-364-fix-party-org-fk.sql

/ organization heeft extra column sequance	,

SQL> show table organization;
SYSTEM_ID                       INTEGER Nullable 
ORGANIZATION_ID                 VARCHAR(20) Nullable 
DESCRIPTION                     VARCHAR(100) Nullable 
AUTOM_RATE_CALC                 SMALLINT Nullable DEFAULT 0
IS_DELETED                      SMALLINT Not Null DEFAULT 0
ORGANIZATION_GROUP              INTEGER Nullable 
SEQUENCE                        INTEGER Not Null DEFAULT 0
CONSTRAINT FK_ORGANIZATION_ORG_GROUP:
  Foreign key (ORGANIZATION_GROUP)    References ORGANIZATION (SYSTEM_ID)
CONSTRAINT ORGANIZATION_PK:
  Primary key (SYSTEM_ID)
CONSTRAINT ORGANIZATION_UK:
  Unique key (ORGANIZATION_ID)

SQL> select  sequence from organization group by sequence;

    SEQUENCE 
============ 
           0 

/ insert dus een extra column 0	, 

/ we doen	,

insert into organization
select organization_systemid, 'DO_NOT_USE_' || organization_systemid, 'Dummy organization to fix foreign key problem', 0,1,null,0
from PARTY 
where ORGANIZATION_SYSTEMID not in (
	select SYSTEM_ID 
	from ORGANIZATION)
group by organization_systemid;
commit;

ALTER TABLE PARTY ADD CONSTRAINT PARTY_ORG_FK FOREIGN KEY (ORGANIZATION_SYSTEMID) REFERENCES ORGANIZATION (SYSTEM_ID);
commit;
/ TODO



/ Einde AD FIX patch-364-fix-party-org-fk.sql

/ 1313	.

/ we oefenen	, voor commit	,

/ we hebben in laptop's ... x en xref table,	 

SQL> alter table xref drop constraint INTEG_20;
SQL> insert into xref values (4,13);
SQL> alter table xref add constraint fk_r foreign key(r) references x(i);
Statement failed, SQLSTATE = 40001
lock conflict on no wait transaction
-unsuccessful metadata update
-object XREF is in use
SQL>  commit;
SQL> alter table xref add constraint fk_r foreign key(r) references x(i);
/ OK

/ Einde PATCH-364-FIX-PARTY-ORG-FK.SQL

/ 7	. 

/ we doen opnieuw	,
jboss@mposerv11:/home/INTERNAL/eric/Downloads$ dsvfms start track

/ zoek in de server.log naar 'Executing patch'	,

$ less log/server.log
...
  9555 2015-10-14 12:59:13,506 INFO  [com.mpobjects.dbpatch.DataBasePatcher] (main:) Executing patch [oms/patch-389_productid_unique_constraint_d
   9555 rop.sql] ...
   9556 2015-10-14 12:59:13,538 ERROR [com.mpobjects.dbpatch.DataBasePatcher] (main:) Problem while executing SQL statement in patch [oms/patch-38
   9556 9_productid_unique_constraint_drop.sql]: 
   9557 2015-10-14 12:59:13,538 ERROR [com.mpobjects.dbpatch.DataBasePatcher] (main:) alter table product drop constraint PRODUCTID_UK
   9558 2015-10-14 12:59:13,538 ERROR [com.mpobjects.dbpatch.DataBasePatcher] (main:) org.firebirdsql.jdbc.FBSQLException: GDS Exception. 33554435
   9558 1. unsuccessful metadata update
   9559 CONSTRAINT PRODUCTID_UK does not exist.

/ PATCH-389_PRODUCTID_UNIQUE_CONSTRAINT_DROP.SQL

SQL>  select sql_script,status,name  from mpo_scs_patch where name like '%patch-389_produc%';

       SQL_SCRIPT STATUS                           NAME                                                                                                                             
================= ================================ =============================================================================== 
        140:140ab FAILED                           patch-389_productid_unique_constraint_drop.sql                                                                                   
==============================================================================
SQL_SCRIPT:  
alter table product drop constraint PRODUCTID_UK;

/ Waarom?

SQL> select name, sql_script,module from mpo_scs_patch where sql_script like '%PRODUCTID_UK%';

NAME                                                                                                                                    SQL_SCRIPT MODULE                                                                                                                           
=============================================================================== ================= =============================================================================== 
patch-253-product-uniqueproductid.sql                                                                                                     140:30c6 oms                                                                                                                              
==============================================================================
SQL_SCRIPT:  
--to apply unique constraint, Run the below delete query if there are any duplicate productids
--delete from product where productid in (SELECT PRODUCTID FROM product GROUP BY PRODUCTID HAVING COUNT(PRODUCTID) > 1);
ALTER TABLE PRODUCT ADD CONSTRAINT PRODUCTID_UK  UNIQUE (PRODUCTID);
==============================================================================
patch-012_productid_unique_constraint_drop.sql                                                                                            140:5644 dsvfms                                                                                                                           
==============================================================================
SQL_SCRIPT:  
alter table product drop constraint PRODUCTID_UK;
==============================================================================
patch-389_productid_unique_constraint_drop.sql                                                                                           140:140ab oms                                                                                                                              
==============================================================================
SQL_SCRIPT:  
alter table product drop constraint PRODUCTID_UK;
==============================================================================

/ Ook	, 

SQL>    select system_id,entry_date,module,name,status from mpo_scs_patch where name in ('patch-012_productid_unique_constraint_drop.sql','patch-253-product-uniqueproductid.sql','patch-389_productid_unique_constraint_drop.sql');

   SYSTEM_ID                ENTRY_DATE MODULE                                                                                                                           NAME                                                                                                                             STATUS                           
============ ========================= =============================================================================== =============================================================================== ================================ 
         291 2012-09-08 10:04:51.4960  oms                                                                                                                              patch-253-product-uniqueproductid.sql                                                                                            APPLIED                          
         465 2012-09-08 10:04:52.3810  dsvfms                                                                                                                           patch-012_productid_unique_constraint_drop.sql                                                                                   APPLIED                          
         782 2015-10-14 12:48:04.2870  oms                                                                                                                              patch-389_productid_unique_constraint_drop.sql                                                                                   FAILED       

/ Dus WH is eerst  patch-253 gedaan	, die de constraint add	, en dan patch-012, die de constraint rm	, 

/ en dan patch-389, die hem opnieuw wilt rm	, en dat gaat dan fout	,

SQL> update mpo_scs_patch set status='SKIPPED' where name='patch-389_productid_unique_constraint_drop.sql';
SQL> commit;


/ 13	.

/ Of in fs	,

[eric@localhost 2015.03]$ grep PRODUCTID_UK  $(find $(find -name patch) -name "*sql" )
./dsvfms/dsvfms/src/sql/patch/patch-012_productid_unique_constraint_drop.sql:alter table product drop constraint PRODUCTID_UK;
./module/oms/src/sql/patch/patch-253-product-uniqueproductid.sql:ALTER TABLE PRODUCT ADD CONSTRAINT PRODUCTID_UK  UNIQUE (PRODUCTID);
./module/oms/src/sql/patch/patch-389_productid_unique_constraint_drop.sql:alter table product drop constraint PRODUCTID_UK;
grep: ./module/oms/src/sql/patch/patch-281_Create: No such file or directory
grep: Document_Type.sql: No such file or directory

/ Geef in google	,
linux find how to escape spaces in filenames

/ NB	.

[eric@localhost 2015.03]$ vi module/oms/src/sql/patch/patch-281_Create\ Document_Type.sql 

/ Lees	,
http://askubuntu.com/questions/343727/filenames-with-spaces-breaking-for-loop-find-command

while read -rd $'\0' file; do
    something with "$file"
done < <(find  . -type f -name '*.*' -print0)

This should handle any filenames that are POSIX-compliant - see man find

   -print0
          True; print the full file name on the standard output, followed by a null character (instead of the newline character that  -print  uses).   This  allows  file
          names that contain newlines or other types of white space to be correctly interpreted by programs that process the find output.  This option corresponds to the
          -0 option of xargs.

/ TODO < <(...)

/ TODO -print0

/ Lees	,
http://superuser.com/questions/409818/how-do-i-parse-the-output-of-the-find-command-when-filenames-have-spaces-in-them

/ Lees	,
http://unix.stackexchange.com/questions/81349/how-do-i-use-find-when-the-filename-contains-spaces

You must combine find and xargs:
find . -type f -print0 | xargs -0 <command>

/ Inderdaad	,

[eric@localhost 2015.03]$ find $(find -name patch) -name "*sql" -print0 | xargs -0 grep PRODUCTID_UK
./dsvfms/dsvfms/src/sql/patch/patch-012_productid_unique_constraint_drop.sql:alter table product drop constraint PRODUCTID_UK;
./module/oms/src/sql/patch/patch-253-product-uniqueproductid.sql:ALTER TABLE PRODUCT ADD CONSTRAINT PRODUCTID_UK  UNIQUE (PRODUCTID);
./module/oms/src/sql/patch/patch-389_productid_unique_constraint_drop.sql:alter table product drop constraint PRODUCTID_UK;

/ Einde PATCH-389_PRODUCTID_UNIQUE_CONSTRAINT_DROP.SQL

/ 7	. 

jboss@mposerv11:/home/INTERNAL/eric/Downloads$ dsvfms start track
2015-10-14 14:03:25,588 INFO  [com.mpobjects.dbpatch.DataBasePatcher] (main:) Executing patch [oms/patch-390-customer-order-line-detail.sql] ...
2015-10-14 14:03:25,760 ERROR [com.mpobjects.dbpatch.DataBasePatcher] (main:) Problem while executing SQL statement in patch [oms/patch-390-custome
r-order-line-detail.sql]: 
2015-10-14 14:03:25,760 ERROR [com.mpobjects.dbpatch.DataBasePatcher] (main:) ALTER TABLE CUSTOMER_ORDER_LINE ADD CONSTRAINT CUSTOMER_ORDER_LINE_PK
 PRIMARY KEY (SYSTEM_ID)
2015-10-14 14:03:25,760 ERROR [com.mpobjects.dbpatch.DataBasePatcher] (main:) org.firebirdsql.jdbc.FBSQLException: GDS Exception. 335544351. unsucc
essful metadata update
STORE RDB$RELATION_CONSTRAINTS failed
null
null
action cancelled by trigger (3) to preserve data integrity
Attempt to define a second PRIMARY KEY for the same table

/ 7	. 

/ we hadden 	,
eric@mposerv8:~$ gbak -rep -user sysdba -password masterkey dsvfms.fdb_20151005-003448.fbk localhost://local/apps/firebird/dsvfms2.fdb

/ we connect ook met deze db server	,

[eric@localhost bin]$ cat dsvfms-db2-t.sh 
#!/bin/bash
isql-fb -u sysdba -p masterkey mposerv8:/local/apps/firebird/dsvfms2.fdb



/ PATCH-390-CUSTOMER-ORDER-LINE-DETAIL.SQL

/ De msg uit de log	staat ook in de row in de database	,

SQL>    select *from mpo_scs_patch where name in ('patch-390-customer-order-line-detail.sql');

   SYSTEM_ID                ENTRY_DATE MODULE                                                                                                                           NAME                                                                                                                                    SQL_SCRIPT STATUS                           PATCH_COMMENT                                                                                                                                                                                                                                                   
============ ========================= =============================================================================== =============================================================================== ================= ================================ =============================================================================== 
         783 2015-10-14 14:03:18.0470  oms                                                                                                                              patch-390-customer-order-line-detail.sql                                                                                                 140:17164 FAILED                           org.firebirdsql.jdbc.FBSQLException: GDS Exception. 335544351. unsuccessful metadata update
STORE RDB$RELATION_CONSTRAINTS failed
null
null
action cancelled by trigger (3) to preserve data integrity
Attempt to define a second PRIMARY KEY for the same      
==============================================================================
SQL_SCRIPT:  
CREATE TABLE CUSTOMER_ORDER_LINE_DETAIL
(
   ENTITY_SYSTEMID integer NOT NULL,
   EDT_SYSTEMID integer NOT NULL,
   FIELD_VALUE varchar(255),
   CONSTRAINT PK_CUSTOMER_ORDER_LINE_DETAIL PRIMARY KEY (ENTITY_SYSTEMID, EDT_SYSTEMID)
);

ALTER TABLE CUSTOMER_ORDER_LINE ADD CONSTRAINT CUSTOMER_ORDER_LINE_PK PRIMARY KEY (SYSTEM_ID);

ALTER TABLE CUSTOMER_ORDER_LINE_DETAIL ADD CONSTRAINT COLD_COL_FK FOREIGN KEY (ENTITY_SYSTEMID) REFERENCES CUSTOMER_ORDER_LINE (SYSTEM_ID);
ALTER TABLE CUSTOMER_ORDER_LINE_DETAIL ADD CONSTRAINT COLD_EDT_FK FOREIGN KEY (EDT_SYSTEMID) REFERENCES ENTITY_DETAIL_TYPE (SYSTEM_ID);
==============================================================================

/ we zien in de regulier row: 140:17164	, dit is de blog id	, 
/ de content staat eronder	,

/ 13	. 

/ we doen	,

SQL> select system_id,name, sql_script,module,status from mpo_scs_patch where sql_script like '%CUSTOMER_ORDER_LINE%PRIMARY KEY%';

   SYSTEM_ID NAME                                                                                                                                    SQL_SCRIPT MODULE                                                                                                                           STATUS                           
============ =============================================================================== ================= =============================================================================== ================================ 
         279 patch-244-customerorder.sql                                                                                                               140:2ee7 oms                                                                                                                              APPLIED                          
==============================================================================
SQL_SCRIPT:  
CREATE TABLE CUSTOMER_ORDER(SYSTEM_ID integer PRIMARY KEY NOT NULL,
CUSTOMER_ORDER_NUMBER varchar(100) UNIQUE NOT NULL,
SOLD_TO_PARTY_SYSTEMID INTEGER NOT NULL
);
ALTER TABLE CUSTOMER_ORDER ADD CONSTRAINT CO_PARTY_FK FOREIGN KEY (SOLD_TO_PARTY_SYSTEMID) REFERENCES PARTY(SYSTEM_ID);


CREATE TABLE CUSTOMER_ORDER_LINE (
SYSTEM_ID INTEGER PRIMARY KEY NOT NULL,
QUANTITY FLOAT,
BILL_TO_PARTY_SYSTEMID INTEGER,
FROM_PARTY_SYSTEMID INTEGER,
TO_PARTY_SYSTEMID INTEGER,
PRODUCT_SYSTEMID integer,
REQUESTED_START_AFTER TIMESTAMP,
REQUESTED_START_BEFORE TIMESTAMP,
REQUESTED_END_AFTER TIMESTAMP,
REQUESTED_END_BEFORE TIMESTAMP
);



==============================================================================
         461 patch-008_migration-fms-to-netapp.sql                                                                                                     140:5463 dsvfms                                                                                                                           APPLIED                          
==============================================================================
SQL_SCRIPT:  
/* Script to convert the current customer order data for FMS, which is stored in product items
Organization: 'DSV-NL-MDK'
*/
...
==============================================================================
         783 patch-390-customer-order-line-detail.sql                                                                                                 140:17164 oms                                                                                                                              FAILED                           
==============================================================================
SQL_SCRIPT:  
CREATE TABLE CUSTOMER_ORDER_LINE_DETAIL
(
   ENTITY_SYSTEMID integer NOT NULL,
   EDT_SYSTEMID integer NOT NULL,
   FIELD_VALUE varchar(255),
   CONSTRAINT PK_CUSTOMER_ORDER_LINE_DETAIL PRIMARY KEY (ENTITY_SYSTEMID, EDT_SYSTEMID)
);

ALTER TABLE CUSTOMER_ORDER_LINE ADD CONSTRAINT CUSTOMER_ORDER_LINE_PK PRIMARY KEY (SYSTEM_ID);

ALTER TABLE CUSTOMER_ORDER_LINE_DETAIL ADD CONSTRAINT COLD_COL_FK FOREIGN KEY (ENTITY_SYSTEMID) REFERENCES CUSTOMER_ORDER_LINE (SYSTEM_ID);
ALTER TABLE CUSTOMER_ORDER_LINE_DETAIL ADD CONSTRAINT COLD_EDT_FK FOREIGN KEY (EDT_SYSTEMID) REFERENCES ENTITY_DETAIL_TYPE (SYSTEM_ID);

/ 13	.

/ wat er fout gaat is dat er opnieuw een primary key wordt def op customer_order_line	, 
/ de customer_order_line_datail table is created	, 
/ we doen dus met de hand	,

drop table customer_order_line_detail;
/ Nu even, 

CREATE TABLE CUSTOMER_ORDER_LINE_DETAIL
(
   ENTITY_SYSTEMID integer NOT NULL,
   EDT_SYSTEMID integer NOT NULL,
   FIELD_VALUE varchar(255),
   CONSTRAINT PK_CUSTOMER_ORDER_LINE_DETAIL PRIMARY KEY (ENTITY_SYSTEMID, EDT_SYSTEMID)
);

ALTER TABLE CUSTOMER_ORDER_LINE_DETAIL 
ADD CONSTRAINT COLD_COL_FK FOREIGN KEY (ENTITY_SYSTEMID) REFERENCES CUSTOMER_ORDER_LINE (SYSTEM_ID);
ALTER TABLE CUSTOMER_ORDER_LINE_DETAIL 
ADD CONSTRAINT COLD_EDT_FK FOREIGN KEY (EDT_SYSTEMID) REFERENCES ENTITY_DETAIL_TYPE (SYSTEM_ID);

SQL> update  mpo_scs_patch set status='MANUALLY_APPLIED' where name='patch-390-customer-order-line-detail.sql';
SQL> commit;

/ Einde PATCH-390-CUSTOMER-ORDER-LINE-DETAIL.SQL

/ 7	. 

jboss@mposerv11:/home/INTERNAL/eric/Downloads$ dsvfms start track

2015-10-14 14:55:48,492 INFO  [com.mpobjects.dbpatch.DataBasePatcher] (main:) Executing patch [oms/patch-396-shi_shoid_uk.sql] ...
2015-10-14 14:55:48,558 ERROR [com.mpobjects.dbpatch.DataBasePatcher] (main:) Problem while executing SQL statement in patch [oms/patch-396-shi_sho
id_uk.sql]: 
2015-10-14 14:55:48,558 ERROR [com.mpobjects.dbpatch.DataBasePatcher] (main:) alter table SHIPMENT_ITEM
add constraint SHI_ID_SHO_UK
unique (SHIPMENT_ORDER_SYSTEMID, SHIPMENT_ITEM_ID)
2015-10-14 14:55:48,558 ERROR [com.mpobjects.dbpatch.DataBasePatcher] (main:) org.firebirdsql.jdbc.FBSQLException: GDS Exception. 335544349. attempt to store duplicate value (visible to active transactions) in unique index "SHI_ID_SHO_UK"
Reason: attempt to store duplicate value (visible to active transactions) in unique index "SHI_ID_SHO_UK"
2015-10-14 14:55:48,568 ERROR [com.mpobjects.dbpatch.DatabasePatchService] (main:) Error while patching database

/ PATCH-396-SHI_SHOID_UK.SQL

QL> select*from mpo_scs_patch where name='patch-396-shi_shoid_uk.sql';

   SYSTEM_ID                ENTRY_DATE MODULE                                                                                                                           NAME                                                                                                                                    SQL_SCRIPT STATUS                           PATCH_COMMENT                                                                                                                                                                                                                                                   
============ ========================= =============================================================================== =============================================================================== ================= ================================ =============================================================================== 
         798 2015-10-14 14:03:18.8020  oms                                                                                                                              patch-396-shi_shoid_uk.sql                                                                                                               140:14464 NOT_APPLIED                                                                                                                                                                                                                                                                                      
==============================================================================
SQL_SCRIPT:  
alter table SHIPMENT_ITEM
add constraint SHI_ID_SHO_UK
unique (SHIPMENT_ORDER_SYSTEMID, SHIPMENT_ITEM_ID);
==============================================================================

/ Dit is de 1ste patch bij SCS-4418

SQL> update mpo_scs_patch set status='SKIPPED'  where name='patch-396-shi_shoid_uk.sql';
SQL> commit;

/ Einde PATCH-396-SHI_SHOID_UK.SQL

/ 	7	.

jboss@mposerv11:/home/INTERNAL/eric/Downloads$ dsvfms start track

015-10-14 15:51:33,923 INFO  [com.mpobjects.dbpatch.DataBasePatcher] (main:) Executing patch [oms/patch-397-pi_shoid_uk.sql] ...
2015-10-14 15:51:36,428 ERROR [com.mpobjects.dbpatch.DataBasePatcher] (main:) Problem while executing SQL statement in patch [oms/patch-397-pi_shoi
d_uk.sql]: 
2015-10-14 15:51:36,428 ERROR [com.mpobjects.dbpatch.DataBasePatcher] (main:) alter table TMS_PRODUCT_ITEM
add constraint TPI_ID_SHO_UK
unique (SHIPMENT_ORDER_SYSTEMID, PRODUCT_ITEM_ID)
2015-10-14 15:51:36,428 ERROR [com.mpobjects.dbpatch.DataBasePatcher] (main:) org.firebirdsql.jdbc.FBSQLException: GDS Exception. 335544349. attemp
t to store duplicate value (visible to active transactions) in unique index "TPI_ID_SHO_UK"
Reason: attempt to store duplicate value (visible to active transactions) in unique index "TPI_ID_SHO_UK"

/ PATCH-397-PI_SHOID_UK.SQL 

/ Dit is de 2de patch bij SCS-4418

SQL> update mpo_scs_patch set status='SKIPPED'  where name='patch-397-pi_shoid_uk.sql';
SQL> commit;

/ Einde PATCH-397-PI_SHOID_UK.SQL 

/ 	7	.

jboss@mposerv11:/home/INTERNAL/eric/Downloads$ dsvfms start track

2015-10-14 16:09:37,757 INFO  [com.mpobjects.dbpatch.DataBasePatcher] (main:) Executing patch [oms/patch-411-create_resource_binary.sql] ...
2015-10-14 16:09:37,898 ERROR [com.mpobjects.dbpatch.DataBasePatcher] (main:) Problem while executing SQL statement in patch [oms/patch-411-create_
resource_binary.sql]: 
2015-10-14 16:09:37,898 ERROR [com.mpobjects.dbpatch.DataBasePatcher] (main:) ALTER TABLE RESOURCE_BINARY ADD CONSTRAINT FK_RB_R FOREIGN KEY(RESOUR
CE_SYSTEMID) REFERENCES CTP_RESOURCE(SYSTEM_ID)
2015-10-14 16:09:37,898 ERROR [com.mpobjects.dbpatch.DataBasePatcher] (main:) org.firebirdsql.jdbc.FBSQLException: GDS Exception. 335544351. unsucc
essful metadata update
Table CTP_RESOURCE not found
null
null

/ PATCH-411-CREATE_RESOURCE_BINARY.SQL

SQL> select*from mpo_scs_patch where name='patch-411-create_resource_binary.sql';

   SYSTEM_ID                ENTRY_DATE MODULE                                                                                                                           NAME                                                                                                                                    SQL_SCRIPT STATUS                           PATCH_COMMENT                                                                                                                                                                                                                                                   
============ ========================= =============================================================================== =============================================================================== ================= ================================ =============================================================================== 
         836 2015-10-14 15:54:57.2730  oms                                                                                                                              patch-411-create_resource_binary.sql                                                                                                     140:203b5 FAILED                           org.firebirdsql.jdbc.FBSQLException: GDS Exception. 335544351. unsuccessful metadata update
Table CTP_RESOURCE not found
null
null                                                                                                                              
==============================================================================
SQL_SCRIPT:  
CREATE TABLE RESOURCE_BINARY (
	RESOURCE_SYSTEMID INTEGER NOT NULL,
	BINARY_SYSTEMID INTEGER NOT NULL
);
ALTER TABLE RESOURCE_BINARY ADD CONSTRAINT FK_RB_R FOREIGN KEY(RESOURCE_SYSTEMID) REFERENCES CTP_RESOURCE(SYSTEM_ID);
ALTER TABLE RESOURCE_BINARY ADD CONSTRAINT FK_RB_B FOREIGN KEY(BINARY_SYSTEMID) REFERENCES OMS_BINARY(SYSTEM_ID);

==============================================================================

/ de table ctp_resource is er niet	,

[eric@localhost 2015.03]$ pwd
/home/eric/Devel/Java/Eclipse/eclipse-jee/workspace/2015.03

[eric@localhost 2015.03]$ find module/capabletopromise/ -name "*.sql" | xargs grep -i "create table" | grep -i ctp_resource
...
module/capabletopromise/src/sql/create-resource-db.sql:CREATE TABLE CTP_RESOURCE

[eric@localhost 2015.03]$ find module/capabletopromise/ -name "*.sql" | xargs grep -i "create table" | grep -i resource_type
module/capabletopromise/src/sql/create-resource_type-db.sql:CREATE TABLE "RESOURCE_TYPE" 

/ Dus geen patches	?
/ TODO

[eric@localhost 2015.03]$ less module/capabletopromise/src/sql/create-resource-db.sql
CREATE TABLE CTP_RESOURCE
(
   SYSTEM_ID integer NOT NULL,
   NAME varchar(50),
   DESCRIPTION varchar(100),
   ORGANIZATION_SYSTEMID integer,
   RESOURCE_TYPE_SYSTEMID integer,
   IS_DELETED SMALLINT DEFAULT 0,
   CONSTRAINT PK_RESOURCE PRIMARY KEY (SYSTEM_ID),
   CONSTRAINT RESOURCE_ORGANIZATION_FK FOREIGN KEY (ORGANIZATION_SYSTEMID) REFERENCES ORGANIZATION(SYSTEM_ID),
   CONSTRAINT RESOURCE_RESOURCETYPE_FK FOREIGN KEY (RESOURCE_TYPE_SYSTEMID) REFERENCES RESOURCE_TYPE(SYSTEM_ID),
   CONSTRAINT UNIQUE_ORANIZATION_RESOURCENAME UNIQUE (ORGANIZATION_SYSTEMID, NAME)
);
ALTER TABLE CTP_RESOURCE
ADD IS_UPDATED smallint;
...

[eric@localhost 2015.03]$ less module/capabletopromise/src/sql/create-resource_type-db.sql

CREATE TABLE "RESOURCE_TYPE" 
(
        "SYSTEM_ID"      INTEGER NOT NULL,
        "NAME"   VARCHAR(100) NOT NULL,
        "DESCRIPTION"    VARCHAR(255),
        "ORGANIZATION_SYSTEMID"  INTEGER NOT NULL,
        "SHORT_TERM_PERIOD"      INTEGER NOT NULL,
        "MEDIUM_TERM_PERIOD"     INTEGER NOT NULL,
        "LONG_TERM_PERIOD"       INTEGER NOT NULL,
        "IS_DELETED" SMALLINT DEFAULT 0, 
        CONSTRAINT PK_RESOURCE_TYPE PRIMARY KEY ("SYSTEM_ID")
);

/ we doen met de hand	,
CREATE TABLE "RESOURCE_TYPE" 
...
CREATE TABLE CTP_RESOURCE
/ en dan de patch-411	,

/ en dan	,
QL> update mpo_scs_patch set status='MANUALLY_APPLIED'  where name='patch-411-create_resource_binary.sql';
SQL> commit;

/ Einde PATCH-411-CREATE_RESOURCE_BINARY.SQL

/ 7	. 

jboss@mposerv11:/home/INTERNAL/eric/Downloads$ dsvfms start track

2015-10-14 17:19:19,751 INFO  [com.mpobjects.dbpatch.DataBasePatcher] (main:) Executing patch [oms/patch-422-soc-correction-type-remove.sql] ...
2015-10-14 17:19:19,801 ERROR [com.mpobjects.dbpatch.DataBasePatcher] (main:) Problem while executing SQL statement in patch [oms/patch-422-soc-cor
rection-type-remove.sql]: 
2015-10-14 17:19:19,801 ERROR [com.mpobjects.dbpatch.DataBasePatcher] (main:) 

alter table cost_component_specification drop correction_type_systemid
2015-10-14 17:19:19,801 ERROR [com.mpobjects.dbpatch.DataBasePatcher] (main:) org.firebirdsql.jdbc.FBSQLException: GDS Exception. 335544351. unsucc
essful metadata update
cannot delete
COLUMN SERVICE_ORDER_COST.CORRECTION_TYPE_SYSTEMID
there are 8 dependencies
Reason: unsuccessful metadata update
cannot delete
COLUMN SERVICE_ORDER_COST.CORRECTION_TYPE_SYSTEMID
there are 8 dependencies

/ PATCH-422-SOC-CORRECTION-TYPE-REMOVE.SQL

SQL> select*from mpo_scs_patch where name='patch-422-soc-correction-type-remove.sql'
CON> ;

   SYSTEM_ID                ENTRY_DATE MODULE                                                                                                                           NAME                                                                                                                                    SQL_SCRIPT STATUS                           PATCH_COMMENT                                                                                                                                                                                                                                                   
============ ========================= =============================================================================== =============================================================================== ================= ================================ =============================================================================== 
         851 2015-10-14 17:14:56.4840  oms                                                                                                                              patch-422-soc-correction-type-remove.sql                                                                                                 140:22b0b FAILED                           org.firebirdsql.jdbc.FBSQLException: GDS Exception. 335544351. unsuccessful metadata update
cannot delete
COLUMN SERVICE_ORDER_COST.CORRECTION_TYPE_SYSTEMID
there are 8 dependencies
Reason: unsuccessful metadata update
cannot delete
COLUMN SERVICE_OR      
==============================================================================
SQL_SCRIPT:  
alter table service_order_cost drop correction_type_systemid;

alter table cost_component_specification drop correction_type_systemid;

drop table correction_type;

==============================================================================


/ we doen met de hand	,

alter table service_order_cost drop correction_type_systemid;
-cannot delete
-COLUMN SERVICE_ORDER_COST.CORRECTION_TYPE_SYSTEMID
-there are 8 dependencies

alter table cost_component_specification drop correction_type_systemid;
/ OK

drop table correction_type;
-ERASE RDB$RELATION_CONSTRAINTS failed
-action cancelled by trigger (1) to preserve data integrity
-Cannot delete PRIMARY KEY being used in FOREIGN KEY definition.

RDB$DEPENDENCIES
RDB$RELATION_CONSTRAINTS                                                                      

SQL>  select * from RDB$DEPENDENCIES where rdb$field_name ='CORRECTION_TYPE_SYSTEMID';

RDB$DEPENDENT_NAME                                                                            RDB$DEPENDED_ON_NAME                                                                          RDB$FIELD_NAME                                                                                RDB$DEPENDENT_TYPE RDB$DEPENDED_ON_TYPE 
=============================================================================== =============================================================================== =============================================================================== ================== ==================== 
FREIGHT_DEL_COST_SHIPMENT                                                                     SERVICE_ORDER_COST                                                                            CORRECTION_TYPE_SYSTEMID                                                                                       1                    0 
FREIGHT_LIN_COST_SHIPMENT                                                                     SERVICE_ORDER_COST                                                                            CORRECTION_TYPE_SYSTEMID                                                                                       1                    0 
OTHER_DEL_COST_SHIPMENT                                                                       SERVICE_ORDER_COST                                                                            CORRECTION_TYPE_SYSTEMID                                                                                       1                    0 
OTHER_LIN_COST_SHIPMENT                                                                       SERVICE_ORDER_COST                                                                            CORRECTION_TYPE_SYSTEMID                                                                                       1                    0 
COSTS_PER_SHIPMENT                                                                            SERVICE_ORDER_COST                                                                            CORRECTION_TYPE_SYSTEMID                                                                                       1                    0 
COSTS_STATUS_PER_SHIPMENT                                                                     SERVICE_ORDER_COST                                                                            CORRECTION_TYPE_SYSTEMID                                                                                       1                    0 
FUEL_DEL_COST_SHIPMENT                                                                        SERVICE_ORDER_COST                                                                            CORRECTION_TYPE_SYSTEMID                                                                                       1                    0 
FUEL_LIN_COST_SHIPMENT                                                                        SERVICE_ORDER_COST                                                                            CORRECTION_TYPE_SYSTEMID                                                                                       1                    0 

/ Dit zijn views	,

/ Intermezzo

select RDB$VIEW_BLR,RDB$VIEW_SOURCE,RDB$RELATION_NAME
from rdb$relations;
select RDB$VIEW_BLR,RDB$RELATION_NAME
from rdb$relations;

select rdb$dependent_name from rdb$dependencies where rdb$field_name ='CORRECTION_TYPE_SYSTEMID';
RDB$DEPENDENT_NAME                                                                            
=============================================================================== 
COSTS_STATUS_PER_SHIPMENT                                                                     
FUEL_DEL_COST_SHIPMENT                                                                        
FUEL_LIN_COST_SHIPMENT                                                                        
FREIGHT_LIN_COST_SHIPMENT                                                                     
OTHER_DEL_COST_SHIPMENT                                                                       
OTHER_LIN_COST_SHIPMENT                                                                       
COSTS_PER_SHIPMENT                                                                            
FREIGHT_DEL_COST_SHIPMENT      

select SHIPMENT_ORDER_SYSTEMID, PRODUCT_ITEM_ID , count(product_item_id) from TMS_PRODUCT_ITEM group by SHIPMENT_ORDER_SYSTEMID, PRODUCT_ITEM_ID having count(product_item_id)>1;


/ Einde Intermezzo

/ we kunnen ook	,
[eric@localhost 2015.03]$ find -name "*patch-*sql" -print0 | xargs -0 grep --color=always FREIGHT_DEL_COST_SHIPMENT
...

/ 13	. 

./dsvfms/dsvfms/src/sql/patch/patch-024_modified_shipment_cost_views.sql:CREATE VIEW FREIGHT_DEL_COST_SHIPMENT (SHIPMENT_ORDER_SYSTEMID, STATUS, AMOUNT)

/ we zouden kunnen	, 

CREATE VIEW FREIGHT_DEL_COST_SHIPMENT (SHIPMENT_ORDER_SYSTEMID, STATUS, AMOUNT)
AS SELECT SOCP.SHIPMENT_ORDER_SYSTEMID, ... 										/ rm	,

/ dus 	,

DROP VIEW FREIGHT_DEL_COST_SHIPMENT;

CREATE VIEW FREIGHT_DEL_COST_SHIPMENT (SHIPMENT_ORDER_SYSTEMID, STATUS, AMOUNT)
AS SELECT SOCP.STATUS, SUM(CASE CT.NAME WHEN 'ADD' THEN SOCP.AMOUNT WHEN 'SUBTRACT' THEN (-1*SOCP.AMOUNT) ELSE 0 END)
FROM SHIPMENT_ORDER_COST_PART SOCP
JOIN SERVICE_ORDER_COST SOC ON SOC.SYSTEM_ID=SOCP.SERVICE_ORDER_COST_SYSTEMID
JOIN CORRECTION_TYPE CT ON SOC.CORRECTION_TYPE_SYSTEMID = CT.SYSTEM_ID
JOIN SERVICE_ORDER SO ON SO.SYSTEM_ID=SOC.SERVICE_ORDER_SYSTEMID
JOIN SERVICE_ORDER_TYPE SOT ON SO.SERVICE_ORDER_TYPE_SYSTEMID=SOT.SYSTEM_ID
WHERE SOCP.IS_DELETED = 0 AND SOC.COST_TYPE_SYSTEMID IN (SELECT SYSTEM_ID FROM RATE_COMPONENT_TYPE WHERE CODE='FREIGHT' AND RCT_GROUP='COST') AND SOT.SERVICE_ORDER_TYPE='DELIVERY' GROUP BY SOCP.SHIPMENT_ORDER_SYSTEMID, SOCP.STATUS;

GRANT DELETE, INSERT, REFERENCES, SELECT, UPDATE ON FREIGHT_DEL_COST_SHIPMENT TO  SYSDBA WITH GRANT OPTION;

/ Maar we doen het niet	, want reports hangen af van deze view 	,
/ TODO

/ we doen	,
SQL> update mpo_scs_patch set status='SKIPPED'  where name='patch-422-soc-correction-type-remove.sql';
SQL> commit;


/ Einde PATCH-422-SOC-CORRECTION-TYPE-REMOVE.SQL

/ 7	. 

jboss@mposerv11:/home/INTERNAL/eric/Downloads$ dsvfms start track

2015-10-15 11:48:40,841 ERROR [com.mpobjects.dbpatch.DataBasePatcher] (main:) Problem while executing SQL statement in patch [oms/patch-459-price_cost_translation_privileges$firebird.sql]: 
2015-10-15 11:48:40,841 ERROR [com.mpobjects.dbpatch.DataBasePatcher] (main:) INSERT INTO BUSINESS_OBJECT (SYSTEM_ID, NAME, DESCRIPTION, IS_DELETED) VALUES (GEN_ID(SYSID,1), 'price-type-translation', 'Pricetype Translation', 0)
2015-10-15 11:48:40,841 ERROR [com.mpobjects.dbpatch.DataBasePatcher] (main:) org.firebirdsql.jdbc.FBSQLException: GDS Exception. 335544665. violation of PRIMARY or UNIQUE KEY constraint "BUS_OBJ_UK" on table "BUSINESS_OBJECT"

/ PATCH-459-PRICE_COST_TRANSLATION_PRIVILEGES$FIREBIRD.SQL

/ we doen met de hand	,

/ 13	.

INSERT INTO BUSINESS_OBJECT (SYSTEM_ID, NAME, DESCRIPTION, IS_DELETED) VALUES (GEN_ID(SYSID,1), 'price-type-translation', 'Pricetype Translation', 0);
/ Skip, row is er al	,

/ 13	.

INSERT INTO BUSINESS_OBJECT (SYSTEM_ID, NAME, DESCRIPTION, IS_DELETED) VALUES (GEN_ID(SYSID,1), 'cost-type-translation', 'Costtype Translation', 0);
/ Doen we	, 

/ 13	.

INSERT INTO PRIVILEGE (SYSTEM_ID, BUSINESS_OBJECT_SYSTEMID, PRIVILEGE_TYPE_SYSTEMID, DESCRIPTION)
SELECT GEN_ID(SYSID,1), BO.SYSTEM_ID, PT.SYSTEM_ID, 'price-type-translation.list'
FROM BUSINESS_OBJECT BO, PRIVILEGE_TYPE PT
where BO.NAME = 'price-type-translation' AND
PT.NAME = 'list';
/ row is er al	, alleen met description null	, dus we doen deze NIET, 	maar in plaats daarvan een update	,

/ Intermezzo

SQL> SELECT GEN_ID(SYSID,1), BO.SYSTEM_ID, PT.SYSTEM_ID, 'price-type-translation.list'
CON> FROM BUSINESS_OBJECT BO, PRIVILEGE_TYPE PT
CON> where BO.NAME = 'price-type-translation' AND
CON> PT.NAME = 'list';

               GEN_ID    SYSTEM_ID    SYSTEM_ID CONSTANT                    
===================== ============ ============ =========================== 
              1085088     31633650            2 price-type-translation.list 

SQL> select*from privilege where BUSINESS_OBJECT_SYSTEMID=31633650;

   SYSTEM_ID BUSINESS_OBJECT_SYSTEMID PRIVILEGE_TYPE_SYSTEMID DESCRIPTION                                                                                                                                                                                              IS_DELETED 
============ ======================== ======================= =============================================================================== ========== 
    31633651                 31633650                       2 <null>                                                                                                                                                                                                            0 

update PRIVILEGE 
set description='price-type-translation.list' 
where BUSINESS_OBJECT_SYSTEMID=(
	select bo.system_id
	FROM BUSINESS_OBJECT BO
	where BO.NAME = 'price-type-translation') 
and PRIVILEGE_TYPE_SYSTEMID=( 
	select pt.system_id
	from PRIVILEGE_TYPE PT
	where PT.NAME = 'list') 
/ WE doen dus deze 	,

/ 13	. 

INSERT INTO PRIVILEGE (SYSTEM_ID, BUSINESS_OBJECT_SYSTEMID, PRIVILEGE_TYPE_SYSTEMID, DESCRIPTION)
SELECT GEN_ID(SYSID,1), BO.SYSTEM_ID, PT.SYSTEM_ID, 'cost-type-translation.list'
FROM BUSINESS_OBJECT BO, PRIVILEGE_TYPE PT
where BO.NAME = 'cost-type-translation' AND
PT.NAME = 'list';
/ doen 	, zoals het er staat	,	

/ 13	. 

SET TERM ^ ;
CREATE PROCEDURE COST_PRICE_PRIVILEGES
AS
DECLARE VARIABLE TMP integer;
begin
    FOR 
	select role_systemid 
	from role_privilege 
	where privilege_systemid = (
		select system_id 
		from privilege
		where business_object_systemid=(
			select system_id 
			from business_object 
			where name='financial-party')
		and privilege_type_systemid=(
			select system_id 
			from privilege_type 
		where name='list'))

	INTO :TMP DO
  	BEGIN

/*
    	INSERT INTO ROLE_PRIVILEGE (ROLE_SYSTEMID,PRIVILEGE_SYSTEMID)  values (:TMP ,
 			(select p.system_id 
			from privilege p , business_object bo , privilege_type pt
 			where bo.name='price-type-translation' 
			and pt.name='list' 
			and p.business_object_systemid=bo.system_id 
			and p.privilege_type_systemid=pt.system_id) );
*/

 		INSERT INTO ROLE_PRIVILEGE (ROLE_SYSTEMID,PRIVILEGE_SYSTEMID)  values (:TMP ,
 			(select p.system_id from privilege p , business_object bo , privilege_type pt
 			where bo.name='cost-type-translation' 
			and pt.name='list' 
			and p.business_object_systemid=bo.system_id 
			and p.privilege_type_systemid=pt.system_id) );

  END
end^
SET TERM ; ^

/ we zullen zien dat de 1ste insert NIET moet	, want al de 4 roles 10103, 10100, 9808853, 10108 =supersuer, administrator, key user, finance hebben de privilege price-type-translation.list al	,
/ de 2de moet wel	,
/ See na dit Intermezzo	,

GRANT EXECUTE
 ON PROCEDURE COST_PRICE_PRIVILEGES TO  SYSDBA;
/ Gewoon, zoals het er staat	,

////////////////////////////////////
/ Dus de roles die privilege financial-party.list hebben moeten ook privlege price-type-translation.list en cost-type-translation.list krijgen	, 

EXECUTE PROCEDURE COST_PRICE_PRIVILEGES;


/ Intermezzo

/ 1313	. 

/ we doen de FOR select apart	,

/ welke roles hebben de privilege financial-party.list	? 

SQL> select role_systemid
CON>     from role_privilege
CON>     where privilege_systemid = (
CON>         select system_id
CON>         from privilege
CON>         where business_object_systemid=(
CON>             select system_id 
CON>             from business_object 
CON>             where name='financial-party')
CON>         and privilege_type_systemid=(
CON>             select system_id 
CON>             from privilege_type 
CON>         where name='list'));

ROLE_SYSTEMID 
============= 
        10103 
        10100 
      9808853 
        10108 

/ 1313	. 

			select p.system_id
         	from privilege p , business_object bo , privilege_type pt
            where bo.name='price-type-translation'
            and pt.name='list'
            and p.business_object_systemid=bo.system_id
            and p.privilege_type_systemid=pt.system_id; 

   SYSTEM_ID 
============ 
    31633651 

			select p.system_id 
			from privilege p , business_object bo , privilege_type pt
            where bo.name='cost-type-translation'
            and pt.name='list'
            and p.business_object_systemid=bo.system_id
            and p.privilege_type_systemid=pt.system_id

   SYSTEM_ID 
============ 
     1085090 

SQL> select*from role_privilege  where role_systemid=10103 and privilege_systemid in (31633651,1085090);

ROLE_SYSTEMID PRIVILEGE_SYSTEMID 
============= ================== 
        10103           31633651 

SQL> select*from role_privilege  where role_systemid=10100 and privilege_systemid in (31633651,1085090);

ROLE_SYSTEMID PRIVILEGE_SYSTEMID 
============= ================== 
        10100           31633651 

SQL> select*from role_privilege  where role_systemid=9808853 and privilege_systemid=31633651;

ROLE_SYSTEMID PRIVILEGE_SYSTEMID 
============= ================== 
      9808853           31633651 

SQL> select*from role_privilege  where role_systemid=10108 and privilege_systemid in (31633651,1085090);

ROLE_SYSTEMID PRIVILEGE_SYSTEMID 
============= ================== 
        10108           31633651 


/ Einde Intermezzo

/ Einde PATCH-459-PRICE_COST_TRANSLATION_PRIVILEGES$FIREBIRD.SQL

/ 7	.

jboss@mposerv11:/home/INTERNAL/eric/Downloads$ dsvfms start track

/ Intermezzo

/ we zien volgorde patches	,

015-10-15 16:03:49,603 INFO  [com.mpobjects.dbpatch.DataBasePatcher] (main:) Executing patch [oms/patch-519-sottypetriggerOnUnplan.sql] ...
2015-10-15 16:03:49,621 INFO  [com.mpobjects.dbpatch.DataBasePatcher] (main:) Executing patch [interfacing/patch-0002-ifacemsgtrace.sql] ...
...
2015-10-15 16:03:49,792 INFO  [com.mpobjects.dbpatch.DataBasePatcher] (main:) Executing patch [interfacing/patch-0005-idseq2$firebird.sql] ...
2015-10-15 16:03:51,519 INFO  [com.mpobjects.dbpatch.DataBasePatcher] (main:) Executing patch [inventory/patch-005-stock_transaction_type.sql] ...
...
2015-10-15 16:04:40,030 INFO  [com.mpobjects.dbpatch.DataBasePatcher] (main:) Executing patch [invoice/patch-061-invoice-header-status.sql] ...
/ we zien andere modules	, vandaar dat de nummertjes weer 'opnieuw beginnen'	,

/ Einde Intermezzo


2015-10-15 16:36:35,877 INFO  [com.mpobjects.dbpatch.DataBasePatcher] (main:) Executing patch [invoice/patch-061-invoice-header-status.sql] ...
2015-10-15 16:36:35,959 ERROR [com.mpobjects.dbpatch.DataBasePatcher] (main:) Problem while executing SQL statement in patch [invoice/patch-061-inv
oice-header-status.sql]: 
/ WH omdat ikzelf nog geen commit had gedaan	,

/ PATCH-061-INVOICE-HEADER-STATUS.SQL

/ WH gaat OK, deze fix is NIET nodig	,

/ alleen de laatste was niet gedaan	, 
/ we doen met de hand	,
SQL> DROP TABLE INVOICE_HEADER_STATUS;
SQL> commit;

SQL> update mpo_scs_patch set status='APPLIED' where name='patch-061-invoice-header-status.sql';
SQL> commit;

/ Einde PATCH-061-INVOICE-HEADER-STATUS.SQL


/ 7	.

jboss@mposerv11:/home/INTERNAL/eric/Downloads$ dsvfms start track


/ Einde PATCH-061-INVOICE-HEADER-STATUS.SQL


/ FIXES DSVFMS PATCHES ON TEST 

/ we hebben xwiki pagina create	,
https://system.mp-objects.com/xwiki/bin/view/Technology/Deployment+dsvfms+2015.03+to+test

/ Herinner ook	,
https://system.mp-objects.com/xwiki/bin/view/Technology/ReleaseTODOList

/ FIX patch-364-fix-party-org-fk.sql

/ Insert een aantal rijen in organization table	, zodat we een fk kunnen maken in de party table	, 
/ er zijn in party table rijen met organization_systemid , die geen system_id's zijn in de organization table	, 

insert into organization
select organization_systemid, 'DO_NOT_USE_' || organization_systemid, 'Dummy organization to fix foreign key problem', 0,1,null,0
from PARTY 
where ORGANIZATION_SYSTEMID not in (
	select SYSTEM_ID 
	from ORGANIZATION)
group by organization_systemid;
commit;

ALTER TABLE PARTY 
ADD CONSTRAINT PARTY_ORG_FK FOREIGN KEY (ORGANIZATION_SYSTEMID) REFERENCES ORGANIZATION (SYSTEM_ID);

SQL> update mpo_scs_patch set status='MANUALLY_APPLIED' where name='patch-364-fix-party-org-fk.sql';
SQL> commit;

/ Einde FIX patch-364-fix-party-org-fk.sql

/ FIX PATCH-389_PRODUCTID_UNIQUE_CONSTRAINT_DROP.SQL

SQL> update mpo_scs_patch set status='SKIPPED' where name='patch-389_productid_unique_constraint_drop.sql';
SQL> commit;

/ Einde FIX PATCH-389_PRODUCTID_UNIQUE_CONSTRAINT_DROP.SQL

/ FIX PATCH-390-CUSTOMER-ORDER-LINE-DETAIL.SQL

CREATE TABLE CUSTOMER_ORDER_LINE_DETAIL
(
   ENTITY_SYSTEMID integer NOT NULL,
   EDT_SYSTEMID integer NOT NULL,
   FIELD_VALUE varchar(255),
   CONSTRAINT PK_CUSTOMER_ORDER_LINE_DETAIL PRIMARY KEY (ENTITY_SYSTEMID, EDT_SYSTEMID)
);

ALTER TABLE CUSTOMER_ORDER_LINE_DETAIL 
ADD CONSTRAINT COLD_COL_FK FOREIGN KEY (ENTITY_SYSTEMID) REFERENCES CUSTOMER_ORDER_LINE (SYSTEM_ID);
ALTER TABLE CUSTOMER_ORDER_LINE_DETAIL 
ADD CONSTRAINT COLD_EDT_FK FOREIGN KEY (EDT_SYSTEMID) REFERENCES ENTITY_DETAIL_TYPE (SYSTEM_ID);

SQL> update  mpo_scs_patch set status='MANUALLY_APPLIED' where name='patch-390-customer-order-line-detail.sql';
SQL> commit;

/ Einde FIX PATCH-390-CUSTOMER-ORDER-LINE-DETAIL.SQL

/ FIX PATCH-396-SHI_SHOID_UK.SQL

/ Dit is de 1ste patch bij SCS-4418	,

SQL> update mpo_scs_patch set status='SKIPPED'  where name='patch-396-shi_shoid_uk.sql';
SQL> commit;

/ Einde FIX PATCH-396-SHI_SHOID_UK.SQL

/ FIX PATCH-397-PI_SHOID_UK.SQL 

/ Dit is de 2de patch bij SCS-4418

SQL> update mpo_scs_patch set status='SKIPPED'  where name='patch-397-pi_shoid_uk.sql';
SQL> commit;

/ Einde FIX PATCH-397-PI_SHOID_UK.SQL 

/ FIX PATCH-411-CREATE_RESOURCE_BINARY.SQL

[eric@localhost 2015.03]$ less module/capabletopromise/src/sql/create-resource_type-db.sql
CREATE TABLE "RESOURCE_TYPE" 
(
        "SYSTEM_ID"      INTEGER NOT NULL,
        "NAME"   VARCHAR(100) NOT NULL,
        "DESCRIPTION"    VARCHAR(255),
        "ORGANIZATION_SYSTEMID"  INTEGER NOT NULL,
        "SHORT_TERM_PERIOD"      INTEGER NOT NULL,
        "MEDIUM_TERM_PERIOD"     INTEGER NOT NULL,
        "LONG_TERM_PERIOD"       INTEGER NOT NULL,
        "IS_DELETED" SMALLINT DEFAULT 0, 
        CONSTRAINT PK_RESOURCE_TYPE PRIMARY KEY ("SYSTEM_ID")
);

[eric@localhost 2015.03]$ less module/capabletopromise/src/sql/create-resource-db.sql
CREATE TABLE CTP_RESOURCE
(
   SYSTEM_ID integer NOT NULL,
   NAME varchar(50),
   DESCRIPTION varchar(100),
   ORGANIZATION_SYSTEMID integer,
   RESOURCE_TYPE_SYSTEMID integer,
   IS_DELETED SMALLINT DEFAULT 0,
   CONSTRAINT PK_RESOURCE PRIMARY KEY (SYSTEM_ID),
   CONSTRAINT RESOURCE_ORGANIZATION_FK FOREIGN KEY (ORGANIZATION_SYSTEMID) REFERENCES ORGANIZATION(SYSTEM_ID),
   CONSTRAINT RESOURCE_RESOURCETYPE_FK FOREIGN KEY (RESOURCE_TYPE_SYSTEMID) REFERENCES RESOURCE_TYPE(SYSTEM_ID),
   CONSTRAINT UNIQUE_ORANIZATION_RESOURCENAME UNIQUE (ORGANIZATION_SYSTEMID, NAME)
);
ALTER TABLE CTP_RESOURCE
ADD IS_UPDATED smallint;

$ less ./module/oms/src/sql/patch/patch-411-create_resource_binary.sql
CREATE TABLE RESOURCE_BINARY (
	RESOURCE_SYSTEMID INTEGER NOT NULL,
	BINARY_SYSTEMID INTEGER NOT NULL
);
ALTER TABLE RESOURCE_BINARY ADD CONSTRAINT FK_RB_R FOREIGN KEY(RESOURCE_SYSTEMID) REFERENCES CTP_RESOURCE(SYSTEM_ID);
ALTER TABLE RESOURCE_BINARY ADD CONSTRAINT FK_RB_B FOREIGN KEY(BINARY_SYSTEMID) REFERENCES OMS_BINARY(SYSTEM_ID);

SQL> update mpo_scs_patch set status='MANUALLY_APPLIED'  where name='patch-411-create_resource_binary.sql';
SQL> commit;



/ Einde FIX PATCH-411-CREATE_RESOURCE_BINARY.SQL

/ FIX PATCH-422-SOC-CORRECTION-TYPE-REMOVE.SQL

SQL> update mpo_scs_patch set status='SKIPPED'  where name='patch-422-soc-correction-type-remove.sql';
SQL> commit;

/ Einde FIX PATCH-422-SOC-CORRECTION-TYPE-REMOVE.SQL

/ FIX PATCH-459-PRICE_COST_TRANSLATION_PRIVILEGES$FIREBIRD.SQL


INSERT INTO BUSINESS_OBJECT (SYSTEM_ID, NAME, DESCRIPTION, IS_DELETED) VALUES (GEN_ID(SYSID,1), 'cost-type-translation', 'Costtype Translation', 0);

update PRIVILEGE 
set description='price-type-translation.list' 
where BUSINESS_OBJECT_SYSTEMID=(
	select bo.system_id
	FROM BUSINESS_OBJECT BO
	where BO.NAME = 'price-type-translation') 
and PRIVILEGE_TYPE_SYSTEMID=( 
	select pt.system_id
	from PRIVILEGE_TYPE PT
	where PT.NAME = 'list') 

INSERT INTO PRIVILEGE (SYSTEM_ID, BUSINESS_OBJECT_SYSTEMID, PRIVILEGE_TYPE_SYSTEMID, DESCRIPTION)
SELECT GEN_ID(SYSID,1), BO.SYSTEM_ID, PT.SYSTEM_ID, 'cost-type-translation.list'
FROM BUSINESS_OBJECT BO, PRIVILEGE_TYPE PT
where BO.NAME = 'cost-type-translation' AND
PT.NAME = 'list';

/* give roles which have privileg financial-party.list also the privilege cost-type-translation.list */ 

SET TERM ^ ;
CREATE PROCEDURE COST_PRICE_PRIVILEGES
AS
DECLARE VARIABLE TMP integer;
begin
    FOR 
	select role_systemid 
	from role_privilege 
	where privilege_systemid = (
		select system_id 
		from privilege
		where business_object_systemid=(
			select system_id 
			from business_object 
			where name='financial-party')
		and privilege_type_systemid=(
			select system_id 
			from privilege_type 
		where name='list'))

	INTO :TMP DO
  	BEGIN

 		INSERT INTO ROLE_PRIVILEGE (ROLE_SYSTEMID,PRIVILEGE_SYSTEMID)  values (:TMP ,
 			(select p.system_id from privilege p , business_object bo , privilege_type pt
 			where bo.name='cost-type-translation' 
			and pt.name='list' 
			and p.business_object_systemid=bo.system_id 
			and p.privilege_type_systemid=pt.system_id) );

  END
end^
SET TERM ; ^

GRANT EXECUTE
 ON PROCEDURE COST_PRICE_PRIVILEGES TO  SYSDBA;

EXECUTE PROCEDURE COST_PRICE_PRIVILEGES;


update mpo_scs_patch set status='MANUALLY_APPLIED' where name='patch-459-price_cost_translation_privileges$firebird.sql';
commit;


/ Einde FIX PATCH-459-PRICE_COST_TRANSLATION_PRIVILEGES$FIREBIRD.SQL

/ PATCH-061-INVOICE-HEADER-STATUS.SQL

/ WH gaat OK, deze fix is NIET nodig	,

/ alleen de laatste was niet gedaan	, 
/ we doen met de hand	,
SQL> DROP TABLE INVOICE_HEADER_STATUS;
SQL> commit;

SQL> update mpo_scs_patch set status='APPLIED' where name='patch-061-invoice-header-status.sql';
SQL> commit;

/ Einde PATCH-061-INVOICE-HEADER-STATUS.SQL



/ Einde FIXES DSVFMS PATCHES ON TEST 



/ Einde DSVSOL-2716

/ MPO-199

/ 7	 . 

/ we maken een nieuw script	, 

[eric@localhost bin]$ cat mpo-ssh-p.sh 
#!/bin/bash
echo "h^Zgcyr&Q"
ssh "vanderveldene@scs-application-p.intermax.mp-objects.com"

[vanderveldene@scs-application-p mpo]$ pwd
/local/apps/jboss-4.0.5.GA/server/mpo
$ vi deploy/postgres-ds.xml
<datasources>
        <xa-datasource>
                <jndi-name>tmsdevDS</jndi-name>
                <track-connection-by-tx>true</track-connection-by-tx>
                <xa-datasource-class>org.postgresql.xa.PGXADataSource</xa-datasource-class>
                <xa-datasource-property name="ServerName">127.0.0.1</xa-datasource-property>
                <xa-datasource-property name="PortNumber">5432</xa-datasource-property>
                <xa-datasource-property name="DatabaseName">mpo</xa-datasource-property>
                <xa-datasource-property name="User">mpo</xa-datasource-property>
                <xa-datasource-property name="Password">zwnnCLP0YYVGCdbCDIOp7lS4JrAxEgj4</xa-datasource-property>


/ we hebbn ook 	,
[eric@localhost bin]$ cat mpo-db-p.sh 
PGPASSWORD=h^Zgcyr\&Q psql -U vanderveldene -h  scs-application-p.intermax.mp-objects.com mpo 
psql: FATAL:  password authentication failed for user "vanderveldene"

/ we doen dus met de hand	,
[eric@localhost bin]$ ./mpo-ssh-p.sh 
h^Zgcyr&Q
[vanderveldene@scs-application-p ~]$ psql -U mpo
[vanderveldene@scs-application-p ~]$ psql -U mpo
Password for user mpo: zwnnCLP0YYVGCdbCDIOp7lS4JrAxEgj4
mpo=> 
/ we zoeken 
djansen, Italia72
PDurr,admin123@MPO

/ we kunnen ook	, 

[eric@localhost bin]$ cat mpo-db-p.sh 
#!/usr/bin/bash
#PGPASSWORD=h^Zgcyr\&Q psql -U vanderveldene -h  scs-application-p.intermax.mp-objects.com mpo 
PGPASSWORD=mpopostgres@mpo psql -U mpopostgres -h  scs-application-p.intermax.mp-objects.com mpo 
[eric@localhost bin]$ mpo-db-p.sh 
mpo=# \du
                              List of roles
  Role name  |                   Attributes                   | Member of 
-------------+------------------------------------------------+-----------
 hendriksm   | Superuser, Create role, Create DB              | {}
 mpo         | Password valid until infinity                  | {}
 mpopostgres | Superuser, Create role, Create DB, Replication | {}
 postgres    | Superuser, Create role, Create DB, Replication | {}



/ 7	. 

/ Op production/acceptance	, 
planning, customer functions , order status	,
/ click filter op geen	, we krijgen ze allemaal	,
/ edit er een	, we zien de customer view	,

/ 7	. 

$ mpo-ssh-a.sh

/ we maken	,
[eric@localhost bin]$ cat mpo-db-a.sh 
PGPASSWORD=h^Zgcyr\&Q psql -U vanderveldene -h  database-a.intermax.mp-objects.com mpo 
[eric@localhost bin]$ mpo-db-a.sh 
psql: FATAL:  password authentication failed for user "vanderveldene"

/ we doen	,
[eric@localhost bin]$ cat mpo-db-a.sh 
#PGPASSWORD=h^Zgcyr\&Q psql -U vanderveldene -h  database-a.intermax.mp-objects.com mpo 
PGPASSWORD=mpopostgres@mpo psql -U mpopostgres -h  database-a.intermax.mp-objects.com mpo 
[eric@localhost bin]$ mpo-db-a.sh 
mpo=# \du
                               List of roles
   Role name   |                   Attributes                   | Member of 
---------------+------------------------------------------------+-----------
 hendriksm     | Superuser, Create role, Create DB              | {}
 mpo           | Password valid until infinity                  | {}
 mpopostgres   | Superuser, Replication                         | {}
 postgres      | Superuser, Create role, Create DB, Replication | {}
 vanderveldene | Password valid until infinity                  | {}

/ Ik sta er wel bij	,
/ TODO











/ Einde MPO-199


/ SQUIRREL

eric@localhost ~]$ cd Devel/Java/squirrel-sql-3.5.3/
[eric@localhost squirrel-sql-3.5.3]$ ./squirrel-sql.sh 
...

/ we zien links vertical 'Aliases'	, 
/ we edit met dsvfms-db-t	, 
url: jdbc:firebirdsql://192.168.1.8/local/apps/firebird/dsvfms.fdb

/ als we een aantal queries schrijven in edit window	,  select er een , 
/ bijv	, 
select sql_script from mpo_scs_patch where name='patch-364-fix-party-org-fk.sql';
/ en click run	button (icon = mannetje), 
/ we zien onderin 1 rij	, 
/ right click 'sql_script' column	, kies 'Make editable'	,
/ dubbelclick op de column	, de content is nu geel	, 
/ als we hebben edit,	 click dan 'update data'	, 

/ rechtsboven is ook 'toggle autocommit'	, default true	, als we click , dan verschijnen er commit/rollback buttons	,


/ Einde SQUIRREL

/ AWK

[eric@localhost bin]$ awk '1' ~/Downloads/server.log 
/ prints de hele file	, 1 is hier de conditie	, en {print} mag je weglaten	,

[eric@localhost bin]$ awk '/MUST_BE_REMOVED/ || /MISSING/{print}' ~/Downloads/server.log 
/ of	,
[eric@localhost bin]$ awk '/MUST_BE_REMOVED/ || /MISSING/' ~/Downloads/server.log 





/ Einde AWK

/ FIREBIRD PROCEDURES

/ 7	.

/ create tables script	,

[eric@localhost dsvfms]$ pwd
/home/eric/Devel/Firebird/scripts/dsvfms

$ cat ./create_sho_shi.sh
#!/usr/bin/bash

isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL

drop table shi;
drop table sho;
create table sho(sys_id int,sho_id varchar(32),primary key(sys_id));
create table shi(sys_id int,sho_sysid int, shi_id varchar(32),primary key(sys_id),foreign key(sho_sysid)references sho(sys_id));

insert into sho values(11,11);
insert into sho values(12,12);
insert into sho values(13,13);
insert into shi values(1,11,1);
insert into shi values(2,11,1);
insert into shi values(3,11,1);
insert into shi values(4,12,2);
insert into shi values(5,12,2);
insert into shi values(6,12,2);
insert into shi values(7,12,2);
insert into shi values(8,12,3);
insert into shi values(9,12,3);
insert into shi values(10,13,4);
commit;
SQL

/ Als we in een ander window interactive	,
[eric@localhost Firebird]$ isql-fb -user sysdba -password masterkey first.fdb 
SQL> select*from shi;
/ dan ERR create_tables.sh
/ we moeten eerst	,
SQL> rollback/commit;

/ Dus	, 
[eric@localhost Firebird]$ isql-fb -user sysdba -password masterkey first.fdb 
SQL> select*from shi;
SQL> rollback/commit;
/ Dan in een ander window,	
[eric@localhost dsvfms]$ ./create_tables.sh 

/ 7	. 

/ update shi_id's

[eric@localhost dsvfms]$ pwd
/home/eric/Devel/Firebird/scripts/dsvfms

[eric@localhost dsvfms]$ cat update_shis.sh 
#!/usr/bin/bash
isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL

update shi
set shi_id=0
where sho_sysid=12;
update shi
set shi_id=cast((select max(cast(shi_id as int))from shi where sho_sysid=12)as integer)+1
where sho_sysid=12;
commit;
SQL

/ comment in isql-fb scripts gaat met /* ... */

//////////////////////
/ als we in een ander window een interactive isql-fb hebben , moeten we eerst een rollback/commit doen, anders zien we niet het result van update_shis.sh	,


/ 7	 

/ Lees	,
http://www.firebirdfaq.org/faq78/

SQL> set term ^;

SQL> create table t(i int)^
SQL> show table t^
I                               INTEGER Nullable 
SQL> create procedure p1
CON> as
CON> begin
CON> insert into t values(7);
CON> end^
SQL>  set term ;^
SQL> execute procedure p1;
SQL> select*from t;

           I 
============ 
           7 

set term ^;
create procedure p2
as
declare i integer;
begin
select*from sho into :i;
end^
set term ;^
/ TODO



/ 7	. 

SQL> select * from shi^

      SYS_ID    SHO_SYSID SHI_ID                           
============ ============ ================================ 
           1           11 1                                
           2           11 2                                
           3           11 3                                
           4           12 5                                
           5           12 6                                
           6           12 7                                
           7           12 8           

SQL> select count(distinct sho_sysid) from shi^

       COUNT 
============ 
           2 

/ 7	. 

/ fct met arg	,

[eric@localhost dsvfms]$ pwd
/home/eric/Devel/Firebird/scripts/dsvfms

[eric@localhost dsvfms]$ cat def_p2.sh 
#!/usr/bin/bash
isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL

drop procedure p2;
set term ^;
create procedure p2(a int)
as
begin
insert into t values(:a);
end^
set term ;^
commit;
SQL


calhost dsvfms]$ cat exec_p2.sh 
#!/usr/bin/bash
isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL

execute procedure p2(13);
commit;
SQL

[eric@localhost dsvfms]$ ./def_p2.sh 
/ zo vaak je wilt	,
[eric@localhost dsvfms]$ ./exec_p2.sh 
/ zo vaak je wilt	,

/ 3	. 

/ Met return value	,

[eric@localhost dsvfms]$ cat def_p3.sh 
#!/usr/bin/bash
isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL

drop procedure p3;
set term ^;
create procedure p3(a int)
returns(b int)
as
begin
insert into t values(:a);
select first 1 i from t into :b;
end^
set term ;^
commit;
SQL

[eric@localhost dsvfms]$ cat exec_p3.sh 
#!/usr/bin/bash
isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL

execute procedure p3(13) ;
commit;
SQL

$ ./def_p3.sh
[eric@localhost dsvfms]$ ./exec_p3.sh 

           B 
============ 
           7 

/ 7	. 


/ execute procedure ... returning_values ...

/ Geef in google	,
firebird loop over result set

/ Lees	,
http://www.firebirdsql.org/refdocs/langrefupd25-psql-forselect.html

/ 7	. 

$ cat def_p4.sh

#!/usr/bin/bash
isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL

create procedure p4 as begin end;
drop procedure p4;
set term ^;

create procedure p4
as
declare a int;
begin
for select i from t into :a do
    begin
    insert into t2 values(:a);
    end
end^

set term ;^
commit;
SQL

$ cat exec_p4.sh

#!/usr/bin/bash
isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL
execute procedure p4;
commit;
SQL

[eric@localhost dsvfms]$ ./def_p4.sh 
[eric@localhost dsvfms]$ ./exec_p4.sh 

/ In interactive isql-fb	,

SQL> select*from t2;

           I 
============ 
           7 
          13 
          13 
          13 
          13 
          13 
          13 
          13 
          13 

/ 7	. 

/ sho , shi	,

$ cat def_p4a.sh

#!/usr/bin/bash
isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL

create procedure p4a as begin end;
drop procedure p4a;
set term ^;

create procedure p4a
as
declare a int;
begin
update shi set sho_sysid=0;
for select distinct sho_sysid from shi into :a do
    begin
    update shi 
    set shi_id=cast((select max(cast(shi_id as int))from shi where sho_sysid=:a)as int)+1
    where sho_sysid=:a;
    end
end^

set term ;^
commit;
SQL

[eric@localhost dsvfms]$ cat exec_p4a.sh 
#!/usr/bin/bash
isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL

execute procedure p4a;
commit;
SQL

$ ./def_p4a.sh

$ ./exec_p4a.sh

SQL> rollback;
SQL> select*from shi;

      SYS_ID    SHO_SYSID SHI_ID                           
============ ============ ================================ 
           1           11 1                                
           2           11 2                                
           3           11 3                                
           4           12 1                                
           5           12 2                                
           6           12 3                                
           7           12 4                                
           8           12 5                                
           9           12 6                                
          10           13 1               

/ 	7	. 

/ Door ./def_p4a.sh onstaat er een dep op shi.sho_sysid	,

SQL> select*from RDB$DEPENDENCIES;

RDB$DEPENDENT_NAME                                                                            RDB$DEPENDED_ON_NAME                                                                          RDB$FIELD_NAME                                                                                RDB$DEPENDENT_TYPE RDB$DEPENDED_ON_TYPE 
=============================================================================== =============================================================================== =============================================================================== ================== ==================== 
P4A                                                                                           SHI                                                                                           SHI_ID                                                                                                         5                    0 
P4A                                                                                           SHI                                                                                           SHO_SYSID                                                                                                      5                    0 
P4                                                                                            T2                                                                                            I                                                                                                              5                    0 
P4                                                                                            T2                                                                                            <null>                                                                                                         5                    0 
P4                                                                                            T                                                                                             I                                                                                                              5                    0 
P4                                                                                            T                                                                                             <null>                                                                                                         5                    0 
P4A                                                                                           SHI                                                                                           <null>                                                                                                         5                    0 
P1                                                                                            T                                                                                             I                                                                                                              5                    0 
P1                                                                                            T                                                                                             <null>                                                                                                         5                    0 
P2                                                                                            T                                                                                             I                                                                                                              5                    0 
P2                                                                                            T                                                                                             <null>                                                                                                         5                    0 
P3                                                                                            T                                                                                             I                                                                                                              5                    0 
P3                                                                                            T                                                                                             <null>                                                                                                         5                    0 

/ Als we shi willen drop , moeten we eerst p4a drop! 
/ TODO

SQL> select*from RDB$RELATION_CONSTRAINTS;

RDB$CONSTRAINT_NAME                                                                           RDB$CONSTRAINT_TYPE RDB$RELATION_NAME                                                                             RDB$DEFERRABLE RDB$INITIALLY_DEFERRED RDB$INDEX_NAME                                                                                
=============================================================================== =================== =============================================================================== ============== ====================== =============================================================================== 
INTEG_1                                                                                       NOT NULL            YI                                                                                            NO             NO                     <null>                                                                                        
INTEG_2                                                                                       PRIMARY KEY         YI                                                                                            NO             NO                     RDB$PRIMARY1                                                                                  
INTEG_20                                                                                      FOREIGN KEY         XREF                                                                                          NO             NO                     RDB$FOREIGN15                                                                                 
INTEG_17                                                                                      PRIMARY KEY         X                                                                                             NO             NO                     RDB$PRIMARY12                                                                                 
INTEG_18                                                                                      PRIMARY KEY         XREF                                                                                          NO             NO                     RDB$PRIMARY13                                                                                 
INTEG_77                                                                                      NOT NULL            SHI_CP                                                                                        NO             NO                     <null>                                                                                        
INTEG_65_CP                                                                                   FOREIGN KEY         SHI_CP                                                                                        NO             NO                     INTEG_65_CP                                                                                   
INTEG_64_CP                                                                                   PRIMARY KEY         SHI_CP                                                                                        NO             NO                     INTEG_64_CP                                                                                   
INTEG_63                                                                                      PRIMARY KEY         SHO                                                                                           NO             NO                     RDB$PRIMARY58                                                                                 

/ Ook	, 
/ TODO

/ Verschil rdb$dependencies en rdb$relation_constraints
/ TODO


/ 7	.

/ copy table 	,

SQL> show table shi;
SYS_ID                          INTEGER Not Null 
SHO_SYSID                       INTEGER Nullable 
SHI_ID                          VARCHAR(32) Nullable 
CONSTRAINT INTEG_65:
  Foreign key (SHO_SYSID)    References SHO (SYS_ID)
CONSTRAINT INTEG_64:

/ we oef in interactive isql-fb	,

create table shi_cp(
SYS_ID                          INTEGER Not Null, 
SHO_SYSID                       INTEGER,  
SHI_ID                          VARCHAR(32), 
CONSTRAINT INTEG_65_cp
  Foreign key (SHO_SYSID)    References SHO (SYS_ID),
CONSTRAINT INTEG_64_cp
  Primary key (SYS_ID)
)

/ nu in scripts	,

[eric@localhost dsvfms]$ cat def_shi_cp.sh 
#!/usr/bin/bash
isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL

/*
drop procedure p4b;
*/
drop table shi_cp;
create table shi_cp(
SYS_ID                          INTEGER Not Null,
SHO_SYSID                       INTEGER,
SHI_ID                          VARCHAR(32),
CONSTRAINT INTEG_65_cp
  Foreign key (SHO_SYSID)    References SHO (SYS_ID),
CONSTRAINT INTEG_64_cp
  Primary key (SYS_ID)
);

commit;
SQL

[eric@localhost dsvfms]$ cat def_p4b.sh 
#!/usr/bin/bash
isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL

/*
drop procedure p4b;
*/
set term ^;
create procedure p4b as
declare sys_id int;
declare sho_sysid int;
declare shi_id varchar(32);
begin
	for select sys_id,sho_sysid,shi_id from shi into :sys_id,:sho_sysid,:shi_id do begin
 		insert into shi_cp values(:sys_id,:sho_sysid,:shi_id); 
	end
end^

set term ;^
commit;
SQL

[eric@localhost dsvfms]$ cat exec_p4b.sh 
#!/usr/bin/bash
isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL
execute procedure p4b;
commit;
SQL

/ In interactief isql-fb	, 
SQL> rollback;
SQL> select*from shi_cp;

      SYS_ID    SHO_SYSID SHI_ID                           
============ ============ ================================ 
           1           11 1                                
           2           11 1                                
           3           11 1                                
           4           12 2                                
           5           12 2                                
           6           12 2                                
           7           12 2                                
           8           12 3                                
           9           12 3                                
          10           13 4     

/ 7	. 

/ bestaat sho table?

[eric@localhost dsvfms]$ cat def_proc.sh 
#!/usr/bin/bash
isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL

drop procedure p_proc;
drop procedure p_proc2;
drop procedure p_proc3;
drop procedure p_proc4;

set term ^;

create procedure p_proc as 
begin
	insert into t values(7);
end^

create procedure p_proc2 returns(a int) as
begin
	select first 1 i from t into :a;
end^

create procedure p_proc3 returns(a int) as
begin
	select 1 from rdb\$relations where rdb\$relation_name = 'SHO' into :a;
end^

create procedure p_proc4 as
begin
    if(exists(select 1 from rdb\$relations where rdb\$relation_name = 'SHO')) then 
        insert into t values(6);
end^

set term ;^
commit;
SQL

[eric@localhost dsvfms]$ cat exec_proc.sh 
#!/usr/bin/bash
isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL

execute procedure p_proc;
execute procedure p_proc2;
execute procedure p_proc3;
execute procedure p_proc4;
select * from t;

commit;
SQL

[eric@localhost dsvfms]$ ./exec_proc.sh 

           A 
============ 
           7 


           A 
============ 
           1 

           I 
============ 
...
           7 
           6 
           7 
           6 
           7 
           6 
           7 
           6 

/ 7	. 

/ create table sho als er nog niet is	,

$ cat def_drops.h


#!/usr/bin/bash
isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL

drop procedure drop_if_exists_sho;
drop procedure drop_if_exists_shi;
drop procedure drop_if_exists_p4a;
drop procedure drop_if_exists_p4b;

set term ^;

create procedure drop_if_exists_sho as
begin
    if(exists(select 1 from rdb\$relations where rdb\$relation_name = 'SHO')) then 
      execute statement 'drop table sho';   
end^

create procedure drop_if_exists_shi as
begin
    if(exists(select 1 from rdb\$relations where rdb\$relation_name = 'SHI')) then 
        execute statement 'drop table shi';
end^

create procedure drop_if_exists_p4a as 
begin
    if(exists(select 1 from rdb\$procedures where rdb\$procedure_name = 'P4A')) then 
        execute statement 'drop procedure p4a';
end^

create procedure drop_if_exists_p4b as 
begin
    if(exists(select 1 from rdb\$procedures where rdb\$procedure_name = 'P4B')) then 
        execute statement 'drop procedure p4b';
end^

set term ;^
commit;
SQL

/////////////////////////////////
/ we kunnen	, 
    if(exists(select 1 from rdb\$relations where rdb\$relation_name = 'SHO')) then 
    	insert into t values(7);

/ maar NIET	,
    if(exists(select 1 from rdb\$relations where rdb\$relation_name = 'SHO')) then 
     	drop table sho;

/ we moeten WEL	,	
    if(exists(select 1 from rdb\$relations where rdb\$relation_name = 'SHO')) then 
     	execute statement 'drop table sho';
/ TODO

$ cat def_sho.sh

#!/usr/bin/bash
isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL

execute procedure drop_if_exists_sho;
commit;

create table sho(sys_id int,sho_id varchar(32),primary key(sys_id));

insert into sho values(11,11);
insert into sho values(12,12);
insert into sho values(13,13);

commit;
SQL

/ we moeten commit in	,
execute procedure drop_if_exists_sho;
commit;
create table sho(sys_id int,sho_id varchar(32),primary key(sys_id));
/ andere deadlock	,
/ TODO

[eric@localhost dsvfms]$ ./def_sho.sh 
[eric@localhost dsvfms]$ ./def_sho.sh 
/ OK


/ 7	.

/ create sho , shi if not exists	,

$ cat def_sho_shi.sh

#!/usr/bin/bash
isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL

execute procedure drop_if_exists_shi;
execute procedure drop_if_exists_sho;
commit;

create table sho(sys_id int,sho_id varchar(32),primary key(sys_id));
create table shi(sys_id int,sho_sysid int, shi_id varchar(32),primary key(sys_id),foreign key(sho_sysid)references sho(sys_id));

insert into sho values(11,11);
insert into sho values(12,12);
insert into sho values(13,13);
insert into shi values(1,11,1);
insert into shi values(2,11,1);
insert into shi values(3,11,1);
insert into shi values(4,12,2);
insert into shi values(5,12,2);
insert into shi values(6,12,2);
insert into shi values(7,12,2);
insert into shi values(8,12,3);
insert into shi values(9,12,3);
insert into shi values(10,13,4);
commit;
SQL


[eric@localhost dsvfms]$ ./def_sho_shi.sh 
[eric@localhost dsvfms]$ ./def_sho_shi.sh 
[eric@localhost dsvfms]$ ./def_sho_shi.sh 
[eric@localhost dsvfms]$ ./def_sho_shi.sh 
/ OK

/ 7	. 

/ create p4b	, die shi copies	,

/ we set voorlopig geen  fk op sho_sysid column in shi_cp	,

$ cat def_p4b.sh

#!/usr/bin/bash
isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL

execute procedure drop_if_exists_p4b;
commit;

set term ^;
create procedure p4b as
declare sys_id int;
declare sho_sysid int;
declare shi_id varchar(32);
begin
    for select sys_id,sho_sysid,shi_id from shi into :sys_id,:sho_sysid,:shi_id do begin
        insert into shi_cp values(:sys_id,:sho_sysid,:shi_id); 
    end
end^
set term ;^

commit;
SQL

$ cat def_shi_cp.sh

#!/usr/bin/bash
isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL

execute procedure drop_if_exists_p4b;
execute procedure drop_if_exists_shi_cp;
commit;

create table shi_cp(
SYS_ID                          INTEGER Not Null,
SHO_SYSID                       INTEGER,
SHI_ID                          VARCHAR(32),
/*CONSTRAINT INTEG_65_cp Foreign key (SHO_SYSID)  References SHO (SYS_ID)*/
CONSTRAINT INTEG_64_cp Primary key (SYS_ID)
);

commit;
SQL

/ we moeten p4b drop voordat we shi_cp drop & create	, want shi_cp.sys_id  heeft dep in p4b	, dus voor drop shi_cp moeten we eerst drop p4b	,

[eric@localhost dsvfms]$ ./def_shi_cp.sh 
[eric@localhost dsvfms]$ ./def_shi_cp.sh 
[eric@localhost dsvfms]$ ./def_p4b.sh 
[eric@localhost dsvfms]$ ./def_p4b.sh 
/ OK

[eric@localhost dsvfms]$ cat exec_p4b.sh
#!/usr/bin/bash
isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL

execute procedure p4b;
commit;
SQL

//////////////////////////////////////////////////////
[eric@localhost dsvfms]$ ./exec_p4b.sh 
[eric@localhost dsvfms]$ ./exec_p4b.sh 
Statement failed, SQLSTATE = 23000
violation of PRIMARY or UNIQUE KEY constraint "INTEG_64_CP" on table "SHI_CP"
-At procedure 'P4B' line: 7, col: 4
/ OK 
/ logisch
[eric@localhost dsvfms]$ ./def_shi_cp.sh 
[eric@localhost dsvfms]$ ./def_p4b.sh 
[eric@localhost dsvfms]$ ./exec_p4b.sh 
/ OK

/ we moeten p4b drop voordat we shi_cp drop & create	, want shi_cp.sys_id  heeft dep in p4b	, dus voor drop shi_cp moeten we eerst drop p4b	,
//////////////////////////////////////

/ HIER HIER HIER

/ 7	. 

[eric@localhost bin]$ cat local-db.sh 
#!/usr/bin/bash
isql-fb -user sysdba -password masterkey "$@"

[eric@localhost bin]$ local-db.sh /home/eric/Devel/Firebird/first.fdb
Database:  /home/eric/Devel/Firebird/first.fdb, User: sysdba


calhost bin]$ local-db.sh /home/eric/DB_TAP/Dsvfms/dsvfms.fdb_20151019-000019.fdb
Database:  /home/eric/DB_TAP/Dsvfms/dsvfms.fdb_20151019-000019.fdb, User: sysdba

/ we hebben	,
[eric@localhost Dsvfms]$ sudo cp -a dsvfms.fdb_20151019-000019.fdb dsvfms.fdb_20151019-000019_cp.fdb 

[eric@localhost bin]$ local-db.sh /home/eric/DB_TAP/Dsvfms/dsvfms.fdb_20151019-000019_cp.fdb
Database:  /home/eric/DB_TAP/Dsvfms/dsvfms.fdb_20151019-000019_cp.fdb, User: sysdba




/ 7	. 

//////////////////////////////////////////
/ Dit is de volgorde	,

[eric@localhost dsvfms]$ ./def_sho_shi.sh 
[eric@localhost dsvfms]$ ./def_p4a.sh 
[eric@localhost dsvfms]$ ./exec_p4a.sh 

#!/usr/bin/bash
isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL

execute procedure drop_if_exists_p4a;
execute procedure drop_if_exists_p4b;
execute procedure drop_if_exists_shi;
execute procedure drop_if_exists_sho;
commit;

create table sho(sys_id int,sho_id varchar(32),primary key(sys_id));
create table shi(sys_id int,sho_sysid int, shi_id varchar(32),primary key(sys_id),foreign key(sho_sysid)references sho(sys_id));

insert into sho values(11,11);
insert into sho values(12,12);
insert into sho values(13,13);
insert into shi values(1,11,1);
insert into shi values(2,11,1);
insert into shi values(3,11,1);
insert into shi values(4,12,2);
insert into shi values(5,12,2);
insert into shi values(6,12,2);
insert into shi values(7,12,2);
insert into shi values(8,12,3);
insert into shi values(9,12,3);
insert into shi values(10,13,4);
commit;
SQL

[eric@localhost dsvfms]$ cat def_p4a.sh 
#!/usr/bin/bash
isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL

execute procedure drop_if_exists_p4a;
commit;

set term ^;
create procedure p4a
as
declare a int;
begin
update shi set shi_id=0;
for select distinct sho_sysid from shi into :a do
	begin
 	update shi 
	set shi_id=cast((select max(cast(shi_id as int))from shi where sho_sysid=:a)as int)+1
	where sho_sysid=:a;
	end
end^

set term ;^
commit;
SQL

[eric@localhost dsvfms]$ cat exec_p4a.sh 
#!/usr/bin/bash
isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL
execute procedure p4a;
commit;
SQL

/ 7	. 

/ algemene conditional drop	,

$ cat def_drops2.sh

#!/usr/bin/bash
isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL

drop procedure drop_relation_if_exists;
drop procedure drop_procedure_if_exists;

set term ^;

create procedure drop_relation_if_exists(name varchar(32)) as 
begin
    if(exists(select 1 from rdb\$relations where rdb\$relation_name = :name)) then 
        execute statement 'drop table ' || name ;
end^

create procedure drop_procedure_if_exists(name varchar(32)) as 
begin
    if(exists(select 1 from rdb\$procedures where rdb\$procedure_name = :name)) then 
        execute statement 'drop procedure ' || name ;
end^

set term ;^
commit;
SQL

/ NB	,
    if(exists(select 1 from rdb\$relations where rdb\$relation_name = :name)) then 				/ :name NIET tussen ''	,
        execute statement 'drop table ' || name ;												/ GEEN 'drop table :name'	,

[eric@localhost dsvfms]$ pwd
/home/eric/Devel/Firebird/scripts/dsvfms
[eric@localhost dsvfms]$ ./def_drops2.sh 
[eric@localhost dsvfms]$ ./def_drops2.sh 
/ OK


$ cat def_sho2.sh

#!/usr/bin/bash
isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL

execute procedure drop_procedure_if_exists('P4A');
execute procedure drop_procedure_if_exists('P4B');
execute procedure drop_relation_if_exists('SHI');
execute procedure drop_relation_if_exists('SHO');
commit;

create table sho(sys_id int,sho_id varchar(32),primary key(sys_id));

insert into sho values(11,11);
insert into sho values(12,12);
insert into sho values(13,13);

commit;
SQL

/ SAMENVATTING

/ Een keer
[eric@localhost dsvfms]$ ./def_drops2.sh

/ HIER HIER HIER

/ Volgorde	
[eric@localhost dsvfms]$ ./def_sho_shi.sh 
[eric@localhost dsvfms]$ ./def_p4a.sh 
[eric@localhost dsvfms]$ ./exec_p4a.sh 

$ cat def_drop2.sh

#!/usr/bin/bash
isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL

drop procedure drop_relation_if_exists;
drop procedure drop_procedure_if_exists;

set term ^;

create procedure drop_relation_if_exists(name varchar(32)) as 
begin
	if(exists(select 1 from rdb\$relations where rdb\$relation_name = :name)) then 
		execute statement 'drop table ' || name ;
end^

create procedure drop_procedure_if_exists(name varchar(32)) as 
begin
	if(exists(select 1 from rdb\$procedures where rdb\$procedure_name = :name)) then 
		execute statement 'drop procedure ' || name ;
end^

set term ;^
commit;
SQL

[eric@localhost dsvfms]$ cat def_sho_shi.sh 
#!/usr/bin/bash
isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL

execute procedure drop_procedure_if_exists('P4A');
execute procedure drop_procedure_if_exists('P4B');
execute procedure drop_relation_if_exists('SHI');
execute procedure drop_relation_if_exists('SHO');
commit;

create table sho(sys_id int,sho_id varchar(32),primary key(sys_id));
create table shi(sys_id int,sho_sysid int, shi_id varchar(32),primary key(sys_id),foreign key(sho_sysid)references sho(sys_id));

insert into sho values(11,11);
insert into sho values(12,12);
insert into sho values(13,13);

insert into shi values(1,11,1);
insert into shi values(2,11,1);
insert into shi values(3,11,1);
insert into shi values(4,12,2);
insert into shi values(5,12,2);
insert into shi values(6,12,2);
insert into shi values(7,12,2);
insert into shi values(8,12,3);
insert into shi values(9,12,3);
insert into shi values(10,12,3);
insert into shi values(11,12,3);
insert into shi values(12,12,3);
insert into shi values(13,12,3);
insert into shi values(14,12,3);
insert into shi values(15,12,3);
insert into shi values(16,13,4);
commit;
SQL

[eric@localhost dsvfms]$ cat def_p4a.sh 
#!/usr/bin/bash
isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL

execute procedure drop_procedure_if_exists('P4A');
commit;

set term ^;
create procedure p4a
as
declare a int;
begin
update shi set shi_id=0;
for select distinct sho_sysid from shi into :a do
	begin
 	update shi 
    set shi_id=cast((select max(cast(shi_id as int))from shi where sho_sysid=:a)as int)+1
	where sho_sysid=:a;
	end
end^

set term ;^
commit;
SQL

$ cat exec_p4a.sh

#!/usr/bin/bash
isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL

execute procedure p4a;
commit;
SQL

/ doe	,
[eric@localhost local]$ ./def_sho_shi.sh 
[eric@localhost local]$ ./def_p4a.sh 
[eric@localhost local]$ ./exec_p4a.sh 

/ Einde SAMENVATTING

/ SAMENVATTING 

[eric@localhost dsvfms]$ pwd
/home/eric/Devel/Firebird/scripts/dsvfms

[eric@localhost dsvfms]$ ls
def_drops2.sh  def_rm_dups_fms.sh  exec_rm_dups_fms.sh

[eric@localhost dsvfms]$ cat def_drops2.sh 

#!/usr/bin/bash
isql-fb -user sysdba -password masterkey /home/eric/DB_TAP/Firebird/Dsvfms/dsvfms.fdb_20151019-000019.fdb <<SQL

drop procedure drop_relation_if_exists;
drop procedure drop_procedure_if_exists;

set term ^;

create procedure drop_relation_if_exists(name varchar(32)) as 
begin
	if(exists(select 1 from rdb\$relations where rdb\$relation_name = :name)) then 
		execute statement 'drop table ' || name ;
end^

create procedure drop_procedure_if_exists(name varchar(32)) as 
begin
	if(exists(select 1 from rdb\$procedures where rdb\$procedure_name = :name)) then 
		execute statement 'drop procedure ' || name ;
end^

set term ;^
commit;
SQL

[eric@localhost dsvfms]$ cat def_rm_dups_fms.sh 

#!/usr/bin/bash
isql-fb -user sysdba -password masterkey /home/eric/DB_TAP/Firebird/Dsvfms/dsvfms.fdb_20151019-000019.fdb <<SQL

execute procedure drop_procedure_if_exists('RM_SHIPMENT_ITEM_ID_DUPS');
commit;

set term ^;
create procedure rm_shipment_item_id_dups as
declare a int;
begin
	update shipment_item 
	set shipment_item_id=0;

	for select distinct shipment_order_systemid from shipment_item into :a do
	begin
 		update shipment_item 
		set shipment_item_id=cast((select max(cast(shipment_item_id as int))from shipment_item where shipment_order_systemid=:a)as int)+1
		where shipment_order_systemid=:a;
	end
end^

set term ;^
commit;
SQL

[eric@localhost dsvfms]$ cat exec_rm_dups_fms.sh 
#!/usr/bin/bash
isql-fb -user sysdba -password masterkey /home/eric/DB_TAP/Firebird/Dsvfms/dsvfms.fdb_20151019-000019.fdb <<SQL

execute procedure rm_shipment_item_id_dups;
commit;
SQL

SQL> select shipment_order_systemid, shipment_item_id,count(shipment_item_id) from shipment_item group by shipment_order_systemid, shipment_item_id having  count( shipment_order_systemid)>1;
/ GEEN	,

/ 7	. 

/ we hadden ook	,

[eric@localhost ]$ for f in $(find -maxdepth 1 -name "*.sh");do awk '{sub("\\.\\./\\.\\.","/home/eric/DB_TAP/Firebird/Local")}{print}' $f >tmp;mv tmp $f;done
/ en 	,
[eric@localhost dsvfms]$ for f in $(find -name "*.sh");do awk '{sub("000019_cp","000019")}{print}' $f >tmp;mv tmp $f;done

[eric@localhost ]$ chmod u+x $(find -name "*.sh")

SQL> select shipment_order_systemid, shipment_item_id,count(shipment_item_id) from shipment_item group by shipment_order_systemid, shipment_item_id having  count( shipment_order_systemid)>1;
...
/ Hele lijst	,

[eric@localhost dsvfms]$ ./def_drops2.sh 
Statement failed, SQLSTATE = 42000
unsuccessful metadata update
-Procedure DROP_RELATION_IF_EXISTS not found
[eric@localhost dsvfms]$ ./def_drops2.sh 
[eric@localhost dsvfms]$ ./def_drops2.sh 
[eric@localhost dsvfms]$ ./def_rm_dups_fms.sh 
[eric@localhost dsvfms]$ ./def_rm_dups_fms.sh 
[eric@localhost dsvfms]$ ./exec_rm_dups_fms.sh 

SQL> select shipment_order_systemid, shipment_item_id,count(shipment_item_id) from shipment_item group by shipment_order_systemid, shipment_item_id having  count( shipment_order_systemid)>1;
/ NIETS

/ Einde SAMENVATTING

/ SAMENVATTING 

/ product id's

SQL>  select  shipment_order_systemid,product_item_id,count(product_item_id) from tms_product_item group by shipment_order_systemid,product_item_id having count(product_item_id)>1;
...
/ hele lijst	,
...
SHIPMENT_ORDER_SYSTEMID PRODUCT_ITEM_ID                                                                         COUNT 
======================= =============================================================================== ============ 
               40071258 304475                                                                                      2 
               40137683 350043                                                                                      2 

/ HIER HIER HIER 



/ Einde SAMENVATTING


/ 7	. 

/ suspend

/ def_qt.sh / exec_qt.sh 
/ OK

/ def_rng.sh / exec_rng.sh 
/ TODO

/ def_qt2.sh / exec_qt2.sh 
/ OK

/ 13	. 

SQL> select*from t;

           I 
============ 
           1 
           2 
           3 
           4 
           5 
           6 
           7 


/ we proberen	, 

$ cat def_qt3.sh

#!/usr/bin/bash
isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL

execute procedure drop_procedure_if_exists('QT3');
commit;

set term ^;
create procedure qt3 returns(a int) as
begin
    select i from t into :a;
    suspend;
end^
set term ;^

commit;
SQL

$ cat exec_qt3.sh

#!/usr/bin/bash
isql-fb -user sysdba -password masterkey ../../first.fdb <<SQL

execute procedure qt3;
commit;
SQL

[eric@localhost dsvfms]$ ./def_qt3.sh 
[eric@localhost dsvfms]$ ./exec_qt3.sh 
Statement failed, SQLSTATE = 21000
multiple rows in singleton select
-At procedure 'QT3' line: 3, col: 2

/ Lees	,
http://stackoverflow.com/questions/9447114/why-doesnt-this-sql-run-firebird-stored-procedure

/ we veranderen	,

$ cat def_qt3.sh
...
create procedure qt3 returns(a int) as
begin
    for select i from t into :a do
    	suspend;
end^
...

[eric@localhost dsvfms]$ ./def_qt3.sh 
[eric@localhost dsvfms]$ ./exec_qt3.sh 

           A 
============ 
           1 
 
/ call	,
	select*from qt3
/ of	,
	select*from qt3()

/ Lees	, 
http://www.firebirdfaq.org/faq143/

/ 7	. 

/ dates

/  Lees	,
http://edn.embarcadero.com/article/28886

SQL> select current_time from rdb$database;

 CURRENT_TIME 
============= 
16:43:15.0000 





/ Einde FIREBIRD PROCEDURES

/ FIREBIRD PROCEDURES

/ 7	. 

/ select in een procedure	,

/ we kunnen niet gewoon select in een procedure, zoals we ook update doen	, 
/ we moeten for select ... into ...

/ Moet een select in een procedure	?


[eric@localhost local]$ pwd
/home/eric/Devel/Firebird/scripts/dsvfms/local

calhost local]$ cat def_chk_rm_dups_shi_fms.sh 
#!/usr/bin/bash
isql-fb -user sysdba -password masterkey /home/eric/DB_TAP/Firebird/Dsvfms/dsvfms.fdb_20151019-000019.fdb <<SQL

execute procedure drop_procedure_if_exists('CHECK_RM_SHIPMENT_ITEM_ID_DUPS');
commit;

set term ^;
create procedure check_rm_shipment_item_id_dups returns(sho_type varchar(30)) as
begin
	for select shipment_order_type 
	from shipment_order_type
	into :sho_type
	do
		suspend;
	end
end^

set term ;^
commit;
SQL

/ of overbodig 	,

create procedure check_rm_shipment_item_id_dups returns(sho_type varchar(30)) as
begin
	for select shipment_order_type 
	from shipment_order_type
	into :sho_type
	do
	begin
		sho_type=sho_type;
		suspend;
	end
end^

/ we zien 2 dingen	,
/ 13	.
/ we moeten varchar(30)	, 30 bijv	, NIET varchar 
create procedure check_rm_shipment_item_id_dups returns(sho_type varchar(30)) as

/ 13	. 
/ we moeten precies zo	, 
	end
end^

/ Doe nu	,
[eric@localhost local]$ ./def_chk_rm_dups_shi_fms.sh 

/ 7		.

/ Call	,
[eric@localhost dsvfms]$ local-db.sh /home/eric/DB_TAP/Firebird/Local/first.fdb
QL> show procedures;
Procedure Name                    Invalid Dependency, Type
================================= ======= =====================================
CHECK_RM_SHIPMENT_ITEM_ID_DUPS            SHIPMENT_ORDER_TYPE, Table

SQL> select * from CHECK_RM_SHIPMENT_ITEM_ID_DUPS;

SHO_TYPE                       
============================== 
GRP-TRUCK                      
INTEGRATOR                     
GRP                            
UPS                            
TNT                            
TEST       

/ NIET 	,
SQL> select * from CHECK_RM_SHIPMENT_ITEM_ID_DUPS();

/ 7	. 

/ we def de procedure die checks of er duplicates zijn	,

$ vi def_chk_rm_dups_shi_fms.sh

#!/usr/bin/bash
isql-fb -user sysdba -password masterkey /home/eric/DB_TAP/Firebird/Dsvfms/dsvfms.fdb_20151019-000019.fdb <<SQL

execute procedure drop_procedure_if_exists('CHECK_RM_SHIPMENT_ITEM_ID_DUPS');
commit;

set term ^;
create procedure check_rm_shipment_item_id_dups returns(sho_sysid int,shi_id varchar(80),count_ int) as
begin
    for select shipment_order_systemid, shipment_item_id, count(shipment_item_id)
    from shipment_item 
    group by shipment_order_systemid, shipment_item_id 
    having count(shipment_item_id)>1 
    into :sho_sysid,:shi_id,:count_
    do
        suspend;
end^

set term ;^
commit;
SQL

/ Doe	,
[eric@localhost local]$ ./def_chk_rm_dups_shi_fms.sh 


/ 13	. 

/ we def de exec script	,

[eric@localhost local]$ cat ./exec_chk_rm_dups_shi_fms.sh 
#!/usr/bin/bash
isql-fb -user sysdba -password masterkey /home/eric/DB_TAP/Firebird/Dsvfms/dsvfms.fdb_20151019-000019.fdb <<SQL

select*from check_rm_shipment_item_id_dups;
rollback;
SQL

/ Doe	,
[eric@localhost local]$ ./exec_chk_rm_dups_shi_fms.sh 

/ 7	. 

/ we doen de check niet in een procedure	,

[eric@localhost local]$ cat exec_chk_rm_dups_shi_fms_2.sh 
#!/usr/bin/bash
isql-fb -user sysdba -password masterkey /home/eric/DB_TAP/Firebird/Dsvfms/dsvfms.fdb_20151019-000019.fdb <<SQL

select shipment_order_systemid, shipment_item_id, count(shipment_item_id)
from shipment_item 
group by shipment_order_systemid, shipment_item_id 
having count(shipment_item_id)>1 ;

rollback;
SQL

[eric@localhost local]$ ./exec_chk_rm_dups_shi_fms_2.sh 
/ OK









/ Einde FIREBIRD PROCEDURES



/ FIREBIRD VIEWS

/ 7	. 

/ we kunnen NIET een view maken met 
select*	, 

SQL> create table x2(i int,primary key(i));
SQL> create table x2ref(i int ,r int not null,primary key(i),foreign key(r)references x2(i));
SQL> create view xview as
CON> select x2.i,r2.r from x2 join x2ref r2 on r2.r=x2.i
/ OK
SQL> select*from x2;

           I 
============ 
           7 

SQL> select*from x2ref;

           I            R 
============ ============ 
           1            7 
           2            7 

SQL>  select*from xview;

           I            R 
============ ============ 
           7            7 
           7            7 




/ Einde FIREBIRD VIEWS

/ POSTGRES FUNCTIONS

/ See 
LOG_8_sep_2014.txt


[eric@localhost Manual]$ pwd
/home/eric/Devel/Postgres/scripts/Manual

/ 7	. 

/ 1ste fct	,

/ een block begint altijd met declare	, niet met begin	, 
/ als er wat te declare valt	,   anders begint block wel met begin	,

/ 13	. 

/ zonder declare	,

$ cat 40.2_a.sql

create or replace function fct1() returns int as $$
begin
    return 30;
end
$$
language plpgsql;

/ geef in interactive psql	,
foo=> create or replace function fct1() returns int as $$
foo$> begin
foo$>     return 30;
foo$> end
foo$> $$
foo-> language plpgsql;
CREATE FUNCTION

/ en doe	,
foo=> select fct1();
 fct1 
------
   30
(1 row)

/ 13	. 

/ met declare	,

$ cat 40.2.sql
create or replace function fct1() returns int as $$
declare
    quantity int:=30;
begin
    raise notice 'quantity is %', quantity+13;
    quantity:=50;
    return quantity;
end
$$
language plpgsql;

/ we geven deze eerst direct in interactive psql	,

foo=> create or replace function fct1() returns int as $$
foo$> declare
foo$>     quantity int:=30;
foo$> begin
foo$>     raise notice 'quantity is %', quantity+13;
foo$>     quantity:=50;
foo$>     return quantity;
foo$> end
foo$> $$
foo-> language plpgsql;
CREATE FUNCTION
foo=> select fct1();
NOTICE:  quantity is 43
 fct1 
------
   50
(1 row)

///////////////////////////////////////////////////////////////
/ we zien dus de raise notice wordt exec	, als by-product	, maar dat het result van de query wordt gegeven door de return	,

/ 13	. 

/ drop a function	,

foo=> drop function if exists fct1;
ERROR:  syntax error at or near ";"
foo=> drop function if exists fct1();
DROP FUNCTION
/ we moeten () geven	, of als er een arg is , ook het type van het arg	,

/ 13	. 

/ we laten language plpgsql weg	,

foo=> create or replace function fct1() returns int as $$
foo$> declare
foo$>     quantity int:=30;
foo$> begin
foo$>     raise notice 'quantity is %', quantity; 
foo$>     quantity:=50;
foo$>     return quantity;
foo$> end;
foo$> $$
foo-> ;
ERROR:  no language specified

/ 13	. 

/ moeten $$ of language op een aparte line	? 
/ Nee	, 

create or replace function fct1() returns int as $$
declare
    quantity int:=30;
begin
    raise notice 'Quantity here is %', quantity; -- prints 30
    quantity:=50;
    return quantity;
end; $$ language plpgsql;

/ 13	. 

/ of geen ; achter laatste end	,

create or replace function fct1() returns int as $$
declare
    quantity int:=30;
begin
    raise notice 'Quantity here is %', quantity; -- prints 30
    quantity:=50;
    return quantity;
end; $$ language plpgsql;

/ 13	. 

/ de $$ moeten staan als boven	, hieronder is ERR	, vooraan	, en achteraan	 is ERR	,

create or replace function fct1() returns int $$ as
declare
    quantity int:=30;
begin
    raise notice 'quantity is %', quantity;
    quantity:=50;
    return quantity;
$$
end 
language plpgsql;

/ 7	. 

/ <<outerblock>>

$ cat 40.2_2.sql

create or replace function fct1() returns int as $$
<<outerblock>>
declare
    quantity int:=30;
begin
    raise notice 'quantity is %', quantity;
    quantity:=50;
    -- subblock
    declare
        quantity int:=80;
    begin
        raise notice 'quantity is %', quantity;
        raise notice 'quantity outer is %', outerblock.quantity;
    end;
    raise notice 'quantity is %', quantity;
    return quantity;
end;
$$
language plpgsql;

/ geef in interactive psql	,

foo=> create or replace function fct1() returns int as $$
foo$> <<outerblock>>
foo$> declare
foo$>     quantity int:=30;
foo$> begin
foo$>     raise notice 'quantity is %', quantity;
foo$>     quantity:=50;
foo$>     -- subblock
foo$>     declare
foo$>         quantity int:=80;
foo$>     begin
foo$>         raise notice 'quantity inner is %', quantity;
foo$>         raise notice 'quantity outer is %', outerblock.quantity;
foo$>     end;
foo$>     raise notice 'quantity is %', quantity;
foo$>     return quantity;
foo$> end;
foo$> $$
foo-> language plpgsql;
CREATE FUNCTION

foo=> select fct1();
NOTICE:  quantity is 30
NOTICE:  quantity inner is 80
NOTICE:  quantity outer is 50
NOTICE:  quantity is 50
 fct1 
------
   50
(1 row)

/ 13	. 

/ outer from function	,

/ we kunnen	,

$ vi 40.2_2.sql

create or replace function fct1() returns int as $$
<<outerblock>>
declare
    quantity int:=30;
begin
    raise notice 'quantity is %', quantity;
    raise notice 'outer FOUND is %', fct1.FOUND;
...
foo=> select fct1();
NOTICE:  quantity is 30
NOTICE:  outer FOUND is f
...

/ TODO

/ 7	.

/ Lees	,
http://www.w3resource.com/PostgreSQL/pl-pgsql-declarations.php

/ 13	. 

$ vi my_sum.sql

create or replace function my_sum(m int,n int) returns int as $$ begin
    return m+n;
end $$ language plpgsql;

foo=> select my_sum(5,3);
 my_sum 
--------
      8
(1 row)

/ alles op 1 regel kan ook	,

$ vi my_sum.sql
create or replace function my_sum(m int,n int) returns int as $$ begin return m+n; end $$ language plpgsql;

/ OK

/ 13	. 

/ 1313	,

/ we oef	,

foo=> select now();
              now              
-------------------------------
 2015-10-15 09:28:52.380419-04
(1 row)

foo=> select now()+interval '2 day';
           ?column?            
-------------------------------
 2015-10-17 09:29:26.997369-04
(1 row)

foo=> select now()+3*interval '2 day';
           ?column?            
-------------------------------
 2015-10-21 09:29:36.761914-04
(1 row)

/ 1313	.

foo=> \df now
                              List of functions
   Schema   | Name |     Result data type     | Argument data types |  Type  
------------+------+--------------------------+---------------------+--------
 pg_catalog | now  | timestamp with time zone |                     | normal
(1 row)

/ 1313	,

$ vi my_date.sql

create or replace function my_date(d date,m int) returns date as $$
declare
    d2 alias for d;
    m2 alias for m;
begin
    return d2+m2*interval '2 day';
end;
$$ language plpgsql;

foo=> select my_date(cast(now()as date),2);
  my_date   
------------
 2015-10-19
(1 row)

/ we moeten dus een cast doen	,

/ 1313	, 

/ we geven my_date een andere type	,

foo=> drop function my_date(date,int);
DROP FUNCTION

/ timestamp = timestamp without timezone	, dus we moeten	, 

$ vi my_date.sql

create or replace function my_date(d timestamp with time zone,m int) returns date as $$
declare
    d2 alias for d;
    m2 alias for m;
begin
    return d2+m2*interval '2 day';
end;
$$ language plpgsql;
 
foo=> select my_date(now(),2);
  my_date   
------------
 2015-10-19
(1 row)

/ 1313	. 

/ hij  returns een date	, 

/ we willen	,

foo=> create or replace function my_date(d timestamp with time zone,m int) returns timestamp with time zone as $$
foo$> declare
foo$>     d2 alias for d;
foo$>     m2 alias for m;
foo$> begin
foo$>     return d2+m2*interval '2 day';
foo$> end;
foo$> $$ language plpgsql;
ERROR:  cannot change return type of existing function
HINT:  Use DROP FUNCTION my_date(timestamp with time zone,integer) first.

/ dus we moeten	,
foo=> drop function my_date(timestamp with time zone , int);
DROP FUNCTION

foo=> create or replace function my_date(d timestamp with time zone,m int) returns timestamp with time zone as $$
foo$> declare
foo$>     d2 alias for d;
foo$>     m2 alias for m;
foo$> begin
foo$>     return d2+m2*interval '2 day';
foo$> end;
foo$> $$ language plpgsql;
CREATE FUNCTION

foo=> select my_date(now(),2);
            my_date            
-------------------------------
 2015-10-19 09:57:32.157911-04
(1 row)

/ 13	. 

/ %type	,

foo=> \d y
            Table "public.y"
 Column |       Type        | Modifiers 
--------+-------------------+-----------
 j      | integer           | 
 t      | character varying | 

foo=> delete from y;
DELETE 1
foo=> insert into y values (1,'Eric J.');
INSERT 0 1
foo=> insert into y values (2,'Foo');
INSERT 0 1

/ je kunt in het fct arg alleen de type schrijven	, en dan met alias $1 een var def	,

$ vi my_name.sql

create or replace function my_name(int) returns varchar as $$
declare
    j2 alias for $1;
    t2 y.t%type;
begin
    select into t2 t from y
    where j=j2;

    return j2 || ',' || t2;
end
$$ language plpgsql;

foo=> select my_name(1);
  my_name  
-----------
 1,Eric J.
(1 row)

foo=> select my_name(2);
 my_name 
---------
 2,Foo
(1 row)

/ Als we in de query hierboven de where clause rm	, 
    select into t2 t from y;
/ dan zien we altijd 'Eric J'	, 
/ Wat als multiple rows returned	?
/ TODO

/ 13	. 

/ %rowtype

$ vi my_row.sql

create or replace function my_row(int) returns varchar as $$
declare
    j2 alias for $1;
    y2 y%rowtype;
begin
    select into y2 *from y
    where y.j=j2;

    return j2 || ': ' || y2.j || ', ' || y2.t;
end
$$ language plpgsql;

foo=> select my_row(1);
    my_row     
---------------
 1: 1, Eric J.
(1 row)

foo=> select my_row(2);
  my_row   
-----------
 2: 2, Foo
(1 row)

/ 13	. 

/ autocommit off gaat met \set	, 
/ dit is WH client side, dus in psql	, in iedere psql apart	, 
/ als je wilt weten wat autocommit nu is	, doe je alleen \set	,

foo=> \set
AUTOCOMMIT = 'on'
PROMPT1 = '%/%R%# '
PROMPT2 = '%/%R%# '
PROMPT3 = '>> '
VERBOSITY = 'default'
VERSION = 'PostgreSQL 9.3.5 on x86_64-redhat-linux-gnu, compiled by gcc (GCC) 4.8.3 20140624 (Red Hat 4.8.3-1), 64-bit'
DBNAME = 'foo'
USER = 'foo'
PORT = '5432'
ENCODING = 'UTF8'
LASTOID = '0'

/ we zien dat autocommit op on staat	,

foo=> \set AUTOCOMMIT off
foo=> \set
AUTOCOMMIT = 'off'
...

foo=> \set AUTOCOMMIT on  
foo=> \set
AUTOCOMMIT = 'on'
...

/ 13	. 

/ we gaan verder met	,
http://www.w3resource.com/PostgreSQL/pl-pgsql-declarations.php

/ Lees	,
http://www.postgresql.org/docs/9.4/static/datatype.html

/ bool is een alias voor boolean	,

$ vi my_not_equal.sql

create or replace function my_not_equal(i int,j int)returns bool as $$
begin
    return i <> j;
end
$$ language plpgsql;

foo=> select my_not_equal(i,j)from z;
 my_not_equal 
--------------
 t
 f
 f
 t
 t
 t
 t
(7 rows)
 







/ Einde POSTGRES FUNCTIONS


/ PCT-756

/ Voor 
Exectution, Customer shipment order search	,

/ 13	. 

/ TODO

/ user 'VanBeek'	, 
/ we zagen niet de Execution menu 	, 
/ we moesten aan role R_KLANT een privilige add	: customer-order:list
/ Dan ziet VanBeek de Execution menu	, 

/ user eric heeft role Administrator	, deze heeft NIET privilege customer-order:list	, maar ziet toch Execution menu	, 
/ TODO

/ 13	. 

/ user eric	, 

/ Ga naar een shipment order, bill to party	, en onthoud de party_id , Bill to party op het scherm, heet ook code , '9148459'

/ Ga naar configuration, administration , user party	, 
/ we zien Parties, 
/ click add, zoek op deze party_id en add	, 
Save 
/ we hebben party added aan eric
pnllogistics3=# select*from party where party_id='9148459';
-[ RECORD 1 ]----------------+---------------------
system_id                    | 26683134
is_deleted                   | 0
party_id                     | 9148459
party_type_systemid          | 26681476
organization_systemid        | 500
name                         | Gildewerk B.V.
name2                        | 
address                      | Jan van Geunsweg 10A
address2                     | 
city                         | HAARLEM
zipcode                      | 2031BD
country_systemid             | 4153
contact_name                 | Maarten Theunissen
emailaddress                 |
faxnumber                    | 023-5340965
phonenumber                  | 023-5322255
 
/ eric kan dan op Execution, Customer shipment order search	,  alle sho zien waarvoor deze party de bill to party is	, 
/ TODO

/ Einde PCT-756

/ DEBUG PCT-756

/ 7		.

/ Execution, Customer shipment order search	,

$ vi CustomerOrderSearchPage.java

shipmentorder.reference1.pnllogistics.outbound
shipmentorder.requestedstartafter.pnllogistics.outbound

/ 13	. 

public abstract class AbstractShipmentOrderViewPanel extends Panel {
		add(new Label(aLabel.getId() + ".label", new AbstractReadOnlyModel<String>() {
			@Override
			public String getObject() {
->				return new StringResourceModel("shipmentorder." + aLabel.getId() + "." + baseProduct + "."
						+ model.getObject().getShipmentOrderProcess(), model).getObject();
aLabel.getIdI()="reference1"
this.this$0.baseProduct="pnllogistics"
model.getObject().getShipmentOrderProcess()="OUTBOUND"

/s
StringResourceModel(LoadableDetachableModel).getObject() line: 120	
			transientModelObject = load();
/s
StringResourceModel.load() line: 647	
		return getString();
/s
StringResourceModel.getString() line: 503	
			value = localizer.getString(getResourceKey(), component, model, defaultValue);
/s
Localizer.getString(String, Component, IModel<?>, String) line: 313	
		String value = getStringIgnoreSettings(key, component, model, null);
/s
Localizer.getStringIgnoreSettings(String, Component, IModel<?>, String) line: 241	
				value = loader.loadStringResource(component, key);
/s
LanguageManagerStringResourceLoader.loadStringResource(Component, String) line: 46	
aKey	"shipmentorder.reference1.pnllogistics.OUTBOUND" (id=26121)	
				return getLanguageManager().getTranslation(aKey, Session.get().getLocale(), Session.get().getStyle(), true);
/s
WicketLanguageManager.getTranslation(String, Locale, String, boolean) line: 22	
		return get(aKey, aLocale, aStyle, aThrowExceptionIfNotFound);
/s
WicketLanguageManager.get(String, Locale, String, boolean) line: 71	
		// lang_properties stored in lower case
		String myFullCode = aFullCode.toLowerCase();
myFullCode	"shipmentorder.reference1.pnllogistics.outbound" (id=26284)	
		String result = fetchTranslation(myFullCode, aLocale, aStyle);
/s
WicketLanguageManager.fetchTranslation(String, Locale, String) line: 54	
		Properties props = getPropertiesFile(aLocale);
		return props.getProperty(myFullCode, null);
/t
WicketLanguageManager.get(String, Locale, String, boolean) line: 73	
		String result = fetchTranslation(myFullCode, aLocale, aStyle);
/d
result	"Requested Productcode" (id=26350)	
			return result;



/ 13	. 

/ FIX PCT-756

public class ShoDetailViewPanel extends AbstractShipmentOrderViewPanel {

	private void addRequestedDate(final String aRequestedDate) {
		Label aLabel = new Label(aRequestedDate, new PropertyModel<String>(model, "dateSetVO." + aRequestedDate));
		add(aLabel);
		add(new Label(aRequestedDate + ".label", new AbstractReadOnlyModel<String>() {
			@Override
			public String getObject() {
				return new StringResourceModel("shipmentorder." + aRequestedDate + "." + baseProduct + "." + model.getObject().getShipmentOrderProcess(), model) .getObject(); /  (*)
/ aRequestedDate="requestedStartAfter"
/ baseProduct="pnllogistics"
/ model.getObject().getShipmentOrderProcess()="OUTBOUND"
//////////////////////////
/ Er stond .toString()	, het moet zijn .getObject()	 bij (*)

		Label priceLabel = new Label("price.label", new AbstractReadOnlyModel<String>() {
			@Override
			public String getObject() {
				return new StringResourceModel("shipmentorder.price.label." + baseProduct + "." + model.getObject().getOrderProcessVO(), model).getObject();

			}

/ Nu ook .getObject()	, er stond .toString()	, 

/ Einde FIX PCT-756


/ Einde DEBUG PCT-756
