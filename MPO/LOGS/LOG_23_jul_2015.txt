continuationId:1437046645981
flowDefinition:reload
redirectTo:invoice-multiline_create?base_controlFlow=false
doRedirect:true
base_sessionLevelOffset:1
base_windowToOpenUrl:
base_windowToOpenHeight:
base_windowToOpenWidth:
base_windowToOpenTitle:
base_windowToOpenScrollbar:
invoiceHeaderSystemId:27126553
systemId:1
invoiceLineNumber_1:10
logisticsOrderReference_1:N0001530
carrierReference_1:
lineRemark_1-display:
lineRemark_1:
podRemark_1-display:
podRemark_1:
amount_1:-361.50
vatTarifType_1:HIGH
amountVat_1:-75.92
costTypeSystemId_1:26671397
parentId_1:0
deleted_1:false
invoiceLineNumber_2:10
logisticsOrderReference_2:
carrierReference_2:
amount_2:0
vatTarifType_2:HIGH
amountVat_2:0
costTypeSystemId_2:26600544
parentId_2:1
deleted_2:true
invoiceLineNumber_3:0
logisticsOrderReference_3:
carrierReference_3:
amount_3:0.00
vatTarifType_3:FREE
amountVat_3:0.00
costTypeSystemId_3:26600544
parentId_3:0
deleted_3:true
invoiceLineNumber_4:0
logisticsOrderReference_4:
carrierReference_4:
amount_4:0.00
vatTarifType_4:FREE
amountVat_4:0.00
costTypeSystemId_4:26600544
parentId_4:0
deleted_4:true
invoiceLineNumber_5:0
logisticsOrderReference_5:
carrierReference_5:
amount_5:0.00
vatTarifType_5:FREE
amountVat_5:0.00
costTypeSystemId_5:26600544
parentId_5:0
deleted_5:true
invoiceLineNumber_6:0
logisticsOrderReference_6:
carrierReference_6:
amount_6:0.00
vatTarifType_6:FREE
amountVat_6:0.00
costTypeSystemId_6:26600544
parentId_6:0
deleted_6:true
invoiceLineNumber_7:0
logisticsOrderReference_7:
carrierReference_7:
amount_7:0.00
vatTarifType_7:FREE
amountVat_7:0.00
costTypeSystemId_7:26600544
parentId_7:0
deleted_7:true
invoiceLineNumber_8:0
logisticsOrderReference_8:
carrierReference_8:
amount_8:0.00
vatTarifType_8:FREE
amountVat_8:0.00
costTypeSystemId_8:26600544
parentId_8:0
deleted_8:true
invoiceLineNumber_9:0
logisticsOrderReference_9:
carrierReference_9:
amount_9:0.00
vatTarifType_9:FREE
amountVat_9:0.00
costTypeSystemId_9:26600544
parentId_9:0
deleted_9:true
invoiceLineNumber_10:0
logisticsOrderReference_10:
carrierReference_10:
amount_10:0.00
vatTarifType_10:FREE
amountVat_10:0.00
costTypeSystemId_10:26600544
parentId_10:0
deleted_10:true
invoiceLineNumber_11:0
logisticsOrderReference_11:
carrierReference_11:
amount_11:0.00
vatTarifType_11:FREE
amountVat_11:0.00
costTypeSystemId_11:26600544
parentId_11:0
deleted_11:true
invoiceLineNumber_12:0
logisticsOrderReference_12:
carrierReference_12:
amount_12:0.00
vatTarifType_12:FREE
amountVat_12:0.00
costTypeSystemId_12:26600544
parentId_12:0
deleted_12:true
invoiceLineNumber_13:0
logisticsOrderReference_13:
carrierReference_13:
amount_13:0.00
vatTarifType_13:FREE
amountVat_13:0.00
costTypeSystemId_13:26600544
parentId_13:0
deleted_13:true
invoiceLineNumber_14:0
logisticsOrderReference_14:
carrierReference_14:
amount_14:0.00
vatTarifType_14:FREE
amountVat_14:0.00
costTypeSystemId_14:26600544
parentId_14:0
deleted_14:true
invoiceLineNumber_15:0
logisticsOrderReference_15:
carrierReference_15:
amount_15:0.00
vatTarifType_15:FREE
amountVat_15:0.00
costTypeSystemId_15:26600544
parentId_15:0
deleted_15:true
invoiceLineNumber_16:0
logisticsOrderReference_16:
carrierReference_16:
amount_16:0.00
vatTarifType_16:FREE
amountVat_16:0.00
costTypeSystemId_16:26600544
parentId_16:0
deleted_16:true
invoiceLineNumber_17:0
logisticsOrderReference_17:
carrierReference_17:
amount_17:0.00
vatTarifType_17:FREE
amountVat_17:0.00
costTypeSystemId_17:26600544
parentId_17:0
deleted_17:true
invoiceLineNumber_18:0
logisticsOrderReference_18:
carrierReference_18:
amount_18:0.00
vatTarifType_18:FREE
amountVat_18:0.00
costTypeSystemId_18:26600544
parentId_18:0
deleted_18:true
invoiceLineNumber_19:0
logisticsOrderReference_19:
carrierReference_19:
amount_19:0.00
vatTarifType_19:FREE
amountVat_19:0.00
costTypeSystemId_19:26600544
parentId_19:0
deleted_19:true
invoiceLineNumber_20:0
logisticsOrderReference_20:
carrierReference_20:
amount_20:0.00
vatTarifType_20:FREE
amountVat_20:0.00
costTypeSystemId_20:26600544
parentId_20:0
deleted_20:true
serverUnavailableMessage:Server busy, please wait
processingFormMessage:Form is being processed...
deleteMessage:Are you sure?
ConsoleSearchEmulationRendering

/ DEBUG ISB-729

/ 7	. 

/ we search inv-22	, en click edit	, 

			<map:match type="regexp" pattern="^invoice-header_(edit|create)$">
				<map:act type="invoiceHeaderForm"/>
				<map:read mime-type="text/html" type="jsp" src="jsp/invoice-header_edit.jsp"/>
			</map:match>
			<map:action logger="invoice" name="invoiceHeaderForm"   src="com.mpobjects.invoice.control.invoiceheader.action.InvoiceHeaderFormAction"/>

			<map:match pattern="invoice-line_view">
				<map:act type="invoiceLine"/>
				<map:read mime-type="text/html" type="jsp" src="jsp/invoice-line.jsp"/>
			</map:match>	
			<map:action logger="invoice" name="invoiceLine"   	    src="com.mpobjects.invoice.control.invoiceline.action.InvoiceLineAction"/>			

$ vi invoice-header_edit.jsp
				<div id="invoiceLineArea">
					<iframe class="invoiceline" src="invoice-line_view?invoiceheadersystemid=${formVO.systemId}&readOnly=${isReadOnly}" />

/ we zien dat in 1ste instantie invoice-line.jsp verschijnt 'in' de invoice-header_edit.jsp	, dat is de jsp met het vergrootglas en de links	,



InvoiceHeaderFormAction.act() line: 78	
		} else {
			myVO = InvoiceHeaderUtil.getDAO().getBySystemId(mySystemId);
myVO	InvoiceHeaderVO  (id=24071)	


/ myVO.invoiceLines 
[
SystemId:27128268	Amount:0.00000	VAT:0.00000	VATTariff:HIGH	CostType:com.mpobjects.oms.model.ratecomponenttype.RateComponentType@2af0496b[systemId=26595322,code=Demurrage,description=Demurrage time,group=COST,reasonMandatory=false,deleted=false,sequenceNr=20]	InvoiceLine:27125923	User 27128130	Create date: 2015-07-17 16:24:21.722	, 
SystemId:27128275	Amount:8269.00000	VAT:1736.49000	VATTariff:HIGH	CostType:com.mpobjects.oms.model.ratecomponenttype.RateComponentType@71ef4268[systemId=26600544,code=Freight,description=Freight Cost,group=COST,reasonMandatory=false,deleted=false,sequenceNr=10]	InvoiceLine:27125923	User 27128130	Create date: 2015-07-20 17:34:22.519	, 
SystemId:27125925	Amount:-413.45000	VAT:-86.82000	VATTariff:HIGH	CostType:com.mpobjects.oms.model.ratecomponenttype.RateComponentType@d6d4a02[systemId=26671397,code=Freight Commission,description=Freight Commission for ISB,group=COST,reasonMandatory=false,deleted=false,sequenceNr=60]	InvoiceLine:27125923	User 27128130	Create date: 2015-07-20 17:34:22.519	, 
SystemId:27128277	Amount:100.00000	VAT:21.00000	VATTariff:HIGH	CostType:com.mpobjects.oms.model.ratecomponenttype.RateComponentType@2af0496b[systemId=26595322,code=Demurrage,description=Demurrage time,group=COST,reasonMandatory=false,deleted=false,sequenceNr=20]	InvoiceLine:27125923	User 27128130	Create date: 2015-07-20 17:34:22.519	, 
SystemId:27128276	Amount:0.00000	VAT:0.00000	VATTariff:HIGH	CostType:com.mpobjects.oms.model.ratecomponenttype.RateComponentType@2af0496b[systemId=26595322,code=Demurrage,description=Demurrage time,group=COST,reasonMandatory=false,deleted=false,sequenceNr=20]	InvoiceLine:27125923	User 27128130	Create date: 2015-07-20 15:44:36.405	, 
SystemId:27125927	Amount:0.00000	VAT:0.00000	VATTariff:HIGH	CostType:com.mpobjects.oms.model.ratecomponenttype.RateComponentType@71ef4268[systemId=26600544,code=Freight,description=Freight Cost,group=COST,reasonMandatory=false,deleted=false,sequenceNr=10]	InvoiceLine:27125923	User 27128130	Create date: 2015-07-20 10:56:44.604	]

InvoiceHeaderFormAction.act() line: 78	
		getRequest().setAttribute("formVO", myVO);

/c
/s
SetFormVOTag.setValueObject(EntityInterface) line: 201	
		theValueObject = aVO;
aVO	InvoiceHeaderVO  (id=24071)	

/ Dus de SetFormVOTag krijgt de valueobject uit de jsp (<mpo:setFormVO valueObject="${formVO}">)	
/ , en hieronder gaat set deze vo in de form	,

/c
SetFormVOTag.doStartTag() line: 91	
this	SetFormVOTag  (id=24007)	
		getForm().addValueObject(getValueObject());
/s
SetFormVOTag.getForm() line: 148	
		if (theFormTag == null) {
				theFormTag = (FormTag) getRequest().getAttribute(FormTag.DEFAULT_DESTINATION_ATTRIBUTE);
/ FormTag.DEFAULT_DESTINATION_ATTRIBUTE="form"
/ TODO (Wanneer set	?) 
/t
/s
FormTag.addValueObject(EntityInterface) line: 181	
		theValueObjects.add(aVO);

/ dan 	,
FormTag.doEndTag() line: 234	
		getRequest().getSession().setAttribute(theContinuationId + "_form", this);

/ we hebben in het edit action , jsp de FormTag create	, en deze stoppen we in de session, voor de save hieronder	,

/ 7	. 

/c 

/ WH 
/ new request	, de jsp verschijnt in <iframe/> 

/s
InvoiceLineAction.act() line: 29	
		InvoiceLineVO mySelectedInvoiceLineVO = new InvoiceLineVO();
mySelectedInvoiceLineVO	InvoiceLineVO  (id=24133)	
		myInvoiceHeaderVO = InvoiceHeaderUtil.getDAO().getBySystemId(getInvoiceHeaderSystemIdFromRequest());
myInvoiceHeaderVO	InvoiceHeaderVO  (id=22717)	
		getRequest().setAttribute("formVO", mySelectedInvoiceLineVO);
		getRequest().setAttribute("invoiceHeaderVO", myInvoiceHeaderVO);

/ c
/ voor jsp	,

	public void setValueObject(EntityInterface aVO) {
		theValueObject = aVO;
aVO	InvoiceLineVO  (id=22718)	

/c
SetFormVOTag.doStartTag() line: 109	
		getForm().addValueObject(getValueObject());
/ TODO( getRequest().getAttribute(FormTag.DEFAULT_DESTINATION_ATTRIBUTE);)

/c
FormTag.doEndTag() line: 227	
		getRequest().getSession().setAttribute(theContinuationId + "_form", this);


/ 7	. 

/ we click op edit in invoice-line.jsp	, 

			<map:match type="regexp" pattern="^invoice-multiline_(edit|create)$">
				...
				<map:act type="invoiceMultiLineForm"/>
				<map:read mime-type="text/html" type="jsp" src="jsp/invoice-multiline_edit.jsp"/>
			</map:match>

			<map:action logger="invoice" name="invoiceMultiLineForm"   src="com.mpobjects.invoice.control.invoiceline.action.InvoiceMultiLineFormAction"/>


$ vi InvoiceMultiLineFormAction.java

			theInvoiceHeaderSystemId = (Integer) getSession().getAttribute(HEADER_ID_ATT_NAME);
"headersystemid"
/ TODO
			Collection myDetailList = MpoBeanFactory.getBean(InvoiceDetailDAO.class).getInvoiceDetailSubset(theInvoiceHeaderSystemId, startLimit,
					InvoiceMultiLineVO.NB_ITEMPAGE);
/ alle 3 de details	,
				myVO = new InvoiceMultiLineVO(myDetailList);
		getRequest().setAttribute("formVO", myVO);
myVO	InvoiceMultiLineVO  (id=24217)	


/c 
SetFormVOTag.setValueObject(EntityInterface) line: 201	
aVO	InvoiceMultiLineVO  (id=24217)	

SetFormVOTag.getForm() line: 148	
				theFormTag = (FormTag) getRequest().getAttribute(FormTag.DEFAULT_DESTINATION_ATTRIBUTE);

/c
FormTag.doEndTag() line: 227	
		getRequest().getSession().setAttribute(theContinuationId + "_form", this);



/ Intermezzo 

/ set in	,
InvoiceMultiLineSaveAction(AbstractSaveAction).act() line: 64	
		validate();
/s
BoundSaveAction.class
	public FormTag getForm() {
			FormTag myTag = (FormTag) getSession().getAttribute(getContinuationId() + "_form");
			...
			getRequest().setAttribute("form", theFormTag);
/t
		validate();
/d
			handleSave();
/ validate wordt voor handleSave called, en via validate wordt getRequest().setAttribute("form",...) set	,

/ continue	,
SetFormVOTag.setValueObject(EntityInterface) line: 201	
		theValueObject = aVO;

/ Einde Intermezzo 

/ 7	. 

/ remove een invoice detail	,
/ click Save and Close	,

			<map:match pattern="invoice-multiline_save">
				<map:act type="invoiceMultiLineSave"/>
			</map:match>
			<map:action logger="invoice" name="invoiceMultiLineSave"   src="com.mpobjects.invoice.control.invoiceline.action.InvoiceMultiLineSaveAction"/>

/ continue	,
/s
/ stack	,
	InvoiceMultiLineSaveAction(BoundSaveAction).getFetchedData() line: 140	
				theFetchedData = getForm().getValueObjects();

	InvoiceMultiLineSaveAction(BoundSaveAction).getValueObject() line: 197	
		return getFetchedData().iterator().next();

	InvoiceMultiLineSaveAction.validate() line: 217	
		InvoiceMultiLineVO myVO = (InvoiceMultiLineVO) getValueObject();

	InvoiceMultiLineSaveAction(AbstractSaveAction).act() line: 64	
		validate();

/ we debug	,
InvoiceMultiLineSaveAction(BoundSaveAction).getForm() line: 170	
			theFormTag = (FormTag) getRequest().getAttribute("form");
null
			FormTag myTag = (FormTag) getSession().getAttribute(getContinuationId() + "_form");
myTag	FormTag  (id=24235)	
			theFormTag = myTag;
			getRequest().setAttribute("form", theFormTag);

/c
InvoiceMultiLineSaveAction.validate() line: 217	
		InvoiceMultiLineVO myVO = (InvoiceMultiLineVO) getValueObject();
/s
InvoiceMultiLineSaveAction(BoundSaveAction).getValueObject() line: 197	
		return getFetchedData().iterator().next();
/s
InvoiceMultiLineSaveAction(BoundSaveAction).getFetchedData() line: 119	
				theFetchedData = getForm().getValueObjects();
[InvoiceMultiLineVO  (id=24217)]

////////////////////////
/ Dus vo uit form is set in de save action	,
	
/c
InvoiceMultiLineSaveAction.handleSave() line: 52	
		InvoiceMultiLineVO myVO = (InvoiceMultiLineVO) getValueObject();
/ hierboven set in de save action	,
		InvoiceHeaderUtil.getInvoiceHeaderService().saveMultiLine(myInvoiceHeaderSystemId, myRepairInvoice, myVO);
/ Deze vo , dus model van de form op invoice-multiline_edit.jsp heeft de juiste invoice details, met van de verwijderde de fields amount en amoutVAT set to 0	,
/ spring starts TX	,
/s
SupplierInvoiceServiceImpl.saveMultiLine(int, String, InvoiceMultiLineVO) line: 1239	
			HashMap<Integer, InvoiceLineVO> myInvoiceLineList = myVO.getInvoiceLineList();
/ Haalt invoiceLine uit de invoicemultilinevo, see (*)	
			for (Entry<Integer, InvoiceLineVO> lineEntry : myInvoiceLineList.entrySet()) {
				InvoiceLineVO myLine = lineEntry.getValue();
						myLine = getInvoiceLineDAO().save(myLine);

/ (*) invoice-line.jsp heeft een ander form als invoice-multiline_edit.jsp	, daarom hebben we ook 2 vo's 	, van elk form een	,
/ de invoice lines zitten in de invoice-multiline_edit.jsp's form's model	, de InvoiceMultiLineVO	, 

/c
InvoiceMultiLineSaveAction(AbstractSaveAction).handleSave
		InvoiceHeaderUtil.getInvoiceHeaderService().saveMultiLine(myInvoiceHeaderSystemId, myRepairInvoice, myVO);
/d
				theInvoiceRedirectionUrl = (String) getSession().getAttribute(InvoiceMultiLineFormAction.REDIRECT_ATT_NAME);

/ na handleSave komt afterSave	,
/c
InvoiceMultiLineSaveAction(AbstractSaveAction).afterSave() line: 158	
			String myRedirectUrl = getRedirectUrl();
myRedirectUrl	"invoice-line_view?headersystemid=27125922&amp;base_controlFlow=false" (id=26621)	
			getRequest().setAttribute("redirectTo", myRedirectUrl);
			RedirectSaveAction.redirect(getRedirector(), getRequest(), myRedirectUrl);

/ 7	. 

/c
InvoiceLineAction.act() line: 53	
		InvoiceLineVO mySelectedInvoiceLineVO = new InvoiceLineVO();
		getRequest().setAttribute("formVO", mySelectedInvoiceLineVO);
/c
SetFormVOTag.setValueObject
		theValueObject = aVO;
/c
SetFormVOTag.doStartTag() line: 91	
		getForm().addValueObject(getValueObject());
/ TODO (Hoe form?)

/c
FormTag.doEndTag() line: 227	
		getRequest().getSession().setAttribute(theContinuationId + "_form", this);

/ 7	.

/ Save en Close header	,

<input type="button" id="saveAndCloseBtn" value="Save and Close" onclick=" theEditFormFormManager.submit('../invoice/invoice-header_save', true, '-1'); return false;">
			<map:match pattern="invoice-header_save">
				<map:act type="invoiceHeaderSave"/>
			</map:match>
			<map:action logger="invoice" name="invoiceHeaderSave"   src="com.mpobjects.invoice.control.invoiceheader.action.InvoiceHeaderSaveAction"/>

/c
InvoiceHeaderSaveAction(BoundSaveAction).getForm() line: 167	
			FormTag myTag = (FormTag) getSession().getAttribute(getContinuationId() + "_form");
			theFormTag = myTag;
			getRequest().setAttribute("form", theFormTag);
/c
InvoiceHeaderSaveAction(BoundSaveAction).getFetchedData() line: 119	
				theFetchedData = getForm().getValueObjects();
/c
InvoiceHeaderSaveAction.handleSave() line: 102	
myVO	InvoiceHeaderVO  (id=24071)	
/ Inderdaad, de oude	, met de oude invoice details	,


/ 7	. 

/ Opnieuw	,

/ we edit (open) inv-22	,

/ 13	. 
/ invoice header	,
/s
InvoiceHeaderFormAction.act() line: 80	
		} else {
			myVO = InvoiceHeaderUtil.getDAO().getBySystemId(mySystemId);

		getSession().setAttribute(InvoiceMultiLineFormAction.HEADER_ID_ATT_NAME, mySystemId);

		getRequest().setAttribute("formVO", myVO);

/c
	public void setValueObject(EntityInterface aVO) {
		theValueObject = aVO;
theValueObject	InvoiceHeaderVO  (id=1804)	

/c
SetFormVOTag.doStartTag() line: 109	
		getForm().addValueObject(getValueObject());
/s
SetFormVOTag.getForm() line: 149	
				theFormTag = (FormTag) getRequest().getAttribute(FormTag.DEFAULT_DESTINATION_ATTRIBUTE);
/t
/c
FormTag.doEndTag() line: 227	
		getRequest().getSession().setAttribute(theContinuationId + "_form", this);
1437547938891

/ Intermezzo
FormTag.doStartTag(){
	...
	theContinuationId = new Date().getTime();
}

/c
/ 13	. 
/ invoice line	,

InvoiceLineAction.act() line: 42	
		InvoiceLineVO mySelectedInvoiceLineVO = new InvoiceLineVO();

		myInvoiceHeaderVO = InvoiceHeaderUtil.getDAO().getBySystemId(getInvoiceHeaderSystemIdFromRequest());
/ TODO (Moeten we ook doen)	,

		getRequest().setAttribute("formVO", mySelectedInvoiceLineVO);
/c
	public void setValueObject(EntityInterface aVO) {
		theValueObject = aVO;
theValueObject	InvoiceLineVO  (id=19955)	

/c
SetFormVOTag.doStartTag() line: 91	
		getForm().addValueObject(getValueObject());
/s
				theFormTag = (FormTag) getRequest().getAttribute(FormTag.DEFAULT_DESTINATION_ATTRIBUTE);
/t
/c
FormTag.doEndTag() line: 227	
		getRequest().getSession().setAttribute(theContinuationId + "_form", this);
1437548878298


/13	.
/ we click 'Edit mode'
InvoiceMultiLineFormAction.act() line: 47	
			theInvoiceHeaderSystemId = (Integer) getSession().getAttribute(HEADER_ID_ATT_NAME);
/ TODO (Moeten we ook doen)	,
			Collection myDetailList = MpoBeanFactory.getBean(InvoiceDetailDAO.class).getInvoiceDetailSubset(theInvoiceHeaderSystemId, startLimit,
					InvoiceMultiLineVO.NB_ITEMPAGE);
/ queries is_deleted=0 op line en detail	,
			if (myDetailList.size() > 0) {
				myVO = new InvoiceMultiLineVO(myDetailList);

		getRequest().setAttribute("formVO", myVO);

/c
SetFormVOTag.setValueObject(EntityInterface) line: 201	
		theValueObject = aVO;
aVO	InvoiceMultiLineVO  (id=21190)	
/c
SetFormVOTag.class
	public void setValueObject(EntityInterface aVO) {
		theValueObject = aVO;
theValueObject	InvoiceMultiLineVO  (id=21190)	
/c
SetFormVOTag.doStartTag() line: 91	
		getForm().addValueObject(getValueObject());
/s
				theFormTag = (FormTag) getRequest().getAttribute(FormTag.DEFAULT_DESTINATION_ATTRIBUTE);
/t
/c
FormTag.doEndTag() line: 227	
		getRequest().getSession().setAttribute(theContinuationId + "_form", this);
1437552889379

/ 13	. 
/ rm etail	, 
/ call Save and Close	,

InvoiceMultiLineSaveAction(BoundSaveAction).getForm() line: 167	
/ via validate (voor handleSave)	,
			FormTag myTag = (FormTag) getSession().getAttribute(getContinuationId() + "_form");
/s
			theContinuationId = new Long(getRequest().getParameter(FormTag.CONTINUATION_FIELD)).longValue();
/ De continuation id zit dus in het form als hidden field	, 
1437552889379
			theFormTag = myTag;
			getRequest().setAttribute("form", theFormTag);
/c
InvoiceMultiLineSaveAction(BoundSaveAction).getFetchedData() line: 119	
/ via validate	,
				theFetchedData = getForm().getValueObjects();
[0]	InvoiceMultiLineVO  (id=20172)	
/c
InvoiceMultiLineSaveAction.handleSave() line: 52	
		InvoiceMultiLineVO myVO = (InvoiceMultiLineVO) getValueObject();
		InvoiceHeaderUtil.getInvoiceHeaderService().saveMultiLine(myInvoiceHeaderSystemId, myRepairInvoice, myVO);
/s
SupplierInvoiceServiceImpl.saveMultiLine(int, String, InvoiceMultiLineVO) line: 1255	

		InvoiceHeaderVO myInvoiceHeaderVO = getInvoiceHeaderDAO().getBySystemId(myInvoiceHeaderSystemId);
/ WH NIET used	,

						myLine = getInvoiceLineDAO().save(myLine);

			for (Entry<Integer, InvoiceDetailVO> detailEntry : myInvoiceDetailList.entrySet()) {
				InvoiceDetailVO myDetail = detailEntry.getValue();
				// Check amount - if = 0 this was deleted
				if (NumberUtils.isNullOrZero(myDetail.getAmount())) {
					if (myDetail.getSystemId() != ValueObject.VOLATILE_SYSTEM_ID) {
/ JA, voor deleted row	,
						myDetail.setDeleted(true);
						myDetail = getInvoiceDetailDAO().save(myDetail);
					}
					myDetail.setDeleted(true);
/ voor overige rows, die system id=0 hebben	,
				} else {
					...
					myDetail = getInvoiceDetailDAO().save(myDetail);
/ voor 2 overblijvende details uit de invoice line	,

/ we zien in postgres log	,

LOG:  execute <unnamed>: update INVOICE_LINE set IS_DELETED=$1, CONTAINER_COUNT=$2, INVOICE_POD_STATUS=$3, INVOICE_RECHARGE_STATUS=$4, LOADING_METERS=$5, LOADING_METERS_UOM=$6, PAY_WEIGHT=$7, PAY_WEIGHT_UOM=$8, POD_REMARK=$9, RECHARGE_DATE=$10, RECHARGE_MARK_NUMBER=$11, CARRIER_REFERENCE=$12, CREATE_DATE=$13, LINE_NUMBER=$14, LOGISTICS_ORDER_REFERENCE=$15, MATCHING_ERROR_CODE=$16, REMARK=$17, SHIPMENT_ORDER_SYSTEMID=$18, SERVICE_ORDER_SYSTEMID=$19, VOLUME=$20, VOLUME_UOM=$21, WEIGHT=$22, WEIGHT_UOM=$23, ORDER_PROCESS_SYSTEMID=$24, USER_SYSTEMID=$25, MATCH_STATUS_SYSTEMID=$26 where SYSTEM_ID=$27
DETAIL:  parameters: $1 = 'f', $2 = NULL, $3 = 'UNKNOWN', $4 = 'INITIAL', $5 = NULL, $6 = NULL, $7 = NULL, $8 = NULL, $9 = '', $10 = NULL, $11 = NULL, $12 = '', $13 = '2015-07-22 10:53:16.087', $14 = '10', $15 = 'N0001709', $16 = '', $17 = '', $18 = NULL, $19 = '27125854', $20 = NULL, $21 = NULL, $22 = NULL, $23 = NULL, $24 = NULL, $25 = '27128130', $26 = '1', $27 = '27125923'

LOG:  execute <unnamed>: update INVOICE_DETAIL set USER_SYSTEMID=$1, CREATE_DATE=$2, IS_DELETED=$3, MATCH_STATUS_SYSTEMID=$4, AMOUNT=$5, AMOUNT_VAT=$6, VAT_TARIF_TYPE=$7, COST_TYPE_SYSTEMID=$8, REMARK=$9, MATCHING_ERROR_CODE=$10, SURCHARGE_BASED=$11, SURCHARGE_SYSTEMID=$12, TAX_1_BASE_AMOUNT=$13, TAX_1_TAX_AMOUNT=$14, TAX_1_TAX_TARIFF=$15, TAX_1_TAX_TYPE=$16, TAX_1_DESCRIPTION=$17 where SYSTEM_ID=$18
DETAIL:  parameters: $1 = '27128130', $2 = '2015-07-22 10:53:16.087', $3 = 'f', $4 = '1', $5 = '-413.44999999999998863131622783839702606201171875', $6 = '-86.81999999999999317878973670303821563720703125', $7 = 'HIGH', $8 = '26671397', $9 = '', $10 = '', $11 = 'f', $12 = NULL, $13 = NULL, $14 = NULL, $15 = NULL, $16 = 'HIGH', $17 = NULL, $18 = '27125925'

LOG:  execute <unnamed>: update INVOICE_DETAIL set USER_SYSTEMID=$1, CREATE_DATE=$2, IS_DELETED=$3, MATCH_STATUS_SYSTEMID=$4, AMOUNT=$5, AMOUNT_VAT=$6, VAT_TARIF_TYPE=$7, COST_TYPE_SYSTEMID=$8, REMARK=$9, MATCHING_ERROR_CODE=$10, SURCHARGE_BASED=$11, SURCHARGE_SYSTEMID=$12, TAX_1_BASE_AMOUNT=$13, TAX_1_TAX_AMOUNT=$14, TAX_1_TAX_TARIFF=$15, TAX_1_TAX_TYPE=$16, TAX_1_DESCRIPTION=$17 where SYSTEM_ID=$18
DETAIL:  parameters: $1 = '27128130', $2 = '2015-07-22 10:53:16.087', $3 = 'f', $4 = '1', $5 = '8269', $6 = '1736.490000000000009094947017729282379150390625', $7 = 'HIGH', $8 = '26600544', $9 = NULL, $10 = '', $11 = 'f', $12 = NULL, $13 = NULL, $14 = NULL, $15 = NULL, $16 = 'HIGH', $17 = NULL, $18 = '27128275'

LOG:  execute <unnamed>: update INVOICE_DETAIL set USER_SYSTEMID=$1, CREATE_DATE=$2, IS_DELETED=$3, MATCH_STATUS_SYSTEMID=$4, AMOUNT=$5, AMOUNT_VAT=$6, VAT_TARIF_TYPE=$7, COST_TYPE_SYSTEMID=$8, REMARK=$9, MATCHING_ERROR_CODE=$10, SURCHARGE_BASED=$11, SURCHARGE_SYSTEMID=$12, TAX_1_BASE_AMOUNT=$13, TAX_1_TAX_AMOUNT=$14, TAX_1_TAX_TARIFF=$15, TAX_1_TAX_TYPE=$16, TAX_1_DESCRIPTION=$17 where SYSTEM_ID=$18
DETAIL:  parameters: $1 = '27128130', $2 = '2015-07-22 10:14:01.612', $3 = 't', $4 = '1', $5 = '0', $6 = '0', $7 = 'HIGH', $8 = '26595322', $9 = NULL, $10 = '', $11 = 'f', $12 = NULL, $13 = NULL, $14 = NULL, $15 = NULL, $16 = 'HIGH', $17 = NULL, $18 = '27128279'

LOG:  execute S_1: COMMIT

/ 13	. 

/ we click Save and Close	,

/c
BoundSaveAction.class
	public FormTag getForm() {
			FormTag myTag = (FormTag) getSession().getAttribute(getContinuationId() + "_form");

/ c
InvoiceHeaderSaveAction(BoundSaveAction).getFetchedData() line: 119	
				theFetchedData = getForm().getValueObjects();
t/
InvoiceHeaderSaveAction.validate() line: 230	
		InvoiceHeaderVO myVO = (InvoiceHeaderVO) getValueObject();
/d
/ TODO(Moeten we veranderen)

/c
InvoiceHeaderSaveAction.handleSave() line: 102	
		InvoiceHeaderVO myVO = (InvoiceHeaderVO) getValueObject();
/ TODO(Moeten we veranderen)

/ 7	. 

/ we veranderen	, 

$ vi InvoiceHeaderSaveAction.java

	private InvoiceHeaderVO getInvoiceHeaderVO() {
		int invoiceHeaderSystemId = 0;
		Object object = getSession().getAttribute(InvoiceMultiLineFormAction.HEADER_ID_ATT_NAME);
		if (object instanceof Integer) {
			invoiceHeaderSystemId = (Integer) object;
		} else {
			throw new IllegalStateException("Unable to get invoice header system id from the http session");
		}
		InvoiceHeaderVO invoiceHeaderVO = InvoiceHeaderUtil.getInvoiceHeaderService().getInvoiceHeaderDAO().getBySystemId(invoiceHeaderSystemId);
		return invoiceHeaderVO;

	}

	@Override
	public void handleSave() throws Exception {
		...
		// InvoiceHeaderVO myVO = (InvoiceHeaderVO) getValueObject();
		InvoiceHeaderVO myVO = getInvoiceHeaderVO();

	@Override
	public void validate() throws Exception {
		...
		// InvoiceHeaderVO myVO = (InvoiceHeaderVO) getValueObject();
		InvoiceHeaderVO myVO = getInvoiceHeaderVO();


/ 13	. 

/ we edit fields in de header, 	en save and close	,

Request URL:http://localhost:8080/tms/invoice/invoice-header_save
Request Headers
Accept:text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Content-Type:application/x-www-form-urlencoded
Origin:http://localhost:8080
Referer:http://localhost:8080/tms/invoice/invoice-header_edit?base_sessionLevelOffset=1&systemid=27125922&systemId=27125922
User-Agent:Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/38.0.2125.104 Safari/537.36
X-DevTools-Emulate-Network-Conditions-Client-Id:00B530C4-44E1-5A5E-BECB-7AD722B2F512
Form Dataview
continuationId:1437563120114
flowDefinition:reload
redirectTo:../core/back?levelOffset=-1
doRedirect:true
base_sessionLevelOffset:-1
base_windowToOpenUrl:
base_windowToOpenHeight:
base_windowToOpenWidth:
base_windowToOpenTitle:
base_windowToOpenScrollbar:
systemId:27125922
invoiceOrganization:ISB-C&S
receiver:CHARTER0035
vatNumberReceiver:
markNumber:INV-22
invoiceNumber:INV-22
sender:ISB-C&S
vatNumberSender:NL808413363B02
invoiceType:SELF_BILL
currency:EUR
vatPolicySystemId:26605695
createDateDate:17-Jun-2015
createDateDateTime:23:59
invoiceDateDate:17-Jun-2015
invoiceDateDateTime:23:59
invoiceDueDateDate:17-Jul-2015
reportDateDate:
invoiceReceiptDateOriginalDate:
invoiceReceiptDateCopyDate:
invoiceHeaderStatus:INITIAL
matchingErrorCode:
invoicePodStatus:UNKNOWN
invoiceRechargeStatus:NOT_RECHARGED
registerEmployee:
remark-display:
remark:
runNumberInvoiceMatching:
approvementEmployee:
approvementRemarks-display:
approvementRemarks:
deblockEmployee:
carrierTotalInvoiceAmountIncVat:0.00
carrierTotalInvoiceAmountExcVat:0.00
totalInvoiceAmountIncVat:9,626.22

totalInvoiceAmountExcVat:7,855.55		/ edited
totalVatAmountHigh:1,649.67				/ edited

totalVatAmountLow:0.00

totalInvoiceAmountHighVat:7,855.55		/ edited

totalInvoiceAmountLowVat:0.00
totalInvoiceAmountFreeVat:0.00
totalInvoiceAmountRevVat:0.00
hiddenActionBtn:false
serverUnavailableMessage:Server busy, please wait
processingFormMessage:Form is being processed...
deleteMessage:Are you sure?
ConsoleSearchEmulationRendering


/ we komen eerst in getForm()	, en daarna	,

/s
InvoiceHeaderSaveAction.getInvoiceHeaderVO() line: 102	
		InvoiceHeaderVO invoiceHeaderVO = InvoiceHeaderUtil.getInvoiceHeaderService().getInvoiceHeaderDAO().getBySystemId(invoiceHeaderSystemId);
...
/s
InvoiceHeaderDAOImpl(GenericHibernateDAO).getBySystemId(int) line: 301	
				return type.cast(getHibernateTemplate().load(type, aSystemId));
...
/s
InvoiceHeaderVO.setTotalInvoiceAmountExcVat(BigDecimal) line: 856	
theTotalInvoiceAmountExcVat	BigDecimal  (id=21062)	
7955.55000
/ uit db	,
/c
InvoiceHeaderVO.setTotalInvoiceAmountHighVat(BigDecimal) line: 872	
theTotalInvoiceAmountHighVat	BigDecimal  (id=21067)	
7955.55000
/c
InvoiceHeaderVO.setTotalVatAmountHigh(BigDecimal) line: 906	
theTotalVatAmountHigh	BigDecimal  (id=21077)	
1670.67000

/ 7	.

/ we reset zoals het was 	,

$ vi InvoiceHeaderSaveAction.java

	@Override
	public void handleSave() throws Exception {

		takeControl = true;

		InvoiceHeaderVO myVO = (InvoiceHeaderVO) getValueObject();
		// InvoiceHeaderVO myVO = getInvoiceHeaderVO();

	@Override
	public void validate() throws Exception {
		...
		InvoiceHeaderVO myVO = (InvoiceHeaderVO) getValueObject();
		// InvoiceHeaderVO myVO = getInvoiceHeaderVO();


/ 13	. 

/ geef op invoice list scherm inv-22, en click filter	,

/ sitemap: invoice-header_list	, 

/ loads uit db,	en sets in obj	,

/ TODO

InvoiceHeaderView.executeDynaQuery(DynaQuery) line: 28	
			return InvoiceHeaderUtil.getDAO().executeDynaQuery(aQuery);
...
/s
InvoiceHeaderDAOImpl.executeDynaQuery(DynaQuery) line: 55	
		return executeSqlSelect(mySql, "IH");
mySql	"SELECT * FROM INVOICE_HEADER WHERE ORGANIZATION_SYSTEMID IN (0,500,520,510,550,530,3150,1)  and upper(Invoice_number) LIKE '%INV-22%'" (id=2345)	
...
/s
InvoiceHeaderDAOImpl(BaseHibernateDAO).executeSqlSelect(String, String, Collection<QueryParameter>, int, int) line: 211	
			return getHibernateTemplate().executeFind(new HibernateCallback() {
				@Override
				public Object doInHibernate(Session aSession) throws HibernateException, SQLException {
					SQLQuery query = aSession.createSQLQuery(aSql);
					for (QueryParameter parameter : aParameters) {
						parameter.setValue(query);
					}
					query.addEntity(anAlias, type);
					if (aMaxResult > 0) {
						query.setMaxResults(aMaxResult);
					}
					if (aFirstResult > 0) {
						query.setFirstResult(aFirstResult);
					}
					return query.list();
				}
			});
/s
InvoiceHeaderVO.setTotalInvoiceAmountExcVat(BigDecimal) line: 856	
7955.55000
/c
	public void setTotalInvoiceAmountHighVat(BigDecimal theTotalInvoiceAmountHighVat) {
		this.theTotalInvoiceAmountHighVat = theTotalInvoiceAmountHighVat;
/c
	public void setTotalVatAmountHigh(BigDecimal theTotalVatAmountHigh) {
		this.theTotalVatAmountHigh = theTotalVatAmountHigh;
1670.67000

/ 13	. 

/ edit inv-22

InvoiceHeaderFormAction.act() line: 78	
		else{
			myVO = InvoiceHeaderUtil.getDAO().getBySystemId(mySystemId);
...
/s
InvoiceHeaderDAOImpl(GenericHibernateDAO).getBySystemId(int) line: 301	
				return type.cast(getHibernateTemplate().load(type, aSystemId));
...
/s
InvoiceHeaderVO.setTotalInvoiceAmountExcVat(BigDecimal) line: 856	
/ value uit db	,

/c
/t
InvoiceHeaderFormAction.act() line: 89	
			myVO = InvoiceHeaderUtil.getDAO().getBySystemId(mySystemId);
/d
			InvoiceHeaderUtil.getInvoiceHeaderService().checkTotals(myVO);
...
/s
SupplierInvoiceServiceImpl.checkTotals(InvoiceHeaderVO) line: 458	
			if (StringUtils.isNotEmpty(theWarning.toString())) {
				setHeaderStatus(myVO, InvoiceHeaderStatus.INITIAL);
/s
SupplierInvoiceServiceImpl.setHeaderStatus(InvoiceHeaderVO, InvoiceHeaderStatus) line: 1302	
		myVO = save(myVO);
/s
SupplierInvoiceServiceImpl.save(InvoiceHeaderVO) line: 1137	
		InvoiceHeaderVO myNewInvoiceHeader = invoiceHeaderDAO.merge(anInvoiceHeader);
...
/s
InvoiceHeaderDAOImpl.merge(InvoiceHeaderVO) line: 258	
		return super.merge(aHeader);
/s
InvoiceHeaderDAOImpl(GenericHibernateDAO).merge(Type) line: 428	
		else{
			anObject = type.cast(getHibernateTemplate().merge(anObject));
...
/s
InvoiceHeaderVO.class
	public void setTotalInvoiceAmountExcVat(BigDecimal theTotalInvoiceAmountExcVat) {
		this.theTotalInvoiceAmountExcVat = theTotalInvoiceAmountExcVat;
/c
	public void setTotalInvoiceAmountHighVat(BigDecimal theTotalInvoiceAmountHighVat) {
		this.theTotalInvoiceAmountHighVat = theTotalInvoiceAmountHighVat;
/c
	public void setTotalVatAmountHigh(BigDecimal theTotalVatAmountHigh) {
		this.theTotalVatAmountHigh = theTotalVatAmountHigh;

/c
InvoiceLineAction.act() line: 29	
		myInvoiceHeaderVO = InvoiceHeaderUtil.getDAO().getBySystemId(getInvoiceHeaderSystemIdFromRequest());
...
/s
InvoiceHeaderDAOImpl(GenericHibernateDAO).getBySystemId(int) line: 301	
				return type.cast(getHibernateTemplate().load(type, aSystemId));
...
/s
InvoiceHeaderVO.class
	public void setTotalInvoiceAmountExcVat(BigDecimal theTotalInvoiceAmountExcVat) {
		this.theTotalInvoiceAmountExcVat = theTotalInvoiceAmountExcVat;
/c
	public void setTotalInvoiceAmountHighVat(BigDecimal theTotalInvoiceAmountHighVat) {
		this.theTotalInvoiceAmountHighVat = theTotalInvoiceAmountHighVat;
/c
	public void setTotalVatAmountHigh(BigDecimal theTotalVatAmountHigh) {
		this.theTotalVatAmountHigh = theTotalVatAmountHigh;

/ 13	. 

/ we edit de 3 fields hierboven in de header	, 
/ click Save and Close	,

/ 13	. 

/ inv-22

org.hibernate.ObjectNotFoundException: No row with the given identifier exists: [com.mpobjects.invoice.model.invoicedetail.vo.InvoiceDetailVO#27128285] 
at org.hibernate.impl.SessionFactoryImpl$2.handleEntityNotFound(SessionFactoryImpl.java:435) 
at org.hibernate.event.def.DefaultLoadEventListener.load(DefaultLoadEventListener.java:233) 
at org.hibernate.event.def.DefaultLoadEventListener.proxyOrLoad(DefaultLoadEventListener.java:269) 
at org.hibernate.event.def.DefaultLoadEventListener.onLoad(DefaultLoadEventListener.java:152) 
at org.hibernate.impl.SessionImpl.fireLoad(SessionImpl.java:1090) 
at org.hibernate.impl.SessionImpl.internalLoad(SessionImpl.java:1038) 
at org.hibernate.type.EntityType.resolveIdentifier(EntityType.java:630) 
at org.hibernate.type.ManyToOneType.assemble(ManyToOneType.java:236) 
at org.hibernate.collection.PersistentSet.initializeFromCache(PersistentSet.java:147) 
at org.hibernate.cache.entry.CollectionCacheEntry.assemble(CollectionCacheEntry.java:58) 
at org.hibernate.event.def.DefaultInitializeCollectionEventListener.initializeCollectionFromCache(DefaultInitializeCollectionEventListener.java:159) 
at org.hibernate.event.def.DefaultInitializeCollectionEventListener.onInitializeCollection(DefaultInitializeCollectionEventListener.java:71) 
at org.hibernate.impl.SessionImpl.initializeCollection(SessionImpl.java:1863) 
at org.hibernate.collection.AbstractPersistentCollection.initialize(AbstractPersistentCollection.java:369) 
at org.hibernate.collection.AbstractPersistentCollection.read(AbstractPersistentCollection.java:111) 
at org.hibernate.collection.AbstractPersistentCollection.readSize(AbstractPersistentCollection.java:134) 
at org.hibernate.collection.PersistentSet.size(PersistentSet.java:162) 
at com.mpobjects.invoice.model.invoiceheader.vo.InvoiceHeaderVO.hasDetails(InvoiceHeaderVO.java:587) 
at com.mpobjects.invoice.service.supplierinvoice.InvoiceHeaderStatusManager.getAllowedNextStatusForSelfBill(InvoiceHeaderStatusManager.java:125) 
at com.mpobjects.invoice.service.supplierinvoice.InvoiceHeaderStatusManager.getAllowedNextStatus(InvoiceHeaderStatusManager.java:92) 
at com.mpobjects.invoice.control.invoiceheader.action.InvoiceHeaderFormAction.act(InvoiceHeaderFormAction.java:117) 
at com.mpobjects.control.action.AbstractAction.act(AbstractAction.java:171) 
at org.apache.cocoon.components.treeprocessor.sitemap.ActTypeNode.invoke(ActTypeNode.java:125) 
at org.apache.cocoon.components.treeprocessor.AbstractParentProcessingNode.invokeNodes(AbstractParentProcessingNode.java:47) 
at org.apache.cocoon.components.treeprocessor.sitemap.PreparableMatchNode.invoke(PreparableMatchNode.java:131) 
at org.apache.cocoon.components.treeprocessor.AbstractParentProcessingNode.invokeNodes(AbstractParentProcessingNode.java:69) 
at org.apache.cocoon.components.treeprocessor.sitemap.PipelineNode.invoke(PipelineNode.java:143) 
at 

/ inv-26
invoice detail#27128287

/ inv-9
#27128289

----------------------+-----------------------------+-----------
 system_id             | integer                     | not null
 create_date           | timestamp without time zone | 
 user_systemid         | integer                     | 
 amount                | numeric(18,5)               | default 0
 amount_vat            | numeric(18,5)               | default 0
 vat_tarif_type        | character varying(50)       | 
 invoice_line_systemid | integer                     | 
 cost_type_systemid    | integer                     | 
 match_status_systemid | integer                     | 
 remark                | character varying(500)      | 
 is_deleted            | smallint                    | default 0
 matching_error_code   | character varying(250)      | 
 surcharge_based       | smallint                    | 
 surcharge_systemid    | integer                     | 
 tax_1_base_amount     | numeric(12,3)               | 
 tax_1_tax_amount      | numeric(12,3)               | 
 tax_1_tax_tariff      | numeric(6,3)                | 
 tax_1_tax_type        | character varying(20)       | 
 tax_1_description     | character varying(100)      | 


ystem_id             | 27128268
create_date           | 2015-07-17 16:24:21.722
user_systemid         | 27128130
amount                | 0.00000
amount_vat            | 0.00000
vat_tarif_type        | HIGH
invoice_line_systemid | 27125923
cost_type_systemid    | 26595322
match_status_systemid | 1
remark                | 
is_deleted            | 1
matching_error_code   | 
surcharge_based       | 0
surcharge_systemid    | 
tax_1_base_amount     | 
tax_1_tax_amount      | 
tax_1_tax_tariff      | 
tax_1_tax_type        | HIGH
tax_1_description     | 

isbscs4=# insert into invoice_detail values(27128285,'2015-07-22 12:05:22.618',27128130,100,21,'HIGH',27125923,26595322,1,'',0,'',0,null,null,null,null,'HIGH','');
INSERT 0 1

/ we kunnen weer inv-22 openen	,

/ cost_type_systemId is in rate_component_type table	,  kijk in de InvoiceDetailVO.standard.hbm.xml	, en de RateComponentType.standard.hbm.xml	,

/ 7	. 

/ we build een nieuwe isb db	,


[eric@localhost LOGS]$ PGPASSWORD=mpopostgres@mpo psql -U mpopostgres isbs
pnloms7=# create database isbscs5;
CREATE DATABASE
[eric@localhost Backup]$ pwd
/home/eric/Devel/Postgres/Backup
[eric@localhost Backup]$ PGPASSWORD=mpopostgres@mpo pg_restore -Fc -U mpopostgres -d  isbscs5  isbscs-a-2015-13-07.dump
/ OK

/ 7	. 

/ we hebben een detail added to inv-26	, save, save and close de line, save and close de header	, then we cannot open the header inv-26 again	,
org.hibernate.ObjectNotFoundException: No row with the given identifier exists: [com.mpobjects.invoice.model.invoicedetail.vo.InvoiceDetailVO#27128131]

/ 7	. 

/ in isbscs4,    inv-22	,

org.hibernate.ObjectNotFoundException: No row with the given identifier exists: [com.mpobjects.invoice.model.invoicedetail.vo.InvoiceDetailVO#27128290]

/ we repain	,
isbscs4=# insert into invoice_detail values(27128290,'2015-07-22 12:05:22.618',27128130,200,42,'HIGH',27125923,26595322,1,'',0,'',0,null,null,null,null,'HIGH','');
/ als we de header save	, en weer open	, zien we dat de detail weer weg is	, WH omdat de value object van de  header deze detail niet heeft	, hij staat weer op deleted=1, en de amount, amountVAT zijn weer 0	, 
/ TODO

/ We had code 	,

$ vi InvoiceHeaderSaveAction.java

	private InvoiceHeaderVO getInvoiceHeaderVO() {
		int invoiceHeaderSystemId = 0;
		Object object = getSession().getAttribute(InvoiceMultiLineFormAction.HEADER_ID_ATT_NAME);
		if (object instanceof Integer) {
			invoiceHeaderSystemId = (Integer) object;
		} else {
			throw new IllegalStateException("Unable to get invoice header system id from the http session");
		}
		InvoiceHeaderVO invoiceHeaderVO = InvoiceHeaderUtil.getInvoiceHeaderService().getInvoiceHeaderDAO().getBySystemId(invoiceHeaderSystemId);
		return invoiceHeaderVO;
		// set setformtagvo.setvalueObject(invoiceHeaderVO);
	}

	@Override
	public void handleSave() throws Exception {
		...
		InvoiceHeaderVO myVO = (InvoiceHeaderVO) getValueObject();
		// InvoiceHeaderVO myVO = getInvoiceHeaderVO();

	@Override
	public void validate() throws Exception {
		...
		InvoiceHeaderVO myVO = (InvoiceHeaderVO) getValueObject();
		// InvoiceHeaderVO myVO = getInvoiceHeaderVO();



/ 7	. 

/ we add an detail	, 


/ 13	. 

/ we click 'Create mode: new page'	,
<a href="invoice-multiline_create?refresh=true&amp;base_controlFlow=false">Create mode: new page</a>

$ vi invoice-sitemap.xmap
			<map:match type="regexp" pattern="^invoice-multiline_(edit|create)$">
				<map:act type="invoiceMultiLineForm"/>
				<map:read mime-type="text/html" type="jsp" src="jsp/invoice-multiline_edit.jsp"/>
			</map:match>

Tantely explained me that ISB-279 cannot be resolved. In 2013.04 she has programmed a warning when the issue should happen. I must be merged into the trunk. So I stop with this issue.



/ click Save and Next Page	, of Save	,
<input type="button" id="saveAndCloseBtn" value="Save and Next page" onclick=" theEditFormFormManager.submit('../invoice/invoice-multiline_save', true, '-1'); return false;">
<input type="button" name="saveBtn" id="saveBtn" value="Save" onclick=" theEditFormFormManager.submit('../invoice/invoice-multiline_save', false, 0);">


isbscs4=# insert into invoice_detail values(27128429,'2015-07-22 12:05:22.618',27128130,200,42,'HIGH',27125923,26595322,1,'',0,'',0,null,null,null,null,'HIGH','');


/ Als er fouten zijn in de totals, verschijnt 'Invoice amount totals' niet rechtsboven, maar links onder 'Booking dates'	,

/ Als er fouten zijn in checkTotals, kunnen we wel een detail add	,
/ TODO


/ VOLGENDE KEER	,
/ See LOG_6_OCT_2015.txt



















/////////////////////////////////////

/ Intermezzo

/ 7	. 

/ de SetFormTagVO heeft 

/ click Edit op een invoiceline	,
/ in de cocoon action wordt de model van het form, het valueobject, create met new 	,
/ wanneer wordt de FormTag create?
/ TODO
/ in FormTag.endTag wordt in session set key=theContinuationId + "_form", value=FormTag

/ click save	, 
/ FormTag myTag = (FormTag) getSession().getAttribute(getContinuationId() + "_form");
/ WH is save een ander request dan edit	, dus moet via session	,
/ TODO
/ dan via validate wordt valueobject uit FormTag queried	,

/ op invoice-multiline_edit.jsp is een apart form	, op  invoice-header_edit.jsp is ook een form	,

/ in HTML zit het invoice-multiline_edit-form in een iframe,	 de hidden fields daarin komen WH daarom NIET in invoice-header_edit-form	,

/ 7	. 

/ edit	,
/ de cocoon action set valueobject in getRequest().getAttribute("formVO")
/ dan wordt de jsp exec	, daarin staat <mpo:setFormVO valueObject="${formVO}">, dus de SetFormVOTag.setValueObject sets de valueobject in zichzelf	, en later SetFormVOTag.doStartTag doet: 	getForm().addValueObject(getValueObject());, dus die pakt de valueobject uit zichzelf (zojuist set), en set hem in de FormTag	,

/ TODO

/ 7	.

BoundSaveAction.class
	public FormTag getForm() {
			FormTag myTag = (FormTag) getSession().getAttribute(getContinuationId() + "_form");
			getRequest().setAttribute("form", theFormTag);
/ TODO 

/ Einde Intermezzo

//////////////////////////////////////////

/ continue	,
InvoiceMultiLineSaveAction.handleSave() line: 52	
		InvoiceMultiLineVO myVO = (InvoiceMultiLineVO) getValueObject();
myVO	InvoiceMultiLineVO  (id=23336)	

		InvoiceHeaderUtil.getInvoiceHeaderService().saveMultiLine(myInvoiceHeaderSystemId, myRepairInvoice, myVO);

/ Einde DEBUG ISB-729

/ JSP (PCT-472)

[eric@localhost tmp]$ pnl-scp-a.sh pnllogistics/conf/language_en_GB_pnllogistics.properties
[eric@localhost tmp]$ cp language_en_GB_pnllogistics.properties /home/eric/Devel/Java/Eclipse/eclipse-jee/workspace/trunk/base-framework/core/conf
/ refresh trunk in eclipse  ,

/ planning, shipment order , search	,
/ = shipment-order_list

$ vi oms-sitemap.xmap
			<map:match pattern="shipment-order_list">
				<map:act type="shipmentOrderList"/>			
				<map:call resource="dynatablePage">
					<map:parameter name="xsp" value="xsp/shipment-order_list.xml"/>
				</map:call>
			</map:match>

/ click filter button	, we vallen in 	,
$ vi ShipmentOrderDaoImpl.java
	@Override
	public List<ShipmentOrderVO> executeDynaQuery(DynaQuery aQuery) throws ShipmentOrderException {
		String mySql = aQuery.toSQL();
/s
$ vi DynaQuery.java
	/** Creates the SQL statement dynamically */
	public String toSQL() {
		...
/ processes de #'s	, filters	, 
/ TODO

/ 7	. 

/ we edit SH000002441

/ we vallen in 	,
$ vi shipment-order_edit.jsp	,
	<mpo:form name="shipmentorder" action="shipment-order_save" entity="shipmentOrder" readOnly="${readOnly}">
/s
/ self created ctor	,
	public FormTag() {
		boolean b = false;
	}



/c
/ we zijn nog steeds in	,
$ vi shipment-order_edit.jsp	,
	<mpo:form name="shipmentorder" action="shipment-order_save" entity="shipmentOrder" readOnly="${readOnly}">
/s
FormTag.doStartTag() line: 246	
		if (StringUtils.isNotEmpty(getDestionationAttribute())) {
/= theDestinationAttribute="form"
			getRequest().setAttribute(getDestionationAttribute(), this);

/ dus hier wordt het "form" attr set op de request	, 

/ Deze wordt later weer queried	, 
    InvoiceMultiLineSaveAction(BoundSaveAction).getForm() line: 168
        if (theFormTag == null) {
            theFormTag = (FormTag) getRequest().getAttribute("form");
/ In SetFormTagVO.class	,
	public FormTag getForm() {
		if (theFormTag == null) {
			if (getRequest() != null && getRequest().getAttribute(FormTag.DEFAULT_DESTINATION_ATTRIBUTE) instanceof FormTag) {
"form"
				theFormTag = (FormTag) getRequest().getAttribute(FormTag.DEFAULT_DESTINATION_ATTRIBUTE);
/ Maar dit is toch een ander request	?
/ TODO

/c
					<mpo:setFormVO valueObject="${formVO}">
/s
SetFormVOTag.<init>() line: 45	

/c
SetFormVOTag.setValueObject(EntityInterface) line: 201	
		theValueObject = aVO;
aVO	ShipmentOrderVO_$$_javassist_139  (id=23188)	



/ Waar komt deze vandaan	?

/ Intermezzo

/ we clicked in de list van sho's  SH000002441

/ Voor IEDERE sho in de list wordt	,
/ TODO 

ShipmentOrderEditAction(AbstractAction).act(Redirector, SourceResolver, Map, String, Parameters) line: 171	
				Map myMap = act();
/s
ShipmentOrderEditAction.act() line: 38	
		int myShipmentOrderId = getSystemIdFromRequest();
		ShipmentOrderVO myShipmentOrder = ShipmentOrderUtil.getShipmentOrderFacadeLocal().getShipmentOrder(myShipmentOrderId);
/s
ShipmentOrderServiceImpl.getShipmentOrder(int) line: 1005	
		return shipmentOrderDao.getBySystemId(aSystemId);
/s
ShipmentOrderDaoImpl(GenericHibernateDAO).getBySystemId(int) line: 297	
				return type.cast(getHibernateTemplate().load(type, aSystemId));
/c
ShipmentOrderVO_$$_javassist_139(ShipmentOrderVO).<init>() line: 320	
	public ShipmentOrderVO() {

	}
/t
ShipmentOrderEditAction.act() line: 44	
		if (myShipmentOrder.getFromPartyVO() == null) {
/s
/ initializes the proxy	, so again the constructor	,
ShipmentOrderVO.<init>() line: 320	


/ Einde Intermezzo

/c
SetFormVOTag.doStartTag() line: 95	

/c
						<mpo:listField name="organization" type="organization" required="true" />
/s
ListFieldTag(FieldTag).setParent(Tag) line: 772	
/=
	public void setParent(Tag aTag) {
aTag	SetFormVOTag  (id=28719)	
/ clone
/ TODO

/ 13	.

/ we click Save op de sho	,
<input type="button" value="Save" onclick="document.getElementById('selectPath').value='yes'; theShipmentorderFormManager.submit('../oms/shipment-order_save', false, 0);">

$ vi oms-sitemap.xmap
          <map:match pattern="shipment-order_save">
				<map:act type="shipmentOrderSave">
                    <map:parameter name="isSave" value="true"/>
                </map:act>
/s
ShipmentOrderSaveAction(AbstractSaveAction).act() line: 64	
		validate();
/s
		super.validate();
/s
ShipmentOrderSaveAction(BoundSaveAction).validate() line: 218	
			Collection myValidationFields = getForm().getValidateAbleFields();
/s
ShipmentOrderSaveAction(BoundSaveAction).getForm() line: 170	
		if (theFormTag == null) {
			theFormTag = (FormTag) getRequest().getAttribute("form");
null
		}
		if (theFormTag == null) {
			FormTag myTag = (FormTag) getSession().getAttribute(getContinuationId() + "_form");
			...
			theFormTag = myTag;
			getRequest().setAttribute("form", theFormTag);

/t
ShipmentOrderSaveAction(ShipmentOrderSaveAction).handleSave() line: 65	
			// The parameter has to be fetched here otherwise it'll be lost
			for (Enumeration myParams = getRequest().getParameterNames(); myParams.hasMoreElements();) {
				myParameter = (String) myParams.nextElement();
				if (myParameter.startsWith(ShipmentItemCopyAction.NUM_COPIES_ITEM_ATTR)) {
					// Cannot use request
					String myParameterValue = getRequest().getParameter(myParameter);
/ 1 keer	,
/ TODO
					if (StringUtils.isNotEmpty(myParameterValue)) {
						getSession().setAttribute(myParameter, myParameterValue);
					}
				}
			}
			ShipmentOrderVO myVO = (ShipmentOrderVO) getValueObject();
/s
ShipmentOrderSaveAction(BoundSaveAction).getValueObject() line: 197	
		return getFetchedData().iterator().next();
/s
ShipmentOrderSaveAction(BoundSaveAction).getFetchedData() line: 119	
			if (theFetchedData == null) {
				Collection<DataFetchable> myFetchFields = getForm().getDataFetchableFields();

rganization,  orderProcess,  shipmentOrderId,  orderStatus,  customerStatusVO.status,  holdStatus,  shipmentType,  requestedServiceLevel,  actualServiceLevel,  reasonCode,  systemEntryDate,  lastUpdate,  requestedStartAfter,  requestedStartBefore,  requestedEndAfter,  requestedEndBefore,  plannedStartAfter,  plannedEndAfter,  reference1,  reference2,  reference4,  reference5,  createdBy,  notifyTo,  requestedTotalColli,  requestedTotalItems,  requestedTotalWeightKg,  requestedTotalVolumeM3,  requestedTotalLoadingMeters,  emission,  requestedTotalValue,  valueCurrency,  cashOnDelivery,  cashOnDeliveryCurrency,  CashOnDeliveryDone,  incoTerm,  incoTermVersion,  incotermsReference,  dangerousGoodsYn,  reference3,  salesOrganization,  reference6,  reference7,  reference8,  reference9,  reference10,  customerOrderNumber,  preferedParty,  remarks,  remarks2, EilandToeslag value, DefaultWeight value, LabelNodig value, BarcodeHold value, DuplicateHold value, ColloHoldChecked value, TotaalADRPuntenAantal value, ProductKenmerkSoort value, OptieSoort value, TijdsVenster value, ShipFromOpmerkingen value, ShipToOpmerkingen value, OntvangenBedragCash amount, OntvangenBedragCash currency, Klantreferentie value, ShipmentReferentieNo value, KlantSpecifiek value, Checked value, Goedgekeurd value,  syncFromFlag,  fromParty, from name, from name2, from address, from address2, from city, from postalCode, from regionState, from country, from phoneNumber, from faxNumber, from emailAddress, from contactName, from reference1, from reference2, from reference3, from reference4, from reference5, from reference6,  syncToFlag,  toParty, to name, to name2, to address, to address2, to city, to postalCode, to regionState, to country, to phoneNumber, to faxNumber, to emailAddress, to contactName, to reference1, to reference2, to reference3, to reference4, to reference5, to reference6,  syncBillToFlag,  billToParty, billTo name, billTo name2, billTo address, billTo address2, billTo city, billTo postalCode, billTo regionState, billTo country, billTo phoneNumber, billTo faxNumber, billTo emailAddress, billTo contactName, DistributionDepot syncFlag, DistributionDepot Party, DistributionDepot name, DistributionDepot name2, DistributionDepot address, DistributionDepot address2, DistributionDepot city, DistributionDepot postalCode, DistributionDepot regionState, DistributionDepot country, DistributionDepot phoneNumber, DistributionDepot faxNumber, DistributionDepot emailAddress, DistributionDepot contactName, CollectionDepot syncFlag, CollectionDepot Party, CollectionDepot name, CollectionDepot name2, CollectionDepot address, CollectionDepot address2, CollectionDepot city, CollectionDepot postalCode, CollectionDepot regionState, CollectionDepot country, CollectionDepot phoneNumber, CollectionDepot faxNumber, CollectionDepot emailAddress, CollectionDepot contactName, productItem systemId, productItem product, productItem productId, productItem customerOrderLine, productItem customerOrderLineSystemId, productItem description, productItem quantity, productItem actualQuantity, productItem weightKg, productItem totalVolumeM3, productItem customsNumber, productItem individualItemValue, productItem valueCurrency, productItem partNumber, productItem productModel, productItem productSeries, productItem productGroup, productItem productOwner, productItem countryOfOrigin, productItem reference2, productItem reference3, productItem reference4, productItem reference5, TunnelCd value, VerpakkingsGrpOmschr value, TransportCategorieCd value, ADRPuntenAant value, SubsidiaryRiskLabel[1] value, SubsidiaryRiskLabel[2] value, SubsidiaryRiskLabel[3] value, MinTemp value, MaxTemp value, productItem requestedAdrCode, productItem actualAdrCode, productItem requestedUnNumber, productItem actualUnNumber, productItem flashpoint, productItem packagingGroup, productItem remarks, shipmentItemList26820566 volumeM3, shipmentItem systemId, shipmentItem shipmentItemId, shipmentItem shippingUnit, shipmentItem reference1, shipmentItem reference2, shipmentItem reference3, shipmentItem labelInfo, shipmentItem containerNumber,  lengthM,  widthM,  heightM,  volumeM3, shipmentItem weightKg, shipmentItem totalLdm, shipmentItem stackable, shipmentItemPackedItems0 productItemVO.description, shipmentItemPackedItems0 productItemVO.quantity, shipmentItemPackedItems0 productItemVO.nonPackedQuantity, shipmentItemPackedItems0 quantity, shipmentItemPackedItems0 actualQuantity]

						myDataFetchable.fetchData();
/s
ListFieldTag.fetchData() line: 117	
			String myCode = getValueFromRequest(getFormFieldName());
/ getFormFieldName()=getName()=name="organization"
/s
		return getRequest().getParameter(aName);
/t
myCode="PNL-CARGO"
				UniqueFieldValueObject myVO = VOReflectionInvoker.getValueAsUniqueVO(getActiveValueObject(), getName());
/s
ListFieldTag(FieldTag).getActiveValueObject() line: 386	
			myRet = getActiveValueObjectHolder().getActiveValueObject();
/ getActiveValueObjectHolder()=SetFormVOTag
/s
SetFormVOTag.getActiveValueObject() line: 127	
		return getValueObject();
/= 	theValueObject;
theValueObject	ShipmentOrderVO_$$_javassist_139  (id=23866)	

/t
ListFieldTag.fetchData() line: 133	
				UniqueFieldValueObject myVO = VOReflectionInvoker.getValueAsUniqueVO(getActiveValueObject(), getName());
/d
myVO	Organization  (id=30705)	
					myCurrentCode = myVO.getCode();
myCurrentCode	"PNL-CARGO" (id=30751)	
						} else {
							myValue = proxy.getByCode(getType(), getFilter(), myCode);
myValue	Organization  (id=30705)	
							VOReflectionInvoker.setUniqueFieldValue(getActiveValueObject(), getName(), myValue);

/c
ShipmentOrderSaveAction(ShipmentOrderSaveAction).handleSave() line: 95	
			} else {
				...
				ShipmentOrderVO myOldVO = shipmentOrderService.getShipmentOrder(myVO.getSystemId());
/s
ShipmentOrderServiceImpl.getShipmentOrder(int) line: 1005	
		return shipmentOrderDao.getBySystemId(aSystemId);
/s
ShipmentOrderVO_$$_javassist_139(ShipmentOrderVO).<init>() line: 320	

/ JSP (PCT-472)

/ PCT-472

/ 7	. 

/ we zien alles onder de "Shipment items" tab	, (naast de "Product items" tab bijvoorbeeld)	,


/ open SH000002461, of SH000002441

$ vi shipment-order_edit.jsp

<div id="shipmentOrderChilds">
			<div id="shipmentOrderChildsTabCollection" class="tabCollection">
				<ul class="tabList" id="shipmentOrderChildsTabList">...</ul>				/ alle tabs op een rij	,
				<div id="productItemsTab" class="tab active">...</div>						/ panel onder de "Shipment items" tab, wat een <li/> is met een <a/> erin	,
				<div id="shipmentItemsTab" class="tab active">								/ panel onder de "Shipment items" tab, wat een <li/> is met een <a/> erin	,
				
	<table class="list">...</table>															/  Actions 		, in SH000002461 multiple rows	,

	<a href="#" id="createShipmentItemBtn" class="hidden"> Create Shipment item 			/ de link die hidden wordt als clicked, het panel hieronder is shown dan	,
	</a>

	<div id="shipmentItemForm" class="">
		<!--/ fields bount to class com.mpobjects.oms.control.shipmentorder.ShipmentItemFormBean(systemid:0)\-->
		<!--\ end of binding toclass com.mpobjects.oms.control.shipmentorder.ShipmentItemFormBean(systemid:0)/-->
		<!--/ fields bount to class com.mpobjects.oms.model.shipmentorder.vo.ShipmentItemVO(systemid:0)\-->

			<div id="shipment-itemTabCollection" class="tabCollection">

					
				<!--?xml version="1.0" encoding="UTF-8"?-->
<ul class="tabList" id="shipment-itemTabList">
    <li class="active" id="shipmentItemTabBtn">
        <a class="show">ShipmentItem</a>
    </li>
</ul>


				<div id="shipmentItemTab" class="tab active">

					<h3>
						
							
								Create Shipment item
							
							
						
					</h3>
					<table>
						<tbody><tr>
							<td>
								<table>
									<input type="hidden" name="shipmentItemSystemId" id="shipmentItemSystemId" value="0">
									<tbody><tr><td class="label">Shipm Item id</td><td nowrap="nowrap" class="input"><span id="shipmentItemShipmentItemId_div"><input type="text" name="shipmentItemShipmentItemId" id="shipmentItemShipmentItemId" size="20" maxlength="250" value="" readonly="readonly" class="fieldInput readOnly "></span></td></tr>

...
									<tr><td class="label">Addition</td><td nowrap="nowrap" class="input"><span id="shipmentItemReference1_div"><input type="text" name="shipmentItemReference1" id="shipmentItemReference1" size="20" maxlength="250" value="" class="fieldInput"></span></td></tr>

									
										<tr><td class="label">Area</td><td nowrap="nowrap" class="input"><span id="shipmentItemReference2_div"><input type="text" name="shipmentItemReference2" id="shipmentItemReference2" size="20" maxlength="250" value="" class="fieldInput"></span></td></tr>

									
									
										<tr><td class="label">Department</td><td nowrap="nowrap" class="input"><span id="shipmentItemReference3_div"><input type="text" name="shipmentItemReference3" id="shipmentItemReference3" size="20" maxlength="250" value="" class="fieldInput"></span></td></tr>

...									


/ Hoe doet JSP dat	?

$ vi shipment-order_edit.jsp

<%@taglib prefix="tmstags" tagdir="/WEB-INF/tags/oms/"%>

		<div id="shipmentOrderChilds">
			<mpo:tabCollection name="shipmentOrderChilds" defaultTab="${!empty shipmentOrderChildsTab ? shipmentOrderChildsTab : cf:property('oms', 'shipmentorder.shipmentorderchildstabdefault', 'productItems')}">
				<mpo:tabList>
					<c:if test="${cf:property('oms', 'shipmentorder.hide.productitems', 'false')=='false'}">
						<mpo:defineTab name="productItems" />
					</c:if>
					<c:if test="${!empty formVO.shipmentItemList or true}">
						<mpo:defineTab name="shipmentItems" />
					</c:if>
				</mpo:tabList>

				<c:if test="${cf:property('oms', 'shipmentorder.hide.productitems', 'false')=='false'}">
					<mpo:tab name="productItems">
						<tmstags:sho-productitems />
					</mpo:tab>
				</c:if>

				<c:if test="${!empty formVO.shipmentItemList or true}">
					<mpo:tab name="shipmentItems">
						<tmstags:sho-shipmentitems />
					</mpo:tab>
				</c:if>

/ 13	. 

$ vi TabCollectionTag.java
	public int doStartTag() {
		String myId = getName() + "TabCollection";
		...

/13	. 
						<tmstags:sho-shipmentitems />

[eric@localhost trunk]$ vi ./module/oms/war/WEB-INF/tags/oms/sho-shipmentitems.tag 

<able class="list">
/ 	de list van actions

	<c:set var="myFirst" value="true" />
	<c:forEach var="currentItem" items="${formVO.flattenedShipmentItems}">
		<c:if test="${myFirst == 'true'}">
			<tr>
				<th><mpo:label name="actions" entity="shipmentitem" /></th>
/ de headers	,
		</c:if>
		<c:set var="shipmentItemList" value="${currentItem.shipmentItemVO}" />
		<mpo:setFormVO valueObject="${shipmentItemList}" prefix="shipmentItemList${shipmentItemList.systemId}">
						<c:if test="${!form.formReadOnly}">
							<mpo:action name="edit" entity="shipmentItem" />

/ we zien dus dat shipmentItemList een alias is voor currentItem.shipmentItemVO	, je use hem meteen	, 
/ Met <mpo:setFormVO/> wordt de value object reset	, zodat de eerst volgende property, edit, daarin wordt get/set	,

	<a href="#" id="createShipmentItemBtn"> <mpo:label name="createShipmentItem" />
	</a>
/ de button	,
...
			<table>
					<mpo:setFormVO valueObject="${shipmentItemBean.shipmentItem}" prefix="shipmentItem">
						<mpo:numberField name="systemId" type="int" hidden="true" />
						<mpo:field name="shipmentItemId" readOnly="true" hidden="create" />
						<mpo:listField type="shippingUnit" name="shippingUnit" required="true" />
						<c:if test="${cf:property('oms', 'shipmentitem.quantity.hidden', 'true')=='false'}">
							<mpo:numberField name="quantity" type="int"/>
						</c:if>
						<c:if test="${cf:property('oms', 'shipmentitem.casenumber.hidden', 'false')=='false'}">
							<mpo:field name="caseNumber" />
						</c:if>
						<mpo:field name="reference1" />
						<c:if test="${cf:property('oms', 'shipmentitem.casenumber.reference2.hidden', 'false')=='false'}">
							<mpo:field name="reference2" />
						</c:if>
						<c:if test="${cf:property('oms', 'shipmentitem.casenumber.reference3.hidden', 'false')=='false'}">
							<mpo:field name="reference3" />
						</c:if>

/ FIX PCT-472

pnllogistics.table_shipment_order_organization

/ rm b 149: SetFormVOTag.getForm(){
				theFormTag = (FormTag) getRequest().getAttribute(FormTag.DEFAULT_DESTINATION_ATTRIBUTE);

/ rm b 135: AbstractAction.act

/ rm b 94: SetFormVOTag.doStartTag
/ rm b 45: SetFormVOTag.<init>

/ rm b 17 DefineTabTag.doStartTag
/ rm b 27 TabTag.doStartTag

/ rm b 230 FormTag.doEndTag

/ we zien in  JSP
[eric@localhost trunk]$ vi ./module/oms/war/WEB-INF/tags/oms/sho-shipmentitems.tag 
						<mpo:field name="reference1" />
							<mpo:field name="reference2" />
							<mpo:field name="reference3" />

/ we moeten in de language file name use	, NIET wat we zien in HTML	, shipmentItemReference1	, 
/ TODO (shipmentItemReference1 ) 

$ vi language_en_GB_pnllogistics.properties

pnllogistics.table_shipment_order_reference1=3S Barcode
pnllogistics.table_shipment_order_reference2=Europlate
pnllogistics.table_shipment_order_reference3=Europlate org

/ Einde FIX-472

/ PCT-470

/ 13	.

/ configuration, master data, entity detail types
EntityDetailTypePage	, wicket	,
/ kies onder entity :	SHIPMENT_ITEM,
/ click Filter	,
/ we zien een aantal entity details	, 
/ deze moeten we ook zien in de JSP als we een shipment item create	,

/ 13	. 

/ we click filter	, 

 /we zien in postgres log	,

LOG:  execute S_1: COMMIT
LOG:  execute <unnamed>: BEGIN
LOG:  execute <unnamed>: 
select count(*) as y0_ 
from ENTITY_DETAIL_TYPE this_ 
where this_.organization_Systemid in (
	select uo.organization_systemid 
	from user_organization uo 
	where uo.user_systemid = $1) 
and this_.IS_DELETED=$2 
and this_.ENTITY=$3
DETAIL:  parameters: $1 = '26682479', $2 = 'f', $3 = 'SHIPMENT_ITEM'
LOG:  execute S_1: COMMIT

LOG:  execute <unnamed>: BEGIN
LOG:  execute <unnamed>: 
select this_.SYSTEM_ID as SYSTEM1_56_0_, this_.IS_DELETED as IS2_56_0_, this_.NAME as NAME56_0_, this_.ALLOWED_VALUES
 as ALLOWED4_56_0_, this_.VALUE_TYPE as VALUE5_56_0_, this_.ENTITY as ENTITY56_0_, this_.ORGANIZATION_SYSTEMID as ORGANIZA7_56_0_, this_.GROUP
_SYSTEMID as GROUP8_56_0_, this_.REQUIRED as REQUIRED56_0_, this_.READ_ONLY as READ10_56_0_, this_.CONFIG as CONFIG56_0_, this_.RANK as RANK56
_0_, this_.VISIBILITY as VISIBILITY56_0_ 
from ENTITY_DETAIL_TYPE this_ 
where this_.organization_Systemid in (
	select uo.organization_systemid 
	from user_organization uo 
	where uo.user_systemid = $1) 
and this_.IS_DELETED=$2 
and this_.ENTITY=$3 
order by this_.NAME asc limit $4
DETAIL:  parameters: $1 = '26682479', $2 = 'f', $3 = 'SHIPMENT_ITEM', $4 = '8'
LOG:  execute S_1: COMMIT

/ we doen zelf	,

pnllogistics=# select*from entity_detail_type where entity='SHIPMENT_ITEM';
 system_id | is_deleted |         name         | value_type |    entity     | organization_systemid | read_only | config | rank | required | vis
ibility | allowed_values | group_systemid 
-----------+------------+----------------------+------------+---------------+-----------------------+-----------+--------+------+----------+----
--------+----------------+----------------
  26684155 |          0 | UpNetwPartnerRefNr   | STRING     | SHIPMENT_ITEM |                   500 | EDIT      |        |   10 |        0 |    
        |                |       26682268
  26684157 |          0 | UpVerzRefNr          | STRING     | SHIPMENT_ITEM |                   500 | EDIT      |        |   30 |        0 |    
        |                |       26682268
  26684158 |          0 | DownVerzRefNr        | STRING     | SHIPMENT_ITEM |                   500 | EDIT      |        |   40 |        0 |    
        |                |       26682268
  26684159 |          0 | UpVerzBarCd          | STRING     | SHIPMENT_ITEM |                   500 | EDIT      |        |   50 |        0 |    
        |                |       26682268
  26684160 |          0 | DownVerzBarCd        | STRING     | SHIPMENT_ITEM |                   500 | EDIT      |        |   60 |        0 |    
        |                |       26682268
  26819966 |          0 | InfoGeadr            | STRING     | SHIPMENT_ITEM |                   500 | EDIT      |        |   70 |        0 |    
        |                |       26682268
  26819998 |          0 | ExtRef               | STRING     | SHIPMENT_ITEM |                   500 | EDIT      |        |   80 |        0 |    
        |                |       26682268
  26684156 |          0 | DownNetwPartnerRefNr | STRING     | SHIPMENT_ITEM |                   500 | EDIT      |        |   20 |        0 |    
        |                |       26682268
(8 rows)

isbscs4=# \d entity_detail_type;
              Table "public.entity_detail_type"
        Column         |          Type           | Modifiers 
-----------------------+-------------------------+-----------
 system_id             | integer                 | not null
 is_deleted            | smallint                | 
 name                  | character varying(50)   | 
 value_type            | character varying(20)   | 
 entity                | character varying(50)   | 
 organization_systemid | integer                 | 
 read_only             | character varying(100)  | 
 config                | character varying(255)  | 
 rank                  | integer                 | 
 required              | smallint                | default 0
 visibility            | character varying(255)  | 
 allowed_values        | character varying(2000) | 
 group_systemid        | integer                 | 
Indexes:
    "lo_detail_type_pk" PRIMARY KEY, btree (system_id)
Foreign-key constraints:
    "edt_group_fk" FOREIGN KEY (group_systemid) REFERENCES entity_detail_type_group(system_id)
    "lo_organization_fk" FOREIGN KEY (organization_systemid) REFERENCES organization(system_id)
Referenced by:
    TABLE "customer_contract_detail" CONSTRAINT "ccd_edt_fk" FOREIGN KEY (edt_systemid) REFERENCES entity_detail_type(system_id)
    TABLE "customer_order_detail" CONSTRAINT "cod_edt_fk" FOREIGN KEY (edt_systemid) REFERENCES entity_detail_type(system_id)
    TABLE "customer_order_line_detail" CONSTRAINT "cold_edt_fk" FOREIGN KEY (edt_systemid) REFERENCES entity_detail_type(system_id)
    TABLE "ctp_resource_detail" CONSTRAINT "crd_edt_fk" FOREIGN KEY (edt_systemid) REFERENCES entity_detail_type(system_id)
    TABLE "container_detail" CONSTRAINT "ctd_edt_fk" FOREIGN KEY (edt_systemid) REFERENCES entity_detail_type(system_id)
    TABLE "party_detail" CONSTRAINT "par_edt_fk" FOREIGN KEY (edt_systemid) REFERENCES entity_detail_type(system_id)
    TABLE "product_item_detail" CONSTRAINT "pid_edt_fk" FOREIGN KEY (edt_systemid) REFERENCES entity_detail_type(system_id)
    TABLE "product_detail" CONSTRAINT "prd_edt_fk" FOREIGN KEY (edt_systemid) REFERENCES entity_detail_type(system_id)
    TABLE "supplier_contract_detail" CONSTRAINT "scd_edt_fk" FOREIGN KEY (edt_systemid) REFERENCES entity_detail_type(system_id)
    TABLE "shipment_order_detail" CONSTRAINT "shod_edt_fk" FOREIGN KEY (edt_systemid) REFERENCES entity_detail_type(system_id)
    TABLE "shipment_item_detail" CONSTRAINT "sid_edt_fk" FOREIGN KEY (edt_systemid) REFERENCES entity_detail_type(system_id)
    TABLE "service_order_detail" CONSTRAINT "sod_edt_fk" FOREIGN KEY (edt_systemid) REFERENCES entity_detail_type(system_id)
    TABLE "subparty_detail" CONSTRAINT "subparty_detail_edt_systemid_fkey" FOREIGN KEY (edt_systemid) REFERENCES entity_detail_type(system_id)

/ 13	. 

/ Waar code als we op de filter button click?
/ WH
$ vi GenericListPanel.java
	protected void makeTable(List<IColumn> aColumnsList) {
		filterForm = new FilterForm("filterForm", dataProvider);

/ we debug	,

EntityDetailTypeSearchListPanel(GenericListPanel).<init>(String, BaseWebComponent, WebComponentEventSwitchBoard, BeanWrapper<BaseDAOInterface<T>>, int, TableDataProviderBuilder<T>, List<EntityGroupAction<T>>) line: 133	
		daoWrapper = aDaoWrapper;
com.mpobjects.view.wicket.util.BeanWrapper@5f7522e9[type=interface com.mpobjects.oms.dao.entitydetailtype.EntityDetailTypeDAO,beanName=<null>]

		initialize();
/s
EntityDetailTypeSearchListPanel(GenericListPanel).initialize() line: 238	
			tableDataProviderBuilder = getDefaultTableDataProviderBuilder();
/ TODO
		dataProvider = tableDataProviderBuilder.build(daoWrapper, getDefaultSortPropertyName());
/s
PrefilteredTableDataProvider$Builder.build(BeanWrapper<BaseDAOInterface<U>>, String) line: 61	
			PrefilteredTableDataProvider<U> myProvider = new PrefilteredTableDataProvider<U>(aDaoWrapper, aDefaultSortProperty);
			myProvider.setPrefilterParameters(parameterList);
[deleted false false EQ]
			return myProvider;

/t
EntityDetailTypeSearchListPanel(GenericListPanel).initialize() line: 304	

		IModel<String> filterColTitle = new IModel<String>() {
			protected IModel<String> filterOn = new ResourceModel("filter", "filter").wrapOnAssignment(GenericListPanel.this);
			...
		myColumnsList.add(new FilteredAbstractColumn(filterColTitle) {
			@Override
			public Component getFilter(final String componentId, final FilterForm form) {
				...
			@Override
			public void populateItem(final Item cellItem, final String componentId, final IModel model) {
				...
/ myColumnsList is nu 1 lang	,

		addFilterColumns(myColumnsList);
/ myColumnsList is nu 8 lang	,

		makeTable(myColumnsList);
/s
EntityDetailTypeSearchListPanel(GenericListPanel).makeTable(List<IColumn>) line: 446	
		objectDataTable = getMpoDataTable(aColumnsList);
		filterForm = new FilterForm("filterForm", dataProvider);
			objectDataTable.addTopToolbar(new FilterToolbar(objectDataTable, filterForm, dataProvider));
...
/ TODO

/ 7	.

/ we geven entity="SHIPMENT_ORDER"	,
pnllogistics=# select*from entity_detail_type where entity='SHIPMENT_ORDER';
 system_id | is_deleted |         name          | value_type |     entity     | organization_systemid | read_only | config | rank | required | v
isibility |              allowed_values              | group_systemid 
-----------+------------+-----------------------+------------+----------------+-----------------------+-----------+--------+------+----------+--
----------+------------------------------------------+----------------
  26684151 |          0 | Checked               | BOOLEAN    | SHIPMENT_ORDER |                   500 | EDIT      |        |   30 |        0 |  
          |                                          |       26682268
  26684152 |          0 | Goedgekeurd           | BOOLEAN    | SHIPMENT_ORDER |                   500 | EDIT      |        |   40 |        0 |  
          |                                          |       26682268
  26772526 |          0 | BarcodeHold           | BOOLEAN    | SHIPMENT_ORDER |                   500 | EDIT      | 1      |    2 |        0 |  
          |                                          |       26682268
  26772527 |          0 | ColloHoldChecked      | BOOLEAN    | SHIPMENT_ORDER |                   500 | EDIT      | 1      |    4 |        0 |  
          |                                          |       26682268
  26772528 |          0 | DuplicateHold         | BOOLEAN    | SHIPMENT_ORDER |                   500 | EDIT      | 1      |    3 |        0 |  
          |                                          |       26682268
  26684153 |          0 | ProductKenmerkSoort   | LIST       | SHIPMENT_ORDER |                   500 | FALSE     |        |    6 |        0 |  
          | ,118                                     |       26682268
  26774119 |          0 | DefaultWeight         | NUMBER     | SHIPMENT_ORDER |                   500 | TRUE      | 5      |    1 |        0 |  
          |                                          |       26682268
  26780756 |          0 | KlantSpecifiek        | REMARKS    | SHIPMENT_ORDER |                   500 | EDIT      |        |   24 |        0 |  
          |                                          |       26682268
  26684154 |          0 | OptieSoort            | LIST       | SHIPMENT_ORDER |                   500 | CREATE    |        |    7 |        0 |  
          | ,007,008,013,999                         |       26682268
  26734011 |          0 | EilandToeslag         | BOOLEAN    | SHIPMENT_ORDER |                   500 | TRUE      | 1      |    0 |        0 |  
          |                                          |       26682268
  26780826 |          0 | ShipmentReferentieNo  | REMARKS    | SHIPMENT_ORDER |                   500 | EDIT      |        |   23 |        0 |  
          |                                          |       26682268
  26684149 |          0 | OntvangenBedragCash   | AMOUNT     | SHIPMENT_ORDER |                   500 | EDIT      |        |   10 |        0 |  
          |                                          |       26682268
  26777671 |          0 | ShipToOpmerkingen     | REMARKS    | SHIPMENT_ORDER |                   500 | EDIT      |        |    9 |        0 |  
          |                                          |       26682268
  26780816 |          0 | Klantreferentie       | REMARKS    | SHIPMENT_ORDER |                   500 | EDIT      |        |   21 |        0 |  
          |                                          |       26682268
  26774375 |          0 | TotaalADRPuntenAantal | STRING     | SHIPMENT_ORDER |                   500 | TRUE      | 4      |    5 |        0 |  
          |                                          |       26682268
  26780820 |          1 | ShipToKlantreferentie | DISPLAY    | SHIPMENT_ORDER |                   500 | TRUE      |        |   22 |        0 |  
          |                                          |       26682268
  26684150 |          0 | OntvangenBedragPin    | AMOUNT     | SHIPMENT_ORDER |                   500 | EDIT      |        |   20 |        0 | f
alse      |                                          |       26682268
  26786350 |          0 | LabelNodig            | BOOLEAN    | SHIPMENT_ORDER |                   500 | EDIT      | 1      |    1 |        0 |  
          |                                          |       26682268
  26820283 |          0 | TijdsVenster          | LIST       | SHIPMENT_ORDER |                   500 | EDIT      |        |    7 |        0 |  
          | ,0800-1000,0800-1200,0800-1400,0800-1630 |       26682268
  26777672 |          0 | ShipFromOpmerkingen   | REMARKS    | SHIPMENT_ORDER |                   500 | EDIT      |        |    8 |        0 |  
          |                                          |       26682268
(20 rows)

/ we zien deze op shipment-order_edit.jsp onder 'Extra fields'	,
/ geef SH000002463	,

pnllogistics=# select shod.* from shipment_order_detail shod join shipment_order sho on shod.entity_systemid=sho.system_id where sho.shipment_order_id='SH000002463'; 
 entity_systemid | edt_systemid |         field_value         
-----------------+--------------+-----------------------------
        26822550 |     26684149 | 
        26822550 |     26684150 | 
        26822550 |     26684151 | 
        26822550 |     26684152 | 
        26822550 |     26684153 | 
        26822550 |     26684154 | 
        26822550 |     26734011 | 
        26822550 |     26772526 | 
        26822550 |     26772527 | 
        26822550 |     26772528 | 
        26822550 |     26774119 | 250
        26822550 |     26774375 | 
        26822550 |     26777671 | Opmerking Q3S7.3-11
        26822550 |     26777672 | Opmerking Q3S7.3-11
        26822550 |     26780756 | 
        26822550 |     26780816 | KlantOrderNummer: Q3S7.3-11
        26822550 |     26780826 | 
        26822550 |     26786350 | 
        26822550 |     26820283 | 
(19 rows)

pnllogistics=# select edt.* from shipment_order_detail shod join shipment_order sho on shod.entity_systemid=sho.system_id join entity_detail_type edt on shod.edt_systemid=edt.system_id where sho.shipment_order_id='SH000002463'; 
 system_id | is_deleted |         name          | value_type |     entity     | organization_systemid | read_only | config | rank | required | v
isibility |              allowed_values              | group_systemid 
-----------+------------+-----------------------+------------+----------------+-----------------------+-----------+--------+------+----------+--
----------+------------------------------------------+----------------
  26684149 |          0 | OntvangenBedragCash   | AMOUNT     | SHIPMENT_ORDER |                   500 | EDIT      |        |   10 |        0 |  
          |                                          |       26682268
  26684150 |          0 | OntvangenBedragPin    | AMOUNT     | SHIPMENT_ORDER |                   500 | EDIT      |        |   20 |        0 | f
alse      |                                          |       26682268
  26684151 |          0 | Checked               | BOOLEAN    | SHIPMENT_ORDER |                   500 | EDIT      |        |   30 |        0 |  
          |                                          |       26682268
  26684152 |          0 | Goedgekeurd           | BOOLEAN    | SHIPMENT_ORDER |                   500 | EDIT      |        |   40 |        0 |  
          |                                          |       26682268
  26684153 |          0 | ProductKenmerkSoort   | LIST       | SHIPMENT_ORDER |                   500 | FALSE     |        |    6 |        0 |  
          | ,118                                     |       26682268
  26684154 |          0 | OptieSoort            | LIST       | SHIPMENT_ORDER |                   500 | CREATE    |        |    7 |        0 |  
          | ,007,008,013,999                         |       26682268
  26734011 |          0 | EilandToeslag         | BOOLEAN    | SHIPMENT_ORDER |                   500 | TRUE      | 1      |    0 |        0 |  
          |                                          |       26682268
  26772526 |          0 | BarcodeHold           | BOOLEAN    | SHIPMENT_ORDER |                   500 | EDIT      | 1      |    2 |        0 |  
          |                                          |       26682268
  26772527 |          0 | ColloHoldChecked      | BOOLEAN    | SHIPMENT_ORDER |                   500 | EDIT      | 1      |    4 |        0 |  
          |                                          |       26682268
  26772528 |          0 | DuplicateHold         | BOOLEAN    | SHIPMENT_ORDER |                   500 | EDIT      | 1      |    3 |        0 |  
          |                                          |       26682268
  26774119 |          0 | DefaultWeight         | NUMBER     | SHIPMENT_ORDER |                   500 | TRUE      | 5      |    1 |        0 |  
          |                                          |       26682268
  26774375 |          0 | TotaalADRPuntenAantal | STRING     | SHIPMENT_ORDER |                   500 | TRUE      | 4      |    5 |        0 |  
          |                                          |       26682268
  26777671 |          0 | ShipToOpmerkingen     | REMARKS    | SHIPMENT_ORDER |                   500 | EDIT      |        |    9 |        0 |  
          |                                          |       26682268
  26777672 |          0 | ShipFromOpmerkingen   | REMARKS    | SHIPMENT_ORDER |                   500 | EDIT      |        |    8 |        0 |  
          |                                          |       26682268
  26780756 |          0 | KlantSpecifiek        | REMARKS    | SHIPMENT_ORDER |                   500 | EDIT      |        |   24 |        0 |  
          |                                          |       26682268
  26780816 |          0 | Klantreferentie       | REMARKS    | SHIPMENT_ORDER |                   500 | EDIT      |        |   21 |        0 |  
          |                                          |       26682268
  26780826 |          0 | ShipmentReferentieNo  | REMARKS    | SHIPMENT_ORDER |                   500 | EDIT      |        |   23 |        0 |  
          |                                          |       26682268
  26786350 |          0 | LabelNodig            | BOOLEAN    | SHIPMENT_ORDER |                   500 | EDIT      | 1      |    1 |        0 |  
          |                                          |       26682268
  26820283 |          0 | TijdsVenster          | LIST       | SHIPMENT_ORDER |                   500 | EDIT      |        |    7 |        0 |  
          | ,0800-1000,0800-1200,0800-1400,0800-1630 |       26682268
(19 rows)

{
SystemId:26774119	IsDeleted:false	Detail Type:DefaultWeight	ValueType:NUMBER	=250, 
SystemId:26772528	IsDeleted:false	Detail Type:DuplicateHold	ValueType:BOOLEAN	=0, 
SystemId:26780756	IsDeleted:false	Detail Type:KlantSpecifiek	ValueType:REMARKS	=, 
SystemId:26777671	IsDeleted:false	Detail Type:ShipToOpmerkingen	ValueType:REMARKS	=, 
SystemId:26684151	IsDeleted:false	Detail Type:Checked	ValueType:BOOLEAN	=0, 
SystemId:26734011	IsDeleted:false	Detail Type:EilandToeslag	ValueType:BOOLEAN	=, 
SystemId:26780816	IsDeleted:false	Detail Type:Klantreferentie	ValueType:REMARKS	=, 
SystemId:26772526	IsDeleted:false	Detail Type:BarcodeHold	ValueType:BOOLEAN	=0, 
SystemId:26786350	IsDeleted:false	Detail Type:LabelNodig	ValueType:BOOLEAN	=1, 
SystemId:26684153	IsDeleted:false	Detail Type:ProductKenmerkSoort	ValueType:LIST	=, 
SystemId:26684152	IsDeleted:false	Detail Type:Goedgekeurd	ValueType:BOOLEAN	=0, 
SystemId:26684154	IsDeleted:false	Detail Type:OptieSoort	ValueType:LIST	=, 
SystemId:26780826	IsDeleted:false	Detail Type:ShipmentReferentieNo	ValueType:REMARKS	=, 
SystemId:26684149	IsDeleted:false	Detail Type:OntvangenBedragCash	ValueType:AMOUNT	=0 , 
SystemId:26774375	IsDeleted:false	Detail Type:TotaalADRPuntenAantal	ValueType:STRING	=, 
SystemId:26777672	IsDeleted:false	Detail Type:ShipFromOpmerkingen	ValueType:REMARKS	=, 
SystemId:26684150	IsDeleted:false	Detail Type:OntvangenBedragPin	ValueType:AMOUNT	=, 
SystemId:26772527	IsDeleted:false	Detail Type:ColloHoldChecked	ValueType:BOOLEAN	=0}

/ 13	

$ vi shipment-order_edit.jsp

					<c:if test="${cf:property('oms', 'shipmentorder.entitydetails.location', 'up')=='up'}">
						<div class="up" id="entityDetails">
							<tmstags:entity-detail-list extraFieldList="${formVO.entityDetailsForDisplay}" process="${formVO.shipmentOrderProcess}" organization="${formVO.organizationSystemid}" />


[eric@localhost trunk]$ vi ./module/oms/war/WEB-INF/tags/oms/entity-detail-list.tag 

<c:forEach var="myEntry" items="${extraFieldList}">

/ de extraFieldList is def in shipment-order_edit.jsp in de call	,

/ we zien	,
public class ShipmentOrderVO extends LogisticsOrderVO implements CustomerStatusSupport, ReferenceSupport, Authorizable, ImportExportTrackable {
/s
public abstract class LogisticsOrderVO extends EntityDetailSupport implements PartyLookupContext {
/s
public abstract class EntityDetailSupport extends ResourceProtectedValueObject implements EntityDetailsHolder {
	public List<EntityDetailWrapper> getEntityDetailsForDisplay() {
		return MpoBeanFactory.getBean(EntityDetailService.class).getDisplayList(this);

/ we debug	,
$ vi shipment-order_edit.jsp
					<c:if test="${cf:property('oms', 'shipmentorder.entitydetails.location', 'up')=='up'}">
						<div class="up" id="entityDetails">
							<tmstags:entity-detail-list extraFieldList="${formVO.entityDetailsForDisplay}" process="${formVO.shipmentOrderProcess}" organization="${formVO.organizationSystemid}" />
/s
ShipmentOrderVO(EntityDetailSupport).getEntityDetailsForDisplay() line: 185	
		return MpoBeanFactory.getBean(EntityDetailService.class).getDisplayList(this);
...
/s
EntityDetailServiceImpl.getDisplayList(EntityDetailSupport) line: 52	
/=
	public List<EntityDetailWrapper> getDisplayList(EntityDetailSupport anEntityDetailSupport) {
/ anEntityDetailSupport=ShipmentOrderVO

		myCheckedList.putAll(anEntityDetailSupport.getEntityDetails());

/ 7	. 

/ local	, open SH000002461	,

/ edit shipment item 0001	, 

/ 7	. 

/ tabs Product items, Shipment items	, ...

$ vi shipment-order_edit.jsp

		<div id="shipmentOrderChilds">
			<mpo:tabCollection name="shipmentOrderChilds" defaultTab="${!empty shipmentOrderChildsTab ? shipmentOrderChildsTab : cf:property('oms', 'shipmentorder.shipmentorderchildstabdefault', 'productItems')}">
				<mpo:tabList>
					<c:if test="${!empty formVO.shipmentItemList or true}">
						<mpo:defineTab name="shipmentItems" />
					</c:if>

				<c:if test="${!empty formVO.shipmentItemList or true}">
					<mpo:tab name="shipmentItems">
						<tmstags:sho-shipmentitems />
					</mpo:tab>
				</c:if>

[eric@localhost trunk]$ less ./module/oms/war/WEB-INF/tags/oms/sho-shipmentitems.tag 

<table class="list">
	<c:forEach var="currentItem" items="${formVO.flattenedShipmentItems}">
		<c:set var="shipmentItemList" value="${currentItem.shipmentItemVO}" />
		<mpo:setFormVO valueObject="${shipmentItemList}" prefix="shipmentItemList${shipmentItemList.systemId}">
			<c:set var="index" scope="request" value="${(index+1)}" />
			<tr class="list${index %2}">
/ class="list0", class="list1"	, class="list0"	, ... voor zebra effect	, 

							<mpo:action name="edit" entity="shipmentItem" />
/ we zien in HTML	,
<button class="action formContext edit" href="shipment-item_edit?systemId=26822238&amp;base_sessionLevelOffset=1">
	<img src="../lookandfeel/styles/images/icons/check24.png" alt="Edit" title="Edit">
</button>

/ 13	. 

/ Hoe komt deze <button/> tot stand?

/ we vallen in	,
ActionTag.doStartTag() line: 114	
		} else {

			StringBuffer myOutput = new StringBuffer();
			renderAction(myOutput);
/s
ActionTag.renderAction(StringBuffer) line: 280	
		ActiveValueObjectHolder myValueObjectHolder = getActiveValueObjectHolder();
myValueObjectHolder	SetFormVOTag  (id=16528)	

		EntityInterface myVO = null;

		if (myValueObjectHolder != null) {
			myVO = myValueObjectHolder.getActiveValueObject();
myVO	ProductItemVO  (id=16647)	

		String myEntity = getEntity();
"productItem"
		String myFormattedAction = StringUtils.formatJavaToFile(getName()).toString();
"edit"
/ See <mpo:action name="edit" entity="shipmentItem" />	,

		myFormattedEntity = StringUtils.formatJavaToFile(myEntity).toString();
"product-item"

		} else {
			myUrl += myFormattedEntity + "_" + myFormattedAction;
product-item_edit
			} else {
				myUrl += "?systemId=" + myVO.getSystemId();
				if (StringUtils.isFalse(getDirect())) {
					myUrl += "&amp;base_sessionLevelOffset=1";
product-item_edit?systemId=26822237&amp;base_sessionLevelOffset=1

		anOutputBuffer.append("<button " + myTarget + " " + myJavascriptFunction + " class=\"" + myClass + "\" href=\"" + myUrl + "\">");
		anOutputBuffer.append(getActionLinkText().toString());
		anOutputBuffer.append("</button>");
<button   class="action formContext edit" href="product-item_edit?systemId=26822237&amp;base_sessionLevelOffset=1"><img src="../lookandfeel/styles/images/icons/check24.png" alt="Edit" title="Edit"/></button>

/ 13	. 

$ vi oms-sitemap.xmap

			<map:match pattern="shipment-item_edit">
				<map:act type="shipmentItemEdit"/>
				<map:read mime-type="text/html" type="jsp" src="jsp/shipment-order_edit.jsp"/>
			</map:match>

			<map:action logger="shipmentorder" name="shipmentItemEdit" src="com.mpobjects.oms.control.shipmentorder.action.ShipmentItemEditAction"/>

/ 13	. 

/ we lezen verder op	,

$ vi sho-shipmentitems.tag

<c:if test="${!empty shipmentItemBean.shipmentItem}">
	<div id="shipmentItemForm" class="${shipmentItemBean.shipmentItem.systemId == 0 && !shipmentItemBean.editBean && ! empty(formVO.shipmentItemList) ? 'hidden' : '' }">
		<mpo:setFormVO valueObject="${shipmentItemBean}" prefix="shipmentItem"></mpo:setFormVO>
/ TODO
		<mpo:setFormVO valueObject="${shipmentItemBean.shipmentItem}" prefix="shipmentItem">
			<mpo:tabCollection name="shipment-item" defaultTab="shipmentItem">
				<mpo:tabList>
					<mpo:defineTab name="shipmentItem" />
					<c:if test="${cf:property('oms', 'shipmentitem.cost.enabled', 'false')=='true'}">
						<mpo:defineTab name="shipmentItemCost" />
					</c:if>
				</mpo:tabList>

				<mpo:tab name="shipmentItem">
					<table>
						<tr>
							<td>
								<table>
									<mpo:numberField name="systemId" type="int" hidden="true" />
...

							<td><tmstags:entity-detail-list extraFieldList="${shipmentItemBean.shipmentItem.entityDetailsForDisplay}" process="${formVO.shipmentOrderProcess}"
									organization="${formVO.organizationSystemid}" /></td>

/ 13	. 

/ Ook	, vergl	, 

$ vi shipment-order_edit.jsp

						<div class="up" id="entityDetails">
							<tmstags:entity-detail-list extraFieldList="${formVO.entityDetailsForDisplay}" process="${formVO.shipmentOrderProcess}" organization="${formVO.organizationSystemid}" />
						</div>

/ ShipmentItemVO extends LogisticsOrderVO extends EntityDetailSupport	,
	public List<EntityDetailWrapper> getEntityDetailsForDisplay() {
		return MpoBeanFactory.getBean(EntityDetailService.class).getDisplayList(this);
	}

[eric@localhost trunk]$ less ./module/oms/war/WEB-INF/tags/oms/entity-detail-list.tag 


/ 13	. 

/ we open een shipment order	,

$ vi shipment-order_edit.jsp
							<tmstags:entity-detail-list extraFieldList="${formVO.entityDetailsForDisplay}" process="${formVO.shipmentOrderProcess}" organization="${formVO.organizationSystemid}" />
/s
ShipmentOrderVO(EntityDetailSupport).getEntityDetailsForDisplay() line: 185	
this=SHipmentOrderVO
		return MpoBeanFactory.getBean(EntityDetailService.class).getDisplayList(this);
/s
EntityDetailServiceImpl.getDisplayList(EntityDetailSupport) line: 52	
/=
	public List<EntityDetailWrapper> getDisplayList(EntityDetailSupport anEntityDetailSupport) {
/ anEntityDetailSupport=ShipmentOrderVO
		myCheckedList.putAll(anEntityDetailSupport.getEntityDetails());
/= 
ShipmentOrderVO's theEntityDetails
{
SystemId:26772528	IsDeleted:false	Detail Type:DuplicateHold	ValueType:BOOLEAN	=0, 
SystemId:26780756	IsDeleted:false	Detail Type:KlantSpecifiek	ValueType:REMARKS	=, 
SystemId:26780816	IsDeleted:false	Detail Type:Klantreferentie	ValueType:REMARKS	=KlantOrderNummer: 0707 TC5, 
SystemId:26772526	IsDeleted:false	Detail Type:BarcodeHold	ValueType:BOOLEAN	=0, 
SystemId:26777672	IsDeleted:false	Detail Type:ShipFromOpmerkingen	ValueType:REMARKS	=, 
SystemId:26684153	IsDeleted:false	Detail Type:ProductKenmerkSoort	ValueType:LIST	=, 
SystemId:26777671	IsDeleted:false	Detail Type:ShipToOpmerkingen	ValueType:REMARKS	=, 
SystemId:26820283	IsDeleted:false	Detail Type:TijdsVenster	ValueType:LIST	=, 
SystemId:26684154	IsDeleted:false	Detail Type:OptieSoort	ValueType:LIST	=, 
SystemId:26774375	IsDeleted:false	Detail Type:TotaalADRPuntenAantal	ValueType:STRING	=, 
SystemId:26780826	IsDeleted:false	Detail Type:ShipmentReferentieNo	ValueType:REMARKS	=, 
SystemId:26684150	IsDeleted:false	Detail Type:OntvangenBedragPin	ValueType:AMOUNT	=, 
SystemId:26772527	IsDeleted:false	Detail Type:ColloHoldChecked	ValueType:BOOLEAN	=0, 
SystemId:26774119	IsDeleted:false	Detail Type:DefaultWeight	ValueType:NUMBER	=750, 
SystemId:26734011	IsDeleted:false	Detail Type:EilandToeslag	ValueType:BOOLEAN	=, 
SystemId:26684151	IsDeleted:false	Detail Type:Checked	ValueType:BOOLEAN	=0, 
SystemId:26786350	IsDeleted:false	Detail Type:LabelNodig	ValueType:BOOLEAN	=1, 
SystemId:26684152	IsDeleted:false	Detail Type:Goedgekeurd	ValueType:BOOLEAN	=0, 
SystemId:26684149	IsDeleted:false	Detail Type:OntvangenBedragCash	ValueType:AMOUNT	=0 }

/c

/ 13	. 

/ we gaan naar shipment order, create	, 
/ zal worden	,
SH000002464
/ we zien een lege entity details form in de shipment order	,  


$ vi oms-menu.xml
	<m:add path="planning.shipmentOrder.create" actionUrl="oms/shipment-order-template_list?refresh=false" privilege="shipment-order-fast.create" index="2042" />

$ vi oms-sitemap.xmap
			<map:match pattern="shipment-order-template_list">
				<map:call resource="dynatablePage">
					<map:parameter name="xsp" value="xsp/shipment-order-template_list.xml"/>
					<map:parameter name="xsl" value="xsl/shipment-order-template_list.xsl"/>
				</map:call>
			</map:match>

$ vi shipment-order-template_list.xsl

       <td class="list" nowrap="nowrap">
            <a > 
            <xsl:attribute name="href"><xsl:value-of select="//shipment-order-create-url"></xsl:value-of><xsl:text>?systemid=</xsl:text><xsl:value-of 
                select="./column[@name='SYSTEMID']"/><xsl:text>&amp;base_sessionLevelOffset=1</xsl:text>
            </xsl:attribute><i18n:text>create.shipment.order</i18n:text> </a>
        </td>
/ link in row	, 

        <button type="button">
         	<xsl:attribute name="onclick">
         		<xsl:text>location.href='</xsl:text>
         		<xsl:value-of select="//shipment-order-create-url"></xsl:value-of>
         		<xsl:text>?systemid=0&amp;base_sessionLevelOffset=1'</xsl:text>
         	</xsl:attribute>
         	<i18n:text>create.new.order</i18n:text>
         </button>
/ button beneden	,

/ TODO //shipment-order-create-url

/ we zien in HTML shipment-order_create	,

$ vi oms-sitemap.xmap

			<map:match pattern="shipment-order_create">
				<map:act type="shipmentOrderCreate"/>
				<map:select type="session-attribute">
					<map:parameter name="attribute-name" value="builder"/>
					<map:when test="jsp">
						<map:read mime-type="text/html" type="jsp" src="jsp/shipment-order_edit.jsp"/>
					</map:when>
					<map:otherwise>
						<map:redirect-to uri="../wicket?module=oms&amp;wicketpage=shipmentorder.edit.ShipmentOrderEditSelectionPage"/>
					</map:otherwise>			
				</map:select>
			</map:match>

/ click button	,
/s
ShipmentOrderVO(EntityDetailSupport).getEntityDetailsForDisplay() line: 185	
		return MpoBeanFactory.getBean(EntityDetailService.class).getDisplayList(this);
/s
EntityDetailServiceImpl.getDisplayList(EntityDetailSupport) line: 52	
/s
	public Map<EntityDetailType, String> getEntityDetails() {
		return entityDetails;
{
SystemId:26774119	IsDeleted:false	Detail Type:DefaultWeight	ValueType:NUMBER	=, 
SystemId:26772528	IsDeleted:false	Detail Type:DuplicateHold	ValueType:BOOLEAN	=, 
SystemId:26780756	IsDeleted:false	Detail Type:KlantSpecifiek	ValueType:REMARKS	=, 
SystemId:26777671	IsDeleted:false	Detail Type:ShipToOpmerkingen	ValueType:REMARKS	=, 
SystemId:26684151	IsDeleted:false	Detail Type:Checked	ValueType:BOOLEAN	=, 
SystemId:26734011	IsDeleted:false	Detail Type:EilandToeslag	ValueType:BOOLEAN	=, 
SystemId:26820283	IsDeleted:false	Detail Type:TijdsVenster	ValueType:LIST	=, 
SystemId:26780816	IsDeleted:false	Detail Type:Klantreferentie	ValueType:REMARKS	=, 
SystemId:26772526	IsDeleted:false	Detail Type:BarcodeHold	ValueType:BOOLEAN	=, 
SystemId:26786350	IsDeleted:false	Detail Type:LabelNodig	ValueType:BOOLEAN	=, 
SystemId:26684153	IsDeleted:false	Detail Type:ProductKenmerkSoort	ValueType:LIST	=, 
SystemId:26684152	IsDeleted:false	Detail Type:Goedgekeurd	ValueType:BOOLEAN	=, 
SystemId:26684154	IsDeleted:false	Detail Type:OptieSoort	ValueType:LIST	=, 
SystemId:26774375	IsDeleted:false	Detail Type:TotaalADRPuntenAantal	ValueType:STRING	=, 
SystemId:26780826	IsDeleted:false	Detail Type:ShipmentReferentieNo	ValueType:REMARKS	=, 
SystemId:26684149	IsDeleted:false	Detail Type:OntvangenBedragCash	ValueType:AMOUNT	=, 
SystemId:26777672	IsDeleted:false	Detail Type:ShipFromOpmerkingen	ValueType:REMARKS	=, 
SystemId:26684150	IsDeleted:false	Detail Type:OntvangenBedragPin	ValueType:AMOUNT	=, 
SystemId:26772527	IsDeleted:false	Detail Type:ColloHoldChecked	ValueType:BOOLEAN	=}


/c
sho-productitems.tag line: 451	
					<tmstags:entity-detail-list extraFieldList="${productItemVO.entityDetailsForDisplay}" process="${formVO.shipmentOrderProcess}" organization="${formVO.organizationSystemid}"/>
/s
ProductItemVO(EntityDetailSupport).getEntityDetailsForDisplay() line: 185	
		return MpoBeanFactory.getBean(EntityDetailService.class).getDisplayList(this);
/s
EntityDetailServiceImpl.getDisplayList(EntityDetailSupport) line: 52	
		myCheckedList.putAll(anEntityDetailSupport.getEntityDetails());
/s
	public Map<EntityDetailType, String> getEntityDetails() {
this	ProductItemVO  (id=25267)	
		return entityDetails;
{
SystemId:26684143	IsDeleted:false	Detail Type:TunnelCd	ValueType:STRING	=, 
SystemId:26684145	IsDeleted:false	Detail Type:TransportCategorieCd	ValueType:STRING	=, 
SystemId:26684148	IsDeleted:false	Detail Type:MaxTemp	ValueType:NUMBER	=, 
SystemId:26822308	IsDeleted:false	Detail Type:SubsidiaryRiskLabel[3]	ValueType:STRING	=, 
SystemId:26822307	IsDeleted:false	Detail Type:SubsidiaryRiskLabel[2]	ValueType:STRING	=, 
SystemId:26684144	IsDeleted:false	Detail Type:VerpakkingsGrpOmschr	ValueType:STRING	=, 
SystemId:26822306	IsDeleted:false	Detail Type:SubsidiaryRiskLabel[1]	ValueType:STRING	=, 
SystemId:26684146	IsDeleted:false	Detail Type:ADRPuntenAant	ValueType:NUMBER	=, 
SystemId:26684147	IsDeleted:false	Detail Type:MinTemp	ValueType:NUMBER	=}

/ we zien verder NIETS	, 

/ Save de shipment order	, 

/ we zien  weer de ShipmentOrderVO's entityDetails	, en de ProductItem's entityDetails	,
/ maar NU ook de ShipmentItemVO's entityDetails , maar is {}	,
/ 
/ we zien ShipmentOrderVO(EntityDetailSupport).getEntityDetailsForDisplay() line: 185	
/ we zien ProductItemVO(EntityDetailSupport).getEntityDetailsForDisplay() line: 185	

/ Intermezzo

$ vi sho-shipmentitems.tag
									<mpo:setFormVO valueObject="${shipmentItemBean.shipmentItem}" prefix="shipmentItem">

/ wat is {shipmentItemBean	?

$ vi ShipmentItemView.java
	public static final String ACTIVE_SHIPMENTITEM = "shipmentItemBean";

$ vi ShipmentOrderEditAction.java
	public Map act() throws java.lang.Exception {
			getSession().setAttribute(ShipmentOrderView.ACTIVE_SHIPMENTORDER, myVO);

/ Dus een shipmentItemBean is de ShipmentOrderVO	,

$ vi oms-sitemap.xmap
			<map:match pattern="shipment-order_edit">
				<map:act type="shipmentOrderEdit">
							<map:read mime-type="text/html" type="jsp" src="jsp/shipment-order_edit.jsp"/>

/ Er  is ook	,

public class ShipmentItemEditAction extends AbstractShipmentOrderChildAction {

	@Override
	public Map act() throws java.lang.Exception {

		int mySystemId = getSystemIdFromRequest();
		ShipmentOrderVO myShipmentOrder = (ShipmentOrderVO) getSession().getAttribute(ShipmentOrderView.ACTIVE_SHIPMENTORDER);
		myShipmentOrder = ShipmentOrderUtil.getShipmentOrderFacadeLocal().getShipmentOrder(myShipmentOrder.getSystemId());
		getSession().setAttribute(ShipmentOrderView.ACTIVE_SHIPMENTORDER, myShipmentOrder);
		getRequest().setAttribute("formVO", myShipmentOrder);

		ShipmentItemVO myShipmentItem = getShipmentItemService().getBySystemId(mySystemId);
		ShipmentItemFormBean myFormVO = new ShipmentItemFormBean(myShipmentItem, myShipmentOrder.getProductItemList());
		getRequest().setAttribute("shipmentItemCostParts", myShipmentItem.getCostPartList());
		getSession().setAttribute(ShipmentItemView.ACTIVE_SHIPMENTITEM, myFormVO);

$ vi ShipmentItemView.java 

public class ShipmentItemView implements Serializable {

	public static final String ACTIVE_SHIPMENTITEM = "shipmentItemBean";



/ Einde Intermezzo

/ 13	. 

/ we moeten een created shipment order eerst save voordat we een shipment item kunnen create	, de link 'Create shipment item' is er niet, wel het form (zonder entity details, de issue)	, dus het is alsof je al de link clicked hebt	,  

/ ShipmentOrderFormAction wordt WH NIET used	, wij use WH ShipmentOrderCreateAction	,

/ we edit een shipment order	, bijv  SH000002464	,
/s
ShipmentOrderEditAction.act() line: 84	
			ShipmentItemFormBean myShipmentItem = prepareNewShipmentItem(myVO);
/ new	,
/s
ShipmentOrderEditAction.prepareNewShipmentItem(ShipmentOrderVO) line: 53	
		return new ShipmentItemFormBean(new ShipmentItemVO(), aShipmentOrder.getProductItemList());
/s
ShipmentItemVO.<init>() line: 157	
/t
ShipmentOrderVO.getProductItemList() line: 1426	
		return theProductItemList;
[]
/t
/s
ShipmentItemFormBean.<init>(ShipmentItemVO, Collection<ProductItemVO>) line: 39	
		setShipmentItem(aShipmentItem);
 		initPackedItemList(aProductItemList);
/ Niets, want de list is leeg	,

/t
			ShipmentItemFormBean myShipmentItem = prepareNewShipmentItem(myVO);
/d
			getSession().setAttribute(ShipmentItemView.ACTIVE_SHIPMENTITEM, myShipmentItem);

			if (!ShipmentOrderShared.isPackagingDisabled()) {
				// It should only be possible to edit individual products when
				// packaging is enabled.
				ProductItemVO myProductItem = (ProductItemVO) VOFactory.getValueObject(ProductItemVO.class);
/s
VOFactory.getValueObject(Class<T>) line: 38	
		return (EntityInterface) Factory.getFactory().getInstance(aValueObjectInterface, aValueObjectInterface.getName());
/s
Factory.getInstance(Class, String) line: 90	
/=
	public Object getInstance(Class anInterface, String aDefaultImplementation) {
anInterface	Class (com.mpobjects.oms.model.shipmentorder.vo.ProductItemVO) (id=2251)	
aDefaultImplementation	"com.mpobjects.oms.model.shipmentorder.vo.ProductItemVO" (id=23991)	

		String myCastableSupertype = anInterface.getName();
com.mpobjects.oms.model.shipmentorder.vo.ProductItemVO
		myTargetStr = theFactoryProperties.getProperty(myCastableSupertype, aDefaultImplementation);
com.mpobjects.oms.model.shipmentorder.vo.ProductItemVO
		return constructInstance(myTargetStr, anInterface, new Object[] {});

/t
ShipmentOrderEditAction.act() line: 93	
				ProductItemVO myProductItem = (ProductItemVO) VOFactory.getValueObject(ProductItemVO.class);
myProductItem	ProductItemVO  (id=24031)	
				MpoBeanFactory.getBean(EntityDetailService.class).initialize(myProductItem);
/s
EntityDetailServiceImpl.initialize(EntityDetailSupport) line: 131	
		List<EntityDetailType> myList = getDAO().getByEntity(anEntityDetailSupport.getEntity());
/ anEntityDetailSupport=ProductItemVO
ProductItemVO.class
	public EntityType getEntity() {
		return EntityType.PRODUCT_ITEM;
/t
/s
EntityDetailTypeDAOImpl.getByEntity(EntityType) line: 33	
/=
	public List<EntityDetailType> getByEntity(EntityType anEntity) {
anEntity	EntityType  (id=25244)	
PRODUCT_ITEM
		Criteria myCriteria = getCurrentSession().createCriteria(EntityDetailType.class);
		myCriteria.add(Property.forName("entity").eq(anEntity))
				.add(Property.forName("deleted").eq(false));
		myCriteria.setCacheable(true);
		return myCriteria.list();
/t
EntityDetailServiceImpl.initialize(EntityDetailSupport) line: 132	
		List<EntityDetailType> myList = getDAO().getByEntity(anEntityDetailSupport.getEntity());
[SystemId:26684143	IsDeleted:false	Detail Type:TunnelCd	ValueType:STRING	, 
SystemId:26684146	IsDeleted:false	Detail Type:ADRPuntenAant	ValueType:NUMBER	, 
SystemId:26822306	IsDeleted:false	Detail Type:SubsidiaryRiskLabel[1]	ValueType:STRING	, 
SystemId:26822307	IsDeleted:false	Detail Type:SubsidiaryRiskLabel[2]	ValueType:STRING	, 
SystemId:26822308	IsDeleted:false	Detail Type:SubsidiaryRiskLabel[3]	ValueType:STRING	, 
SystemId:26684147	IsDeleted:false	Detail Type:MinTemp	ValueType:NUMBER	, 
SystemId:26684144	IsDeleted:false	Detail Type:VerpakkingsGrpOmschr	ValueType:STRING	, 
SystemId:26684148	IsDeleted:false	Detail Type:MaxTemp	ValueType:NUMBER	, 
SystemId:26684145	IsDeleted:false	Detail Type:TransportCategorieCd	ValueType:STRING	]
/ TODO ( we zien in de postgres log deze query NIET)	,

		if (anEntityDetailSupport.getEntityDetails() != null) {
/ anEntityDetailSupport=ProductItemVO	,
/ entityDetails={}
/ Hieronder gaan we deze fill	,
			myList.removeAll(anEntityDetailSupport.getEntityDetails().keySet());
		}


		for (EntityDetailType myEntityDetailType : myList) {
			anEntityDetailSupport.setEntityDetail(myEntityDetailType, spaceAsInitialValue ? " " : "");
		}
/ Lege strings dus	,
/s
ProductItemVO(EntityDetailSupport).setEntityDetail(EntityDetailType, String) line: 238	
		getEntityDetails().put(aType, aValue);
...
/t
ShipmentOrderEditAction.act() line: 94	
				MpoBeanFactory.getBean(EntityDetailService.class).initialize(myProductItem);
/d
myProductItem	ProductItemVO  (id=26231)	
	entityDetails	HashMap  (id=26234)	
{SystemId:26684143	IsDeleted:false	Detail Type:TunnelCd	ValueType:STRING	=, 
SystemId:26684145	IsDeleted:false	Detail Type:TransportCategorieCd	ValueType:STRING	=, 
SystemId:26684148	IsDeleted:false	Detail Type:MaxTemp	ValueType:NUMBER	=, 
SystemId:26822308	IsDeleted:false	Detail Type:SubsidiaryRiskLabel[3]	ValueType:STRING	=, 
SystemId:26822307	IsDeleted:false	Detail Type:SubsidiaryRiskLabel[2]	ValueType:STRING	=, 
SystemId:26684144	IsDeleted:false	Detail Type:VerpakkingsGrpOmschr	ValueType:STRING	=, 
SystemId:26822306	IsDeleted:false	Detail Type:SubsidiaryRiskLabel[1]	ValueType:STRING	=, 
SystemId:26684146	IsDeleted:false	Detail Type:ADRPuntenAant	ValueType:NUMBER	=, 
SystemId:26684147	IsDeleted:false	Detail Type:MinTemp	ValueType:NUMBER	=}

				getSession().setAttribute("productItemVO", myProductItem);

/c
jsp line
/ TODO
ShipmentOrderVO(EntityDetailSupport).getEntityDetailsForDisplay() line: 185	
this=ShipmentOrderVO	,
/ queries ShipmentOrderVO.entityDetails

/ c
$ vi sho-productitems.tag
					<tmstags:entity-detail-list extraFieldList="${productItemVO.entityDetailsForDisplay}" process="${formVO.shipmentOrderProcess}" organization="${formVO.organizationSystemid}"/>
/s
ProductItemVO(EntityDetailSupport).getEntityDetailsForDisplay() line: 185	
/ queries ProductItemVO.entityDetails

/c
$ vi sho-shipmentitems.tag
							<td><tmstags:entity-detail-list extraFieldList="${shipmentItemBean.shipmentItem.entityDetailsForDisplay}" process="${formVO.shipmentOrderProcess}" organization="${formVO.organizationSystemid}" /></td>
/s
ShipmentItemVO(EntityDetailSupport).getEntityDetailsForDisplay() line: 185	
/ queries SHipmentItemVO.entityDetails={}

/ 13	. 

/ create een shipment order , van de 2de template	,

/ click 'Create order' in de row op de list van templates	, 
/s
ShipmentOrderCreateAction.act() line: 44	
		Request myRequest = getRequest();
		int mySystemId = getSystemIdFromRequest();
26770507
			myTemplate = MpoBeanFactory.getBean(ShipmentOrderDao.class).getBySystemId(mySystemId);
ShipmentOrder: cons_test_gse(SystemId:26770507; Org:PNL-CARGO)
/ een shipment order template is ook een shipment order	,
/ cons_test_gse is de shipment_order_id	,
myTemplate	ShipmentOrderVO_$$_javassist_139  (id=18076)	
	handler	JavassistLazyInitializer  (id=18765)	
		target	ShipmentOrderVO  (id=23824)	
			entityDetails	PersistentMap  (id=23825)	
{SystemId:26684153	IsDeleted:false	Detail Type:ProductKenmerkSoort	ValueType:LIST	=, 
SystemId:26684154	IsDeleted:false	Detail Type:OptieSoort	ValueType:LIST	=, 
SystemId:26684152	IsDeleted:false	Detail Type:Goedgekeurd	ValueType:BOOLEAN	=0, 
SystemId:26684149	IsDeleted:false	Detail Type:OntvangenBedragCash	ValueType:AMOUNT	=0 , 
SystemId:26684150	IsDeleted:false	Detail Type:OntvangenBedragPin	ValueType:AMOUNT	=0 , 
SystemId:26734011	IsDeleted:false	Detail Type:EilandToeslag	ValueType:BOOLEAN	=, 
SystemId:26684151	IsDeleted:false	Detail Type:Checked	ValueType:BOOLEAN	=0}

			theShipmentOrderPartyList	PersistentBag  (id=24812)	
[com.mpobjects.oms.model.entity.shipmentorderparty.ShipmentOrderParty@4a0708e1[shipmentOrder=ShipmentOrder: cons_test_gse(SystemId:26770507; Org:PNL-CARGO),name=,partyTypeGroup=theSystemId: 26681486PartyTypeGroup :DistributionDepot], 
com.mpobjects.oms.model.entity.shipmentorderparty.ShipmentOrderParty@13d811bf[shipmentOrder=ShipmentOrder: cons_test_gse(SystemId:26770507; Org:PNL-CARGO),name=,partyTypeGroup=theSystemId: 26681485PartyTypeGroup :CollectionDepot]]



		ShipmentOrderVO myVO = MpoBeanFactory.getBean(ShipmentOrderService.class).create(myTemplate);
/s
ShipmentOrderServiceImpl.create(ShipmentOrderVO, boolean) line: 554	
		} else {
			myVO = aShipmentOrderTemplate.copy();
myVO	ShipmentOrderVO  (id=22780)	
	entityDetails	HashMap  (id=22799)	
{SystemId:26684153	IsDeleted:false	Detail Type:ProductKenmerkSoort	ValueType:LIST	=, 
SystemId:26684152	IsDeleted:false	Detail Type:Goedgekeurd	ValueType:BOOLEAN	=0, 
SystemId:26684154	IsDeleted:false	Detail Type:OptieSoort	ValueType:LIST	=, 
SystemId:26684149	IsDeleted:false	Detail Type:OntvangenBedragCash	ValueType:AMOUNT	=0 , 
SystemId:26684150	IsDeleted:false	Detail Type:OntvangenBedragPin	ValueType:AMOUNT	=0 , 
SystemId:26684151	IsDeleted:false	Detail Type:Checked	ValueType:BOOLEAN	=0, 
SystemId:26734011	IsDeleted:false	Detail Type:EilandToeslag	ValueType:BOOLEAN	=}

aShipmentOrderTemplate	ShipmentOrderVO  (id=27998)	
	theShipmentOrderPartyList	PersistentBag  (id=28692)	
[com.mpobjects.oms.model.entity.shipmentorderparty.ShipmentOrderParty@28709f3c[shipmentOrder=ShipmentOrder: cons_test_gse(SystemId:26770507; Org:PNL-CARGO),name=,partyTypeGroup=theSystemId: 26681486PartyTypeGroup :DistributionDepot], 
com.mpobjects.oms.model.entity.shipmentorderparty.ShipmentOrderParty@79e630e1[shipmentOrder=ShipmentOrder: cons_test_gse(SystemId:26770507; Org:PNL-CARGO),name=,partyTypeGroup=theSystemId: 26681485PartyTypeGroup :CollectionDepot]]

			copyShipmentOrderParties(aShipmentOrderTemplate, myVO);
/s
ShipmentOrderServiceImpl.copyShipmentOrderParties(ShipmentOrderVO, ShipmentOrderVO) line: 531	
			Collection<ShipmentOrderParty> myShipmentOrderParties = anOriginal.getShipmentOrderParties();
				for (ShipmentOrderParty myParty : myShipmentOrderParties) {
					ShipmentOrderParty myNewParty = new ShipmentOrderParty();
					BeanUtils.copyProperties(myNewParty, myParty);
					myNewParty.setSystemId(ValueObject.VOLATILE_SYSTEM_ID);
					myNewParty.setShipmentOrder(aNewShipmentOrder);
					aNewShipmentOrder.addShipmentOrderParty(myNewParty);
				}

/t
ShipmentOrderServiceImpl.create(ShipmentOrderVO, boolean) line: 573	
			copyShipmentOrderParties(aShipmentOrderTemplate, myVO);
/d
			EntityDetailUtil.copyCorrespondingEntityDetails(aShipmentOrderTemplate, myVO);
	/**
	 * Copy corresponding EntityDetailType values from one vo to another, only if the EDT is present on the copyTo
	 * object. Does not create missing values
/ Doet niets bij ons	, de 7 key:value's veranderen niet	, de values worden niet overwrite met anderen	,
/ TODO

aShipmentOrderTemplate	ShipmentOrderVO  (id=27998)	
	entityDetails	PersistentMap  (id=28696)	
{
SystemId:26684153	IsDeleted:false	Detail Type:ProductKenmerkSoort	ValueType:LIST	=, 
SystemId:26684154	IsDeleted:false	Detail Type:OptieSoort	ValueType:LIST	=, 
SystemId:26684152	IsDeleted:false	Detail Type:Goedgekeurd	ValueType:BOOLEAN	=0, 
SystemId:26684149	IsDeleted:false	Detail Type:OntvangenBedragCash	ValueType:AMOUNT	=0 , 
SystemId:26684150	IsDeleted:false	Detail Type:OntvangenBedragPin	ValueType:AMOUNT	=0 , 
SystemId:26734011	IsDeleted:false	Detail Type:EilandToeslag	ValueType:BOOLEAN	=, 
SystemId:26684151	IsDeleted:false	Detail Type:Checked	ValueType:BOOLEAN	=0}

			myVO.setSystemId(ValueObject.VOLATILE_SYSTEM_ID);
/ replace template's system_id
0
			myVO.setShipmentOrderId("");
			myVO.setShipmentOrderTemplate(aShipmentOrderTemplate);
			myVO.setTemplate(isTemplate);
false
		addShipmentOrderParties(myVO);
/ TODO (Later)	,
		MpoBeanFactory.getBean(EntityDetailService.class).initialize(myVO);
/s
EntityDetailServiceImpl.initialize(EntityDetailSupport) line: 131	
/ anEntityDetailSupport=ShipmentOrderVO
		List<EntityDetailType> myList = getDAO().getByEntity(anEntityDetailSupport.getEntity());
[SystemId:26684151	IsDeleted:false	Detail Type:Checked	ValueType:BOOLEAN	, 
SystemId:26684152	IsDeleted:false	Detail Type:Goedgekeurd	ValueType:BOOLEAN	, 
SystemId:26772526	IsDeleted:false	Detail Type:BarcodeHold	ValueType:BOOLEAN	, 
SystemId:26772527	IsDeleted:false	Detail Type:ColloHoldChecked	ValueType:BOOLEAN	, 
SystemId:26772528	IsDeleted:false	Detail Type:DuplicateHold	ValueType:BOOLEAN	, 
SystemId:26684153	IsDeleted:false	Detail Type:ProductKenmerkSoort	ValueType:LIST	, 
SystemId:26774119	IsDeleted:false	Detail Type:DefaultWeight	ValueType:NUMBER	, 
SystemId:26780756	IsDeleted:false	Detail Type:KlantSpecifiek	ValueType:REMARKS	, 
SystemId:26684154	IsDeleted:false	Detail Type:OptieSoort	ValueType:LIST	, 
SystemId:26734011	IsDeleted:false	Detail Type:EilandToeslag	ValueType:BOOLEAN	, 
SystemId:26780826	IsDeleted:false	Detail Type:ShipmentReferentieNo	ValueType:REMARKS	, 
SystemId:26684149	IsDeleted:false	Detail Type:OntvangenBedragCash	ValueType:AMOUNT	, 
SystemId:26777671	IsDeleted:false	Detail Type:ShipToOpmerkingen	ValueType:REMARKS	, 
SystemId:26780816	IsDeleted:false	Detail Type:Klantreferentie	ValueType:REMARKS	, 
SystemId:26774375	IsDeleted:false	Detail Type:TotaalADRPuntenAantal	ValueType:STRING	, 
SystemId:26684150	IsDeleted:false	Detail Type:OntvangenBedragPin	ValueType:AMOUNT	, 
SystemId:26786350	IsDeleted:false	Detail Type:LabelNodig	ValueType:BOOLEAN	, 
SystemId:26820283	IsDeleted:false	Detail Type:TijdsVenster	ValueType:LIST	, 
SystemId:26777672	IsDeleted:false	Detail Type:ShipFromOpmerkingen	ValueType:REMARKS	]
/ queries entity_detail_type op entity=SHIPENT_ORDER
/ Het zijn keys	, alle keys bij entity 'SHIPMENT_ORDER'	,
19

		if (anEntityDetailSupport.getEntityDetails() != null) {
			myList.removeAll(anEntityDetailSupport.getEntityDetails().keySet());

[SystemId:26684153	IsDeleted:false	Detail Type:ProductKenmerkSoort	ValueType:LIST	, 
SystemId:26684152	IsDeleted:false	Detail Type:Goedgekeurd	ValueType:BOOLEAN	, 
SystemId:26684154	IsDeleted:false	Detail Type:OptieSoort	ValueType:LIST	, 
SystemId:26684149	IsDeleted:false	Detail Type:OntvangenBedragCash	ValueType:AMOUNT	, 
SystemId:26684150	IsDeleted:false	Detail Type:OntvangenBedragPin	ValueType:AMOUNT	, 
SystemId:26684151	IsDeleted:false	Detail Type:Checked	ValueType:BOOLEAN	, 
SystemId:26734011	IsDeleted:false	Detail Type:EilandToeslag	ValueType:BOOLEAN	]
/ Deze gaan eraf	,
7

/ myList=
[SystemId:26772526	IsDeleted:false	Detail Type:BarcodeHold	ValueType:BOOLEAN	, 
SystemId:26772527	IsDeleted:false	Detail Type:ColloHoldChecked	ValueType:BOOLEAN	, 
SystemId:26772528	IsDeleted:false	Detail Type:DuplicateHold	ValueType:BOOLEAN	, 
SystemId:26774119	IsDeleted:false	Detail Type:DefaultWeight	ValueType:NUMBER	, 
SystemId:26780756	IsDeleted:false	Detail Type:KlantSpecifiek	ValueType:REMARKS	, 
SystemId:26780826	IsDeleted:false	Detail Type:ShipmentReferentieNo	ValueType:REMARKS	, 
SystemId:26777671	IsDeleted:false	Detail Type:ShipToOpmerkingen	ValueType:REMARKS	, 
SystemId:26780816	IsDeleted:false	Detail Type:Klantreferentie	ValueType:REMARKS	, 
SystemId:26774375	IsDeleted:false	Detail Type:TotaalADRPuntenAantal	ValueType:STRING	, 
SystemId:26786350	IsDeleted:false	Detail Type:LabelNodig	ValueType:BOOLEAN	, 
SystemId:26820283	IsDeleted:false	Detail Type:TijdsVenster	ValueType:LIST	, 
SystemId:26777672	IsDeleted:false	Detail Type:ShipFromOpmerkingen	ValueType:REMARKS	] 
/ Deze keys ouden we over,	
12
		for (EntityDetailType myEntityDetailType : myList) {
			anEntityDetailSupport.setEntityDetail(myEntityDetailType, spaceAsInitialValue ? " " : "");
		}
/ We fill de list met keys van alle entity details op entity='SHIPMENT_ORDER' die we nog niet hadden in onze copy van het template,  en values ""	,
/ In de list van het template zien we ook values 0	,
/ TODO


/t
ShipmentOrderServiceImpl.create(ShipmentOrderVO, boolean) line: 604	
		MpoBeanFactory.getBean(EntityDetailService.class).initialize(myVO);
/d

/c
$ vi shipment-order_edit.jsp
		<tmstags:entity-detail-list extraFieldList="${formVO.entityDetailsForDisplay}" process="${formVO.shipmentOrderProcess}" organization="${formVO.organizationSystemid}" />
/ prints de form met alleen de keys  van de entity details van de sho	,
/s
ShipmentOrderVO(EntityDetailSupport).getEntityDetailsForDisplay() line: 185	
		return MpoBeanFactory.getBean(EntityDetailService.class).getDisplayList(this);
/s
EntityDetailServiceImpl.getDisplayList(EntityDetailSupport) line: 66	
		myCheckedList.putAll(anEntityDetailSupport.getEntityDetails());
/s
ShipmentOrderVO(EntityDetailSupport).getEntityDetails() line: 176	
/= theEntityDetails
/= key:values
{SystemId:26774119	IsDeleted:false	Detail Type:DefaultWeight	ValueType:NUMBER	=, 
SystemId:26772528	IsDeleted:false	Detail Type:DuplicateHold	ValueType:BOOLEAN	=, 
SystemId:26780756	IsDeleted:false	Detail Type:KlantSpecifiek	ValueType:REMARKS	=, 
SystemId:26777671	IsDeleted:false	Detail Type:ShipToOpmerkingen	ValueType:REMARKS	=, 
SystemId:26684151	IsDeleted:false	Detail Type:Checked	ValueType:BOOLEAN	=0, 
SystemId:26734011	IsDeleted:false	Detail Type:EilandToeslag	ValueType:BOOLEAN	=, 
SystemId:26820283	IsDeleted:false	Detail Type:TijdsVenster	ValueType:LIST	=, 
SystemId:26780816	IsDeleted:false	Detail Type:Klantreferentie	ValueType:REMARKS	=, 
SystemId:26772526	IsDeleted:false	Detail Type:BarcodeHold	ValueType:BOOLEAN	=, 
SystemId:26786350	IsDeleted:false	Detail Type:LabelNodig	ValueType:BOOLEAN	=, 
SystemId:26684153	IsDeleted:false	Detail Type:ProductKenmerkSoort	ValueType:LIST	=, 
SystemId:26684152	IsDeleted:false	Detail Type:Goedgekeurd	ValueType:BOOLEAN	=0, 
SystemId:26684154	IsDeleted:false	Detail Type:OptieSoort	ValueType:LIST	=, 
SystemId:26774375	IsDeleted:false	Detail Type:TotaalADRPuntenAantal	ValueType:STRING	=, 
SystemId:26780826	IsDeleted:false	Detail Type:ShipmentReferentieNo	ValueType:REMARKS	=, 
SystemId:26684149	IsDeleted:false	Detail Type:OntvangenBedragCash	ValueType:AMOUNT	=0 , 
SystemId:26777672	IsDeleted:false	Detail Type:ShipFromOpmerkingen	ValueType:REMARKS	=, 
SystemId:26684150	IsDeleted:false	Detail Type:OntvangenBedragPin	ValueType:AMOUNT	=0 , 
SystemId:26772527	IsDeleted:false	Detail Type:ColloHoldChecked	ValueType:BOOLEAN	=}
19

		for (Entry<EntityDetailType, String> myEntry : myCheckedList.entrySet()) {
			// If present, take visibility expr of the group otherwise take the one of the type
/ TODO
			EntityDetailType myEntityDetailType = myEntry.getKey();
			String myVisibilityExpr = myEntityDetailType.getVisibilityExpr();
			if (myVisibilityExpr == null) {
				// The visibility expr functionality can be replaced with the permission one
				if (!PermissionType.NONE.equals(myManager.checkPermissionForEntityDetail(anEntityDetailSupport, myEntityDetailType))) {
					myResult.add(new EntityDetailWrapper(myEntityDetailType, anEntityDetailSupport));
/ Lijkt dat hij alleen de key's pakt 	,
/ TODO

/c
$ vi sho-productitems.tag
					<tmstags:entity-detail-list extraFieldList="${productItemVO.entityDetailsForDisplay}" process="${formVO.shipmentOrderProcess}" organization="${formVO.organizationSystemid}"/>
/s
ProductItemVO(EntityDetailSupport).getEntityDetailsForDisplay() line: 185	
		return MpoBeanFactory.getBean(EntityDetailService.class).getDisplayList(this);
/s
EntityDetailServiceImpl.getDisplayList(EntityDetailSupport) line: 68	

		myCheckedList.putAll(anEntityDetailSupport.getEntityDetails());
{SystemId:26684143	IsDeleted:false	Detail Type:TunnelCd	ValueType:STRING	=, 
SystemId:26684144	IsDeleted:false	Detail Type:VerpakkingsGrpOmschr	ValueType:STRING	=, 
SystemId:26684145	IsDeleted:false	Detail Type:TransportCategorieCd	ValueType:STRING	=, 
SystemId:26684146	IsDeleted:false	Detail Type:ADRPuntenAant	ValueType:NUMBER	=, 
SystemId:26822306	IsDeleted:false	Detail Type:SubsidiaryRiskLabel[1]	ValueType:STRING	=, 
SystemId:26822307	IsDeleted:false	Detail Type:SubsidiaryRiskLabel[2]	ValueType:STRING	=, 
SystemId:26822308	IsDeleted:false	Detail Type:SubsidiaryRiskLabel[3]	ValueType:STRING	=, 
SystemId:26684147	IsDeleted:false	Detail Type:MinTemp	ValueType:NUMBER	=, 
SystemId:26684148	IsDeleted:false	Detail Type:MaxTemp	ValueType:NUMBER	=}
/ key:value's	,

/ In meer detail	,
myCheckedList	TreeMap  (id=28432)	
	root	TreeMap$Entry  (id=28465)	
		key	EntityDetailType  (id=28521)	
SystemId:26684145	IsDeleted:false	Detail Type:TransportCategorieCd	ValueType:STRING	
		left	TreeMap$Entry  (id=29848)	
		parent	null	
		right	TreeMap$Entry  (id=29849)	
		value	"" (id=20692)	
	size	9	
	values	null	
/ Dus we zien de entity detail type	, en de value ""


		for (Entry<EntityDetailType, String> myEntry : myCheckedList.entrySet()) {
			// If present, take visibility expr of the group otherwise take the one of the type
			EntityDetailType myEntityDetailType = myEntry.getKey();
			String myVisibilityExpr = myEntityDetailType.getVisibilityExpr();
			if (myVisibilityExpr == null) {
				// The visibility expr functionality can be replaced with the permission one
				if (!PermissionType.NONE.equals(myManager.checkPermissionForEntityDetail(anEntityDetailSupport, myEntityDetailType))) {
					myResult.add(new EntityDetailWrapper(myEntityDetailType, anEntityDetailSupport));
...
		return myResult;
/=
	elementData	Object[10]  (id=28500)	
		[0]	EntityDetailWrapper  (id=28503)	
			amount	null	
			currency	null	
			currencyDAO	$Proxy134  (id=26903)	
			entity	ProductItemVO  (id=28067)	
			map	HashMap  (id=28514)	
			performanceMonitorService	null	
			systemId	0	
			type	EntityDetailType  (id=28516)	
SystemId:26684143	IsDeleted:false	Detail Type:TunnelCd	ValueType:STRING	
		[1]	EntityDetailWrapper  (id=28504)	
			amount	null	
			currency	null	
			currencyDAO	$Proxy134  (id=26903)	
			entity	ProductItemVO  (id=28067)	
			map	HashMap  (id=28514)	
			performanceMonitorService	null	
			systemId	0	
			type	EntityDetailType  (id=28519)	
SystemId:26684144	IsDeleted:false	Detail Type:VerpakkingsGrpOmschr	ValueType:STRING	
		[2]	EntityDetailWrapper  (id=28505)	
			amount	null	
			currency	null	
			currencyDAO	$Proxy134  (id=26903)	
			entity	ProductItemVO  (id=28067)	
			map	HashMap  (id=28514)	
			performanceMonitorService	null	
			systemId	0	
			type	EntityDetailType  (id=28521)	
SystemId:26684145	IsDeleted:false	Detail Type:TransportCategorieCd	ValueType:STRING	
		[3]	EntityDetailWrapper  (id=28506)	
		[4]	EntityDetailWrapper  (id=28507)	
		[5]	EntityDetailWrapper  (id=28508)	
		[6]	EntityDetailWrapper  (id=28509)	
		[7]	EntityDetailWrapper  (id=28510)	
		[8]	EntityDetailWrapper  (id=28512)	
	modCount	9	
	size	9	

/ map wordt used om de value te geven	,

$ vi EntityDetailWrapper.java
	public EntityDetailType getType() {
		return type;
	}
	public String getValue() {
		return map.get(type);
	}

/ extraFieldList=List<EntityDetailWrapper>	,

$ vi EntityDetailType.java
	public ValueType getValueType() {
		return valueType;
ValueType.STRING 
/ bijv	,

$ vi EntityDetailType.java
	public String getName() {
		return getCode();
"VerpakkingsGrpOmschr"
"TransportCategoryCd"


/t
$ vi sho-productitems.tag
					<tmstags:entity-detail-list extraFieldList="${productItemVO.entityDetailsForDisplay}" process="${formVO.shipmentOrderProcess}" organization="${formVO.organizationSystemid}"/>
/d 
/ extraFieldList="${productItemVO.entityDetailsForDisplay}"	,
/c
ShipmentOrderVO.getShipmentOrderProcess() line: 1836	
		return getOrderProcess().getCode();
"OUTBOUND"

/s
$ vi entity-detail-list.tag

<%@taglib prefix="ctf" uri="/WEB-INF/tld/core-functions.tld"%>

<c:forEach var="myEntry" items="${extraFieldList}">
	<c:set var="myDetailType" value="${myEntry.type}" />
	<c:set var="myValue" value="${myEntry.value}" />
	<c:set var="detailProcess" value="${ctf:organizationPropertyNoException(myDetailType.organization.systemId, '', 'process.type', 'none',false)}" />

/ myEntry=EntityDetailWrapper	,
/ myDetailType is een EntityDetailType	,
/ myValue is een String
	<c:if test="${myDetailType.valueType!='HIDDEN'}">
/ TODO( er waren ook entries met value=0, of was dat "0"	?
 
$ vi EntityDetailType.java
	public Organization getOrganization() {
		return organization;
	}

$ vi core-functions.tld
<function>
	<name>organizationPropertyNoException</name>
    <function-class>com.mpobjects.core.ApplicationPropertyManager</function-class>
    <function-signature>
        java.lang.String  taglibGetOrganizationProperty(int, java.lang.String,java.lang.String,java.lang.String,boolean)
    </function-signature>
</function>

/c
ApplicationPropertyManager.taglibGetOrganizationProperty(int, String, String, String, boolean) line: 129	
/=
	public static String taglibGetOrganizationProperty(int anOrganizationSystemId, String aModule, String aKey, String aDefaultValue, boolean aThrowException) {
		return getInstance().getModuleOrganizationProperty(anOrganizationSystemId, aModule, aKey, aDefaultValue, aThrowException);
anOrganizationSystemId	500	
aModule	"" (id=31966)	
aKey	"process.type" (id=31967)	
aDefaultValue	"none" (id=31968)	
aThrowException	false	
/s
ApplicationPropertyManager.getModuleOrganizationProperty(int, String, String, String, boolean) line: 310	
/=
	public String getModuleOrganizationProperty(int anOrganizationSystemid, String aModule, String aKey, String aDefaultValue, boolean aThrowException) {
		return getOrganizationProperty(anOrganizationSystemid, getPropertyKey(aModule, aKey), aDefaultValue, aThrowException);
this	ApplicationPropertyManager  (id=31965)	
anOrganizationSystemid	500	
aModule	"" (id=31966)	
aKey	"process.type" (id=31967)	
aDefaultValue	"none" (id=31968)	
aThrowException	false	
/s
ApplicationPropertyManager.getOrganizationProperty(int, String, String, boolean) line: 396	
/=
	public String getOrganizationProperty(int anOrganizationSystemid, String aPropertyKey, String aDefaultValue, boolean aThrowException) {
this	ApplicationPropertyManager  (id=31965)	
anOrganizationSystemid	500	
aPropertyKey	"process.type" (id=31967)	
aDefaultValue	"none" (id=31968)	
aThrowException	false	

		Resource myResource = AuthenticationUtils.getResource();
Resource:eric(systemId:26682479)
		Organization myOrganization = null;

		if (myResource != null) {
			for (Organization myResourceOrganization : myResource.getOrganizations()) {
SystemId:500	Id:PNL-CARGO	Description:PostNL Cargo
				if (myResourceOrganization.getSystemId() == anOrganizationSystemid) {
/ JA
					myOrganization = myResourceOrganization;
					break;

		String myRet = myOrganization.getProperty(aPropertyKey, aDefaultValue);
"none"

/t
entity-detail-list.tag line: 17	
	<c:set var="detailProcess" value="${ctf:organizationPropertyNoException(myDetailType.organization.systemId, '', 'process.type', 'none',false)}" />
/d
"none"
	<c:if test="${myDetailType.valueType!='HIDDEN'}">
/ NEE	, 
ValueType.STRING
		<c:if test="${detailProcess == process||detailProcess=='none'}">
/ JA
			<c:choose>
				<c:otherwise>
					<c:if test="${first}">
						<c:out escapeXml="false" value="<fieldset><legend>" />
						<mpo:label name="extraFields" />
						<c:out escapeXml="false" value="</legend><table>" />
						<c:set var="first" value="false" />
					</c:if>
					<!-- display fields -->
					<mpo:setFormVO valueObject="${myEntry}" prefix="${myDetailType.name}">
						<tr>
							<td class="label">
								<mpo:label firstCharToUpper="true" name="${myDetailType.name}" /></td>
							<td align="left"><c:choose>
									<c:otherwise>
										<mpo:field showFieldContext="false" name="value" required="${myDetailType.required}"
											readOnly="${myDetailType.readOnlyString?myDetailType.readOnlyString:form.formReadOnly}"
											maxLength="${myDetailType.config}" size="${myDetailType.config}" />

/ myEntry=EntityDetailWrapper	, 
/ myDetailType.name="TransportCategoryId"	, bijv	,

/ set b in 
FieldTag.doStartTag() line: 316	
/ dan zie je vanzelf in welke line je bent in de entity-detail-list.tag	,
/s
entity-detail-list.tag line: 89	
									<c:otherwise>
->										<mpo:field showFieldContext="false" name="value" required="${myDetailType.required}"
											readOnly="${myDetailType.readOnlyString?myDetailType.readOnlyString:form.formReadOnly}"
											maxLength="${myDetailType.config}" size="${myDetailType.config}" />
/s
FieldTag.doStartTag() line: 316	
this	FieldTag  (id=33683)	
	name	"value" (id=33777)	
	pefix	"TunnelCd" (id=30207)	

				findSetFormVOTag();
/s
FieldTag.findSetFormVOTag() line: 1100	
		while (myParent != null && !(myParent instanceof SetFormVOTag) && i < max) {
			myParent = myParent.getParent();
			i++;
		}
		SetFormVOTag myTag = (SetFormVOTag) myParent;
		setActiveValueObjectHolder((SetFormVOTag) myTag.clone());
/t
FieldTag.doStartTag() line: 350	
				} else {
					appendInputPart(myRet);
/s
FieldTag.appendInputPart(StringBuffer) line: 931	
		if (isFieldContextList() && isCurrentlyReadOnly()) {
/ NEE
		} else {
			aBuffer.append("<input type=\"text\"");
			aBuffer.append(" name=\"" + getFormFieldName() + "\"");
/s
FieldTag.getFormFieldName() line: 1138	
		String myPrefix = getPrefix();
"TunnelCd"
		} else {
			myRet = myPrefix + StringUtils.firstCharToUpper(getName());
"TunnelCdValue"
/t
			aBuffer.append(" id=\"" + getFormFieldName() + "\"");
			aBuffer.append(" size=\"" + getSize() + "\"");
			aBuffer.append(" maxLength=\"" + getMaxLength() + "\"");
<input type="text" name="TunnelCdValue" id="TunnelCdValue" size="5" maxLength="5"

			if (isBindToVO()) {
/ JA
				aBuffer.append(" value=\"" + getDisplayValueAsString().replaceAll("\"", "") + "\"");
<input type="text" name="TunnelCdValue" id="TunnelCdValue" size="5" maxLength="5" value=""

			if (StringUtils.isNotEmpty(myClasses)) {
				aBuffer.append(" class=\"" + myClasses + "\" ");

			aBuffer.append("/>");

/ volgende	,
$ vi entity-detail-list.tag
<c:forEach var="myEntry" items="${extraFieldList}">
	<!-- master process::${process} detail name: ${myDetailType.name} detailProcess:${detailProcess} -->
	<c:set var="myDetailType" value="${myEntry.type}" />
	<c:set var="myValue" value="${myEntry.value}" />
->	<c:set var="detailProcess" value="${ctf:organizationPropertyNoException(myDetailType.organization.systemId, '', 'process.type', 'none',false)}" />
"none"
/ want	,
/s
ApplicationPropertyManager.taglibGetOrganizationProperty(int, String, String, String, boolean) line: 129	
...

/ 7	. 

/ we click op 'Create order' link in row op shipment order tempate is (planning, shipment order, create)	,
/= shipment-order_create	,

$ vi ShipmentOrderCreateAction.java
	public Map act() throws java.lang.Exception {

		ShipmentOrderVO myVO = MpoBeanFactory.getBean(ShipmentOrderService.class).create(myTemplate);
		mySession.setAttribute(ShipmentOrderView.ACTIVE_SHIPMENTORDER, myVO);
"active_shipment_order"
		ShipmentItemVO myShipmentItemVO = null;
		ProductItemVO myProductItemVO = (ProductItemVO) VOFactory.getValueObject(ProductItemVO.class);
		MpoBeanFactory.getBean(EntityDetailService.class).initialize(myVO);
		MpoBeanFactory.getBean(EntityDetailService.class).initialize(myProductItemVO);
		getSession().setAttribute(ShipmentItemView.ACTIVE_SHIPMENTITEM, myShipmentItemVO);
"shipmentItemBean"
null

$ vi shipment-order_edit.jsp

				<c:if test="${cf:property('oms', 'shipmentorder.hide.productitems', 'false')=='false'}">
					<mpo:tab name="productItems">
						<tmstags:sho-productitems />
					</mpo:tab>
				</c:if>

				<c:if test="${!empty formVO.shipmentItemList or true}">
					<mpo:tab name="shipmentItems">
						<tmstags:sho-shipmentitems />
					</mpo:tab>
				</c:if>
 
/ 7	.

[eric@localhost Backup]$ pwd
/home/eric/Devel/Postgres/Backup
[eric@localhost Backup]$ PGPASSWORD='h^Zgcyr&Q'  pg_dump -U vanderveldene -Fc -h pnl-app-a.intermax.mp-objects.com pnllogistics > pnl-app-a_pnllogistics.dump
/ OK

/ login local db    ,
[eric@localhost LOGS]$ PGPASSWORD=mpopostgres@mpo psql -U mpopostgres pnloms7
pnloms7=# create database pnllogistics;
CREATE DATABASE

[eric@localhost Backup]$ PGPASSWORD=mpopostgres@mpo pg_restore -U mpopostgres -d  pnllogistics pnl-app-a_pnllogistics.dump
/ OK

/ 7	.  

[eric@localhost apache-activemq-5.10.1]$ pwd
/home/eric/Devel/Java/ActiveMQ/apache-activemq-5.10.1
[eric@localhost apache-activemq-5.10.1]$ bin/activemq console

/ 7	.


/ 7	. 

/ create shipment order	, 

/ See ook CREATE SHIPMENT ORDER 

/ Kies	,
planning, shipment order, create
/ dit is shipment-order-template_list

/ click filter of enter 	, we krijgen list van shipment order templates	,

/ we create eeh sho	,
SH000002609

/ we kiezen het 2de template	, 

/ we zien 
Status 1404 OPEN

/ we passen velden aan	,

/ in Shipment order details
Hold Status: <leeg>
Actual productcode: 3610
Entry date: 28 Jul 2015 14:33			/ is er al , WH de creation data	,
Last update: 28 Jul 2015 14:39			/ is er al , 
Req start after: 30 Jul 2015 8:00
Requested start before: 30 Jul 2015 18:00
Req end after: 31 Jul 2015 8:00
Requested end before: 31 Jul 2015 18:00
Requested Productcode: 3610				/ = Actual productcode	,

/ in Shipment order details
Inco term: NA

/ Ship From
Company: constst frm					/ is er al	,
Address: xxx
Housenumber: 13
City: Schiedam
Postalcode: 3012cn 						/ is er al	,

/ Ship To 
Company: constst to						/ is er al	,
Address: xxx
Housenumber: 13
City: Eindhoven 
Postalcode: 2656gh						/ is er al	,

/ Bill To 
Bill to party:	9148459					/ is er al	,
Company: Gildewerk B.V.					/ is er al	, 
Address: Jan van Geunsweg 10A			/ is er al	, 
City: HAARLEM							/ is er al	, 
Postalcode: 2656gh						/ is er al	,
Country: NL								/ is er al	,

Save	, 


/ Nu kunnen we een shipment item create	, 
Unit type: C
/ Save shipment item	,
/ OK

//////////////////////////////////////
/ de sho is planned	, want we zien onder service actions,  er zijn er 3	, 

/ 7	. 

/ we click in een row onder Shipment items	' edit'	, 
/ we zien in HTML	,
<button class="action formContext edit" href="shipment-item_edit?systemId=26831189&amp;base_sessionLevelOffset=1">
	<img src="../lookandfeel/styles/images/icons/check24.png" alt="Edit" title="Edit">
</button>

$ vi oms-sitemap.xmap

			<map:match pattern="shipment-item_edit">
				<map:act type="shipmentItemEdit"/>
				<map:read mime-type="text/html" type="jsp" src="jsp/shipment-order_edit.jsp"/>
			</map:match>
			<map:action logger="shipmentorder" name="shipmentItemEdit" src="com.mpobjects.oms.control.shipmentorder.action.ShipmentItemEditAction"/>

/s
$ vi ShipmentItemEditAction.java
		int mySystemId = getSystemIdFromRequest();
...
		getRequest().setAttribute("formVO", myShipmentOrder);
/ system id van de shipment item	,
		ShipmentItemVO myShipmentItem = getShipmentItemService().getBySystemId(mySystemId);
		ShipmentItemFormBean myFormVO = new ShipmentItemFormBean(myShipmentItem, myShipmentOrder.getProductItemList());
/ myShipmentOrder.getProductItemList()=[]
/s
ShipmentItemFormBean.<init>(ShipmentItemVO, Collection<ProductItemVO>) line: 41	
		setShipmentItem(aShipmentItem);
		initPackedItemList(aProductItemList);
/s
ShipmentItemFormBean.initPackedItemList(Collection<ProductItemVO>) line: 93	
		packedItemList.addAll(shipmentItem.getPackedItemList());
[]
/t
ShipmentItemEditAction.act() line: 44	
		ShipmentItemFormBean myFormVO = new ShipmentItemFormBean(myShipmentItem, myShipmentOrder.getProductItemList());
/d
		getRequest().setAttribute("shipmentItemCostParts", myShipmentItem.getCostPartList());
		getSession().setAttribute(ShipmentItemView.ACTIVE_SHIPMENTITEM, myFormVO);
/ ShipmentItemView.ACTIVE_SHIPMENTITEM="shipmentItemBean"

		getSession().setAttribute(ACTIVE_ITEM_TAB, ACTIVE_ITEM_TAB_SHIPMENT);
/ ACTIVE_ITEM_TAB="shipmentOrderChildsTab", 
/ ACTIVE_ITEM_TAB_SHIPMENT="shipmentItems"

/ c
/ Dit zijn entity details van de sho	,
$ vi shipment-order_edit.jsp
					<c:if test="${cf:property('oms', 'shipmentorder.entitydetails.location', 'up')=='up'}">
						<div class="up" id="entityDetails">
							<tmstags:entity-detail-list extraFieldList="${formVO.entityDetailsForDisplay}" process="${formVO.shipmentOrderProcess}" organization="${formVO.organizationSystemid}" />

/c
sho-productitems.tag line: 451	
					<tmstags:entity-detail-list extraFieldList="${productItemVO.entityDetailsForDisplay}" process="${formVO.shipmentOrderProcess}" organization="${formVO.organizationSystemid}"/>
...
/s
ProductItemVO(EntityDetailSupport).getEntityDetailsForDisplay() line: 185	

/c
sho-shipmentitems.tag line: 133	
<table class="list">
	<c:forEach var="currentItem" items="${formVO.flattenedShipmentItems}">
/ headers	,
				<c:forEach var="shipmentItemDetail" items="${currentItem.shipmentItemVO.entityDetailsForDisplay}">
/s
ShipmentItemVO(EntityDetailSupport).getEntityDetailsForDisplay() line: 185	
		return MpoBeanFactory.getBean(EntityDetailService.class).getDisplayList(this);
this	ShipmentItemVO  (id=27579)	
	entityDetails	PersistentMap  (id=29142)	
{}

/c
sho-shipmentitems.tag line: 133	
<table class="list">
/ values	,
				<!-- Entity detail values -->
				<c:forEach var="shipmentItemDetail" items="${shipmentItemList.entityDetailsForDisplay}">

/c
sho-shipmentitems.tag line: 377	
		<td>
			<tmstags:entity-detail-list extraFieldList="${shipmentItemBean.shipmentItem.entityDetailsForDisplay}" process="${formVO.shipmentOrderProcess}" organization="${formVO.organizationSystemid}" />
		</td>

/ FIX PCT-470

$ vi ShipmentOrderEditAction.java

			ShipmentItemFormBean myShipmentItem = prepareNewShipmentItem(myVO);										/ al	,
->			MpoBeanFactory.getBean(EntityDetailService.class).initialize(myShipmentItem.getShipmentItem());			/ nieuw	,



/ we zien als we een bestaande sho edit, en we click de link 'Create shipment item'	, nu ook de entity details	,
/ Maar als we een bestaande edit NIET	,

Added the entity details to the part of the shipment order form where a shipment item is created.

When you later edit a shipment item created with this new form, also the entity details are shown. 

Before this fix, there were no entity details on a shipment item.


Committed revision 20434.

Translated on service-action_edit.jsp two "name" fields to "Company" and two "name2" fields to "Contact".


/ Einde FIX PCT-470






/ 7	. 

/ wat doet de link 'Create shipment item'	?

/ we zien in HTML	,
<a href="#" id="createShipmentItemBtn"> Create Shipment item</a>

/ Zoek in Chrome met ctrl+shift+f (zoek in alles) naar 'createShipmentItemBtn'	,
/ Naast Console, in Search, zien we 
$ vi class.shipment_order_edit.js

/ of anders	, 
/ In Elements select de <a/>, ga rechts naar Event listeners	, click op a#createShipmentItemBtn	, en we komen vanzelf in de handler	, we verlaten Elements, en komen in Sources	,
$ vi class.shipment_order_edit.js
ShipmentOrderEdit.createShipmentItemBtnOnclick = function() {
->    document.getElementById("shipmentItemForm").className="";
    shipmentOrderCorrectLocations();
    this.className="hidden";
    return false;
}

/ we set een b	,
  document.getElementById("shipmentItemForm").className="";
/ dat is de div net onder de link, en had class="hidden", het zijn al de inputs	,
/ we zien alle inputs, maar niet de entity details	,
    shipmentOrderCorrectLocations();
/s
function shipmentOrderCorrectLocations() {
    var mySaveShipmentItemBtn = document.getElementById("saveShipmentItemBtn");
    var mySaveSimpleShipmentItemBtn = document.getElementById("saveSimpleShipmentItemBtn");
    var mySaveProductItemBtn = document.getElementById("saveProductItemBtn");

    if (mySaveShipmentItemBtn!=null) {
/ JA
        mySaveShipmentItemBtn.onclick = ShipmentOrderEdit.saveShipmentItem;
    }
    if (mySaveSimpleShipmentItemBtn!=null) {
/ NEE
    if (mySaveProductItemBtn!=null) {
/ JA
    	mySaveProductItemBtn.onclick = ShipmentOrderEdit.saveProductItem;
    }
/t
ShipmentOrderEdit.createShipmentItemBtnOnclick (class.shipment-der_edit.js:52)
    this.className="hidden";
/ Maak de link hidden	,
    return false;




/ Einde PCT-470

/ SHIPMENT_ORDER_EDIT.JSP

/  Hoe is formVO bekend in de jsp	?

/ Eerst	, 
$ vi ShipmentOrderEditAction.java
	@Override
	public Map act() throws java.lang.Exception {
			myVO = MpoBeanFactory.getBean(ShipmentOrderDao.class).getBySystemId(mySystemId);
			getSession().setAttribute(ShipmentOrderView.ACTIVE_SHIPMENTORDER, myVO);

/ dan 
$ vi ShipmentOrderView.java
	public static final String ACTIVE_SHIPMENTORDER = "active_shipment_order";
	public ShipmentOrderVO getShipmentOrderVO() {
		return getActive();
	}
	private ShipmentOrderVO getActive() {
		ShipmentOrderVO myActive = (ShipmentOrderVO) getSession().getAttribute(ACTIVE_SHIPMENTORDER);
/ precies die we hebben set in ShipmentOrderEditAction.act	,



/ dan 
$ vi shipment-order_edit.jsp

<jsp:useBean id="myShipmentOrderView" scope="session" class="com.mpobjects.oms.view.shipmentorder.ShipmentOrderView" />
/ doet WH new	,

	theResource.init(request);
	ShipmentOrderVO myVO = myShipmentOrderView.getShipmentOrderVO();
	request.setAttribute("formVO", myVO);





/ Einde SHIPMENT_ORDER_EDIT.JSP

/ PCT-472

/ de sho is planned	, 
/ open service order, type="COLLECT"	,
Name -> Company
Name2 -> Contact

$ vi shipment-order_edit.jsp

		<div id="serviceActions">
					<%
							for (ServiceActionVO myServiceActionVO : myVO.getServiceActionList()) {
								request.setAttribute("activeServiceAction", myServiceActionVO);
					%>
					<mpo:setFormVO valueObject="${activeServiceAction}">

						<tr class="list${index2 %2}">
							<%
								if (isEditable) {
							%>
							<td>
								<mpo:action name="edit" entity="serviceAction" /> 
								...
							</td>


/ we zien in HTML	,
<button class="action formContext edit" href="service-action_edit?systemId=26831169&amp;base_sessionLevelOffset=1"><img src="../lookandfeel/styles/images/icons/check24.png" alt="Edit" title="Edit"></button>

$ vi oms-sitemap.xmap

			<map:match pattern="service-action_edit">
				<map:act type="serviceActionEdit"/>
				<map:read mime-type="text/html" type="jsp" src="jsp/service-action_edit.jsp"/>
			</map:match>
			<map:action name="serviceActionEdit" logger="serviceaction" src="com.mpobjects.oms.control.serviceaction.action.ServiceActionEditAction"/>

Translated on service-action_edit.jsp two "name" fields to "Company" and two "name2" fields to "Contact".

/ Einde PCT-472

/ PCT-451

/ op het shipment order is een knop 'Create return'	, 
/ er wordt een nieuwe shipment order create, die van B naar A gaat	, als de oorspronkelijke van A naar B ging	,


/ click 'Create return'	, 

org.postgresql.util.PSQLException: ERROR: duplicate key value violates unique constraint "shi_id_sho_uk" Detail: Key (shipment_order_systemid, shipment_item_id)=(26831237, 010) already exists. 
...
at com.mpobjects.oms.dao.entitylog.EntityLogDAOHibernate.save(EntityLogDAOHibernate.java:171) 
...
at com.mpobjects.oms.ratecalc.model.ratecalculation.vo.RateCalculationVO.saveLog(RateCalculationVO.java:1565) 
at com.mpobjects.oms.ratecalc.model.ratecalculation.vo.RateCalculationVO.runFor(RateCalculationVO.java:882) 
at com.mpobjects.oms.ratecalc.model.service.CalculationServiceImpl.recalculate(CalculationServiceImpl.java:570) 
...
at com.mpobjects.oms.ratecalc.model.eventhandler.util.RateCalcEventListener.recalculate(RateCalcEventListener.java:336) 
at com.mpobjects.oms.ratecalc.model.eventhandler.util.RateCalcEventListener.recalcShipOrderPrice(RateCalcEventListener.java:95) 
at com.mpobjects.oms.ratecalc.model.eventhandler.util.RateCalcEventListener.handleEvent(RateCalcEventListener.java:78) 
at com.mpobjects.oms.model.eventhandler.util.ListenerList.fireEvent(ListenerList.java:82) 
at com.mpobjects.oms.service.event.EventHandlerServiceImpl.handleEvent(EventHandlerServiceImpl.java:109) 
at com.mpobjects.oms.model.service.ShipmentOrderServiceImpl.triggerEventHandler(ShipmentOrderServiceImpl.java:2542) 
at com.mpobjects.oms.model.service.ShipmentOrderServiceImpl.updateShipmentOrder(ShipmentOrderServiceImpl.java:2045) 
at com.mpobjects.oms.model.service.ShipmentOrderServiceImpl.updateShipmentOrder(ShipmentOrderServiceImpl.java:1952) 
...
at com.mpobjects.oms.model.service.ShipmentOrderServiceImpl.createReturnShipmentOrder(ShipmentOrderServiceImpl.java:771) 
...
at com.mpobjects.oms.control.shipmentorder.action.ShipmentOrderCreateReturnAction.act(ShipmentOrderCreateReturnAction.java:56) 
at com.mpobjects.control.action.AbstractAction.act(AbstractAction.java:171) 

/ 13	. 

/ Open	SH000002573
/ click 'Cost'
/ Hier zien we entries onder Post calculated, Price k 
/ we kunnen zelf ook een price part toevoegen	,
/ onder Price, create	,
VRACHT	Vrachtkosten	107.98 EUR	AUTOMATIC	Calc.: 107.98 (ADD)	NOT_INVOICED 		/ al,		
AANMELDTOESLAG	aanmeldtoeslag	100.00 EUR	MANUAL		NOT_INVOICED					/ new	,	
/ we zien MANUAL	, maar de bestaande is AUTOMATIC	,

/ Open SH000002589	, 
/ click 'Create return'	,
/ Deze gaat OK	,
SH000002589RO
/ Dit zijn WH shipment orders zonder shipment items	,

/ dit is inderdaad de meest recent created shipment order	,

pnllogistics2=# select shipment_order_id from shipment_order  order by system_id desc limit 5
pnllogistics2-# ;
 shipment_order_id 
-------------------
 SH000002589RO
 SH000002609			/ deze hebben we voor PCT-470 create
 SH000002607
 SH000002606
 SH000002605
(5 rows)

/ 13	. 

/ als we nog een keer 'Create return' click op  SH000002589	, 

org.postgresql.util.PSQLException: ERROR: null value in column "currency_systemid" violates not-null constraint Detail: Failing row contains (26831254, 26831249, ADD, 26595000, , MANUAL, 10.36000, null, NOT_INVOICED, null, null, null, ESTIMATED). 
...
at com.mpobjects.oms.dao.entitylog.EntityLogDAOHibernate.save(EntityLogDAOHibernate.java:171) 
...
at com.mpobjects.oms.ratecalc.model.ratecalculation.vo.RateCalculationVO.saveLog(RateCalculationVO.java:1565) 
at com.mpobjects.oms.ratecalc.model.ratecalculation.vo.RateCalculationVO.runFor(RateCalculationVO.java:882) 
at com.mpobjects.oms.ratecalc.model.service.CalculationServiceImpl.recalculate(CalculationServiceImpl.java:570) 
...
at com.sun.proxy.$Proxy236.recalculate(Unknown Source) 
at com.mpobjects.oms.ratecalc.model.eventhandler.util.RateCalcEventListener.recalculate(RateCalcEventListener.java:336) 
at com.mpobjects.oms.ratecalc.model.eventhandler.util.RateCalcEventListener.recalcShipOrderPrice(RateCalcEventListener.java:95) 
at com.mpobjects.oms.ratecalc.model.eventhandler.util.RateCalcEventListener.handleEvent(RateCalcEventListener.java:78) 
at com.mpobjects.oms.model.eventhandler.util.ListenerList.fireEvent(ListenerList.java:82) 
at com.mpobjects.oms.service.event.EventHandlerServiceImpl.handleEvent(EventHandlerServiceImpl.java:109) 
at com.mpobjects.oms.model.service.ShipmentOrderServiceImpl.triggerEventHandler(ShipmentOrderServiceImpl.java:2542) 
at com.mpobjects.oms.model.service.ShipmentOrderServiceImpl.updateShipmentOrder(ShipmentOrderServiceImpl.java:2045) 
at com.mpobjects.oms.model.service.ShipmentOrderServiceImpl.updateShipmentOrder(ShipmentOrderServiceImpl.java:1952) 
at com.mpobjects.oms.model.service.ShipmentOrderServiceImpl.recalculateShipmentOrder(ShipmentOrderServiceImpl.java:1272) 
...
at com.mpobjects.oms.model.shipmentorder.ShipmentOrderChildService.recalculateShipmentOrder(ShipmentOrderChildService.java:24) 
at com.mpobjects.oms.model.shipmentitem.service.ShipmentItemServiceImpl.save(ShipmentItemServiceImpl.java:587) 
at com.mpobjects.oms.model.shipmentitem.service.ShipmentItemServiceImpl.save(ShipmentItemServiceImpl.java:560) 
at com.mpobjects.oms.model.shipmentitem.service.ShipmentItemServiceImpl.save(ShipmentItemServiceImpl.java:555) 
at com.mpobjects.oms.model.shipmentitem.service.ShipmentItemServiceImpl.save(ShipmentItemServiceImpl.java:545) 
at com.mpobjects.oms.model.shipmentitem.service.ShipmentItemServiceImpl.save(ShipmentItemServiceImpl.java:1) 
...
at com.mpobjects.oms.service.CompleteShipmentOrderDuplicator.duplicate(CompleteShipmentOrderDuplicator.java:79) 
at com.mpobjects.oms.service.CompleteShipmentOrderDuplicator.duplicate(CompleteShipmentOrderDuplicator.java:33) 
at com.mpobjects.oms.model.service.ShipmentOrderServiceImpl.createReturnShipmentOrder(ShipmentOrderServiceImpl.java:722) 
...
at com.mpobjects.oms.control.shipmentorder.action.ShipmentOrderCreateReturnAction.act(ShipmentOrderCreateReturnAction.java:56) 

/ click refresh filter	, dan wordt de query op alle sho's opnieuw gedaan	,
/ we zien in de postgres log	,
149929 LOG:  execute <unnamed>: BEGIN
 149930 LOG:  execute <unnamed>: SELECT SHO.* FROM SHIPMENT_ORDER SHO WHERE IS_TEMPLATE = 0 AND ORGANIZATION_SYSTEMID IN (0,500,1020,1010,1)  
 149930 and system_entry_date > '2015-07-01' limit $1
 149931 DETAIL:  parameters: $1 = '2000'

/ Daarna filteren we weer op 2589 	,
178590 LOG:  execute <unnamed>: SELECT SHO.* FROM SHIPMENT_ORDER SHO WHERE IS_TEMPLATE = 0 AND ORGANIZATION_SYSTEMID IN (0,500,1020,1010,1)  
 178590 and system_entry_date > '2015-07-01' and upper(shipment_order_id) LIKE '%2589%' limit $1
 178591 DETAIL:  parameters: $1 = '2000'

/ 7	. 

/ we kunnen ook op SH000002537 een return maken: SH000002537RO	,
///////////////////////////////////////////////////////////
/ Als we  SH000002537RO, wordt hij ingeplanned	, 

/ 2589 is STARTED	, 2537 is PLANNED	,
/ Deze returns gaan OK

/ SH000002609 hadden we self create	, return gaat ERR,	


/ 7	.

/ als je een shipment order create, is het OPEN	,
/ als je hem save, wordt hij ingeplanned, we zien service actions	, hij is dan PLANNED	, 
/ ga naar de 1ste service order, set actual start date van deze	, de sho is dan STARTED	,


/ Einde PCT-451

/ DEBUG PCT-451

/  Als we SH000002609 create return 	, dan zien we 	,


org.postgresql.util.PSQLException: ERROR: duplicate key value violates unique constraint "shi_id_sho_uk" Detail: Key (shipment_order_systemid, shipment_item_id)=(26831237, 010) already exists. 
...
at com.mpobjects.oms.dao.entitylog.EntityLogDAOHibernate.save(EntityLogDAOHibernate.java:171) 
...
at com.mpobjects.oms.ratecalc.model.ratecalculation.vo.RateCalculationVO.saveLog(RateCalculationVO.java:1565) 
at com.mpobjects.oms.ratecalc.model.ratecalculation.vo.RateCalculationVO.runFor(RateCalculationVO.java:882) 
at com.mpobjects.oms.ratecalc.model.service.CalculationServiceImpl.recalculate(CalculationServiceImpl.java:570) 
...
at com.mpobjects.oms.ratecalc.model.eventhandler.util.RateCalcEventListener.recalculate(RateCalcEventListener.java:336) 
at com.mpobjects.oms.ratecalc.model.eventhandler.util.RateCalcEventListener.recalcShipOrderPrice(RateCalcEventListener.java:95) 
at com.mpobjects.oms.ratecalc.model.eventhandler.util.RateCalcEventListener.handleEvent(RateCalcEventListener.java:78) 
at com.mpobjects.oms.model.eventhandler.util.ListenerList.fireEvent(ListenerList.java:82) 
at com.mpobjects.oms.service.event.EventHandlerServiceImpl.handleEvent(EventHandlerServiceImpl.java:109) 
at com.mpobjects.oms.model.service.ShipmentOrderServiceImpl.triggerEventHandler(ShipmentOrderServiceImpl.java:2542) 
at com.mpobjects.oms.model.service.ShipmentOrderServiceImpl.updateShipmentOrder(ShipmentOrderServiceImpl.java:2045) 
at com.mpobjects.oms.model.service.ShipmentOrderServiceImpl.updateShipmentOrder(ShipmentOrderServiceImpl.java:1952) 
at com.mpobjects.oms.model.service.ShipmentOrderServiceImpl.createReturnShipmentOrder(ShipmentOrderServiceImpl.java:771) 
at com.mpobjects.oms.control.shipmentorder.action.ShipmentOrderCreateReturnAction.act(ShipmentOrderCreateReturnAction.java:56) 
at com.mpobjects.control.action.AbstractAction.act(AbstractAction.java:171) 

/ debug	, 
/s
ShipmentOrderCreateReturnAction.act() line: 56	
		// get original shipment order
		String SystemOrderSystemId = getRequest().getParameter("shipmentorder_systemid");
26831165
		ShipmentOrderVO myOriginalShipmentOrder = ShipmentOrderUtil.getShipmentOrderFacadeLocal().getShipmentOrder(Integer.valueOf(SystemOrderSystemId));
/ TODO (postgres log)	,
		ShipmentOrderVO myVO = MpoBeanFactory.getBean(ShipmentOrderService.class).createReturnShipmentOrder(myOriginalShipmentOrder);
/s
ShipmentOrderServiceImpl.createReturnShipmentOrder(ShipmentOrderVO) line: 720	
		ShipmentOrderVO myShipmentOrderVO = shipmentOrderDuplicator.duplicate(aShipmentOrder);
/s
CompleteShipmentOrderDuplicator.duplicate(ShipmentOrderVO, CustomDuplicateAction) line: 44	
		ShipmentOrderVO myNewShipmentOrderVO = anOriginalShipmentOrderVO.copy();
/s
ShipmentOrderVO.copy() line: 413	
this
	systemId	26831165	
			ShipmentOrderVO myVO = ShipmentOrderVOFactory.getShipmentOrderVO();
myVO
	systemId 0
			copyTo(myVO);
/s
ShipmentOrderVO.copyTo(ShipmentOrderVO) line: 432	
		ShipmentOrderVO myVO = aTargetShipmentOrderVO;
		super.copyTo(myVO);
/s
ShipmentOrderVO(LogisticsOrderVO).copyTo(LogisticsOrderVO) line: 1097	
		super.copyTo(aVO);
/s
ShipmentOrderVO(ResourceProtectedValueObject).copyTo(ResourceProtectedValueObject) line: 65	
		super.copyTo(aVO);
/s
ShipmentOrderVO(UniqueFieldValueObjectImpl).copyTo(UniqueFieldValueObjectImpl) line: 25	
		super.copyTo(aVO);
/s
ShipmentOrderVO(ValueObject).copyTo(ValueObject) line: 282	
/ this=ShipmentOrderVO	, systemId=26831165
/ aVO.systemId=0
		aVO.setSystemId(getSystemId());
/ aVO.systemId	26831165	

/t
ShipmentOrderVO(ResourceProtectedValueObject).copyTo(ResourceProtectedValueObject) line: 67	
			aVO.setOrganization(getOrganization());
/t
ShipmentOrderVO(LogisticsOrderVO).copyTo(LogisticsOrderVO) line: 1098	
		super.copyTo(aVO);
/d
...
/t
ShipmentOrderVO.copyTo(ShipmentOrderVO) line: 434	
		super.copyTo(aVO);
/d
...
/t
ShipmentOrderVO.copy() line: 420	
			copyTo(myVO);
/d
			return myVO;
/t
CompleteShipmentOrderDuplicator.duplicate(ShipmentOrderVO, CustomDuplicateAction) line: 44	
		ShipmentOrderVO myNewShipmentOrderVO = anOriginalShipmentOrderVO.copy();
/d
myNewShipmentOrderVO	ShipmentOrderVO  (id=23187)	
	theProductItemList	TreeSet  (id=23878)	
[]
	theShipmentItemList	TreeSet  (id=23896)	
[]

		myNewShipmentOrderVO.setSystemId(ValueObject.VOLATILE_SYSTEM_ID);
/ systemId=0
		myNewShipmentOrderVO.setShipmentOrderId(anOriginalShipmentOrderVO.getShipmentOrderId().trim() + "copy");
theShipmentOrderId	"SH000002609copy" (id=30511)	
		try
			myNewShipmentOrderVO = shipmentOrderService.createShipmentOrder(myNewShipmentOrderVO);
/s
ShipmentOrderServiceImpl.createShipmentOrder(ShipmentOrderVO, TMSEventContext) line: 809	
			if (aShipmentOrder.isTemplate()) {
/ NEE
			} else {
				...
				myVO = shipmentOrderDao.save(aShipmentOrder);
systemId	26831335	
/ nieuwe system_id gen	,
/s
ShipmentOrderDaoImpl(GenericHibernateDAO).save(Type) line: 485	
		if (anEntity.getSystemId() == 0) {
/ JA
			getHibernateTemplate().persist(anEntity);
/t
ShipmentOrderServiceImpl.createShipmentOrder(ShipmentOrderVO, TMSEventContext) line: 837	
				myVO = shipmentOrderDao.save(aShipmentOrder);
/d
/ we zitten in een service mth, dus nu wordt de save nog niet commit	,

				MpoBeanFactory.getBean(EntityDetailService.class).initialize(myVO);
{SystemId:26774119	IsDeleted:false	Detail Type:DefaultWeight	ValueType:NUMBER	=40, 
SystemId:26772528	IsDeleted:false	Detail Type:DuplicateHold	ValueType:BOOLEAN	=0, 
SystemId:26780756	IsDeleted:false	Detail Type:KlantSpecifiek	ValueType:REMARKS	=, 
SystemId:26777671	IsDeleted:false	Detail Type:ShipToOpmerkingen	ValueType:REMARKS	=, 
SystemId:26684151	IsDeleted:false	Detail Type:Checked	ValueType:BOOLEAN	=0, 
SystemId:26734011	IsDeleted:false	Detail Type:EilandToeslag	ValueType:BOOLEAN	=, 
SystemId:26820283	IsDeleted:false	Detail Type:TijdsVenster	ValueType:LIST	=, 
SystemId:26780816	IsDeleted:false	Detail Type:Klantreferentie	ValueType:REMARKS	=, 
SystemId:26772526	IsDeleted:false	Detail Type:BarcodeHold	ValueType:BOOLEAN	=0, 
SystemId:26786350	IsDeleted:false	Detail Type:LabelNodig	ValueType:BOOLEAN	=0, 
SystemId:26827907	IsDeleted:false	Detail Type:ManualPricing	ValueType:BOOLEAN	=0, 
SystemId:26684153	IsDeleted:false	Detail Type:ProductKenmerkSoort	ValueType:LIST	=, 
SystemId:26684152	IsDeleted:false	Detail Type:Goedgekeurd	ValueType:BOOLEAN	=0, 
SystemId:26684154	IsDeleted:false	Detail Type:OptieSoort	ValueType:LIST	=, 
SystemId:26684149	IsDeleted:false	Detail Type:OntvangenBedragCash	ValueType:AMOUNT	=0 , 
SystemId:26822867	IsDeleted:false	Detail Type:CashOnDeliveryRemarks	ValueType:REMARKS	=, 
SystemId:26774375	IsDeleted:false	Detail Type:TotaalADRPuntenAantal	ValueType:STRING	=, 
SystemId:26780826	IsDeleted:false	Detail Type:ShipmentReferentieNo	ValueType:REMARKS	=, 
SystemId:26777672	IsDeleted:false	Detail Type:ShipFromOpmerkingen	ValueType:REMARKS	=, 
SystemId:26684150	IsDeleted:false	Detail Type:OntvangenBedragPin	ValueType:AMOUNT	=0 , 
SystemId:26772527	IsDeleted:false	Detail Type:ColloHoldChecked	ValueType:BOOLEAN	=0}
/ myVO heeft al alle 21 entity details types + default values	, deze blijft onveranderd door .initialize	,
/s
EntityDetailServiceImpl.initialize(EntityDetailSupport) line: 131	
		List<EntityDetailType> myList = getDAO().getByEntity(anEntityDetailSupport.getEntity());
/ anEntityDetailSupport=ShipmentOrderVO	,  systemId	26831335	, de copy	,
/ anEntityDetailSupport.getEntity()=EntityType.SHIPMENT_ORDER
/ myList size 21 van entity detail types	= alle entity detail types op entity SHIPMENT_ORDER

		if (anEntityDetailSupport.getEntityDetails() != null) {
			myList.removeAll(anEntityDetailSupport.getEntityDetails().keySet());
/ myList size 0
/ dus de entityDetails uit anEntityDetailSupport=myVO=ShipmentOrderVO blijft onveranderd	,

		for (EntityDetailType myEntityDetailType : myList) {
[]
/ NEE

/t
ShipmentOrderServiceImpl.createShipmentOrder(ShipmentOrderVO, TMSEventContext) line: 842	
				MpoBeanFactory.getBean(EntityDetailService.class).initialize(myVO);
/d
				getTriggerHandler().handleCreate(myVO);
/s
ShipmentOrderServiceImpl.getTriggerHandler() line: 2476	
/= this.triggerHandler=com.mpobjects.oms.service.trigger.ShipmentOrderTriggerHandlerImpl@746988e1
/ NIETS
/t
				triggerEventHandler(null, myVO, new TMSEventContext());
/s
ShipmentOrderServiceImpl.triggerEventHandler(ShipmentOrderVO, ShipmentOrderVO, TMSEventContext) line: 2542	
		if (anOldVO == null) {
			myEvent = new ShipmentOrderEvent(null, aNewVO, ShipmentOrderEvent.CREATED, anEventContext);
		eventHandlerService.handleEvent(myEvent);
/s
EventHandlerServiceImpl.handleEvent(Event) line: 109	
		String myEventType = anEvent.getEventType();
"shipmentorder.created"

			int myLevel = eventThreadStack.push(anEvent);
0

			listenerList.fireEvent(anEvent);
this	EventHandlerServiceImpl  (id=31981)	
	listenerList	ListenerList  (id=32009)	
		theListenerList	ArrayList  (id=32047)	
			elementData	Object[15]  (id=32136)	
				[0]	DocumentEventListener  (id=32137)	
				[1]	CustomerOrderEventListener  (id=32138)	
				[2]	ShoCostAllocationEventListener  (id=32139)	
				[3]	TMSCarConServiceOrderEventListener  (id=32140)	
				[4]	SupplierInvoiceUpdateEventListener  (id=32141)	
				[5]	StockTransactionEventListener  (id=32212)	
				[6]	$Proxy410  (id=32213)	
				[7]	EventEventListener  (id=32321)	
				[8]	AllocationEventListener  (id=32349)	
				[9]	CustomerInvoiceUpdateEventListener  (id=32350)	
				[10]	CapableToPromiseEventListener  (id=32361)	
				[11]	PnlLogisticsEventListener  (id=32388)	
				[12]	EmailReportEventListener  (id=32389)	
				[13]	InvoiceServiceOrderEventHandler  (id=32394)	
				[14]	RateCalcEventListener  (id=32395)	
			size	15	
/s
ListenerList.fireEvent(Event<?>) line: 80	
		for (EventListener myListener : theListenerList) {
			myListener.handleEvent(anEvent);
/s
RateCalcEventListener.handleEvent(Event) line: 66	

$ vi pnllogistics.properties
module.ratecalc.serviceorder.ratecalculation.execution=auto
/ of misschien ook in de db	, 
/ TODO

			String myRecalcExecution = ApplicationPropertyManager.getInstance().getModuleProperty("ratecalc", "serviceorder.ratecalculation.execution");
"auto"
			if (myRecalcExecution.equalsIgnoreCase("auto")) {
				recalcServiceOrderCost(anEvent);
/ NIETS
			String myPriceExecution = ApplicationPropertyManager.getInstance().getModuleProperty("ratecalc", "shipmentorderprice.ratecalculation.execution");
"auto"
			if (myPriceExecution.equalsIgnoreCase("auto")) {
				recalcShipOrderPrice(anEvent);
/s
RateCalcEventListener.recalcShipOrderPrice(Event) line: 91	
		String myType = anEvent.getEventType();
myType	"shipmentorder.created" (id=32005)	
			if (myType.equals(ShipmentOrderEvent.CREATED)) {
/ JA
				ShipmentOrderVO myNewShipmentOrderVO = ((ShipmentOrderEvent) anEvent).getNewShipmentOrderVO();
SH000002609copy
systemId: 26831387
				recalculate(myNewShipmentOrderVO, AgreementType.SHIPMENT_ORDER, anEvent.getEventContext());
/s
RateCalcEventListener.recalculate(ShipmentOrderVO, AgreementType, TMSEventContext) line: 335	
/ See DEBUG RECALCULATE PCT-451
/t
EventHandlerServiceImpl.handleEvent(Event) line: 111	
			listenerList.fireEvent(anEvent);
/d
			broadcastToTopic(anEvent);
/s
EventHandlerServiceImpl.broadcastToTopic(Event<?>) line: 166	
		jmsTemplate.send(getTopicName(aEvent), new MessageCreator() {
...
/t
ShipmentOrderServiceImpl.createShipmentOrder(ShipmentOrderVO, TMSEventContext) line: 848	
				triggerEventHandler(null, myVO, new TMSEventContext());
/d
CompleteShipmentOrderDuplicator.duplicate(ShipmentOrderVO, CustomDuplicateAction) line: 54	
			myNewShipmentOrderVO = shipmentOrderService.createShipmentOrder(myNewShipmentOrderVO);
systemId	26831335	, de copy	,
/d
/ Nog niet commit	, want we zijn nog in een service	,
ShipmentOrderCreateReturnAction(AbstractAction).act(Redirector, SourceResolver, Map, String, Parameters) line: 171	
		ShipmentOrderVO myVO = MpoBeanFactory.getBean(ShipmentOrderService.class).createReturnShipmentOrder(myOriginalShipmentOrder);
ShipmentOrder: SH000002609copy(SystemId:26831341; Org:PNL-CARGO)

			// copy product items
			Collection<ProductItemVO> myOriginalProductItems = anOriginalShipmentOrderVO.getProductItemList();
			for (ProductItemVO myOriginalProductItem : myOriginalProductItems) {
/ NEE

			// copy shipment items
			Collection<ShipmentItemVO> myOriginalShipmentItems = anOriginalShipmentOrderVO.getShipmentItemList();
			for (ShipmentItemVO myOriginalShipmentItem : myOriginalShipmentItems) {
[shipmentItem: 010(systemId:26831189, labelInfo:0107481611104395), 
shipmentItem: 020(systemId:26831235, labelInfo:1471406851104396)]
/ Klopt, zelf create	,
				ShipmentItemVO myNewShipmentItem = myOriginalShipmentItem.copy();
/sets systemId=0

				myNewShipmentItem = shipmentItemService.save(myNewShipmentItem);
shipmentItem: 010(systemId:26831343, labelInfo:8562719081104407)
/ hij heeft weer een system id	,

/ Intermezzo

/ we zien in de postgres log	,
LOG:  execute <unnamed>: insert into SHIPMENT_ORDER (IS_TEMPLATE, SHIPMENT_ORDER_ID, ORDER_... values ($1, $2, $3, $4, $5...
DETAIL:  parameters: $1 = 'f', $2 = 'SH000002609copy', $3 = '26594670', $4 = '26766227', $5 = NUL...

LOG:  execute <unnamed>: insert into SHIPMENT_ORDER_PARTY (PARTY_ID, SYNC_FLAG, NAME, NAME2, ADDRESS, ADDRESS2, CITY, POSTAL_CODE, REGION_STATE,
 PHONE_NUMBER, FAX_NUMBER, EMAIL_ADDRESS, CONTACT_NAME, REFERENCE1, REFERENCE2, REFERENCE3, REFERENCE4, REFERENCE5, REFERENCE6, COUNTRY_SYSTEMID
, PARTY_TYPE_GROUP_SYSTEMID, SHIPMENT_ORDER_SYSTEMID, SYSTEM_ID) values ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, 
$17, $18, $19, $20, $21, $22, $23)
DETAIL:  parameters: $1 = '', $2 = 'DISABLED', $3 = '', $4 = '', $5 = '', $6 = '', $7 = '', $8 = '', $9 = '', $10 = '', $11 = '', $12 = '', $13 
= '', $14 = '', $15 = '', $16 = '', $17 = '', $18 = '', $19 = '', $20 = NULL, $21 = '26681486', $22 = '26831341', $23 = '26831344'

LOG:  execute <unnamed>: insert into SHIPMENT_ORDER_PARTY (PARTY_ID, SYNC_FLAG, NAME, NAME2, ADDRESS, ADDRESS2, CITY, POSTAL_CODE, REGION_STATE,
 PHONE_NUMBER, FAX_NUMBER, EMAIL_ADDRESS, CONTACT_NAME, REFERENCE1, REFERENCE2, REFERENCE3, REFERENCE4, REFERENCE5, REFERENCE6, COUNTRY_SYSTEMID
, PARTY_TYPE_GROUP_SYSTEMID, SHIPMENT_ORDER_SYSTEMID, SYSTEM_ID) values ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, 
$17, $18, $19, $20, $21, $22, $23)
DETAIL:  parameters: $1 = '', $2 = 'DISABLED', $3 = '', $4 = '', $5 = '', $6 = '', $7 = '', $8 = '', $9 = '', $10 = '', $11 = '', $12 = '', $13 
= '', $14 = '', $15 = '', $16 = '', $17 = '', $18 = '', $19 = '', $20 = NULL, $21 = '26681485', $22 = '26831341', $23 = '26831345'

LOG:  execute <unnamed>: update SHIPMENT_ORDER set IS_TEMPLATE=$1, SHIPMENT_ORDER_ID=$2, ORDER_PROCESS_SYSTEMID=$3, ACT_SERVICE_LEVEL_SYSTEMID=$
4, REQ_SERVICE_LEVEL_SYSTEMID=$5, STATUS_CODE_SYSTEMID=$6, ORGANIZATION_SYSTEMID=$7, INCO_TERM_SYSTEMID=$8, PATH_SYSTEMID=$9, FROM_LOCATION_ID=$
10...
where SYSTEM_ID=$210
DETAIL:  parameters: $1 = 'f', $2 = 'SH000002609copy', $3 = '26594670', $4 = '26766227', $5 = ..., $210 = '26831341'

LOG:  execute <unnamed>: update SHIPMENT_ORDER_PARTY set PARTY_ID=$1, SYNC_FLAG=$2, NAME=$3, NAME2=$4, ADDRESS=$5, ADDRESS2=$6, CITY=$7, POSTAL_CODE=$8, REGION_STATE=$9, PHONE_NUMBER=$10, FAX_NUMBER=$11, EMAIL_ADDRESS=$12, CONTACT_NAME=$13, REFERENCE1=$14, REFERENCE2=$15, REFERENCE3=$16, REFERENCE4=$17, REFERENCE5=$18, REFERENCE6=$19, COUNTRY_SYSTEMID=$20, PARTY_TYPE_GROUP_SYSTEMID=$21 where SYSTEM_ID=$22
DETAIL:  parameters: $1 = 'DOR', $2 = 'DISABLED', $3 = 'Depot Dordrecht', $4 = '', $5 = 'Pieter Zeemanweg', $6 = '146', $7 = 'Dordrecht', $8 = '3316 GZ ', $9 = '', $10 = '', $11 = '', $12 = '', $13 = '', $14 = '', $15 = '', $16 = '', $17 = '', $18 = '160213', $19 = '', $20 = '4153', $21 = '26681485', $22 = '26831345'

LOG:  execute S_2: insert into SHIPMENT_ORDER_DETAIL (ENTITY_SYSTEMID, EDT_SYSTEMID, FIELD_VALUE) values ($1, $2, $3)
DETAIL:  parameters: $1 = '26831341', $2 = '26774119', $3 = '40'
LOG:  execute S_2: insert into SHIPMENT_ORDER_DETAIL (ENTITY_SYSTEMID, EDT_SYSTEMID, FIELD_VALUE) values ($1, $2, $3)
DETAIL:  parameters: $1 = '26831341', $2 = '26772528', $3 = '0'
LOG:  execute S_2: insert into SHIPMENT_ORDER_DETAIL (ENTITY_SYSTEMID, EDT_SYSTEMID, FIELD_VALUE) values ($1, $2, $3)
DETAIL:  parameters: $1 = '26831341', $2 = '26780756', $3 = ''
LOG:  execute S_2: insert into SHIPMENT_ORDER_DETAIL (ENTITY_SYSTEMID, EDT_SYSTEMID, FIELD_VALUE) values ($1, $2, $3)
DETAIL:  parameters: $1 = '26831341', $2 = '26777671', $3 = ''
LOG:  execute S_2: insert into SHIPMENT_ORDER_DETAIL (ENTITY_SYSTEMID, EDT_SYSTEMID, FIELD_VALUE) values ($1, $2, $3)
DETAIL:  parameters: $1 = '26831341', $2 = '26684151', $3 = '0'
LOG:  execute S_2: insert into SHIPMENT_ORDER_DETAIL (ENTITY_SYSTEMID, EDT_SYSTEMID, FIELD_VALUE) values ($1, $2, $3)
DETAIL:  parameters: $1 = '26831341', $2 = '26734011', $3 = ''
LOG:  execute S_2: insert into SHIPMENT_ORDER_DETAIL (ENTITY_SYSTEMID, EDT_SYSTEMID, FIELD_VALUE) values ($1, $2, $3)
DETAIL:  parameters: $1 = '26831341', $2 = '26820283', $3 = ''
LOG:  execute S_2: insert into SHIPMENT_ORDER_DETAIL (ENTITY_SYSTEMID, EDT_SYSTEMID, FIELD_VALUE) values ($1, $2, $3)
DETAIL:  parameters: $1 = '26831341', $2 = '26780816', $3 = ''
LOG:  execute S_2: insert into SHIPMENT_ORDER_DETAIL (ENTITY_SYSTEMID, EDT_SYSTEMID, FIELD_VALUE) values ($1, $2, $3)
DETAIL:  parameters: $1 = '26831341', $2 = '26772526', $3 = '0'
LOG:  execute S_2: insert into SHIPMENT_ORDER_DETAIL (ENTITY_SYSTEMID, EDT_SYSTEMID, FIELD_VALUE) values ($1, $2, $3)
DETAIL:  parameters: $1 = '26831341', $2 = '26786350', $3 = '0'
LOG:  execute S_2: insert into SHIPMENT_ORDER_DETAIL (ENTITY_SYSTEMID, EDT_SYSTEMID, FIELD_VALUE) values ($1, $2, $3)
DETAIL:  parameters: $1 = '26831341', $2 = '26827907', $3 = '0'
LOG:  execute S_2: insert into SHIPMENT_ORDER_DETAIL (ENTITY_SYSTEMID, EDT_SYSTEMID, FIELD_VALUE) values ($1, $2, $3)
DETAIL:  parameters: $1 = '26831341', $2 = '26684153', $3 = ''
LOG:  execute S_2: insert into SHIPMENT_ORDER_DETAIL (ENTITY_SYSTEMID, EDT_SYSTEMID, FIELD_VALUE) values ($1, $2, $3)
DETAIL:  parameters: $1 = '26831341', $2 = '26684152', $3 = '0'
LOG:  execute S_2: insert into SHIPMENT_ORDER_DETAIL (ENTITY_SYSTEMID, EDT_SYSTEMID, FIELD_VALUE) values ($1, $2, $3)
DETAIL:  parameters: $1 = '26831341', $2 = '26684154', $3 = ''
LOG:  execute S_2: insert into SHIPMENT_ORDER_DETAIL (ENTITY_SYSTEMID, EDT_SYSTEMID, FIELD_VALUE) values ($1, $2, $3)
DETAIL:  parameters: $1 = '26831341', $2 = '26684149', $3 = '0 '
LOG:  execute <unnamed>: update SHIPMENT_ORDER_PARTY set SHIPMENT_ORDER_SYSTEMID=$1 where SYSTEM_ID=$2
DETAIL:  parameters: $1 = '26831341', $2 = '26831344'
LOG:  execute <unnamed>: update SHIPMENT_ORDER_PARTY set SHIPMENT_ORDER_SYSTEMID=$1 where SYSTEM_ID=$2
DETAIL:  parameters: $1 = '26831341', $2 = '26831345'

/ Einde Intermezzo

/ we zijn nog in	,
CompleteShipmentOrderDuplicator.duplicate(ShipmentOrderVO, CustomDuplicateAction) line: 80	
				myNewShipmentItem = shipmentItemService.save(myNewShipmentItem);
/d
				if (aCustomAction.isShouldCopyProductItem()) {
					// copy packed items
					List<PackedItemVO> myOrigPackedItemList = myOriginalShipmentItem.getPackedItemList();
					for (PackedItemVO myOrigPackedItemVO : myOrigPackedItemList) {
/ NEE
[]
				shipmentItemService.save(myNewShipmentItem);

/ volgende	,
/d
		myNewShipmentOrderVO = shipmentOrderService.getShipmentOrder(myNewShipmentOrderVO.getSystemId());
/s
		return shipmentOrderDao.getBySystemId(aSystemId);
/ L2 cached	,

/t
ShipmentOrderServiceImpl.createReturnShipmentOrder(ShipmentOrderVO) line: 724	
		ShipmentOrderVO myShipmentOrderVO = shipmentOrderDuplicator.duplicate(aShipmentOrder);
/d

/ Einde DEBUG PCT-451

/ DEBUG RECALCULATE PCT-451

RateCalcEventListener.recalculate(ShipmentOrderVO, AgreementType, TMSEventContext) line: 311	
		boolean myCalcOffline = ApplicationPropertyManager.getInstance().getModuleOrganizationProperty(anOrder.getOrganization(), "ratecalc",
				"shipmentorder.recalculate.offline", false);
false
		} else {
			getCalculationService().recalculate(anOrder, aRateType, anEventContext);
/s
CalculationServiceImpl.recalculate(LogisticsOrderVO, AgreementType, TMSEventContext) line: 493	
			List<RateAgreementVO> mySelectedRateAgreement = getMatchingRateAgreement(anOrder, aRateType);
/ anOrder=ShipmentOrder: SH000002609copy(SystemId:26831387; Org:PNL-CARGO)
/ aRateType=AgreementType.SHIPMENT_ORDER
/s
CalculationServiceImpl.recalculate(LogisticsOrderVO, AgreementType, TMSEventContext) line: 493	
		List<RateAgreementVO> myResultList = new ArrayList<RateAgreementVO>();
			if (myPreselectedList.isEmpty()) {
				myPreselectedList = getRateAgreementList(aRateType);
/s
CalculationServiceImpl.recalculate(LogisticsOrderVO, AgreementType, TMSEventContext) line: 493	
		return rateAgreementDao.getByType(aRateType);
/s
RateAgreementHibernateDAOImpl.class
	public List<RateAgreementVO> getByType(AgreementType aRateType) {
		DetachedCriteria myCriteria = DetachedCriteria.forClass(RateAgreementVO.class);
		myCriteria.add(Property.forName("agreementType").eq(aRateType)).add(Property.forName("template").eq(false))
				.add(Property.forName("quotation").eq(false));
		return findNonDeleted(myCriteria);

/ we zien in de postgres log	,

LOG:  execute <unnamed>: select ... 
from RATE_AGREEMENT this_ 
left outer join UNIT unit2_ on this_.UNIT_SYSTEMID=unit2_.SYSTEM_ID 
where this_.organization_Systemid in (
	select uo.organization_systemid 
	from user_organization uo 
	where uo.user_systemid = $1) 
and this_.RATE_TYPE=$2 
and this_.IS_TEMPLATE=$3 
and this_.IS_QUOTATION=$4 
and this_.IS_DELETED=$5
DETAIL:  parameters: $1 = '26682479', $2 = 'SHIPMENT_ORDER', $3 = 'f', $4 = 'f', $5 = 'f'

/ we doen zelf	,
pnllogistics2=# select count(*) from rate_agreement  where rate_type='SHIPMENT_ORDER' and is_template=false and is_quotation=false and is_deleted=false;
 count 
-------
   207
(1 row)

/ Klopt, zo groot is myPreselectedList	, 

/t
				myPreselectedList = getRateAgreementList(aRateType);
/d
207 rate agreements	,

/ Intermezzo

/ config, finance, service management, service agreements(admin), 
/ Kies de 1ste	, 'Verkooptarief Intertoys	, edit	,
/ we zien Selection criteria	, 
Order detail			Value_from 	 	Value_to				MatchTyped 
BILL_TO_PARY (SHO)		9831001									REGEX
REQ_END_AFTER (SHO)		01-Jan-2015		31-dec-2015				RANGE

/ we zien ook Parameters	,
RP-Vracht
/ we zien oo Rate Components	,
RC-Tariefstaffel-Intertoys

/ kies	,
/ config, finance, service management, order details
/ we edit BILL_TO_PARTY	,
Expression ./billToPartyVO/partyId
/ we edit REQ_END_AFTER	,
Expression ./consignmentList[1]/serviceActionList[1]/shipmentOrderVO/dateSetVO/requestedEndAfter 


/ Einde Intermezzo

			for (RateAgreementVO myRateAgreementVO : myPreselectedList) {
				if (myResultList.isEmpty() || !myResultList.contains(myRateAgreementVO)) {
					if (myRateAgreementVO.matches(myContext)) {
/s
RateAgreementVO.matches(JXPathContext) line: 417	
		Collection<RAgreementSelCriterion> myRagreementSelCriteriumList = getRateAgreementSelCriterionList();
/ #=2
/ see in Intermezzo hierboven	,
		for (RAgreementSelCriterion myRagreementSelCriteriumVO : myRagreementSelCriteriumList) {
			if (!myRagreementSelCriteriumVO.matches(aContext)) {
/s
RAgreementSelCriterion.matches(JXPathContext) line: 85	
		Object myValue = getMatchValue(aJXPathContext);
/s
RAgreementSelCriterion.getMatchValue(JXPathContext) line: 151	
this	RAgreementSelCriterion  (id=26853)	
		OrderDetail myOrderDetail = getOrderDetail();
		Object myValue = myOrderDetail.retrieveValueFromOrder(aJXPathContext);
/s
OrderDetail.retrieveValueFromOrder(JXPathContext) line: 177	
this	OrderDetail  (id=26949)	
		String myPathOrClass = getPathOrClass();
myPathOrClass	"./billToPartyVO/partyId" (id=27205)	

		Object myValue = aContext.getValue(myPathOrClass);
aContext	JXPathContextReferenceImpl  (id=26822)	
	contextBean	ShipmentOrderVO  (id=3017)	
hipmentOrder: SH000002609copy(SystemId:26831387; Org:PNL-CARGO)
	compiled	HashMap  (id=26675)	
/ TODO (Wat is dit voor lijst , is deze voor elk sho dezelfde?)
		size	39	
		table	HashMap$Entry[64]  (id=27908)	
			[1]	HashMap$Entry  (id=27912)	
			[5]	HashMap$Entry  (id=27913)	
			[6]	HashMap$Entry  (id=27914)	
			[9]	HashMap$Entry  (id=27915)	
			[11]	HashMap$Entry  (id=27916)	
			[12]	HashMap$Entry  (id=27918)	
			[14]	HashMap$Entry  (id=27919)	
			[16]	HashMap$Entry  (id=27921)	
			[17]	HashMap$Entry  (id=27922)	
			[20]	HashMap$Entry  (id=27924)	
			[26]	HashMap$Entry  (id=27932)	
			[27]	HashMap$Entry  (id=27933)	
			[28]	HashMap$Entry  (id=27934)	
			[29]	HashMap$Entry  (id=27936)	
			[30]	HashMap$Entry  (id=27937)	
			[31]	HashMap$Entry  (id=27939)	
			[32]	HashMap$Entry  (id=27940)	
			[34]	HashMap$Entry  (id=27942)	
			[35]	HashMap$Entry  (id=27944)	
			[38]	HashMap$Entry  (id=27945)	
			[40]	HashMap$Entry  (id=27946)	
			[41]	HashMap$Entry  (id=27947)	
./billToPartyVO/partyId=java.lang.ref.SoftReference@1a87bb86
			[43]	HashMap$Entry  (id=27948)	
			[46]	HashMap$Entry  (id=27950)	
			[47]	HashMap$Entry  (id=27951)	
			[49]	HashMap$Entry  (id=28014)	
			[52]	HashMap$Entry  (id=28015)	
			[56]	HashMap$Entry  (id=28016)	
			[61]	HashMap$Entry  (id=28017)	
			[62]	HashMap$Entry  (id=28018)	
			[63]	HashMap$Entry  (id=28019)	
myValue	"9148459" (id=27833)	

/ Intermezzo

$ vi ShipmentOrder.standard.hbm.xml
		<component name="billToPartyVO" class="com.mpobjects.oms.model.entity.VirtualParty">
			<property name="code" column="INVOICE_PARTY_ID" />

pnllogistics2=# select  invoice_party_id from shipment_order where shipment_order_id='SH000002609';
-[ RECORD 1 ]----+--------
invoice_party_id | 9148459

/ Einde Intermezzo

/t
RAgreementSelCriterion.getMatchValue(JXPathContext) line: 158	
		Object myValue = myOrderDetail.retrieveValueFromOrder(aJXPathContext);
/d
"9148459"
/ partyId van buildToParty	,
		return myValue;
/t
RAgreementSelCriterion.matches(JXPathContext) line: 86	
		Object myValue = getMatchValue(aJXPathContext);
/d
"9148459"
		return matchValue(myValue);
/s
RAgreementSelCriterion.matchValue(Object) line: 103	
		Matcher myMatcher = getMatchTypeName().getMatcher(this);
/s
RAgreementSelCriterion.getMatchTypeName() line: 53	
		return getMatchType().getMatchTypeName();
/ getMatchType()=theMatchType=MatchTypeVO SystemId [3800001], Name [REGEX]
MatchTypeName.REGEXX
/t
RAgreementSelCriterion.matchValue(Object) line: 103	
		Matcher myMatcher = getMatchTypeName().getMatcher(this);
/s
MatchTypeName$5.getMatcher(MatchCriterium) line: 43	
public enum MatchTypeName {
	REGEX {
		@Override
		public Matcher getMatcher(MatchCriterium aMatchCriterium) {
->			return new RegexMatcher(aMatchCriterium.getValueFrom());
		}
	},
aMatchCriterium	RAgreementSelCriterion  (id=26853)	
	theValueFrom	"9831001" (id=26955)	
/s
RegexMatcher.<init>(String) line: 27	
/=
	public RegexMatcher(String aRegex) {
aRegex	"9831001" (id=26955)	

/t
RAgreementSelCriterion.matchValue(Object) line: 104	
/=
	public boolean matchValue(Object aValue) {
aValue	"9148459" (id=27833)										/ de bill_to partyId uit de new sho	, = die uit de original sho	,
		Matcher myMatcher = getMatchTypeName().getMatcher(this);
myMatcher	RegexMatcher  (id=28640)	
	theRegex	"9831001" (id=26955)								/ uit de RAgreementSelCriterion van deze rate agreement	,
/s
RegexMatcher.match(Object) line: 54	
		return theInvertFlag ? !myValue.matches(theRegex) : myValue.matches(theRegex);
this	RegexMatcher  (id=28640)	
	theRegex	"9831001" (id=26955)	
myValue	"9148459" (id=27833)	

/t
RAgreementSelCriterion.matchValue(Object) line: 105	
		boolean myResult = myMatcher.match(aValue);
/d
false
/t
RateAgreementVO.matches(JXPathContext) line: 419	
		for (RAgreementSelCriterion myRagreementSelCriteriumVO : myRagreementSelCriteriumList) {
			if (!myRagreementSelCriteriumVO.matches(aContext)) {
/ JA
				return false;
/t
CalculationServiceImpl.getMatchingRateAgreement(LogisticsOrderVO, AgreementType) line: 752	
this	CalculationServiceImpl  (id=25335)	
		JXPathContext myContext = JXPathContext.newContext(aLogisticsOrder);
					} else {
						myKey = "SHO-" + aRateType + aLogisticsOrder.getSystemId();
"SHO-SHIPMENT_ORDER26831387"
			for (RateAgreementVO myRateAgreementVO : myPreselectedList) {
/ 207 rate agreeements	,
				if (myResultList.isEmpty() || !myResultList.contains(myRateAgreementVO)) {
					if (myRateAgreementVO.matches(myContext)) {
/ NEE
/ de 1ste criterion was al false	, de 2de probeert hij niet eens	,

/ volgende	
...
/ we set b	,
			for (RateAgreementVO myRateAgreementVO : myPreselectedList) {
				if (myResultList.isEmpty() || !myResultList.contains(myRateAgreementVO)) {
					if (myRateAgreementVO.matches(myContext)) {
/ JA
/ deze rate agreement match	,
Name: VT-9148459-2015
Description: Verkooptarief Gildewerk BV 2015
Selection criteria
BILL_TO_PARTY(SHO) 9148459	REGEX
REQ_START_AFTER(SHO) 01-Jan-2015 31-Dec-2015 DATE_RANGE

						myResultList.add(myRateAgreementVO);

/ deze rate agreement match	,
Name: RA-BUSINESSRULES SHO 
Description: Business rules PostNL 
Selection criteria
Order detail		Value_from
ORGANIZATION(SHO) 	PNL-CARGO		REGEX

			} else {
				if (aLogisticsOrder.isPersistent() && !AgreementType.SHIPMENT_ORDER_PROPERTIES.equals(aRateType) && !StringUtils.isEmpty(myKey)) {
/ JA
aRateType=AgreementType.SHIPMENT_ORDER
myKey=SHO-SHIPMENT_ORDER26831387
					for (RateAgreementVO myRateAgreementVO : myResultList) {
						myEntry[i] = myRateAgreementVO.getSystemId();
/ myEntry=[26768606, 26773867]
					matching_cache.addObject(myKey, myEntry);
/ this=CalculationServiceImpl	, this.matching_cache	,
			return myResultList;
////////////////////////////////////////////
/ de 2 ra's die match deze sho	,

/t
CalculationServiceImpl.recalculate(LogisticsOrderVO, AgreementType, TMSEventContext) line: 498	
			List<RateAgreementVO> mySelectedRateAgreement = getMatchingRateAgreement(anOrder, aRateType);
/d
/ de 2 ra's die match deze sho	,

			// Now calculate the rates
			RateCalculationVO myRateCalculationVO = new RateCalculationVO();
			} else if (anOrder instanceof ShipmentOrderVO) {
				myRateCalculationVO.setShipmentOrder((ShipmentOrderVO) anOrder);

			} else {
				myRateCalculationVO.setRateAgreementVO(mySelectedRateAgreement);
/ de 2 ra's die match deze sho	,
/s
RateCalculationVO.setRateAgreementVO(List<RateAgreementVO>) line: 959	
		rateAgreement = aRateAgreementList;
/ de 2 ra's die match deze sho	,
		} else {
			agreementType = aRateAgreementList.iterator().next().getAgreementType();
AgreementType.SHIPMENT_ORDER

/t
CalculationServiceImpl.recalculate(LogisticsOrderVO, AgreementType, TMSEventContext) line: 533	
			} else {
				myRateCalculationVO.setRateAgreementVO(mySelectedRateAgreement);
/d
				} else if (anOrder instanceof ShipmentOrderVO) {
					ShipmentOrderVO myShipmentOrder = (ShipmentOrderVO) anOrder;
					if (!myRateCalculationVO.rateCalculationRequired()) {
/s
RateCalculationVO.rateCalculationRequired() line: 744	
		// First check if we need to calculate
		LogisticsOrderVO myOrder = getOrder();
ShipmentOrder: SH000002609copy(SystemId:26831387; Org:PNL-CARGO)
		if (myOrder != null && !StringUtils.isEmpty(myOrder.getRatecalcMd5Hash())) {
			String myHash = RateCalcHashCalculator.calculate(rateAgreement, myOrder);
/s
RateCalcHashCalculator.calculate(List<RateAgreementVO>, LogisticsOrderVO) line: 32	
/=
	public static String calculate(List<RateAgreementVO> aRateAgreement, @Nonnull LogisticsOrderVO anOrder) {
			Hibernate.initialize(anOrder.getEntityDetails());
			for (RateAgreementVO myAgreement : aRateAgreement) {
				Collection<Object> myValues = myAgreement.getOrderDetailValues(anOrder);
/s
RateAgreementVO.getOrderDetailValues(Object) line: 209	

/ iedere ra heeft een list van rate tables	,

		JXPathContext myContext = JXPathContext.newContext(anOrderVO);

		// Dimensions and selection criteria of rate tables can be order details too
		for (RateTableVO myRateTableVO : getRateTableList()) {
			for (DimensionVO myDimension : myRateTableVO.getDimensionList()) {
				if (myDimension.getOrderDetail() != null) {
					myRet.add(myDimension.getOrderDetail().retrieveValueFromOrder(myContext));
/s
DimensionVO.getOrderDetail() line: 97	
		return getInputParameter().getOrderDetailVO();
this	DimensionVO  (id=30087)	
	basicChargeApplicable	false	
	discrete	true	
	inputParameter	InputParameterVO  (id=30245)	
		performanceMonitorService	null	
		systemId	26768757	
		theConfigurationValue	null	
		theFreeValue	null	
		theFuncParDef	null	
		theOrderDetail	OrderDetail  (id=30451)	
		theParameter	null	
		theRateFunc	RateFunctionVO  (id=30452)	
			performanceMonitorService	null	
			systemId	26768758	
			theFunctionDefinition	FunctionDefinitionVO  (id=31304)	
			theInputParameterList	PersistentSet  (id=31305)	
			theIsUserDefined	false	
			theRateParameter	RateParameterVO  (id=31307)	
			theRateTable	RateTableVO  (id=30493)	
			theUnit	null	
			theUserFuncDef	null	
		theRateResult	null	
	LOG	Log4JLogger  (id=30491)	
	maxMinMode	null	
	name	"RTD-AANTAL-PAL" (id=30492)	
	performanceMonitorService	null	
	rangePermitted	false	
	rateTable	RateTableVO  (id=30493)	
	regexPermitted	false	
	rounding	false	
	systemId	26768754	
	theSequenceNr	1	
	unit	Unit  (id=30494)	
/ TODO

/t
RateAgreementVO.getOrderDetailValues(Object) line: 217	
					myRet.add(myDimension.getOrderDetail().retrieveValueFromOrder(myContext));
/s
OrderDetail.retrieveValueFromOrder(JXPathContext) line: 178	
		String myPathOrClass = getPathOrClass();
count(./topLevelShipmentItems[shippingUnitVO/code='P'])
		Object myValue = aContext.getValue(myPathOrClass);
0.00
		return myValue;

/t
RateAgreementVO.getOrderDetailValues(Object) line: 220	
		// Dimensions and selection criteria of rate tables can be order details too
		for (RateTableVO myRateTableVO : getRateTableList()) {
			for (DimensionVO myDimension : myRateTableVO.getDimensionList()) {
				if (myDimension.getOrderDetail() != null) {
					myRet.add(myDimension.getOrderDetail().retrieveValueFromOrder(myContext));
/d
/ Er is maar 1 dimension op deze rate table	,
/ er zijn 2 criteria	,
			for (RTableSelCriterion myCriterion : myRateTableVO.getSelectionCriterionList()) {
				if (myCriterion.getOrderDetail() != null) {
					myRet.add(myCriterion.getOrderDetail().retrieveValueFromOrder(myContext));
[0.0, 0.0]
[0.0, 0.0, NL]

/c
/myRet=[0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.00000, 0.00000, 0.0, 0.0, , 0.0, 0.0, ]
		Collection<RateParameterVO> myRateParameterList = getRateParameterList();

/ Intermezzo

/ In de GUI in de ra kies tab Parameters	,
/ we zien er maar 1	, RP-VRACHT	,
/ edit,	 
/ we zien Parameters	, 
this	RateAgreementVO  (id=26690)	
anOrderVO	ShipmentOrderVO  (id=3017)	
myRet	ArrayList  (id=29902)	
myContext	JXPathContextReferenceImpl  (id=29903)	
myRateParameterList	PersistentSet  (id=26717)	
	set	HashSet  (id=31740)	
		map	HashMap  (id=31744)	
			size	22	
			table	HashMap$Entry[32]  (id=31750)	
				[0]	HashMap$Entry  (id=31759)	
theSystemId: 26768745Name :RT-PALLETSTAFFEL-CH-1_OUTPUT
				[4]	HashMap$Entry  (id=31760)	
theSystemId: 26768650Name :RT-Rembourstoeslag_OUTPUT
				[5]	HashMap$Entry  (id=31761)	
theSystemId: 26768618Name :RT-PALLETSTAFFEL-BE-1_OUTPUT
				[7]	HashMap$Entry  (id=31762)	
				[8]	HashMap$Entry  (id=31764)	
				[9]	HashMap$Entry  (id=31765)	
				[10]	HashMap$Entry  (id=31766)	
				[11]	HashMap$Entry  (id=31767)	
				[12]	HashMap$Entry  (id=31768)	
				[13]	HashMap$Entry  (id=31769)	
				[18]	HashMap$Entry  (id=31770)	
				[20]	HashMap$Entry  (id=31771)	
				[21]	HashMap$Entry  (id=31772)	
				[22]	HashMap$Entry  (id=31774)	
				[23]	HashMap$Entry  (id=31776)	
				[29]	HashMap$Entry  (id=31777)	
				[31]	HashMap$Entry  (id=31779)	

/ Dit zijn results van de RATE_TABLE function	, 
/ Dit is automatisch zo	, er staat in de GUI nergens dat RATE_FUNCTION de fct is	,

/ In de GUI, kijk in de rate table	, 
RT-PALLETSTAFFEL-AT-1
/ we zien onder Dimensions	,
Name 			Order detail
RTD-AANTAL-PAL	NR_OF_PALLET(SHO)


/ neem de 1ste rate parameter	,

pnllogistics2=# select*from rate_parameter where system_id=26768745;
 system_id |             name             | description | outputfrom_function_systemid | rate_agreement_systemid | is_persistent | sequence_nr |
 parameter_type_systemid | is_user_editable | iteration_entity | iteration_action 
-----------+------------------------------+-------------+------------------------------+-------------------------+---------------+-------------+
-------------------------+------------------+------------------+------------------
  26768745 | RT-PALLETSTAFFEL-CH-1_OUTPUT |             |                     26768744 |                26768606 |             0 |           0 |
                         |                0 |                  | 
(1 row)

pnllogistics2=# select*from rate_function where system_id= 26768744;
 system_id | function_definition_systemid | is_user_defined | user_func_def | rate_table_systemid | unit_systemid 
-----------+------------------------------+-----------------+---------------+---------------------+---------------
  26768744 |                      3500001 |               0 |               |            26768739 |              
(1 row)

pnllogistics2=# select*from function_definition where system_id=3500001;
 system_id |                             definition                              |    name    
-----------+---------------------------------------------------------------------+------------
   3500001 | com.mpobjects.oms.ratecalc.model.process.function.RateTableFunction | RATE TABLE
(1 row)

/ we zien overigens	,

pnllogistics2=# select name from rate_parameter;
                       name                        
---------------------------------------------------
 RP-VRACHT
 RT-EXECUTED-BY-PARTY-COLLECT_OUTPUT
 TT-PALLETTARIEF-NL_OUTPUT

pnllogistics2=# select * from input_parameter where system_id=26768743;
 system_id | parameter_systemid | func_par_def_systemid | rate_func_systemid | dimension_systemid | configuration_value | order_detail_systemid 
| free_value 
-----------+--------------------+-----------------------+--------------------+--------------------+---------------------+-----------------------
+------------
  26768743 |                    |                       |           26768744 |                    |                     |              26681459 
|           
(1 row)


/ Einde Intermezzo

		for (RateParameterVO myParameter : myRateParameterList) {
theSystemId: 26768745Name :RT-PALLETSTAFFEL-CH-1_OUTPUT
			if (myParameter.getOutputfromFunctionVO() != null) {
				myInputParameterList = myParameter.getOutputfromFunctionVO().getInputParameterList();
 myParameter.getOutputfromFunctionVO()=com.mpobjects.oms.ratecalc.model.ratefunction.vo.RateFunctionVO/id:26768744
[SystemId: 26768743]
				for (InputParameterVO element : myInputParameterList) {
					OrderDetail myOrderDetailVO = element.getOrderDetailVO();
SystemId: 26681459, Name :NR_OF_PALLET, PathOrClass :count(./topLevelShipmentItems[shippingUnitVO/code='P'])
					if (myOrderDetailVO != null) {
						myRet.add(myOrderDetailVO.retrieveValueFromOrder(myContext));

/ we zien in de GUI NIET input parameter	, 
/ TODO

/c
RateAgreementVO.getOrderDetailValues(Object) line: 220	
		return myRet;
[0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.00000, 0.00000, 0.0, 0.0, , 0.0, 0.0, , 0.0, 0.00000, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]

/t
RateCalcHashCalculator.calculate(List<RateAgreementVO>, LogisticsOrderVO) line: 35	
			for (RateAgreementVO myAgreement : aRateAgreement) {
				Collection<Object> myValues = myAgreement.getOrderDetailValues(anOrder);
/d
[0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.0, 0.0, NL, 0.00000, 0.00000, 0.0, 0.0, , 0.0, 0.0, , 0.0, 0.00000, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]

				myValues.add(myAgreement.getName());
				addAllAsStrings(sortedset, myValues);
/ sortedSet=[, 0.0, 0.00000, NL, VT-9148459-2015]
/ alle verschillende: "", "0.0", "0.00000", "NL", "VT-9148459-2015"]

/ volgende	,
public class RateCalcHashCalculator {

	public static String calculate(List<RateAgreementVO> aRateAgreement, @Nonnull LogisticsOrderVO anOrder) {
		Validate.notNull(anOrder, "Logistics order can't be null");
		try {
			Hibernate.initialize(anOrder.getEntityDetails());
			SortedSet<Object> sortedset = new TreeSet<Object>();
			for (RateAgreementVO myAgreement : aRateAgreement) {
				Collection<Object> myValues = myAgreement.getOrderDetailValues(anOrder);
				myValues.add(myAgreement.getName());
[0.0, NL, NL, 12, 13, 2656gh, 3012cn, Eindhoven, PNL-CARGO, 0, NL, 3012cn, PNL-CARGO, NL, 3012cn, PNL-CARGO, NL, PNL-CARGO, 3012cn, NL, NL, NL, 3012cn, PNL-CARGO, , 9148459, NL, 0.0, 0, 0.0, PNL-CARGO, false, null, PNL-CARGO, 2656gh, NL, NL, PNL-CARGO, 2656gh, NL, NL, 2656gh, PNL-CARGO, NL, 2656gh, PNL-CARGO, NL, PNL-CARGO, 0, , , , , null, null, null, 9148459, PNL-CARGO, 3610, 3610, NL, NL, 3012cn, 2656gh, 3610, , , , 3610, 3610, null, , , , , 3610, 2656gh, 0.0, 0.0, , , 3610, BENELUXFREIGHT, PNL-CARGO, NL, 3012cn, PNL-CARGO, 3012cn, NL, , 3610, , 2015-07-30 08:00:00.0, 2015-07-30 08:00:00.0, PNL-CARGO, NL, 2656gh, 2015-07-30 08:00:00.0, PNL-CARGO, NL, 3012cn, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, PNL-CARGO, Eindhoven, 12, NL, 2656gh, NL, 3012cn, 13, 2656gh, NL, PNL-CARGO, PNL-CARGO, 2656gh, , null, 0.0, 2015-07-30 18:00:00.0, 9148459, , NL, 3610, , NL, 2656gh, PNL-CARGO, , , 3610, null, null, null, 2656gh, NL, PNL-CARGO, null, 3610, 3610, , 3012cn, 2656gh, NL, NL, PNL-CARGO, 3012cn, PNL-CARGO, NL, PNL-CARGO, 3610, 3610, BENELUXFREIGHT, null, NL, 0.0, 0.0, null, null, RA-BUSINESSRULES SHO]

				addAllAsStrings(sortedset, myValues);
/ sortedSet=[, 0, 0.0, 0.00000, 12, 13, 1438236000000, 1438272000000, 2656gh, 3012cn, 3610, 9148459, BENELUXFREIGHT, Eindhoven, NL, PNL-CARGO, RA-BUSINESSRULES SHO, VT-9148459-2015, false]

/c
/ we hebben alle rate agreements gehad	,
			String myValuesAsString = StringUtils.implode(sortedset.toArray(), "-");
/ sortedSet=[, 0, 0.0, 0.00000, 12, 13, 1438236000000, 1438272000000, 2656gh, 3012cn, 3610, 9148459, BENELUXFREIGHT, Eindhoven, NL, PNL-CARGO, RA-BUSINESSRULES SHO, VT-9148459-2015, false]
"-0-0.0-0.00000-12-13-1438236000000-1438272000000-2656gh-3012cn-3610-9148459-BENELUXFREIGHT-Eindhoven-NL-PNL-CARGO-RA-BUSINESSRULES SHO-VT-9148459-2015-false"
			return StringUtils.encriptSha(myValuesAsString);

/t
RateCalculationVO.rateCalculationRequired() line: 747	
			String myHash = RateCalcHashCalculator.calculate(rateAgreement, myOrder);
/d
178A24DD3D0B0CF22EAF7AD9C27BEB5E89705DA9
			if (ObjectUtils.equals(myHash, myOrder.getRatecalcMd5Hash())) {
/ NEE
		return true;
/t
CalculationServiceImpl.recalculate(LogisticsOrderVO, AgreementType, TMSEventContext) line: 565	
					if (!myRateCalculationVO.rateCalculationRequired()) {
	 * Returns true if the input values for the order have changed.
true
/ TODO ERICJ (Waarom input values veranderd?)
				// Now calculate the rates
				myRateCalculationVO.runFor(mySelectedRateAgreement);
/ list van 2 rate agreements	, die voldeden aan de data in de copied sho	,
/s
RateCalculationVO.runFor(List<RateAgreementVO>) line: 765	
		setRateAgreementVO(aRateAgreementVO);
/ list van 2 rate agreements	, die voldeden aan de data in de copied sho	,
		LogisticsOrderVO myOrder = getOrder();
ShipmentOrder: SH000002609copy(SystemId:26831387; Org:PNL-CARGO)

			// In case of multiple rate agreement, iterate over first list only!
			Set<Variable> myList = aRateAgreementVO.iterator().next().getVariableList();
[]
			if (myList.size() == 0) {
/ JA
				/* No variables (iteration) involved */
				addToLog("Calculating rate agreement, no variables defined");
				calculateWithoutVariables();
/s
RateCalculationVO.calculateWithoutVariables() line: 1330	
			RateCalculationAlternative myAlterNative = new RateCalculationAlternative(this);
			alternativeList.add(myAlterNative);
			for (RateAgreementVO myAgreement : getRateAgreementVO()) {
/  getRateAgreementVO()=list van 2 rate agreements	, die voldeden aan de data in de copied sho	,
				runFor(myAgreement, myAlterNative);
/s
RateCalculationVO.runFor(RateAgreementVO, RateCalculationAlternative) line: 1066	
/=
	protected void runFor(RateAgreementVO aRateAgreementVO, RateCalculationAlternative anAlternative) {

/  aRateAgreementVO is dus de 1ste ra	, uit de lijst van 2 , waaraan de sho voldoet aan de order details onder de selection criteria tab van de ra staan	,

this	RateCalculationVO  (id=29142)	
	rateCalculation	RateCalculationVO  (id=29142)	
rateCalculationVO (RA: VT-9148459-2015,RA-BUSINESSRULES SHO, orderSystemid:ShipmentOrder: SH000002609copy(SystemId:26831387; Org:PNL-CARGO))
/ we zien 2 ra's : VT-9148459-2015,RA-BUSINESSRULES SHO
/ we zien de orderSystemid: ShipmentOrder: SH000002609copy(SystemId:26831387; Org:PNL-CARGO)

			// Put manually modified results in a map.
			populateManuallyModifiedResultsMap();
/ NIETS
			initObjectMap();
/s
	private void initObjectMap() {
		if (shipmentOrder != null) {
			objectMap.put(EntityType.SHIPMENT_ORDER.name(), shipmentOrder);
{SHIPMENT_ORDER=ShipmentOrder: SH000002609copy(SystemId:26831387; Org:PNL-CARGO)}

			EntityType myAgreementType = getCurrentEntityType();
EntityType.SHIPMENT_ORDER
			for (CostComponentSpecificationVO myCostComponent : aRateAgreementVO.getCostComponentSpecificationList()) {
this	RateCalculationVO  (id=29142)	
aRateAgreementVO	RateAgreementVO  (id=26690)	
	theCostComponentSpecificationList	PersistentSet  (id=26731)	
		set	HashSet  (id=33415)	
			map	HashMap  (id=33434)	
				size	1	
				table	HashMap$Entry[16]  (id=33448)	
					[13]	HashMap$Entry  (id=33450)	
						key	CostComponentSpecificationVO  (id=33473)	
							$SWITCH_TABLE$com$mpobjects$oms$ratecalc$model$costcomponentspecification$vo$RatePlusMode	null	
							calculationType	CalculationType  (id=33711)	
							correctionType	CorrectionType  (id=33712)	
							entityType	EntityType  (id=27190)	
							evaluationObjective	EvaluationObjective  (id=33720)	
							performanceMonitorService	null	
							rateAgreement	RateAgreementVO  (id=26690)	
							rateComponentType	RateComponentType  (id=33904)	
							rateParameter	RateParameterVO  (id=33920)	
							ratePlusMode	RatePlusMode  (id=33921)	
							systemId	26768863	
							theDescription	"Totale Vrachtkosten" (id=33938)	
							theName	"RC-VRACHT" (id=33939)	
							theSequenceNr	0	

/ Deze zien we in de GUI 	, in de ra	, 
Name: VT-9148459-2015
/ we zien tab Rate components
RC-VRACHT Totale Vrachtkosten
/ Dit is 'm	,
/ edit
Parameter: RP-VRACHT
Calculation type: Post Calculated(Estimated)

			for (CostComponentSpecificationVO myCostComponent : aRateAgreementVO.getCostComponentSpecificationList()) {
				if (!myAgreementType.equals(myCostComponent.getEntityType())) {
/ NEE
				} else {
					myCostComponentSpecificationList.add(myCostComponent);

				componentLoop: for (CostComponentSpecificationVO myCostComp : myCostComponentSpecificationList) {
					for (RateResult myResult : myCostComp.run(this)) {
/s
CostComponentSpecificationVO.run(RateCalculationVO) line: 195	
this	CostComponentSpecificationVO  (id=33473)	
		} else {
			RateParameterVO myParameter = getRateParameter();
/ rateParameter=
theSystemId: 26768862Name :RP-VRACHT
Description :TOTAAL VRACHT TARIEF
/ Klopt , this=rate component=RC-VRACHT heeft 1 rate parameter =RP-VRACHT

			RateResult myResult = myParameter.calculate(aRateCalculation);
/s
RateParameterVO.calculate(RateCalculationVO) line: 66	
			RateResult myResult = aRateCalculation.getManuallyModifiedResult(this);
null
			if (myResult == null) {
				// Note, the RateCalculation cache is cleared after each alternative
				if (!aRateCalculation.hasCachedResult(this)) {
/ JA
						if (aRateCalculation.shouldCalculate(this)) {
/s
RateCalculationVO.shouldCalculate(RateParameterVO) line: 972	
			// Clear object map
			initObjectMap();

/=
	public boolean shouldCalculate(RateParameterVO aParameter) throws RateException {
		AbstractRateFunction myFunction = getRateFunction(aParameter);
/s
RateCalculationVO.getRateFunction(RateParameterVO) line: 624	
		String myKey = aRateParameterVO.getName();
"RP-VRACHT"
			RateFunctionVO myOutputfromFunction = aRateParameterVO.getOutputfromFunctionVO();
myOutputfromFunction	RateFunctionVO_$$_javassist_83  (id=34450)	
			FunctionDefinitionVO myFunctionDefinition = myOutputfromFunction.getFunctionDefinitionVO();
theSystemId: 3500006
Definition :com.mpobjects.oms.ratecalc.model.process.function.SumFunction,Name :SUM

/ Intermezzo

pnllogistics2=# select fd.* from rate_parameter rp join rate_function rf on rp.outputfrom_function_systemid=rf.system_id join function_definition fd on fd.system_id=rf.function_definition_systemid where rp.system_id= 26768862;
 system_id |                          definition                           | name 
-----------+---------------------------------------------------------------+------
   3500006 | com.mpobjects.oms.ratecalc.model.process.function.SumFunction | SUM
(1 row)

/ Einde Intermezzo

			String myClassName = myFunctionDefinition.getDefinition();
"com.mpobjects.oms.ratecalc.model.process.function.SumFunction"
			try {
				Class<?> myClass = Class.forName(myClassName);
				myFunction = (AbstractRateFunction) myClass.newInstance();
				myFunction.setRateFunctionVO(myOutputfromFunction);
				myFunction.setRateContext(this);
this	RateCalculationVO  (id=29142)	
			rateFunctionCache.put(myKey, myFunction);
myKey	"RP-VRACHT" (id=34445)	

/t
RateCalculationVO.shouldCalculate(RateParameterVO) line: 973	
		AbstractRateFunction myFunction = getRateFunction(aParameter);
/d
myFunction	SumFunction  (id=35122)	
		String myKey = aParameter.getName() + getCacheNameSuffix();
myKey	"RP-VRACHT" (id=35241)	
				myResult = myFunction.shouldCalculate(this);
/ returns true	,
			shouldCalculateCache.put(myKey, myResult);
"RP-VRACHT":true
		return myResult.booleanValue();
/t
RateParameterVO.calculate(RateCalculationVO) line: 77	

						if (aRateCalculation.shouldCalculate(this)) {
							AbstractRateFunction myAbstractRateFunction = aRateCalculation.getRateFunction(this);
this	RateParameterVO  (id=33920)	
RP-VRACHT
myAbstractRateFunction	SumFunction  (id=35122)	
	theRateContext	RateCalculationVO  (id=29142)	
	theRateFunctionVO	RateFunctionVO_$$_javassist_83  (id=34450)	
	withDebugLog	true	

/ myAbstractRateFunction bevat dus myRateFunction	, hieronder	,

							RateFunctionVO myRateFunction = getOutputfromFunctionVO();
myRateFunction	RateFunctionVO_$$_javassist_83  (id=34450)	
	handler	JavassistLazyInitializer  (id=34945)	
		target	RateFunctionVO  (id=35552)	
			performanceMonitorService	null	
			systemId	26768844	
			theFunctionDefinition	FunctionDefinitionVO  (id=34974)	
theSystemId: 3500006
Definition :com.mpobjects.oms.ratecalc.model.process.function.SumFunction,Name :SUM
			theInputParameterList	PersistentSet  (id=35554)	
[SystemId: 26768854, SystemId: 26768853, SystemId: 26768855, SystemId: 26768856, SystemId: 26768857, SystemId: 26768851, SystemId: 26768861, SystemId: 26768852, SystemId: 26768860, SystemId: 26768848, SystemId: 26768859, SystemId: 26768845, SystemId: 26768846, SystemId: 26768849, SystemId: 26768858, SystemId: 26768850, SystemId: 26768847]
			theIsUserDefined	false	
			theRateParameter	RateParameterVO  (id=33920)	
theSystemId: 26768862Name :RP-VRACHT
Description :TOTAAL VRACHT TARIEF
			theRateTable	null	
			theUnit	Unit  (id=26733)	
			theUserFuncDef	null	


/ Intermezzo

ra VT-9148459-2015
Verkooptarief Gildewerk BV 2015
/ we zien onder tab 'Rate Components' rc RC-VRACHT
/ deze heeft 1 parameter	,
rp RP-VRACHT
/ Deze zien we ook onder tab Parameters	,
/ edit deze	, 
Deze wordt berekend met Sum fct	,

/ Einde Intermezzo

							Collection<InputParameterVO> myInputParameterList = myRateFunction.getInputParameterList();
[SystemId: 26768854, SystemId: 26768853, SystemId: 26768855, SystemId: 26768856, SystemId: 26768857, SystemId: 26768851, SystemId: 26768861, SystemId: 26768852, SystemId: 26768860, SystemId: 26768848, SystemId: 26768859, SystemId: 26768845, SystemId: 26768846, SystemId: 26768849, SystemId: 26768858, SystemId: 26768850, SystemId: 26768847]

							} else {
								// First, make sure all input parameters are calculated
								for (InputParameterVO myInputParameter : myInputParameterList) {
									RateResult mySub = myInputParameter.calculate(aRateCalculation);
/s
InputParameterVO.calculate(RateCalculationVO) line: 71	
this	InputParameterVO  (id=35820)	
	theParameter	RateParameterVO  (id=35840)	
theSystemId: 26768780Name :RT-PALLETSTAFFEL-PL-2_OUTPUT

/ BIJNA recursive call	, this=RT-PALLETSTAFFEL-PL-2_OUTPUT	, in caller this=RP-VRACHT
/ we zijn nu in InputParameterVO.calculate, zonet in RateParameterVO.calculate

/ we kunnen altijd naar de ra	,
this	InputParameterVO  (id=20728)	
	theOrderDetail	null	
	theParameter	RateParameterVO  (id=20762)	
		theRateAgreement	RateAgreementVO  (id=20827)	
			description	"Verkooptarief Gildewerk BV 2015" (id=20905)	
			name	"VT-9148459-2015" (id=20932)	

			OrderDetail myServiceorderDetail = getOrderDetailVO();
null
/ WH is dit in de GUI als je de rate parameter RP-VRACHT edit	, dan zien we de list van parameters, bijv RT-PALLETSTAFFEL-PL-2_OUTPUT, en de free value parameter, de leeg is en de order details  die er ook niet zijn	, 	

			RateParameterVO myParameter = get ParameterVO();
/= theParameter
			if (myServiceorderDetail != null) {
/ NEE
			} else if (myFreeValue != null) {
/ NEE
			} else if (myParameter != null) {
/ JA
				myRateResult = myParameter.calculate(aRateCalculation);
/s
RateParameterVO.calculate(RateCalculationVO) line: 66	
this	RateParameterVO  (id=20762)	
theSystemId: 26768759Name :RT-PALLETSTAFFEL-AT-1_OUTPUT
/ Nu wel recursive call	, want we zitten nog in , met this=RP-VRACHT	,

						if (aRateCalculation.shouldCalculate(this)) {
/s
RateCalculationVO.shouldCalculate(RateParameterVO) line: 972	
/=
	public boolean shouldCalculate(RateParameterVO aParameter) throws RateException {
this	RateCalculationVO  (id=19969)	
aParameter	RateParameterVO  (id=20762)	
	theOutputfromFunction	RateFunctionVO  (id=20826)	
		theInputParameterList	PersistentSet  (id=22222)	
			set	HashSet  (id=22872)	
				map	HashMap  (id=22876)	
					size	1	
					table	HashMap$Entry[16]  (id=22880)	
						[10]	HashMap$Entry  (id=22882)	
							key	InputParameterVO  (id=22884)	
								performanceMonitorService	null	
								systemId	26768757	
								theConfigurationValue	null	
								theFreeValue	null	
								theFuncParDef	null	
								theOrderDetail	OrderDetail  (id=22889)	
SystemId: 26681459, Name :NR_OF_PALLET, PathOrClass :count(./topLevelShipmentItems[shippingUnitVO/code='P'])
								theParameter	null	
								theRateFunc	RateFunctionVO  (id=20826)	
								theRateResult	null	
							value	Object  (id=22885)	

/ Deze order detail zien we ook in de GUI: ga naar de ra, tab rate tables	, edit RT-PALLETSTAFFEL-AT-1_OUTPUT	, we komen in het 'Edit Ratetable' scherm, we zien onder Dimension tab 1 order detail	,

		AbstractRateFunction myFunction = getRateFunction(aParameter);
		theUnit	null	
myFunction	RateTableFunction  (id=24206)	
	theRateFunctionVO	RateFunctionVO  (id=20826)	
/ Dit is weer de rate parameter's theOutputfromFunction	,

				myResult = myFunction.shouldCalculate(this);
/s
RateTableFunction.shouldCalculate(RateCalculationVO) line: 374	
		RateTableVO myRateTable = getRateFunctionVO().getRateTableVO();
this	RateTableFunction  (id=24206)	
	theRateFunctionVO	RateFunctionVO  (id=24207)	

myRateTable	RateTableVO  (id=24209)	
	content	"1.0\t228.00\n2.0\t280.00\n3.0\t350.00" (id=24433)	
	description	"Pallet tarief ES 1 tot 3" (id=24434)	
	dimensionList	PersistentBag  (id=24436)	
	selectionCriterionList	PersistentBag  (id=24443)	
	systemId	26768803	
	theName	"RT-PALLETSTAFFEL-ES-1" (id=24447)	
	theRateTableRows	null	

/ Intermezzo 

pnllogistics2=# select * from rate_table where system_id=26768803;
-[ RECORD 1 ]--------------+-------------------------
rate_agreement_systemid    | 26768606
system_id                  | 26768803
name                       | RT-PALLETSTAFFEL-ES-1
description                | Pallet tarief ES 1 tot 3
unit_systemid              | 1000072
rate_table_xml             | 
min_charge                 | 
max_charge                 | 
rounding                   | 0
excel_formatted            | 0
default_value              | 
rate_table_content         | 1.0     228.00
                           | 2.0     280.00
                           | 3.0     350.00
is_user_editable           | 0
is_shared                  | 0
linked_rate_table_systemid | 
linked_multiplication      | 
linked_addition            | 
last_update                | 2015-05-12 13:34:58.022

/ Einde Intermezzo 

		return myRateTable.meetsTableSelectionCriteria(aRateCalculation);
/s
RateTableVO.meetsTableSelectionCriteria(RateCalculationVO) line: 964	
		for (RTableSelCriterion myRTableSelCriterion : getSelectionCriterionList()) {
			myRetValue = myRTableSelCriterion.evaluate(aRateContext);

/ In GUI: scherm 'Edit Ratetable'	, tab Dimensions	, en tab Rate table selection criteria	, 
/ Dimension is wat hij uit gaat rekenen, is 1 order detail	,
/ Rate table selection criteria zijn 2 order details	,

		for (RTableSelCriterion myRTableSelCriterion : getSelectionCriterionList()) {
myRTableSelCriterion	RTableSelCriterion  (id=24605)	
	systemId	26768811	
	theMatchType	MatchTypeVO  (id=24776)	
SystemId [3800003], Name [RANGE]
	theOrderDetail	OrderDetail  (id=22889)	
SystemId: 26681459, Name :NR_OF_PALLET, PathOrClass :count(./topLevelShipmentItems[shippingUnitVO/code='P'])
	theRateParameter	null	
	theRateTable	RateTableVO  (id=24209)	
	theUnit	Unit  (id=24782)	
	theValueFrom	"1" (id=24784)	
	theValueTo	"3" (id=24785)	
/ Klopt	, zien we allemaal in de GUI	,

			myRetValue = myRTableSelCriterion.evaluate(aRateContext);
/s
RTableSelCriterion.evaluate(RateCalculationVO) line: 82	
		Matcher myMatcher = getMatchTypeName().getMatcher(this);
...
/s
public enum MatchTypeName {
	RANGE {
		@Override
		public Matcher getMatcher(MatchCriterium aMatchCriterium) {
->			return new RangeMatcher(aMatchCriterium.getValueFrom(), aMatchCriterium.getValueTo());
		}
	},
aMatchCriterium	RTableSelCriterion  (id=24605)	

/t
RTableSelCriterion.evaluate(RateCalculationVO) line: 84	
		Matcher myMatcher = getMatchTypeName().getMatcher(this);
/d
		if (getOrderDetail() != null) {
			OrderDetail myServiceorderDetail = getOrderDetail();
SystemId: 26681459, Name :NR_OF_PALLET, PathOrClass :count(./topLevelShipmentItems[shippingUnitVO/code='P'])
			myRateResult = aRateContext.evaluate(myServiceorderDetail);
	theUnitVO	Unit  (id=24782)	
theSystemId: 26632357	Symbol :PC	Description :Pieces	UnitType :NORMAL	IsDeleted :0	
	theValue	"0.0" (id=25600)	

			myFromUnit = myServiceorderDetail.getUnit();
		if (myRateResult != null) {
			Unit myToUnit = getUnit();
theSystemId: 26632357	Symbol :PC	Description :Pieces	UnitType :NORMAL	IsDeleted :0	

			} else {
				MpoBeanFactory.getBean(UnitConversionService.class).convert(RateResultUtils.getBigDecimalValue(myRateResult), myFromUnit, myToUnit);

			} else {
				myValue = myRateResult.getValue();
"0.0"
		if (myValue != null) {
			myMatchResult = myMatcher.match(myValue);
/s
RangeMatcher.match(Object) line: 67	
			} else if (aValue instanceof String) {
				try {
					Number myValue = getNumberFormat().parse((String) aValue);
					return match(myValue);
/s
RangeMatcher.match(Number) line: 131	
		if (aValue.doubleValue() < toNumber(theValueFrom).doubleValue()) {
			return false;
/t
RateCalculationVO.shouldCalculate(RateParameterVO) line: 978	
				myResult = myFunction.shouldCalculate(this);
/d
false
			shouldCalculateCache.put(myKey, myResult);
{RT-PALLETSTAFFEL-AT-1_OUTPUT=false, RT-PALLETSTAFFEL-ES-1_OUTPUT=false, RP-VRACHT=true}

/t
RateParameterVO.calculate(RateCalculationVO) line: 75	
						if (aRateCalculation.shouldCalculate(this)) {
/d
/ NEE
						aRateCalculation.cacheResult(this, myResult);
/ myResult=null
/s
RateParameterVO.calculate(RateCalculationVO) line: 75	
		theCachedResultMap.put(aParameter.getName() + getCacheNameSuffix(), aResult);
{RT-PALLETSTAFFEL-AT-1_OUTPUT=null, RT-PALLETSTAFFEL-ES-1_OUTPUT=null}

/t
InputParameterVO.calculate(RateCalculationVO) line: 111	
			} else if (myParameter != null) {
				myRateResult = myParameter.calculate(aRateCalculation);
/d
			setRateResult(myRateResult);
/s
InputParameterVO.setRateResult(RateResult) line: 295	
			theRateResult = new ThreadLocal<RateResult>();
		theRateResult.set(aRateResult);
null

/t
RateParameterVO.calculate(RateCalculationVO) line: 153	
							} else {
								// First, make sure all input parameters are calculated
								for (InputParameterVO myInputParameter : myInputParameterList) {
									RateResult mySub = myInputParameter.calculate(aRateCalculation);
/d
null
									if (mySub != null) {
/ NEE
/ JA
										mySubResults.add(mySub);

/ Intermezzo

/ we willen calculate	,
RC-VRACHT
/ deze heeft een rate param	,
RP-VRACHT
/ deze is result van een RP-VRACHT.theFromOutputFunction, die een list van input params heeft	, 
/ als we in de GUI RP-VRACHT edit, zien we free value, parameters	, order details	, WH zijn dit (zitten in ) input params	,
/ onze input params hebben 1 rate param, bijv. RT-PALLETSTAFFEL-FR-2_OUTPUT	, 
/ deze gaan we ook calc, deze rate param heeft een theFromOutputFunction, met input params	, 
/ in de GUI edit RT-PALLETSTAFFEL-FR-2_OUTPUT, 	we zien Dimansions tab	, zien we de input params	, (toen we RP-VRACHT edit, zagen we free value, parameters, order details op het scherm, nu onder tab Dimensions

myInputParameterList	PersistentSet  (id=25830)	
	set	HashSet  (id=26437)	
		map	HashMap  (id=26442)	
			size	1	
			table	HashMap$Entry[16]  (id=26445)	
				[9]	HashMap$Entry  (id=26449)	
					key	InputParameterVO  (id=25926)	
						performanceMonitorService	PerformanceMonitorServiceImpl  (id=20800)	
						systemId	26768788	
						theConfigurationValue	null	
						theFreeValue	null	
						theFuncParDef	null	
						theOrderDetail	OrderDetail  (id=22889)	
SystemId: 26681459, Name :NR_OF_PALLET, PathOrClass :count(./topLevelShipmentItems[shippingUnitVO/code='P'])
						theParameter	null	
						theRateFunc	RateFunctionVO  (id=25829)	
						theRateResult	ThreadLocal  (id=26406)	

/ we zien dat deze rate param RT-PALLETSTAFFEL-FR-2_OUTPUT geen sel criteria heeft	, vandaar dat hij doorkomt	,
 

/ Einde Intermezzo

/ volgende	,
/c
this	RateParameterVO  (id=25827)	
theSystemId: 26768790Name :RT-PALLETSTAFFEL-FR-2_OUTPUT

mySubResults	ArrayList  (id=25831)	
[0.0 theSystemId: 26632357	Symbol :PC	Description :Pieces	UnitType :NORMAL	IsDeleted :0	]

								myResult = myAbstractRateFunction.convertAndCalculate(myInputParameterList, aRateCalculation);
/s
RateTableFunction.convertAndCalculate(Collection<InputParameterVO>, RateCalculationVO) line: 335	
		RateResult myResult = calculate(anInputParameterList, aRateCalculation);
/s
RateTableFunction.calculate(Collection<InputParameterVO>, RateCalculationVO) line: 50	
		RateTableVO myRateTable = getRateFunctionVO().getRateTableVO();

/ Intermezzo

.rate_table_systemid=rt.system_id where rp.system_id=26768790;
-[ RECORD 1 ]--------------+---------------------------------
rate_agreement_systemid    | 26768606
system_id                  | 26768786
name                       | RT-PALLETSTAFFEL-FR-2
description                | Pallet tarief FR vanaf 4 pallets
unit_systemid              | 1000072
rate_table_xml             | 
min_charge                 | 
max_charge                 | 
rounding                   | 0
excel_formatted            | 0
default_value              | 
rate_table_content         | 9999    119.66
is_user_editable           | 0
is_shared                  | 0
linked_rate_table_systemid | 
linked_multiplication      | 
linked_addition            | 
last_update                | 2015-05-12 13:36:14.77

/ click in GUI op row van rate tables  niet op edit button, maar op data button	, dan zie je de def	
rate_table_content         | 9999    119.66


/ Einde Intermezzo

		for (DimensionVO dim : myRateTable.getDimensionList()) {
			RateResult dimRes = dim.getInputParameter().getRateResult();
this	DimensionVO  (id=27410)	
	inputParameter	InputParameterVO  (id=25926)	
		performanceMonitorService	PerformanceMonitorServiceImpl  (id=20800)	
		systemId	26768788	
		theConfigurationValue	null	
		theFreeValue	null	
		theFuncParDef	null	
		theOrderDetail	OrderDetail  (id=22889)	
		theParameter	null	
		theRateFunc	RateFunctionVO  (id=25829)	
		theRateResult	ThreadLocal  (id=26406)	
dimRes	RateResult  (id=25927)	
0.0 theSystemId: 26632357	Symbol :PC	Description :Pieces	UnitType :NORMAL	IsDeleted :0	

			myKeyBuilder.append(dimRes.getValue()).append('|');
myKeyBuilder	StringBuilder  (id=27406)	
0.0|

		final String cacheKey = myKeyBuilder.toString();
0.0|
		RateTableResultCache myCache = RateTableResultCache.getInstance();
		} else {
			myRateResult = calculateWithoutCache(anInputParameterList, aRateCalculation);
/ TODO ERICJ (Waarom, we hebben toch zonet berekend?)
/s
RateTableFunction.calculateWithoutCache(Collection<InputParameterVO>, RateCalculationVO) line: 95	
this	RateTableFunction  (id=25828)	
		RateTableVO myRateTable = getRateFunctionVO().getRateTableVO();
...
			if (!mySecondDimension) {
				myResult = myRateTable.matchRowDimension(myInputParamArray);
/s
RateTableVO.matchRowDimension(InputParameterVO[]) line: 908	
		int myLast = getLastDataRow();
/s
		return getRows().size() - 1;
/s
		return theRateTableRows;
this	RateTableVO  (id=26839)	
	theRateTableRows	ArrayList  (id=28014)	
		elementData	Object[10]  (id=28017)	
			[0]	RateTableRow  (id=28021)	
				cells	ArrayList  (id=28030)	
					elementData	Object[10]  (id=28032)	
						[0]	RateTableDimensionInputCell  (id=28034)	
							dimensionSeqNr	1	
							theFormerCell	null	
							theFormerCellLoaded	false	
							theNextCell	null	
							theNextCellLoaded	false	
							theText	"9999" (id=28138)	
						[1]	RateTableOutputCell  (id=28035)	
							theText	"119.66" (id=28141)	
					size	2	

/t
RateTableVO.matchRowDimension(InputParameterVO[]) line: 909	
		int myLast = getLastDataRow();
1
/ index, want er zijn 2 rows	,
			for (int c = 0; c < anInputArray.length; c++) {
				RateTableCell myObject = myRow.get(c);
				RateTableDimensionInputCell myInputCell = null;
				try {
					myInputCell = (RateTableDimensionInputCell) myObject;
myInputCell	RateTableDimensionInputCell  (id=28034)	
	theText	"9999" (id=28138)	
				if (!myInputCell.match(this, anInputArray[c].getRateResult())) {
this	RateTableVO  (id=26839)	
anInputArray	InputParameterVO[1]  (id=27985)	
	[0]	InputParameterVO  (id=25926)	
		performanceMonitorService	PerformanceMonitorServiceImpl  (id=20800)	
		systemId	26768788	
		theConfigurationValue	null	
		theFreeValue	null	
		theFuncParDef	null	
		theOrderDetail	OrderDetail  (id=22889)	
SystemId: 26681459, Name :NR_OF_PALLET, PathOrClass :count(./topLevelShipmentItems[shippingUnitVO/code='P'])
		theParameter	null	
		theRateFunc	RateFunctionVO  (id=25829)	
		theRateResult	ThreadLocal  (id=26406)	
/s
InputParameterVO.getRateResult() line: 237	
		return theRateResult.get();
/t
/s
RateTableDimensionInputCell.match(RateTableVO, RateResult) line: 105	
this	RateTableDimensionInputCell  (id=28034)	
aRateResult	RateResult  (id=25927)	
0.0 theSystemId: 26632357	Symbol :PC	Description :Pieces	UnitType :NORMAL	IsDeleted :0	
		DimensionVO theDimension = theRateTable.getDimension(dimensionSeqNr);
this.dimensionSeqNr=1
		if (theDimension.isDiscrete()) {
			/* Discrete dimension */
			String myLowerText = getText().toLowerCase();
"9999"
				if (myLowerText.indexOf('x') > -1) {
/ TODO 
				} else {
					/* numeric */
					BigDecimal myFloatValue = RateResultUtils.getBigDecimalValue(aRateResult);
aRateResult	RateResult  (id=25927)	
theValue="0.0" unitType.toString()="theSystemId: 26632357	Symbol :PC	Description :Pieces	UnitType :NORMAL	IsDeleted :0"	
0.0
					if (myFloatValue.compareTo(theRateTable.getValueAsBigDecimal(this)) == 0) {
this	RateTableDimensionInputCell  (id=28034)	
false
					} else {
						return false;
/t
RateTableVO.matchRowDimension(InputParameterVO[]) line: 922	
				if (!myInputCell.match(this, anInputArray[c].getRateResult())) {
/ JA
					break;
				if (!myInputCell.match(this, anInputArray[c].getRateResult())) {
					break;
		return myResult;
null
/t
RateTableFunction.calculateWithoutCache(Collection<InputParameterVO>, RateCalculationVO) line: 143	
			if (!mySecondDimension) {
				myResult = myRateTable.matchRowDimension(myInputParamArray);
null
		return myRateResult;
null
/t
RateTableFunction.calculate(Collection<InputParameterVO>, RateCalculationVO) line: 74	
		} else {
			myRateResult = calculateWithoutCache(anInputParameterList, aRateCalculation);
null
			myCache.cacheResult(myRateTable, cacheKey, myRateResult);
cacheKey	"0.0|" (id=27816)	
myRateResult	null	
myCache	RateTableResultCache  (id=27831)	
	rateTableCache	LRUMap  (id=28657)	
{26768786={0.0|=null}}
/ 26768786=de myRateTable

		return myRateResult;
null

/t
RateTableFunction.convertAndCalculate(Collection<InputParameterVO>, RateCalculationVO) line: 335	
		RateResult myResult = calculate(anInputParameterList, aRateCalculation);
null
		return myResult;
/t

/ terug bij de RT-PALLETSTAFFEL-FR-2_OUTPUT	, 
RateParameterVO.calculate(RateCalculationVO) line: 160	
this	RateParameterVO  (id=25827)	
theSystemId: 26768790Name :RT-PALLETSTAFFEL-FR-2_OUTPUT
								// First, make sure all input parameters are calculated
								for (InputParameterVO myInputParameter : myInputParameterList) {
									RateResult mySub = myInputParameter.calculate(aRateCalculation);
									if (mySub != null) {
										mySubResults.add(mySub);
									}
								}
								myResult = myAbstractRateFunction.convertAndCalculate(myInputParameterList, aRateCalculation);
/d
null
						aRateCalculation.cacheResult(this, myResult);
this	RateParameterVO  (id=25827)	
theSystemId: 26768790Name :RT-PALLETSTAFFEL-FR-2_OUTPUT

/ t
InputParameterVO.calculate(RateCalculationVO) line: 110	
this	InputParameterVO  (id=25832)	
/ de input param bij RT-PALLETSTAFFEL-FR-2_OUTPUT	,
			} else if (myParameter != null) {
				myRateResult = myParameter.calculate(aRateCalculation);
/d
null
			setRateResult(myRateResult);
			return getRateResult();
/t
RateParameterVO.calculate(RateCalculationVO) line: 153	
this	RateParameterVO  (id=19952)	
theSystemId: 26768862Name :RP-VRACHT
Description :TOTAAL VRACHT TARIEF
							} else {
								// First, make sure all input parameters are calculated
								for (InputParameterVO myInputParameter : myInputParameterList) {
									RateResult mySub = myInputParameter.calculate(aRateCalculation);
null
/ we step zonder b door al deze input params	, 
								myResult = myAbstractRateFunction.convertAndCalculate(myInputParameterList, aRateCalculation);
null
						aRateCalculation.cacheResult(this, myResult);
/t
CostComponentSpecificationVO.run(RateCalculationVO) line: 205	
			RateResult myResult = myParameter.calculate(aRateCalculation);
/d
null
		return myResultList;
[]
/t
RateCalculationVO.runFor(RateAgreementVO, RateCalculationAlternative) line: 1108	
				componentLoop: for (CostComponentSpecificationVO myCostComp : myCostComponentSpecificationList) {
					for (RateResult myResult : myCostComp.run(this)) {
/d
				anAlternative.setSuccess(true);
/t
RateCalculationVO.calculateWithoutVariables() line: 1334	
			for (RateAgreementVO myAgreement : getRateAgreementVO()) {
				runFor(myAgreement, myAlterNative);
/d
/ volgende	, 
/ er zijn 2 ra's die match  (in iedere ra is er een tab Selection Criteria	, daar staan ze	, en de ra is toepasbaar op de sho als de ra aan alle selection criteria voldoet	,
/ volgende	,
/ we step over,	 
/ Dit is ra	,
Name: RA-BUSINESSRULES SHO
Description: Business rules PostNL
Deze heeft veel rc's	, en rp's	, 
/t
RateCalculationVO.runFor(List<RateAgreementVO>) line: 785	
			if (myList.size() == 0) {
				/* No variables (iteration) involved */
				calculateWithoutVariables();
/d
			} else {

				try {
					if (serviceOrder != null || shipmentOrder != null || customerOrderLine != null) {
/ JA
						RateCalculationAlternative firstAlt = alternativeList.iterator().next();
firstAlt	RateCalculationAlternative  (id=22353)	
	resultSetList	HashMap  (id=30554)	
		size	1	
		table	HashMap$Entry[16]  (id=30650)	
			[13]	HashMap$Entry  (id=30654)	
				value	AlternativeResultSet  (id=30657)	
					LOG	Log4JLogger  (id=30689)	
					alternative	RateCalculationAlternative  (id=22353)	
					costMap	HashMap  (id=30690)	
					entitySystemId	26831388	
					entityType	EntityType  (id=25384)	
					priceMap	HashMap  (id=30691)	
					propertyMap	HashMap  (id=30693)	
					resultMap	HashMap  (id=30694)	
						size	10	
						table	HashMap$Entry[16]  (id=30703)	
							[1]	HashMap$Entry  (id=30706)	
								hash	-1605271231	
								key	CostComponentSpecificationVO  (id=30720)	
CostComponentSpecification:26786986/RC_PROCESS/Order Process
								next	HashMap$Entry  (id=30721)	
								value	ArrayList  (id=30722)	
[LB ]
							[2]	HashMap$Entry  (id=30707)	
								hash	-1604528238	
								key	CostComponentSpecificationVO  (id=30726)	
CostComponentSpecification:26791330/RC-REQUESTED-END-BEFORE/SET REQUESTED END BEFORE
								next	null	
								value	ArrayList  (id=30727)	
[2015-07-31 18:00:00 theSystemId: 1000536	Symbol :DATE	Description :Datum	UnitType :DATE	IsDeleted :0	]
							[5]	HashMap$Entry  (id=30708)	
								hash	-1607660059	
								key	CostComponentSpecificationVO  (id=30730)	
CostComponentSpecification:26823742/RC_REQ_START_AFTER/Req Start After
								next	null	
								value	ArrayList  (id=30731)	
[2015-07-30 08:00:00 theSystemId: 1000536	Symbol :DATE	Description :Datum	UnitType :DATE	IsDeleted :0	]
							[7]	HashMap$Entry  (id=30709)	
								hash	-1604964937	
								key	CostComponentSpecificationVO  (id=30733)	
CostComponentSpecification:26774022/RC-HOLD/ZET HOLD STATUS
								next	null	
								value	ArrayList  (id=30734)	
[NL ]
							[8]	HashMap$Entry  (id=30712)	
								hash	-1604375832	
								key	CostComponentSpecificationVO  (id=30736)	
CostComponentSpecification:26790876/DistributionDepot/Set distribution depot
								next	null	
								value	ArrayList  (id=30737)	
[DOR ]
							[11]	HashMap$Entry  (id=30713)	
								hash	-1604530117	
								key	CostComponentSpecificationVO  (id=30739)	
CostComponentSpecification:26791329/RC-REQUESTED-END-AFTER/SET REQUESTED END AFTER
								next	HashMap$Entry  (id=30740)	
								value	ArrayList  (id=30741)	
[2015-07-31 08:00:00 theSystemId: 1000536	Symbol :DATE	Description :Datum	UnitType :DATE	IsDeleted :0	]
							[15]	HashMap$Entry  (id=30714)	
								hash	-1607660129	
								key	CostComponentSpecificationVO  (id=30743)	
CostComponentSpecification:26823743/RC_REQ_START_BEFORE/Req Start Before
								next	HashMap$Entry  (id=30744)	
								value	ArrayList  (id=30745)	
[2015-07-30 18:00:00 theSystemId: 1000536	Symbol :DATE	Description :Datum	UnitType :DATE	IsDeleted :0	]

						for (AlternativeResultSet mySet : firstAlt.getResultSetList().values()) {
/ mySet=
[RC_PROCESS = LB]
 [RC-PRODUCTCODE = 3610]
 [RC-REQUESTED-END-BEFORE = 2015-07-31 18:00:00]
 [RC_REQ_START_AFTER = 2015-07-30 08:00:00]
 [RC-HOLD = NL]
 [DistributionDepot = DOR]
 [RC-REQUESTED-END-AFTER = 2015-07-31 08:00:00]
 [RC-SHIPMENTTYPE = BENELUXFREIGHT]
 [RC_REQ_START_BEFORE = 2015-07-30 18:00:00]
 [CollectionDepot = DOR]
 
							switch (mySet.getEntityType()) {
								case SHIPMENT_ORDER:
									ShipmentOrderVO myShipmentOrder = MpoBeanFactory.getBean(ShipmentOrderDao.class).getBySystemId(mySet.getEntitySystemId());
									} else {
										/* Used to set the requested dates on a shipment order */
										MpoBeanFactory.getBean(ShipmentOrderCalculationService.class).updateShipmentOrder(myShipmentOrder, mySet, myLog);
///////////////////////////////////////////////
/ RATE CALCULATION -> UPDATE SHIPMENTORDER 

/ we zien deze NIET direct in de log	, we zitten in 	,
RateCalcEventListener.recalculate(ShipmentOrderVO, AgreementType, TMSEventContext) line: 336	
			getCalculationService().recalculate(anOrder, aRateType, anEventContext);
...
CompleteShipmentOrderDuplicator.duplicate(ShipmentOrderVO, CustomDuplicateAction) line: 54	
			myNewShipmentOrderVO = shipmentOrderService.createShipmentOrder(myNewShipmentOrderVO);
...
ShipmentOrderCreateReturnAction.act() line: 56	
		ShipmentOrderVO myVO = MpoBeanFactory.getBean(ShipmentOrderService.class).createReturnShipmentOrder(myOriginalShipmentOrder);



						for (AlternativeResultSet mySet : firstAlt.getResultSetList().values()) {
/ Einde 
						if (getOrder() instanceof LogisticsOrderVO) {
							updateLogisticsOrderRateAgreement(getOrder(), firstAlt.getRateCalculation());
/s
RateCalculationVO.getOrder() line: 579	
			} else if (isShipmentOrderPriceRate()) {
/s
		if (getRateAgreementVO() != null && !getRateAgreementVO().isEmpty()) {
			return getRateAgreementVO().iterator().next().getAgreementType().equals(AgreementType.SHIPMENT_ORDER);
true
/t
				return shipmentOrder;
/t
/ TODO
							updateLogisticsOrderRateCalcStatus(getOrder(), firstAlt.isSuccess() ? "Success" : "Failed");
/ TODO
/ we zijn in 	,
RateCalculationVO.runFor(List<RateAgreementVO>) line: 880	
				} finally {
					try {
						// log lines might have been updated during updating of order
						addToLog(String.format("Executed on: %tc", Calendar.getInstance()));
						createXMLLog();
-> 						saveLog();
/ HIER STRAKS ERR

/t
RateCalcEventListener.recalculate(ShipmentOrderVO, AgreementType, TMSEventContext) line: 336	
			getCalculationService().recalculate(anOrder, aRateType, anEventContext);
/t
RateCalcEventListener.recalcShipOrderPrice(Event) line: 93	
			if (myType.equals(ShipmentOrderEvent.CREATED)) {
				ShipmentOrderVO myNewShipmentOrderVO = ((ShipmentOrderEvent) anEvent).getNewShipmentOrderVO();
				recalculate(myNewShipmentOrderVO, AgreementType.SHIPMENT_ORDER, anEvent.getEventContext());
/d
EventHandlerServiceImpl.handleEvent(Event) line: 111	
			listenerList.fireEvent(anEvent);
/d
/t
ShipmentOrderServiceImpl.createShipmentOrder(ShipmentOrderVO, TMSEventContext) line: 848	
				triggerEventHandler(null, myVO, new TMSEventContext());
/d
			return myVO;
ShipmentOrder: SH000002609copy(SystemId:26831388; Org:PNL-CARGO)

/t
CompleteShipmentOrderDuplicator.duplicate(ShipmentOrderVO, CustomDuplicateAction) line: 54	
			myNewShipmentOrderVO = shipmentOrderService.createShipmentOrder(myNewShipmentOrderVO);
/d
		if (aCustomAction.isShouldCopyProductItem()) {
/ JA
			// copy product items
			Collection<ProductItemVO> myOriginalProductItems = anOriginalShipmentOrderVO.getProductItemList();
[]

		if (aCustomAction.isShouldCopyShipmentItem()) {
/ JA
			// copy shipment items
			Collection<ShipmentItemVO> myOriginalShipmentItems = anOriginalShipmentOrderVO.getShipmentItemList();
			for (ShipmentItemVO myOriginalShipmentItem : myOriginalShipmentItems) {
shipmentItem: 010(systemId:26831189, labelInfo:0107481611104395)
shipmentItem: 020(systemId:26831235, labelInfo:1471406851104396)

				ShipmentItemVO myNewShipmentItem = myOriginalShipmentItem.copy();
/s
ShipmentItemVO.copy() line: 221	
		ShipmentItemVO myShipmentItemVO = ShipmentItemVOFactory.getShipmentItemVO();
		copyTo(myShipmentItemVO);
/s
ShipmentItemVO.copyTo(ShipmentItemVO) line: 232	
...
		aTarget.setShipmentItemId(theShipmentItemId);
/t
ShipmentItemVO.copyTo
		myShipmentItemVO.setSystemId(ValueObject.VOLATILE_SYSTEM_ID);
		return myShipmentItemVO;
/t
CompleteShipmentOrderDuplicator.duplicate(ShipmentOrderVO, CustomDuplicateAction) line: 77	
				ShipmentItemVO myNewShipmentItem = myOriginalShipmentItem.copy();
/d
shipmentItem: 020(systemId:0, labelInfo:null)
				myNewShipmentItem.setLabelInfo(null);
				myNewShipmentItem.updateShipmentOrder(myNewShipmentOrderVO);
				myNewShipmentItem = shipmentItemService.save(myNewShipmentItem);

				shipmentItemService.save(myNewShipmentItem);
		return myNewShipmentOrderVO;
/t
CompleteShipmentOrderDuplicator.duplicate(ShipmentOrderVO, CustomDuplicateAction) line: 79	
				ShipmentItemVO myNewShipmentItem = myOriginalShipmentItem.copy();
/d
shipmentItem: 010(systemId:0, labelInfo:null)
/=
myNewShipmentItem	ShipmentItemVO  (id=24888)	
	systemId	0	
	theShipmentItemId	"010" (id=25465)	
				myNewShipmentItem.updateShipmentOrder(myNewShipmentOrderVO);
/ TODO
				myNewShipmentItem = shipmentItemService.save(myNewShipmentItem);

/t
ShipmentOrderServiceImpl.createReturnShipmentOrder(ShipmentOrderVO) line: 724	
		ShipmentOrderVO myShipmentOrderVO = shipmentOrderDuplicator.duplicate(aShipmentOrder);
/d

		String myReturnToPartyId = ApplicationPropertyManager.getInstance().getModuleProperty("oms", "shipmentorder.returnbutton.returnto", null);
null
		String myReturnOrganizationId = ApplicationPropertyManager.getInstance().getModuleProperty("oms", "shipmentorder.returnbutton.organization", null);
null
		// set new from and to party
		if (myReturnToPartyId == null) {
/ JA
			myShipmentOrderVO.setToPartyVO(aShipmentOrder.getFromPartyVO());
/ Dit is de return	,
			myShipmentOrderVO.setFromPartyVO(aShipmentOrder.getToPartyVO());
/ Dit is de return	,
		// id settings
		myShipmentOrderVO.setShipmentType(getReturnShipmentOrderType());
/s
ShipmentOrderServiceImpl.getReturnShipmentOrderType() line: 2160	
				returnShipmentOrderType = new BeanWrapper<ShipmentTypeDAO>(ShipmentTypeDAO.class).getBean().getByCode(returnOrderType);
/ returnOrderType="COLLECT"
/ TODO
null
		return returnShipmentOrderType;
null


pnllogistics2=# select*from shipment_order_type;
 system_id | is_deleted | organization_id | shipment_order_type |                   description                    
-----------+------------+-----------------+---------------------+--------------------------------------------------
  26681891 |          0 |             500 | EUROFREIGHT         | Vracht van/naar de niet Benelux landen
  26681890 |          0 |             500 | BENELUXFREIGHT      | Vracht van/naar Beneluxlanden via netwerk
  26681892 |          0 |             500 | DIRECTFREIGHT       | Vracht van/naar Benelux landen rechstreeks
  26681893 |          0 |             500 | SPECIALSERVICES     | Vracht van/naar Beneluxlanden met speciale eisen
  26681894 |          0 |             500 | PHARMA              | Vracht van/naar Beneluxlanden Pharma & Care
(5 rows)

/t

		} else {
			myShipmentOrderVO.setShipmentOrderId(aShipmentOrder.getShipmentOrderId() + returnOrderIdPostFix);
theShipmentOrderId	"SH000002609copy" (id=40122)	
/ WAS
theShipmentOrderId	"SH000002609RO" (id=40145)	
/ NU

/ myShipmentOrderVO heeft een systemId	, waarom moet dan nog save naar db	? 
/ TODO

		// save it to the database
		try {
			ShipmentOrderUtil.getShipmentOrderFacadeLocal().updateShipmentOrder(myShipmentOrderVO, true);
/s
ShipmentOrderServiceImpl.updateShipmentOrder(ShipmentOrderVO, TMSEventContext, boolean) line: 2001	
		if (anOrder.isVolatile()) {
/ NEE
		} else {
			myOld = shipmentOrderDao.getOld(anOrder);
/s
ShipmentOrderDaoImpl(GenericHibernateDAO).getOld(Type) line: 399	
		return getOld(aCurrent, type);
class com.mpobjects.oms.model.shipmentorder.vo.ShipmentOrderVO
/s
ShipmentOrderDaoImpl(GenericHibernateDAO).getOld(K, Class<? extends K>) line: 346	
...
/ TODO
/t
ShipmentOrderServiceImpl.updateShipmentOrder(ShipmentOrderVO, TMSEventContext, boolean) line: 2001	
			ShipmentOrderVO myOldVO = getOld(aShipmentOrder);
/d
				myNew = shipmentOrderDao.merge(aShipmentOrder);
				addShipmentOrderParties(myNew);
/ TODO
				myNew.recalculate();
/ TODO
					updatePricePart(myNew);
/ TODO
...
					triggerEventHandler(myOldVO, myNew, anEventContext);
...
/s
ShipmentOrderServiceImpl.triggerEventHandler(ShipmentOrderVO, ShipmentOrderVO, TMSEventContext) line: 2542	
		if (anOldVO == null) {
/ NEE
		} else {
			myEvent = new ShipmentOrderEvent(anOldVO, aNewVO, ShipmentOrderEvent.UPDATED, anEventContext);
...

RateCalcEventListener.recalcShipOrderPrice(Event) line: 94	
		String myType = anEvent.getEventType();
"shipmentorder.updated"
			} else if (myType.equals(ShipmentOrderEvent.UPDATED)) {
				ShipmentOrderVO myNewShipmentOrderVO = ((ShipmentOrderEvent) anEvent).getNewShipmentOrderVO();
				recalculate(myNewShipmentOrderVO, AgreementType.SHIPMENT_ORDER, anEvent.getEventContext()); 		/ (*)
/s
RateCalcEventListener.recalculate(ShipmentOrderVO, AgreementType, TMSEventContext) line: 303	
		} else {
			getCalculationService().recalculate(anOrder, aRateType, anEventContext);
/s
CalculationServiceImpl.recalculate(LogisticsOrderVO, AgreementType, TMSEventContext) line: 493	
			List<RateAgreementVO> mySelectedRateAgreement = getMatchingRateAgreement(anOrder, aRateType);
mySelectedRateAgreement	ArrayList  (id=41761)	
	elementData	Object[10]  (id=41762)	
		[0]	RateAgreementVO  (id=41763)	
VT-9148459-2015
		[1]	RateAgreementVO  (id=41764)	
RA-BUSINESSRULES SHO

				} else if (anOrder instanceof ShipmentOrderVO) {
					ShipmentOrderVO myShipmentOrder = (ShipmentOrderVO) anOrder;
					if (!myRateCalculationVO.rateCalculationRequired()) {
/ NEE
				// Now calculate the rates
				myRateCalculationVO.runFor(mySelectedRateAgreement);
/s
RateCalculationVO.runFor(List<RateAgreementVO>) line: 765	
		LogisticsOrderVO myOrder = getOrder();
/ see (*) de newVO	,
			if (myList.size() == 0) {
				/* No variables (iteration) involved */
				calculateWithoutVariables();

								case SHIPMENT_ORDER:
									ShipmentOrderVO myShipmentOrder = MpoBeanFactory.getBean(ShipmentOrderDao.class).getBySystemId(mySet.getEntitySystemId());
/ TODO (Hele tijd met newVO,	 see getOld()	, maar nu ineens uit de db	)	,

									if (agreementType.equals(AgreementType.SHIPMENT_ORDER_PROPERTIES)) {
/ NEE
									} else {
										/* Used to set the requested dates on a shipment order */
										MpoBeanFactory.getBean(ShipmentOrderCalculationService.class).updateShipmentOrder(myShipmentOrder, mySet, myLog);
									break;

						if (getOrder() instanceof LogisticsOrderVO) {
							updateLogisticsOrderRateAgreement(getOrder(), firstAlt.getRateCalculation());
							updateLogisticsOrderRateCalcStatus(getOrder(), firstAlt.isSuccess() ? "Success" : "Failed");

				} finally {
					try {
						// log lines might have been updated during updating of order
						addToLog(String.format("Executed on: %tc", Calendar.getInstance()));
						createXMLLog();
						saveLog();
/s
RateCalculationVO.saveLog() line: 1556	
 		EntityLogDAO myDao = MpoBeanFactory.getBean(EntityLogDAO.class);
		} else if (isShipmentOrderPriceRate()) {
			myDao.save(shipmentOrder, myLog);
/s
EntityLogDAOHibernate.java
		DetachedCriteria myDetachedCriteria = DetachedCriteria.forClass(ShipmentOrderEntityLog.class);
		myDetachedCriteria.createAlias("entityLog", "log");
		myDetachedCriteria.add(Property.forName("log.logType").eq(aEntityLog.getLogType()));
		myDetachedCriteria.add(Property.forName("shipmentOrderSystemId").eq(aShipmentOrder.getSystemId()));
		List<ShipmentOrderEntityLog> myLogList = getHibernateTemplate().findByCriteria(myDetachedCriteria);
/t
RateCalculationVO.runFor(List<RateAgreementVO>) line: 884	
						saveLog();
					} catch (Exception e) {
org.springframework.dao.DataIntegrityViolationException: Could not execute JDBC batch update; SQL [insert into SHIPMENT_ITEM (PARENT_SYSTEMID, SHIPPING_UNIT_SYSTEMID, GOODS_STATUS_SYSTEMID, value_currency_systemid, value_alt_currency_systemid, SHIPMENT_ITEM_ID, LENGTH_M, WIDTH_M, HEIGHT_M, WEIGHT_KG, COMP_ITEM_WEIGHT_KG, BASE_WEIGHT_KG, TOT_VOLUME_M3, TOT_WEIGHT_KG, VOLUME_M3, TOTAL_LDM, ITEM_VALUE, CONTAINER_NUMBER, AIRWAYBILL_NUMBER, CASE_NUMBER, HANDLING_INSTRUCTIONS, REFERENCE1, REFERENCE2, REFERENCE3, REFERENCE4, REFERENCE5, REFERENCE6, REFERENCE7, REFERENCE8, REFERENCE9, REFERENCE10, LABEL_INFO, QUANTITY, PLANNED_QUANTITY, ACTUAL_QUANTITY, SHIPMENT_ORDER_SYSTEMID, STACKABLE, EXPORT_DATE, RELEASE_DATE, SPLIT_GROUP, GCD_SEQUENCE_NUMBER, GCD_NO_OF_PACKAGES, GCD_TRACKING_REFERENCE1, GCD_TRACKING_REFERENCE2, GCD_TRACKING_REFERENCE3, COST, COST_CURRENCY_SYSTEMID, COST_METHOD, SYSTEM_ID) values (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)]; constraint [null]; nested exception is org.hibernate.exception.ConstraintViolationException: Could not execute JDBC batch update



/ Einde DEBUG RECALCULATE PCT-451

/ DEBUG RECALCULATE PCT-451

CompleteShipmentOrderDuplicator.duplicate(ShipmentOrderVO, CustomDuplicateAction) line: 79	
				myNewShipmentItem = shipmentItemService.save(myNewShipmentItem);
/s
ShipmentItemServiceImpl.save(ShipmentItemVO, boolean, boolean, boolean, boolean) line: 577	
			ItemIdGenerator myIdGenerator = new ItemIdGenerator(getManualPrefix());
			// Generate the item number for manually entered orders:
			addExistingShipmentItemIds(myShipmentOrder.getShipmentItemList(), myIdGenerator);
/ Omdat (myShipmentOrder.getShipmentItemList()=[], doet hij niets	, is ERR	,
			aVO.setShipmentItemId(myIdGenerator.nextItemId());
/s
ShipmentItemVO.setShipmentItemId(String) line: 1113	
/=
	public void setShipmentItemId(String aShipmentItemId) {
ShipmentItemId	"010" (id=24427)	
theShipmentItemId	"020" (id=24440)	
		theShipmentItemId = aShipmentItemId;
theShipmentItemId	"010" (id=24427)	

/ FIX PCT-451

$ vi CompleteShipmentOrderDuplicator.java

		if (aCustomAction.isShouldCopyShipmentItem()) {
			// copy shipment items
			Collection<ShipmentItemVO> myOriginalShipmentItems = anOriginalShipmentOrderVO.getShipmentItemList();
			for (ShipmentItemVO myOriginalShipmentItem : myOriginalShipmentItems) {

				ShipmentItemVO myNewShipmentItem = myOriginalShipmentItem.copy();
				myNewShipmentItem.setLabelInfo(null);
				myNewShipmentItem.updateShipmentOrder(myNewShipmentOrderVO);
/ WAS	,
->				myNewShipmentOrderVO.addShipmentItem(myNewShipmentItem);
/ NU	,

/ myNewShipmentOrderVO.addShipmentItem calls myNewShipmentItem.updateShipmentOrder	, dus NIET meer nodig	,

/ Einde FIX PCT-451

/ Einde DEBUG RECALCULATE PCT-451


/ PCT-451

/ b's	,

EventHandlerServiceImpl [line: 109] - handleEvent(Event)	
RateCalcEventListener [line: 66] - handleEvent(Event)	
RateCalculationVO [line: 880] - runFor(List<RateAgreementVO>)	
RateParameterVO [line: 155] - calculate(RateCalculationVO)	
RateParameterVO [line: 160] - calculate(RateCalculationVO)	
CalculationServiceImpl [entry] - recalculate(LogisticsOrderVO, AgreementType, TMSEventContext)	
CompleteShipmentOrderDuplicator [entry] - duplicate(ShipmentOrderVO, CustomDuplicateAction)	
LogisticsOrderVO [entry] - getFromPartyVO()	
LogisticsOrderVO [entry] - setToPartyVO(Party)	
RateCalcEventListener [entry] - handleEvent(Event)	
RateParameterVO [entry] - calculate(RateCalculationVO)	
ShipmentOrderCreateReturnAction [entry] - act()	


/ Einde PCT-451

/ PCT-487

/ 13	. 

/ shipment order search	,
			<map:match pattern="shipment-order_list">
				<map:act type="shipmentOrderList"/>			
				<map:call resource="dynatablePage">
					<map:parameter name="xsp" value="xsp/shipment-order_list.xml"/>
				</map:call>
			</map:match>

$ vi language_en_GB_pnllogistics.properties
pnllogistics.table_shipment_order_shipmentorder.reference2.pnllogistics.general=Customer Reference
pnllogistics.table_shipment_order_shipmentorder.reference3.pnllogistics.general=Import Partner Nr

/ 13	. 

/ shipment order search	by item,
			<map:match pattern="shipment-item_list">
				<map:act type="shipmentOrderList"/>			
				<map:call resource="dynatablePage">
					<map:parameter name="xsp" value="xsp/shipment-item_list.xml"/>
				</map:call>
			</map:match>

$ vi language_en_GB_pnllogistics.properties
pnllogistics.table_shipment_item_search_reference1=3S Barcode
pnllogistics.table_shipment_item_search_shipmentitem.reference2=Europlate
pnllogistics.table_shipment_item_search_shipmentitem.reference3=Europlate org

/ 13	. 

/ shpment order edit	,
			<map:match pattern="shipment-order_edit">
				<map:act type="shipmentOrderEdit">
					<map:select type="session-attribute">
						<map:parameter name="attribute-name" value="builder"/>
						<map:when test="jsp">
							<map:read mime-type="text/html" type="jsp" src="jsp/shipment-order_edit.jsp"/>
						</map:when>
						<map:otherwise>
							<map:redirect-to uri="../wicket?module=oms&amp;wicketpage=shipmentorder.edit.ShipmentOrderEditSelectionPage"/>
						</map:otherwise>			
					</map:select>
				</map:act>
			</map:match>

$ vi shipment-order_edit.jsp
		<mpo:tabCollection name="location" defaultTab="${formVO.shipmentOrderProcess=='INBOUND'?'shipFrom':'shipTo'}">
			<mpo:tab name="shipFrom">
				<tmstags:shipfrom formid="shipmentorder" />
			</mpo:tab>
			<mpo:tab name="shipTo">
				<tmstags:shipto formid="shipmentorder" />
			</mpo:tab>
			<mpo:tab name="billTo">
				<tmstags:sho-billto />
			</mpo:tab>
[eric@localhost trunk]$ ls ./module/oms/war/WEB-INF/tags/oms/shipfrom.tag 

/ 13	. 

/ we kijken naar reference1 field in shipment item form	, 

/ we geven languageKey attr erbij, en geven shipmentitem  er in mee	,

$ vi sho-shipmentitems.tag

<c:if test="${!empty shipmentItemBean.shipmentItem}">
	<div id="shipmentItemForm" class="${shipmentItemBean.shipmentItem.systemId == 0 && !shipmentItemBean.editBean && ! empty(formVO.shipmentItemList) ? 'hidden' : '' }">
		<mpo:setFormVO valueObject="${shipmentItemBean.shipmentItem}" prefix="shipmentItem">
			<mpo:tabCollection name="shipment-item" defaultTab="shipmentItem">
				<mpo:tab name="shipmentItem">
								<table>
									<mpo:field name="reference1" />
									<c:if test="${cf:property('oms', 'shipmentitem.casenumber.reference2.hidden', 'false')=='false'}">
									<mpo:field languageKey="shipmentitem.reference1" name="reference1" />
									<c:if test="${cf:property('oms', 'shipmentitem.casenumber.reference2.hidden', 'false')=='false'}">
										<mpo:field languageKey="shipmentitem.reference2" name="reference2" />
									</c:if> 
									<c:if test="${cf:property('oms', 'shipmentitem.casenumber.reference3.hidden', 'false')=='false'}">
										<mpo:field languageKey="shipmentitem.reference3" name="reference3" />
									</c:if>
									<!-- TODO why using a different ppty? -->
									<c:if test="${cf:property('oms', 'shipmentitem.casenumber.reference4.hidden', 'true')=='false'}">
										<mpo:field languageKey="shipmentitem.reference4" name="reference4" />
									</c:if>

/ we vielen eerst in	,
sho-shipmentitems.tag line: 304	
									<mpo:field name="reference1" />
/s
LanguageManager.get(String, String) line: 258	
aTableName	"shipment_order" (id=18979)	
aField	"reference1" (id=18977)	
/ Dit is niet specifiek genoeg	,

/ 13	. 

/ we edit een shipment order	,

/ 1313	.

/ op ship from	, 2de rijtje

/ we geven languageKey attr erbij, en geven shipfrom er in mee	,

/ net zo op shipto en billto	,


$ vi shipfrom.tag
		<table style="border-spacing: 0px">
			<mpo:setFormVO valueObject="${formVO.fromPartyVO}" prefix="from">
				<mpo:field name="phoneNumber" />
				<mpo:field name="faxNumber" />
				<mpo:field name="emailAddress" />
				<mpo:field name="contactName" />
				<c:if test="${cf:property('tms', 'serviceorder.shipfrom.party.reference1.hidden', 'true')=='false'}">
					<mpo:field languageKey="shipfrom.reference1" name="reference1" />
				</c:if>
				<c:if test="${cf:property('tms', 'serviceorder.shipfrom.party.reference2.hidden', 'true')=='false'}">
					<mpo:field languageKey="shipfrom.reference2" name="reference2" />
				</c:if>
				<c:if test="${cf:property('tms', 'serviceorder.shipfrom.party.reference3.hidden', 'true')=='false'}">
					<mpo:field languageKey="shipfrom.reference3" name="reference3" />
				</c:if>
				<c:if test="${cf:property('tms', 'serviceorder.shipfrom.party.reference4.hidden', 'true')=='false'}">
					<mpo:field languageKey="shipfrom.reference4" name="reference4" />
				</c:if>
				<c:if test="${cf:property('tms', 'serviceorder.shipfrom.party.reference5.hidden', 'true')=='false'}">
					<mpo:field languageKey="shipfrom.reference5" name="reference5" />
				</c:if>
				<c:if test="${cf:property('tms', 'serviceorder.shipfrom.party.reference6.hidden', 'true')=='false'}">
					<mpo:field languageKey="shipfrom.reference6" name="reference6" />
				</c:if>

/ want eerst	,
/s
LanguageManager.get(String, String) line: 258	
aTableName	"shipment_order" (id=22250)	
aField	"reference1" (id=22248)	


/ Eerst	,
					<mpo:field name="reference1" />
				</c:if>
/
/s
LanguageManager.get(String, String) line: 258	
aTableName	"shipment_order" (id=22250)	
aField	"reference1" (id=22248)	

/ 1313	. 

/ op form product item	,

/ al	, OK	,

$ vi sho-productitems.tag
												<c:if test="${cf:property('oms', 'productitem.reference2.hidden', 'false')=='false'}">
													<mpo:field languageKey="productitem.reference2" name="reference2" />
												</c:if>

/s
LanguageManager.get(String, String) line: 258	
aTableName	"shipment_order" (id=22250)	
aField	"productitem.reference1" (id=22248)	

/ 1313	.

/ al , OK

$ vi sho-shipmentitems.tag

				<th><mpo:label name="reference1" entity="shipmentitem" /></th>
/s
LanguageManager.get(String, String) line: 258	
aTableName	"shipmentitem" (id=22250)	
aField	"reference1" (id=22248)	

/ 1313	.





 





/ Einde PCT-487

/ PNLLOGISTICS

/ op test	,

/ 7	. 

pnllogistics=> select*from shipment_item where shipment_order_systemid=27744473;
-[ RECORD 1 ]-----------------+-----------------
system_id                     | 27745021
shipment_order_systemid       | 27744473
shipping_unit_systemid        | 27637638
shipment_item_id              | 010
description                   | 
...

/ sho SH000021906	,

/ make shipment item	, 
/ save 

/ maar op scherm verschijnt NIET	, en je kunt ook geen nieuwe create	, want hij begint weer op 010	, en dan	,

org.postgresql.util.PSQLException: ERROR: duplicate key value violates unique constraint "shi_id_sho_uk" Detail: Key (shipment_order_systemid, shipment_item_id)=(27744473, 010) already exists.


/ 7	. 

/ op test, 	

SH000021908 
/ kan niet saved	, 

/ we maken copy van deze db	, 

[eric@localhost Backup]$ PGPASSWORD='h^Zgcyr&Q'  pg_dump -U vanderveldene -Fc -h pnl-app-t.intermax.mp-objects.com pnllogistics > pnl-app-t_pnllogistics.dump

/ 7	. 

/ op test	,

/ we maken return op SH000019906
SH000019906RO
/ OK, 
/ Als een sho 2 of meer shipment items heeft	, dan ERR bij create return	,



/ Einde PNLLOGISTICS

/ DSVMHC-274

/ finance, carrier invoice, generate invoices
GenerateInvoices wicket page	,
$ vi invoice-menu.xml
	<m:add path="finance.cost.carrierInvoice.generateInvoices" actionUrl="wicket/?module=invoice&amp;wicketpage=invoice.GenerateInvoices"
		privilege="invoice.edit" index="5305" />
/ we zien dus module: invoice

/ er zijn	,
package com.mpobjects.invoice.view.wicket.invoice;
public class GenerateInvoices extends BaseContextPage {
/ en	,
package com.mpobjects.customerinvoice.view.wicket;
public class GenerateInvoices extends BaseContextPage {

/ Het is dus de 1ste	,

$ vi GenerateInvoicesPanel.java

package com.mpobjects.invoice.view.wicket.invoice;
public class GenerateInvoicesPanel extends FinancialPartySearchListPanel {
	@Override
	protected void addFilterColumns(List<IColumn> aColumnList) {
		super.addFilterColumns(aColumnList);
		aColumnList.add(new ConfigurableTextFilteredPropertyColumn<String>(new ResourceModel("postalCode"), "postalCode", "postalCode",
				new ConfigurableTextFilteredPropertyColumn.FilterTextfieldBuilder<String>(30)));
...

$ vi language_en.properties
postalcode=Postal Code

/ Use kleine letters in de key	,

/ Waar is de HTML van de filter ? In de wicket component	?
/ See GenerateInvoices	, GenericListPanel.java
/ TODO

/ Einde DSVMHC-274

/ PCT-504

$ vi shipment-order_edit.jsp

				<c:if test="${!empty formVO.shipmentItemList or true}">
					<mpo:tab name="shipmentItems">
						<tmstags:sho-shipmentitems />
					</mpo:tab>
				</c:if>

$ vi sho-shipmentitems.tag

<%@taglib prefix="cf" uri="/WEB-INF/tld/core-functions.tld"%>

/ See beneden	, 
/ TODO

/ PROPERTIES IN DE DB	,
/ we zien	,
oms,shipmentitem.casenumber.containerNumber.hidden=true
/ de properties worden	, 
module.oms.shipmentitem.casenumber.containerNumber.hidden=true
/ Als het 1ste arg er is	, hier 'oms'	, dan zet hij er voor: moodule.oms.
/ dit gebeurt in 	,
ApplicationPropertyManager.getPropertyKey(String, String) line: 678	
/=
	protected String getPropertyKey(String aModule, String aKey) {
aModule	"oms" (id=26495)	
aKey	"shipmentitem.casenumber.containerNumber.hidden" (id=26494)	
		if (StringUtils.isNotEmpty(aModule)) {
			myRet = "module." + aModule + "." + aKey;
myRet	"module.oms.shipmentitem.casenumber.containerNumber.hidden" (id=26540)	
/ Dit moeten we in de db set	,

$ vi core-functions.tld
<function>
	<name>property</name>
    <function-class>com.mpobjects.core.ApplicationPropertyManager</function-class>
    <function-signature>
        java.lang.String  taglibGetProperty(java.lang.String,java.lang.String,java.lang.String)
    </function-signature>
</function>

/ 13	. 

/ Wanneer wordt Organization.propertiesValues set?
/ Want deze -> mappedProperties	,
/ Ze komen uit de db	,
/ TODO


/ 13	. 

/ debug get property	, 

/ Deze 13 is onvolledig	, 
/ TODO

/ we set b	,
				<c:if test="${cf:property('oms', 'shipmentitem.reference4.hidden', 'true')=='false'}">
/s
ApplicationPropertyManager.taglibGetProperty(String, String, String) line: 136	
		return getInstance().getModuleProperty(aModule, aKey, aDefaultValue);
aModule	"oms" (id=21420)	
aKey	"shipmentitem.reference4.hidden" (id=21419)	
aDefaultValue	"true" (id=21421)	
/s
ApplicationPropertyManager.getModuleProperty(String, String, String) line: 378	
		return getProperty(getPropertyKey(aModule, aKey), aDefaultValue);
/s
ApplicationPropertyManager.getModuleProperty(String, String, String) line: 378	
/=
	public String getProperty(String aKey, String aDefaultValue) {
aKey	"module.oms.shipmentitem.reference4.hidden" (id=21443)	
aDefaultValue	"true" (id=21421)	
			myReturnValue = myResource.getProperty(aKey);
null
				myReturnValue = getDatabaseProperty(aKey, null);
null
			myReturnValue = getApplicationProperty(aKey, aDefaultValue);
/s
		return theProperties.getProperty(aKey, aDefaultValue);
true
/ default WH	,

/ we debug op	,
module.oms.shipmentitem.container.hidden=true
				<c:if test="${cf:property('oms', 'shipmentitem.container.hidden', 'false')=='false'}">
					<th><mpo:label name="containerNumber" entity="shipmentitem" /></th>
				</c:if>
/s
ApplicationPropertyManager.getProperty(String, String) line: 531	
aKey	"module.oms.shipmentitem.container.hidden" (id=23989)	
aDefaultValue	"false" (id=22171)	
			myReturnValue = myResource.getProperty(aKey);
/s
Resource.getProperty(String, String) line: 504	
aPropertyName	"module.oms.shipmentitem.container.hidden" (id=23989)	
aDefaultValue	null	
		String myRet = getUserProperty(aPropertyName, null);
/s
Resource.getUserProperty(String, String) line: 586	
		loadMappedProperties();
/s
Resource.loadMappedProperties() line: 959	
/ TODO
/t
		PropertiesValueVO prop = mappedProperties.get(aPropertyName);
null
/ want	,
this	Resource  (id=24107)	
	mappedProperties	Collections$UnmodifiableMap  (id=24200)	
this	Resource  (id=24107)	
	mappedProperties	Collections$UnmodifiableMap  (id=24200)	
		m	HashMap  (id=24202)	
			size	1	
			table	HashMap$Entry[16]  (id=24280)	
				[4]	HashMap$Entry  (id=24285)	
					hash	-1847500700	
					key	"user.locale.code" (id=22914)	
					next	null	
					value	PropertiesValueVO  (id=24290)	
						value	"en_GB_pnllogistics" (id=24403)	
		return aDefaultValue;
null
/t
Resource.getProperty(String, String) line: 504	
		String myRet = getUserProperty(aPropertyName, null);
/d
null
			Organization myActiveOrg = getActiveOrg();
				myRet = myActiveOrg.getProperty(aPropertyName, aDefaultValue);
/s
Organization.getProperty(String, String) line: 123	
		PropertiesValueVO prop = mappedProperties.get(aProperty);
this	Organization  (id=24211)	
	automRateCalc	Boolean  (id=22894)	
	code	"PNL-CARGO" (id=23069)	
	dateTimeZone	null	
	deleted	false	
	description	"PostNL Cargo" (id=23070)	
	ediIdentifier	null	
	isNewRecord	false	
	mappedProperties	HashMap  (id=24805)	
		size	67	
		table	HashMap$Entry[128]  (id=24809)	
			[0...99]	
				[0]	HashMap$Entry  (id=24810)	
				[1]	HashMap$Entry  (id=24811)	
				[3]	HashMap$Entry  (id=24812)	
				[8]	HashMap$Entry  (id=24813)	
					hash	-762421752	
					key	"module.oms.shipmentitem.container.hidden" (id=23309)	
					next	HashMap$Entry  (id=24956)	
					value	PropertiesValueVO  (id=24876)	
						checked	false	
						code	"" (id=22318)	
						deleted	false	
						description	"" (id=22318)	
						organization	Organization  (id=24211)	
						organizationVO	null	
						performanceMonitorService	null	
						property	Property_$$_javassist_16  (id=24881)	
							_filter_signature	(id=23283)	
							_methods_	Method[102]  (id=23284)	
							code	"" (id=22318)	
							deleted	false	
							description	"" (id=22318)	
							handler	JavassistLazyInitializer  (id=24967)	
								componentIdType	null	
								constructed	true	
								entityName	"com.mpobjects.oms.model.entity.property.Property" (id=23291)	
								getIdentifierMethod	Method  (id=23293)	
								id	Integer  (id=24973)	
								initialized	true	
								interfaces	Class[1]  (id=23296)	
								overridesEquals	true	
								persistentClass	Class (com.mpobjects.oms.model.entity.property.Property) (id=6851)	
								readOnly	false	
								readOnlyBeforeAttachedToSession	null	
								replacement	null	
								session	SessionImpl  (id=24980)	
								setIdentifierMethod	Method  (id=23304)	
								target	Property  (id=24982)	
									code	"module.oms.shipmentitem.container.hidden" (id=23309)	
									deleted	false	
									description	"hide container field in shipment item part of shipment order form" (id=23310)	
									mandatory	Boolean  (id=22894)	
									performanceMonitorService	null	
									propertyType	PropertyType  (id=23313)	
									systemId	26831888	
									visible	Boolean  (id=22894)	
								unwrap	false	
							mandatory	null	
							performanceMonitorService	null	
							propertyType	null	
							systemId	0	
							visible	null	
						resource	null	
						systemId	26831889	
						value	"true" (id=24882)	
				[9]	HashMap$Entry  (id=24814)	
				...

			return prop.getPropertiesValueValue();
true
/t
ApplicationPropertyManager.getProperty(String, String) line: 535	
			myReturnValue = myResource.getProperty(aKey);
true


/ FIX PCT-504

/ properties zijn case sensitive	, dus shipmentitem.containernumber.hidden is een andere als shipmentitem.containerNumber.hidden

$ vi shipment-order_edit.jsp

				<c:if test="${!empty formVO.shipmentItemList or true}">
					<mpo:tab name="shipmentItems">
						<tmstags:sho-shipmentitems />
					</mpo:tab>
				</c:if>

$ vi sho-shipmentitems.tag

<%@taglib prefix="cf" uri="/WEB-INF/tld/core-functions.tld"%>

/ list van shipment items	,
				<c:if test="${cf:property('oms', 'shipmentitem.containernumber.hidden', 'false')=='false'}">
					<th><mpo:label name="containerNumber" entity="shipmentitem" /></th>
				</c:if>
				...
				<c:if test="${cf:property('oms', 'shipmentitem.containernumber.hidden', 'false')=='false'}">
					<td>${shipmentItemList.containerNumber}</td>
				</c:if>

/ shipment item  part of shipment order form	,
				<c:if test="${cf:property('oms', 'shipmentitem.containernumber.hidden', 'false')=='false'}">
					<mpo:field name="containerNumber" />
				</c:if>

/ list van shipment items	,
				<c:if test="${cf:property('oms', 'shipmentitem.stackable.hidden', 'false')=='false'}">
					<th><mpo:label name="stackable" entity="shipmentitem" /></th>
				</c:if>
				<c:if test="${cf:property('oms', 'shipmentitem.stackable.hidden', 'false')=='false'}">
					<td>${shipmentItemList.stackable}</td>
				</c:if>
/ form	,
				<c:if test="${cf:property('oms','shipmentitem.stackable.hidden','false')=='false' }">
					<mpo:booleanField name="stackable" overRideable="true" />
				</c:if>


$ vi sho-productitems.tag

/ form
											<c:if test="${cf:property('oms', 'productitem.customerorderline.hidden', 'false')=='false'}">
												<mpo:listField name="customerOrderLine" type="customerOrderLine" />
												<mpo:numberField name="customerOrderLineSystemId" type="int" hidden="true" />
											</c:if>

/ list van product items	,
				<c:if test="${cf:property('oms', 'productitem.customsnumber.hidden', 'false')=='false'}">
					<th><mpo:label name="customsNumber" entity="productitem" /></th>
				</c:if>
				<c:if test="${cf:property('oms', 'productitem.customsnumber.hidden', 'false')=='false'}">
					<td>${currentItem.customsNumber}</td>
				</c:if>

/ form
										<c:if test="${cf:property('oms', 'productitem.customsnumber.hidden', 'false')=='false'}">
											<mpo:field name="customsNumber" /> 
										</c:if>

/ list	,
				<c:if test="${cf:property('oms', 'productitem.individualitemvalue.hidden', 'false')=='false'}">
					<th colspan="2"><mpo:label name="individualItemValue" entity="productitem" /></th>
				</c:if>
				<c:if test="${cf:property('oms', 'productitem.individualitemvalue.hidden', 'false')=='false'}">
					<td>${cf:formatNumber(currentItem.individualItemValue)}</td>
					<td>${currentItem.valueCurrencyVO.code}</td>
				</c:if>
/ form	,
										<c:if test="${cf:property('oms', 'productitem.individualitemvalue.hidden', 'false')=='false'}">
											<mpo:numberField type="float" minValue="0" name="individualItemValue">
												<mpo:listField name="valueCurrency" type="currency" />
											</mpo:numberField>
										</c:if>											

/ in list	,
				<c:if test="${cf:property('oms', 'productitem.partnumber.hidden', 'false')=='false'}">
					<th><mpo:label name="partNumber" entity="productitem" /></th>
				</c:if>
				<c:if test="${cf:property('oms', 'productitem.partnumber.hidden', 'false')=='false'}">
					<td>${currentItem.partNumber}</td>
				</c:if>
/ in form	,
										<c:if test="${cf:property('oms', 'productitem.partnumber.hidden', 'false')=='false'}">
											<mpo:field name="partNumber" />
										</c:if>
/ in list	,
				<c:if test="${cf:property('oms', 'productitem.productmodel.hidden', 'false')=='false'}">
					<th><mpo:label name="productModel" entity="productitem" /></th>
				</c:if>
				<c:if test="${cf:property('oms', 'productitem.productmodel.hidden', 'false')=='false'}">
					<td>${currentItem.productModel}</td>
				</c:if>
/ in form	,
										<c:if test="${cf:property('oms', 'productitem.productmodel.hidden', 'false')=='false'}">
											<mpo:field name="productModel" />
										</c:if>
/ in list	,
				<c:if test="${cf:property('oms', 'productitem.productseries.hidden', 'false')=='false'}">
					<th><mpo:label name="productSeries" entity="productitem" /></th>
				</c:if>
				<c:if test="${cf:property('oms', 'productitem.productseries.hidden', 'false')=='false'}">
					<td>${currentItem.productSeries}</td>
				</c:if>
/ in form	,
										<c:if test="${cf:property('oms', 'productitem.productseries.hidden', 'false')=='false'}">
											<mpo:field name="productSeries" />
										</c:if>
/ in list	,
				<c:if test="${cf:property('oms', 'productitem.productgroup.hidden', 'false')=='false'}">
					<th><mpo:label name="productGroup" entity="productitem" /></th>
				</c:if>
				<c:if test="${cf:property('oms', 'productitem.productgroup.hidden', 'false')=='false'}">
					<td>${currentItem.productGroup}</td>
				</c:if>
/ in form	,
										<c:if test="${cf:property('oms', 'productitem.productgroup.hidden', 'false')=='false'}">
											<mpo:field name="productGroup" />
										</c:if>
/ in list	,
				<c:if test="${cf:property('oms', 'productitem.productOwner.hidden', 'false')=='false'}">
					<th><mpo:label name="productOwner" entity="productitem" /></th>
				</c:if>
				<c:if test="${cf:property('oms', 'productitem.productowner.hidden', 'false')=='false'}">
					<td>${currentItem.productOwner}</td>
				</c:if>
/ in form	,
										<c:if test="${cf:property('oms', 'productitem.productowner.hidden', 'false')=='false'}">																			<mpo:field name="productOwner" />
										</c:if>
/ in list	,
				<c:if test="${cf:property('oms', 'productitem.countryoforigin.hidden', 'false')=='false'}">
					<th><mpo:label name="countryOfOrigin" entity="productitem" /></th>
				</c:if>
				<c:if test="${cf:property('oms', 'productitem.countryoforigin.hidden', 'false')=='false'}">
					<td>${currentItem.countryOfOriginVO.code}</td>
				</c:if>
/ in form	,
										<c:if test="${cf:property('oms', 'productitem.countryoforigin.hidden', 'false')=='false'}">
											<mpo:listField name="countryOfOrigin" type="country" />
										</c:if>
/ in list	,
						<c:if test="${cf:property('oms', 'productitem.reference2.hidden', 'false')=='false'}">
							<th><mpo:label name="reference2" entity="productitem" /></th>
						</c:if>
						<c:if test="${cf:property('oms', 'productitem.reference3.hidden', 'false')=='false'}">
							<th><mpo:label name="reference3" entity="productitem" /></th>
						</c:if>
						<c:if test="${cf:property('oms', 'productitem.reference4.hidden', 'false')=='false'}">
							<th><mpo:label name="reference4" entity="productitem" /></th>
						</c:if>
						<c:if test="${cf:property('oms', 'productitem.reference5.hidden', 'false')=='false'}">
							<th><mpo:label name="reference5" entity="productitem" /></th>
						</c:if>
						<c:if test="${cf:property('oms', 'productitem.reference2.hidden', 'false')=='false'}">
							<td>${currentItem.reference2}</td>
						</c:if>
						<c:if test="${cf:property('oms', 'productitem.reference3.hidden', 'false')=='false'}">
							<td>${currentItem.reference3}</td>
						</c:if>
						<c:if test="${cf:property('oms', 'productitem.reference4.hidden', 'false')=='false'}">
							<td>${currentItem.reference4}</td>
						</c:if>
						<c:if test="${cf:property('oms', 'productitem.reference5.hidden', 'false')=='false'}">
							<td>${currentItem.reference5}</td>
						</c:if>
/ in form 	,
												<c:if test="${cf:property('oms', 'productitem.reference2.hidden', 'false')=='false'}">
													<mpo:field languageKey="productitem.reference2" name="reference2" />
												</c:if>
												<c:if test="${cf:property('oms', 'productitem.reference3.hidden', 'false')=='false'}">
													<mpo:field languageKey="productitem.reference3" name="reference3" />
												</c:if>
												<c:if test="${cf:property('oms', 'productitem.reference4.hidden', 'false')=='false'}">
													<mpo:field languageKey="productitem.reference4" name="reference4" />
												</c:if>
												<c:if test="${cf:property('oms', 'productitem.reference5.hidden', 'false')=='false'}">
													<mpo:field languageKey="productitem.reference5" name="reference5" />
												</c:if>
/ in list	,
					<c:if test="${cf:property('oms', 'hazgoods.actualadrcode.hidden', 'false')=='false'}">
						<th><mpo:label name="actualAdrCode.adrCode" entity="productitem" /></th>
					</c:if>
					<c:if test="${cf:property('oms', 'hazgoods.actualunnumber.hidden', 'false')=='false'}"
						<th><mpo:label name="actualUnNumber.unNumber" entity="productitem" /></th>
					</c:if>
					<c:if test="${cf:property('oms', 'hazgoods.actualadrcode.hidden', 'false')=='false'}">
						<td>${currentItem.actualAdrCode.adrCode}</td>
					</c:if>
					<c:if test="${cf:property('oms', 'hazgoods.actualunnumber.hidden', 'false')=='false'}">
						<td>${currentItem.actualUnNumber.unNumber}</td>
					</c:if>


/ in form	,  
								<c:if test="${cf:property('oms', 'hazgoods.actualadrcode.hidden', 'false')=='false'}">
									<mpo:listField name="actualAdrCode" type="adrcode" />
								</c:if>
								<c:if test="${cf:property('oms', 'hazgoods.actualunnumber.hidden', 'false')=='false'}">
									<mpo:listField name="actualUnNumber" type="unnumber" />
								</c:if>






/ in db	,
module.oms.shipmentitem.containernumber.hidden=true
module.oms.shipmentitem.stackable.hidden=true

module.oms.productitem.customerorderline.hidden=true
module.oms.productitem.customsnumber.hidden=true
module.oms.productitem.individualitemvalue.hidden=true
module.oms.productitem.partnumber.hidden=true
module.oms.productitem.productmodel.hidden=true
module.oms.productitem.productseries.hidden=true
module.oms.productitem.productgroup.hidden=true
module.oms.productitem.productowner.hidden=true
module.oms.productitem.countryoforigin.hidden=true
module.oms.productitem.reference2.hidden=true
module.oms.productitem.reference3.hidden=true
module.oms.productitem.reference4.hidden=true
module.oms.productitem.reference5.hidden=true

module.oms.hazgoods.actualadrcode.hidden=true 
module.oms.hazgoods.actualunnumber.hidden=true 

/ text in GUI
hide container field in shipment item part of shipment order form.
hide stackable field in shipment item part of shipment order form.
hide customer order line field in product item part of shipment order form.
hide customs number field in product item part of shipment order form.
hide individual item value field in product item part of shipment order form.
hide part no. field in product item part of shipment order form.
hide model field in product item part of shipment order form.
hide series field in product item part of shipment order form.
hide product group field in product item part of shipment order form.
hide product owner field in product item part of shipment order form.
hide country of origin field in product item part of shipment order form.
hide reference2 field in product item part of shipment order form.
hide reference3 field in product item part of shipment order form.
hide reference4 field in product item part of shipment order form.
hide reference5 field in product item part of shipment order form.
hide actual adr code field in hazardous goods part on shipment order form.
hide actual un number field in hazardous goods part on shipment order form.




/ Einde FIX PCT-504

/ Einde PCT-504

/ PCT-505

$ vi shipment-order_edit.jsp 

			<mpo:tab name="shipFrom">
				<tmstags:shipfrom formid="shipmentorder" />
			</mpo:tab>
			<mpo:tab name="shipTo">
				<tmstags:shipto formid="shipmentorder" />
			</mpo:tab>
			<mpo:tab name="billTo">
				<tmstags:sho-billto />
			</mpo:tab>

$ vi shipfrom.tag
				<c:if test="${cf:property('tms', 'serviceorder.shipfrom.party.reference4.hidden', 'true')=='false'}">
					<mpo:field languageKey="shipfrom.reference4" name="reference1" />
				</c:if>
/ de 1ste property, bepaalt of field zichtbaar is	, -> db	,
/ de 2de is de translation, -> language file	, 

myProductSpecificCode	"pnllogistics.table_shipment_order_shipfrom.reference4" (id=21780)	

/ 13	. 

[eric@localhost Backup]$ pwd
/home/eric/Devel/Postgres/Backup
$ PGPASSWORD='h^Zgcyr&Q' pg_dump -U vanderveldene -Fc -h pnl-app-t.intermax.mp-objects.com pnltms> pnl-app-a_pnltms-$(date +"%y-%m-%d").dump 

pnllogistics2=# create database pnltms2;
CREATE DATABASE
[eric@localhost Backup]$ PGPASSWORD=mpopostgres@mpo pg_restore -U mpopostgres -d  pnltms2 pnl-app-a_pnltms-$(date +"%y-%m-%d").dump 
/ ERR
/ Veel Errors	,


/ Einde PCT-505

/ PCT-499

/ FIX PCT-499

/ nieuwe properties	,
module.oms.shipmentorder.orderprocess.required=true
module.oms.shipmentorder.reference2.required=true
module.oms.shipmentitem.weight.nominvalue.required=true
/ descriptions	,
require the order process field on shipment order form. 
require the reference2 field on shipment order form. 
require the weight(Kg) field in shipment item part of shipment order, but can be 0.

$ vi shipment-order_edit.jsp

						<c:choose>
							<c:when test="${cf:property('oms', 'shipmentorder.orderprocess.required', 'false')}">
								<mpo:listField name="orderProcess" type="orderProcess" overRideable="true" required="true"/>
							</c:when>
							<c:otherwise>
								<mpo:listField name="orderProcess" type="orderProcess" overRideable="true"/>
							</c:otherwise>
						</c:choose>

						<c:choose>
							<c:when test="${cf:property('oms', 'shipmentorder.reference2.required', 'false')}">
								<mpo:field name="reference2" languageKey="shipmentorder.reference2.${cf:property('', 'base.product','')}.${fn:toLowerCase(formVO.shipmentOrderProcess)}" overRideable="true" size="15"
									readOnly="${!reference2Editable}" required="true" />
							</c:when>
							<c:otherwise>
								<mpo:field name="reference2" languageKey="shipmentorder.reference2.${cf:property('', 'base.product','')}.${fn:toLowerCase(formVO.shipmentOrderProcess)}" overRideable="true" size="15"
									readOnly="${!reference2Editable}"/>
							</c:otherwise>
						</c:choose>

$ vi sho-shipmentitems.tag

										<c:choose>
											<c:when test="${cf:property('oms', 'shipmentitem.weight.or.totalweight.required', 'false')}">
												<mpo:numberField name="weightKg" type="float" minValue="0.1" required="true" />
											</c:when>
											<c:when test="${cf:property('oms', 'shipmentitem.weight.nominvalue.required', 'false')}">
												<mpo:numberField name="weightKg" type="float" required="true" />
											</c:when>
											<c:otherwise>
												<mpo:numberField name="weightKg" type="float" />
											</c:otherwise>
										</c:choose>

/ Einde FIX PCT-499


/ Einde PCT-499

/ PCT-510

$ vi oms-sitemap.xmap

			<map:match pattern="shipment-order_list">
				<map:act type="shipmentOrderList"/>			
				<map:call resource="dynatablePage">
					<map:parameter name="xsp" value="xsp/shipment-order_list.xml"/>
				</map:call>
			</map:match>

$ vi shipment-order_list.xml

            if(!myTable.isFieldHidden("organization")){
            	myTable.addDatabaseJoinColumn("organization","organization_id", 11);
            }


$ vi Table.java
package com.mpobjects.view.util.table;

	public boolean isFieldHidden(String aFieldName) {
		String myModule = EntityActionUtil.getModule(new RequestAdaptor(getRequest()));
oms
		String myEntity = StringUtils.formatToPropertiesKey(getName());
shipmentorder
		String myFieldName = StringUtils.formatToPropertiesKey(aFieldName.toLowerCase());
organization
		String myKey = myEntity + "." + myFieldName + ".hidden";
shipmentorder.organization.hidden
		boolean isHidden = ApplicationPropertyManager.getInstance().getModuleProperty(myModule, myKey, false);

/ Intermezzo

/ In jsp's	precies hetzelfde	,

<%@taglib prefix="cf" uri="/WEB-INF/tld/core-functions.tld"%>
							<c:when test="${cf:property('oms', 'shipmentorder.orderprocess.required', 'false')}">

$ vi core-functions.tld
<function>
	<name>property</name>
    <function-class>com.mpobjects.core.ApplicationPropertyManager</function-class>
    <function-signature>
        java.lang.String  taglibGetProperty(java.lang.String,java.lang.String,java.lang.String)
    </function-signature>
</function>

$ vi ApplicationPropertyManager.java
	public static String taglibGetProperty(String aModule, String aKey, String aDefaultValue) {
		return getInstance().getModuleProperty(aModule, aKey, aDefaultValue);
	}

/ Einde Intermezzo

/ we debug	,
	public boolean isFieldHidden(String aFieldName) {
		boolean isHidden = ApplicationPropertyManager.getInstance().getModuleProperty(myModule, myKey, false);
myModule	"oms" (id=21444)	
myKey	"shipmentorder.organization.hidden" (id=21483)	
...
/s
ApplicationPropertyManager.getModuleProperty(String, String, String) line: 378	
		return getProperty(getPropertyKey(aModule, aKey), aDefaultValue);
/s
ApplicationPropertyManager.getProperty(String, String) line: 531	
module.oms.shipmentorder.organization.hidden

/ FIX PCT-501

$ vi shipment-order_list.xml
				if (!myTable.isFieldHidden("requestedstartafter")) {

				if (!myTable.isFieldHidden("requestedendafter")) {
				
				if (!myTable.isFieldHidden("requestedendbefore")) {


/ create property
module.oms.shipmentorder.requestedstartafter.hidden=true
module.oms.shipmentorder.requestedendafter.hidden=true
module.oms.shipmentorder.requestedendbefor.hidden=true
/ ze zijn er al, maar de value zijn false	, moet true 	,

module.oms.shipmentorder.search.requestedstartafter.hidden=true



/ Einde FIX PCT-501




/ Einde PCT-510




/ PLAN

/ Open op test	,
SH000002841
/ deze heeft meerdere sa's en seo's	, 

/ Einde PLAN

/ SVN

[eric@localhost trunk]$ svn blame $(find -name sho-shipmentitems.tag) |less

/ Einde SVN


/ PCT-504

/ Als we een property form open	, dan soms ERR	,

2015-08-05 14:50:25,436 ERROR [org.apache.wicket.markup.html.WebPage] (http-0.0.0.0-8080-3:) ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2015-08-05 14:50:25,436 ERROR [org.apache.wicket.markup.html.WebPage] (http-0.0.0.0-8080-3:) You probably forgot to add a <body> or <head> tag to your markup since no Header Container was 
found but components were found which want to write to the <head> section.
<script type="text/javascript" src="resources/org.apache.wicket.markup.html.WicketEventReference/wicket-event.js"></script>
<script type="text/javascript" src="resources/org.apache.wicket.ajax.WicketAjaxReference/wicket-ajax.js"></script>
<script type="text/javascript" src="resources/org.apache.wicket.ajax.AbstractDefaultAjaxBehavior/wicket-ajax-debug.js"></script>
<script type="text/javascript" id="wicket-ajax-debug-enable"><!--/*--><![CDATA[/*><!--*/
wicketAjaxDebugEnable=true;
/*-->]]>*/</script>


2015-08-05 14:50:25,436 ERROR [org.apache.wicket.markup.html.WebPage] (http-0.0.0.0-8080-3:) ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
2015-08-05 14:50:25,436 ERROR [org.apache.wicket.RequestCycle] (http-0.0.0.0-8080-3:) Error attaching this container for rendering: [Page class = com.mpobjects.oms.view.wicket.property.PropertyEditFormPage, id = 8, version = 0, ajax = 0]
org.apache.wicket.WicketRuntimeException: Error attaching this container for rendering: [Page class = com.mpobjects.oms.view.wicket.property.PropertyEditFormPage, id = 8, version = 0, ajax = 0]
	at org.apache.wicket.MarkupContainer.onBeforeRenderChildren(MarkupContainer.java:1789)
	at org.apache.wicket.Component.onBeforeRender(Component.java:4001)
	at org.apache.wicket.Page.onBeforeRender(Page.java:1555)
	at org.apache.wicket.Component.internalBeforeRender(Component.java:1069)
	at org.apache.wicket.Component.beforeRender(Component.java:1103)
	at org.apache.wicket.Component.prepareForRender(Component.java:2297)
	at org.apache.wicket.Page.prepareForRender(Page.java:1545)
	at org.apache.wicket.Component.prepareForRender(Component.java:2329)
	at org.apache.wicket.Page.renderPage(Page.java:912)
	at org.apache.wicket.request.target.component.PageRequestTarget.respond(PageRequestTarget.java:63)
	at org.apache.wicket.request.AbstractRequestCycleProcessor.respond(AbstractRequestCycleProcessor.java:105)
	at org.apache.wicket.RequestCycle.processEventsAndRespond(RequestCycle.java:1287)
	at org.apache.wicket.RequestCycle.step(RequestCycle.java:1358)
	at org.apache.wicket.RequestCycle.steps(RequestCycle.java:1465)
	at org.apache.wicket.RequestCycle.request(RequestCycle.java:545)
	at org.apache.wicket.protocol.http.WicketFilter.doGet(WicketFilter.java:486)
	at org.apache.wicket.protocol.http.WicketServlet.doGet(WicketServlet.java:138)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:697)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:810)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:252)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:173)
	at com.mpobjects.control.filter.FirstLoginFilter.doFilter(FirstLoginFilter.java:76)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:202)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:173)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:330)
	at org.springframework.security.web.access.intercept.FilterSecurityInterceptor.invoke(FilterSecurityInterceptor.java:118)
	at org.springframework.security.web.access.intercept.FilterSecurityInterceptor.doFilter(FilterSecurityInterceptor.java:84)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:113)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:103)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
	at org.springframework.security.web.authentication.AnonymousAuthenticationFilter.doFilter(AnonymousAuthenticationFilter.java:113)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
	at org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:154)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
	at org.springframework.security.web.savedrequest.RequestCacheAwareFilter.doFilter(RequestCacheAwareFilter.java:45)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
	at org.springframework.security.web.authentication.AbstractAuthenticationProcessingFilter.doFilter(AbstractAuthenticationProcessingFilter.java:199)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:110)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
	at com.mpobjects.auth.springsec.RunAsLogoutFilter.doFilter(RunAsLogoutFilter.java:41)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
	at org.springframework.security.web.context.SecurityContextPersistenceFilter.doFilter(SecurityContextPersistenceFilter.java:87)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
	at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:192)
	at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:160)
	at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:343)
	at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:260)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:202)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:173)
	at filters.SetCharacterEncodingFilter.doFilter(SetCharacterEncodingFilter.java:111)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:202)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:173)
	at org.springframework.orm.hibernate3.support.OpenSessionInViewFilter.doFilterInternal(OpenSessionInViewFilter.java:230)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:202)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:173)
	at org.jboss.web.tomcat.filters.ReplyHeaderFilter.doFilter(ReplyHeaderFilter.java:96)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:202)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:173)
	at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:213)
	at org.apache.catalina.core.StandardContextValve.__invoke(StandardContextValve.java:178)
	at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java)
	at org.jboss.web.tomcat.security.SecurityAssociationValve.invoke(SecurityAssociationValve.java:175)
	at org.jboss.web.tomcat.security.JaccContextValve.invoke(JaccContextValve.java:74)
	at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:126)
	at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:105)
	at org.jboss.web.tomcat.tc5.jca.CachedConnectionValve.invoke(CachedConnectionValve.java:156)
	at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:107)
	at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:148)
	at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:869)
	at org.apache.coyote.http11.Http11BaseProtocol$Http11ConnectionHandler.processConnection(Http11BaseProtocol.java:664)
	at org.apache.tomcat.util.net.PoolTcpEndpoint.processSocket(PoolTcpEndpoint.java:527)
	at org.apache.tomcat.util.net.MasterSlaveWorkerThread.run(MasterSlaveWorkerThread.java:112)
	at java.lang.Thread.run(Thread.java:745)
Caused by: org.hibernate.NonUniqueObjectException: a different object with the same identifier value was already associated with the session: [com.mpobjects.oms.model.entity.property.Property#26831890]
	at org.hibernate.engine.StatefulPersistenceContext.checkUniqueness(StatefulPersistenceContext.java:638)
	at org.hibernate.event.def.DefaultSaveOrUpdateEventListener.performUpdate(DefaultSaveOrUpdateEventListener.java:305)
	at org.hibernate.event.def.DefaultSaveOrUpdateEventListener.entityIsDetached(DefaultSaveOrUpdateEventListener.java:246)
	at org.hibernate.event.def.DefaultUpdateEventListener.performSaveOrUpdate(DefaultUpdateEventListener.java:57)
	at org.hibernate.event.def.DefaultSaveOrUpdateEventListener.onSaveOrUpdate(DefaultSaveOrUpdateEventListener.java:93)
	at org.hibernate.impl.SessionImpl.fireUpdate(SessionImpl.java:742)
	at org.hibernate.impl.SessionImpl.update(SessionImpl.java:730)
	at org.hibernate.impl.SessionImpl.update(SessionImpl.java:722)
	at com.mpobjects.view.wicket.util.single.GenericFormPanel.reloadObject(GenericFormPanel.java:216)
	at com.mpobjects.view.wicket.util.single.GenericFormPanel.onBeforeRender(GenericFormPanel.java:112)
	at org.apache.wicket.Component.internalBeforeRender(Component.java:1069)
	at org.apache.wicket.Component.beforeRender(Component.java:1103)
	at org.apache.wicket.MarkupContainer.onBeforeRenderChildren(MarkupContainer.java:1777)
	... 76 more

/ Ook als we een property open	, en we veranderen de name	, dan 	,
/ Maar we zien in de db dat hij wel is create	,

org.hibernate.NonUniqueObjectException: a different object with the same identifier value was already associated with the session: [com.mpobjects.oms.model.entity.property.Property#26831890]
	at org.hibernate.engine.StatefulPersistenceContext.checkUniqueness(StatefulPersistenceContext.java:638)
	at org.hibernate.event.def.DefaultSaveOrUpdateEventListener.performUpdate(DefaultSaveOrUpdateEventListener.java:305)
	at org.hibernate.event.def.DefaultSaveOrUpdateEventListener.entityIsDetached(DefaultSaveOrUpdateEventListener.java:246)
	at org.hibernate.event.def.DefaultUpdateEventListener.performSaveOrUpdate(DefaultUpdateEventListener.java:57)
	at org.hibernate.event.def.DefaultSaveOrUpdateEventListener.onSaveOrUpdate(DefaultSaveOrUpdateEventListener.java:93)
	at org.hibernate.impl.SessionImpl.fireUpdate(SessionImpl.java:742)
	at org.hibernate.impl.SessionImpl.update(SessionImpl.java:730)
	at org.hibernate.impl.SessionImpl.update(SessionImpl.java:722)
	at com.mpobjects.view.wicket.util.single.GenericFormPanel.reloadObject(GenericFormPanel.java:216)
	at com.mpobjects.view.wicket.util.single.GenericFormPanel.onBeforeRender(GenericFormPanel.java:112)
	at org.apache.wicket.Component.internalBeforeRender(Component.java:1069)
	at org.apache.wicket.Component.beforeRender(Component.java:1103)
	at org.apache.wicket.Component.prepareForRender(Component.java:2297)
	at org.apache.wicket.Component.prepareForRender(Component.java:2329)
	at org.apache.wicket.ajax.AjaxRequestTarget.respondComponent(AjaxRequestTarget.java:853)
	at org.apache.wicket.ajax.AjaxRequestTarget.respondComponents(AjaxRequestTarget.java:680)
	at org.apache.wicket.ajax.AjaxRequestTarget.respond(AjaxRequestTarget.java:590)
	at org.apache.wicket.request.AbstractRequestCycleProcessor.respond(AbstractRequestCycleProcessor.java:105)
	at org.apache.wicket.RequestCycle.processEventsAndRespond(RequestCycle.java:1287)
	at org.apache.wicket.RequestCycle.step(RequestCycle.java:1358)
	at org.apache.wicket.RequestCycle.steps(RequestCycle.java:1465)
	at org.apache.wicket.RequestCycle.request(RequestCycle.java:545)
	at org.apache.wicket.protocol.http.WicketFilter.doGet(WicketFilter.java:486)
	at org.apache.wicket.protocol.http.WicketServlet.doPost(WicketServlet.java:160)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:717)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:810)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:252)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:173)
	at com.mpobjects.control.filter.FirstLoginFilter.doFilter(FirstLoginFilter.java:76)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:202)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:173)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:330)
	at org.springframework.security.web.access.intercept.FilterSecurityInterceptor.invoke(FilterSecurityInterceptor.java:118)
	at org.springframework.security.web.access.intercept.FilterSecurityInterceptor.doFilter(FilterSecurityInterceptor.java:84)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
	at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:113)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
	at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:103)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
	at org.springframework.security.web.authentication.AnonymousAuthenticationFilter.doFilter(AnonymousAuthenticationFilter.java:113)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
	at org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:154)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
	at org.springframework.security.web.savedrequest.RequestCacheAwareFilter.doFilter(RequestCacheAwareFilter.java:45)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
	at org.springframework.security.web.authentication.AbstractAuthenticationProcessingFilter.doFilter(AbstractAuthenticationProcessingFilter.java:199)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
	at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:110)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
	at com.mpobjects.auth.springsec.RunAsLogoutFilter.doFilter(RunAsLogoutFilter.java:41)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
	at org.springframework.security.web.context.SecurityContextPersistenceFilter.doFilter(SecurityContextPersistenceFilter.java:87)
	at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
	at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:192)
	at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:160)
	at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:343)
	at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:260)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:202)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:173)
	at filters.SetCharacterEncodingFilter.doFilter(SetCharacterEncodingFilter.java:111)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:202)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:173)
	at org.springframework.orm.hibernate3.support.OpenSessionInViewFilter.doFilterInternal(OpenSessionInViewFilter.java:230)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:202)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:173)
	at org.jboss.web.tomcat.filters.ReplyHeaderFilter.doFilter(ReplyHeaderFilter.java:96)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:202)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:173)
	at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:213)
	at org.apache.catalina.core.StandardContextValve.__invoke(StandardContextValve.java:178)
	at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java)
	at org.jboss.web.tomcat.security.SecurityAssociationValve.invoke(SecurityAssociationValve.java:175)
	at org.jboss.web.tomcat.security.JaccContextValve.invoke(JaccContextValve.java:74)
	at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:126)
	at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:105)
	at org.jboss.web.tomcat.tc5.jca.CachedConnectionValve.invoke(CachedConnectionValve.java:156)
	at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:107)
	at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:148)
	at org.apache.coyote.http11.Http11Processor.process(Http11Processor.java:869)
	at org.apache.coyote.http11.Http11BaseProtocol$Http11ConnectionHandler.processConnection(Http11BaseProtocol.java:664)
	at org.apache.tomcat.util.net.PoolTcpEndpoint.processSocket(PoolTcpEndpoint.java:527)
	at org.apache.tomcat.util.net.MasterSlaveWorkerThread.run(MasterSlaveWorkerThread.java:112)
	at java.lang.Thread.run(Thread.java:745)

/ op acceptance	, als we een properties edit,  soms wel , soms niet 	,

Error Details
Page class: com.mpobjects.oms.view.wicket.property.PropertyEditFormPage
WicketMessage: Error attaching this container for rendering: [Page class = com.mpobjects.oms.view.wicket.property.PropertyEditFormPage, id = 2, version = 0, ajax = 30]
Root cause:
org.hibernate.NonUniqueObjectException: a different object with the same identifier value was already associated with the session: [com.mpobjects.oms.model.entity.property.Property#26836515]
     at org.hibernate.engine.StatefulPersistenceContext.checkUniqueness(StatefulPersistenceContext.java:638)
     at org.hibernate.event.def.DefaultSaveOrUpdateEventListener.performUpdate(DefaultSaveOrUpdateEventListener.java:305)
     at org.hibernate.event.def.DefaultSaveOrUpdateEventListener.entityIsDetached(DefaultSaveOrUpdateEventListener.java:246)
     at org.hibernate.event.def.DefaultUpdateEventListener.performSaveOrUpdate(DefaultUpdateEventListener.java:57)
     at org.hibernate.event.def.DefaultSaveOrUpdateEventListener.onSaveOrUpdate(DefaultSaveOrUpdateEventListener.java:93)
     at org.hibernate.impl.SessionImpl.fireUpdate(SessionImpl.java:742)
     at org.hibernate.impl.SessionImpl.update(SessionImpl.java:730)
     at org.hibernate.impl.SessionImpl.update(SessionImpl.java:722)
     at com.mpobjects.view.wicket.util.single.GenericFormPanel.reloadObject(GenericFormPanel.java:216)
     at com.mpobjects.view.wicket.util.single.GenericFormPanel.onBeforeRender(GenericFormPanel.java:112)
     at org.apache.wicket.Component.internalBeforeRender(Component.java:1069)
     at org.apache.wicket.Component.beforeRender(Component.java:1103)
     at org.apache.wicket.MarkupContainer.onBeforeRenderChildren(MarkupContainer.java:1777)
     at org.apache.wicket.Component.onBeforeRender(Component.java:4001)
     at org.apache.wicket.Page.onBeforeRender(Page.java:1555)
     at org.apache.wicket.Component.internalBeforeRender(Component.java:1069)
     at org.apache.wicket.Component.beforeRender(Component.java:1103)
     at org.apache.wicket.Component.prepareForRender(Component.java:2297)
     at org.apache.wicket.Page.prepareForRender(Page.java:1545)
     at org.apache.wicket.Component.prepareForRender(Component.java:2329)
     at org.apache.wicket.Page.renderPage(Page.java:912)
     at org.apache.wicket.request.target.component.PageRequestTarget.respond(PageRequestTarget.java:63)
     at org.apache.wicket.request.AbstractRequestCycleProcessor.respond(AbstractRequestCycleProcessor.java:105)
     at org.apache.wicket.RequestCycle.processEventsAndRespond(RequestCycle.java:1287)
     at org.apache.wicket.RequestCycle.step(RequestCycle.java:1358)
     at org.apache.wicket.RequestCycle.steps(RequestCycle.java:1465)
     at org.apache.wicket.RequestCycle.request(RequestCycle.java:545)
     at org.apache.wicket.protocol.http.WicketFilter.doGet(WicketFilter.java:486)
     at org.apache.wicket.protocol.http.WicketServlet.doGet(WicketServlet.java:138)
     at javax.servlet.http.HttpServlet.service(HttpServlet.java:697)
     at javax.servlet.http.HttpServlet.service(HttpServlet.java:810)
     at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:252)
     at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:173)
     at com.mpobjects.control.filter.FirstLoginFilter.doFilter(FirstLoginFilter.java:76)
     at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:202)
     at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:173)
     at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:330)
     at org.springframework.security.web.access.intercept.FilterSecurityInterceptor.invoke(FilterSecurityInterceptor.java:118)
     at org.springframework.security.web.access.intercept.FilterSecurityInterceptor.doFilter(FilterSecurityInterceptor.java:84)
     at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
     at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:113)
     at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
     at org.springframework.security.web.session.SessionManagementFilter.doFilter(SessionManagementFilter.java:103)
     at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
     at org.springframework.security.web.authentication.AnonymousAuthenticationFilter.doFilter(AnonymousAuthenticationFilter.java:113)
     at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
     at org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:154)
     at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
     at org.springframework.security.web.savedrequest.RequestCacheAwareFilter.doFilter(RequestCacheAwareFilter.java:45)
     at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
     at org.springframework.security.web.authentication.AbstractAuthenticationProcessingFilter.doFilter(AbstractAuthenticationProcessingFilter.java:199)
     at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
     at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:110)
     at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
     at com.mpobjects.auth.springsec.RunAsLogoutFilter.doFilter(RunAsLogoutFilter.java:41)
     at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
     at org.springframework.security.web.context.SecurityContextPersistenceFilter.doFilter(SecurityContextPersistenceFilter.java:87)
     at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:342)
     at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:192)
     at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:160)
     at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:343)
     at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:260)
     at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:202)
     at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:173)
     at filters.SetCharacterEncodingFilter.doFilter(SetCharacterEncodingFilter.java:111)
     at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:202)
     at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:173)
     at org.springframework.orm.hibernate3.support.OpenSessionInViewFilter.doFilterInternal(OpenSessionInViewFilter.java:230)
     at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)
     at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:202)
     at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:173)
     at org.jboss.web.tomcat.filters.ReplyHeaderFilter.doFilter(ReplyHeaderFilter.java:96)
     at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:202)
     at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:173)
     at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:213)
     at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:178)
     at org.jboss.web.tomcat.security.SecurityAssociationValve.invoke(SecurityAssociationValve.java:175)
     at org.jboss.web.tomcat.security.JaccContextValve.invoke(JaccContextValve.java:74)
     at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:126)
     at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:105)
     at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:107)
     at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:148)
     at org.apache.jk.server.JkCoyoteHandler.invoke(JkCoyoteHandler.java:199)
     at org.apache.jk.common.HandlerRequest.invoke(HandlerRequest.java:282)
     at org.apache.jk.common.ChannelSocket.invoke(ChannelSocket.java:767)
     at org.apache.jk.common.ChannelSocket.processConnection(ChannelSocket.java:697)
     at org.apache.jk.common.ChannelSocket$SocketConnection.runIt(ChannelSocket.java:889)
     at org.apache.tomcat.util.threads.ThreadPool$ControlRunnable.run(ThreadPool.java:684)
     at java.lang.Thread.run(Thread.java:701)
Complete stack:
org.apache.wicket.WicketRuntimeException: Error attaching this container for rendering: [Page class = com.mpobjects.oms.view.wicket.property.PropertyEditFormPage, id = 2, version = 0, ajax = 30]
     at org.apache.wicket.MarkupContainer.onBeforeRenderChildren(MarkupContainer.java:1789)
     at org.apache.wicket.Component.onBeforeRender(Component.java:4001)
     at org.apache.wicket.Page.onBeforeRender(Page.java:1555)
     at org.apache.wicket.Component.internalBeforeRender(Component.java:1069)
     at org.apache.wicket.Component.beforeRender(Component.java:1103)
     at org.apache.wicket.Component.prepareForRender(Component.java:2297)
     at org.apache.wicket.Page.prepareForRender(Page.java:1545)
     at org.apache.wicket.Component.prepareForRender(Component.java:2329)
     at org.apache.wicket.Page.renderPage(Page.java:912)
     at org.apache.wicket.request.target.component.PageRequestTarget.respond(PageRequestTarget.java:63)
     at org.apache.wicket.request.AbstractRequestCycleProcessor.respond(AbstractRequestCycleProcessor.java:105)
     at org.apache.wicket.RequestCycle.processEventsAndRespond(RequestCycle.java:1287)
     at org.apache.wicket.RequestCycle.step(RequestCycle.java:1358)
     at org.apache.wicket.RequestCycle.steps(RequestCycle.java:1465)
     at org.apache.wicket.RequestCycle.request(RequestCycle.java:545)
     at org.apache.wicket.protocol.http.WicketFilter.doGet(WicketFilter.java:486)

 
/ TODO

/ Einde PCT-504


/ PAT-152

/ import acceptance database van pagode	,

[eric@localhost Backup]$ pwd
/home/eric/Devel/Postgres/Backup
$ PGPASSWORD='h^Zgcyr&Q'  pg_dump -U vanderveldene -Fc -h pnl-app-a.intermax.mp-objects.com pnltms> pnl-app-a_pnltms.dump

pnllogistics2=# create database pnltms;
CREATE DATABASE
[eric@localhost Backup]$ PGPASSWORD=mpopostgres@mpo pg_restore -U mpopostgres -d  pnltms pnl-app-a_pnltms.dump

$ vi application.properties
base.product=pnltms

[eric@localhost server]$ cp -a pnllogistics/ pnltms
$ cd pnltms/deploy
[eric@localhost deploy]$ vi postgres-ds.xml
...
[eric@localhost deploy]$ mv pnllogistics-schedule-service.xml pnltms-schedule-service.xml 
$ vi pntms-schedule-service.xml
<server>
    <mbean code="org.jboss.varia.scheduler.Scheduler" name=":service=PnlTmsInterfaces">
        <attribute name="SchedulableArguments">ejb/PnlTmsInterfaceRunnerFacade,all-admin,admin123@MPO</attribute>
...

PNL-TMS-AB
PNL-TMS-GEN
user.locale.code en_GB_pnltms
never.expires true





/ Einde PAT-152

/ PCT DATABASE COPY VAN ACCEPTANCE TO TEST

[eric@localhost Backup]$ PGPASSWORD='h^Zgcyr&Q'  pg_dump -U vanderveldene -Fc -h pnl-app-a.intermax.mp-objects.com pnllogistics> pnl-app-a_pnllogistics-$(date +"%y-%m-%d").dump
[eric@localhost Backup]$ PGPASSWORD='h^Zgcyr&Q'  pg_dump -U vanderveldene -Fc -h pnl-app-t.intermax.mp-objects.com pnllogistics> pnl-app-t_pnllogistics-$(date +"%y-%m-%d").dump
[eric@localhost Backup]$ ls -ltrh
-rw-rw-r--. 1 eric     eric      15M Aug  4 11:14 pnl-app-a_pnllogistics-15-08-04.dump
-rw-rw-r--. 1 eric     eric      62M Aug  4 11:17 pnl-app-t_pnllogistics-15-08-04.dump

/ 13	. 

[eric@localhost Backup]$ pnl-ssh-t.sh  
[vanderveldene@pnl-app-t ~]$ sudo su - jboss
[jboss@pnl-app-t ~]$ pnllogistics  stop

/ 13	 .

/ we lezen op	, 
https://system.mp-objects.com/xwiki/bin/view/Technology/PostgreSQL

[eric@localhost Backup]$ PGPASSWORD='h^Zgcyr&Q'  psql -U vanderveldene  -h pnl-app-t.intermax.mp-objects.com -d pnllogistics <<EOFalter schema public rename to public_old;
create schema public;
EOF
ERROR:  must be owner of schema public
ERROR:  permission denied for database pnllogistics
/ TODO
/ SENT EMAIL TO PRODUCTION

/ Nu werkt wel, als we inlog op pnl-app-t zelf	,
[vanderveldene@pnl-app-t ~]$ PGPASSWORD=90trKR3ZUtORXgNQnLJR  psql -U pnllogistics -h localhost pnllogistics <<EOF
alter schema public__old rename to public_old;
EOF

ALTER SCHEMA



/ 13.	 

[eric@localhost Backup]$ PGPASSWORD=mpopostgres@mpo pg_restore -U mpopostgres -h pnl-app-t.intermax.mp-objects.com -d pnllogistics pnl-app-t_pnllogistics-$(date +"%y-%m-%d").dump
/ TODO (Hebben we niet kunnen doen)	, 


/ Einde PCT DATABASE COPY VAN ACCEPTANCE TO TEST

/ IMPORT XML

/ MORGEN 
Executions -> Actions

/ Einde IMPORT XML

/ SAMENVATTING CREATE SHIPMENTORDER

/ Kies	,
planning, shipment order, create
/ dit is shipment-order-template_list

/ click filter of enter 	, we krijgen list van shipment order templates	,

/ we kiezen het template 'cons_test_gse'	, 

/ we zien 
Status 1404 OPEN

/ we passen velden aan	,

/ in Shipment order details
Shipment order: SH000002979
Actual productcode: 3610
Req start after: <tomorrow> 8:00					/= from client (waarvan afgehaald wordt)
Req start before: <tomorrow> 18:00
Req end after: <day after tomorrow> 8:00			/= to other client ( waarnaar geleverd wordt)	,
Req end before: <day after tomorrow> 18:00			
Requested Productcode: 3610				/ = Actual productcode	,
Customer Reference: test create shipment order		/ bijv	, elke string is OK	,

/ In Ship from
Address: xxx
house number : 7
/ In Ship to 
Address: xxx
house number : 7
/ Als we deze NIET invullen, niet echt heel erg: als we de sho save, 	dan zien we ADDRESS_HOLD	, dus kunnen we deze addresses alsnog invullen	,

Save

/ de status is nog steeds 1404, OPEN	,
/ we zien in Shipment order details, Hold Status: COLLO_HOLD	, 
/ clear Hold Status, en 	, 

/ create shipment item	,
Unit type : C
PostNL Reference: 3seve15082401 	/= 3s + eve+ 150824 + 01 = 3s+ <my name> + <date> + <number>
weight:1.00

Save shipment item	, 


Save (shipment order) 
/ Nu is hij ingeplanned	,

/ we zien	,
Status 1450
	PLANNED

/ we zien de sa's	, 

COLLECT  
From : constst frm - Schiedam - NL	, 
To: DOR - Depot Dordrecht - Dordrecht - NL
Requested start: 25 aug 2015
Pln. Start date	: 25 aug 2015				
Actual start	
Req. End (after): 26 aug 2015					/ TODO
Pln. End date:	25 aug 2015	
Actual end	
Status: 1450	
Consignment N0004873.1	
Executed by: Baris Cargo Service 

LINEHAUL
From : DOR - Depot Dordrecht - Dordrecht - NL 
To:EHV - Depot Eindhoven - Eindhoven - NL 
Requested start: 25 aug 2015
Pln. Start date	: 25 aug 2015				
Actual start	
Req. End (after): 26 aug 2015					/ TODO
Pln. End date:	25 aug 2015	
Actual end	
Status: 1450	
Consignment N0004874.1	
Executed by: Baris Cargo Service 

DELIVERY
From : EHV - Depot Eindhoven - Eindhoven - NL 
To: constst to - Eindhoven - NL
Requested start: 25-Aug-2015					/ TODO
Pln. Start date	: 26 aug 2015				
Actual start	
Req. End (after): 26 aug 2015					
Pln. End date:	26 aug 2015	
Actual end	
Status: 1450	
Consignment N0004877.1	
Executed by: Ritmo Logistics 

DELIVERY NOTE
From : EHV - Depot Eindhoven - Eindhoven - NL 
To: constst to - Eindhoven - NL
Requested start: 25-Aug-2015					/ TODO
Pln. Start date	: 26 aug 2015				
Actual start	
Req. End (after): 26 aug 2015					
Pln. End date:	26 aug 2015	
Actual end	
Status: 1450	
Consignment N0004878.1	
Executed by: Ritmo Logistics 

/ 7	. 

/ we maken 2 sho's	,
SH000002980
SH000002981
/ beide 3610	, dezelfde 2 time windows (req start, req end)	, dus 4 date times	,  
Save

/ we maken voor beide dezefde shi (TOD dit hoeft WH niet)	, unit type C	, andere barcode (PostNL reference)	, en weight 1.0, 	Save shipment order

Save beide sho's nog een keer	, 

/ we zien voor elk 4 sa's	: collect, 	linehaul, delivery, delivery note	,
/ we zien dat beide sho's consolidate in elke 

pnllogistics3=# select sa. system_id,sat.service_action_type,con.consignment_number from service_action sa join shipment_order sho on sa.shipment_order_systemid=sho.system_id join consignment con on sa. consignment_systemid=con.system_id join service_action_type sat on sa.service_action_type_systemid=sat.system_id where sho.shipment_order_id='SH000002980';
 system_id | service_action_type | consignment_number 
-----------+---------------------+--------------------
  26846522 | DELIVERY            | N0004882.1
  26846523 | DELIVERY_NOTE       | N0004881.1
  26846521 | LINEHAUL            | N0004880.1
  26846520 | COLLECT             | N0004879.1
(4 rows)

pnllogistics3=# select sa. system_id,sat.service_action_type,con.consignment_number from service_action sa join shipment_order sho on sa.shipment_order_systemid=sho.system_id join consignment con on sa. consignment_systemid=con.system_id join service_action_type sat on sa.service_action_type_systemid=sat.system_id where sho.shipment_order_id='SH000002981';
 system_id | service_action_type | consignment_number 
-----------+---------------------+--------------------
  26846527 | DELIVERY_NOTE       | N0004884.1
  26846526 | DELIVERY            | N0004883.1
  26846525 | LINEHAUL            | N0004880.1
  26846524 | COLLECT             | N0004879.1
(4 rows)

/ we zien dat de collect-, linehaul-sa's van beide sho worden consolidate op een (dezelfde) consignment	, maar de delivery NIET	, en de delivery note ook niet , maar dat is logisch	,

/ 7	. 

/ 24 dec 2015

https://test-pnl.mp-objects.com/pnllogistics/core/index_frameset

/ planning, sho, create
/ kies template rt/rt gerard	, click create order	,

/ geef 
Requested Productcode: 3610
Customer reference: eric
Save
/ Hij is OPEN (1404)

/ create een shi	,
Unit type: C
Save Shipment item

Save (sho)
/ Hij is PLANNED (1450)



/ Einde SAMENVATTING CREATE SHIPMENTORDER

/ DEBUG CREATE SHIPMENT ORDER

/ 7	. 

planning, shipment order, create	,
shipment-order-template_list

$ vi oms-sitemap.xmap 
			<map:match pattern="shipment-order-template_list">
				<map:call resource="dynatablePage">
					<map:parameter name="xsp" value="xsp/shipment-order-template_list.xml"/>
					<map:parameter name="xsl" value="xsl/shipment-order-template_list.xsl"/>
				</map:call>
			</map:match>

$ vi shipment-order-template_list.xml

    </xsp:logic>
    <dynatable:initialize name="shipment-order-template">
        <xsp:logic>
        	
            // Dynamic query
            myTable.setQuery(
            "SELECT * FROM SHIPMENT_ORDER " +
            "WHERE IS_TEMPLATE = 1 AND IS_DELETED = 0 AND ORGANIZATION_SYSTEMID IN {USER_ORGANIZATIONS} " +
            "-#1 AND FROM_COUNTRY_SYSTEMID IN (SELECT SYSTEM_ID FROM COUNTRY WHERE ?)#-" +
            "-#2 AND TO_COUNTRY_SYSTEMID IN (SELECT SYSTEM_ID FROM COUNTRY WHERE ?)#-"+
            "-#3 AND ORGANIZATION_SYSTEMID IN (SELECT SYSTEM_ID FROM ORGANIZATION WHERE ?)#-" + 
            "-#4 AND ORDER_PROCESS_SYSTEMID IN (SELECT SYSTEM_ID FROM ORDER_PROCESS WHERE ?)#-" +
            "-#5 AND ACT_SERVICE_LEVEL_SYSTEMID IN (SELECT SYSTEM_ID FROM SHIPMENT_SERVICE_LEVEL WHERE ?)#-"
            ,
           	myMaxResult
            );

   <dynatable:populate>
        <xsp:logic>

			ShipmentOrderView myView = new ShipmentOrderView();
            Collection myList = myView.executeDynaQuery(myTable.getDynaQuery());
			...

   <filter-param name="shipment-order-create-url" defaultValue="shipment-order_create"/>
    <xsp:logic>
            myShipmentOrderCreateURL = request.getParameter("shipment-order-create-url");
                myShipmentOrderCreateURL = "shipment-order_create";
    </xsp:logic>
    <actions>
        <shipment-order-create-url><xsp:expr>myShipmentOrderCreateURL</xsp:expr></shipment-order-create-url>
    </actions>

$ vi ShipmentOrderView.java

	public Collection executeDynaQuery(DynaQuery aQuery) throws AbstractException {
			return getDao().executeDynaQuery(aQuery);

$ vi ShipmentOrderDaoImpl.java
	public List<ShipmentOrderVO> executeDynaQuery(DynaQuery aQuery) throws ShipmentOrderException {
		String mySql = aQuery.toSQL();
/ WH Deze parses de query	, met die #'s	,

$ vi DynaQuery.java
	/** Creates the SQL statement dynamically */
	public String toSQL() {
		...

/ de links zien we in 	,

$ vi shipment-order-template_list.xsl

           <a> 
            <xsl:attribute name="href"><xsl:text>shipment-order-template_copy?systemid=</xsl:text><xsl:value-of select="./column[@name='SYSTEMID']"/><xsl:text>&amp;base_sessionLevelOffset=1</xsl:text>
            </xsl:attribute><i18n:text>copy</i18n:text> </a>
        
                <a > 
                <xsl:attribute name="href">
                    <xsl:text>shipment-order-template_edit?systemid=</xsl:text><xsl:value-of select="./column[@name='SYSTEMID']"/><xsl:text>&amp;base_sessionLevelOffset=1</xsl:text>
                </xsl:attribute><i18n:text>edit</i18n:text> </a>

                <a > 
                <xsl:attribute name="href">
                    <xsl:text>shipment-order-template_delete?systemid=</xsl:text><xsl:value-of select="./column[@name='SYSTEMID']"/><xsl:text>&amp;base_sessionLevelOffset=1</xsl:text>
                </xsl:attribute><i18n:text>delete</i18n:text> </a>
            </td>

            <a > 
            <xsl:attribute name="href"><xsl:value-of select="//shipment-order-create-url"></xsl:value-of><xsl:text>?systemid=</xsl:text><xsl:value-of 
                select="./column[@name='SYSTEMID']"/><xsl:text>&amp;base_sessionLevelOffset=1</xsl:text>
            </xsl:attribute><i18n:text>create.shipment.order</i18n:text> </a>

/ De buttons onderin	,

    <xsl:template name="custom_footer">
        <p> 
        <button type="button">
        	<xsl:attribute name="onclick"> 
            	<xsl:text>location.href='shipment-order-template_create?systemid=0&amp;base_sessionLevelOffset=1'</xsl:text>
            </xsl:attribute>
            <i18n:text>create.new.template</i18n:text>
        </button>&#160;&#160;     

         <button type="button">
         	<xsl:attribute name="onclick">
         		<xsl:text>location.href='</xsl:text>
         		<xsl:value-of select="//shipment-order-create-url"></xsl:value-of>
         		<xsl:text>?systemid=0&amp;base_sessionLevelOffset=1'</xsl:text>
         	</xsl:attribute>
         	<i18n:text>create.new.order</i18n:text>
         </button>
         </p>
    </xsl:template>
    <xsl:template match="process-type"/>
</x

/ we zien dus in xsl	,
            <xsl:value-of select="//shipment-order-create-url"></xsl:value-of>
/ en in xml	,
	...
/ TODO

/ we zien in HTML bij 'Create order'	, shipment-order_create	,

	
/ 7	.

$ vi oms-sitemap.xmap

			<map:match pattern="shipment-order_create">
				<map:act type="shipmentOrderCreate"/>
				<map:select type="session-attribute">
					<map:parameter name="attribute-name" value="builder"/>
					<map:when test="jsp">
						<map:read mime-type="text/html" type="jsp" src="jsp/shipment-order_edit.jsp"/>
					</map:when>
					<map:otherwise>
						<map:redirect-to uri="../wicket?module=oms&amp;wicketpage=shipmentorder.edit.ShipmentOrderEditSelectionPage"/>
					</map:otherwise>			
				</map:select>
			</map:match>

/ we click 'Create order'	, 
/s
ShipmentOrderCreateAction.act() line: 44	
		int mySystemId = getSystemIdFromRequest();
26682849
/ Dit is de id van de template die we gekozen hebben	, dit is een shipment order	,
pnllogistics3=# select is_template from shipment_order where system_id=26682849;
 is_template 
-------------
           1
(1 row)


/ Intermezzo

/ 7	.

/ een shipment order template is een shipment order met is_template=1	,

$ vi ShipmentOrderTemplateCreateAction.java

public class ShipmentOrderTemplateCreateAction extends AbstractAction {

	@Override
	public Map act() throws java.lang.Exception {

		int mySystemId = getSystemIdFromRequest();
		ShipmentOrderVO myVO = MpoBeanFactory.getBean(ShipmentOrderService.class).create(myOriginal, true);
/ WH myOriginal=null
/s
	@Override
	public ShipmentOrderVO create(ShipmentOrderVO aShipmentOrderTemplate, boolean isTemplate) {
		if (aShipmentOrderTemplate == null) {
/ NEE
		} else {
			myVO = aShipmentOrderTemplate.copy();

/ 7	.

/ In welke columns in de shipment_order table komt het woord template voor	?

[eric@localhost LOGS]$ grep template <(PGPASSWORD=mpopostgres@mpo psql -U mpopostgres pnllogistics3  <<SQL
\d shipment_order
SQL)
 is_template                    | smallint                    | 
 template_systemid              | integer                     | 
 approval_template              | character varying(30)       | 
    "sho_template_idx" btree (template_systemid)
    "so_is_template" btree (is_template)
    "so_shipm_is_template" btree (order_process_systemid, is_template)
    "so_path_fk" FOREIGN KEY (path_systemid) REFERENCES path_template(system_id)
    TABLE "inv_product_item_template" CONSTRAINT "fk_inv_product_item_sho" FOREIGN KEY (sho_template_systemid) REFERENCES shipment_order(system_id)

/ we zochten: is_template	,

/ 7	.

pnllogistics3=# SELECT column_name
FROM information_schema.columns 
where table_name ='shipment_order' 
and column_name like '%template%';
    column_name    
-------------------
 is_template
 template_systemid
 approval_template
(3 rows)

/ Einde Intermezzo

/ 7	.

/ we click 'Create order' op Shipment Order Template scherm	,
/s
ShipmentOrderCreateAction.act() line: 44	
		int mySystemId = getSystemIdFromRequest();
26770507
/ Het cons_test_gse template,
			myTemplate = MpoBeanFactory.getBean(ShipmentOrderDao.class).getBySystemId(mySystemId);
		ShipmentOrderVO myVO = MpoBeanFactory.getBean(ShipmentOrderService.class).create(myTemplate);
/s
ShipmentOrderServiceImpl.create(ShipmentOrderVO, boolean) line: 554	
aShipmentOrderTemplate	ShipmentOrderVO  (id=20153)	
isTemplate	false	
		if (aShipmentOrderTemplate == null) {
/ NEE
		} else {
			myVO = aShipmentOrderTemplate.copy();
/s
ShipmentOrderVO.copy() line: 413	
			ShipmentOrderVO myVO = ShipmentOrderVOFactory.getShipmentOrderVO();
/ new
			copyTo(myVO);
/ this =de template sho	, 
this
	theTemplateFlag	true

/ Intermezzo

$ vi ShipmentOrder.standard.hbm.xml
		<property name="template" column="IS_TEMPLATE" not-null="true" />

$ vi ShipmentOrderVO.java
	public boolean isTemplate() {
		return theTemplateFlag;
	}

/ Einde Intermezzo

/s
	public void copyTo(ShipmentOrderVO aTargetShipmentOrderVO) {
		ShipmentOrderVO myVO = aTargetShipmentOrderVO;
		super.copyTo(myVO);
/s
ShipmentOrderVO(LogisticsOrderVO).copyTo(LogisticsOrderVO) line: 1087	
		super.copyTo(aVO);
/s
ShipmentOrderVO(ResourceProtectedValueObject).copyTo(ResourceProtectedValueObject) line: 65	
		super.copyTo(aVO);
/s
ShipmentOrderVO(UniqueFieldValueObjectImpl).copyTo(UniqueFieldValueObjectImpl) line: 25	
		super.copyTo(aVO);
/s
ShipmentOrderVO(ValueObject).copyTo(ValueObject) line: 282	
		aVO.setSystemId(getSystemId());
/ de system_id van de template sho	,
...
t
ShipmentOrderVO(ResourceProtectedValueObject).copyTo(ResourceProtectedValueObject) line: 65	
		super.copyTo(aVO);
/d
		if (organization != null) {
PNL-CARGO
			aVO.setOrganization(getOrganization());
/t
ShipmentOrderVO(LogisticsOrderVO).copyTo(LogisticsOrderVO) line: 1087	
this.theTemplateFlag==true	,
		super.copyTo(aVO);
/d
		this.updateTo(aVO);
/s
ShipmentOrderVO(LogisticsOrderVO).updateTo(LogisticsOrderVO) line: 1260	
		super.updateTo(aVO);
/s
ShipmentOrderVO(EntityDetailSupport).updateTo(LogisticsOrderVO) line: 304	
		for (Entry<EntityDetailType, String> entry : getEntityDetails().entrySet()) {
/ GEEN
/t
ShipmentOrderVO(LogisticsOrderVO).updateTo(LogisticsOrderVO) line: 1261	
		super.updateTo(aVO);
/d
		aVO.setOrderStatusVO(theOrderStatusVO);
OrderStatus:1404 (systemId:6)							/ OPEN
...
		if (theToPartyVO != null) {
/ JA
			aVO.setToPartyVO(new VirtualParty(theToPartyVO));
this.theTemplateFlag==true	,
this.theToPartyVO	VirtualParty  (id=24097)	
/ als we het template edit	, zien we de parties	,

/ Intermezzo

pnllogistics3=# select*from shipment_order where shipment_order_id='cons_test_gse';

  26770507 |           1 | cons_test_gse     |               26681860 |                   26766188 |                    6 |         
          500 |            1006746 |               |                | constst to |          |            |             | Eindhoven |
 5626gh         |                 |                4153 |                 |               |                  |                 |    
              | constst frm |            |              |               | Schiedam  | 3012cn           |                   |        
          4153 |                   |                 |                    |                   |                      | 9148459      
    | Gildewerk B.V. |               | Jan van Geunsweg 10A |                  | HAARLEM      | 2031BD              |               
       |                     4153 | 023-5322255          | 023-5340965        |                       | Maarten Theunissen   | 2015-
05-08 16:04:41.696    | 2015-05-08 16:04:41.696   |                          |                         |                            
  |                             | 2015-05-09 16:04:41.696  | 2015-05-09 16:04:41.696 |                        |                     
  |                            |                           |                  |                |            26680352 | 2015-05-08 16
:06:40.405 |                            |                          |                             |                           |      
              |          |                       |     


/ to_name='constst to'
/ from_name='constst frm'
/ invoice_party_id=9148459		/ billto virtual party heet invoice_  in een sho	,

/ Einde Intermezzo


PARTY id:(systemId:0)
this=template	,
this.theFromPartyVO.systemId=0
/ TODO
		if (theFromPartyVO != null) {
			aVO.setFromPartyVO(new VirtualParty(theFromPartyVO));
PARTY id:(systemId:0)

		if (getDateSetVO() == null) {
/ NEE
/=theDateSetVO
RSAFTER: 2015-05-08 16:04:41.696, RSBEFORE: 2015-05-08 16:04:41.696, REAFTER: 2015-05-09 16:04:41.696, REBEFORE: 2015-05-09 16:04:41.696, PSAFTER: null, PSBEFORE: null, PEAFTER: null, PEBEFORE: null, AS: null, AE: null, RELEASE:null, PRELEASE:null, CLOSE:null

/ Intermezzo

pnllogistics3=# select REQUESTED_ARRIVAL_AFTER from shipment_order where shipment_order_id='cons_test_gse';
 requested_arrival_after 
-------------------------
 2015-05-09 16:04:41.696
(1 row)

pnllogistics3=# select REQUESTED_ARRIVAL_before from shipment_order where shipment_order_id='cons_test_gse';
 requested_arrival_before 
--------------------------
 2015-05-09 16:04:41.696
(1 row)

pnllogistics3=# select REQUESTED_departure_before from shipment_order where shipment_order_id='cons_test_gse';
 requested_departure_before 
----------------------------
 2015-05-08 16:04:41.696
(1 row)

pnllogistics3=# select REQUESTED_departure_after from shipment_order where shipment_order_id='cons_test_gse';
 requested_departure_after 
---------------------------
 2015-05-08 16:04:41.696
(1 row)

/ Deze data zien we in de date picker	,

/ Einde Intermezzo

		} else {
			aVO.setDateSetVO(getDateSetVO().deepClone());

/ aVO is de target sho	, die we met new hebben create	, this is de template sho	,

		aVO.setHoldStatus(theHoldStatus);
null
		aVO.setAdditionalInformationMap(getAdditionalInformationMap());
{}
		aVO.setPayWeight(getPayWeight());
null
		aVO.setPrice(getPrice());
null
		aVO.setTemporary(isTemporary());
false
		aVO.setEmission(getEmission());
null
		cloneTotals(aVO);
/s
ShipmentOrderVO(LogisticsOrderVO).cloneTotals(LogisticsOrderVO) line: 210	
this='cons_tst_gse'	, de tpl	,
			boolean myOrigRecalculate = shouldRecalculate();
/=
		return theRecalculateFlag;
false
			setRecalculate(false);
this='cons_tst_gse'	, de tpl	,
/s
		theRecalculateFlag = aRecalculate;
		theRecalculateActualsFlag = aRecalculate;

			aLogisticsOrderVO.setRecalculate(false);
aLogisticsOrderVO=target sho	, 
/s
		theRecalculateFlag = aRecalculate;
		theRecalculateActualsFlag = aRecalculate;

			aLogisticsOrderVO.setRequestedTotalColli(getRequestedTotalColli());
null
			aLogisticsOrderVO.setRequestedTotalWeightKg(getRequestedTotalWeightKg());
			aLogisticsOrderVO.setRequestedTotalVolumeM3(getRequestedTotalVolumeM3());
			aLogisticsOrderVO.setRequestedTotalLoadingMeters(getRequestedTotalLoadingMeters());
			aLogisticsOrderVO.setRequestedAltTotalValue(getRequestedAltTotalValue());
			aLogisticsOrderVO.setRequestedTotalItems(getRequestedTotalItems());
			aLogisticsOrderVO.setRequestedTotalValue(getRequestedTotalValue());

			setRecalculate(myOrigRecalculate);
false
			aLogisticsOrderVO.setRecalculate(myOrigRecalculate);
false
/t
ShipmentOrderVO(LogisticsOrderVO).updateTo(LogisticsOrderVO) line: 1282	
		cloneTotals(aVO);
/d
		aVO.setLockPrecalculation(isLockPrecalculation());
		aVO.setApprovedBy(getApprovedBy());
null
		aVO.setApprovedOnDate(getApprovedOnDate());
		aVO.setApprovePrecalculation(isApprovePrecalculation());
		aVO.setRatecalcMd5Hash(getRatecalcMd5Hash());
/t
ShipmentOrderVO.copyTo(ShipmentOrderVO) line: 430	
/=
	public void copyTo(ShipmentOrderVO aTargetShipmentOrderVO) {
this=tpl sho	, aTargetShipmentOrderVO=target sho	,
		super.copyTo(myVO);
/d
		myVO.setShipmentOrderId(theShipmentOrderId);
theShipmentOrderId	"cons_test_gse" (id=25847)	
		myVO.setSystemEntryDate(theSystemEntryDate);
theSystemEntryDate	Timestamp  (id=25850)	
2015-05-08 16:06:40.405
/ TODO
		myVO.setOriginalSystemEntryDate(getOriginalSystemEntryDate());
2015-05-08 16:06:40.405
/ TODO
		this.updateTo(myVO);
/s
ShipmentOrderVO.updateTo(ShipmentOrderVO) line: 2627	


this=tpl sho	, myVO=target sho	,

/ Zojuist waren we LogisticsOrder.update	,

		super.updateTo(aTargetShipmentOrderVO);
/ TODO (Zojuist gedaan)	,m
		ShipmentOrderVO myVO = aTargetShipmentOrderVO;
/ de target sho	,
		...
		myVO.setTemplate(theTemplateFlag);
true
...
		if (theBillToParty != null) {
			myVO.setBillToPartyVO(new VirtualParty(getBillToPartyVO()));
this
	theBillToParty	VirtualParty  (id=29655)	
PARTY id:9148459(systemId:0)

		if (theEmployeeResponsibleParty != null) {
			myVO.setEmployeeResponsiblePartyVO(new VirtualParty(getEmployeeResponsiblePartyVO()));
this
	theEmployeeResponsibleParty	VirtualParty  (id=29658)	
PARTY id:(systemId:0)

		myVO.setBillOfLadingNr(billOfLadingNr);
null
		myVO.setRemarks(theRemarks);
""
		myVO.setRemarks2(theRemarks2);
""
		myVO.setPreferedPartyVO(getPreferedPartyVO());
null
		myVO.setShipmentType(getShipmentType());
null
		myVO.setReference1(getReference1());
""
		myVO.setReference2(getReference2());
		myVO.setReference3(getReference3());
		myVO.setReference4(getReference4());
		myVO.setReference5(getReference5());
		myVO.setReference6(getReference6());
		myVO.setReference7(getReference7());
		myVO.setReference8(getReference8());
		myVO.setReference9(getReference9());
		myVO.setReference10(getReference10());
...
/t
ShipmentOrderServiceImpl.create(ShipmentOrderVO, boolean) line: 566	
		} else {
			myVO = aShipmentOrderTemplate.copy();
/d
			copyShipmentOrderParties(aShipmentOrderTemplate, myVO);
/s
ShipmentOrderServiceImpl.copyShipmentOrderParties(ShipmentOrderVO, ShipmentOrderVO) line: 526	
			Collection<ShipmentOrderParty> myShipmentOrderParties = anOriginal.getShipmentOrderParties();
/= theShipmentOrderPartyList
[com.mpobjects.oms.model.entity.shipmentorderparty.ShipmentOrderParty@59158337[shipmentOrder=ShipmentOrder: cons_test_gse(SystemId:26770507; Org:PNL-CARGO),name=,partyTypeGroup=theSystemId: 26681486PartyTypeGroup :DistributionDepot], 
com.mpobjects.oms.model.entity.shipmentorderparty.ShipmentOrderParty@1359bd92[shipmentOrder=ShipmentOrder: cons_test_gse(SystemId:26770507; Org:PNL-CARGO),name=,partyTypeGroup=theSystemId: 26681485PartyTypeGroup :CollectionDepot]]
/ Dit zijn DistributionDepot	, CollectionDepot	, die we zien naast Ship from, Ship to, Bill to	,

				for (ShipmentOrderParty myParty : myShipmentOrderParties) {
					ShipmentOrderParty myNewParty = new ShipmentOrderParty();
					BeanUtils.copyProperties(myNewParty, myParty);
					myNewParty.setSystemId(ValueObject.VOLATILE_SYSTEM_ID);
0
					myNewParty.setShipmentOrder(aNewShipmentOrder);
					aNewShipmentOrder.addShipmentOrderParty(myNewParty);
/t
ShipmentOrderServiceImpl.create(ShipmentOrderVO, boolean) line: 568	
			copyShipmentOrderParties(aShipmentOrderTemplate, myVO);
/d
			EntityDetailUtil.copyCorrespondingEntityDetails(aShipmentOrderTemplate, myVO);
/s
EntityDetailUtil.copyCorrespondingEntityDetails(EntityDetailSupport, EntityDetailSupport) line: 97	
		Map<EntityDetailType, String> myTo = aCopyTo.getEntityDetails();
/=entityDetails
{SystemId:26684153	IsDeleted:false	Detail Type:ProductKenmerkSoort	ValueType:LIST	=,
SystemId:26684152	IsDeleted:false	Detail Type:Goedgekeurd	ValueType:BOOLEAN	=0,
SystemId:26684154	IsDeleted:false	Detail Type:OptieSoort	ValueType:LIST	=,
SystemId:26684149	IsDeleted:false	Detail Type:OntvangenBedragCash	ValueType:AMOUNT	=0 ,
SystemId:26684150	IsDeleted:false	Detail Type:OntvangenBedragPin	ValueType:AMOUNT	=0 ,
SystemId:26734011	IsDeleted:false	Detail Type:EilandToeslag	ValueType:BOOLEAN	=,
SystemId:26684151	IsDeleted:false	Detail Type:Checked	ValueType:BOOLEAN	=0}
/ Deze komen uit het template	,
/ Als we click op Edit ipv Create order in de list van templates,	 dan zie je het template zelf, en onderin zien we 'Extra fields'	,
/t
		for (Entry<EntityDetailType, String> entry : aCopyFrom.getEntityDetails().entrySet()) {
			EntityDetailType myType = entry.getKey();
			if (myTo.containsKey(myType)) {
				myTo.put(myType, entry.getValue());
myType: SystemId:26684151	IsDeleted:false	Detail Type:Checked	ValueType:BOOLEAN	
entry.getValue()="0"
myType: SystemId:26734011	IsDeleted:false	Detail Type:EilandToeslag	ValueType:BOOLEAN	
entry.getValue()=""
myType: SystemId:26684153	IsDeleted:false	Detail Type:ProductKenmerkSoort	ValueType:LIST	
entry.getValue()=""
myType:SystemId:26684154	IsDeleted:false	Detail Type:OptieSoort	ValueType:LIST	
entry.getValue()=""
...

/ Intermezzo

pnllogistics3=# select t.*from shipment_order_detail d join shipment_order sho on d.entity_systemid=sho.system_id join entity_detail_type t on d.edt_systemid=t.system_id  where sho.shipment_order_id='cons_test_gse';
 system_id | is_deleted |        name         | value_type |     entity     | organization_systemid | read_only | config | rank | re
quired | visibility |    allowed_values    | group_systemid 
-----------+------------+---------------------+------------+----------------+-----------------------+-----------+--------+------+---
-------+------------+----------------------+----------------
  26684151 |          0 | Checked             | BOOLEAN    | SHIPMENT_ORDER |                   500 | EDIT      |        |   30 |   
     0 |            |                      |       26682268
  26684152 |          0 | Goedgekeurd         | BOOLEAN    | SHIPMENT_ORDER |                   500 | EDIT      |        |   40 |   
     0 |            |                      |       26682268
  26684153 |          0 | ProductKenmerkSoort | LIST       | SHIPMENT_ORDER |                   500 | FALSE     |        |    6 |   
     0 |            | ,118                 |       26682268
  26684154 |          0 | OptieSoort          | LIST       | SHIPMENT_ORDER |                   500 | CREATE    |        |    7 |   
     0 |            | ,007,008,013,999,014 |       26682268
  26684149 |          0 | OntvangenBedragCash | AMOUNT     | SHIPMENT_ORDER |                   500 | EDIT      |        |   10 |   
     0 |            |                      |       26682268
  26684150 |          0 | OntvangenBedragPin  | AMOUNT     | SHIPMENT_ORDER |                   500 | EDIT      |        |   20 |   
     0 | false      |                      |       26682268
  26734011 |          0 | EilandToeslag       | BOOLEAN    | SHIPMENT_ORDER |                   500 | TRUE      | 1      |    0 |   
     0 |            |                      |       26682268
(7 rows)





/ Einde Intermezzo

/t
ShipmentOrderServiceImpl.create(ShipmentOrderVO, boolean) line: 569	
			EntityDetailUtil.copyCorrespondingEntityDetails(aShipmentOrderTemplate, myVO);
/d
/ Nu hebben de orig sho en target sho nog dezelfde system_id en shipment_order_id	,

			myVO.setSystemId(ValueObject.VOLATILE_SYSTEM_ID);
0
			myVO.setShipmentOrderId("");
			myVO.setShipmentOrderTemplate(aShipmentOrderTemplate);
			myVO.setTemplate(isTemplate);
false
			if (!myResource.getActivatableOrganizationSystemids().contains(myVO.getOrganization().getSystemId())) {
/ NEE
/ myResource.getActivatableOrganizationSystemids()=[500, 1020, 1010, 1]
/ myVO.getOrganization().getSystemId()=500

		addShipmentOrderParties(myVO);
/s
ShipmentOrderServiceImpl.addShipmentOrderParties(ShipmentOrderVO) line: 288	
			myPartyGroupsToCreate.addAll(MpoBeanFactory.getBean(PartyTypeGroupDAO.class).getShowOnShipmentOrder());
/ alvast antwoord	,
[theSystemId: 26681486PartyTypeGroup :DistributionDepot, theSystemId: 26681485PartyTypeGroup :CollectionDepot]
/s
		DetachedCriteria myDetachedCriteria = DetachedCriteria.forClass(PartyTypeGroupVO.class).add(Property.forName("showOnSho").eq(true)) .add(Property.forName("system").eq(false)).add(Property.forName("deleted").eq(false));
...

/Intermezzo

pnllogistics3=# select*from party_type_group;
 system_id | party_type_group  |                   description                    | is_deleted | show_on_sho | show_on_so | is_syste
m | show_on_co | show_on_col 
-----------+-------------------+--------------------------------------------------+------------+-------------+------------+---------
--+------------+-------------
  26681480 | BILL_TO           | Bill to parties                                  |          0 |           0 |          0 |         
0 |          0 |           0
  26681486 | DistributionDepot | Distribution Depot                               |          0 |           1 |          0 |         
0 |          0 |           0
  26681483 | PREFERRED_PARTY   | Preferred party                                  |          0 |           0 |          0 |         
0 |          0 |           0
  26681484 | SERVICE_PROVIDER  | Service provider                                 |          0 |           0 |          0 |         
0 |          0 |           0
  26681560 | COLLECTION_DEPOT  | Collection Depot                                 |          1 |           1 |          0 |         
0 |          0 |           0
  26681482 | DELIVERY          | Ship to                                          |          0 |           0 |          0 |         
0 |          0 |           0
  26822037 | ACTIVATION        | Customers that need an acivation before planning |          0 |           0 |          0 |         
0 |          0 |           0
  26822149 | DROP-OFF          | Customers that bring their cargo to a depot.     |          0 |           0 |          0 |         
0 |          0 |           0
  26681485 | CollectionDepot   | Collection depot                                 |          0 |           1 |          0 |         
0 |          0 |           0
  26681481 | COLLECTION        | Ship from                                        |          0 |           0 |          0 |         
0 |          0 |           0
(10 rows)

  26681560 | COLLECTION_DEPOT  | Collection Depot                                 |          1 |           1 |          0 |         
0 |          0 |           0
/ is deleted	,

/Einde Intermezzo

			for (ShipmentOrderParty myParty : aShipmentOrder.getShipmentOrderParties()) {
[com.mpobjects.oms.model.entity.shipmentorderparty.ShipmentOrderParty@66d87fa9[shipmentOrder=ShipmentOrder: (SystemId:0; Org:PNL-CARGO),name=,partyTypeGroup=theSystemId: 26681486PartyTypeGroup :DistributionDepot], 
com.mpobjects.oms.model.entity.shipmentorderparty.ShipmentOrderParty@4681984b[shipmentOrder=ShipmentOrder: (SystemId:0; Org:PNL-CARGO),name=,partyTypeGroup=theSystemId: 26681485PartyTypeGroup :CollectionDepot]]
				PartyTypeGroupVO myPartyTypeGroupVO = myParty.getPartyTypeGroup();
				myPartyGroupsToCreate.remove(myPartyTypeGroupVO);
[]
/ Dus we hoeven geen shipment order parties te create	, 
/t
ShipmentOrderServiceImpl.create(ShipmentOrderVO, boolean) line: 599	
		addShipmentOrderParties(myVO);
/d
		MpoBeanFactory.getBean(EntityDetailService.class).initialize(myVO);


/ HIER HIER HIER








/ 7	. 

/ we vullen in	,

Shipment Order: SH000002980							/moeten zelf geven	,
Actual Productcode: 3610
Requested Productcode: 3610
Req. Start (After): <tomorrow> 08:04
Requested Start Before: <tomorrow> 08:04	
Req. End (After): 	<day after tomorrow> 08:04
Req. End (Before): <day after tomorrow> 08:04
Customer Reference: test create shipment order

/ Save
/= shipment-order_save

/ Zonet clickten we op 'Create Order'	, op een template	, doet : new 	, copy template fields in de new	,

/ Intermezzo

$ vi oms-sitemap.xmap

			<map:action logger="shipmentorder" name="shipmentOrderSave" src="com.mpobjects.oms.control.shipmentorder.action.ShipmentOrderSaveAction"/>
           <map:match pattern="shipment-order_save">
                <!-- The shipment order is saved and via redirection send to the correct page -->
				<map:act type="shipmentOrderSave">
                    <map:parameter name="isSave" value="true"/>
                </map:act>
                <!-- This part is only reached when the path selection is manual (see ShipmentOrderSave.shouldTakeControl()-->
                <map:act type="pathMatchAction"/>
                <map:act type="redirectAfterSave">
					<map:parameter name="redirectTo" value="path-template_list-for-shipment-order?refresh=true&amp;manuallyAssign={request-param:manuallyAssign}&amp;base_sessionLevelOffset=1"/>
				</map:act>
            </map:match>

/ Einde Intermezzo

/s

/ HIER HIER HIER













            



/ Einde DEBUG CREATE SHIPMENT ORDER
