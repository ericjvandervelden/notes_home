
/ PCT-449

/ 13	. 

/ config, finance, service management, service agreements(admin)
$ vi ratecalc-sitemap.xmap
			<map:match pattern="rate_agreement_list">			
				<map:act type="rateAgreementList"/>
				<map:generate label="xmlContent" type="serverpages" src="xsp/rate-agreement-list.xml">
					<map:parameter value="true" name="parameters"/>
				</map:generate>
				<map:call resource="dynatable-styler"/>
			</map:match>

$ vi rate-agreement-list.xsl
    <xsl:import href="../../core/xsl/generic-dynatablepage.xsl"/>

$ vi /generic-dynatablepage.xsl
	<xsl:import href="generic-search.xsl" />
				<script type="text/javascript" src="../script/dynatable.js"></script>

$ vi generic-search.xsl
            <form name="filterform" id="filterform" action="filter" target="_self" method="post">
                <input type="hidden" name="column" id="column"/>
                <td class="button">
                   <button  type="button" class="icon_filter small" href="#" onclick="javascript:filter();">
                    </button>
                    <button type="button" class="icon_filter_clear small" href="#" onclick="javascript:resetFilter();">
                    </button>
                    <xsl:choose>
                        <xsl:when test="$no-refresh='true'">                   
                        </xsl:when>
                        <xsl:otherwise>
                            <xsl:text> </xsl:text>
                            <button type="button" class="icon_refresh small" href="#" onclick="javascript:refresh();">
                            </button>
                        </xsl:otherwise>
                    </xsl:choose>
                    <button type="button" href="#" class="icon_excel small" onclick="javascript:downloadExcel();">
                    </button>                    
            </form>


/ Deze zien we onder Filter op bijna elke page	,
<tr class="search">
	<form method="post" target="_self" action="filter" id="filterform" name="filterform" _lpchecked="1"></form>
	<input id="column" name="column" type="hidden">
	<td class="button">
		<input value="filter" id="do" name="do" type="hidden">
		<input value="0" id="base_sessionLevelOffset" name="base_sessionLevelOffset" type="hidden">
		<input value="true" id="is_search_header_request" name="is_search_header_request" type="hidden">
		<input id="usePaginator" name="usePaginator" type="hidden" value="true">
		<input type="hidden" id="screenId" name="screenId" value="rateagreement_list">
		<input id="selectBox" name="selectBox" type="hidden" value="null;">
		<button onclick="javascript:filter();" href="#" class="icon_filter small" type="button"> </button>
		<button onclick="javascript:resetFilter();" href="#" class="icon_filter_clear small" type="button"> </button> 
		<button onclick="javascript:refresh();" href="#" class="icon_refresh small" type="button"> </button>
		<button onclick="javascript:downloadExcel();" class="icon_excel small" href="#" type="button"> </button>
	</td>
	<td>
	<input type="text" size="7" name="filter_1" value="sho" onkeypress="return filterFieldKeyPress(event);" style="cursor: auto; background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABHklEQVQ4EaVTO26DQBD1ohQWaS2lg9JybZ+AK7hNwx2oIoVf4UPQ0Lj1FdKktevIpel8AKNUkDcWMxpgSaIEaTVv3sx7uztiTdu2s/98DywOw3Dued4Who/M2aIx5lZV1aEsy0+qiwHELyi+Ytl0PQ69SxAxkWIA4RMRTdNsKE59juMcuZd6xIAFeZ6fGCdJ8kY4y7KAuTRNGd7jyEBXsdOPE3a0QGPsniOnnYMO67LgSQN9T41F2QGrQRRFCwyzoIF2qyBuKKbcOgPXdVeY9rMWgNsjf9ccYesJhk3f5dYT1HX9gR0LLQR30TnjkUEcx2uIuS4RnI+aj6sJR0AM8AaumPaM/rRehyWhXqbFAA9kh3/8/NvHxAYGAsZ/il8IalkCLBfNVAAAAABJRU5ErkJggg==); background-attachment: scroll; background-position: 100% 50%; background-repeat: no-repeat;">
	</td>
	<td>
	<input type="text" size="7" name="filter_2" value="" onkeypress="return filterFieldKeyPress(event);">
	</td>
	<td>
	<input type="text" size="7" name="filter_3" value="" onkeypress="return filterFieldKeyPress(event);">
	</td>
	<td>
	<input type="text" size="7" name="filter_4" value="" onkeypress="return filterFieldKeyPress(event);">
	</td>
	<td>
	<input type="text" size="7" name="filter_5" value="" onkeypress="return filterFieldKeyPress(event);">
	</td>
	
</tr>
/ Dit is wat we onder Filters zien: de 4 inputs + hidden fields	,
/ We zien toch een form	, de action van de form wordt door js hieronder edit	,

/ geef in devtools ctlr+shift+f	, en geef filter	,
$ vi scrips/dynatable.js
function filter(){
 ->  myAddress = getLocation();

/ we debug	,

	myAddress = getLocation();
myAddress: "http://localhost:8080/tms/ratecalc/rate_agreement_list
   var myDoElement = document.getElementById("do");
/ hidden field	,
   document.filterform.action=myAddress + '?screenId='+getScreenId();
<form method="post" target="_self" action="http://localhost:8080/tms/ratecalc/rate_agreement_list?screenId=rateagreement_list" id="filterform" name="filterform" _lpchecked="1"></form>
       document.filterform.submit();

/ we zien in devtools bij Network	,

Headers
Remote Address:[::1]:8080
Request URL:http://localhost:8080/tms/ratecalc/rate_agreement_list?screenId=rateagreement_list
Request Method:POST
Status Code:200 OK

Request Headers
Accept:text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Encoding:gzip,deflate
Accept-Language:en-US,en;q=0.8
Cache-Control:max-age=0
Connection:keep-alive
Content-Length:193
Content-Type:application/x-www-form-urlencoded
Cookie:visited=yes; JSESSIONID=1llua8yc8hq0d14hmf8vs3f621
Host:localhost:8080
Origin:http://localhost:8080
Referer:http://localhost:8080/tms/ratecalc/rate_agreement_list?screenId=rateagreement_list
User-Agent:Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/38.0.2125.104 Safari/537.36

Query String Parametersview sourceview URL encoded
screenId:rateagreement_list

Form Data
column:
do:filter
base_sessionLevelOffset:0
is_search_header_request:true
usePaginator:true
screenId:rateagreement_list
selectBox:null;;
filter_1:sho
filter_2:
filter_3:
filter_4:
filter_5:

Response
Content-Length:5072
Content-Type:text/html
Date:Fri, 07 Aug 2015 13:58:16 GMT
Server:Apache-Coyote/1.1
X-Cocoon-Version:2.1.10
X-Powered-By:Servlet 2.4; JBoss-4.0.5.GA (build: CVSTag=Branch_4_0 date=200610162339)/Tomcat-5.5

/ TODO (Hoe form data?)

/ 13	. 

/ we geven sho bij Name	, en click filter	,
/ we krijgen 2 rows	, we click edit RA-BUSINESSRULES SHO	,

$ vi ratecalc-sitemap.xmap
			<map:match pattern="rate_agreement_edit">
				<map:act type="rateAgreementEdit"/>
				<map:call function="handleForm">
					<map:parameter name="function" value="rateagreement_edit"/>
					<map:parameter name="form-definition" value="cforms/rateagreement/rate-agreement-form.xml"/>
					<map:parameter name="bindingURI" value="cforms/rateagreement/rate-agreement-binding.xml"/>
				</map:call>
			</map:match>

/ rateagreement_edit is fct in rate-agreement-fs.js	,

/ Kijk naar rate-agreement-form.xml,
[eric@localhost trunk]$ ls ./module/ratecalc/war/ratecalc/cforms/rateagreement/
rate-agreement-binding.xml  
rate-agreement-form.xml  
rate-agreement-fs.js 
rate-agreement-template.xml

$ vi rate-agreement-template.xml

/ Hier zien we alles wat we op de page zien, de rij buttons, de tabs	, ...
/ bijv de rate tables tab en panel	, 

		<ft:form-template method="POST" action="${continuation.id}.continue" name="rateagreementForm">
					<ft:widget id="name">
						<fi:styling maxlength="50" size="50"></fi:styling>
					</ft:widget>
...
/ bovenkant form	, Name	, Reference1	, ...

			<input i18n:attr="value" value="forms:Save" type="submit" onClick="document.rateagreementForm.target_screen.value='Save';"/>
...
/ buttons	, Save, Save and Close, New	, ...

					<fi:group>
						<fi:label>
							<i18n:text i18n:key="ragreement.tab.ratetables">Rate Tables</i18n:text>
						</fi:label>
						<fi:items>
							<cinclude:include src="cocoon:/rate_table_list?refresh=true"/>
						</fi:items>
					</fi:group>
...
/ de tabs	, we zien hier de rate tables tab	, 

/ we zien rate_table_list	,

$ vi ratecalc-sitemap.xmap

			<!--RateTable Pipeline-->
			<map:match pattern="rate_table_list">
				<map:act type="rateTableListForRateAgreement"/>
				<map:call resource="rate-table-list-toXml"/>
				<map:call resource="paginator"/>
				<map:call resource="i18n-styler"/>
				<map:serialize type="html"/>
			</map:match>

		<map:resource name="rate-table-list-toXml">
			<map:generate label="xmlContent" type="serverpages" src="xsp/rate-table-list.xml">
				<map:parameter value="true" name="parameters"/>
			</map:generate>
			<map:transform type="logXml">
				<map:parameter value="form-instance-ratetable.xml" name="file-name"/>
				<map:parameter value="page" name="dom-root-element"/>
			</map:transform>
			<map:transform src="xsl/rate-table-list.xsl"/>
		</map:resource>

$ vi rate-table-list.xsl

	<xsl:template match="row">
		<tr class="list{(position()-1) mod 2}">			
		 <td class="list" width="20">
					<a href="#">
                        <xsl:attribute name="onclick">javascript:submitAndShowRateTable(<xsl:value-of 
                            select="./column[1]/text()"/>,'RateTableCopy');</xsl:attribute>copy</a>
				</td>                
                <td class="list" width="20" align="center">
					<a href="#">
                        <xsl:attribute name="onclick">javascript:submitAndShowRateTable(<xsl:value-of 
                            select="./column[1]/text()"/>,'RateTable',true);</xsl:attribute>
						<img border="0" src="../lookandfeel/styles/images/icons/check24.png">
									</img>
					</a>
				</td>
               <td width="20" align="center">
					<a href="#" >
                        <xsl:attribute name="onclick">javascript:submitAndShowHTMLRateTable(<xsl:value-of 
                            select="./column[1]/text()"/>,<xsl:value-of select="./column[2]/text()"/>);</xsl:attribute>
						<img border="0" src="../lookandfeel/images/icons/lookup.png">
									</img>
					</a>
				</td> 
                <td width="20" align="center">
					<a href="#" >
                        <xsl:attribute name="onclick">javascript:submitAndShowRateTable(<xsl:value-of 
                            select="./column[1]/text()"/>,'RateTableExcelEdit');</xsl:attribute>
						<img border="0" src="../lookandfeel/styles/images/icons/excel.gif">
									</img>
					</a>
				</td> 
			<xsl:apply-templates/>
		</tr>
	</xsl:template>
/ Dit zijn de 4 links op een row in de rate table list	,: copy, edit, ...

/ 13	. 

/ we zien in devtools bij Sources	, als we de ra openen	, 
http://localhost:8080/tms/ratecalc/rate_agreement_edit?base_sessionLevelOffset=1&systemid=26774573&systemId=26774573
/ Logisch, we zijn op de form (zijn aan het edit) van de ra RA-BUSINESSRULES SHO	,

/ in rate-agreement-template.xml staat rate_table_list	, 
	...
	<script language="javascript">
								  function submitAndShowRateTable(aSystemId,aTargetScreen){		
    									submitAndShowRateTable(aSystemId,aTargetScreen,false);
                                    }
/ en	,
$ vi rate-table-list.xsl
		<script language="javascript"><![CDATA[
								  function submitAndShowRateTable(aSystemId,aTargetScreen){		

/ Dit is op een van de buttons in rate table row	, copy, edit	, show html rate table,	 excel	, 
 
/ 13	. 

/ we edit een rate table	,
/ we zien 	,
<a href="#" onclick="javascript:submitAndShowRateTable(26832018,'RateTable',true);">
	<img src="../lookandfeel/styles/images/icons/check24.png" border="0">
</a>  

/ we vallen in JS in	,
http://localhost:8080/tms/ratecalc/rate_agreement_edit?base_sessionLevelOffset=1&systemid=26773867&systemId=26773867
                                    function submitAndShowRateTable(aSystemId,aTargetScreen,aReadOnly){
										 if(aSystemId!=null && aSystemId!=''){
												document.rateagreementForm.ratetableSuffix.value =  '?systemId=' + aSystemId;
                                         if(aReadOnly){
                                            document.rateagreementForm.readonly.value = true;
										 document.rateagreementForm.target_screen.value=aTargetScreen;
									     document.rateagreementForm.submit();		
/ Dit is het hele form	,

/ we click edit op een rate table,	 en we vallen in een script in cocoon's rate_agreement_edit	, 	 NIET in form op cocoon's rate_table_edit	,
/ WH is dit omdat hij inderdaad het hele form (ra form) submit	,

$ vi ratecalc-sitemap.xmap

			<map:match pattern="rate_agreement_save">
				<map:act type="rateAgreementSave"/>
				<map:select type="session-attribute">
					<map:parameter value="target_screen" name="attribute-name"/>
					<map:when test="RateTable">
						<map:redirect-to uri="rate_table_edit{session-attr:ratetableSuffix}"/>
					</map:when>

           <map:match pattern="rate_table_edit">
                <map:act type="rateTableEdit"/>
                <map:call function="handleForm">
                    <map:parameter name="function" value="ratetable_edit"/>
                    <map:parameter name="form-definition" value="cforms/ratetable/rate-table-form.xml"/>
                    <map:parameter name="bindingURI" value="cforms/ratetable/rate-table-binding.xml"/>
                </map:call>
            </map:match>

/ we vallen op server inderdaad in	,
RateAgreementSaveAction.act() line: 28	

/ we zien dat de ra wordt saved	, 
/ maar daarna redirect naar een cocoon cform	, dat zien we in rate_agreement_save hier vlakboven	,
						<map:redirect-to uri="rate_table_edit{session-attr:ratetableSuffix}"/>

/ we geven continue	,
/ we vallen op de server in	,
RateAgreementSaveAction.act() line: 28	

[eric@localhost trunk]$ ls ./module/ratecalc/war/ratecalc/cforms/ratetable
rate-table-binding.xml  
rate-table-edit-table-fs.js  
rate-table-form.xml  
rate-table-fs.js  
rate-table-template.xml

$ vi rate-table-template.xml
					<fi:group>
						<fi:label>Iteration</fi:label>
						<fi:styling layout="columns" />
						<fi:items>
		                    <ft:widget id="iterationEntity">
		                    </ft:widget>
		                    <ft:widget id="iterationAction">
		                    </ft:widget>
		                 </fi:items>
		            </fi:group>

			<input value="Edit" name="target_screen" id="target_screen" type="hidden" />
			<input i18n:attr="value" value="forms:Close" type="submit" onClick="document.ratetableForm.target_screen.value='List';" />			

/ we zien in HTML op de rate table ecit page	,
<form  method="POST" action="624b852b678030168d793f774a3e2847734f2f87.continue"  name="rateTableForm" state="active" onsubmit="forms_onsubmit()">
	<input value="Save and Close" type="submit" onclick="document.ratetableForm.target_screen.value='List';">
	<input value="Cancel" type="submit" onclick="submitCancel(); return false;">
	<input value="Delete" type="submit" onclick="submitDelete(); return false;">

/ bij Save and Close wordt geen JS called, maar de action en onsubmit op het form 	,

$ vi forms-lib.js
	function forms_onsubmit() {
		...

$ vi rate-table-fs.js

function ratetable_edit(form) {
	...
	cocoon.redirectTo("rate_table_save");
}
/ Deze js zien we niet 

$ vi ratecalc-sitemap.xmap

           <map:match pattern="rate_table_save">
                <map:act type="rateTableSave"/>
                <map:select type="session-attribute">
                    <map:parameter value="target_screen" name="attribute-name"/>
                    <map:when test="List">
                        <map:redirect-to uri="rate_agreement_edit?systemId={session-jxpath:active_rateagreement/systemId}"/>
                    </map:when>

/ 13	. 

/ we click Save and Close op een rate table, 	
/ we vallen in	,
RateTableSaveAction.act() line: 32	
/c
RateAgreementEditAction.act() line: 25	
/c
RateTableListForRateAgreementAction(ListAction).act() line: 58	
/c
RateParameterListWithoutRateTableParametersAction(ListAction).act() line: 58	
/c
VariableListAction(ListAction).act() line: 58	
/c
CostComponentSpecificationListAction(ListAction).act() line: 58	
/c
RateAgreementTestListAction(ListAction).act() line: 58	
/c
RateAgreementLogAction(ListAction).act() line: 58	

/ we zien de ra page weer	,

/ Einde PCT-449

/ PCT-449

/ 7	. 


/ als we op een sho Save click	,

RateCalcEventListener.handleEvent(Event) line: 78	
			if (myRecalcExecution.equalsIgnoreCase("auto")) {
/ JA
				recalcServiceOrderCost(anEvent);
			}

			String myPriceExecution = ApplicationPropertyManager.getInstance().getModuleProperty("ratecalc", "shipmentorderprice.ratecalculation.execution");

			if (myPriceExecution.equalsIgnoreCase("auto")) {
				recalcShipOrderPrice(anEvent);
 / TODO
			}

/ maar als we een shipment item Save	, dan 

RateCalcEventListener.handleEvent(Event) line: 78	
			if (myRecalcExecution.equalsIgnoreCase("auto")) {
				recalcServiceOrderCost(anEvent);
/ TODO 
			}

			String myPriceExecution = ApplicationPropertyManager.getInstance().getModuleProperty("ratecalc", "shipmentorderprice.ratecalculation.execution");

			if (myPriceExecution.equalsIgnoreCase("auto")) {
/ JA
				recalcShipOrderPrice(anEvent);
			}

/ 7	. 

/ open SH000002609	,
/ open een shipment item 	,
/ we hebben clic 'Save shipment item'	,

/ See STOP HIER

RateCalcEventListener.handleEvent(Event) line: 78	
			if (myPriceExecution.equalsIgnoreCase("auto")) {
				recalcShipOrderPrice(anEvent);
/s
RateCalcEventListener.recalcShipOrderPrice(Event) line: 95	
			} else if (myType.equals(ShipmentOrderEvent.UPDATED)) {
				ShipmentOrderVO myNewShipmentOrderVO = ((ShipmentOrderEvent) anEvent).getNewShipmentOrderVO();
				recalculate(myNewShipmentOrderVO, AgreementType.SHIPMENT_ORDER, anEvent.getEventContext());
/s
RateCalcEventListener.recalculate(ShipmentOrderVO, AgreementType, TMSEventContext) line: 303	
			getCalculationService().recalculate(anOrder, aRateType, anEventContext);
/s
CalculationServiceImpl.recalculate(LogisticsOrderVO, AgreementType, TMSEventContext) line: 493	
			List<RateAgreementVO> mySelectedRateAgreement = getMatchingRateAgreement(anOrder, aRateType);
/s
CalculationServiceImpl.getMatchingRateAgreement(LogisticsOrderVO, AgreementType) line: 702	
						myKey = "SHO-" + aRateType + aLogisticsOrder.getSystemId();

					Integer[] myInt = (Integer[]) matching_cache.getObject(myKey);
/ In debugger 
myInt=null
/ Daardoor	, 
myResultList=[]
 				myPreselectedList = getRateAgreementList(aRateType);
/ alle ra's 

/ welke ra's match de sho?
			for (RateAgreementVO myRateAgreementVO : myPreselectedList) {
/ 
				if (myResultList.isEmpty() || !myResultList.contains(myRateAgreementVO)) {
					if (myRateAgreementVO.matches(myContext)) {
/ een van de ra's	,
theSystemId: 26774573Name :VT-9831001-2015
Description :Verkooptarief Intertoys
Organization :SystemId:500	Id:PNL-CARGO	Description:PostNL Cargo
Unit :theSystemId: 1000072	Symbol :EUR	Description :Euro	UnitType :CURRENCY	IsDeleted :0	
IsDeleted :false
Type :SHIPMENT_ORDER

/ we zien op de ra in de GUI Selection criteria	, 
Oreder detail		Value from 		Value to		Match type
REQ_END_AFTER		01-Jan-2015		31-dec-2015		RANGE
BILL_TO_PARTY		9831001							REGEX

pnllogistics2=# select*from order_detail where name similar to '%(BILL_TO|REQ_END)%';
 system_id |                                     path_or_class                                      |         name         | unit_systemid | parameter_type_sy
stemid |  entity_type   
-----------+----------------------------------------------------------------------------------------+----------------------+---------------+------------------
-------+----------------
     21955 | ./billToPartyVO/partyId                                                                | BILL_TO_PARTY        |               |                 3
700001 | SHIPMENT_ORDER
700005 | SHIPMENT_ORDER
  26674110 | ./dateSetVO/requestedEndAfter                                                          | REQ_END_AFTER        |       1000536 |                 3
700005 | SHIPMENT_ORDER

/s
RateAgreementVO.matches(JXPathContext) line: 417	
		Collection<RAgreementSelCriterion> myRagreementSelCriteriumList = getRateAgreementSelCriterionList();
/=
		return rateAgreementSelCriterionList;

		for (RAgreementSelCriterion myRagreementSelCriteriumVO : myRagreementSelCriteriumList) {
			if (!myRagreementSelCriteriumVO.matches(aContext)) {
/s
RAgreementSelCriterion.matches(JXPathContext) line: 85	
		Object myValue = getMatchValue(aJXPathContext);
/s
RAgreementSelCriterion.getMatchValue(JXPathContext) line: 151	
		OrderDetail myOrderDetail = getOrderDetail();
SystemId: 21955, Name :BILL_TO_PARTY, PathOrClass :./billToPartyVO/partyId
		Object myValue = myOrderDetail.retrieveValueFromOrder(aJXPathContext);
myValue	"9148459" (id=28623)	

/ Klopt	,
pnllogistics2=# select INVOICE_PARTY_ID from shipment_order where shipment_order_id='SH000002609';
-[ RECORD 1 ]----+--------
invoice_party_id | 9148459

/t
RAgreementSelCriterion.matches(JXPathContext) line: 86	
		Object myValue = getMatchValue(aJXPathContext);
/d
		return matchValue(myValue);
/s
RAgreementSelCriterion.matchValue(Object) line: 103	
		Matcher myMatcher = getMatchTypeName().getMatcher(this);
MatchTypeName.REGEX
myMatcher	RegexMatcher  (id=28756)	
		boolean myResult = myMatcher.match(aValue);
false
/t
RateAgreementVO.matches(JXPathContext) line: 419	
		for (RAgreementSelCriterion myRagreementSelCriteriumVO : myRagreementSelCriteriumList) {
			if (!myRagreementSelCriteriumVO.matches(aContext)) {
				return false;
/t
CalculationServiceImpl.getMatchingRateAgreement(LogisticsOrderVO, AgreementType) line: 752	
			for (RateAgreementVO myRateAgreementVO : myPreselectedList) {
				if (myResultList.isEmpty() || !myResultList.contains(myRateAgreementVO)) {
					if (myRateAgreementVO.matches(myContext)) {
/ NEE
/ we geven 
/c
/ JA

/ er zijn 2 ra's die de sho match	,

myRateAgreementVO	RateAgreementVO_$$_javassist_103  (id=28808)	
theSystemId: 26768606Name :VT-9148459-2015
Description :Verkooptarief Gildewerk BV 2015
Organization :SystemId:500	Id:PNL-CARGO	Description:PostNL Cargo
Unit :theSystemId: 1000072	Symbol :EUR	Description :Euro	UnitType :CURRENCY	IsDeleted :0	
IsDeleted :false
Type :SHIPMENT_ORDER

theSystemId: 26773867Name :RA-BUSINESSRULES SHO
Description :Business rules PostNL
Organization :SystemId:500	Id:PNL-CARGO	Description:PostNL Cargo
Unit :theSystemId: 1000072	Symbol :EUR	Description :Euro	UnitType :CURRENCY	IsDeleted :0	
IsDeleted :false
Type :SHIPMENT_ORDER

					for (RateAgreementVO myRateAgreementVO : myResultList) {
						myEntry[i] = myRateAgreementVO.getSystemId();
						i++;
					}
					matching_cache.addObject(myKey, myEntry);
/ myKey=SHO-SHIPMENT_ORDER26831165
/ myEntry=[26768606, 26773867]

/t
CalculationServiceImpl.recalculate(LogisticsOrderVO, AgreementType, TMSEventContext) line: 498	
			List<RateAgreementVO> mySelectedRateAgreement = getMatchingRateAgreement(anOrder, aRateType);
/d
/ de 2 hierboven	,
			// Now calculate the rates
			RateCalculationVO myRateCalculationVO = new RateCalculationVO();
			} else if (anOrder instanceof ShipmentOrderVO) {
				myRateCalculationVO.setShipmentOrder((ShipmentOrderVO) anOrder);
			} else {
				myRateCalculationVO.setRateAgreementVO(mySelectedRateAgreement);
/ de 2 hierboven	,

				} else if (anOrder instanceof ShipmentOrderVO) {
					ShipmentOrderVO myShipmentOrder = (ShipmentOrderVO) anOrder;
					if (!myRateCalculationVO.rateCalculationRequired()) {
/s
RateCalculationVO.rateCalculationRequired() line: 744	
			String myHash = RateCalcHashCalculator.calculate(rateAgreement, myOrder);
/ STOP HIER
/ we veranderen in debugger myHash="0"
			if (ObjectUtils.equals(myHash, myOrder.getRatecalcMd5Hash())) {
/ NEE
		return true;
/t
CalculationServiceImpl.recalculate(LogisticsOrderVO, AgreementType, TMSEventContext) line: 570	
					if (!myRateCalculationVO.rateCalculationRequired()) {
/d
/ NEE
				// Now calculate the rates
				myRateCalculationVO.runFor(mySelectedRateAgreement);
/s
RateCalculationVO.runFor(List<RateAgreementVO>) line: 784	
				calculateWithoutVariables();
/s
RateCalculationVO.calculateWithoutVariables() line: 1330	
			RateCalculationAlternative myAlterNative = new RateCalculationAlternative(this);
			alternativeList.add(myAlterNative);
			for (RateAgreementVO myAgreement : getRateAgreementVO()) {
				runFor(myAgreement, myAlterNative);
/s
RateCalculationVO.runFor(RateAgreementVO, RateCalculationAlternative) line: 1066	
			EntityType myAgreementType = getCurrentEntityType();
SHIPMENT_ORDER
			for (CostComponentSpecificationVO myCostComponent : aRateAgreementVO.getCostComponentSpecificationList()) {
/=
		return theCostComponentSpecificationList;
[CostComponentSpecification:26768863/RC-VRACHT/Totale Vrachtkosten]
				else{
					myCostComponentSpecificationList.add(myCostComponent);

/ Intermezzo

pnllogistics2=# \d cost_component_specification
Foreign-key constraints:
    "cdt_parameter_systemid" FOREIGN KEY (parameter_systemid) REFERENCES rate_parameter(system_id)
    "cdt_ragreement_systemid" FOREIGN KEY (rate_agreement_systemid) REFERENCES rate_agreement(system_id)
    "fk_rate_comp_type_systemid" FOREIGN KEY (order_rate_part_systemid) REFERENCES rate_component_type(system_id)

 system_id |   name    |     description     | parameter_systemid | order_rate_part_systemid | sequence_nr | rate_agreement_systemid | rate_plus_mode | correc
tion_type | evaluation_objective | calculation_type |  entity_type   
-----------+-----------+---------------------+--------------------+--------------------------+-------------+-------------------------+----------------+-------
----------+----------------------+------------------+----------------
  26768863 | RC-VRACHT | Totale Vrachtkosten |           26768862 |                 26595000 |           0 |                26768606 | NONE           | ADD   
          | PRICE                | POSTCALCULATED   | SHIPMENT_ORDER
(1 row)

pnllogistics2=# select*from rate_agreement where system_id= 26768606;
 system_id |      name       |           description           | organization_systemid | unit_systemid | is_deleted |   rate_type    | is_quotation | is_templ
ate | reference1 | reference2 | reference3 | reference4 | reference5 | reference6 | reference7 | reference8 | reference9 | reference10 
-----------+-----------------+---------------------------------+-----------------------+---------------+------------+----------------+--------------+---------
----+------------+------------+------------+------------+------------+------------+------------+------------+------------+-------------
  26768606 | VT-9148459-2015 | Verkooptarief Gildewerk BV 2015 |                   500 |       1000072 |          0 | SHIPMENT_ORDER |            0 |         
  0 |            |            |            |            |            |            |            |            |            | 
(1 row)

pnllogistics2=#  select*from rate_parameter where system_id= 26768862 ;
 system_id |   name    |     description      | outputfrom_function_systemid | rate_agreement_systemid | is_persistent | sequence_nr | parameter_type_systemid
 | is_user_editable | iteration_entity | iteration_action 
-----------+-----------+----------------------+------------------------------+-------------------------+---------------+-------------+------------------------
-+------------------+------------------+------------------
  26768862 | RP-VRACHT | TOTAAL VRACHT TARIEF |                     26768844 |                26768606 |             0 |           0 |                        
 |                0 |                  | 
(1 row)

pnllogistics2=# select*from rate_component_type where system_id= 26595000;'
 system_id |  code  | description  | is_deleted | reason_mandatory | sequence_nr | rct_group 
-----------+--------+--------------+------------+------------------+-------------+-----------
  26595000 | VRACHT | Vrachtkosten |          0 |                0 |          10 | PRICE
(1 row)

/ Einde Intermezzo

				componentLoop: for (CostComponentSpecificationVO myCostComp : myCostComponentSpecificationList) {
					for (RateResult myResult : myCostComp.run(this)) {
/s
CostComponentSpecificationVO.run(RateCalculationVO) line: 195	
		} else {
			RateParameterVO myParameter = getRateParameter();
/=
		return rateParameter;
theSystemId: 26768862Name :RP-VRACHT Description :TOTAAL VRACHT TARIEF

			RateResult myResult = myParameter.calculate(aRateCalculation);
/s
RateParameterVO.calculate(RateCalculationVO) line: 66	
						if (aRateCalculation.shouldCalculate(this)) {
/s
RateCalculationVO.shouldCalculate(RateParameterVO) line: 972	
		AbstractRateFunction myFunction = getRateFunction(aParameter);
/s
RateCalculationVO.getRateFunction(RateParameterVO) line: 624	
		String myKey = aRateParameterVO.getName();
			RateFunctionVO myOutputfromFunction = aRateParameterVO.getOutputfromFunctionVO();
theSystemId: 26768862Name :RP-VRACHT Description :TOTAAL VRACHT TARIEF
/=
		return theOutputfromFunction;

this	RateCalculationVO  (id=30952)	
aRateParameterVO	RateParameterVO  (id=32185)	
myKey	"RP-VRACHT" (id=32559)	
myFunction	null	

myOutputfromFunction	RateFunctionVO_$$_javassist_83  (id=32562)	
	handler	JavassistLazyInitializer  (id=32971)	
		target	RateFunctionVO  (id=33000)	
			performanceMonitorService	null	
			systemId	26768844	
			theFunctionDefinition	FunctionDefinitionVO  (id=33003)	
theSystemId: 3500006
Definition :com.mpobjects.oms.ratecalc.model.process.function.SumFunction,Name :SUM
			theInputParameterList	PersistentSet  (id=33004)	
[SystemId: 26768847,
 SystemId: 26768850,
 SystemId: 26768855,
 SystemId: 26768860,
 SystemId: 26768845,
 SystemId: 26768849,
 SystemId: 26768858,
 SystemId: 26768846,
 SystemId: 26768859,
 SystemId: 26768852,
 SystemId: 26768861,
 SystemId: 26768857,
 SystemId: 26768856,
 SystemId: 26768851,
 SystemId: 26768853,
 SystemId: 26768848,
 SystemId: 26768854]
			theIsUserDefined	false	
			theRateParameter	RateParameterVO  (id=32185)	
theSystemId: 26768862Name :RP-VRACHT
Description :TOTAAL VRACHT TARIEF
			theRateTable	null	
			theUnit	Unit  (id=31884)	
			theUserFuncDef	null	

/ Intermezzo

pnllogistics2=# select*from rate_parameter where system_id=26768862;
 system_id |   name    |     description      | outputfrom_function_systemid | rate_agreement_systemid | is_persistent | sequence_nr | parameter_type_systemid
 | is_user_editable | iteration_entity | iteration_action 
-----------+-----------+----------------------+------------------------------+-------------------------+---------------+-------------+------------------------
-+------------------+------------------+------------------
  26768862 | RP-VRACHT | TOTAAL VRACHT TARIEF |                     26768844 |                26768606 |             0 |           0 |                        
 |                0 |                  | 
(1 row)

pnllogistics2=# \d rate_parameter
Foreign-key constraints:
    "par_function_fk" FOREIGN KEY (outputfrom_function_systemid) REFERENCES rate_function(system_id)
 
pnllogistics2=# select  rf.* from rate_parameter rp join rate_function rf on rp.outputfrom_function_systemid=rf.system_id where rp.system_id=26768862;
 system_id | function_definition_systemid | is_user_defined | user_func_def | rate_table_systemid | unit_systemid 
-----------+------------------------------+-----------------+---------------+---------------------+---------------
  26768844 |                      3500006 |               0 |               |                     |       1000072
(1 row)

pnllogistics2=#  \d rate_function
Foreign-key constraints:
    "fnc_function_definition_fk" FOREIGN KEY (function_definition_systemid) REFERENCES function_definition(system_id)
  

pnllogistics2=# select  fd.* from rate_parameter rp join rate_function rf on rp.outputfrom_function_systemid=rf.system_id join function_definition fd on rf.function_definition_systemid=fd.system_id where rp.system_id=26768862;
 system_id |                          definition                           | name 
-----------+---------------------------------------------------------------+------
   3500006 | com.mpobjects.oms.ratecalc.model.process.function.SumFunction | SUM
(1 row)

pnllogistics2=# \d input_parameter
Foreign-key constraints:
    "inp_dim_fk" FOREIGN KEY (dimension_systemid) REFERENCES dimension(system_id)
    "inp_func_def_par_fk" FOREIGN KEY (func_par_def_systemid) REFERENCES func_parameter_def(system_id)
    "inp_function_fk" FOREIGN KEY (rate_func_systemid) REFERENCES rate_function(system_id)
    "inp_order_detail_fk" FOREIGN KEY (order_detail_systemid) REFERENCES order_detail(system_id)
    "inp_parameter_fk" FOREIGN KEY (parameter_systemid) REFERENCES rate_parameter(system_id)

pnllogistics2=# select*from input_parameter where rate_func_systemid=26768844;
 system_id | parameter_systemid | func_par_def_systemid | rate_func_systemid | dimension_systemid | configuration_value | order_detail_systemid | free_value 
-----------+--------------------+-----------------------+--------------------+--------------------+---------------------+-----------------------+------------
  26768845 |           26768699 |                       |           26768844 |                    |                     |                       |           
  26768846 |           26768613 |                       |           26768844 |                    |                     |                       |           
  26768847 |           26768706 |                       |           26768844 |                    |                     |                       |           
  26768848 |           26768618 |                       |           26768844 |                    |                     |                       |           
  26768849 |           26768790 |                       |           26768844 |                    |                     |                       |           
  26768850 |           26768638 |                       |           26768844 |                    |                     |                       |           
  26768851 |           26768819 |                       |           26768844 |                    |                     |                       |           
  26768852 |           26768661 |                       |           26768844 |                    |                     |                       |           
  26768853 |           26768773 |                       |           26768844 |                    |                     |                       |           
  26768854 |           26768780 |                       |           26768844 |                    |                     |                       |           
  26768855 |           26768766 |                       |           26768844 |                    |                     |                       |           
  26768856 |           26768650 |                       |           26768844 |                    |                     |                       |           
  26768857 |           26768759 |                       |           26768844 |                    |                     |                       |           
  26768858 |           26768807 |                       |           26768844 |                    |                     |                       |           
  26768859 |           26768752 |                       |           26768844 |                    |                     |                       |           
  26768860 |           26768745 |                       |           26768844 |                    |                     |                       |           
  26768861 |           26768785 |                       |           26768844 |                    |                     |                       |           
(17 rows)

pnllogistics2=# select*from rate_parameter where system_id=26768699;
 system_id |             name             | description | outputfrom_function_systemid | rate_agreement_systemid | is_persistent | sequence_nr | parameter_typ
e_systemid | is_user_editable | iteration_entity | iteration_action 
-----------+------------------------------+-------------+------------------------------+-------------------------+---------------+-------------+--------------
-----------+------------------+------------------+------------------
  26768699 | RT-PALLETSTAFFEL-DE-1_OUTPUT |             |                     26768698 |                26768606 |             0 |           0 |              
           |                0 |                  | 
(1 row)


pnllogistics2=# select rp.*from input_parameter ip join rate_parameter rp on ip.parameter_systemid=rp.system_id where rate_func_systemid=26768844; 
 system_id |               name               | description | outputfrom_function_systemid | rate_agreement_systemid | is_persistent | sequence_nr | parameter
_type_systemid | is_user_editable | iteration_entity | iteration_action 
-----------+----------------------------------+-------------+------------------------------+-------------------------+---------------+-------------+----------
---------------+------------------+------------------+------------------
  26768650 | RT-Rembourstoeslag_OUTPUT        |             |                     26768649 |                26768606 |             0 |           0 |          
               |                0 |                  | 
  26768699 | RT-PALLETSTAFFEL-DE-1_OUTPUT     |             |                     26768698 |                26768606 |             0 |           0 |          
               |                0 |                  | 
  26768706 | RT-PALLETSTAFFEL-DE-2_OUTPUT     |             |                     26768705 |                26768606 |             0 |           0 |          
               |                0 |                  | 
  26768745 | RT-PALLETSTAFFEL-CH-1_OUTPUT     |             |                     26768744 |                26768606 |             0 |           0 |          
               |                0 |                  | 
  26768752 | RT-PALLETSTAFFEL-CH-2_OUTPUT     |             |                     26768751 |                26768606 |             0 |           0 |          
               |                0 |                  | 
  26768759 | RT-PALLETSTAFFEL-AT-1_OUTPUT     |             |                     26768758 |                26768606 |             0 |           0 |          
               |                0 |                  | 
  26768766 | RT-PALLETSTAFFEL-AT-2_OUTPUT     |             |                     26768765 |                26768606 |             0 |           0 |          
               |                0 |                  | 
  26768773 | RT-PALLETSTAFFEL-PL-1_OUTPUT     |             |                     26768772 |                26768606 |             0 |           0 |          
               |                0 |                  | 
  26768780 | RT-PALLETSTAFFEL-PL-2_OUTPUT     |             |                     26768779 |                26768606 |             0 |           0 |          
               |                0 |                  | 
  26768785 | RT-PALLETSTAFFEL-FR-1_OUTPUT     |             |                     26768784 |                26768606 |             0 |           0 |          
               |                0 |                  | 
  26768790 | RT-PALLETSTAFFEL-FR-2_OUTPUT     |             |                     26768789 |                26768606 |             0 |           0 |          
               |                0 |                  | 
  26768807 | RT-PALLETSTAFFEL-ES-1_OUTPUT     |             |                     26768806 |                26768606 |             0 |           0 |          
               |                0 |                  | 
  26768819 | RT-PALLETSTAFFEL-ES-2_OUTPUT     |             |                     26768818 |                26768606 |             0 |           0 |          
               |                0 |                  | 
  26768613 | RT-PALLETSTAFFEL-NL-1_OUTPUT     |             |                     26768612 |                26768606 |             0 |           0 |          
               |                0 |                  | 
  26768661 | RT-Waddentoeslag Pallet 1_OUTPUT |             |                     26768660 |                26768606 |             0 |           0 |          
               |                0 |                  | 
  26768618 | RT-PALLETSTAFFEL-BE-1_OUTPUT     |             |                     26768617 |                26768606 |             0 |           0 |          
               |                0 |                  | 
  26768638 | RT-PALLETSTAFFEL-LUX-1_OUTPUT    |             |                     26768637 |                26768606 |             0 |           0 |          
               |                0 |                  | 
(17 rows)

/ Einde Intermezzo

			RateFunctionVO myOutputfromFunction = aRateParameterVO.getOutputfromFunctionVO();
/d
/ de fct (outputfromFunction) die de rp "RP-VRACHT" uitrekent	, 

com.mpobjects.oms.ratecalc.model.ratefunction.vo.RateFunctionVO/id:26768844
			FunctionDefinitionVO myFunctionDefinition = myOutputfromFunction.getFunctionDefinitionVO();
theSystemId: 3500006
Definition :com.mpobjects.oms.ratecalc.model.process.function.SumFunction,Name :SUM
			String myClassName = myFunctionDefinition.getDefinition();
com.mpobjects.oms.ratecalc.model.process.function.SumFunction
				Class<?> myClass = Class.forName(myClassName);
				myFunction = (AbstractRateFunction) myClass.newInstance();
				myFunction.setRateFunctionVO(myOutputfromFunction);
com.mpobjects.oms.ratecalc.model.ratefunction.vo.RateFunctionVO/id:26768844
				myFunction.setRateContext(this);
			rateFunctionCache.put(myKey, myFunction);
"RP-VRACHT":myFunction

/t
RateCalculationVO.shouldCalculate(RateParameterVO) line: 973	
		AbstractRateFunction myFunction = getRateFunction(aParameter);
/d
				myResult = myFunction.shouldCalculate(this);
/=
	return true;

/t
RateParameterVO.calculate(RateCalculationVO) line: 75	
/ this= theSystemId: 26768862Name :RP-VRACHT Description :TOTAAL VRACHT TARIEF

						if (aRateCalculation.shouldCalculate(this)) {
/d
							AbstractRateFunction myAbstractRateFunction = aRateCalculation.getRateFunction(this);
this	RateParameterVO  (id=32185)	
theSystemId: 26768862Name :RP-VRACHT Description :TOTAAL VRACHT TARIEF
myAbstractRateFunction	SumFunction  (id=33491)	
	theRateContext	RateCalculationVO  (id=30952)	
	theRateFunctionVO	RateFunctionVO_$$_javassist_83  (id=32562)	
com.mpobjects.oms.ratecalc.model.ratefunction.vo.RateFunctionVO/id:26768844
/ de fct (outputfromFunction) die de rp "RP-VRACHT" uitrekent	,

							RateFunctionVO myRateFunction = getOutputfromFunctionVO();
com.mpobjects.oms.ratecalc.model.ratefunction.vo.RateFunctionVO/id:26768844
/ de fct (outputfromFunction) die de rp "RP-VRACHT" uitrekent	,
/ OVERBODIG	, 
/= 
myAbstractRateFunction  SumFunction  (id=33491)
    theRateFunctionVO   RateFunctionVO_$$_javassist_83  (id=32562)

							Collection<InputParameterVO> myInputParameterList = myRateFunction.getInputParameterList();
[SystemId: 26768856,
 SystemId: 26768858,
 SystemId: 26768847,
 SystemId: 26768845,
 SystemId: 26768859,
 SystemId: 26768850,
 SystemId: 26768854,
 SystemId: 26768860,
 SystemId: 26768855,
 SystemId: 26768846,
 SystemId: 26768851,
 SystemId: 26768852,
 SystemId: 26768849,
 SystemId: 26768853,
 SystemId: 26768857,
 SystemId: 26768861,
 SystemId: 26768848]

/ Intermezzo

/ In de GUI , ra form, onder tab Parameters, 	click edit "RP-VRACHT"	,  we zien dat alle parameters RT's zijn	, en geen order detail, of free value	, 
/ terug in het ra form, onder tab Rate Tables	, zien we alle rate tables	,  inderdaad allemaal	, ook die niet parameter zijn van RP-VRACHT	, 

/ Einde Intermezzo

							} else {
								// First, make sure all input parameters are calculated
								for (InputParameterVO myInputParameter : myInputParameterList) {
									RateResult mySub = myInputParameter.calculate(aRateCalculation);
/s
InputParameterVO.calculate(RateCalculationVO) line: 71	
			RateParameterVO myParameter = getParameterVO();
			} else if (myParameter != null) {
				myRateResult = myParameter.calculate(aRateCalculation);
/s
RateParameterVO.calculate(RateCalculationVO) line: 66	
this=
theSystemId: 26768780
Name :RT-PALLETSTAFFEL-PL-2_OUTPUT

/ Intermezzo

pnllogistics2=#  select*from rate_parameter where system_id=26768780;
 system_id |             name             | description | outputfrom_function_systemid | rate_agreement_systemid | is_persistent | sequence_nr | parameter_typ
e_systemid | is_user_editable | iteration_entity | iteration_action 
-----------+------------------------------+-------------+------------------------------+-------------------------+---------------+-------------+--------------
-----------+------------------+------------------+------------------
  26768780 | RT-PALLETSTAFFEL-PL-2_OUTPUT |             |                     26768779 |                26768606 |             0 |           0 |              
           |                0 |                  | 
(1 row)

/ Einde Intermezzo

					try {
						if (aRateCalculation.shouldCalculate(this)) {
/s
RateCalculationVO.shouldCalculate(RateParameterVO) line: 972	
		AbstractRateFunction myFunction = getRateFunction(aParameter);
/s
RateCalculationVO.getRateFunction(RateParameterVO) line: 631	
			RateFunctionVO myOutputfromFunction = aRateParameterVO.getOutputfromFunctionVO();
com.mpobjects.oms.ratecalc.model.ratefunction.vo.RateFunctionVO/id:26768779
			FunctionDefinitionVO myFunctionDefinition = myOutputfromFunction.getFunctionDefinitionVO();
			String myClassName = myFunctionDefinition.getDefinition();
com.mpobjects.oms.ratecalc.model.process.function.RateTableFunction
			try {
				Class<?> myClass = Class.forName(myClassName);
				myFunction = (AbstractRateFunction) myClass.newInstance();
				myFunction.setRateFunctionVO(myOutputfromFunction);
				myFunction.setRateContext(this);
/t
RateCalculationVO.shouldCalculate(RateParameterVO) line: 977	
		AbstractRateFunction myFunction = getRateFunction(aParameter);
/d
myFunction RateTableFunction  (id=22064)	
	theRateContext	RateCalculationVO  (id=21310)	
	theRateFunctionVO	RateFunctionVO  (id=21828)	
com.mpobjects.oms.ratecalc.model.ratefunction.vo.RateFunctionVO/id:26768779
	withDebugLog	true	
				myResult = myFunction.shouldCalculate(this);

/ RateTableFunction is net als SumFunction: beide hebben de 'echte' outputFromFunction , theRateFunctionVO	, 
/s
RateTableFunction.shouldCalculate(RateCalculationVO) line: 374	


/ Intermezzo

pnllogistics2=# select*from rate_function where system_id= 26768779;
 system_id | function_definition_systemid | is_user_defined | user_func_def | rate_table_systemid | unit_systemid 
-----------+------------------------------+-----------------+---------------+---------------------+---------------
  26768779 |                      3500001 |               0 |               |            26768774 |              
(1 row)

pnllogistics2=# select*from rate_table where system_id=26768774;
-[ RECORD 1 ]--------------+---------------------------------
rate_agreement_systemid    | 26768606
system_id                  | 26768774
name                       | RT-PALLETSTAFFEL-PL-2
description                | Pallet tarief PL vanaf 4 pallets
unit_systemid              | 1000072
rate_table_xml             | 
min_charge                 | 
max_charge                 | 
rounding                   | 0
excel_formatted            | 0
default_value              | 
rate_table_content         | 9999    108.00
is_user_editable           | 0
is_shared                  | 0
linked_rate_table_systemid | 
linked_multiplication      | 
linked_addition            | 
last_update                | 2015-05-07 13:01:03.495

pnllogistics2=# \d rate_table
Referenced by:
    TABLE "dimension" CONSTRAINT "dim_rate_table_fk" FOREIGN KEY (rate_table_systemid) REFERENCES rate_table(system_id)
    TABLE "rate_function" CONSTRAINT "fnc_rate_table_fk" FOREIGN KEY (rate_table_systemid) REFERENCES rate_table(system_id)
    TABLE "rate_table" CONSTRAINT "rate_table_linked_fk" FOREIGN KEY (linked_rate_table_systemid) REFERENCES rate_table(system_id)
    TABLE "rtable_sel_criterium" CONSTRAINT "rts_rate_table_fk" FOREIGN KEY (rate_table_systemid) REFERENCES rate_table(system_id)

-[ RECORD 1 ]-----------+---------
system_id               | 26768776
rate_table_systemid     | 26768774
unit_systemid           | 
match_type_systemid     | 3800003
rate_parameter_systemid | 
value_from              | 4
value_to                | 9999
is_date                 | 0
order_detail_systemid   | 26681459
-[ RECORD 2 ]-----------+---------
system_id               | 26768777
rate_table_systemid     | 26768774
unit_systemid           | 
match_type_systemid     | 3800001
rate_parameter_systemid | 
value_from              | PL
value_to                | 
is_date                 | 0
order_detail_systemid   | 4200506

/ er zijn dus 2 sel  crit voor deze rt	, 

/ Einde Intermezzo

		return myRateTable.meetsTableSelectionCriteria(aRateCalculation);
/s
RateTableVO.meetsTableSelectionCriteria(RateCalculationVO) line: 964	
		for (RTableSelCriterion myRTableSelCriterion : getSelectionCriterionList()) {

myRTableSelCriterion	RTableSelCriterion  (id=23610)	
	performanceMonitorService	null	
	systemId	26768776	
	theIsDate	false	
	theMatchType	MatchTypeVO  (id=23759)	
SystemId [3800003], Name [RANGE]
	theOrderDetail	OrderDetail  (id=23760)	
SystemId: 26681459, Name :NR_OF_PALLET, PathOrClass :count(./topLevelShipmentItems[shippingUnitVO/code='P'])
	theRateParameter	null	
	theRateTable	RateTableVO  (id=22200)	
	theUnit	null	
	theValueFrom	"4" (id=23787)	
	theValueTo	"9999" (id=23788)	

			myRetValue = myRTableSelCriterion.evaluate(aRateContext);
/s
RTableSelCriterion.evaluate(RateCalculationVO) line: 82	
		Matcher myMatcher = getMatchTypeName().getMatcher(this);
com.mpobjects.oms.util.match.impl.RangeMatcher@133c3f83
		if (getOrderDetail() != null) {
			OrderDetail myServiceorderDetail = getOrderDetail();
			myRateResult = aRateContext.evaluate(myServiceorderDetail);
/s
RateCalculationVO.evaluate(OrderDetail) line: 339	
				} else {
					// Now retrieving a regular order detail
					EntityType myType = aOrderDetailVO.getEntityType();
SHIPMENT_ORDER
					Object myObject = objectMap.get(myType.name());
ShipmentOrder: SH000002609(SystemId:26831165; Org:PNL-CARGO)
					String myPathOrClass = aOrderDetailVO.getPathOrClass();
count(./topLevelShipmentItems[shippingUnitVO/code='P'])
/ TODO
					} else {
						Object myRet = null;
						try {
							myRet = aOrderDetailVO.retrieveValue(myObject);
Double 0.0
							} else if (myRet instanceof Number) {
								myRateResult = new RateResult(BigDecimal.valueOf(((Number) myRet).floatValue()));
			if (myRateResult != null && myRateResult.getUnitVO() == null) {
				myRateResult.setUnitVO(aOrderDetailVO.getUnit());
myRateResult	RateResult  (id=28215)	
	DATE_FORMAT	"yyyy-MM-dd" (id=28371)	
	DATE_TIME_FORMAT	"yyyy-MM-dd HH:mm:ss" (id=28372)	
	costPartList	ArrayList  (id=28373)	
	isManuallyModified	false	
	theFunctionName	"" (id=28374)	
	theResultName	"" (id=28374)	
	theSubResultList	ArrayList  (id=28375)	
	theUnitVO	theSystemId: 26632357	Symbol :PC	Description :Pieces	UnitType :NORMAL	IsDeleted :0	
	theValue	"0.0" (id=28376)	
/t
RTableSelCriterion.evaluate(RateCalculationVO) line: 100	
			myRateResult = aRateContext.evaluate(myServiceorderDetail);
/d
			myFromUnit = myServiceorderDetail.getUnit();
			} else {
				myValue = myRateResult.getValue();
"0.0"
			myMatchResult = myMatcher.match(myValue);
/s
RangeMatcher.match(Object) line: 73	
					Number myValue = getNumberFormat().parse((String) aValue);
					return match(myValue);
Long 0
					return match(myValue);
/s
RangeMatcher.match(Number) line: 131	
		if (aValue.doubleValue() < toNumber(theValueFrom).doubleValue()) {
			return false;
		}
...
/t
RateTableVO.meetsTableSelectionCriteria(RateCalculationVO) line: 969	
			myRetValue = myRTableSelCriterion.evaluate(aRateContext);
false
			if (!myRetValue) {
				break;
		return myRetValue;
...
/t
RateCalculationVO.shouldCalculate(RateParameterVO) line: 984	
				myResult = myFunction.shouldCalculate(this);
false
		return myResult.booleanValue();
/t
RateParameterVO.calculate(RateCalculationVO) line: 75	
						if (aRateCalculation.shouldCalculate(this)) {
/ NEE
			return myResult;
null
/t
RateParameterVO.calculate(RateCalculationVO) line: 154	
									RateResult mySub = myInputParameter.calculate(aRateCalculation);
/d
null

/ de 1ste sel crit failed	, en dan stopt hij met deze input par	,

/ volgende	,
							} else {
								// First, make sure all input parameters are calculated
								for (InputParameterVO myInputParameter : myInputParameterList) {
									RateResult mySub = myInputParameter.calculate(aRateCalculation);
...
/s
RateTableFunction.shouldCalculate(RateCalculationVO) line: 374	
		RateTableVO myRateTable = getRateFunctionVO().getRateTableVO();
this	RateTableFunction  (id=28700)	
/ zoals SumFunction	,
/ getRateFunctionVO()=
this
	theRateFunctionVO	RateFunctionVO  (id=28706)	
com.mpobjects.oms.ratecalc.model.ratefunction.vo.RateFunctionVO/id:26768772

/ Intermezzo

pnllogistics2=# select*from rate_function where system_id=26768772;
-[ RECORD 1 ]----------------+---------
system_id                    | 26768772
function_definition_systemid | 3500001									/ RATE_TABLE
is_user_defined              | 0
user_func_def                | 
rate_table_systemid          | 26768767
unit_systemid                | 

pnllogistics2=# select*from rate_table where system_id=26768767;
-[ RECORD 1 ]--------------+-------------------------
rate_agreement_systemid    | 26768606
system_id                  | 26768767
name                       | RT-PALLETSTAFFEL-PL-1
description                | Pallet tarief PL 1 tot 3
unit_systemid              | 1000072
rate_table_xml             | 
min_charge                 | 
max_charge                 | 
rounding                   | 0
excel_formatted            | 0
default_value              | 
rate_table_content         | 1.0     136.00
                           | 2.0     216.00
                           | 3.0     324.00
is_user_editable           | 0
is_shared                  | 0
linked_rate_table_systemid | 
linked_multiplication      | 
linked_addition            | 
last_update                | 2015-05-12 13:40:39.145


/ Einde Intermezzo

/ we zijn in	,
RateTableFunction.shouldCalculate(RateCalculationVO) line: 375	
		RateTableVO myRateTable = getRateFunctionVO().getRateTableVO();
/d
		return myRateTable.meetsTableSelectionCriteria(aRateCalculation);

/c 
/ we willen een rate param (input param)	, die er door komt	, 
RateParameterVO.calculate(RateCalculationVO) line: 77	
/ this=
theSystemId: 26768790
Name :RT-PALLETSTAFFEL-FR-2_OUTPUT
						if (aRateCalculation.shouldCalculate(this)) {
/ JA
/ Klopt, deze rt heeft geen sel crit	, dus matches de sho	,

/ Intermezzo

pnllogistics2=# select*from rate_parameter where system_id=26768790;
 system_id |             name             | description | outputfrom_function_systemid | rate_agreement_systemid | is_persistent | sequence_nr | parameter_typ
e_systemid | is_user_editable | iteration_entity | iteration_action 
-----------+------------------------------+-------------+------------------------------+-------------------------+---------------+-------------+--------------
-----------+------------------+------------------+------------------
  26768790 | RT-PALLETSTAFFEL-FR-2_OUTPUT |             |                     26768789 |                26768606 |             0 |           0 |              
           |                0 |                  | 
(1 row)

pnllogistics2=# select*from rate_function where system_id= 26768789;
 system_id | function_definition_systemid | is_user_defined | user_func_def | rate_table_systemid | unit_systemid 
-----------+------------------------------+-----------------+---------------+---------------------+---------------
  26768789 |                      3500001 |               0 |               |            26768786 |              
(1 row)

pnllogistics2=# select*from rate_table where system_id=26768786;
-[ RECORD 1 ]--------------+---------------------------------
rate_agreement_systemid    | 26768606
system_id                  | 26768786
name                       | RT-PALLETSTAFFEL-FR-2
description                | Pallet tarief FR vanaf 4 pallets
unit_systemid              | 1000072
rate_table_xml             | 
min_charge                 | 
max_charge                 | 
rounding                   | 0
excel_formatted            | 0
default_value              | 
rate_table_content         | 9999    119.66
is_user_editable           | 0
is_shared                  | 0
linked_rate_table_systemid | 
linked_multiplication      | 
linked_addition            | 
last_update                | 2015-05-12 13:36:14.77

/ Als we edit een rate par	, bijv RP-VRACHT	, zien we input parameters als parameters, entity details en free value	, 
/ bij edit rate table, zien we de input parameters onder Dimension	,

pnllogistics2=#  select*from input_parameter where rate_func_systemid=26768789;
 system_id | parameter_systemid | func_par_def_systemid | rate_func_systemid | dimension_systemid | configuration_value | order_detail_systemid | free_value 
-----------+--------------------+-----------------------+--------------------+--------------------+---------------------+-----------------------+------------
  26768788 |                    |                       |           26768789 |                    |                     |              26681459 |           
(1 row)
pnllogistics2=# select*from order_detail where system_id=26681459;
 system_id |                      path_or_class                      |     name     | unit_systemid | parameter_type_systemid |  entity_type   
-----------+---------------------------------------------------------+--------------+---------------+-------------------------+----------------
  26681459 | count(./topLevelShipmentItems[shippingUnitVO/code='P']) | NR_OF_PALLET |      26632357 |                 3700003 | SHIPMENT_ORDER
(1 row)

/ Einde Intermezzo

							} else {
								// First, make sure all input parameters are calculated
								for (InputParameterVO myInputParameter : myInputParameterList) {
									RateResult mySub = myInputParameter.calculate(aRateCalculation);
/s
InputParameterVO.calculate(RateCalculationVO) line: 71	
			OrderDetail myServiceorderDetail = getOrderDetailVO();
			if (myServiceorderDetail != null) {
				myRateResult = aRateCalculation.evaluate(myServiceorderDetail);
				if (myRateResult != null) {
					myRateResult.setResultName(myServiceorderDetail.getName());
myRateResult	RateResult  (id=29553)	
	DATE_FORMAT	"yyyy-MM-dd" (id=28371)	
	DATE_TIME_FORMAT	"yyyy-MM-dd HH:mm:ss" (id=28372)	
	costPartList	ArrayList  (id=29554)	
	isManuallyModified	false	
	theFunctionName	"" (id=28374)	
	theResultName	"NR_OF_PALLET" (id=29557)	
	theSubResultList	ArrayList  (id=29555)	
	theUnitVO	Unit  (id=28415)	
	theValue	"0.0" (id=29556)	

/t
RateParameterVO.calculate(RateCalculationVO) line: 154	
							} else {
								// First, make sure all input parameters are calculated
								for (InputParameterVO myInputParameter : myInputParameterList) {
									RateResult mySub = myInputParameter.calculate(aRateCalculation);
0.0 theSystemId: 26632357	Symbol :PC	Description :Pieces	UnitType :NORMAL	IsDeleted :0	
										mySubResults.add(mySub);
								myResult = myAbstractRateFunction.convertAndCalculate(myInputParameterList, aRateCalculation);
/s
		RateResult myResult = calculate(anInputParameterList, aRateCalculation);
/s
RateTableFunction.calculate(Collection<InputParameterVO>, RateCalculationVO) line: 39	
		RateTableVO myRateTable = getRateFunctionVO().getRateTableVO();
myRateTable	RateTableVO  (id=29426)	
	content	"9999\t119.66" (id=29727)	
	description	"Pallet tarief FR vanaf 4 pallets" (id=29972)	
	dimensionList	PersistentBag  (id=29730)	

...
		final String cacheKey = myKeyBuilder.toString();
"0.0|"
/ maar we maken cacheKey=""	, zodat de cache lookup fails	, en hij gaat calculate	,
		} else {
			myRateResult = calculateWithoutCache(anInputParameterList, aRateCalculation);
/s
RateTableFunction.calculateWithoutCache(Collection<InputParameterVO>, RateCalculationVO) line: 95	
		RateTableVO myRateTable = getRateFunctionVO().getRateTableVO();
		int myNoOfDimensions = myRateTable.getDimensionList().size();
1
		for (DimensionVO myDimension : myRateTable.getDimensionList()) {
			} else if (myDimension.getSequenceNr() == 1) {
				myInputParamArray[0] = myDimension.getInputParameter();
myInputParamArray	InputParameterVO[1]  (id=30046)	
	[0]	InputParameterVO  (id=29534)	
		theFreeValue	null	
		theFuncParDef	null	
		theOrderDetail	OrderDetail  (id=23760)	
		theParameter	null	
		theRateFunc	RateFunctionVO  (id=29402)	
		theRateResult	ThreadLocal  (id=30122)	

		boolean mySecondDimension = myRateTable.getLastDataColumn() < myRateTable.getLastDataRow();
false
		mainloop: for (int i = 0; i < 2; i++) {
			if (!mySecondDimension) {
				myResult = myRateTable.matchRowDimension(myInputParamArray);
/s
RateTableVO.matchRowDimension(InputParameterVO[]) line: 909	
		int myLast = getLastDataRow();
/s
RateTableVO.getLastDataRow() line: 470	
		return getRows().size() - 1;
/s
RateTableVO.getRows() line: 637	
		return theRateTableRows;
this	RateTableVO  (id=29426)	
	content	"9999\t119.66" (id=29727)	
	description	"Pallet tarief FR vanaf 4 pallets" (id=29972)	
	theRateTableRows	ArrayList  (id=30002)	
		elementData	Object[10]  (id=30263)	
			[0]	RateTableRow  (id=30274)	
				cells	ArrayList  (id=30283)	
					elementData	Object[10]  (id=30285)	
						[0]	RateTableDimensionInputCell  (id=30287)	
							dimensionSeqNr	1	
							theFormerCell	null	
							theFormerCellLoaded	false	
							theNextCell	null	
							theNextCellLoaded	false	
							theText	"9999" (id=30423)	
						[1]	RateTableOutputCell  (id=30288)	
							theText	"119.66" (id=30424)	
					size	2	
		size	1	
/t
RateTableVO.matchRowDimension(InputParameterVO[]) line: 909	
		int myLast = getLastDataRow();
/d
0
/ index	,
		rowLoop: for (int r = getFirstDataRow(); r <= myLast; r++) {
			RateTableRow myRow = getRow(r);									/ in def rate table	,
			for (int c = 0; c < anInputArray.length; c++) {
anInputArray	InputParameterVO[1]  (id=30046)	
[SystemId: 26768788]														/ 
				RateTableCell myObject = myRow.get(c);
myObject	RateTableDimensionInputCell  (id=30287)	
					myInputCell = (RateTableDimensionInputCell) myObject;
				if (!myInputCell.match(this, anInputArray[c].getRateResult())) {
/s
RateTableDimensionInputCell.match(RateTableVO, RateResult) line: 105	
		DimensionVO theDimension = theRateTable.getDimension(dimensionSeqNr);
		if (theDimension.isDiscrete()) {
			/* Discrete dimension */
			String myLowerText = getText().toLowerCase();
9999
				} else {
					/* numeric */
					BigDecimal myFloatValue = RateResultUtils.getBigDecimalValue(aRateResult);
/ aRateResult=0.0 theSystemId: 26632357	Symbol :PC	Description :Pieces	UnitType :NORMAL	IsDeleted :0	
0.0
					if (myFloatValue.compareTo(theRateTable.getValueAsBigDecimal(this)) == 0) {
/ theRateTable.getValueAsBigDecimal(this)=BigDecimal 9999
/ NEE
					} else {
						return false;
...
/t
RateTableFunction.calculate(Collection<InputParameterVO>, RateCalculationVO) line: 74	
			myRateResult = calculateWithoutCache(anInputParameterList, aRateCalculation);
null
			myCache.cacheResult(myRateTable, cacheKey, myRateResult);
...
/t
RateParameterVO.calculate(RateCalculationVO) line: 161	
								myResult = myAbstractRateFunction.convertAndCalculate(myInputParameterList, aRateCalculation);
null
...
/t
InputParameterVO.calculate(RateCalculationVO) line: 111	
			} else if (myParameter != null) {
				myRateResult = myParameter.calculate(aRateCalculation);
/d
null
...
/t
RateParameterVO.calculate(RateCalculationVO) line: 153	
this=
theSystemId: 26768862
Name :RP-VRACHT
						if (aRateCalculation.shouldCalculate(this)) {
-> b 	,
							} else {
								// First, make sure all input parameters are calculated
								for (InputParameterVO myInputParameter : myInputParameterList) {
									RateResult mySub = myInputParameter.calculate(aRateCalculation);
/d
null
/ volgende	,

/ 7	.

/ Herhaal	,
/ er zijn 2 ra's die de sho match	,

myRateAgreementVO	RateAgreementVO_$$_javassist_103  (id=28808)	
theSystemId: 26768606Name :VT-9148459-2015
Description :Verkooptarief Gildewerk BV 2015
Organization :SystemId:500	Id:PNL-CARGO	Description:PostNL Cargo
Unit :theSystemId: 1000072	Symbol :EUR	Description :Euro	UnitType :CURRENCY	IsDeleted :0	
IsDeleted :false
Type :SHIPMENT_ORDER

theSystemId: 26773867Name :RA-BUSINESSRULES SHO
Description :Business rules PostNL
Organization :SystemId:500	Id:PNL-CARGO	Description:PostNL Cargo
Unit :theSystemId: 1000072	Symbol :EUR	Description :Euro	UnitType :CURRENCY	IsDeleted :0	
IsDeleted :false
Type :SHIPMENT_ORDER

/ De list als we Cost click op de sho	,
/ we lezen de detailed log	, see LOG_PCT-449.txt	,
/ we zien inderdaad dat  [14:11:20.051] Starting evaluation of component [RC-VRACHT] niets oplevert	,

/ we gaan de andere, RA-BUSINESSRULES SHO doen	,

/ op SH000002609, we open een shipment item , en click 'Save shipment item'	,

/ we pass	,

RateCalculationVO.rateCalculationRequired() line: 744	
			String myHash = RateCalcHashCalculator.calculate(rateAgreement, myOrder);
/ we maken hem in de debugger "0"	,
			if (ObjectUtils.equals(myHash, myOrder.getRatecalcMd5Hash())) {
/ NEE
		return true;

/ we pass	,

RateCalculationVO.calculateWithoutVariables() line: 1335	
			for (RateAgreementVO myAgreement : getRateAgreementVO()) {
				runFor(myAgreement, myAlterNative);
getRateAgreementVO()=
[theSystemId: 26768606Name :VT-9148459-2015
Description :Verkooptarief Gildewerk BV 2015
Organization :SystemId:500	Id:PNL-CARGO	Description:PostNL Cargo
Unit :theSystemId: 1000072	Symbol :EUR	Description :Euro	UnitType :CURRENCY	IsDeleted :0	
IsDeleted :false
Type :SHIPMENT_ORDER
, theSystemId: 26773867Name :RA-BUSINESSRULES SHO
Description :Business rules PostNL
Organization :SystemId:500	Id:PNL-CARGO	Description:PostNL Cargo
Unit :theSystemId: 1000072	Symbol :EUR	Description :Euro	UnitType :CURRENCY	IsDeleted :0	
IsDeleted :false
Type :SHIPMENT_ORDER
]
/ 2 dus	,
/ De 1ste geeft geen calculated RC	, 
/ we vallen in de 2de	, RA-BUSINESSRULES SHO	,
/s
RateCalculationVO.runFor(RateAgreementVO, RateCalculationAlternative) line: 1108	
				componentLoop: for (CostComponentSpecificationVO myCostComp : myCostComponentSpecificationList) {
					for (RateResult myResult : myCostComp.run(this)) {

myCostComponentSpecificationList	ArrayList  (id=33443)	
	elementData	Object[15]  (id=33446)	
		[0]	CostComponentSpecificationVO  (id=33154)	
CostComponentSpecification:26786986/RC_PROCESS/Order Process
		[1]	CostComponentSpecificationVO  (id=33462)	
CostComponentSpecification:26823742/RC_REQ_START_AFTER/Req Start After
		[2]	CostComponentSpecificationVO  (id=33463)	
CostComponentSpecification:26823743/RC_REQ_START_BEFORE/Req Start Before
		[3]	CostComponentSpecificationVO  (id=33464)	
CostComponentSpecification:26774022/RC-HOLD/ZET HOLD STATUS
		[4]	CostComponentSpecificationVO  (id=33465)	
CostComponentSpecification:26774028/EilandToeslag/Bepaal Eilandtoeslag
		[5]	CostComponentSpecificationVO  (id=33466)	
CostComponentSpecification:26773874/RC-PRODUCTCODE/SET PRODUCT CODE ALS ACTUAL SERVICE LEVEL
		[6]	CostComponentSpecificationVO  (id=33467)	
CostComponentSpecification:26791330/RC-REQUESTED-END-BEFORE/SET REQUESTED END BEFORE
		[7]	CostComponentSpecificationVO  (id=33469)	
CostComponentSpecification:26791329/RC-REQUESTED-END-AFTER/SET REQUESTED END AFTER
		[8]	CostComponentSpecificationVO  (id=33470)	
CostComponentSpecification:26774379/TotaalADRPuntenAantal/SET TOTAL HAZ POINTS ON SHIPMENT ORDER HEADER
		[9]	CostComponentSpecificationVO  (id=33679)	
CostComponentSpecification:26820290/TijdsVenster/Set field Tijdsvenster
		[10]	CostComponentSpecificationVO  (id=33680)	
CostComponentSpecification:26790876/DistributionDepot/Set distribution depot
		[11]	CostComponentSpecificationVO  (id=33681)	
CostComponentSpecification:26773948/RC-SHIPMENTTYPE/SET SHIPMENT TYPE
		[12]	CostComponentSpecificationVO  (id=33682)	
CostComponentSpecification:26790877/CollectionDepot/Set collection depot
		[13]	CostComponentSpecificationVO  (id=33683)	
CostComponentSpecification:26774262/DefaultWeight/SET DEFAULT WEIGHT
	size	14	

/s
CostComponentSpecificationVO.run(RateCalculationVO) line: 204	
		} else {
			RateParameterVO myParameter = getRateParameter();
theSystemId: 26786431	, 
Name :RT_PROCESS_OUTPUT
			RateResult myResult = myParameter.calculate(aRateCalculation);
/s
RateParameterVO.calculate(RateCalculationVO) line: 77	
						if (aRateCalculation.shouldCalculate(this)) {
/ JA

/ Intermezzo

pnllogistics2=# select*from rate_parameter where system_id=26786431;
 system_id |       name        | description | outputfrom_function_systemid | rate_agreement_systemid | is_persistent | sequence_nr | parameter_type_systemid 
| is_user_editable | iteration_entity | iteration_action 
-----------+-------------------+-------------+------------------------------+-------------------------+---------------+-------------+-------------------------
+------------------+------------------+------------------
  26786431 | RT_PROCESS_OUTPUT |             |                     26786430 |                26773867 |             0 |           0 |                         
|                0 |                  | 
(1 row)
pnllogistics2=# select*from rate_function where system_id= 26786430;
 system_id | function_definition_systemid | is_user_defined | user_func_def | rate_table_systemid | unit_systemid 
-----------+------------------------------+-----------------+---------------+---------------------+---------------
  26786430 |                      3500001 |               0 |               |            26786425 |              
(1 row)

pnllogistics2=# select*from rate_table  where system_id=  26786425 ;
-[ RECORD 1 ]--------------+------------------------
rate_agreement_systemid    | 26773867
system_id                  | 26786425
name                       | RT_PROCESS
description                | 
unit_systemid              | 
rate_table_xml             | 
min_charge                 | 
max_charge                 | 
rounding                   | 0
excel_formatted            | 0
default_value              | LB
rate_table_content         |         001
                           | 135     AB
is_user_editable           | 0
is_shared                  | 0
linked_rate_table_systemid | 
linked_multiplication      | 
linked_addition            | 
last_update                | 2015-06-22 14:39:26.152

pnllogistics2=# select*from input_parameter where rate_func_systemid=26786430;
 system_id | parameter_systemid | func_par_def_systemid | rate_func_systemid | dimension_systemid | configuration_value | order_detail_systemid | free_value 
-----------+--------------------+-----------------------+--------------------+--------------------+---------------------+-----------------------+------------
  26786428 |                    |                       |           26786430 |                    |                     |              26786423 |           
  26786429 |                    |                       |           26786430 |                    |                     |              26786424 |           
(2 rows)

pnllogistics2=# select*from order_detail where system_id=26786423;
 system_id |                    path_or_class                    |         name         | unit_systemid | parameter_type_systemid |  entity_type   
-----------+-----------------------------------------------------+----------------------+---------------+-------------------------+----------------
  26786423 | ./entityDetailValueMap[@name='ProductKenmerkSoort'] | PRODUCT_KENMERKSOORT |               |                 3700001 | SHIPMENT_ORDER
(1 row)

pnllogistics2=# select*from order_detail where system_id=26786424;
 system_id |               path_or_class                |    name     | unit_systemid | parameter_type_systemid |  entity_type   
-----------+--------------------------------------------+-------------+---------------+-------------------------+----------------
  26786424 | ./entityDetailValueMap[@name='OptieSoort'] | OPTIE_SOORT |               |                 3700001 | SHIPMENT_ORDER
(1 row)



/ Einde Intermezzo
							AbstractRateFunction myAbstractRateFunction = aRateCalculation.getRateFunction(this);
myAbstractRateFunction	RateTableFunction  (id=33945)	
	theRateFunctionVO	RateFunctionVO  (id=33174)	
com.mpobjects.oms.ratecalc.model.ratefunction.vo.RateFunctionVO/id:26786430
							RateFunctionVO myRateFunction = getOutputfromFunctionVO();
com.mpobjects.oms.ratecalc.model.ratefunction.vo.RateFunctionVO/id:26786430
							Collection<InputParameterVO> myInputParameterList = myRateFunction.getInputParameterList();
[SystemId: 26786428, SystemId: 26786429]
							Collection<RateResult> mySubResults = new ArrayList<RateResult>();

							} else {
								// First, make sure all input parameters are calculated
								for (InputParameterVO myInputParameter : myInputParameterList) {
									RateResult mySub = myInputParameter.calculate(aRateCalculation);
										mySubResults.add(mySub);
/s
InputParameterVO.calculate(RateCalculationVO) line: 71	

			OrderDetail myServiceorderDetail = getOrderDetailVO();
SystemId: 26786423, Name :PRODUCT_KENMERKSOORT, PathOrClass :./entityDetailValueMap[@name='ProductKenmerkSoort']
				myRateResult = aRateCalculation.evaluate(myServiceorderDetail);
/ OPTIE_SOORT net zo	, 
/ dan	,
mySubResults	ArrayList  (id=34196)	
[, ]
								myResult = myAbstractRateFunction.convertAndCalculate(myInputParameterList, aRateCalculation);
...
/s
RateTableFunction.calculate(Collection<InputParameterVO>, RateCalculationVO) line: 39	
		RateTableVO myRateTable = getRateFunctionVO().getRateTableVO();
theSystemId: 26786425
		for (DimensionVO dim : myRateTable.getDimensionList()) {
/ de 2 input params	, kermerksoort en optiesoort	, hierboven	,

/ we maken de cacheKey=""
		} else {
			myRateResult = calculateWithoutCache(anInputParameterList, aRateCalculation);
/s
RateTableFunction.calculateWithoutCache(Collection<InputParameterVO>, RateCalculationVO) line: 101	
		int myNoOfDimensions = myRateTable.getDimensionList().size();
2
		InputParameterVO[] myInputParamArray = new InputParameterVO[myNoOfDimensions - 1];
[null]
		for (DimensionVO myDimension : myRateTable.getDimensionList()) {
			if (myDimension.getSequenceNr() == 2) {
/ 2de	,
				mySecondInputParam = myDimension.getInputParameter();
			} else if (myDimension.getSequenceNr() == 1) {
/ 1ste	, 
				myInputParamArray[0] = myDimension.getInputParameter();

		boolean mySecondDimension = myRateTable.getLastDataColumn() < myRateTable.getLastDataRow();
/s
RateTableVO.getLastDataColumn() line: 457	
		if (getRows().size() > 0) {
/s
RateTableVO.getRows() line: 609	
		if (serialized) {
			serialized = false;
			asciiContentToObjects();
/ Vanaf nu	,
		return theRateTableRows;
this	RateTableVO  (id=34296)	
	content	"\t001\n135\tAB" (id=34437)	
	defaultValue	"LB" (id=34438)	
	theRateTableRows	ArrayList  (id=34609)	
		elementData	Object[10]  (id=34611)	
			[0]	RateTableRow  (id=34613)	
				cells	ArrayList  (id=34617)	
					elementData	Object[10]  (id=34621)	
						[0]	EmptyCell  (id=34623)	
						[1]	RateTableDimensionInputCell  (id=34624)	
							dimensionSeqNr	2	
							theFormerCell	null	
							theFormerCellLoaded	false	
							theNextCell	null	
							theNextCellLoaded	false	
							theText	"001" (id=34643)	
					modCount	2	
					size	2	
				rowNumber	0	
			[1]	RateTableRow  (id=34614)	
				cells	ArrayList  (id=34675)	
					elementData	Object[10]  (id=34676)	
						[0]	RateTableDimensionInputCell  (id=34677)	
							dimensionSeqNr	1	
							theFormerCell	null	
							theFormerCellLoaded	false	
							theNextCell	null	
							theNextCellLoaded	false	
							theText	"135" (id=34679)	
						[1]	RateTableOutputCell  (id=34678)	
							theText	"AB" (id=34680)	
					size	2	
		size	2	
/t
	/**
	 * Returns the index of the last column which contains data.
	 */
RateTableVO.getLastDataColumn() line: 458	
		if (getRows().size() > 0) {
/ JA	,
2
			return getRows().get(0).size();
/t
		boolean mySecondDimension = myRateTable.getLastDataColumn() < myRateTable.getLastDataRow();
/s
	/**
	 * Returns the index of the last row with data.
	 * 
RateTableVO.getLastDataRow() line: 470	
		return getRows().size() - 1;

/ Intermezzo

/ rate tables	,

pnllogistics2=# select name,rate_table_content from rate_table where system_id in (26684213,26682589,26681957,26682010,26766620,26733901,26682023,26764794,26764802,26830553,26787701,26786432);
-[ RECORD 1 ]------+------------------------------------------------------------------
name               | RT-COLLECTIONDEPOT-PHARMA
rate_table_content |                 PNL-CARGO
                   | BE      .*      TBA
                   | LU      .*      TBA
                   | NL      .*      ZWA

/ 3 dim	,
/ (PNL-CARGO,BE,.*) -> TBA
/ (PNL-CARGO,LU,.*) -> TBA
/ (PNL-CARGO,NL,.*) -> ZWA


-[ RECORD 2 ]------+------------------------------------------------------------------
name               | RT-DISTRIBUTIONDEPOT-EUROFREIGHT-EXP
rate_table_content |                 PNL-CARGO
                   | .*      .*      INT

/ 3-dim
/ (PNL-CARGO,.*,.*) -> INT
 
-[ RECORD 3 ]------+------------------------------------------------------------------
name               | RT-COLLECTIONDEPOT-EUROFREIGHT-EXP
rate_table_content |                 PNL-CARGO
                   | BE      .*      TBA
                   | LU      .*      TBA
                   | NL      0.*|1.*|2[0-5].*        ASA
                   | NL      2[6-9].*|3[0-3].*       DOR
                   | NL      3[4-9].*        ASA
                   | NL      4.*|5[0-1].*    DOR
                   | NL      5[2-9].*|6[0-6].*       EHV
                   | NL      6[7-9].*|7.*|8.*|9.*    HOA

/ 3-dim
/ (PNL-CARGO, BE, .* ) -> TBA
/ (PNL-CARGO, NL, 0.*|1.*|2[0-5].*)->ASA
...

-[ RECORD 4 ]------+------------------------------------------------------------------
name               | RT-Rolcontainerstaffel-leeg-Be 3
rate_table_content | 1       46.71
                   | 2       46.71
                   | 3       46.71
                   | 4       64.23
                   | 5       64.23
                   | 6       64.23
                   | 7       81.75
                   | 8       81.75
                   | 9       81.75
                   | 10      99.26
                   | 11      99.26
                   | 12      99.26
                   | 13      110.93
                   | 14      110.93
                   | 15      110.93
                   | 16      122.62
                   | 17      122.62
                   | 18      122.62
                   | 19      134.29
                   | 20      134.29
                   | 21      134.29

/ 
-[ RECORD 5 ]------+------------------------------------------------------------------
name               | RT-DEFAULT-LEADTIME
rate_table_content | .*      1
-[ RECORD 6 ]------+------------------------------------------------------------------
name               | rt wadden
rate_table_content |         1       2       3
                   | 1000AA|1100ZZ   1       2       3

/ 2-dim
/ (1,1000AA|1100ZZ)->1
/ (2,1000AA|1100ZZ)->2
/ (3,1000AA|1100ZZ)->3

-[ RECORD 7 ]------+------------------------------------------------------------------
name               | RT-CODE
rate_table_content |         COLLECT DELIVERY
                   | AB      SE1001  SE2001
                   | LB      SE1000  SE2000
                   | OUTBOUND        SE1000  SE2000
                   | RT      SE1002  SE2002

/ 3 dim
/ (COLLECT, AB) -> SE1001
/ (DELIVERY, AB) -> SE2001
/ (COLLECT, LB) -> SE1000
/ (DELIVERY, LB) -> SE2000
...
-[ RECORD 8 ]------+------------------------------------------------------------------
name               | RT-CODE-FTL
rate_table_content |         COLLECT DELIVERY
                   | .*      SE3000  SE3000

/ 2-dim
/ (COLLECT, .*) -> SE1001
/ (DELIVERY, .*) -> SE2001

-[ RECORD 9 ]------+------------------------------------------------------------------
name               | RT-HOLD STATUS
rate_table_content |                 PNL-CARGO
                   | .*      UNKNOWN_PRODUCT_HOLD    UNKNOWN_PRODUCT_HOLD
                   | CUSTOMER_HOLD   .*      CUSTOMER_HOLD

/ WH 3-dim
(PNL-CARGO,.*,.*,UNKNOWN_PRODUCT_HOLD) -> PNL-CARGO,UNKNOWN_PRODUCT_HOLD
(PNL-CARGO,,CUSTOMER_HOLD,.*) -> CUSTOMER_HOLD


-[ RECORD 10 ]-----+------------------------------------------------------------------
name               | RT-HOLD STATUS
rate_table_content |                         PNL-CARGO
                   | .*      .*      COLLO_HOLD      COLLO_HOLD
                   | .*      CUSTOMER_HOLD   !COLLO_HOLD     CUSTOMER_HOLD
                   | UNKNOWN_PRODUCT_HOLD    !CUSTOMER_HOLD  !COLLO_HOLD     UNKNOWN_PRODUCT_HOLD

/ 4-dim	,
(PNL-CARGO,.*,.*,COLLO_HOLD) -> COLLO_HOLD
(PNL-CARGO,.*,CUSTOMER_HOLD,!COLLO_HOLD) -> CUSTOMER_HOLD
(PNL-CARGO,UNKNOWN_PRODUCT_HOLD,!CUSTOMER_HOLD,!COLLO_HOLD) -> UNKNOWN_PRODUCT_HOLD


-[ RECORD 10 ]-----+------------------------------------------------------------------
name               | RT_PROCESS															
rate_table_content |         001
                   | 135     AB

/ 2 dim	,
/ (001,135) -> AB

-[ RECORD 11 ]-----+------------------------------------------------------------------
name               | RT-POSTALCODE-HOLD
rate_table_content |                         NL      !NL
                   | !NL     .*      0.*     ADDRESS_HOLD    0
                   | NL      0.*     .*      ADDRESS_HOLD    ADDRESS_HOLD
-[ RECORD 12 ]-----+------------------------------------------------------------------
name               | RT_REDEN_CODE_RAPPORT
rate_table_content |         A       B
                   | A03     Voormelding door PostNL aangemaakt      N
                   | D05     Vergeefse rit   N
                   | D40     Afhaalzending niet opgehaald    N
                   | H22     Geannuleerd     J
                   | H32     Onvoldoende capaciteit  J
                   | H35     Geweigerd, schade       J
                   | H36     Adres incorrect N
                   | H38     Geweigerd, verkeerd product     N
                   | J07     Gesloten        J
                   | J09     Uitgesteld tot volgende werkdag J
                   | J16     Autoluwe zone buiten tijdsvenster       J
                   | J24     Lever data te bepalen   J
                   | J26     Aflevering vertraagd, verkeersomstandigheden    N
                   | J43     Buiten tijdsvenster     J
                   | J90     Datum levering  J
                   | J91     Gedeeltelijk manco      J
                   | J92     Eerste bezorgpoging niet geslaagd. Tweede poging volgt  N
                   | J93     Gedeeltelijk manco      J
                   | J94     Gesloten        N
                   | K01     Aansluiting gemist      J
                   | K15     Manco   J
                   | K17     Geweigerd       N
                   | K41     Rembours niet te innen  N
                   | M1      Definitief Manco        J
                   | M2      Manco   J

/ like in sql is case sensitive	, like '%WADDEN%' is een andere dan like '%wadden%'	,

/ 13	. 

/ in welke ra zit rt wadden?
/ Als we een rate param hebben, wat is de bijbehorende rt	?
pnllogistics2=# select ra.name from rate_table rt join rate_agreement ra on rt.rate_agreement_systemid=ra.system_id where rt.name='rt wadden';
      name       
-----------------
 VT-9883921-2015
(1 row)
/ Dus we kunnen in de GUI kijken naar de rt 'rt wadden'	, we moeten naar de ra 'VT-9883921-2015'	,

/ in welke ra zit 'RT-CODE'?
pnllogistics2=# select ra.name from rate_table rt join rate_agreement ra on rt.rate_agreement_systemid=ra.system_id where rt.name='RT-CODE';
         name         
----------------------
 RA-BUSINESSRULES SEO
(1 row)

pnllogistics2=# select ra.name from rate_table rt join rate_agreement ra on rt.rate_agreement_systemid=ra.system_id where rt.name='RT-HOLD STATUS';
           name           
--------------------------
	...
 RA-BUSINESSRULES SHO
(2 rows)



/ 13	. 

/ bij rt 'rt wadden' is er een rp 'rt wadden_OUTPUT'	,


/ 13	. 

/ Edit een rc	, 

entity type : shipment order
correctiont type: hold status

/ Dat betekent dat de value van de rc in de hold status van de sho terecht komt	, 

/ Einde Intermezzo

RateParameterVO.calculate(RateCalculationVO) line: 79	
this	RateParameterVO  (id=25767)	
theSystemId: 26773941	Name :RP-DISTRIBUTIONDEPOT Description :Bepaal distributie depot

						if (aRateCalculation.shouldCalculate(this)) {
/ JA
							AbstractRateFunction myAbstractRateFunction = aRateCalculation.getRateFunction(this);
com.mpobjects.oms.ratecalc.model.process.function.MutexFunction@2193a0b4
							RateFunctionVO myRateFunction = getOutputfromFunctionVO();
com.mpobjects.oms.ratecalc.model.ratefunction.vo.RateFunctionVO/id:26773894
							Collection<InputParameterVO> myInputParameterList = myRateFunction.getInputParameterList();
[SystemId: 26814008, SystemId: 26814009, SystemId: 26814010, SystemId: 26814011]

/ Intermezzo

pnllogistics2=#   select fd.*  from rate_parameter rp join rate_function rf on rp.outputfrom_function_systemid=rf.system_id join function_definition fd on rf.function_definition_systemid=fd.system_id where rp.system_id=26773941;
 system_id |                           definition                            | name  
-----------+-----------------------------------------------------------------+-------
    554251 | com.mpobjects.oms.ratecalc.model.process.function.MutexFunction | MUTEX
(1 row)


pnllogistics2=#  select rp2.*  from rate_parameter rp join rate_function rf on rp.outputfrom_function_systemid=rf.system_id  join input_parameter ip on rf.system_id=ip.rate_func_systemid join rate_parameter rp2 on ip.parameter_systemid=rp2.system_id where rp.system_id=26773941;
 system_id |                    name                     | description | outputfrom_function_systemid | rate_agreement_systemid | is_persistent | sequence_nr 
| parameter_type_systemid | is_user_editable | iteration_entity | iteration_action 
-----------+---------------------------------------------+-------------+------------------------------+-------------------------+---------------+-------------
+-------------------------+------------------+------------------+------------------
  26773939 | RT-DISTRIBUTIONDEPOT-PHARMA_OUTPUT          |             |                     26773931 |                26773867 |             0 |           0 
|                         |                0 |                  | 
  26773928 | RT-DISTRIBUTIONDEPOT-BNLF+SPECIALS_OUTPUT   |             |                     26773920 |                26773867 |             0 |           0 
|                         |                0 |                  | 
  26773917 | RT-DISTRIBUTIONDEPOT-EUROFREIGHT-EXP_OUTPUT |             |                     26773908 |                26773867 |             0 |           0 
|                         |                0 |                  | 
  26773905 | RT-DISTRIBUTIONDEPOT-EUROFREIGHT-IMP_OUTPUT |             |                     26773896 |                26773867 |             0 |           0 
|                         |                0 |                  | 
(4 rows)
/ de rate params die input zijn van de fct die de rate param 26773941	, 
/ er zijn 3 rate params met name='RP-DISTRIBUTIONDEPOT'	,  daarom moeten we de system_id geven	,

/ Einde Intermezzo

/ we stop hiermee	,

/ 7	.

/ Kies rt RT-PRODUCTCODE (in ra RA-BUSINESSRULES SHO)	, 
/ deze heeft 1 dimension	,
/ click Linking	, deze vraagt om een andere rt	, deze moet ook 1 dimension hebben, 
/ kies RT-WADDEN	,

/ Als we voor iedere vervoerder (van de 100)  een ra hebben	, bijv, RA-BUSINESSRULES SHO1, RA-BUSINESSRULES SHO2, ... dan is er in iedere ra bijv RT_FUEL	, 
/ als deze moet worden update, moeten we in alle ra's deze update doen	,
/ makkelijker is om 1 rt te hebben , met alle 100 fuels te hebben	, en dan de RT_FUEL in iedere ra te vervangen door deze rt	,
/ deze rt moet shared zijn	, dat is een checkbox op de rt	,  
/ de lookup gebeurt dus niet in de RT_FUEL
/ 


/ Einde PCT-449

/ DEBUG PCT-449

/ een rt kan maar in 1 ra zijn	, 
/ tenzijn we de rt shared maken	,
/ wat vervangt een shared rt	? Ook een rt? Ja	, we moeten in de ra een rt maken met dezelfde dim als de shared rt	, 
/ de reden is dat we maar 1 rt hoeven te edit	, anders de rt in iedere ra	.	

/ we maken RT_ADR_HOLD shared naar RT-WADDEN	,

/ we save de rt	,
RateTableSaveAction.act() line: 42	

		RateAgreementVO myRateAgreement = (RateAgreementVO) getSession().getAttribute(RateAgreementAbstractEditAction.ACTIVE_RATE_AGREEMENT);
		myRateAgreement.addRateTable(myRateTable);

		if (myRateTable.isLinked()) {
			// reload linked rate table to avoid session closed
			RateTableVO linkedRateTable = MpoBeanFactory.getBean(RateTableDAO.class).getBySystemId(myRateTable.getLinkedRateTableSystemId());
			myRateTable.setLinkedRateTable(linkedRateTable);
			checkAndApplyLinkLogic(myRateTable);
		}
/ TODO
		save(myRateTable);
/s
RateTableSaveAction(RateTableAbstractSaveAction).save(RateTableVO) line: 26	
		MpoBeanFactory.getBean(RateTableService.class).saveRateTable(aRateTable);
/s
RateTableServiceImpl.saveRateTable(RateTableVO) line: 148	
		if (aRateTable.hasTransformedValues()) {
/s
RateTableVO.hasTransformedValues() line: 701	
		if (!isLinked()) {
/=
		return linkedRateTable != null;
/ JA	, NU
			return false;
/t
RateTableServiceImpl.saveRateTable(RateTableVO) line: 148	
		if (aRateTable.hasTransformedValues()) {
/ NEE	, NU
		dao.save(aRateTable);
/ dao=com.mpobjects.ratecalc.dao.ratetable.RateTableDAOHibernate@94f2451	,
/s
RateTableDAOHibernate.save(RateTableVO) line: 89	
		return super.save(aRateTable);
/s
RateTableDAOHibernate(GenericHibernateDAO).save(Type) line: 485	
			getHibernateTemplate().update(anEntity);
/t
RateTableServiceImpl.saveRateTable(RateTableVO) line: 154	
		dao.save(aRateTable);
/d
		if (aRateTable.getRateFunction() == null) {
		} else {
			RateParameterVO myToUpdateRateParameter = aRateTable.getRateFunction().getRateParameter();
theSystemId: 26826642Name :RT_ADR_HOLD_OUTPUT
			myToUpdateRateParameter.setName(aRateTable.getName() + "_OUTPUT");
/ is AL	, 
			myToUpdateRateParameter.setIterationAction(aRateTable.getIterationAction());
/ is NULL nu	,
/s
RateTableVO.getIterationAction() line: 425	
		if (iterationAction == null) {
/ JA
			if (getRateFunction() != null && getRateFunction().getRateParameter() != null) {
/ JA
				iterationAction = getRateFunction().getRateParameter().getIterationAction();
null
		return iterationAction;
/t
			myToUpdateRateParameter.setIterationAction(aRateTable.getIterationAction());
/d
/ blijft NULL	,
			myToUpdateRateParameter.setIterationEntity(aRateTable.getIterationEntity());
/ is NULL nu	,
/s
RateTableVO.getIterationEntity() line: 445	
		if (iterationEntity == null) {
			if (getRateFunction() != null && getRateFunction().getRateParameter() != null) {
				iterationEntity = getRateFunction().getRateParameter().getIterationEntity();
null
			}
		}
		return iterationEntity;
/t
			myToUpdateRateParameter.setIterationEntity(aRateTable.getIterationEntity());
/ blijft NULL	,
			rateParameterDao.merge(myToUpdateRateParameter);
/ rateParameterDao=com.mpobjects.ratecalc.dao.rateparameter.RateParameterDAOHibernate@4a4f4e2d
/s
RateParameterDAOHibernate(GenericHibernateDAO).merge(Type) line: 421	
			anObject = type.cast(getHibernateTemplate().merge(anObject));
/t
            myToUpdateRateParameter.setIterationEntity(aRateTable.getIterationEntity());
/d
			myRateTableFunctionInstance = aRateTable.getRateFunction();
com.mpobjects.oms.ratecalc.model.ratefunction.vo.RateFunctionVO/id:26826641

/ Intermezzo

pnllogistics2=# select*from rate_function where system_id=26826641;
 system_id | function_definition_systemid | is_user_defined | user_func_def | rate_table_systemid | unit_systemid 
-----------+------------------------------+-----------------+---------------+---------------------+---------------
  26826641 |                      3500001 |               0 |               |            26826637 |              
(1 row)

pnllogistics2=# select*from rate_table where system_id=26826637;
 rate_agreement_systemid | system_id |    name     | description | unit_systemid | rate_table_xml | min_charge | max_charge | rounding | excel_formatted | def
ault_value | rate_table_content | is_user_editable | is_shared | linked_rate_table_systemid | linked_multiplication | linked_addition |       last_update     
  
-------------------------+-----------+-------------+-------------+---------------+----------------+------------+------------+----------+-----------------+----
-----------+--------------------+------------------+-----------+----------------------------+-----------------------+-----------------+-----------------------
--
                26773867 |  26826637 | RT_ADR_HOLD |             |               |                |            |            |        0 |               0 |    
           | 99999   ADR_HOLD   |                0 |         0 |                   26774023 |                       |                 | 2015-08-12 13:42:47.61
2
(1 row)

/ Einde Intermezzo

		for (DimensionVO myDim : aRateTable.getDimensionList()) {
			InputParameterVO myInputParameter = myDim.getInputParameter();
SystemId: 26826640
			myInputParameter.setRateFuncVO(myRateTableFunctionInstance);
			inputParameterDao.save(myInputParameter);
/s
InputParameterDAOHibernate(GenericHibernateDAO).save(Type) line: 485	
			getHibernateTemplate().update(anEntity);

/ 13	. 

/ we set Linking op RT-WADDEN	, 
/ we set Iteration op SHIPMENT_ITEM	, SUM

RateTableSaveAction.act() line: 38	
		if (myRateTable.isLinked()) {
			// reload linked rate table to avoid session closed
			RateTableVO linkedRateTable = MpoBeanFactory.getBean(RateTableDAO.class).getBySystemId(myRateTable.getLinkedRateTableSystemId());
/s
RateTableVO.getLinkedRateTableSystemId() line: 500	
		return getSystemId(getLinkedRateTable());
/s
RateTableVO.getLinkedRateTable() line: 486	
		return linkedRateTable;
this	RateTableVO  (id=26126)	
		handler	JavassistLazyInitializer  (id=28520)	
			id	Integer  (id=28523)	
26774023
			initialized	false	

/ Intermezzo

pnllogistics2=# select*from rate_table where system_id=26774023;
-[ RECORD 1 ]--------------+-------------------------------
rate_agreement_systemid    | 26773867
system_id                  | 26774023
name                       | RT-WADDEN
description                | Alle postcodes in waddengebied
unit_systemid              | 
rate_table_xml             | 
min_charge                 | 
max_charge                 | 
rounding                   | 0
excel_formatted            | 0
default_value              | 
rate_table_content         | 179[0-9].*      1
                           | 88[8-9][0-9].*  1
                           | 916[0-9].*      1
is_user_editable           | 0
is_shared                  | 1
linked_rate_table_systemid | 
linked_multiplication      | 
linked_addition            | 
last_update                | 2015-06-29 14:23:31.462

/ Einde Intermezzo

/t
RateTableVO.getLinkedRateTableSystemId() line: 500	
		return getSystemId(getLinkedRateTable());
/s
RateTableVO(ValueObject).getSystemId(ValueObject) line: 315	
			return anObject.getSystemId();
anObject	RateTableVO_$$_javassist_141  (id=28498)	
/ TODO

/t
RateTableSaveAction.act() line: 38	
			RateTableVO linkedRateTable = MpoBeanFactory.getBean(RateTableDAO.class).getBySystemId(myRateTable.getLinkedRateTableSystemId());
/d
/s
RateTableDAOHibernate(GenericHibernateDAO).getBySystemId(int) line: 297	
aSystemId	26774023	
				return type.cast(getHibernateTemplate().load(type, aSystemId));
/t
RateTableSaveAction.act() line: 39	
			RateTableVO linkedRateTable = MpoBeanFactory.getBean(RateTableDAO.class).getBySystemId(myRateTable.getLinkedRateTableSystemId());
/d
			myRateTable.setLinkedRateTable(linkedRateTable);
/ LET OP: myRateTable is een proxy, en linkedRateTable ook	,

myRateTable	RateTableVO_$$_javassist_141  (id=24754)	
	handler	JavassistLazyInitializer  (id=26145)	
		id	Integer  (id=28619)	
26826637
		initialized	true	
		target	RateTableVO  (id=26126)	
			linkedRateTable	RateTableVO_$$_javassist_141  (id=28608)	
					id	Integer  (id=28661)	
26774023
					initialized	true	

			checkAndApplyLinkLogic(myRateTable);
/s
RateTableSaveAction.checkAndApplyLinkLogic(RateTableVO) line: 58	
		RateTableVO myMaster = aRateTable.getLinkedRateTable();
myMaster.heSystemId: 26774023
/ Klopt	,
		if (myMaster.getDimensionList().size() != aRateTable.getDimensionList().size()) {
/ NEE
		} else {
			for (DimensionVO myMasterDimension : myMaster.getDimensionList()) {
myMasterDimension=theSystemId: 26774026Name :RTD-TOPOSTALCODE

/ Intermezzo

/ Een dimension heeft een input param	, deze input param is geen rate param	, wel een order detail	, 

pnllogistics2=#  select*from dimension where system_id=26774026;
 system_id |       name       | rate_table_systemid | unit_systemid | rounding | discrete | basic_charge_applicable | sequence_nr | max_min_mode | regex_pe
rmitted | range_permitted | input_parameter_systemid 
-----------+------------------+---------------------+---------------+----------+----------+-------------------------+-------------+--------------+---------
--------+-----------------+--------------------------
  26774026 | RTD-TOPOSTALCODE |            26774023 |               |        0 |        1 |                       0 |           1 |              |         
      1 |               0 |                 26774025
(1 row)

pnllogistics2=# select*from input_parameter where system_id= 26774025;
 system_id | parameter_systemid | func_par_def_systemid | rate_func_systemid | dimension_systemid | configuration_value | order_detail_systemid | free_valu
e 
-----------+--------------------+-----------------------+--------------------+--------------------+---------------------+-----------------------+----------
--
  26774025 |                    |                       |           26774024 |                    |                     |               4200507 |          
 
(1 row)

/ Einde Intermezzo

/ myMasterDimension
theSystemId: 26774026Name :RTD-TOPOSTALCODE
				int mySequence = myMasterDimension.getSequenceNr();
1
/ de 1ste dimension	,
				DimensionVO myDimension = aRateTable.getDimension(mySequence);
/ van de origineel	,
theSystemId: 26826638Name :UN_NUMBER
				myDimension.setUnit(myMasterDimension.getUnit());
/ TODO
				myDimension.setDiscrete(myMasterDimension.isDiscrete());
/ TODO
				myDimension.setBasicChargeApplicable(myMasterDimension.isBasicChargeApplicable());
/ TODO
				myDimension.setRegexPermitted(myMasterDimension.isRegexPermitted());
/ TODO
				myDimension.setRangePermitted(myMasterDimension.isRangePermitted());
/ TODO
				myDimension.setMaxMinMode(myMasterDimension.getMaxMinMode());
/ TODO
/t
RateTableSaveAction.act() line: 42	
			checkAndApplyLinkLogic(myRateTable);
		}
		save(myRateTable);
/s
RateTableSaveAction(RateTableAbstractSaveAction).save(RateTableVO) line: 26	
		MpoBeanFactory.getBean(RateTableService.class).saveRateTable(aRateTable);
/s
RateTableServiceImpl.saveRateTable(RateTableVO) line: 148	
		if (aRateTable.hasTransformedValues()) {
/s
RateTableVO.hasTransformedValues() line: 701	
		if (!isLinked()) {
/ want	,
/=
		return linkedRateTable != null;
/ NEE
		} else if ((linkedMultiplication == null ||...) 
				&& (linkedAddition == null ||...){ 
/ JA
			return false;
/t
RateTableServiceImpl.saveRateTable(RateTableVO) line: 152	
		if (aRateTable.hasTransformedValues()) {
/ NEE
		dao.save(aRateTable);

/ 7	. 

RateTableVO.setIterationEntity(String) line: 1223	
this	RateTableVO  (id=30009)	
	iterationAction	IterationAction  (id=28501)	
	iterationEntity	"SHIPMENT_ITEM" (id=30013)	
	systemId	26826637	
	theName	"RT_ADR_HOLD" (id=29796)	
	theRateAgreement	RateAgreementVO_$$_javassist_103  (id=30033)	
	theRateFunction	RateFunctionVO  (id=30034)	

		iterationEntity = aIterationEntity;
null
/ Veranderd!

/c
RateTableVO.setIterationActionStr(String) line: 1215	
this	RateTableVO  (id=30009)	
	iterationAction	IterationAction  (id=28501)	
	iterationEntity	"SHIPMENT_ITEM" (id=30013)	
/ TODO

/ FIX PCT-449

$ vi RateTableVO.java
	public void setIterationAction(IterationAction aIterationAction) {
		iterationAction = aIterationAction;
		if (getRateFunction() != null && getRateFunction().getRateParameter() != null) {
			getRateFunction().getRateParameter().setIterationAction(iterationAction);
		}
	}

/ Omdat	,
	public IterationAction getIterationAction() {
		if (iterationAction == null) {
			if (getRateFunction() != null && getRateFunction().getRateParameter() != null) {
				iterationAction = getRateFunction().getRateParameter().getIterationAction();
			}
	}
	public String getIterationEntity() {
		if (iterationEntity == null) {
			if (getRateFunction() != null && getRateFunction().getRateParameter() != null) {
				iterationEntity = getRateFunction().getRateParameter().getIterationEntity();
			}
		}
		return iterationEntity;
	}

/ en omdat	,
$ vi RateTableServiceImpl.java
	public void saveRateTable(RateTableVO aRateTable) throws AbstractException {
			myRateParameterVO.setIterationAction(aRateTable.getIterationAction());
			myRateParameterVO.setIterationEntity(aRateTable.getIterationEntity());


/ Intermezzo

/ 7	. 

/ theory	,

/ open ra RA-BUSINESSRULES SHO	,
/ open rp RA_ADR_HOLD	, er is een if fct die hem uitrekent , 
/ deze heeft 3 input params	,  2 ervan zijn dezelfde rp RT_ADR_HOLD_OUTPUT	,  en 1 is een order detail	, 
/ deze fct heeft geen rate_table_systemid	, de input params vind je door in de input_parameter table te zoeken op rate_func_systemid	,
/ voor de rp RT_ADR_HOLD_OUTPUT is er ook een fct, een rate table fct,  die hem uitrekent	, 
/ deze heeft een rate_func_systemid	, en 1 input param (voor de lookup in de rate table)	, deze vinden we weer door in de input_parameter table te zoeken op rate_funct_systemid	, 
/ de rate table heet RT_ADR_HOLD	, zonder _OUTPUT	, 
/ Dus de rp heet <name>_OUTPUT	, de rt <name>	, 

/ we zien hieronder dat de iteration wordt saved op de rp RT_ADR_HOLD_OUTPUT, met iteration_entity , iteration_action, en dus NIET op de rt RT_ADR_HOLD
/ TODO
/ Maar de linked rt wordt wel op de rt bewaard	, met linked_rate_table_systemid	,
/ OK
/ Dit is het probleem dat je dus in de get/set van de iteration's entity/action in de rt raar moet doen 	, naar de rp moet gaan	,
/ TODO

/ 7	. 

/ als we in GUI de iteretion leeg maken	, zien we dat in de db	,

/ we zien de 1ste 	, en als we ze leeg maken	,  zien we de 2de	,
pnllogistics2=# select*from rate_parameter where system_id=26826642;
 system_id |        name        | description | outputfrom_function_systemid | rate_agreement_systemid | is_persistent | sequence_nr | parameter_type_syste
mid | is_user_editable | iteration_entity | iteration_action 
-----------+--------------------+-------------+------------------------------+-------------------------+---------------+-------------+---------------------
----+------------------+------------------+------------------
  26826642 | RT_ADR_HOLD_OUTPUT |             |                     26826641 |                26773867 |             0 |           0 |                     
    |                0 | SHIPMENT_ITEM    | SUM
(1 row)

pnllogistics2=# select*from rate_parameter where system_id=26826642;
 system_id |        name        | description | outputfrom_function_systemid | rate_agreement_systemid | is_persistent | sequence_nr | parameter_type_syste
mid | is_user_editable | iteration_entity | iteration_action 
-----------+--------------------+-------------+------------------------------+-------------------------+---------------+-------------+---------------------
----+------------------+------------------+------------------
  26826642 | RT_ADR_HOLD_OUTPUT |             |                     26826641 |                26773867 |             0 |           0 |                     
    |                0 |                  | 
(1 row)

/ 7	.

/ de tables voor rp's, fct's, ip's , 

/ RP_ADR_HOLD 

/ 13	.

pnllogistics2=# select*from rate_parameter where name like '%RP_ADR_HOLD%';
 system_id |    name     | description | outputfrom_function_systemid | rate_agreement_systemid | is_persistent | sequence_nr | parameter_type_systemid | i
s_user_editable | iteration_entity | iteration_action 
-----------+-------------+-------------+------------------------------+-------------------------+---------------+-------------+-------------------------+--
----------------+------------------+------------------
  26825865 | RP_ADR_HOLD |             |                     26825864 |                26773867 |             0 |           0 |                         |  
              0 |                  | 
(1 row)

pnllogistics2=# select*from rate_function where system_id=26825864;
 system_id | function_definition_systemid | is_user_defined | user_func_def | rate_table_systemid | unit_systemid 
-----------+------------------------------+-----------------+---------------+---------------------+---------------
  26825864 |                      3500018 |               0 |               |                     |              
(1 row)

pnllogistics2=# select*from function_definition where system_id=3500018;
 system_id |                          definition                          | name 
-----------+--------------------------------------------------------------+------
   3500018 | com.mpobjects.oms.ratecalc.model.process.function.IfFunction | IF
(1 row)

pnllogistics2=# select*from input_parameter  where rate_func_systemid=26825864;
 system_id | parameter_systemid | func_par_def_systemid | rate_func_systemid | dimension_systemid | configuration_value | order_detail_systemid | free_valu
e 
-----------+--------------------+-----------------------+--------------------+--------------------+---------------------+-----------------------+----------
--
  26825866 |           26826642 |                     3 |           26825864 |                    |                     |                       |          
 
  26825868 |                    |                     1 |           26825864 |                    |                     |               4200506 |          
 
  26825867 |           26826642 |                     2 |           26825864 |                    |                     |                       |          
 
(3 rows)

pnllogistics2=# select*from rate_parameter where system_id=26826642;
 system_id |        name        | description | outputfrom_function_systemid | rate_agreement_systemid | is_persistent | sequence_nr | parameter_type_syste
mid | is_user_editable | iteration_entity | iteration_action 
-----------+--------------------+-------------+------------------------------+-------------------------+---------------+-------------+---------------------
----+------------------+------------------+------------------
  26826642 | RT_ADR_HOLD_OUTPUT |             |                     26826641 |                26773867 |             0 |           0 |                     
    |                0 | SHIPMENT_ITEM    | SUM
(1 row)

pnllogistics2=# select*from order_detail where system_id=4200506;
 system_id |       path_or_class        |    name    | unit_systemid | parameter_type_systemid |  entity_type   
-----------+----------------------------+------------+---------------+-------------------------+----------------
   4200506 | ./toPartyVO/countryVO/code | TO COUNTRY |               |                 3700001 | SHIPMENT_ORDER
(1 row)

/ 13	. 

pnllogistics2=# select*from rate_parameter where name like '%RT_ADR_HOLD%';
 system_id |        name        | description | outputfrom_function_systemid | rate_agreement_systemid | is_persistent | sequence_nr | parameter_type_syste
mid | is_user_editable | iteration_entity | iteration_action 
-----------+--------------------+-------------+------------------------------+-------------------------+---------------+-------------+---------------------
----+------------------+------------------+------------------
  26826642 | RT_ADR_HOLD_OUTPUT |             |                     26826641 |                26773867 |             0 |           0 |                     
    |                0 | SHIPMENT_ITEM    | SUM
(1 row)

pnllogistics2=# select*from rate_function where system_id=26826641;
 system_id | function_definition_systemid | is_user_defined | user_func_def | rate_table_systemid | unit_systemid 
-----------+------------------------------+-----------------+---------------+---------------------+---------------
  26826641 |                      3500001 |               0 |               |            26826637 |              
(1 row)
pnllogistics2=# select*from function_definition where system_id=3500001;
 system_id |                             definition                              |    name    
-----------+---------------------------------------------------------------------+------------
   3500001 | com.mpobjects.oms.ratecalc.model.process.function.RateTableFunction | RATE TABLE
(1 row)

pnllogistics2=# select*from rate_table where name like '%RT_ADR_HOLD%';
 rate_agreement_systemid | system_id |    name     | description | unit_systemid | rate_table_xml | min_charge | max_charge | rounding | excel_formatted | 
default_value | rate_table_content | is_user_editable | is_shared | linked_rate_table_systemid | linked_multiplication | linked_addition |       last_updat
e       
-------------------------+-----------+-------------+-------------+---------------+----------------+------------+------------+----------+-----------------+-
--------------+--------------------+------------------+-----------+----------------------------+-----------------------+-----------------+-----------------
--------
                26773867 |  26826637 | RT_ADR_HOLD |             |               |                |            |            |        0 |               0 | 
              | 99999   ADR_HOLD   |                0 |         0 |                            |                       |                 | 2015-08-13 09:39
:41.406
(1 row)

/ 13	. 

/ we zien de iteration  op	,

pnllogistics2=# select*from rate_parameter where name like '%RT_ADR_HOLD%';
 system_id |        name        | description | outputfrom_function_systemid | rate_agreement_systemid | is_persistent | sequence_nr | parameter_type_syste
mid | is_user_editable | iteration_entity | iteration_action 
-----------+--------------------+-------------+------------------------------+-------------------------+---------------+-------------+---------------------
----+------------------+------------------+------------------
  26826642 | RT_ADR_HOLD_OUTPUT |             |                     26826641 |                26773867 |             0 |           0 |                     
    |                0 | SHIPMENT_ITEM    | SUM
(1 row)


/ Einde Intermezzo


/ Einde FIX PCT-449



/ Einde DEBUG PCT-449

/ PCT-528

$ vi shipment-order_list.xml

/ in het header gedeelte	,
			boolean myCreateReturnEnabled = ApplicationPropertyManager.getInstance().getModuleProperty("oms", "shipmentorder.createreturn.enable", "false").equals("true");

            myTable.addAction("edit");         
            if (myCreateReturnEnabled){
            	myTable.addActionWithContext("create-return", "row"); 
            }         

/ in het data gedeelte	,
                ShipmentOrderMask myMask = new ShipmentOrderMask(myVO);  
				String myReturnShipmentTypes = ApplicationPropertyManager.getInstance().getModuleProperty("oms", "shipmentorder.createreturn.types", "");
				
				if (myReturnShipmentTypes.contains(myMask.getShipmentTypeCode())){
				 	if(!myVO.getReturnCreated()){
						myRow.addAttribute(Row.ATTRIBUTE_SHOW_ACTION, "return");
					}
				}

/ we zien dat addAction, addActionWithContext maar 1 keer worden called	, 
// en de ShipmentOrderMask.getShipmentTYpeCode meerdere keren, per rij. sho 1 keer	, 

$ vi ShipmentOrderMask.class
	public String getShipmentTypeCode() {
		String myRet = "";
		try {
			ShipmentType myVO = theShipmentOrder.getShipmentType();
			if (myVO != null) {
				myRet = myVO.getCode();
BENELUXFREIGHT
/ of
EUROFREIGHT
/ bijv	, 
/ we zien in de GUI dit field met label Business Line	,


/ Als we de <- return order willen zien naast de edit 	, moeten we WH 2 properties in db 	,
module.oms.shipmentorder.createreturn.enable=true
module.oms.shipmentorder.createreturn.types=BENELUXFREIGHT,EUROFREIGHT

/ De .enable property is type BOOLEAN	, de .types is van type STRING	,

/ Doe reload config	,

///////////////////////////
/ dan zien we de de blauwe pijl op de BENELUXFREIGHT en EUROFREIGHT  sho's	, als ze nog geen return order hebben	,

/ 7	. 

select*
from shipment_order sho
join order_process op 
on sho.order_process_systemid=op.system_id
where sho.shipment_order_id='SH000002609'


/ Einde PCT-528

/ PCT-575

$ vi shipment-order_edit.jsp

						<c:if test="${cf:property('oms', 'shipmentorder.orderstatusdescription.hidden', 'true')=='false'}">
							<c:choose>
								<c:when test="${cf:property('oms','shipmentorder.orderstatusdescriptionlabel.hidden','true')=='false'}">
									<mpo:field name="orderStatus.description" readOnly="true"/>
								</c:when>
								<c:otherwise>
									<tr>
										<td>&nbsp;</td>
										<td><input class="fieldInput" id="orderStatusDescription" name="orderStatusDescription" type="text" value="${formVO.orderStatusVO.description}" size="15" readonly="readonly" />
										</td>
									</tr>
								</c:otherwise>
							</c:choose>
						</c:if>
/ WERKT NIET
/ TODO
/ we doen voorlopig	,
						<c:if test="${cf:property('oms', 'shipmentorder.orderstatusdescription.hidden', 'true')=='false'}">
							<tr>
								<td>&nbsp;</td>
								<td><input class="fieldInput" id="orderStatusDescription" name="orderStatusDescription" type="text" value="${formVO.orderStatusVO.description}" size="15" readonly="readonly" />
								</td>
							</tr>
						</c:if>




						<c:if test="${cf:property('oms', 'shipmentorder.value.hidden', 'false')=='false'}">
							<tr>
								<td class="label"><mpo:label name="Value" />
								</td>
								<td class="input">
									<div class="numberFildInput">
										<mpo:numberField name="requestedTotalValue" type="float" size="9" showFieldContext="false" overRideable="true" />
									</div> <mpo:listField name="valueCurrency" type="currency" showFieldContext="false" />
								</td>
							</tr>
						</c:if>
/ OK


/ we set in db	, 
module.oms.shipmentorder.orderstatusdescription.hidden=false 
module.oms.shipmentorder.value.hidden=true

module.oms.shipmentorder.orderstatusdescriptionlabel.hidden=false 
/ TODO




/ Einde PCT-575

/ DEPLOY PNLLOGISTICS TO TEST

/ vanaf laptop	,
[eric@localhost pnllogistics]$ scp lib/ehcache-2.10.0.jar lib/quartz-1.8.6.jar vanderveldene@pnl-app-a.intermax.mp-objects.com:


/ Einde DEPLOY PNLLOGISTICS TO TEST

/ POSTGRES

/ 7	. 

/ Lees	,
http://www.postgresql.org/docs/9.1/static/datatype-datetime.html

/ 7	. 

/ date is alleen 2015-05-18	,  
/ time is alleen 14:27:42.152	,
/ timestamp is  2015-05-18 14:27:42.152

/ als we een column date 	, dan is de type date	,
/ als we een column time , dan is de type time without timezone 
/ als we een column timestamp , dan is de type timestamp without timezone 

foo=> drop table dts ; create table dts(t date);
DROP TABLE
CREATE TABLE
foo=> insert into dts values('1999-01-08 14:27:42.152');
INSERT 0 1
foo=> select*from dts;
     t      
------------
 1999-01-08
(1 row)
foo=> \d dts
    Table "public.dts"
 Column | Type | Modifiers 
--------+------+-----------
 t      | date | 



foo=> drop table dts ; create table dts(t time);
DROP TABLE
CREATE TABLE
foo=> insert into dts values('1999-01-08 14:27:42.152');
INSERT 0 1
foo=> select*from dts;
      t       
--------------
 14:27:42.152
(1 row)
foo=> \d dts
             Table "public.dts"
 Column |          Type          | Modifiers 
--------+------------------------+------


foo=> drop table dts ; create table dts(t timestamp);
DROP TABLE
CREATE TABLE
foo=> insert into dts values('1999-01-08 14:27:42.152');
INSERT 0 1
foo=> select*from dts;
            t            
-------------------------
 1999-01-08 14:27:42.152
(1 row)
foo=> \d dts
                Table "public.dts"
 Column |            Type             | Modifiers 
--------+-----------------------------+-----------
 t      | timestamp without time zone | 

/ 7	. 

/ cast naar date kan verschil geven	,

$ vi test.sh
#!/usr/bin/bash
PGPASSWORD=foo psql -U foo <<SQL
--comment
drop table if exists dts;
create table dts(t timestamp);
insert into dts values('1999-01-08 14:27:42.152');
insert into dts values('1999-02-08 14:27:42.152');
insert into dts values('1999-03-08 14:27:42.152');
insert into dts values('1999-04-08 14:27:42.152');
insert into dts values('1999-05-08 14:27:42.152');
select*from dts where t between '1999-02-08' and '1999-04-08';
select*from dts where cast(t as timestamp) between cast('1999-02-08' as timestamp) and cast('1999-04-08' as timestamp);
select*from dts where cast(t as date) between cast('1999-02-08' as date) and cast('1999-04-08' as date);
SQL

[eric@localhost Reports]$ ./test.sh 
...
            t            
-------------------------
 1999-02-08 14:27:42.152
 1999-03-08 14:27:42.152
(2 rows)

            t            
-------------------------
 1999-02-08 14:27:42.152
 1999-03-08 14:27:42.152
(2 rows)

            t            
-------------------------
 1999-02-08 14:27:42.152
 1999-03-08 14:27:42.152
 1999-04-08 14:27:42.152
(3 rows)

/ we zien dat als we cast naar date	, er 1 rij extra komt	, 
/ Klopt	,

/ 7	. 

/ in SQL between is [,]	, dus tot en met	,

$ vi test2.sh

#!/usr/bin/bash
ts="1999-01-08 14:27:42.152"
echo "$ts"
PGPASSWORD=foo psql -U foo <<SQL
drop table if exists dts;
create table dts(t timestamp);
insert into dts values('"$ts"');
select cast(t as date) from dts where t between '"$ts"' and '"$ts"';
SQL
[eric@localhost Reports]$ ./test2.sh 
1999-01-08 14:27:42.152
     t      
------------
 1999-01-08
(1 row)


/ 7		.

$ vi test2.sh
#!/usr/bin/bash
ts="1999-01-08 14:27:42.152"
echo "$ts"
PGPASSWORD=foo psql -U foo <<SQL
drop table if exists dts;
create table dts(t timestamp);
insert into dts values('"$ts"');
SQL
/ OK

/ Als we NIET ''	, dus	,
insert into dts values("$ts");
/ dan ERR	,
ERROR:  column "1999-01-08 14:27:42.152" does not exist
LINE 1: insert into dts values("1999-01-08 14:27:42.152");

/ Dus met '' erbij verschijnen de "" NIET	, 
/ TODO 



/ Einde POSTGRES

/ PCT-435

/ op acceptance	,
configuration, report, reports
/ Op pagina 2,	 
Scan report
Scan_select_input

/ Kies Scan report	,
Download report source	,
-rw-r-----. 1 eric eric     12307 Aug 13 10:58 CARGO_EXTRACT_Scanreport-V12.jrxml

$ pwd
/home/eric/Devel/Reports
[eric@localhost Reports]$ cp ~/Downloads/CARGO_EXTRACT_Scanreport-V12.jrxml CARGO_EXTRACT_Scanreport-V12.sql

/ Ook,	 
/ click 'Test report'	,
Start date: 1 juli 2015
End date : nu
/ click Create	,

/ Open de xls	,
/ we hebben in Libre Office: Tools-Options-Libre Office-Security, we hebben op Medium set	, we moeten confirm als we de .xls open	,
/ click 'Enable macros'	,
/ click PostNL icon	, 
/ we zien een ERR	, Basic runtime error '423'	,


/ 7	. 

/ VERBETER

/ In  de event zit sa, seo, shi	,

/ shi -> sho 	
/ een sho bestaat uit bijv 10 shi's 	, in een shi zit ref naar de sho	,
pnllogistics2=# select * from shipment_item limit 1;
 system_id | shipment_order_systemid |...
pnllogistics2=# select count(*)from shipment_item where shipment_order_systemid= 26684379;
10

/ sa 
pnllogistics2=# select*from service_action limit 1;
 system_id | sequence_number | consignment_systemid | shipment_order_systemid | 



/ 7	. 

pnllogistics2=# \d event_event
 closed_on                    | timestamp without time zone | 

pnllogistics2=# select closed_on from event_event;
	...
 2015-05-18 14:27:42.152

/ 7	.

/ oef in pnllogistics op a	,

pnllogistics=> select count(*)from event_event e join event_type t on e.event_type_systemid=t.system_id and t.name='J95';
 count 
-------
    69
(1 row)

/ we nemen de meest recente	,

[eric@localhost Reports]$ vi pnl-db-a-pct-435-study.sh 
PGPASSWORD=h^Zgcyr\&Q psql -U vanderveldene -h  pnl-app-a.intermax.mp-objects.com pnllogistics<<SQL
select e.system_id,e.closed_on 
    from event_event e join event_type t on e.event_type_systemid=t.system_id 
    where t.name='J95' 
    order by e.system_id desc limit $@
SQL
[eric@localhost Reports]$ ./pnl-db-a-pct-435-study.sh 5
 system_id |        closed_on        
-----------+-------------------------
  26844166 | 2015-08-13 15:46:17.836
  26843976 | 2015-08-13 13:47:00.572
  26843958 | 2015-08-13 13:40:55.275
  26843952 | 2015-08-13 13:39:28.894
  26843861 | 2015-08-13 12:55:50.488
(5 rows)

/ 7	. 

$ vi test3.sh

#!/usr/bin/bash
ts="1999-01-08 14:27:42.152"
echo "$ts"
PGPASSWORD=foo psql -U foo <<SQL
select cast('"$ts"' as date); 
SQL
[eric@localhost Reports]$ ./test3.sh 
1999-01-08 14:27:42.152
str"$ts"
    date    
------------
 1999-01-08
(1 row)


/ Maar	,
$ vi test3.sh
ts="1999-01-08 14:27:42.152"
echo "$ts"
echo str'"$ts"'
echo ('"$ts"')
/ ERR
/ TODO

/ 7	. 

$ vi pnl-db-a-pct-435.sh
where ee.system_id="$@"
/  ERR 
[eric@localhost Reports]$ ./pnl-db-a-pct-435.sh 26844166
ERROR:  column "26844166" does not exist
LINE 149: where ee.system_id="26844166"




/ 7	. 

/ we vervangen in de report query dat hij maar 1 event pakt van type 'J95'	, ipv allemaal tussen een bepaalde timestamp	,

/ 7	. 

/ we moeten op zoek naar een delivery seo met meerdere sho's	,

/ 13	. 

pnllogistics=> select count(*) 
from event_event e 
join event_type t on e.event_type_systemid=t.system_id 
where t.name='J95' ;
-[ RECORD 1 ]
count | 69

pnllogistics=> select count(service_action_systemid) 
from event_event e 
join event_type t on e.event_type_systemid=t.system_id 
where t.name='J95' ;
-[ RECORD 1 ]
count | 64

pnllogistics=> select service_action_systemid 
from event_event e 
join event_type t on e.event_type_systemid=t.system_id 
where t.name='J95' ; 
...
-[ RECORD 34 ]----------+---------
service_action_systemid | 26776936
-[ RECORD 35 ]----------+---------
service_action_systemid | 
...
/ Sommige zijn leeg	,
/ Deze zie je dus niet in count(service_action_systemid)	, 


pnllogistics=> select count(sa.shipment_order_systemid) 
from event_event e 
join event_type et on e.event_type_systemid=et.system_id 
join service_action sa on e.service_action_systemid=sa.system_id 
where et.name='J95' ;
-[ RECORD 1 ]
count | 64
/ Bij join pakt hij alleen die event_event's die service_action_systemid!=null	,

pnllogistics=> select count(sho.*) 
from event_event e 
join event_type et on e.event_type_systemid=et.system_id 
join service_action sa on e.service_action_systemid=sa.system_id 
join shipment_order sho on sa.shipment_order_systemid=sho.system_id
where et.name='J95' ;
-[ RECORD 1 ]
count | 64

/ 13	. 

select ev.service_order_systemid
from event_event ev
join event_type ty on ev.event_type_systemid=ty.system_id
where ty.name='J95' ;

select count(cons.service_order_systemid )
from event_event ev
join event_type ty on ev.event_type_systemid=ty.system_id
join service_action sa on ev.service_action_systemid=sa.system_id 
join consignment cons on sa.consignment_systemid=cons.system_id
where ty.name='J95' ;
-[ RECORD 1 ]
count | 64

select cons.service_order_systemid=ev.service_order_systemid
from event_event ev
join event_type ty on ev.event_type_systemid=ty.system_id
join service_action sa on ev.service_action_systemid=sa.system_id 
join consignment cons on sa.consignment_systemid=cons.system_id
where ty.name='J95' ;

select count(case when cons.service_order_systemid=ev.service_order_systemid then 1 else null end)
from event_event ev
join event_type ty on ev.event_type_systemid=ty.system_id
join service_action sa on ev.service_action_systemid=sa.system_id 
join consignment cons on sa.consignment_systemid=cons.system_id
where ty.name='J95' ;
-[ RECORD 1 ]
count | 64
/ we kunnen dus 	,
event -> seo
/ of	,
event->sa->cons->seo	,

/ Lees	,
http://stackoverflow.com/questions/5396498/postgresql-sql-count-of-true-values

/ 7	.

/ is een seo een DELIVERY ?

pnllogistics=> select distinct(ty.service_order_type) 
from service_order seo
join service_order_type ty on seo.service_order_type_systemid=ty.system_id;
-[ RECORD 1 ]------+--------------
service_order_type | LINEHAUL
-[ RECORD 2 ]------+--------------
service_order_type | PRINT_LABEL
-[ RECORD 3 ]------+--------------
service_order_type | COLLECT
-[ RECORD 4 ]------+--------------
service_order_type | CHECK
-[ RECORD 5 ]------+--------------
service_order_type | PICK_UP
-[ RECORD 6 ]------+--------------
service_order_type | DELIVERY
-[ RECORD 7 ]------+--------------
service_order_type | DELIVERY_NOTE

select distinct(seoty.service_order_type)
from event_event ev
join event_type evty on ev.event_type_systemid=evty.system_id
join service_order seo on ev.service_order_systemid=seo.system_id
join service_order_type seoty on seo.service_order_type_systemid=seoty.system_id
where evty.name='J95' ;
-[ RECORD 1 ]------+--------------
service_order_type | LINEHAUL
-[ RECORD 2 ]------+--------------
service_order_type | DELIVERY
-[ RECORD 3 ]------+--------------
service_order_type | DELIVERY_NOTE

/ TODO

/ 7	.

/ Een seo can meerdere sho 	,

select sa.shipment_order_systemid
from service_order seo 
join consignment cons on cons.service_order_systemid=seo.system_id
join service_action sa on sa.consignment_systemid=cons.system_id
join event_event ev on ev.service_action_systemid=seo.system_id
join event_type evty on ev.event_type_systemid=evty.system_id
join service_order_type seoty on seo.service_order_type_systemid=seoty.system_id
where evty='J95'
and seoty='DELIVERY' 


select seo.service_order_id ,count(seo.service_order_id)
from service_order seo 
join consignment cons on cons.service_order_systemid=seo.system_id
join service_action sa on sa.consignment_systemid=cons.system_id
join shipment_order sho on sa.shipment_order_systemid=sho.system_id
group by seo.service_order_id)

//////////////////////////////////////////////////////////////////////////////////////////////
/ QUERY NUMBER OF SERVICE ORDER WITH MORE THEN ... SHIPMENT ORDERS
/ Geef de seo's met meer dan 10 nsho's	,
select seo.service_order_id
from service_order seo 
join consignment cons on cons.service_order_systemid=seo.system_id
join service_action sa on sa.consignment_systemid=cons.system_id
join shipment_order sho on sa.shipment_order_systemid=sho.system_id
group by seo.service_order_id
having count(seo.service_order_id)>10;
/////////////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////
/ we willen weten welke seo types er voorkomen	,
pnllogistics=> select seo.service_order_id,seoty.service_order_type
from service_order seo
join consignment cons on cons.service_order_systemid=seo.system_id
join service_action sa on sa.consignment_systemid=cons.system_id
join shipment_order sho on sa.shipment_order_systemid=sho.system_id
join service_order_type seoty on seo.service_order_type_systemid=seoty.system_id
where seoty.service_order_type='COLLECT'
group by seo.service_order_id,seoty.service_order_type
having count(seo.service_order_id)>1;
/ we zien COLLECT	, LINEHAUL	, ...	, maar GEEN DELIVERY	,

/ Intermezzo

/ we group by ook op seoty.service_order_type	, en daar joinen we NIET op	, en beinvloed de group by NIET	,

/ we hadden eerder	, hier : t.n is ook joined op	,

foo=> select s.m,count(t.n)
foo-> from s
foo-> join st on s.m=st.m
foo-> join t on st.n=t.n
foo-> group by s.m,t.n
foo-> having count(s.m)>1
foo-> ;
 m | count 
---+-------
(0 rows)

foo=> select s.m,count(t.n)
from s
join st on s.m=st.m
join t on st.n=t.n
group by s.m,t.n
having count(s.m)>0;
 m | count 
---+-------
 1 |     1
 2 |     1
 2 |     1
(3 rows)

pnllogistics=> select seo.service_order_id
pnllogistics-> from service_order seo
pnllogistics-> join consignment cons on cons.service_order_systemid=seo.system_id
pnllogistics-> join service_action sa on sa.consignment_systemid=cons.system_id
pnllogistics-> join shipment_order sho on sa.shipment_order_systemid=sho.system_id
pnllogistics-> join service_order_type seoty on seo.service_order_type_systemid=seoty.system_id
pnllogistics-> where seoty.service_order_type='COLLECT'
pnllogistics-> group by seo.service_order_id
pnllogistics-> having count(seo.service_order_id)>10;
 service_order_id  
-------------------
 N0003617
 N0001679-20150619
 N0001172
(3 rows)

pnllogistics=> select seo.service_order_id
pnllogistics-> from service_order seo
pnllogistics-> join consignment cons on cons.service_order_systemid=seo.system_id
pnllogistics-> join service_action sa on sa.consignment_systemid=cons.system_id
pnllogistics-> join shipment_order sho on sa.shipment_order_systemid=sho.system_id
pnllogistics-> join service_order_type seoty on seo.service_order_type_systemid=seoty.system_id
pnllogistics-> where seoty.service_order_type='LINEHAUL'
pnllogistics-> group by seo.service_order_id
pnllogistics-> having count(seo.service_order_id)>10;
 service_order_id 
------------------
 N0002202
 N0003618
 N0001173
 N0002196
 N0002193
(5 rows)

pnllogistics=> select seo.service_order_id
pnllogistics-> from service_order seo
pnllogistics-> join consignment cons on cons.service_order_systemid=seo.system_id
pnllogistics-> join service_action sa on sa.consignment_systemid=cons.system_id
pnllogistics-> join shipment_order sho on sa.shipment_order_systemid=sho.system_id
pnllogistics-> join service_order_type seoty on seo.service_order_type_systemid=seoty.system_id
pnllogistics-> where seoty.service_order_type='DELIVERY_NOTE'
pnllogistics-> group by seo.service_order_id
pnllogistics-> having count(seo.service_order_id)>10;
 service_order_id 
------------------
 N0002203
 N0002205
 N0002197
 N0002252
(4 rows)

pnllogistics=>  select seo.service_order_id,seoty.service_order_type
pnllogistics-> from service_order seo
pnllogistics-> join consignment cons on cons.service_order_systemid=seo.system_id
pnllogistics-> join service_action sa on sa.consignment_systemid=cons.system_id
pnllogistics-> join shipment_order sho on sa.shipment_order_systemid=sho.system_id
pnllogistics-> join service_order_type seoty on seo.service_order_type_systemid=seoty.system_id
pnllogistics-> group by seo.service_order_id,seoty.service_order_type
pnllogistics-> having count(seo.service_order_id)>10;
 service_order_id  | service_order_type 
-------------------+--------------------
 N0002202          | LINEHAUL
 N0002197          | DELIVERY_NOTE
 N0003617          | COLLECT
 N0001173          | LINEHAUL
 N0002196          | LINEHAUL
 N0002205          | DELIVERY_NOTE
 N0002203          | DELIVERY_NOTE
 N0002193          | LINEHAUL
 N0001679-20150619 | COLLECT
 N0001172          | COLLECT
 N0002252          | DELIVERY_NOTE
 N0003618          | LINEHAUL
(12 rows)

/ Einde Intermezzo

/ Nu alleen met 'J95'
select seo.service_order_id
from service_order seo
join consignment cons on cons.service_order_systemid=seo.system_id
join service_action sa on sa.consignment_systemid=cons.system_id
join shipment_order sho on sa.shipment_order_systemid=sho.system_id
join event_event ev on ev.service_order_systemid=seo.system_id
join event_type evty on ev.event_type_systemid=evty.system_id
where evty.name='J95'
group by seo.service_order_id
having count(seo.service_order_id)>1;
-[ RECORD 1 ]----+---------
service_order_id | N0003188
-[ RECORD 2 ]----+---------
service_order_id | N0001460
-[ RECORD 3 ]----+---------
service_order_id | N0003952
-[ RECORD 4 ]----+---------
service_order_id | N0001485
-[ RECORD 5 ]----+---------
service_order_id | N0001471
-[ RECORD 6 ]----+---------
service_order_id | N0002760
-[ RECORD 7 ]----+---------
service_order_id | N0003985
-[ RECORD 8 ]----+---------
service_order_id | N0001465
-[ RECORD 9 ]----+---------
service_order_id | N0001612
-[ RECORD 10 ]---+---------
service_order_id | N0001608
-[ RECORD 11 ]---+---------
service_order_id | N0001506

/ Nu met allebei	,
select seo.service_order_id,seoty.service_order_type
from service_order seo
join consignment cons on cons.service_order_systemid=seo.system_id
join service_action sa on sa.consignment_systemid=cons.system_id
join shipment_order sho on sa.shipment_order_systemid=sho.system_id
join event_event ev on ev.service_order_systemid=seo.system_id
join event_type evty on ev.event_type_systemid=evty.system_id
join service_order_type seoty on seo.service_order_type_systemid=seoty.system_id
and evty.name='J95'
group by seo.service_order_id,seoty.service_order_type
having count(seo.service_order_id)>1;
-[ RECORD 1 ]------+--------------
service_order_id   | N0003188
service_order_type | DELIVERY
-[ RECORD 2 ]------+--------------
service_order_id   | N0002760
service_order_type | DELIVERY
-[ RECORD 3 ]------+--------------
service_order_id   | N0001471
service_order_type | LINEHAUL
-[ RECORD 4 ]------+--------------
service_order_id   | N0001460
service_order_type | DELIVERY_NOTE
-[ RECORD 5 ]------+--------------
service_order_id   | N0003985
service_order_type | DELIVERY
-[ RECORD 6 ]------+--------------
service_order_id   | N0001465
service_order_type | DELIVERY_NOTE
-[ RECORD 7 ]------+--------------
service_order_id   | N0001612
service_order_type | DELIVERY
-[ RECORD 8 ]------+--------------
service_order_id   | N0003952
service_order_type | DELIVERY
-[ RECORD 9 ]------+--------------
service_order_id   | N0001485
service_order_type | DELIVERY
-[ RECORD 10 ]-----+--------------
service_order_id   | N0001608
service_order_type | DELIVERY
-[ RECORD 11 ]-----+--------------
service_order_id   | N0001506
service_order_type | DELIVERY

////////////////////////////////////////////////////////////////////////////////////////
select seo.service_order_id
from service_order seo
join consignment cons on cons.service_order_systemid=seo.system_id
join service_action sa on sa.consignment_systemid=cons.system_id
join shipment_order sho on sa.shipment_order_systemid=sho.system_id
join event_event ev on ev.service_order_systemid=seo.system_id
join event_type evty on ev.event_type_systemid=evty.system_id
join service_order_type seoty on seo.service_order_type_systemid=seoty.system_id
where seoty.service_order_type='DELIVERY'
and evty.name='J95'
group by seo.service_order_id
having count(seo.service_order_id)>1;
-[ RECORD 1 ]----+---------
service_order_id | N0003188
-[ RECORD 2 ]----+---------
service_order_id | N0001612
-[ RECORD 3 ]----+---------
service_order_id | N0001608
-[ RECORD 4 ]----+---------
service_order_id | N0002760
-[ RECORD 5 ]----+---------
service_order_id | N0001485
-[ RECORD 6 ]----+---------
service_order_id | N0001506
-[ RECORD 7 ]----+---------
service_order_id | N0003985
-[ RECORD 8 ]----+---------
service_order_id | N0003952

/ Hernoem columns	,
select seo.service_order_id
from service_order seo
join consignment cons on cons.service_order_systemid=seo.system_id
join service_action sa on sa.consignment_systemid=cons.system_id
join shipment_order sho on sa.shipment_order_systemid=sho.system_id
join event_event evt on evt.service_order_systemid=seo.system_id
join event_type evtt on evt.event_type_systemid=evtt.system_id
join service_order_type seot on seo.service_order_type_systemid=seot.system_id
where seot.service_order_type='DELIVERY'
and evtt.name='J95'
group by seo.service_order_id
having count(seo.service_order_id)>1;

select evt.system_id
from event_event evt 
join service_order seo on evt.service_order_systemid=seo.system_id 
join event_type evtt on evt.event_type_systemid=evtt.system_id
join service_order_type seot on seo.service_order_type_systemid=seot.system_id
where seo.service_order_id='N0003188'
and seot.service_order_type='DELIVERY'
and evtt.name='J95';
-[ RECORD 1 ]-------
system_id | 26843458
-[ RECORD 2 ]-------
system_id | 26826970

/ 7	. 

/ J27

/ als we sho SH000002544 open	, zien we 5 shi's	, en 4 sa's	, en 20 events	,


pnllogistics=> select count(shi.system_id)
from shipment_item shi
join shipment_order sho on shi.shipment_order_systemid=sho.system_id
where sho. shipment_order_id='SH000002544';
 count 
-------
     5
(1 row)


select shi.*
from shipment_item shi
join shipment_order sho on shi.shipment_order_systemid=sho.system_id
where sho. shipment_order_id='SH000002544';

select shi.*
from shipment_item shi
join shipment_order sho on shi.shipment_order_systemid=sho.system_id
join event_event evt on evt.shipment_item_system_id=shi.system_id
where sho. shipment_order_id='SH000002544';

select count(shi.system_id)
from event_event evt
join event_type evtty on evt.event_type_systemid=evtty.system_id
join shipment_item shi on evt.shipment_item_system_id=shi.system_id
join shipment_order sho on shi.shipment_order_systemid=sho.system_id
where evtty.name='J27'
and sho. shipment_order_id='SH000002544';
count 
-------
    10
(1 row)
/ Klopt,	 we zien 10 J27's onder sho SH000002544

/ we willen nu alleen COLLECT 

select count(shi.system_id)
from event_event evt
join event_type evtty on evt.event_type_systemid=evtty.system_id
join shipment_item shi on evt.shipment_item_system_id=shi.system_id
join shipment_order sho on shi.shipment_order_systemid=sho.system_id
join service_action sa on evt.service_action_systemid=sa.system_id
join service_action_type saty on sa.service_action_type_systemid=saty.system_id
where evtty.name='J27'
and sho. shipment_order_id='SH000002544'
and saty.service_action_type='COLLECT';
 count 
-------
     5
(1 row)
/ Klopt	,

select evt.shipment_item_system_id,evt.service_action_systemid,evt.service_order_systemid	, shi.reference1
from event_event evt
join event_type evtty on evt.event_type_systemid=evtty.system_id
join shipment_item shi on evt.shipment_item_system_id=shi.system_id
join shipment_order sho on shi.shipment_order_systemid=sho.system_id
join service_action sa on evt.service_action_systemid=sa.system_id
join service_action_type saty on sa.service_action_type_systemid=saty.system_id
where evtty.name='J27'
and sho. shipment_order_id='SH000002544'
and saty.service_action_type='COLLECT';
 shipment_item_system_id | service_action_systemid | service_order_systemid |  reference1   
-------------------------+-------------------------+------------------------+---------------
                26827410 |                26827421 |               26827369 | 3SHEVC0000001
                26827412 |                26827421 |               26827369 | 3SHEVC0000002
                26827414 |                26827421 |               26827369 | 3SHEVC0000003
                26827416 |                26827421 |               26827369 | 3SHEVC0000004
                26827418 |                26827421 |               26827369 | 3SHEVC0000005
(5 rows)

/ we zien dus dat de J27 collect events op elk van de 5 shi's zijn	,

/ 7	.

/ spreadsheet	,

/ 13	. 

select sho.shipment_order_id
from shipment_order sho
join shipment_item shi on shi.shipment_order_systemid=sho.system_id
where shi.reference1='3SHEVC0013004';
 shipment_order_id 
-------------------
 SH000002543
(1 row)

/ maar op de spreadsheet zien we ook	,
SH000002544

/ 13	. 

select sho.shipment_order_id
from shipment_order sho
join shipment_item shi on shi.shipment_order_systemid=sho.system_id
where shi.reference1='3SHEVH0000001';
 shipment_order_id 
-------------------
 SH000002609
(1 row)
/ maar op de spreadsheet zien we ook	,
SH000002612
SH000002611

/ 7	.

/ spreadsheet	,

/ wat zijn de bijbehorende events	?

/ 13	.

select sho.shipment_order_id,evt.system_id
from shipment_order sho
join shipment_item shi on shi.shipment_order_systemid=sho.system_id
join event_event evt on evt.shipment_item_system_id=shi.system_id
where shi.reference1='3SHEVC0013004';
 shipment_order_id | system_id 
-------------------+-----------
 SH000002543       |  26827614
 SH000002543       |  26827628
(2 rows)

/ 13	. 

select sho.shipment_order_id,evt.system_id
from shipment_order sho
join shipment_item shi on shi.shipment_order_systemid=sho.system_id
join event_event evt on evt.shipment_item_system_id=shi.system_id
where shi.reference1= '3SHEVH0000001';
 shipment_order_id | system_id 
-------------------+-----------
 SH000002609       |  26831224
 SH000002609       |  26831229
 SH000002609       |  26831936
 SH000002609       |  26831234
(4 rows)

/ 13

/ meer detail	,
	 
select sho.shipment_order_id,evt.system_id,evtty.name,saty.service_action_type
from shipment_order sho
join shipment_item shi on shi.shipment_order_systemid=sho.system_id
join event_event evt on evt.shipment_item_system_id=shi.system_id
join event_type evtty on evt.event_type_systemid=evtty.system_id
join service_action sa on evt.service_action_systemid=sa.system_id
join service_action_type saty on sa.service_action_type_systemid=saty.system_id
where shi.reference1='3SHEVC0013004';
 shipment_order_id | system_id | name | service_action_type 
-------------------+-----------+------+---------------------
 SH000002543       |  26827614 | J27  | COLLECT
 SH000002543       |  26827628 | J05  | DELIVERY
(2 rows)

select sho.shipment_order_id,evt.system_id,evtty.name,saty.service_action_type
from shipment_order sho
join shipment_item shi on shi.shipment_order_systemid=sho.system_id
join event_event evt on evt.shipment_item_system_id=shi.system_id
join event_type evtty on evt.event_type_systemid=evtty.system_id
join service_action sa on evt.service_action_systemid=sa.system_id
join service_action_type saty on sa.service_action_type_systemid=saty.system_id
where shi.reference1= '3SHEVH0000001';
shipment_order_id | system_id | name | service_action_type 
-------------------+-----------+------+---------------------
 SH000002609       |  26831224 | J45  | LINEHAUL
 SH000002609       |  26831229 | J27  | LINEHAUL
 SH000002609       |  26831936 | J95  | DELIVERY
 SH000002609       |  26831234 | J27  | COLLECT
(4 rows)





/ 13	. 

/ met seo	,

select sho.shipment_order_id,evt.system_id,evtty.name,saty.service_action_type,evt.service_order_systemid,seo.service_order_id
from shipment_order sho
join shipment_item shi on shi.shipment_order_systemid=sho.system_id
join event_event evt on evt.shipment_item_system_id=shi.system_id
join event_type evtty on evt.event_type_systemid=evtty.system_id
join service_action sa on evt.service_action_systemid=sa.system_id
join service_action_type saty on sa.service_action_type_systemid=saty.system_id
join service_order seo on evt.service_order_systemid=seo.system_id 
where shi.reference1='3SHEVC0013004';
 shipment_order_id | system_id | name | service_action_type | service_order_systemid | service_order_id 
-------------------+-----------+------+---------------------+------------------------+------------------
 SH000002543       |  26827614 | J27  | COLLECT             |               26827369 | N0003212
 SH000002543       |  26827628 | J05  | DELIVERY            |               26827621 | N0003221
(2 rows)


select sho.shipment_order_id,evt.system_id,evtty.name,saty.service_action_type,evt.service_order_systemid,seo.service_order_id
from shipment_order sho
join shipment_item shi on shi.shipment_order_systemid=sho.system_id
join event_event evt on evt.shipment_item_system_id=shi.system_id
join event_type evtty on evt.event_type_systemid=evtty.system_id
join service_action sa on evt.service_action_systemid=sa.system_id
join service_action_type saty on sa.service_action_type_systemid=saty.system_id
join service_order seo on evt.service_order_systemid=seo.system_id 
where shi.reference1= '3SHEVH0000001';
 shipment_order_id | system_id | name | service_action_type | service_order_systemid | service_order_id 
-------------------+-----------+------+---------------------+------------------------+------------------
 SH000002609       |  26831224 | J45  | LINEHAUL            |               26831216 | N0003510
 SH000002609       |  26831229 | J27  | LINEHAUL            |               26831216 | N0003510
 SH000002609       |  26831936 | J95  | DELIVERY            |               26831241 | N0003512
 SH000002609       |  26831234 | J27  | COLLECT             |               26831211 | N0003509
(4 rows)

/ 13	. 

/ vind alle shi's die op de sho zitten waar shi '3SHEVC0013004' op zit	,

select shi.reference1
from shipment_item shi
where shi.shipment_order_systemid=(
select sho.system_id
from shipment_order sho
join shipment_item shi on shi.shipment_order_systemid=sho.system_id
where shi.reference1='3SHEVC0013004');
  reference1   
---------------
 3SHEVC0012001
 3SHEVC0130002
 3SHEVC0013003
 3SHEVC0013004
 3SHEVC0130005
(5 rows)

/ of	,

select shi.reference1
from shipment_item shi
join shipment_order sho on shi.shipment_order_systemid=sho.system_id
join shipment_item shi2 on shi2.shipment_order_systemid=sho.system_id
where shi2.reference1='3SHEVC0013004';
  reference1   
---------------
 3SHEVC0012001
 3SHEVC0130002
 3SHEVC0013003
 3SHEVC0013004
 3SHEVC0130005
(5 rows)

/ 13	. 

/////////////////////////////////////////////////////////////////////////////////////////////

/ ga uit van shi 3SHEVC0013004, find sho waar in is, vind alle shi's in deze sho	, vind J27-events op deze shi's	, find uit deze J27-event de sa, en de seo	,
/ we kunnen properties zoals service_order_type (COLLECT),from_name, ...  aan sa of seo vragen	, in deze query allebei, overbodig	, 

select shi.reference1,con.consignment_number,saty.service_action_type,sa.from_name, sa.to_name,seoty.service_order_type, seo.to_name, seo.from_name
from event_event evt
join event_type evtty on evt.event_type_systemid=evtty.system_id
join service_action sa on evt.service_action_systemid=sa.system_id
join service_action_type saty on sa.service_action_type_systemid=saty.system_id
join consignment con on sa.consignment_systemid=con.system_id
join service_order seo on evt.service_order_systemid=seo.system_id 
join service_order_type seoty on seo.service_order_type_systemid=seoty.system_id
join shipment_item shi on evt.shipment_item_system_id=shi.system_id
join shipment_order sho on shi.shipment_order_systemid=sho.system_id
join shipment_item shi2 on shi2.shipment_order_systemid=sho.system_id
where shi2.reference1='3SHEVC0013004'
and evtty.name='J27';

/ we kunnen de type aan de sa of aan de seo vragen	,

select seoty.service_order_type 
from service_order_type seoty
join service_order seo on  seo.service_order_type_systemid=seoty.system_id
where seo.service_order_id='N0003212';
 service_order_type 
--------------------
 COLLECT
(1 row)

/ we zien dat de seo in de J27-event = de J27-event's shi, daarvan de sa, daarvan de con, daarvan de seo	, 

select shi.reference1,sho.shipment_order_id,con.consignment_number,saty.service_action_type,sa.from_name, sa.to_name,
	seo.system_id,
	seo2.system_id,
	seoty.service_order_type, seo.to_name, seo.from_name,
	seoty2.service_order_type, seo2.to_name, seo2.from_name
from event_event evt
join event_type evtty on evt.event_type_systemid=evtty.system_id
join service_action sa on evt.service_action_systemid=sa.system_id
join service_action_type saty on sa.service_action_type_systemid=saty.system_id
join consignment con on sa.consignment_systemid=con.system_id
join service_order seo on con.service_order_systemid=seo.system_id 
join service_order_type seoty on seo.service_order_type_systemid=seoty.system_id
join service_order seo2 on evt.service_order_systemid=seo2.system_id 
join service_order_type seoty2 on seo2.service_order_type_systemid=seoty2.system_id
join shipment_item shi on evt.shipment_item_system_id=shi.system_id
join shipment_order sho on shi.shipment_order_systemid=sho.system_id
join shipment_item shi2 on shi2.shipment_order_systemid=sho.system_id
where shi2.reference1='3SHEVC0013004'
and evtty.name='J27';


/////////////////////////////////////////////////////////////////////////////////////////////

/ 13. 	

pnllogistics=> \d+ service_order_shipment_order
                      View "public.service_order_shipment_order"
         Column          |          Type          | Modifiers | Storage  | Description 
-------------------------+------------------------+-----------+----------+-------------
 service_order_systemid  | integer                |           | plain    | 
 service_order_id        | character varying(80)  |           | extended | 
 shipment_order_systemid | integer                |           | plain    | 
 shipment_order_id       | character varying(80)  |           | extended | 
 reference1              | character varying(255) |           | extended | 
 reference2              | character varying(255) |           | extended | 
View definition:
 SELECT so.system_id AS service_order_systemid,
    so.service_order_id,
    sho.system_id AS shipment_order_systemid,
    sho.shipment_order_id,
    sho.reference1,
    sho.reference2
   FROM shipment_order sho,
    service_action sa,
    consignment c,
    service_order so
  WHERE c.service_order_systemid = so.system_id AND sa.consignment_systemid = c.system_id AND sho.system_id = sa.shipment_order_systemid;


pnllogistics=> select * from service_order_shipment_order where shipment_order_id='SH000002543';
 service_order_systemid | service_order_id | shipment_order_systemid | shipment_order_id | reference1 |     reference2      
------------------------+------------------+-------------------------+-------------------+------------+---------------------
               26827369 | N0003212         |                26827349 | SH000002543       | 3610       | ExternKenmerk: Q3S1
               26827621 | N0003221         |                26827349 | SH000002543       | 3610       | ExternKenmerk: Q3S1
               26827617 | N0003220         |                26827349 | SH000002543       | 3610       | ExternKenmerk: Q3S1
               26827696 | N0003222         |                26827349 | SH000002543       | 3610       | ExternKenmerk: Q3S1
(4 rows)
/ of met seoty	,
select  seosho.*,seoty.service_order_type
from service_order_shipment_order seosho
join service_order seo on seosho.service_order_id=seo.service_order_id
join service_order_type seoty on seo.service_order_type_systemid=seoty.system_id
where shipment_order_id='SH000002543';
 service_order_systemid | service_order_id | shipment_order_systemid | shipment_order_id | reference1 |     reference2      | service_order_
type 
------------------------+------------------+-------------------------+-------------------+------------+---------------------+---------------
-----
               26827369 | N0003212         |                26827349 | SH000002543       | 3610       | ExternKenmerk: Q3S1 | COLLECT
               26827621 | N0003221         |                26827349 | SH000002543       | 3610       | ExternKenmerk: Q3S1 | DELIVERY
               26827617 | N0003220         |                26827349 | SH000002543       | 3610       | ExternKenmerk: Q3S1 | DELIVERY_NOTE
               26827696 | N0003222         |                26827349 | SH000002543       | 3610       | ExternKenmerk: Q3S1 | PRINT_LABEL
(4 rows)


/ we zien dus N0003212	, maar ook 3 anderen	, 
/ we zien op sho screen de sa's (seo's) die gedaan moeten worden voor deze sho	,

pnllogistics=> select * from service_order_shipment_order where service_order_id='N0003212';
 service_order_systemid | service_order_id | shipment_order_systemid | shipment_order_id | reference1 |     reference2      
------------------------+------------------+-------------------------+-------------------+------------+---------------------
               26827369 | N0003212         |                26827349 | SH000002543       | 3610       | ExternKenmerk: Q3S1
               26827369 | N0003212         |                26827405 | SH000002544       | 3610       | ExternKenmerk: Q3S1
(2 rows)
/ we zien consolidaties	die deze seo doet	,

/ 13	. 

/ sa's op een sho	,

select sa.system_id
from shipment_order sho
join service_action sa on sa.shipment_order_systemid=sho.system_id
where sho.shipment_order_id='SH000002543';
 system_id 
-----------
  26827607
  26827609
  26827608
  26827695
(4 rows)

/ 13	. 

/ test query voor service_order_shipment_order	,

select 
	evt.system_id as evt,
	shi.system_id as shi,
	so_dlvnote.system_id as so_dlvnote,
	sosho.service_order_systemid as so,
	sosho.shipment_order_systemid as sho,
	sosho_dlvnote.service_order_systemid as so_dlvnote,
	sosho_dlvnote.shipment_order_systemid as sho_dlvnote,
	shi.shipment_order_systemid as sho2,
	so_tmp.system_id as so_tmp,
	sa_tmp.system_id as sa_tmp,
	sho_tmp.system_id as sho_tmp,
	--sa.system_id as sa,
	sa_dlvnote.system_id as sa_dlvnote
--	sa_dlvnotenote.system_id as sa_dlvnotenote
from event_event evt
join event_type et on et.system_id = evt.event_type_systemid 
	and et.name = 'J27'
join shipment_item shi on shi.system_id = evt.shipment_item_system_id 
	and shi.reference1='3SHEVC0013004'

left join service_order_shipment_order sosho on sosho.service_order_systemid = evt.service_order_systemid
-- ERR in sosho zitten de 2 sho's uit de consolidatie	, die we moeten hebben , en een andere	,

left join service_order so_tmp on evt.service_order_systemid=so_tmp.system_id
left join service_action sa_tmp on evt.service_action_systemid=sa_tmp.system_id
left join shipment_order sho_tmp on shi.shipment_order_systemid=sho_tmp.system_id

left join service_action sa_dlvnote 
join service_action_type sa_dlvnote_ty 
on sa_dlvnote.service_action_type_systemid=sa_dlvnote_ty.system_id
	and sa_dlvnote_ty.service_action_type='DELIVERY_NOTE'
on sa_dlvnote.shipment_order_systemid=sho_tmp.system_id
left join consignment con_dlvnote on sa_dlvnote.consignment_systemid=con_dlvnote.system_id
left join service_order SO_DELIVERY on con_dlvnote.service_order_systemid=SO_DELIVERY.system_id

left join service_order_shipment_order sosho_dlvnote
    join service_order so_dlvnote 
	on sosho_dlvnote.service_order_systemid = so_dlvnote.system_id 
    join service_order_type so_dlvnote_ty
	on so_dlvnote.service_order_type_systemid = so_dlvnote_ty.system_id 
		and so_dlvnote_ty.service_order_type = 'DELIVERY_NOTE' 
on sosho_dlvnote.shipment_order_systemid = sosho.shipment_order_systemid

   evt    |   shi    | so_dlvnote |    so    |   sho    | so_dlvnote | sho_dlvnote |   sho2   |  so_tmp  |  sa_tmp  | sho_tmp  | sa_dlvnote 
----------+----------+------------+----------+----------+------------+-------------+----------+----------+----------+----------+------------
 26827614 | 26827360 |   26827617 | 26827369 | 26827349 |   26827617 |    26827349 | 26827349 | 26827369 | 26827607 | 26827349 |   26827608
 26827614 | 26827360 |   26827442 | 26827369 | 26827405 |   26827442 |    26827405 | 26827349 | 26827369 | 26827607 | 26827349 |   26827608
(2 rows)

   evt    |    sa    |    so    |   shi    |  sa_dlv  | sa_dlvnote 
----------+----------+----------+----------+----------+------------
 26827614 | 26827607 | 26827369 | 26827360 | 26827609 |   26827608

select so.system_id 
from service_action sa 
join consignment con on sa.consignment_systemid=con.system_id
join service_order so on con.service_order_systemid=so.system_id
where sa.system_id= 26827608;
 system_id 
-----------
  26827617

select sa.system_id 
from service_action sa 
join consignment con on sa.consignment_systemid=con.system_id
join service_order so on con.service_order_systemid=so.system_id
where so.system_id=26827617;
 system_id 
-----------
  26827608

select sosho.*,so_ty.service_order_type
from service_order_shipment_order sosho
join service_order so on sosho.service_order_systemid=so.system_id 
join service_order_type so_ty on so.service_order_type_systemid=so_ty.system_id 
where shipment_order_systemid=26827349;
 service_order_systemid | service_order_id | shipment_order_systemid | shipment_order_id | reference1 |     reference2      | service_or
der_type 
------------------------+------------------+-------------------------+-------------------+------------+---------------------+-----------
---------
               26827369 | N0003212         |                26827349 | SH000002543       | 3610       | ExternKenmerk: Q3S1 | COLLECT
               26827621 | N0003221         |                26827349 | SH000002543       | 3610       | ExternKenmerk: Q3S1 | DELIVERY
               26827617 | N0003220         |                26827349 | SH000002543       | 3610       | ExternKenmerk: Q3S1 | DELIVERY_N
OTE
               26827696 | N0003222         |                26827349 | SH000002543       | 3610       | ExternKenmerk: Q3S1 | PRINT_LABE
L
(4 rows)


/ 13	. 

/ study joins	,

/ 1313	.

select 
	evt.system_id as evt,
	shi.system_id as shi_evt,
	sosho.service_order_systemid as so,
	sosho.shipment_order_systemid as sho_cons
from event_event evt
join event_type et on et.system_id = evt.event_type_systemid 
	and et.name = 'J27'
join shipment_item shi on shi.system_id = evt.shipment_item_system_id 
	and shi.reference1='3SHEVC0013004'

left join service_order_shipment_order sosho on sosho.service_order_systemid = evt.service_order_systemid

   evt    | shi_evt  |    so    | sho_cons 
----------+----------+----------+----------
 26827614 | 26827360 | 26827369 | 26827349
 26827614 | 26827360 | 26827369 | 26827405

/ we zien de 2 consolidated sho in de so	, 
/ daarom 2 rows,	

/ 1313

select 
	evt.system_id as evt,
	shi.system_id as shi_evt,
	sosho.service_order_systemid as so,
	sosho.shipment_order_systemid as sho_cons
--	so_tmp.system_id as so_tmp
	--sa_tmp.system_id as sa_tmp,
	--sho_tmp.system_id as sho_tmp,
from event_event evt
join event_type et on et.system_id = evt.event_type_systemid 
	and et.name = 'J27'
join shipment_item shi on shi.system_id = evt.shipment_item_system_id 
--	and shi.reference1='3SHEVC0013004'

left join service_order_shipment_order sosho on sosho.service_order_systemid = evt.service_order_systemid
-- ERR in sosho zitten de 2 sho's uit de consolidatie	, die we moeten hebben , en een andere	,

left join service_order so_tmp on evt.service_order_systemid=so_tmp.system_id
--left join service_action sa_tmp on evt.service_action_systemid=sa_tmp.system_id
--left join shipment_order sho_tmp on shi.shipment_order_systemid=sho_tmp.system_id



/ 13	. 

/////////////////////////////////////////////////////////////////////////////
/ BASIS PCT-534
/ HIER HIER HIER

select evt.system_id as evt,sa.system_id as sa,so.system_id as so,
	shi.system_id as shi,
	sa_dlv.system_id as sa_dlv,
	sa_dlvnote.system_id as sa_dlvnote
from event_event evt
join event_type et on et.system_id = evt.event_type_systemid 
	and et.name = 'J27'
join shipment_item shi on shi.system_id = evt.shipment_item_system_id 
	and shi.reference1='3SHEVC0013004'
left join service_order so on evt.service_order_systemid=so.system_id
left join service_action sa on evt.service_action_systemid=sa.system_id
left join shipment_order sho on shi.shipment_order_systemid=sho.system_id

left join service_action sa_dlv 
join service_action_type sa_dlv_ty 
on sa_dlv.service_action_type_systemid=sa_dlv_ty.system_id
	and sa_dlv_ty.service_action_type='DELIVERY'
on sa_dlv.shipment_order_systemid=sho.system_id
left join consignment con_dlv on sa_dlv.consignment_systemid=con_dlv.system_id
left join service_order SO_DELIVERY on con_dlv.service_order_systemid=SO_DELIVERY.system_id

left join service_action sa_dlvnote 
join service_action_type sa_dlvnote_ty 
on sa_dlvnote.service_action_type_systemid=sa_dlvnote_ty.system_id
	and sa_dlvnote_ty.service_action_type='DELIVERY_NOTE'
on sa_dlvnote.shipment_order_systemid=sho.system_id
left join consignment con_dlvnote on sa_dlvnote.consignment_systemid=con_dlvnote.system_id
left join service_order SO_DELIVERY_NOTE on con_dlvnote.service_order_systemid=SO_DELIVERY_NOTE.system_id;
   evt    |    sa    |    so    |   shi    |  sa_dlv  | sa_dlvnote 
----------+----------+----------+----------+----------+------------
 26827614 | 26827607 | 26827369 | 26827360 | 26827609 |   26827608
(1 row)


--where shi.reference1='3SHEVC0013004'
--and sa_dlv_ty.service_action_type='DELIVERY'
--and sa_dlvnote_ty.service_action_type='DELIVERY_NOTE';

--join service_order_type seo_dlv_ty on SO_DELIVERY.service_order_type_systemid=seo_dlv_ty.system_id
--	and seo_dlv_ty.service_order_type='DELIVERY'
--left join service_order_type seo_dlvnote_ty on SO_DELIVERY_NOTE.service_order_type_systemid=seo_dlvnote_ty.system_id
--and seo_dlvnote_ty.service_order_type='DELIVERY_NOTE'

/ Einde BASIS PCT-534
/////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////
/ BASIS PCT-534 WITH SERVICE_ORDER_SHIPMENT_ORDER

/ Bijwerken	, 
/ TODO

select 
	evt.system_id as evt,
	sa.system_id as sa,
	so.system_id as so,
	shi.system_id as shi,
--	sa_dlv.system_id as sa_dlv,
--	sa_dlvnote.system_id as sa_dlvnote,
	SO_DELIVERY.system_id,
	so_dlv_ty.system_id,
	SHOSO_DELIVERY.service_order_systemid,
	SHOSO_DELIVERY.shipment_order_systemid
from event_event evt
join event_type et on et.system_id = evt.event_type_systemid 
	and et.name = 'J27'
join shipment_item shi on shi.system_id = evt.shipment_item_system_id 
	and shi.reference1='3SHEVC0013004'
left join service_order so on evt.service_order_systemid=so.system_id
left join service_action sa on evt.service_action_systemid=sa.system_id
left join shipment_order sho on shi.shipment_order_systemid=sho.system_id

left join service_order_shipment_order SHOSO_DELIVERY 
    join service_order SO_DELIVERY 
	on SHOSO_DELIVERY.service_order_systemid = SO_DELIVERY.system_id 
    join service_order_type so_dlv_ty
	on SO_DELIVERY.service_order_type_systemid = so_dlv_ty.system_id 
		and so_dlv_ty.service_order_type = 'DELIVERY' 
on SHOSO_DELIVERY.shipment_order_systemid = sho.system_id 

left join service_action sa_dlv 
	join service_action_type sa_dlv_ty 
	on sa_dlv.service_action_type_systemid=sa_dlv_ty.system_id
		and sa_dlv_ty.service_action_type='DELIVERY'
on sa_dlv.shipment_order_systemid=sho.system_id
left join consignment con_dlv on sa_dlv.consignment_systemid=con_dlv.system_id
left join service_order SO_DELIVERY on con_dlv.service_order_systemid=SO_DELIVERY.system_id


left join service_action sa_dlvnote 
join service_action_type sa_dlvnote_ty 
on sa_dlvnote.service_action_type_systemid=sa_dlvnote_ty.system_id
	and sa_dlvnote_ty.service_action_type='DELIVERY_NOTE'
on sa_dlvnote.shipment_order_systemid=sho.system_id
left join consignment con_dlvnote on sa_dlvnote.consignment_systemid=con_dlvnote.system_id
left join service_order SO_DELIVERY_NOTE on con_dlvnote.service_order_systemid=SO_DELIVERY_NOTE.system_id;
   evt    |    sa    |    so    |   shi    |  sa_dlv  | sa_dlvnote 
----------+----------+----------+----------+----------+------------
 26827614 | 26827607 | 26827369 | 26827360 | 26827609 |   26827608
(1 row)


--where shi.reference1='3SHEVC0013004'
--and sa_dlv_ty.service_action_type='DELIVERY'
--and sa_dlvnote_ty.service_action_type='DELIVERY_NOTE';

--join service_order_type seo_dlv_ty on SO_DELIVERY.service_order_type_systemid=seo_dlv_ty.system_id
--	and seo_dlv_ty.service_order_type='DELIVERY'
--left join service_order_type seo_dlvnote_ty on SO_DELIVERY_NOTE.service_order_type_systemid=seo_dlvnote_ty.system_id
--and seo_dlvnote_ty.service_order_type='DELIVERY_NOTE'

/ Einde BASIS PCT-534 WITH SERVICE_ORDER_SHIPMENT_ORDER
/////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////
/ BASIS PCT-534 WITH SERVICE_ORDER_SHIPMENT_ORDER

select
    evt.system_id as evt,
    shi.system_id as shi,
    sa.system_id as sa,
    so.system_id as so,
    sho.system_id as sho,

    SO_DELIVERY.system_id as SO_DELIVERY,
    so_dlv_ty.service_order_type as so_dlv_ty,

    SO_DELIVERY3.system_id as SO_DELIVERY3 ,
    so_dlv_ty3.service_order_type as so_dlv_ty3,

    SO_DELIVERY2.system_id as SO_DELIVERY2,
    sa_dlv_ty2.system_id as sa_dlv_ty2,
    'Last'
from event_event evt
join event_type evt_ty on evt_ty.system_id = evt.event_type_systemid
    and evt_ty.name = 'J27'
join shipment_item shi on shi.system_id = evt.shipment_item_system_id
    and shi.reference1='3SHEVC0013004'
left join shipment_order sho on shi.shipment_order_systemid=sho.system_id
left join service_order so on evt.service_order_systemid=so.system_id
left join service_action sa on evt.service_action_systemid=sa.system_id

left join service_order_shipment_order SHOSO_DELIVERY
    join service_order SO_DELIVERY
    on SHOSO_DELIVERY.service_order_systemid = SO_DELIVERY.system_id
    join service_order_type so_dlv_ty
    on SO_DELIVERY.service_order_type_systemid = so_dlv_ty.system_id
        and so_dlv_ty.service_order_type = 'DELIVERY'
on SHOSO_DELIVERY.shipment_order_systemid = sho.system_id

left join service_action sa_dlv3 on sa_dlv3.shipment_order_systemid=sho.system_id
left join consignment con_dlv3 on sa_dlv3.consignment_systemid=con_dlv3.system_id
left join service_order SO_DELIVERY3
    join service_order_type so_dlv_ty3 
    on SO_DELIVERY3.service_order_type_systemid=so_dlv_ty3.system_id
        and so_dlv_ty3.service_order_type='DELIVERY'
on con_dlv3.service_order_systemid=SO_DELIVERY3.system_id

left join service_action sa_dlv2
    join service_action_type sa_dlv_ty2
    on sa_dlv2.service_action_type_systemid=sa_dlv_ty2.system_id
        and sa_dlv_ty2.service_action_type='DELIVERY'
on sa_dlv2.shipment_order_systemid=sho.system_id
left join consignment con_dlv2 on sa_dlv2.consignment_systemid=con_dlv2.system_id
left join service_order SO_DELIVERY2 on con_dlv2.service_order_systemid=SO_DELIVERY2.system_id

   evt    |   shi    |    sa    |    so    |   sho    | so_delivery | so_dlv_ty | so_delivery3 | so_dlv_ty3 | so_delivery2 | sa_dlv_ty2 | ?column? 
----------+----------+----------+----------+----------+-------------+-----------+--------------+------------+--------------+------------+----------
 26827614 | 26827360 | 26827607 | 26827369 | 26827349 |    26827621 | DELIVERY  |              |            |     26827621 |   26681854 | Last
 26827614 | 26827360 | 26827607 | 26827369 | 26827349 |    26827621 | DELIVERY  |     26827621 | DELIVERY   |     26827621 |   26681854 | Last
 26827614 | 26827360 | 26827607 | 26827369 | 26827349 |    26827621 | DELIVERY  |              |            |     26827621 |   26681854 | Last
 26827614 | 26827360 | 26827607 | 26827369 | 26827349 |    26827621 | DELIVERY  |              |            |     26827621 |   26681854 | Last
(4 rows)

/ Hoe oplossen dat 
left join service_action sa_dlv3 on sa_dlv3.shipment_order_systemid=sho.system_id
/ eerst de 4 sa's zijn	, 
/ TODO


/ BASIS PCT-534 WITH SERVICE_ORDER_SHIPMENT_ORDER
/////////////////////////////////////////////////////////////////////////////

/ PCT-534 FIX

/ 13	. 

[eric@localhost Reports]$ pwd
/home/eric/Devel/Reports
[eric@localhost Reports]$ ls
CARGO_EXTRACT_Scanreport-V12.jrxml   CARGO_EXTRACT_ScanreportWithInputPram-V13.jrxml  
pnl-db-a-pct-435-fix.sh  

/ PCT-534's fix= pnl-db-a-pct-435-fix.sh

/ we maken met deze fix CARGO_EXTRACT_Scanreport.jrxml	, CARGO_EXTRACT_ScanreportWithInputParam.jrxml

/ we halen nieuwe acceptance db op	,
[eric@localhost Backup]$ pwd
/home/eric/Devel/Postgres/Backup
$ PGPASSWORD='h^Zgcyr&Q'  pg_dump -U vanderveldene -Fc -h pnl-app-a.intermax.mp-objects.com pnltms> pnl-app-a_pnltms.dump

/ we zijn nu op de laptop 	, 21-08-2015 op pnllogistics2	,

pnllogistics2=# create database pnllogistics3; 
CREATE DATABASE
[eric@localhost Backup]$ PGPASSWORD=mpopostgres@mpo pg_restore -U mpopostgres -d pnllogistics3 pnl-app-t_pnllogistics-21-08-2015.dump 

$ vi deploy/postgres-ds.xml
        <xa-datasource-property name="DatabaseName">pnllogistics3</xa-datasource-property>
...
                <connection-url>jdbc:postgresql://127.0.0.1:5432/pnllogistics3</connection-url>


/ 13	. 

/ configuration, reports, report	,
/ open Scan_Select_Input	,
Upload Report Source
/ kies de jrxml file	,
Save
/ Click 'Test Report'	,
/ Kies datums 10 Jul	, 15 Aug	,
Event type: J27

/ 13	. 

/ we hadden ERR	,
org.postgresql.util.PSQLException: ERROR: operator does not exist: timestamp without time zone >= character varying
  Hint: No operator matches the given name and argument type(s). You might need to add explicit type casts.
/ we moeten in de .jrxml	, maar NIET in de psql , de cast	,
where cast(ee.closed_on as timestamp) between cast($P{transaction_date_start_date} as timestamp) and  cast($P{transaction_dateEndDate} as timestamp)

/ 13	. 

[eric@localhost reports]$ pwd
/home/eric/Devel/Java/Eclipse/eclipse-jee/workspace/reports
[eric@localhost reports]$ svn co https://system.mp-objects.com/svn/reports/trunk
[eric@localhost reports]$ find
.
./trunk
./trunk/isbscs
./trunk/pnllogistics
./trunk/pnllogistics/DeliveryNote.jrxml
./trunk/pnllogistics/images
./trunk/pnllogistics/images/postnl_logo.png

[eric@localhost Reports]$ pwd
/home/eric/Devel/Reports
[eric@localhost Reports]$ cp CARGO_EXTRACT_Scanreport.jrxml CARGO_EXTRACT_ScanreportWithInputParam.jrxml /home/eric/Devel/Java/Eclipse/eclipse-jee/workspace/reports/trunk/pnllogistics/
[eric@localhost reports]$ find
.
./trunk
./trunk/isbscs
./trunk/pnllogistics
./trunk/pnllogistics/CARGO_EXTRACT_Scanreport.jrxml
./trunk/pnllogistics/DeliveryNote.jrxml
./trunk/pnllogistics/images
./trunk/pnllogistics/images/postnl_logo.png
./trunk/pnllogistics/CARGO_EXTRACT_ScanreportWithInputParam.jrxml

[eric@localhost reports]$ svn add trunk/ --force

[eric@localhost reports]$ svn commit -m "PCT-435 Only the shipment item itself on which the event is, is reported" trunk/pnllogistics/CARGO_EXTRACT_Scanreport.jrxml trunk/pnllogistics/CARGO_EXTRACT_ScanreportWithInputParam.jrxml 
Adding  (bin)  trunk/pnllogistics/CARGO_EXTRACT_Scanreport.jrxml
Adding  (bin)  trunk/pnllogistics/CARGO_EXTRACT_ScanreportWithInputParam.jrxml
Transmitting file data ..
Committed revision 15.



/ Einde PCT-534 FIX

/ 13	. 

select *
from event_event evt
join event_type evt_ty on evt_ty.system_id = evt.event_type_systemid
    and evt_ty.name = 'J95'
join shipment_item shi on shi.system_id = evt.shipment_item_system_id
    and shi.reference1='3SHEVH0000001'
/ Is er	,

/ 13	. 

/ J27 event op collect en linehaul	: als shi in wh aankomt	, wordt hij gescanned	, 
/ J45 event als shi vertrekt uit sh naar linehaul	,




////////////////////////////////////////////////////////////////////////
/ VERSCHIL JOIN EN 'INNER" JOIN

/ 1313	.


select evt.system_id as evt,sa.system_id as sa,so.system_id as so,
	shi.system_id as shi,
	sa_dlv.system_id as sa_dlv
from event_event evt
join event_type et on et.system_id = evt.event_type_systemid 
	and et.name = 'J27'
join shipment_item shi on shi.system_id = evt.shipment_item_system_id 
	and shi.reference1='3SHEVC0013004'
left join service_order so on evt.service_order_systemid=so.system_id
left join service_action sa on evt.service_action_systemid=sa.system_id
left join shipment_order sho on shi.shipment_order_systemid=sho.system_id

left join service_action sa_dlv 
on sa_dlv.shipment_order_systemid=sho.system_id
join service_action_type sa_dlv_ty 
on sa_dlv.service_action_type_systemid=sa_dlv_ty.system_id
	and sa_dlv_ty.service_action_type='DELIVERY2'
left join consignment con_dlv on sa_dlv.consignment_systemid=con_dlv.system_id
left join service_order SO_DELIVERY on con_dlv.service_order_systemid=SO_DELIVERY.system_id

	and sa_dlv_ty.service_action_type='DELIVERY'
   evt    |    sa    |    so    |   shi    |  sa_dlv  
----------+----------+----------+----------+----------
 26827614 | 26827607 | 26827369 | 26827360 | 26827609
(1 row)

	and sa_dlv_ty.service_action_type='DELIVERY2'
 evt | sa | so | shi | sa_dlv 
-----+----+----+-----+--------
(0 rows)

/ ->

select evt.system_id as evt,sa.system_id as sa,so.system_id as so,
	shi.system_id as shi,
	sa_dlv.system_id as sa_dlv
from event_event evt
join event_type et on et.system_id = evt.event_type_systemid 
	and et.name = 'J27'
join shipment_item shi on shi.system_id = evt.shipment_item_system_id 
	and shi.reference1='3SHEVC0013004'
left join service_order so on evt.service_order_systemid=so.system_id
left join service_action sa on evt.service_action_systemid=sa.system_id
left join shipment_order sho on shi.shipment_order_systemid=sho.system_id

left join service_action sa_dlv 
join service_action_type sa_dlv_ty 
on sa_dlv.service_action_type_systemid=sa_dlv_ty.system_id
	and sa_dlv_ty.service_action_type='DELIVERY2'
on sa_dlv.shipment_order_systemid=sho.system_id
left join consignment con_dlv on sa_dlv.consignment_systemid=con_dlv.system_id
left join service_order SO_DELIVERY on con_dlv.service_order_systemid=SO_DELIVERY.system_id

	and sa_dlv_ty.service_action_type='DELIVERY
   evt    |    sa    |    so    |   shi    |  sa_dlv  
----------+----------+----------+----------+----------
 26827614 | 26827607 | 26827369 | 26827360 | 26827609
(1 row)

	and sa_dlv_ty.service_action_type='DELIVERY2'
   evt    |    sa    |    so    |   shi    | sa_dlv 
----------+----------+----------+----------+--------
 26827614 | 26827607 | 26827369 | 26827360 |       
(1 row)



/ 1313	.

/ we maken de volgende joins	,

evt-shi-sho-sa-so-sa_dlv-sa_dlvnote

/ shi , sa, so zijn uit de evt	, 
/ sho is uit de shi	,
/ sa_dlv is uit sho: een sho heeft een aantal sa's	, een van de evt, dat is sa	, en meerdere, zoals sa_dlv,	 sa_dlvnote	, 


/ 1313

///////////////////////////////////////////////////////////////////////////
/ INNER JOINS 

/ 131313

select evt.system_id as evt,shi.system_id as shi,sa.system_id as sa,so.system_id as so,
	sa_dlv.system_id as sa_dlv2,sa_dlv_ty.service_action_type
from event_event evt
join event_type et on et.system_id = evt.event_type_systemid 
	and et.name = 'J27'
join shipment_item shi on shi.system_id = evt.shipment_item_system_id 
	and shi.reference1='3SHEVC0013004'
left join shipment_order sho on shi.shipment_order_systemid=sho.system_id
left join service_order so on evt.service_order_systemid=so.system_id
left join service_action sa on evt.service_action_systemid=sa.system_id

left join service_action sa_dlv 
	join service_action_type sa_dlv_ty 
	on sa_dlv.service_action_type_systemid=sa_dlv_ty.system_id
	and sa_dlv_ty.service_action_type='DELIVERY2'
on sa_dlv.shipment_order_systemid=sho.system_id;
   evt    |   shi    |    sa    |    so    | sa_dlv2 | service_action_type 
----------+----------+----------+----------+---------+---------------------
 26827614 | 26827360 | 26827607 | 26827369 |         | 
(1 row)

/ en	,
...
left join service_action sa_dlv 
	join service_action_type sa_dlv_ty 
	on sa_dlv.service_action_type_systemid=sa_dlv_ty.system_id
	and sa_dlv_ty.service_action_type='DELIVERY'
on sa_dlv.shipment_order_systemid=sho.system_id;
   evt    |   shi    |    sa    |    so    | sa_dlv2  | service_action_type 
----------+----------+----------+----------+----------+---------------------
 26827614 | 26827360 | 26827607 | 26827369 | 26827609 | DELIVERY


/ 131313

/ VERSCHIL1

select 
	evt.system_id as evt,
	shi.system_id as shi,
	sa.system_id as sa,
	so.system_id as so,
	sho.system_id as sho,
	sa_dlv.system_id as sa_dlv2,
	sa_dlv_ty.service_action_type
from event_event evt
join event_type et on et.system_id = evt.event_type_systemid 
	and et.name = 'J27'
join shipment_item shi on shi.system_id = evt.shipment_item_system_id 
	and shi.reference1='3SHEVC0013004'
left join shipment_order sho on shi.shipment_order_systemid=sho.system_id
left join service_order so on evt.service_order_systemid=so.system_id
left join service_action sa on evt.service_action_systemid=sa.system_id

left join service_action sa_dlv on sa_dlv.shipment_order_systemid=sho.system_id
left join service_action_type sa_dlv_ty on sa_dlv.service_action_type_systemid=sa_dlv_ty.system_id
	and sa_dlv_ty.service_action_type='DELIVERY';

/ zonder sa_dlv, sa_dlv_ty	,
   evt    |   shi    |    sa    |    so    |   sho2   
----------+----------+----------+----------+----------
 26827614 | 26827360 | 26827607 | 26827369 | 26827349

/ met sa_dlv, sa_dlv_ty	,
   evt    |   shi    |    sa    |    so    |   sho    | sa_dlv2  | service_action_type 
----------+----------+----------+----------+----------+----------+---------------------
 26827614 | 26827360 | 26827607 | 26827369 | 26827349 | 26827607 | 
 26827614 | 26827360 | 26827607 | 26827369 | 26827349 | 26827609 | DELIVERY
 26827614 | 26827360 | 26827607 | 26827369 | 26827349 | 26827608 | 
 26827614 | 26827360 | 26827607 | 26827369 | 26827349 | 26827695 | 
(4 rows)

/ we zien 4 rows	, want de sho heeft 4 sa (so)	,
/ we zien left join: als links match met rechts	, print hij rechts de match	, anders print null 

/ als we	,
...
left join service_action sa_dlv on sa_dlv.shipment_order_systemid=sho.system_id
join service_action_type sa_dlv_ty on sa_dlv.service_action_type_systemid=sa_dlv_ty.system_id
	and sa_dlv_ty.service_action_type='DELIVERY';
   evt    |   shi    |    sa    |    so    |   sho    | sa_dlv2  | service_action_type 
----------+----------+----------+----------+----------+----------+---------------------
 26827614 | 26827360 | 26827607 | 26827369 | 26827349 | 26827609 | DELIVERY
(1 row)
/ want dan join je er maar 1 rij erbij	,

/ als we	,
...
left join service_action sa_dlv on sa_dlv.shipment_order_systemid=sho.system_id
left join service_action_type sa_dlv_ty on sa_dlv.service_action_type_systemid=sa_dlv_ty.system_id
	and sa_dlv_ty.service_action_type='DELIVERY2';
   evt    |   shi    |    sa    |    so    |   sho    | sa_dlv2  | service_action_type 
----------+----------+----------+----------+----------+----------+---------------------
 26827614 | 26827360 | 26827607 | 26827369 | 26827349 | 26827607 | 
 26827614 | 26827360 | 26827607 | 26827369 | 26827349 | 26827609 | 
 26827614 | 26827360 | 26827607 | 26827369 | 26827349 | 26827608 | 
 26827614 | 26827360 | 26827607 | 26827369 | 26827349 | 26827695 | 
(4 rows)

/ als we join	,
...
left join service_action sa_dlv on sa_dlv.shipment_order_systemid=sho.system_id
join service_action_type sa_dlv_ty on sa_dlv.service_action_type_systemid=sa_dlv_ty.system_id
    and sa_dlv_ty.service_action_type='DELIVERY2';
 evt | shi | sa | so | sho | sa_dlv2 | service_action_type 
-----+-----+----+----+-----+---------+---------------------
(0 rows)


/ 131313

/ we zien het verschil	,

select evt.system_id as evt,shi.system_id as shi,sa.system_id as sa,so.system_id as so,
    sa_dlv.system_id as sa_dlv2,sa_dlv_ty.service_action_type
from event_event evt
join event_type et on et.system_id = evt.event_type_systemid
    and et.name = 'J27'
join shipment_item shi on shi.system_id = evt.shipment_item_system_id
    and shi.reference1='3SHEVC0013004'
left join shipment_order sho on shi.shipment_order_systemid=sho.system_id
left join service_order so on evt.service_order_systemid=so.system_id
left join service_action sa on evt.service_action_systemid=sa.system_id

left join service_action sa_dlv
    join service_action_type sa_dlv_ty
    on sa_dlv.service_action_type_systemid=sa_dlv_ty.system_id
    and sa_dlv_ty.service_action_type='DELIVERY2'
on sa_dlv.shipment_order_systemid=sho.system_id;
   evt    |   shi    |    sa    |    so    | sa_dlv2 | service_action_type
----------+----------+----------+----------+---------+---------------------
 26827614 | 26827360 | 26827607 | 26827369 |         |
(1 row)

select evt.system_id as evt,shi.system_id as shi,sa.system_id as sa,so.system_id as so,sho.system_id as sho,
    sa_dlv.system_id as sa_dlv2,sa_dlv_ty.service_action_type
from event_event evt
join event_type et on et.system_id = evt.event_type_systemid
    and et.name = 'J27'
join shipment_item shi on shi.system_id = evt.shipment_item_system_id
    and shi.reference1='3SHEVC0013004'
left join shipment_order sho on shi.shipment_order_systemid=sho.system_id
left join service_order so on evt.service_order_systemid=so.system_id
left join service_action sa on evt.service_action_systemid=sa.system_id

left join service_action sa_dlv on sa_dlv.shipment_order_systemid=sho.system_id
left join service_action_type sa_dlv_ty on sa_dlv.service_action_type_systemid=sa_dlv_ty.system_id
    and sa_dlv_ty.service_action_type='DELIVERY2';
   evt    |   shi    |    sa    |    so    |   sho    | sa_dlv2  | service_action_type
----------+----------+----------+----------+----------+----------+---------------------
 26827614 | 26827360 | 26827607 | 26827369 | 26827349 | 26827607 |
 26827614 | 26827360 | 26827607 | 26827369 | 26827349 | 26827609 |
 26827614 | 26827360 | 26827607 | 26827369 | 26827349 | 26827608 |
 26827614 | 26827360 | 26827607 | 26827369 | 26827349 | 26827695 |
(4 rows)

/ INNER JOINS 
///////////////////////////////////////////////////////////////////////////



/ 1313	.

select sa_dlv.system_id as sa_dlv2,sa_dlv_ty.service_action_type
from service_action sa_dlv 
left join service_action_type sa_dlv_ty on sa_dlv.service_action_type_systemid=sa_dlv_ty.system_id
where sa_dlv.system_id=26827607;
 sa_dlv2  | service_action_type 
----------+---------------------
 26827607 | COLLECT
(1 row)



/ 1313

select evt.system_id as evt,shi.system_id as shi,sa.system_id as sa,so.system_id as so,sa_dlv.system_id as sa_dlv,sa_dlvnote.system_id as sa_dlvnote
--select sa_dlv.system_id,sa_dlv_ty.service_action_type
from event_event evt
join event_type et on et.system_id = evt.event_type_systemid 
	and et.name = 'J27'
left join shipment_item shi on shi.system_id = evt.shipment_item_system_id 
left join service_order so on evt.service_order_systemid=so.system_id
left join service_action sa on evt.service_action_systemid=sa.system_id

left join shipment_order sho on shi.shipment_order_systemid=sho.system_id

left join service_action sa_dlv 
	join service_action_type sa_dlv_ty 
	on sa_dlv.service_action_type_systemid=sa_dlv_ty.system_id
	and sa_dlv_ty.service_action_type='DELIVERY2'
on sa_dlv.shipment_order_systemid=sho.system_id
left join consignment con_dlv on sa_dlv.consignment_systemid=con_dlv.system_id
left join service_order SO_DELIVERY on con_dlv.service_order_systemid=SO_DELIVERY.system_id
--left join service_order_type seo_dlv_ty on SO_DELIVERY.service_order_type_systemid=seo_dlv_ty.system_id
--and seo_dlv_ty.service_order_type='DELIVERY'

left join service_action sa_dlvnote on sa_dlvnote.shipment_order_systemid=sho.system_id
join service_action_type sa_dlvnote_ty on sa_dlvnote.service_action_type_systemid=sa_dlvnote_ty.system_id
and sa_dlvnote_ty.service_action_type='DELIVERY_NOTE'
left join consignment con_dlvnote on sa_dlvnote.consignment_systemid=con_dlvnote.system_id
left join service_order SO_DELIVERY_NOTE on con_dlvnote.service_order_systemid=SO_DELIVERY_NOTE.system_id
--left join service_order_type seo_dlvnote_ty on SO_DELIVERY_NOTE.service_order_type_systemid=seo_dlvnote_ty.system_id
--and seo_dlvnote_ty.service_order_type='DELIVERY_NOTE'

where shi.reference1='3SHEVC0013004'
--and sa_dlv_ty.service_action_type='DELIVERY'
--and sa_dlvnote_ty.service_action_type='DELIVERY_NOTE';

/ 1313	.

/ orig

select evt.system_id as evt,shi.system_id as shi,sa.system_id as sa,so.system_id as so,sa_dlv.system_id as sa_dlv,sa_dlvnote.system_id as sa_dlvnote
--select sa_dlv.system_id,sa_dlv_ty.service_action_type
from event_event evt
join event_type et on et.system_id = evt.event_type_systemid 
	and et.name = 'J27'
left join shipment_item shi on shi.system_id = evt.shipment_item_system_id 
left join service_order so on evt.service_order_systemid=so.system_id
left join service_action sa on evt.service_action_systemid=sa.system_id

left join shipment_order sho on shi.shipment_order_systemid=sho.system_id

left join service_action sa_dlv on sa_dlv.shipment_order_systemid=sho.system_id
left join service_action_type sa_dlv_ty on sa_dlv.service_action_type_systemid=sa_dlv_ty.system_id
	and sa_dlv_ty.service_action_type='DELIVERY2'
left join consignment con_dlv on sa_dlv.consignment_systemid=con_dlv.system_id
left join service_order SO_DELIVERY on con_dlv.service_order_systemid=SO_DELIVERY.system_id
--left join service_order_type seo_dlv_ty on SO_DELIVERY.service_order_type_systemid=seo_dlv_ty.system_id
--and seo_dlv_ty.service_order_type='DELIVERY'

left join service_action sa_dlvnote on sa_dlvnote.shipment_order_systemid=sho.system_id
left join service_action_type sa_dlvnote_ty on sa_dlvnote.service_action_type_systemid=sa_dlvnote_ty.system_id
and sa_dlvnote_ty.service_action_type='DELIVERY_NOTE'
left join consignment con_dlvnote on sa_dlvnote.consignment_systemid=con_dlvnote.system_id
left join service_order SO_DELIVERY_NOTE on con_dlvnote.service_order_systemid=SO_DELIVERY_NOTE.system_id
--left join service_order_type seo_dlvnote_ty on SO_DELIVERY_NOTE.service_order_type_systemid=seo_dlvnote_ty.system_id
--and seo_dlvnote_ty.service_order_type='DELIVERY_NOTE'

where shi.reference1='3SHEVC0013004';
--and sa_dlv_ty.service_action_type='DELIVERY'
--and sa_dlvnote_ty.service_action_type='DELIVERY_NOTE';

/ 1313	.

/ kleiner	,

select evt.system_id as evt2,et.name as name2,shi.system_id as shi2,so.system_id as so2
from event_event evt
join event_type et on et.system_id = evt.event_type_systemid 
	--and et.name = 'J27'
left join shipment_item shi on shi.system_id = evt.shipment_item_system_id 
	--and shi.reference1='3SHEVC0013004'
left join service_order so on evt.service_order_systemid=so.system_id;
   evt2   | name2 |   shi2   |   so2    
----------+-------+----------+----------
 26682202 | OLH   |          | 26682198
 26786619 | J27   |          | 26786033
 26766220 | ePOD  |          | 26766214
 26772908 | J27   |          | 26772637
 26772909 | I01   |          | 26772637
 26772912 | J27   |          | 26772643
 26772913 | J27   |          | 26772643
 26683835 | FLH   |          | 26683282
 26682249 | ASC   |          | 26682219
 26682252 | OLH   |          | 26682224
 26682264 | ePOD  |          | 26682258
 26765256 | OLH   |          | 26765168
 26786624 | J27   |          | 26786620
 26682203 | FLH   |          | 26682198
 26786625 | J27   |          | 26786620
 26682253 | FLH   |          | 26682224
 26840387 | C01   |          | 26840042
 26682263 | POD   |          | 26682258
 26825142 | J45   | 26814651 | 26814597

/ we zien dat er events zijn	, ook J27's	, die geen shi hebben	, maar wel altijd een so	,

/ we doen	,

select evt.system_id as evt2,et.name as name2,shi.system_id as shi2,so.system_id as so2
from event_event evt
join event_type et on et.system_id = evt.event_type_systemid 
	and et.name = 'J27'
join shipment_item shi on shi.system_id = evt.shipment_item_system_id 
	and shi.reference1='3SHEVC0013004'
left join service_order so on evt.service_order_systemid=so.system_id;
/ of	,
select evt.system_id as evt2,et.name as name2,shi.system_id as shi2,so.system_id as so2
from event_event evt
join event_type et on et.system_id = evt.event_type_systemid 
	and et.name = 'J27'
left join shipment_item shi on shi.system_id = evt.shipment_item_system_id 
left join service_order so on evt.service_order_systemid=so.system_id
where shi.reference1='3SHEVC0013004'

/ de left join op de so kan net zo goed join	, omdat er altijd een so is op een event	,

select evt.system_id as evt2,et.name as name2,shi.system_id as shi2,so.system_id as so2,sa.system_id as sa2
from event_event evt
join event_type et on et.system_id = evt.event_type_systemid 
	and et.name = 'J27'
left join shipment_item shi on shi.system_id = evt.shipment_item_system_id 
	and shi.reference1='3SHEVC0013004'
left join service_order so on evt.service_order_systemid=so.system_id
left join service_action sa on evt.service_action_systemid=sa.system_id;
   evt2   | name2 |   shi2   |   so2    |   sa2    
----------+-------+----------+----------+----------
 26786619 | J27   |          | 26786033 | 26786613
 26772908 | J27   |          | 26772637 | 26772901
...
/ we zien dat er ook altijd een sa is op een event	, dus we kunnen altijd left join , is toch gelijk aan join	,

select evt.system_id as evt,shi.system_id as shi,sa.system_id as sa,so.system_id as so,sho.system_id as sho2 
from event_event evt
join event_type et on et.system_id = evt.event_type_systemid
    and et.name = 'J27'
join shipment_item shi on shi.system_id = evt.shipment_item_system_id
    and shi.reference1='3SHEVC0013004'
left join shipment_order sho on shi.shipment_order_systemid=sho.system_id
left join service_order so on evt.service_order_systemid=so.system_id
left join service_action sa on evt.service_action_systemid=sa.system_id;
   evt    |   shi    |    sa    |    so    |   sho2   
----------+----------+----------+----------+----------
 26827614 | 26827360 | 26827607 | 26827369 | 26827349
(1 row)
/ als er een shi , is er ook een sho	, dus dan kunnen we ook left join op sho	, = join 




/ 1313	.

/ kleiner	,

/ HIER HIER HIER

select evt.system_id as evt2,et.name as name2,shi.system_id as shi2,so.system_id as so2
from event_event evt
join event_type et on et.system_id = evt.event_type_systemid 
	and et.name = 'J27'
join shipment_item shi on shi.system_id = evt.shipment_item_system_id 
	and shi.reference1='3SHEVC0013004'
left join service_order so on evt.service_order_systemid=so.system_id;

left join shipment_order sho on shi.shipment_order_systemid=sho.system_id

left join service_action sa_dlv on sa_dlv.shipment_order_systemid=sho.system_id
left join service_action_type sa_dlv_ty on sa_dlv.service_action_type_systemid=sa_dlv_ty.system_id
	and sa_dlv_ty.service_action_type='DELIVERY2'
left join consignment con_dlv on sa_dlv.consignment_systemid=con_dlv.system_id
left join service_order SO_DELIVERY on con_dlv.service_order_systemid=SO_DELIVERY.system_id
--left join service_order_type seo_dlv_ty on SO_DELIVERY.service_order_type_systemid=seo_dlv_ty.system_id
--and seo_dlv_ty.service_order_type='DELIVERY'

left join service_action sa_dlvnote on sa_dlvnote.shipment_order_systemid=sho.system_id
left join service_action_type sa_dlvnote_ty on sa_dlvnote.service_action_type_systemid=sa_dlvnote_ty.system_id
and sa_dlvnote_ty.service_action_type='DELIVERY_NOTE'
left join consignment con_dlvnote on sa_dlvnote.consignment_systemid=con_dlvnote.system_id
left join service_order SO_DELIVERY_NOTE on con_dlvnote.service_order_systemid=SO_DELIVERY_NOTE.system_id
--left join service_order_type seo_dlvnote_ty on SO_DELIVERY_NOTE.service_order_type_systemid=seo_dlvnote_ty.system_id
--and seo_dlvnote_ty.service_order_type='DELIVERY_NOTE'


/ 1313	,

/ orig	, kleiner	,

select evt.system_id as evt,evt.event_type_systemid,et.system_id,et.name
from event_event evt
left join event_type et on et.system_id = evt.event_type_systemid
	and et.name = 'J27';
   evt    | event_type_systemid | system_id | name 
----------+---------------------+-----------+------
 26682202 |            26681711 |           | 
 26786619 |            26767126 |  26767126 | J27
...
/ we zien dat er bij evt  26682202 ern geen J27 evt type is	, we krijgen een null achter deze evt	, 

/ of	,
select evt.system_id as evt,evt.event_type_systemid,et.system_id,et.name
from event_event evt
left join event_type et on et.system_id = evt.event_type_systemid ;
   evt    | event_type_systemid | system_id | name 
----------+---------------------+-----------+------
 26682202 |            26681711 |  26681711 | OLH
 26786619 |            26767126 |  26767126 | J27
...

/ we zien dat er bij evt 26682202 er een OLH evt type is	, die krijgen we dan	, 

/ Doe join	, 
select evt.system_id as evt,evt.event_type_systemid,et.system_id,et.name
from event_event evt
join event_type et on et.system_id = evt.event_type_systemid 
	and et.name = 'J27';

/ 1313

select evt.system_id as evt2,et.name as name2,shi.system_id as shi2
from event_event evt
join event_type et on et.system_id = evt.event_type_systemid
    and et.name = 'J27'
left join shipment_item shi on shi.system_id = evt.shipment_item_system_id
	and shi.reference1='3SHEVC0013004';
   evt2   | name2 |   shi2   
----------+-------+----------
 26786619 | J27   |         
 26772908 | J27   |         
 26772912 | J27   |         
...


select evt.system_id as evt2,et.name as name2,shi.system_id as shi2
from event_event evt
join event_type et on et.system_id = evt.event_type_systemid
    and et.name = 'J27'
left join shipment_item shi on shi.system_id = evt.shipment_item_system_id
	and shi.reference1='3SHEVC0013004'
where shi.reference1 is not null;
   evt2   | name2 |   shi2   
----------+-------+----------
 26827614 | J27   | 26827360
(1 row)



/ 1313	.

/ orig,	 kleiner	,

select evt.system_id as evt,et.name,shi.system_id as shi
from event_event evt
join event_type et on et.system_id = evt.event_type_systemid 
	and et.name = 'J27'
left join shipment_item shi on shi.system_id = evt.shipment_item_system_id 
and shi.reference1='3SHEVC0013004';
left join service_action sa on evt.service_action_systemid=sa.system_id

left join shipment_order sho on shi.shipment_order_systemid=sho.system_id

left join service_action sa_dlv on sa_dlv.shipment_order_systemid=sho.system_id
left join service_action_type sa_dlv_ty on sa_dlv.service_action_type_systemid=sa_dlv_ty.system_id
	and sa_dlv_ty.service_action_type='DELIVERY2'
left join consignment con_dlv on sa_dlv.consignment_systemid=con_dlv.system_id
left join service_order SO_DELIVERY on con_dlv.service_order_systemid=SO_DELIVERY.system_id
--left join service_order_type seo_dlv_ty on SO_DELIVERY.service_order_type_systemid=seo_dlv_ty.system_id
--and seo_dlv_ty.service_order_type='DELIVERY'

left join service_action sa_dlvnote on sa_dlvnote.shipment_order_systemid=sho.system_id
left join service_action_type sa_dlvnote_ty on sa_dlvnote.service_action_type_systemid=sa_dlvnote_ty.system_id
and sa_dlvnote_ty.service_action_type='DELIVERY_NOTE'
left join consignment con_dlvnote on sa_dlvnote.consignment_systemid=con_dlvnote.system_id
left join service_order SO_DELIVERY_NOTE on con_dlvnote.service_order_systemid=SO_DELIVERY_NOTE.system_id
--left join service_order_type seo_dlvnote_ty on SO_DELIVERY_NOTE.service_order_type_systemid=seo_dlvnote_ty.system_id
--and seo_dlvnote_ty.service_order_type='DELIVERY_NOTE'

where shi.reference1='3SHEVC0013004';

/ HIER HIER HIER

/ 1313	. 

select sa_ty.service_action_type
from service_action sa
left join service_action_type sa_ty on sa.service_action_type_systemid=sa_ty.system_id
and sa.system_id=26827609;

--where sa_ty.service_action_type='DELIVERY';
--where sa.system_id=6827609;

/ 1313

select sa_ty.service_action_type
from service_action sa
left join service_action_type sa_ty on sa.service_action_type_systemid=sa_ty.system_id
and sa.system_id=26827609;

select count(sa.system_id)
from service_action sa
join service_action_type sa_ty 
on sa.service_action_type_systemid=sa_ty.system_id 
and sa_ty.service_action_type='DELIVERY';


--where sa_ty.service_action_type='DELIVERY';
--where sa.system_id=6827609;



/ 7	. 

/ Het verschil tussen CARGO_EXTRACT_Scanreport-V12.sql en CARGO_EXTRACT_ScanreportWithInputPram-V13.sql is alleen	,

join event_type et on et.system_id = ee.EVENT_TYPE_SYSTEMID and et.name = 'J95'
join event_type et on et.system_id = ee.EVENT_TYPE_SYSTEMID and et.name = '$CollectionDepot'

/ we doen	
$ vi pnl-db-a-pct-435.sh

#!/usr/bin/bash
transaction_date_start_date="2015-07-15 00:00:00.000"
transaction_dateEndDate="2015-08-10 00:00:00.000"
CollectionDepot="J27"

PGPASSWORD=h^Zgcyr\&Q psql -U vanderveldene -h  pnl-app-a.intermax.mp-objects.com pnllogistics <<SQL 
select 
...
join event_type et on et.system_id = ee.EVENT_TYPE_SYSTEMID and et.name = '$CollectionDepot'
...
where ee.closed_on between '$transaction_date_start_date' and  '$transaotion_dateEndDate)

$ ./pnl-db-a-pct-435.sh
...
(71 rows)
/ Klopt met die van Jan	,

/ 13	.

/ we specialize	,

$ ./pnl-db-a-pct-435.sh

Reference1="3SHEVC0013004"
/ of	,
Reference1="3SHEVH0000001"

select 
...
join event_type et on et.system_id = ee.EVENT_TYPE_SYSTEMID and et.name = '$CollectionDepot'
...
where ee.closed_on between '$transaction_date_start_date' and  '$transaotion_dateEndDate)
and shi.reference1='$Reference1'

/ 1313

Reference1="3SHEVC0013004"

 SH000002543       | Linda bv |          | 2404 VA        | 383         |               | BENELUXFREIGHT      |              | 3SHEVC0013004 | 2015-07-20 14:14:51.52  | LB                | 8000             | KlantOrderNummer: Q3S1 | N0003220                          | 2015-04-27 18:00:00                     | 0004             | J27              | Gesorteerd door depot        | N0003212                     | 9000                       | COLLECT                        | Depot Utrecht (International) |                     | ASA               | PEETERS          | Peeters Transportcentrale | 2015-07-20 14:52:36.381 | All sites administrator | 2015-07-20        | 3SHEVC0110001 |               | 2015-07-15       | 2015-08-10     |                              |                       | 
 SH000002544       | Linda bv |          | 2803DK         | 383         |               | BENELUXFREIGHT      |              | 3SHEVC0013004 | 2015-07-20 14:18:35.945 | LB                | 8000             | KlantOrderNummer: Q3S1 | N0003216                          | 2015-04-27 18:00:00                     | 0004             | J27              | Gesorteerd door depot        | N0003212                     | 9000                       | COLLECT                        | Depot Utrecht (International) |                     | ASA               | PEETERS          | Peeters Transportcentrale | 2015-07-20 14:52:36.381 | All sites administrator | 2015-07-20        | 3SHEVC0000001 |               | 2015-07-15       | 2015-08-10     | Verkeerd voorgemeld          | A03                   | 
(2 rows)

/ 1313	. 

Reference1="3SHEVH0000001"

 SH000002609       | Linda bv |          | 2803DK         | 383         |               | BENELUXFREIGHT      |              | 3SHEVH0000001 | 2015-07-28 14:33:39.16  | LB                | 8000             | KlantOrderNummer: Q3S1 | N0003511                          | 2015-04-27 18:00:00                     | 0001             | J27              | Gesorteerd door depot        | N0003509                     | 9000                       | COLLECT                        | Depot Dordrecht |                     | ASA               | PEETERS          | Peeters Transportcentrale | 2015-07-29 13:54:30.634 | All sites administrator | 2015-07-28        | 3SHEVH0000001 |               | 2015-07-15       | 2015-08-10     | Uitgesteld, gescand op depot | J95                   | Depot PostNL Utrecht
 SH000002611       | Linda bv |          | 2803DK         | 383         | p89           | BENELUXFREIGHT      |              | 3SHEVH0000001 | 2015-07-28 14:34:49.704 | LB                | 8000             | KlantOrderNummer: Q3S1 |                                   |                                         | 0001             | J27              | Gesorteerd door depot        | N0003509                     | 9000                       | COLLECT                        | Depot Dordrecht |                     | ASA               | PEETERS          | Peeters Transportcentrale | 2015-07-29 13:54:30.634 | All sites administrator | 2015-07-28        | 3SHEVI0000001 |               | 2015-07-15       | 2015-08-10     |                              |                       | 
 SH000002612       | Linda bv |          | 2803DK         | 383         |               | BENELUXFREIGHT      |              | 3SHEVH0000001 | 2015-07-28 14:36:23.325 | LB                | 8000             | KlantOrderNummer: Q3S1 | N0003519                          | 2015-04-27 18:00:00                     | 0001             | J27              | Gesorteerd door depot        | N0003509                     | 9000                       | COLLECT                        | Depot Dordrecht |                     | ASA               | PEETERS          | Peeters Transportcentrale | 2015-07-29 13:54:30.634 | All sites administrator | 2015-07-28        | 3SHEVJ0000001 |               | 2015-07-15       | 2015-08-10     |                              |                       | 
(3 rows)

/ 13	.

pnllogistics=> \d+ service_order_shipment_order
                      View "public.service_order_shipment_order"
         Column          |          Type          | Modifiers | Storage  | Description 
-------------------------+------------------------+-----------+----------+-------------
 service_order_systemid  | integer                |           | plain    | 
 service_order_id        | character varying(80)  |           | extended | 
 shipment_order_systemid | integer                |           | plain    | 
 shipment_order_id       | character varying(80)  |           | extended | 
 reference1              | character varying(255) |           | extended | 
 reference2              | character varying(255) |           | extended | 
View definition:
 SELECT so.system_id AS service_order_systemid,
    so.service_order_id,
    sho.system_id AS shipment_order_systemid,
    sho.shipment_order_id,
    sho.reference1,
    sho.reference2
   FROM shipment_order sho,
    service_action sa,
    consignment c,
    service_order so
  WHERE c.service_order_systemid = so.system_id AND sa.consignment_systemid = c.system_id AND sho.system_id = sa.shipment_order_systemid;

pnllogistics=> select * from service_order_shipment_order where shipment_order_id='SH000001927';
 service_order_systemid | service_order_id | shipment_order_systemid | shipment_order_id | reference1 | reference2 
------------------------+------------------+-------------------------+-------------------+------------+------------
               26785282 | N0001725         |                26785264 | SH000001927       | 3613       | 
               26785247 | N0001721         |                26785264 | SH000001927       | 3613       | 
               26785275 | N0001724         |                26785264 | SH000001927       | 3613       | 
               26785253 | N0001722         |                26785264 | SH000001927       | 3613       | 
(4 rows)
/ We zien de verschillende seo's (sa's) bij deze sho	,






	








/ Einde PCT-435 

/ POSTGRES

/ foo=> insert into dts values(null);
INSERT 0 1
foo=> select*from dts;
            t            
-------------------------
 1999-01-08 14:27:42.152
 
(2 rows)

foo=> select count(t)from dts;
 count 
-------
     1
(1 row)

/ Als een column null is 	, maakt count(t) en count(*) verscchil	,

/ Einde POSTGRES

/ SQL

drop table if exists s;
create table s(m int);
drop table if exists t;
create table t(n int);
drop table if exists st;
create table st(m int,n int);
insert into s values(1),(2);
insert into t values(11),(12);
insert into st values(1,11),(2,11),(2,12);

select s.m
from s
join st on s.m=st.m
join t on st.n=t.n
group by s.m
having count(s.m)>1
 m | count 
---+-------
 1 |     1
 2 |     2
(2 rows)

select s.m
from s
join st on s.m=st.m
join t on st.n=t.n
group by s.m
having count(s.m)>1;
 m 
---
 2
(1 row)

/ 7	.

/ Let op	,

foo=> select s.m,count(t.n)
foo-> from s
foo-> join st on s.m=st.m
foo-> join t on st.n=t.n
foo-> group by s.m,t.n
foo-> having count(s.m)>1
foo-> ;
 m | count 
---+-------
(0 rows)

foo=> select s.m,count(t.n)
from s
join st on s.m=st.m
join t on st.n=t.n
group by s.m,t.n
having count(s.m)>0;
 m | count 
---+-------
 1 |     1
 2 |     1
 2 |     1
(3 rows)

/ 7	. 

/ left join	, and

/ we zien in 	,

select *      
from s
left join st on s.m=st.m 
	and st.n=11;

/ dat als er voor een row links rechts geen passende row is, 	hij rechts null geeft	, 
/ dus of een passende rij, of nulls	,

/ 1313	.


foo=> select*from s;
 m 
---
 1
 2
 3
(3 rows)

foo=> select*from st;
 m | n  
---+----
 1 | 11
 2 | 11
 2 | 12
 4 | 11
(4 rows)

/ 1313	,

select *      
from st
left join s on s.m=st.m 
	and s.m=1;

foo=> select *      
from s
left join st on s.m=st.m
    and st.n=11;
 m | m | n  
---+---+----
 1 | 1 | 11
 2 | 2 | 11
 3 |   |   
(3 rows)

foo=> select *
from s
left join st on s.m=st.m
    and st.n=12;
 m | m | n  
---+---+----
 1 |   |   
 2 | 2 | 12
 3 |   |   
(3 rows)

foo=> select *
from s
left join st on s.m=st.m
    and st.n=123
foo-> ;
 m | m | n 
---+---+---
 1 |   |  
 2 |   |  
 3 |   |  
(3 rows)

/ 7	.

/ st links	,

foo=> select *      
from st
left join s on s.m=st.m 
    and s.m=1;
 m | n  | m 
---+----+---
 1 | 11 | 1
 2 | 12 |  
 4 | 11 |  
 2 | 11 |  
(4 rows)

foo=> select *
from st
left join s on s.m=st.m 
    and s.m=2;
 m | n  | m 
---+----+---
 1 | 11 |  
 2 | 12 | 2
 4 | 11 |  
 2 | 11 | 2
(4 rows)

foo=> select *
from st
left join s on s.m=st.m 
    and s.m=3;
 m | n  | m 
---+----+---
 1 | 11 |  
 2 | 12 |  
 4 | 11 |  
 2 | 11 |  
(4 rows)

foo=> select *
from st
left join s on s.m=st.m 
    and s.m=4;
 m | n  | m 
---+----+---
 1 | 11 |  
 2 | 12 |  
 4 | 11 |  
 2 | 11 |  
(4 rows)

/ 7	. 

/ we hebben rij add to s en st	,

foo=> select*from s;
 m 
---
 1
 3
 2
 2
(4 rows)

foo=> select*from st;
 m | n  
---+----
 1 | 11
 1 | 11
 2 | 11
 2 | 12
 2 | 12
 4 | 11
(4 rows)

foo=> select *      
from s
left join st on s.m=st.m
    and st.n=12;
 m | m | n  
---+---+----
 1 |   |   
 3 |   |   
 2 | 2 | 12
 2 | 2 | 12
 2 | 2 | 12
 2 | 2 | 12
(6 rows)

left join st on s.m=st.m
    and st.n=11;
 m | m | n  
---+---+----
 1 | 1 | 11
 1 | 1 | 11
 3 |   |   
 2 | 2 | 11
 2 | 2 | 11
(5 rows)


/ 7	. 

/ andere s, st	,

foo=> select*from s;
 m 
---
 1
 2
 3
 4
(4 rows)

foo=> select*from st;
 m | n  
---+----
 1 | 11
 1 | 11
 2 | 11
 2 | 12
 3 | 13
 3 | 14
(6 rows)

foo=> select *
from s
left join st on s.m=st.m
    and st.n=11;
 m | m | n  
---+---+----
 1 | 1 | 11
 1 | 1 | 11
 2 | 2 | 11
 3 |   |   
 4 |   |   
(5 rows)


foo=> select *      
from s
left join st on s.m=st.m
    and st.n=12;
 m | m | n  
---+---+----
 1 |   |   
 2 | 2 | 12
 3 |   |   
 4 |   |   
(4 rows)

/ 7	. 

drop table if exists s;
create table s(m int);
drop table if exists st;
create table st(m int,n int);
drop table if exists t;
create table t(n int,t char);
insert into s values(1),(2);
insert into st values(1,11),(1,12);
insert into t values(11,'a'),(12,'b');

/ 1313	, 

/ we willen het zo	,

select*
from s
left join st 
     join t 
     on st.n=t.n
     and t.t='c'
 on s.m=st.m
where s.m=1;
 m | m | n | n | t 
---+---+---+---+---
 1 |   |   |   | 
(1 row)

select*
from s
left join st 
     join t 
     on st.n=t.n
     and t.t='a'
 on s.m=st.m
where s.m=1;
 m | m | n  | n  | t 
---+---+----+----+---
 1 | 1 | 11 | 11 | a

/ 1313	,

/ Kunnen we het zonder de nested join	?

/ Deze lijkt goed	, maar als er geen join is met 'c'	, dan zien we helemaal geen rij	, en dat is niet de bedoeling	,

select*
from s
left join st on s.m=st.m
join t on st.n=t.n
	and t.t='a'
where s.m=1;
 m | m | n  | n  | t 
---+---+----+----+---
 1 | 1 | 11 | 11 | a
(1 row)

select*
from s
left join st on s.m=st.m
join t on st.n=t.n
    and t.t='c'
where s.m=1;
 m | m | n | n | t 
---+---+---+---+---
(0 rows)




/ 1313	,

/ overig	, 

select*
from s
left join st on s.m=st.m
left join t on st.n=t.n
    and t.t='c'
where s.m=1
;
 m | m | n  | n | t 
---+---+----+---+---
 1 | 1 | 11 |   | 
 1 | 1 | 12 |   | 

select*
from s
left join st on s.m=st.m
left join t on st.n=t.n
    and t.t='a'
where s.m=1;
m | m | n  | n  | t 
---+---+----+----+---
 1 | 1 | 11 | 11 | a
 1 | 1 | 12 |    | 

select*
from s
left join st on s.m=st.m
join t on st.n=t.n
	and t.t='a'
where s.m=1

select*
from s
left join st on s.m=st.m
join t on st.n=t.n
    --and t.t='a'
where s.m=1;
 m | m | n  | n  | t 
---+---+----+----+---
 1 | 1 | 11 | 11 | a
 1 | 1 | 12 | 12 | b

select*
from s
left join st on s.m=st.m
left join t on st.n=t.n
    --and t.t='a'
where s.m=1;
 m | m | n  | n  | t 
---+---+----+----+---
 1 | 1 | 12 | 12 | b
 1 | 1 | 11 | 11 | a

select*
from s
join st on s.m=st.m
join t on st.n=t.n
    --and t.t='a'
where s.m=1;

foo=> select*
foo-> from s
foo-> join st on s.m=st.m
foo-> join t on st.n=t.n
foo->     --and t.t='a'
foo-> where s.m=1;
 m | m | n  | n  | t 
---+---+----+----+---
 1 | 1 | 11 | 11 | a
 1 | 1 | 12 | 12 | b
(2 rows)



/ Einde SQL


/ POSTGRES 

REASSIGN OWNED

/ Einde POSTGRES 

/ BACKUP

/ we hebben open	,
LOG_6_OCT_2014.txt
LOG_8_sep_2014.txt	/ wicket study	,
LOG_23_jul_2015.txt
LOG_10_aug.txt 		/ deze, meeswt recent	,

[eric@localhost eclipse-jee-test]$ pwd
/home/eric/Devel/Java/Eclipse/eclipse-jee-test
/home/eric/Devel/Java/Eclipse/eclipse-jee
/home/eric/Devel/Java/Eclipse/eclipse-jee/workspace/trunk
/home/eric/Devel/Java/JBoss/jboss-4.0.5.GA/server/pnllogistics
/home/eric/Devel/Interfaces/2015.01_mpo
/home/eric/Devel/Java/ActiveMQ/apache-activemq-5.10.1

/home/eric/Devel/Postgres/scripts/SCS/Rapport					/ report dat sneller moest	,
/home/eric/Devel/Reports										/ PCT-534
/home/eric/Devel/Postgres/Backup								/ backups van db's

/home/eric/Devel/Java/Tomcat/apache-tomcat-7.0.57
/home/eric/Devel/Java/Wicket/wicket
/home/eric/Devel/Java/Wicket/apache-wicket-1.4.23

/home/eric/Devel/Java/Spring/spring-test-first
/home/eric/Devel/Java/Mockito/mockito

/home/eric/Devel/Java/Camel/camelinaction/chapter2/spring-my
/home/eric/Devel/Interfaces/2015.01_mpo/SHO.xml

/home/eric/Devel/Java/Ehcache
/home/eric/Devel/Postgres/scripts
/home/eric/Devel/Java/Wicket/wicket


/ we hebben 
~/Devel/LOGS

[root@localhost eric]# rsync -avz Devel /run/media/eric/WD/mpo//home/eric/


/ Einde BACKUP

/ PCT-609

$ vi language_en_GB_pnllogistics.properties
pnllogistics.table_shipment_order_billto.name2=Contact

$ vi sho-billto.tag
<%@taglib prefix="cf" uri="/WEB-INF/tld/core-functions.tld"%>
				<c:if test="${cf:property('oms', 'shipmentorder.billto.party.contact.hidden', 'true')=='false'}">
					<mpo:field name="contactName" />
				</c:if>

$ vi core-functions.tld 
<function>
	<name>property</name>
    <function-class>com.mpobjects.core.ApplicationPropertyManager</function-class>
    <function-signature>
        java.lang.String  taglibGetProperty(java.lang.String,java.lang.String,java.lang.String)
    </function-signature>
</function>

/ Enter in property db	,
module.oms.shipmentorder.billto.party.contact.hidden=true

/ we zien dat gedaan wordt	,
commit -m "In billto part of the shipment order form:..." /home/eric/Devel/Java/Eclipse/eclipse-jee/workspace/trunk/module/oms/war/WEB-INF/tags/oms/sho-billto.tag

/ we deploy naar test	,
/ we moeten jericho-html-3.3.jar copy naar test	,
[eric@localhost pnllogistics]$ scp lib/jericho-html-3.3.jar vanderveldene@pnl-app-t.intermax.mp-objects.com:/tmp
h^Zgcyr&Q
/ op test	,
[jboss@pnl-app-t lib]$ cp /tmp/jericho-html-3.3.jar .

/ Einde PCT-609

/ PCT-607

$ vi shipment-order_edit.jsp

						<c:if test="${cf:property('oms', 'shipmentorder.remarks2.hidden', 'true')=='false'}">
							<mpo:textField languageKey="shipmentorder.remarks2" name="remarks2" overRideable="true" readOnly="${!remarks2Editable}" />
						</c:if>

$ vi language_en_GB_pnllogistics.properties
pnllogistics.table_shipment_order_shipmentorder.remarks2=Memo

ommitted revision 20678.

/ Einde PCT-607

/ PCT-612

/ See login 
User id: VanBeek
Role: R_KLANT 
password: pnlc
Onderin properties:
bill.to.partyid: 10169348

/ Dat betekent dat deze login alleen de orders van billto party 10169348 kan zien	,
/ TODO

[eric@localhost pnllogistics]$ pnl-db-a-pg.sh 
pnllogistics=> select*from tms_user where user_id='VanBeek';
 system_id | user_id |          user_name          | user_email_address | is_enabled | is_deleted |       last_login        | login_
attempt | is_first_login |  last_password_update   | chargeable | grace_login | created_by | created_on | user_password | is_interfa
ce_account | user_reference1 | user_reference2 | local_account | time_zone 
-----------+---------+-----------------------------+--------------------+------------+------------+-------------------------+-------
--------+----------------+-------------------------+------------+-------------+------------+------------+---------------+-----------
-----------+-----------------+-----------------+---------------+-----------
  26850005 | VanBeek | Klant Van Beek Art Supplies |                    |          1 |          0 | 2015-08-31 13:18:28.402 |       
      0 |              0 | 2015-08-31 13:17:21.622 |          1 |           0 |   26680352 | 2015-08-31 | pnlc          |           
         0 |                 |                 |             1 | 
(1 row)

/ 7	. 

/ we maken local ook deze user	,

/ see configuration, administration	, business object
/ customerorder hebben we al	,
/ see configuration, administration	, privilege type
/ list is er al	, 

/ see configuration, administration	, privilege	, 
/ we moeten de privilege customerorder.list maken	, (dit is business object.privilege type)	,
/ click 'create a new entry'
/ kies customerorder	, list	,
Save


/ we moeten eerst de R_KLANT role create	,
/ see configuration, administration	, role	, 
Name: R_KLANT
...
Selected privileges: 
customerorder.view
customerorder.list

Save and close:
org.springframework.dao.InvalidDataAccessApiUsageException: detached entity passed to persist: com.mpobjects.oms.model.privilegeentity.vo.PrivilegeVO; nested exception is org.hibernate.PersistentObjectException: detached entity passed to persist: com.mpobjects.oms.model.privilegeentity.vo.PrivilegeVO

/ check	,
gistics3=# select*from privilege p join business_object b on p.business_object_systemid=b.system_id join privilege_type t on p.privilege_type_systemid=t.system_id where b.name='customerorder';
 system_id | business_object_systemid | privilege_type_systemid |                   description                   | is_deleted | sys
tem_id |     name      |     description      | is_deleted | system_id | name |                     description                     
| is_deleted 
-----------+--------------------------+-------------------------+-------------------------------------------------+------------+----
-------+---------------+----------------------+------------+-----------+------+-----------------------------------------------------
+------------
  25825394 |                 25825393 |                       9 | access to track & treace screen                 |          0 |  25
825393 | customerorder | track & trace screen |          0 |         9 | view | View a record (edit /create form in readonly mode?) 
|          0
  26849099 |                 25825393 |                       2 | Access for customer order view (execution menu) |          0 |  25
825393 | customerorder | track & trace screen |          0 |         2 | list |                                                     
|          0
(2 rows)

/ de role van de user 'VanBeek'	,
pnllogistics=>  select r.* from user_role ur join tms_user u on ur.user_systemid=u.system_id join tms_role r on ur.role_systemid=r.system_id where u.user_id='VanBeek';
 system_id |  name   |          description          | role_weight | charge_type | is_deleted | account_exp | password_exp | session
_timeout | grace_logins 
-----------+---------+-------------------------------+-------------+-------------+------------+-------------+--------------+--------
---------+--------------
  26850003 | R_KLANT | Role for customer (of PostNL) |           0 | LIGHT       |          0 |             |              |        
       0 |           -1
(1 row)

/ op acceptance	,
pnllogistics=> select p.*from privilege p  join role_privilege rp on p.system_id=rp.privilege_systemid join tms_role r on r.system_id=rp.role_systemid where  r.name='R_KLANT';
 system_id | business_object_systemid | privilege_type_systemid |                   description                   | is_deleted 
-----------+--------------------------+-------------------------+-------------------------------------------------+------------
  25825394 |                 25825393 |                       9 | Access to track & trace screen                  |          0
  26850004 |                 25825393 |                       2 | Access for customer order view (execution menu) |          0
(2 rows)

/ local	,
pnllogistics3=# select p.*  from privilege p join    business_object b on p  .business_object_systemid = b .system_id join privilege_type t on p. privilege_type_systemid=t.system_id where b.name='customerorder' and t.name in ('list', 'view'); system_id | business_object_systemid | privilege_type_systemid |                   description                   | is_deleted 
-----------+--------------------------+-------------------------+-------------------------------------------------+------------
  25825394 |                 25825393 |                       9 | access to track & treace screen                 |          0
  26849099 |                 25825393 |                       2 | Access for customer order view (execution menu) |          0
(2 rows)

pnllogistics3=#  select r.*,p.*,b.*,t.* from tms_role r join role_privilege rp on r.system_id=rp.role_systemid join  privilege p on p.system_id=rp.privilege_systemid join business_object b on p.business_object_systemid=b.system_id join privilege_type t on p.privilege_type_systemid=t.system_id where r.name='R_KLANT';
 system_id |  name   | description | role_weight | charge_type | is_deleted | account_exp | password_exp | session_timeout | grace_l
ogins | system_id | business_object_systemid | privilege_type_systemid |                   description                   | is_delete
d | system_id |     name      |     description      | is_deleted | system_id | name |                     description              
       | is_deleted 
-----------+---------+-------------+-------------+-------------+------------+-------------+--------------+-----------------+--------
------+-----------+--------------------------+-------------------------+-------------------------------------------------+----------
--+-----------+---------------+----------------------+------------+-----------+------+----------------------------------------------
-------+------------
  26849106 | R_KLANT |             |           0 | LIGHT       |          0 |             |              |               0 |        
   -1 |  25825394 |                 25825393 |                       9 | access to track & treace screen                 |          
0 |  25825393 | customerorder | track & trace screen |          0 |         9 | view | View a record (edit /create form in readonly 
mode?) |          0
  26849106 | R_KLANT |             |           0 | LIGHT       |          0 |             |              |               0 |        
   -1 |  26849099 |                 25825393 |                       2 | Access for customer order view (execution menu) |          
0 |  25825393 | customerorder | track & trace screen |          0 |         2 | list |                                              
       |          0
(2 rows)

[eric@localhost Postgres]$ PGPASSWORD=mpopostgres@mpo pg_dump -U mpopostgres -Fc -h localhost pnllogistics3 -f pnllogistics3_2015.09.08.dump
[eric@localhost ShortTests]$ PGPASSWORD='h^Zgcyr&Q'  psql -U vanderveldene -Fc -h pnl-app-t.intermax.mp-objects.com pnltms



/ Wat we doen is,	

/ GIVE ROLE EXISTING PRIVILEGES BY HAND

/ we hebben tms_role R_KLANT create met GUI	,

pnllogistics3=# insert into role_privilege select r.system_id,p.system_id from tms_role r cross join privilege p join    business_object b on p  .business_object_systemid = b .system_id join privilege_type t on p. privilege_type_systemid=t.system_id where b.name='customerorder' and t.name in ('list', 'view') and r.name='R_KLANT';
INSERT 0 2



/nu ook local	,
pnllogistics3=# select p.*from privilege p  join role_privilege rp on p.system_id=rp.privilege_systemid join tms_role r on r.system_id=rp.role_systemid where  r.name='R_KLANT'; 
system_id | business_object_systemid | privilege_type_systemid |                   description                   | is_deleted 
-----------+--------------------------+-------------------------+-------------------------------------------------+------------
  25825394 |                 25825393 |                       9 | access to track & treace screen                 |          0
  26849099 |                 25825393 |                       2 | Access for customer order view (execution menu) |          0
(2 rows)

/ Met reload config zagen we in de GUI  NIET de beide privileges in de role R_KLANT	, 
/ Maar we moesten restart	, toen OK	,



/ 7	. 

/ we login met ssh op acceptance	, en login de db met de user:pw uit postgres.xml	,

$ pnl-ssh-a.sh
h^Zgcyr&Q
$ psql -h localhost -U pnllogistics
Password for user pnllogistics:RHKKxd-xFqvC4UibbW2ylnnK8H2BNWAH

/ 7	. 

/ Scherm

/ Execution, customer order view	,
customer-order_list

$ vi  pnllogistics-sitemap.xmap

		<map:action name="customerOrderList" src="com.mpobjects.oms.control.customerorder.action.CustomerOrderListAction"/>
	<map:pipeline>
			<map:match pattern="customer-order_list">
				<map:act type="customerOrderList"/>
				<map:call resource="dynatablePage">
					<map:parameter name="xsp" value="xsp/customer-order_list.xml"/>
				</map:call> 
			</map:match>	
			<map:match pattern="customer-order_view">
				<map:read type="jsp" src="../oms/jsp/customer-order_view-wicket.jsp"/>		
			</map:match>


/ De query wordt in de XSP gedaan	,
        String myQuery =             "SELECT S.* FROM SHIPMENT_ORDER S " +
            "WHERE IS_TEMPLATE = 0  AND ORGANIZATION_SYSTEMID IN {USER_ORGANIZATIONS} and INVOICE_PARTY_ID like '%" + ApplicationPropertyManager.getInstance().getProperty("bill.to.partyid","") + "%' " +
            "-#2 AND TO_COUNTRY_SYSTEMID IN (SELECT SYSTEM_ID FROM COUNTRY WHERE ?)#-"+
            "-#3 AND STATUS_CODE_SYSTEMID IN (SELECT SYSTEM_ID FROM ORDER_STATUS WHERE ?)#-" +
            "-#4 AND HOLD_STATUS_SYSTEMID IN (SELECT SYSTEM_ID FROM HOLD_STATUS WHERE ?)#-" +
            "-#5 AND STATUS_CODE_SYSTEMID IN (SELECT SYSTEM_ID FROM ORDER_STATUS WHERE ?)#-" +
            "-#6 AND SYSTEM_ID IN (SELECT SHIPMENT_ORDER_SYSTEMID FROM TMS_PRODUCT_ITEM WHERE ?)#-";
...
       <xsp:logic>
            ShipmentOrderView myView = new ShipmentOrderView();
            Collection myList = myView.executeDynaQuery(myTable.getDynaQuery());
/s
public class ShipmentOrderView extends AbstractView {
	public Collection executeDynaQuery(DynaQuery aQuery) throws AbstractException {
		LOG.debug("in executeDynaQuery");
		try {
			return getDao().executeDynaQuery(aQuery);
/s
public class ShipmentOrderDaoImpl extends AbstractMonitoringDashboardEntityDAO<ShipmentOrderVO> implements ShipmentOrderDao {
	@Override
	public List<ShipmentOrderVO> executeDynaQuery(DynaQuery aQuery) throws ShipmentOrderException {
		String mySql = aQuery.toSQL();
/ parses this query	,

/ we zien onder Filters WH toevallig edit button	, = customer-order_view	,
/ waar created?
$ vi generic-dynatablepage.xsl
...
/ TODO
$ vi dynatable.xsl
...
/ TODO

/ see cocoon.xconf	,
/ TODO

/ customer-order_view geeft de JSP	,

$ vi customer-order_view-wicket.jsp

<%@taglib prefix="ctf" tagdir="/WEB-INF/tags/core/" %>
<%@taglib prefix="ttf" tagdir="/WEB-INF/tags/oms/"%>

	<ctf:pageBody>	
		<script type="text/javascript">
			document.location.href="../wicket?module=oms&wicketpage=shipmentorder.coview.CustomerOrderViewPageWrapper&systemId=${param.systemid}";
		</script>
	</ctf:pageBody>

[eric@localhost trunk]$ ls  ./base-framework/core/war/WEB-INF/tags/core/
pageBody.tag  pageHeader.tag  page.tag  userLoginBody.tag
[eric@localhost trunk]$ ls module/oms/war/WEB-INF/tags/oms
containers.tag                  party-group-query-type.tag          sho-customerorders.tag       tab-sa-consignments.tag
dashboard-query-type.tag        party-partyprenotificationrule.tag  sho-employeeresponsible.tag  tab-sa-receipts.tag
edit-parties.tag                resources.tag                       sho-party.tag                tab-sa-route.tag
entity-detail-list.tag          shipfrom-readonly.tag               sho-productitems.tag         tab-sa-serviceactions.tag
googlemap.tag                   shipfrom.tag                        sho-shipmentitems.tag        workload-dashboard-query-type.tag
order-dashboard-query-type.tag  shipto-readonly.tag                 sho-simpleshipmentitems.tag  xmldocuments.tag
order-instructions.tag          shipto.tag                          sho-template-party.tag
pagination_util.tag             sho-billto.tag                      sho-tracing.tag
party-documents.tag             sho-containers.tag                  so-party.tag

/we click een edit button op een row in de list	,
/s
$ vi CustomerOrderViewPageWrapper.html
<wicket:extend>
	<div wicket:id="customerorder"></div>
</wicket:extend>

$ vi CustomerOrderViewPageWrapper.java
	public CustomerOrderViewPageWrapper() {
		...
		myPage = new CustomerOrderViewPanel("customerorder");

$ vi CustomerOrderViewPanel.html
	<div wicket:id="shipmentordertab"></div>
	<div wicket:id="partytab"></div>
	<div wicket:id="shoplanningtab"></div>
	<div wicket:id="unitproducttab"></div>
	<div wicket:id="eventtab"></div>
	<form wicket:id ="form">
		<button  class="icon icon_cancel" wicket:id="back">Back</button>
	</form>

$ vi CustomerOrderViewPanel.java
/s
	public CustomerOrderViewPanel(String aName) {
		super(aName);
		model = new CompoundPropertyModel<ShipmentOrderVO>(new EntityDetachableModel<ShipmentOrderVO>(null, new BeanWrapper<ShipmentOrderDao>( ShipmentOrderDao.class)));
		createPage();
/s
	protected void createPage() {
		add(new ShipmentOrderTabPanel("shipmentordertab", model));
/s
$ vi ShipmentOrderTabPanel.html
<wicket:panel>
	<div wicket:id="tabs" class="tabpanel">[tabbed panel will be here]</div>
</wicket:panel>
$ vi ShipmentOrderTabPanel.java
	public ShipmentOrderTabPanel(String aId, final IModel<ShipmentOrderVO> aModel) {
		tabbedPanel = new TabbedPanel("tabs", tabs);
		add(tabbedPanel);
		tabs.add(new AbstractTab(new StringResourceModel("shipmentorder", aModel)) {
/ title op de tab	,
			@Override
			public Panel getPanel(String panelId) {
->				return new ShoDetailViewPanel(panelId, aModel);
/ we vallen hierin in renderring fase	,
ShipmentOrderTabPanel$1.getPanel(String) line: 42	
TabbedPanel.setSelectedTab(int) line: 356	
TabbedPanel.onBeforeRender() line: 241	
...
/s
$ vi ShoDetailViewPanel.html
	...
						<td class="panel-field" colspan="2"><span wicket:id="reference1" /></td>
$ vi ShoDetailViewPanel.java
	public ShoDetailViewPanel(String aId, IModel<ShipmentOrderVO> aModel) {
		...
		init();
/s
	protected void init() {
		addReferenceField(new Label("reference1", new PropertyModel<String>(model, "reference1")));

/ Intermezzo

		addReferenceField(new Label("reference1", new PropertyModel<String>(model, "reference1")));
		add(new Label("shipmentOrderId", new PropertyModel<String>(model, "shipmentOrderId")));
		add(new Label("incoterms", new PropertyModel<String>(model, "incoTermVO.code")));
		addRequestedDate("requestedStartAfter");


/ leads to lookup in de locale file	,
"shipmentorder.reference1.pnllogistics.lb"
"shipmentorder.shipmentOrderId"
/ TODO
"shipmentorder.incoterms"
/ TODO
"shipmentorder.requestedStartAfter.pnllogistics.lb"

$ vi ShipmentOrderTabPanel.java
		tabs.add(new AbstractTab(new StringResourceModel("shipmentorder", aModel)) {
			@Override
			public Panel getPanel(String panelId) {
				return new ShoDetailViewPanel(panelId, aModel);
panelId="shipmentOrder"
/s
public class ShoDetailViewPanel extends AbstractShipmentOrderViewPanel {
	public ShoDetailViewPanel(String aId, IModel<ShipmentOrderVO> aModel) {
		super(aId, aModel);
		init();
	}
	protected void init() {
		add(new Label("shipmentOrderId", new PropertyModel<String>(model, "shipmentOrderId")));

/ MISSCHIEN dat omdat aId="shipmentorder"	, de key "shipmentOrder.shipmentOrderId"	,
/ TODO


/ Einde Intermezzo

	protected void addReferenceField(Label aLabel) {
/ doet	,
/ 1. is hidden? via property (resource, db, file)
/ 2	. 
/s
	protected void addReferenceField(Label aLabel) {
aLabel	Label  (id=18462)	
	data	PropertyModel  (id=18463)	
		expression	"reference1" (id=18464)	
		target	CompoundPropertyModel  (id=18460)	
			target	EntityDetachableModel  (id=18465)	
				dao	BeanWrapper  (id=18466)	
				entity	ShipmentOrderVO_$$_javassist_139  (id=18467)	
				systemId	26845712	
	id	"reference1" (id=18464)	
		boolean myHidden = ApplicationPropertyManager.getInstance().getProperty("module.oms.shipmentorder." + aLabel.getId() + ".hidden", false);
/s
ApplicationPropertyManager.getProperty(String, boolean) line: 522	
aKey=module.oms.shipmentorder.reference1.hidden
		String myValue = getProperty(aKey, NOTSET);
/s
ApplicationPropertyManager.getProperty(String, String) line: 531	
		Resource myResource = AuthenticationUtils.getResource();
eric
		if (myResource != null) {
			myReturnValue = myResource.getProperty(aKey);
null
			if (myReturnValue == null) {
				myReturnValue = getDatabaseProperty(aKey, null);
null
			}
		}

		if (myReturnValue == null) {
 			myReturnValue = getApplicationProperty(aKey, aDefaultValue);
/ uit een file	,
/ TODO
aDefaultValue="notset"
...
/t
ShoDetailViewPanel(AbstractShipmentOrderViewPanel).addReferenceField(Label) line: 38	
		boolean myHidden = ApplicationPropertyManager.getInstance().getProperty("module.oms.shipmentorder." + aLabel.getId() + ".hidden", false);
false
		add(aLabel);
		add(new Label(aLabel.getId() + ".label", new StringResourceModel("shipmentorder." + aLabel.getId() + "." + baseProduct + "." + processType, model)));
/= StringResourceModel("shipmentorder.reference1.pnllogistics.lb")
/ consults LanguageManagerStringResourceLoader, consults  WicketLanguageManager	, consults language file	,


/ Intermezzo

$ vi ApplicationUtils.java
		IResourceSettings myResourceSettings = anApplication.getResourceSettings();
		myResourceSettings.addStringResourceLoader(4, new LanguageManagerStringResourceLoader());

$ vi LanguageManagerStringResourceLoader.java
	@Override
	public String loadStringResource(Component aComponent, String aKey) {
aComponent	Label  (id=4175)	
aKey	"shipmentorder.reference1.pnllogistics.lb" (id=4176)	

/ In render fase	,

			if (aComponent != null) {
				return getLanguageManager().getTranslation(aComponent.getClass().getSimpleName(), aKey, aComponent.getLocale(), aComponent.getStyle(), true);
/s
WicketLanguageManager.getTranslation(String, String, Locale, String, boolean) line: 26	
/=
	public String getTranslation(String aPrefix, String aKey, Locale aLocale, String aStyle, boolean aThrowExceptionIfNotFound) {
this	WicketLanguageManager  (id=19711)	
aPrefix	"Label" (id=19712)	
aKey	"shipmentorder.reference1.pnllogistics.lb" (id=4176)	
aLocale	Locale  (id=19713)										en_GB_pnllogistics
aStyle	null	
aThrowExceptionIfNotFound	true	
			myFullKey = (aPrefix + SEPARATOR + aKey).toLowerCase();
"label.shipmentorder.reference1.pnllogistics.lb"
			myResult = fetchTranslation(myFullKey, aLocale, aStyle);
null
			return get(aKey, aLocale, aStyle, aThrowExceptionIfNotFound);
/s
WicketLanguageManager.get(String, Locale, String, boolean) line: 73	
		String myFullCode = aFullCode.toLowerCase();
		String result = fetchTranslation(myFullCode, aLocale, aStyle);
myFullCode	"shipmentorder.reference1.pnllogistics.lb" (id=4176)	
result	"Requested Productcode" (id=19837)	




/ Einde Intermezzo

/t
CustomerOrderViewPanel.createPage() line: 50	
		add(new ShipmentOrderTabPanel("shipmentordertab", model));
/d
		myPartyTab = new PartyMainPanel("partytab");
/ Nu worden keys zoals
	party.name

/ opgezocht	,
/ / TODO

		ShoPlanningTabPanel shoPlanningTabPanel = new ShoPlanningTabPanel("shoplanningtab", model) {
		add(shoPlanningTabPanel);
	j
		add(new EventTabPanel("eventtab", model));
/s
public class EventTabPanel extends Panel {
	public EventTabPanel(String aId, final IModel<ShipmentOrderVO> aModel) {

		boolean myHideEventServiceactions = ApplicationPropertyManager.getInstance().getProperty("module.oms.shipmentorderview.eventserviceactions.hidden", false);
		if (!myHideEventServiceactions) {
			tabs.add(new AbstractTab(new StringResourceModel("events-serviceactions", aModel)) {
				@Override
				public Panel getPanel(String panelId) {
					return new ServiceActionEventListViewPanel(panelId, aModel);
				}
			});
		}

/s
public class ServiceActionEventListViewPanel extends AbstractShipmentOrderViewPanel {
	protected void init() {
		...
		Label planningStartLabel = new Label("plannedStart", new StringResourceModel("Pln.Start", model)) {
		Label planningEndLabel = new Label("plannedEnd", new StringResourceModel("Pln.End", model)) {
		add(planningStartLabel);
		add(planningEndLabel);

$ vi language_en_GB_pnllogistics.properties
pln.start=[Start]
pln.end=[End]



/ Einde PCT-612

/ PCT-635

/ Tarakesh edited pnllogistics-service.sb.xml	,

	<bean id="-com.mpobjects.oms.model.service.ShipmentOrderServiceImpl" class="com.mpobjects.pnllogistics.model.shipmentorder.service.PnlLogisticsShipmentOrderServiceImpl">
		<!-- DO NOT USE THIS BEAN. This construction exists only to solve the circular dependency problem with ProxyFactoryBeans -->
		<property name="customerOrderLineDAO" ref="com.mpobjects.oms.dao.customerorderline.CustomerOrderLineDAO" />
		<property name="customerOrderLineService" ref="com.mpobjects.oms.service.customerorder.CustomerOrderLineService" />
		<property name="eventHandlerService" ref="com.mpobjects.oms.service.event.EventHandlerService" />
		<property name="calculationService" ref="com.mpobjects.oms.service.calculation.OmsCalculationService" />
		<property name="orderStatusDAO" ref="com.mpobjects.oms.model.orderstatus.dao.OrderStatusDAO" />
		<property name="organizationDAO" ref="com.mpobjects.oms.dao.organization.OrganizationDAO" />
		<property name="productItemDAO" ref="com.mpobjects.oms.model.shipmentorder.dao.ProductItemDAO" />
		<property name="productItemService" ref="com.mpobjects.oms.model.productitem.service.ProductItemService" />
		<property name="returnOrderIdPostFix" value="${module.oms.shipmentorder.returnorderidpostfix}" />
		<property name="returnOrderIdPreFix" value="${module.oms.shipmentorder.returnorderidprefix}" />
		<property name="returnOrderName" value="${module.oms.shipmentorder.returnordername}" />
		<property name="returnOrderType" value="${module.oms.shipmentorder.returnordertype}" />
		<property name="shipmentItemDAO" ref="com.mpobjects.oms.model.shipmentorder.dao.ShipmentItemDAO" />
		<property name="shipmentItemIdGenerator" ref="shipmentItemIdGenerator" />
		<property name="shipmentItemService" ref="com.mpobjects.oms.model.shipmentitem.service.ShipmentItemService" />
		<property name="shipmentOrderDao" ref="com.mpobjects.oms.dao.shipmentorder.ShipmentOrderDao" />
		<property name="shipmentOrderDuplicator" ref="com.mpobjects.oms.service.ShipmentOrderDuplicator" />
		<property name="shipmentOrderPricePartDAO" ref="com.mpobjects.oms.model.shipmentorderpricepart.dao.ShipmentOrderPricePartDAO" />
		<property name="shipmentOrderPriceService" ref="com.mpobjects.oms.service.shipmentorderprice.ShipmentOrderPriceService" />
		<property name="shipmentOrderValidationService" ref="com.mpobjects.oms.model.shipmentorder.service.ShipmentOrderValidationService" />
		<property name="timeService" ref="com.mpobjects.core.model.service.TimeService" />
		<property name="triggerHandler" ref="com.mpobjects.oms.service.trigger.ShipmentOrderTriggerHandler" />
		<property name="customerStatusService" ref="com.mpobjects.oms.model.customerstatus.service.CustomerStatusService" />
		<property name="shipmentOrderCostPartService" ref="com.mpobjects.oms.service.shipmentordercostpart.ShipmentOrderCostPartService" />
	</bean>

/ Wat in vergl met oms-service.sb.xml	?
/ TODO

/ Zoek waar de spring config file wordt gepakt	,
/ TODO

/ Einde PCT-635


/ USER SCREENS

/ In user screen zien we onder in bill.to.party  10169348

/ Ga naar	,
configuration, planning, parties
/ we zien list van parties	,
/ edit 'opdrachtgever'	,
/ we krijgen list 	,
/ filter op beek	,
Opdrachtgever	PNL-CARGO	10169348	van Beek Art Sup...
/ Kies deze in user screen voor bill.to.party 

/ we maken user VanBeek	,
Name: VanBeek
Full name: Klant Van Beek Art Supplies
password: pnlc
Roles: R_KLANT
Enabled: <check>
Local Account: <check>
Member Of: NL-CARGO	PostNL Cargo
	Activatable: check
	Active: check
Save
/ Add nu property	, bill.to.party	, via een modal window	, 
/ geef dan de value	, 10169348

/ we check in db	,

pnllogistics3=# select*from tms_user where user_name like '%Beek%';
 system_id | user_id |          user_name          | user_email_address | is_enabled | is_deleted | last_login | login_attempt | is_
first_login |  last_password_update   | chargeable | grace_login | created_by | created_on | user_password | is_interface_account | 
user_reference1 | user_reference2 | local_account | time_zone 
-----------+---------+-----------------------------+--------------------+------------+------------+------------+---------------+----
------------+-------------------------+------------+-------------+------------+------------+---------------+----------------------+-
----------------+-----------------+---------------+-----------
  26849107 | VanBeek | Klant Van Beek Art Supplies |                    |          1 |          0 |            |             0 |    
          0 | 2015-09-02 12:25:12.396 |          0 |           0 |   26682479 | 2015-09-02 | pnlc          |                    0 | 
                |                 |             1 | 
(1 row)

/ we check	,

pnllogistics3=# select pv.*from properties_value pv join tms_user u on pv.user_system_id=u.system_id where user_id ='VanBeek';
 system_id | properties_system_id | property_value | user_system_id | organization_system_id 
-----------+----------------------+----------------+----------------+------------------------
  26849109 |                21954 | 10169348       |       26849107 |                       
(1 row)






/ Einde USER SCREENS

/ DEBUG USER SCREENS

/ 7	. 

/ configuration, administration, admin users 
/ wicket page ResourcePage	,
/ dit is list page van users	,
/s
ResourcePage.<init>() line: 22	
/=
package com.mpobjects.oms.view.wicket.user;
@Privilege(object = "user", type = "list")
public class ResourcePage extends BaseContextPage {
	public ResourcePage() {
->		super();
		if (myResource.hasPrivilege("user", "reset") && !myResource.hasPrivilege("user", "update")) {
/ NEE
		} else {
			add(new ResourceCrudPanel("listPanel"));
/s
ResourceCrudPanel.<init>(String) line: 68	
/=
	public ResourceCrudPanel(String aPanelId) {
		super(aPanelId, Resource.class, new BeanWrapper<ResourceDAOInterface>(ResourceDAOInterface.class), "code");
/s
ResourceCrudPanel(AbstractAjaxGenericCrudPanel).<init>(String, Class<? extends T>, BeanWrapper<BaseDAOInterface<T>>, String) line: 82	
/=
	public AbstractAjaxGenericCrudPanel(String anId, Class<? extends T> aType, BeanWrapper<? extends BaseDAOInterface<T>> aDaoWrapper, String aSortProperty) {
this	ResourceCrudPanel  (id=21122)	
anId	"listPanel" (id=21123)	
aType	Class (com.mpobjects.oms.model.user.Resource) (id=13104)	
aDaoWrapper	BeanWrapper  (id=21142)	
aSortProperty	"code" (id=21145)	
		super(anId);
		type = aType;
		sortProperty = aSortProperty;
		daoBeanWrapper = aDaoWrapper;
		dynamicPanel = getListPanel();
/s
ResourceCrudPanel.getListPanel() line: 102	
/=
	public AbstractGenericListPanel getListPanel() {
		return new ListPanel();
/s
ResourceCrudPanel$ListPanel.<init>(ResourceCrudPanel) line: 39	
/=
public class ResourceCrudPanel extends AbstractAjaxGenericCrudPanel<Resource> {
	class ListPanel extends AjaxListPanel {
		public ListPanel() {
->			super(PREFIX, "userId", "fullName", "userOrganizations", "roles", "emailAddress", "enabled", "lastLoginDate", "lastPasswordUpdate", "loginAttempt", "graceLogin", "firstLogin");
/s
ResourceCrudPanel$ListPanel(AbstractAjaxGenericCrudPanel$AjaxListPanel).<init>(AbstractAjaxGenericCrudPanel, String, String...) line: 35	
/=
public abstract class AbstractAjaxGenericCrudPanel<T extends EntityInterface> extends Panel {
	public class AjaxListPanel extends AbstractGenericListPanel {
		public AjaxListPanel(String aPrefix, String... aHeaderList) {
->			super(aPrefix, getDataProvider(), aHeaderList);
/s
ResourceCrudPanel(AbstractAjaxGenericCrudPanel).getDataProvider() line: 163	
/=
	protected TableDataProviderInterface<T> getDataProvider() {
		if (dataProvider == null) {
/ JA
			TableDataProviderBuilder<T> myBuilder = new EntityInterfaceDataProvider.Builder(getParameterList());
			dataProvider = myBuilder.build(daoBeanWrapper, sortProperty);
dataProvider	EntityInterfaceDataProvider  (id=21919)	
		}
		return dataProvider;
/t
/s
ResourceCrudPanel$ListPanel(AbstractGenericListPanel).<init>(String, TableDataProviderInterface, String...) line: 75	
this	ResourceCrudPanel$ListPanel  (id=21841)	
//////////////////////////////////////////
/ USER SEARCH PANEL
/ Onthoud: AbstractGenericListPanel	,
/ Dit is de panel waar we naar zochten	,
...
		createButton = new AjaxFallbackButton("createButton", myForm) {
			@Override
			protected void onSubmit(AjaxRequestTarget aTarget, Form<?> aForm) {
				try {
					createObject(aTarget);
				} catch (Exception e) {
					LOG.error(e.getMessage(), e);
					throw new RuntimeException("Couldn't create object", e);
				}
			}
		};
		myForm.add(createButton);

/ de createObject method is in	,
public class ResourceCrudPanel extends AbstractAjaxGenericCrudPanel<Resource> {
	class ListPanel extends AjaxListPanel {
		...
		@Override
		protected void createObject(AjaxRequestTarget aTarget) {
			Resource myResource = new Resource();
			myResource.setChargeable(true);
			Model<Resource> myModel = new Model<Resource>(myResource);
			AbstractGenericEditPanel myEditPanel = getEditPanel(myModel);
			refresh(aTarget, myEditPanel, ResourcePage.class, myModel);
		}

/ 13	. 

/ we click Create	,
/s
ResourceCrudPanel$ListPanel.createObject(AjaxRequestTarget) line: 45	
/=
public class ResourceCrudPanel extends AbstractAjaxGenericCrudPanel<Resource> {
	class ListPanel extends AjaxListPanel {
		...
		@Override
		protected void createObject(AjaxRequestTarget aTarget) {
			Resource myResource = new Resource();
			...
			Model<Resource> myModel = new Model<Resource>(myResource);
			AbstractGenericEditPanel myEditPanel = getEditPanel(myModel);
/s
ResourceCrudPanel.getEditPanel(IModel<Resource>) line: 85	
		boolean myEdit = anObject.getObject().equals(ResourceUtil.getResource());
false
/ want anObject.getObject()=new Resource()	, en ResourceUtil.getResource()=eric
		return new EditPanel(anObject.getObject(), myEdit) {
			...
/s
ResourceCrudPanel$1(EditPanel).<init>(Resource, boolean) line: 121	
/=
public class EditPanel extends UserCrudEditPanel {
	public EditPanel(Resource aResource, boolean isEdit) {
this	ResourceCrudPanel$1  (id=22524)	
		super(new Model<Resource>(aResource), isEdit);

/ Intermezzo

/ MIDDEN USER SCREEN PANEL 
/ EditPanel.html is onderkant fields	, 
/ en 2 blocks: Organizations, Member Of	,

/ we missen dus nog de bovenste fields, 	
/ en onderin de properties	,
/ en helemaal onderaan alle buttons Save, ...
/ Deze in UserCrudPanel	, die parent is van ResourceCrudPanel	,
/ 


$ vi EditPanel.html

<wicket:extend>
	<select wicket:id="roles"></select>
	<input type="text" wicket:id="loginAttempt" size="50" />
	<input type="text" wicket:id="graceLogin" size="50" />
	<span wicket:id="createdBy.code" />
	<span wicket:id="createdOn" />
	<input type="checkbox" wicket:id="enabled" />
	<input type="checkbox" wicket:id="firstLogin" />
	<input type="checkbox" wicket:id="chargeable" />
	<input type="checkbox" wicket:id="interfaceAccount" />
	<input type="checkbox" wicket:id="localAccount" />
	<tr>
		<td>
			<div class="exContainer" wicket:id="all"></div>
		</td>
		<td>
			<div class="exContainer" wicket:id="userOrganizations"></div>
		</td>
	</tr>
	<tr>
		<td>&nbsp;</td>
		<td><input type="checkbox" wicket:id="setAll" /><label wicket:for="setAll"><wicket:label key="setAll">Un/Mark all as activable</wicket:label></label></td>
	</tr>
</wicket:extend>

/ Einde Intermezzo

/ we zijn nog in	,
public class EditPanel extends UserCrudEditPanel {
	public EditPanel(Resource aResource, boolean isEdit) {
this	ResourceCrudPanel$1  (id=22524)	
		super(new Model<Resource>(aResource), isEdit);
/s
ResourceCrudPanel$1(UserCrudEditPanel).<init>(IModel<Resource>, boolean, String...) line: 181	
/=
public class UserCrudEditPanel extends AbstractGenericEditPanel<Resource> {
	public UserCrudEditPanel(IModel<Resource> aResource, boolean myEdit, String... aFieldList) {

/Intermezzo

/ BOVEN/ONDER USER EDIT SCREEN 
/ is UserCrudEditPanel	,
/ We hebben nu alles	, behalve de buttons Save, ... onderin	,

$ vi UserCrudEditPanel.html

wicket:extend>
	<input type="text" wicket:id="code" size="50"  />
	<input type="text" wicket:id="description" size="50"  />
	<input type="password" wicket:id="newPassword" size="50"  />
	<input type="password" wicket:id="confirmPassword" size="50"  />
	<input type="text" wicket:id="emailAddress" size="50" />
	<input type="text" wicket:id="userReference1" size="50" />
	<input type="text" wicket:id="userReference2" size="50" />
	<select wicket:id="activatableOrganization"></select>
	<select wicket:id="timeZone"></select>
	<wicket:child/>


<tr><td colspan="2"><h2><wicket:message key="properties.title"/></h2></td></tr>
<tr>
	<td colspan="2">
		<div wicket:id="propertySelection">
			<table class="grid">
				<thead>
					<tr class="headers">
						<th>&nbsp;</th>
						<th><wicket:message key="code">code</wicket:message></th>
						<th><wicket:message key="description">Description</wicket:message></th>
						<th><wicket:message key="value">value</wicket:message></th>
					</tr>
				</thead>
				<tbody>
					<tr wicket:id="propertiesValues">
						<td><input type="checkbox" wicket:id="selection" /></td>
						<td wicket:id="code"></td>
						<td wicket:id="description"></td>
						<td><input type="text" wicket:id="value" /></td>

					</tr>
				</tbody>
				<tfoot>
					<tr>
						<td><input type="checkbox" wicket:id="selectAllProperties" /></td>
						<td colspan="2"><label><wicket:message key="selectAllProperties">Select/deselect all properties</wicket:message> </label></td>
					</tr>
				</tfoot>
			</table>
		</div>
	</td>
</tr>
<div wicket:id="propertiesLookupWindow"></div>
</wicket:extend>


/Einde Intermezzo

/ we zijn nog in	,
public class UserCrudEditPanel extends AbstractGenericEditPanel<Resource> {
    public UserCrudEditPanel(IModel<Resource> aResource, boolean myEdit, String... aFieldList) {
		...
			initPropertiesPart();
/s
ResourceCrudPanel$1(UserCrudEditPanel).initPropertiesPart() line: 200	
/ Afmaken
/ TODO

		listPanel = dynamicPanel;
		dynamicPanel.setOutputMarkupId(true);
		add(dynamicPanel);

/ 7	. 

$ vi UserCrudPanel.class
/=
public class UserCrudEditPanel extends AbstractGenericEditPanel<Resource> {
	protected void initPropertiesPart() {
		...
		SortablePropertyModelDataProvider<PropertiesValueVO> myPropertiesProvider = new SortablePropertyModelDataProvider<PropertiesValueVO>( editForm.getModel(), "propertiesValues");
		DataView<PropertiesValueVO> myValuesView = new DataView<PropertiesValueVO>("propertiesValues", myPropertiesProvider) {
			@Override
			protected void populateItem(Item<PropertiesValueVO> anItem) {
				anItem.add(new AttributeAppender("class", true, new Model<String>(anItem.getIndex() % 2 == 0 ? "even" : "odd"), " "));

/ .populateItem wordt called in 
UserCrudEditPanel$1(RefreshingView).onPopulate() line: 98	
/ anItem is precies de property bill.to.party: 10...

/ TODO (Wanneer uit db queried?)
/ Eerder, niet tijden rendering phase	, 
/ Let op DetachableModel	, 
/ TODO






/ Einde DEBUG USER SCREENS

/ DEBUG ERROR PCT-616

/ Als we create role R_KLANT	, met privileges customerorder.list en .view		, 
org.springframework.dao.InvalidDataAccessApiUsageException: detached entity passed to persist: com.mpobjects.oms.model.privilegeentity.vo.PrivilegeVO; nested exception is org.hibernate.PersistentObjectException: detached entity passed to persist: com.mpobjects.oms.model.privilegeentity.vo.PrivilegeVO

configuration, administration, role
/= wicket page RolePage	,

/ 7	. 

/ De RolePage is niet interessant voor ons	, deze heeft de list van roles	, 
/ Zo'n role kun  je bijv edit	, door te click op de edit button	, deze submit vind je op de RolePage	,

public class RolePage extends EvoEditPage<RoleVO> {
	protected void createPage() {
		// The edit page to which we will redirect when needed
		super.createPage();
		editPage = new RoleEditFormPage(this, daoWrapper, dataProperties);

/ als we click op Edit in een row (een role), dan vallen we in z'n parent's	,
public abstract class EvoEditPage<T extends DescribedUniqueFieldValueObject> extends EvoListPage<T> implements EvoEditFormCallback {
	@Override
	protected Collection<EntityAction<T>> getListActions() {
		List<EntityAction<T>> actions = new ArrayList<EntityAction<T>>();

		// Edit the selected entity
		final IModel<String> editPageTitle = new StringResourceModel("editEntity", EvoEditPage.this, new Model<EvoEditPage<T>>(EvoEditPage.this),
				"Update ${entityName}");
		EntityActionButton<T> button = new EntityActionAjaxButton<T>("edit", new ResourceModel("edit")) {
			@Override
->			protected void onSubmit(Button aButton, AjaxRequestTarget aTarget, IModel<T> aSelection) {
/ TODO
/ See Beneden	,


/ Interessant voor ons is editPage=RoleEditFormPage inst	, de role form	

/ SCHEMA

RoleEditFormPage
/ heeft total/selected privileges: deze ziet we terug in RoleEditFormPage.html
/create actions: Save, Save and Close, Export, Cancel	,
/ deze actions gaan mee met editPanel=create RoleEditPanel	,
/ RoleEditPanel heeft een aantal fields: Role weight, ..., Grace logins	,
/ en z'n parent	, EvoEditPanel heeft Name (code) , Description	,

/ editPanel is een property van RoleEditPanel's parent EvoEditPanel	, 
/ EvoEditPanel heeft ook een method createEditPanel	, die een EvoEditPanel creates	,maar deze wordt overruled door RoleEditPanel.createEditPanel	, die een RoleEditPanel creates	,



/ Einde SCHEMA

/ 7	. 

public class RoleEditFormPage extends EvoEditFormPage<RoleVO> implements EvoEditFormCallback {

	protected Collection<EntityAction<RoleVO>> getFormActions() {
		List<EntityAction<RoleVO>> actions = new ArrayList<EntityAction<RoleVO>>();

		EntityActionButton<RoleVO> saveBtn = new EntityActionAjaxButton<RoleVO>("ok", new ResourceModel("save")) {
			@Override
->			protected void onSubmit(Button aButton, AjaxRequestTarget aTarget, IModel<RoleVO> aSelection) {
//////////////////////////////////////////
/ Als we Save click op het role form	,
		};
		actions.add(saveBtn);

		EntityActionButton<RoleVO> saveAndCloseBtn = new EntityActionAjaxButton<RoleVO>("ok", new ResourceModel("saveAndClose")) {
			@Override
			protected void onSubmit(Button aButton, AjaxRequestTarget aTarget, IModel<RoleVO> aSelection) {
		}
		actions.add(saveAndCloseBtn);

		exportButton = new EntityActionButton<RoleVO>("export", new ResourceModel("export")) {
			@Override
			protected void onSubmit(Button aButton, IModel<RoleVO> aSelection) {
		};

		actions.add(exportButton);

		EntityActionButton<RoleVO> cancelBtn = new EntityActionAjaxButton<RoleVO>("cancel", new ResourceModel("cancel")) {
			@Override
			protected Button createButton(final IModel<RoleVO> aModel, String aId) {
			@Override
			protected void onSubmit(Button aButton, AjaxRequestTarget aTarget, IModel<RoleVO> aSelection) {
		};
		cancelBtn.setDefaultFormProcessing(false);
		actions.add(cancelBtn);
	
		return acctions;
	}

	@Override
	protected void createEditPanel() {
		...
		EntityFormActionBuilder<RoleVO> panelBuilder = new EntityFormActionBuilder<RoleVO>(getFormActions());
		editPanel = new RoleEditPanel("editPanel", new WebComponentEventSwitchBoard(), panelBuilder, daoWrapper, dataProperties);

	private void initPrivilegePart() {
		DynamicList<PrivilegeVO, PrivilegeVO> myLeft = new DynamicList<PrivilegeVO, PrivilegeVO>("all", new PropertyModel(this, "availablePrivileges"), new StringResourceModel("privileges", this, null));
		DynamicList<PrivilegeVO, PrivilegeVO> myRight = new DynamicList<PrivilegeVO, PrivilegeVO>("privileges", new PropertyModel(this, "currentPrivileges"), new StringResourceModel("selected.privileges", this, null)) {
		};
		...
		addOrReplace(myLeft);
		addOrReplace(myRight);

	@Override
	public void setEditRecord(RoleVO aRecord) {
		...
		initPrivilegePart();

/ 7	.

/ Als we click: edit R_FINANCE	, dan	,

EvoEditPage$4.onSubmit(Button, AjaxRequestTarget, IModel<T>) line: 191	
	protected Collection<EntityAction<T>> getListActions() {
		List<EntityAction<T>> actions = new ArrayList<EntityAction<T>>();

		// Edit the selected entity
		...
		EntityActionButton<T> button = new EntityActionAjaxButton<T>("edit", new ResourceModel("edit")) {
			@Override
			protected void onSubmit(Button aButton, AjaxRequestTarget aTarget, IModel<T> aSelection) {
this	EvoEditPage$4  (id=20870)	
	this$0	RolePage  (id=21330)	

				EvoEditFormPage<T> page = getEditPage();
page	RoleEditFormPage  (id=20869)	
				page.setEditRecord(aSelection.getObject());
/ aSelection=
com.mpobjects.view.wicket.util.multi.GenericListElementModel@6927c093:attached=true:tempModelObject=[SystemId:26780070	Name:R_FINANCE	Description:Role for employee Finance]
/s
RoleEditFormPage.setEditRecord(RoleVO) line: 131	
/=
	public void setEditRecord(RoleVO aRecord) {
aRecord	RoleVO  (id=21303)	
		super.setEditRecord(aRecord);
/=
		editPanel.setEditRecord(aEntity);
/s
RoleEditPanel(EvoEditPanel).setEditRecord(T) line: 68	
		setObject(record);
/s
RoleEditPanel(GenericFormPanel).setObject(T) line: 242	
		form.setModelObject(object);
/t
RoleEditFormPage.setEditRecord(RoleVO) line: 131	
		super.setEditRecord(aRecord);
/d
		if (aRecord != null) {
			aRecord.setTotalPrivileges(getTotalPrivileges(aRecord.getPrivileges()));
/ alle 456	,
/s
this	RoleVO  (id=21303)	
	privileges	PersistentSet  (id=21631)	
[PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@16b2f9e4[report-cod-postnl,cod reports postnl] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@4f843faa[list,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@12af448e[customer-contract,customer-contract] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@4f843faa[list,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@3a3ec7b7[rate-agreement,Rate agreement] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@4f843faa[list,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@3a3ec7b7[rate-agreement,Rate agreement] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@861c2e4[enable,enable (wicket)],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@1bd9541b[party,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@73290606[create,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@1637931f[report,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@607cea4b[view,View a record (edit /create form in readonly mode?)],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@1bd9541b[party,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@2120bc85[update,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@2d9fb3a7[profile,The profile] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@50814841[edit,edit],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@6a58cf4d[shipment-order,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@4f843faa[list,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@1bd9541b[party,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@4f843faa[list,]]

/ Deze zien we straks inderdaad in 'Selected Privileges' op de form page	,
/ het zijn er 10	,

/ Maar in de volgende method worden ze helemaal niet used	,
/t
/s
RoleEditFormPage.getTotalPrivileges(Set<PrivilegeVO>) line: 91	
		Collection<PrivilegeVO> privilegeList = myPrivilegeDaoWrapper.getBean().getAll();
		totalPrivileges.addAll(privilegeList);
[PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@6a58cf4d[shipment-order,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@73290606[create,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@6a58cf4d[shipment-order,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@4f843faa[list,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@6a58cf4d[shipment-order,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@2120bc85[update,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@6a58cf4d[shipment-order,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@4aa3df0d[delete,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@6a58cf4d[shipment-order,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@19d891f1[track-trace,Track & Trace],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@6a58cf4d[shipment-order,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@2a658f84[cancel,Cancel action],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@6a58cf4d[shipment-order,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@3ae51a1[restore,Restore action],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@6a58cf4d[shipment-order,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@3628b727[reference8,reference8],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@6a58cf4d[shipment-order,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@27edbb3b[hold-status,hold status],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@6a58cf4d[shipment-order,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@6c91fec6[remarks,remarks],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@6a58cf4d[shipment-order,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@399eee5e[reference2,reference 2],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@6a58cf4d[shipment-order,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@231df350[inco-term,inco term],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@6a58cf4d[shipment-order,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@70bb0617[inco-reference,inco reference],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@6a58cf4d[shipment-order,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@2ce02d42[plan,Plan the order (shipment/service)],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@6a58cf4d[shipment-order,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@183f2368[split,Split the shipment order],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@6a58cf4d[shipment-order,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@9b04d87[unplan,unplan],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@6a58cf4d[shipment-order,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@4573a380[createreturn,createreturn],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@5232e5d2[service-order,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@73290606[create,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@5232e5d2[service-order,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@4f843faa[list,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@5232e5d2[service-order,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@2120bc85[update,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@5232e5d2[service-order,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@4aa3df0d[delete,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@5232e5d2[service-order,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@2579a5ca[set-started,Set objects to started/shipped],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@5232e5d2[service-order,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@3745b241[set-ended,Set objects to ended/delivered],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@5232e5d2[service-order,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@c3ac221[set-closed,Sets status to closed],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@5232e5d2[service-order,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@bef0946[recalculate,Recalculate],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@5232e5d2[service-order,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@58432b98[render,render (wicket)],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@5232e5d2[service-order,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@861c2e4[enable,enable (wicket)],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@5232e5d2[service-order,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@b8e6827[batch-release,Batch releasing],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@1bd9541b[party,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@73290606[create,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@1bd9541b[party,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@4f843faa[list,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@1bd9541b[party,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@2120bc85[update,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@1bd9541b[party,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@4aa3df0d[delete,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@39b89f5d[consignment,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@73290606[create,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@5c358e02[cost-type,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@73290606[create,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@5c358e02[cost-type,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@4f843faa[list,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@5c358e02[cost-type,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@2120bc85[update,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@5c358e02[cost-type,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@4aa3df0d[delete,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@5c358e02[cost-type,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@50814841[edit,edit],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@648ba1ee[country,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@73290606[create,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@648ba1ee[country,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@4f843faa[list,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@648ba1ee[country,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@2120bc85[update,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@648ba1ee[country,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@4aa3df0d[delete,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@648ba1ee[country,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@50814841[edit,edit],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@706a57fe[currency,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@73290606[create,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@706a57fe[currency,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@4f843faa[list,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@706a57fe[currency,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@2120bc85[update,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@706a57fe[currency,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@4aa3df0d[delete,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@706a57fe[currency,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@58432b98[render,render (wicket)],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@706a57fe[currency,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@861c2e4[enable,enable (wicket)],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@706a57fe[currency,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@50814841[edit,edit],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@1451190b[inco-term,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@4f843faa[list,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@1451190b[inco-term,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@2120bc85[update,],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@1451190b[inco-term,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@607cea4b[view,View a record (edit /create form in readonly mode?)],
PrivilegeVO: com.mpobjects.oms.model.entity.businessobject.BusinessObject@1451190b[inco-term,] - com.mpobjects.oms.model.entity.privilegetype.PrivilegeType@58432b98[render,render (wicket)], ...

		return totalPrivileges;
/ alle 456	,
/t
RoleEditFormPage.setEditRecord(RoleVO) line: 133	
			aRecord.setTotalPrivileges(getTotalPrivileges(aRecord.getPrivileges()));
/ alle 456	,
/d
			aRecord.removeTotalPrivileges(aRecord.getPrivileges());
/ 446=456-10	,
/s
		totalPrivileges.removeAll(aPrivileges);
/t
			setCurrentPrivileges(aRecord.getPrivileges());
/s
		currentPrivileges = aList;
/ 10 
/t
			setAvailablePrivileges(aRecord.getPrivileges());
/s
		Collection<PrivilegeVO> myAllOrganizations = organizationDAO.getBean().getAll();
		myAllOrganizations.removeAll(aPrivileges);
/ Deden we hierboven ook 	,
		availablePrivileges = myAllOrganizations;
/ 446	, 

/ Dus currert priv's zijn er nu 10	, available=alle - current=456-10=446	,

/t
RoleEditFormPage.setEditRecord(RoleVO) line: 138	
			setAvailablePrivileges(aRecord.getPrivileges());
/d
		initPrivilegePart();
/s
RoleEditFormPage.initPrivilegePart() line: 332	
		DynamicList<PrivilegeVO, PrivilegeVO> myLeft = new DynamicList<PrivilegeVO, PrivilegeVO>("all", new PropertyModel(this, "availablePrivileges"), new StringResourceModel("privileges", this, null));

		DynamicList<PrivilegeVO, PrivilegeVO> myRight = new DynamicList<PrivilegeVO, PrivilegeVO>("privileges", new PropertyModel(this, "currentPrivileges"),
				new StringResourceModel("selected.privileges", this, null)) {

/ dus links: avaibable priv's = 456-10=446	,
/ dus rechts: current priv's =  10	,

/ Intermezzo
public class DynamicList<S extends EntityInterface & Comparable, T extends EntityInterface & Comparable> extends FormComponentPanel {
...
/ Einde Intermezzo

this	RoleEditFormPage  (id=20869)	
		myRight.setTargetList(myLeft);
		myLeft.setTargetList(myRight);
		addOrReplace(myLeft);
		addOrReplace(myRight);

/ 7	. 

/ we click create op de RolePage	, 

EvoEditPage$3.onSubmit(AjaxRequestTarget, Form<?>) line: 134	
/=
public abstract class EvoEditPage<T extends DescribedUniqueFieldValueObject> extends EvoListPage<T> implements EvoEditFormCallback {
	protected void createCreateButton() {
		// A simple form for the create button
		Form<T> createForm = new Form<T>("createForm");
		add(createForm);

		createButton = new AjaxFallbackButton("createButton", createForm) {
			@Override
			protected void onSubmit(AjaxRequestTarget aTarget, Form<?> aForm) {
				EvoEditFormPage<T> page = getEditPage();
page	RoleEditFormPage  (id=22203)	
				page.setEditRecord(daoWrapper.getBean().createNewObject());
/s
GenericHibernateDAO.class
	@Override
	public Type createNewObject() {
			return type.newInstance();
/t
/s
RoleEditFormPage.setEditRecord(RoleVO) line: 131	
/=
	public void setEditRecord(RoleVO aRecord) {
SystemId:0	Name:	Description:
		super.setEditRecord(aRecord);
/ sets form in RoleEditPanel's model=deze (mew new created) RoleVO
		if (aRecord != null) {
			aRecord.setTotalPrivileges(getTotalPrivileges(aRecord.getPrivileges()));
456
			aRecord.removeTotalPrivileges(aRecord.getPrivileges());
456
			setCurrentPrivileges(aRecord.getPrivileges());
0
			setAvailablePrivileges(aRecord.getPrivileges());
0
		initPrivilegePart();

/ Geef continue	,

/ 7		.

Name: R_KLANT
Charge type: FULL
Privileges: customerorder.list
Privileges: customerorder.view
Save
/s
RoleEditFormPage$2.onSubmit(Button, AjaxRequestTarget, IModel<RoleVO>) line: 208	
/=
public class RoleEditFormPage extends EvoEditFormPage<RoleVO> implements EvoEditFormCallback {
	protected Collection<EntityAction<RoleVO>> getFormActions() {
		List<EntityAction<RoleVO>> actions = new ArrayList<EntityAction<RoleVO>>();
		EntityActionButton<RoleVO> saveBtn = new EntityActionAjaxButton<RoleVO>("ok", new ResourceModel("save")) {
			@Override
			protected void onSubmit(Button aButton, AjaxRequestTarget aTarget, IModel<RoleVO> aSelection) {

				if (((RoleEditPanel) editPanel).isValidObject(aSelection.getObject())) {
/s
RoleEditPanel.isValidObject(RoleVO) line: 44	
		BeanWrapper<RoleDAO> myRoleDaoWrapper = new BeanWrapper<RoleDAO>(RoleDAO.class);
		return !myRoleDaoWrapper.getBean().checkRoleExist(aRole);
/s
RoleDAOImpl.checkRoleExist(RoleVO) line: 33	
		args.put("code", aRole.getCode());
{code=R_KLANT}
		Collection<RoleVO> roleCollection = findEqualsWithQueryMap(args);
/s
RoleDAOImpl(GenericHibernateDAO).findEqualsWithQueryMap(Map<String,Object>) line: 238	
/=
	public Collection<Type> findEqualsWithQueryMap(Map<String, Object> aCriteriaQueryMap) {
this	RoleDAOImpl  (id=19988)	
	type	Class (com.mpobjects.oms.model.entity.role.RoleVO) (id=17128)	
aCriteriaQueryMap	HashMap  (id=22797)	
{code=R_KLANT}

		DetachedCriteria myDetachedCriteria = DetachedCriteria.forClass(type);

		for (String myAttribute : aCriteriaQueryMap.keySet()) {
			myDetachedCriteria.add(Property.forName(myAttribute).eq(aCriteriaQueryMap.get(myAttribute)));
		}
...
/t
RoleDAOImpl.checkRoleExist(RoleVO) line: 39	
		Collection<RoleVO> roleCollection = findEqualsWithQueryMap(args);
/d


/t
RoleEditFormPage$2.onSubmit(Button, AjaxRequestTarget, IModel<RoleVO>) line: 218	
				if (((RoleEditPanel) editPanel).isValidObject(aSelection.getObject())) {
/d
					try {
						getSession().clear();
						daoWrapper.getBean().save(aSelection.getObject());
/ als we geen privileges	, we zien in postgres log	,
insert into TMS_ROLE (NAME, DESCRIPTION, ROLE_WEIGHT, CHARGE_TYPE, IS_DELETED, ACCOUNT_EXP, PASSWORD_EXP, SESSION_TIMEOUT, GRACE_LOGINS, SYSTEM_ID) values ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)
 535626 DETAIL:  parameters: $1 = 'R_KLANT', $2 = NULL, $3 = '0', $4 = 'FULL', $5 = 'f', $6 = NULL, $7 = NULL, $8 = '0', $9 = '-1',$10 = '26849104'

/ 13	.

/ we willen deze weer delete	, 
/ op RolePage	, we click delete-button	,
/s
public class RolePage extends EvoEditPage<RoleVO> {
		// Delete the selected entity
		button = new EntityActionAjaxButton<RoleVO>("delete", new ResourceModel("delete")) {
			@Override
			protected void onSubmit(Button aButton, AjaxRequestTarget aTarget, IModel<RoleVO> aSelection) {
				RoleVO selection = aSelection.getObject();
					daoWrapper.getBean().delete(selection);
/ TODO

/ 13	. 

/ als we een deleted type weer willen create	, krijgen we een ERR bij Name (code)	, 

$ vi GenericFormPanel.java
	protected void createPanel(CompoundPropertyModel<T> model) {
		form = new GenericForm<T>("genericForm", model);
		add(form);
		...
		setForm(form);

$ vi EvoEditPanel.java
	protected void setForm(GenericForm<T> aform) {
		UniqueCodeValidator<T> codeValidator = new UniqueCodeValidator<T>(getEvoBeanWrapper(), aform.getModel());

$ vi UniqueCodeValidator.java
	public void validate(IValidatable<String> aValidatable) {
->		String enteredCode = aValidatable.getValue();
R_KLANT

this	UniqueCodeValidator  (id=23337)	
	existingModel	CompoundPropertyModel  (id=23458)	
		target	EntityDetachableModel  (id=23460)	
			dao	BeanWrapper  (id=23462)	
			entity	RoleVO  (id=23465)	
SystemId:0	Name:	Description:
/ TODO
			systemId	0	

		if (existingModel != null && existingModel.getObject() != null) {
			curSysId = existingModel.getObject().getSystemId();
0
		EnumeratedValueObjectDAOInterface<T> dao = daoWrapper.getBean();
		// Check deleted as well
		for (T myEntity : dao.findByCode(enteredCode, true)) {
SystemId:26849104	Name:R_KLANT	Description:null
			if (curSysId != 0) {
/ NEE
				if (myEntity.getSystemId() == curSysId) {
/ NIET
					// must be disassociated from the session, otherwise it collides with saving
					dao.detach(myEntity);
/ NIET
					continue;
/ NIET
/ TODO
			// code exists in different object; raise error
			if (SoftDeletable.class.isAssignableFrom(daoWrapper.getBean().getType()) && ((SoftDeletable) myEntity).isDeleted()) {
/ JA
				error.addMessageKey("evocode.deleted.not.unique");
				error.setMessage("A deleted object with code '" + enteredCode + "' already exists.");

/ 13	. 

/ rm R_KLANT uit de tms_user tabel	,

$ vi RoleDAOImpl.class
		List<RoleVO> myRoleList = getHibernateTemplate().findByCriteria(
				DetachedCriteria.forClass(RoleVO.class).add(Property.forName("name").eq(aServiceOrderCode)));

/ H. uses it's cache,	 en ondanks dat we R_KLANT hebben rm, zit hj nog in de cache	, 

/ we moeten 'reload config'	, dan si myRoleList leeg	, 

/ 13	. 

Name: R_KLANT
Charge type: FULL
Privileges: customerorder.list
Privileges: customerorder.view
Save
/s
RoleEditFormPage$2.onSubmit(Button, AjaxRequestTarget, IModel<RoleVO>) line: 211	
/=
			protected void onSubmit(Button aButton, AjaxRequestTarget aTarget, IModel<RoleVO> aSelection) {
				if (((RoleEditPanel) editPanel).isValidObject(aSelection.getObject())) {
					try {
						getSession().clear();
						daoWrapper.getBean().save(aSelection.getObject());
this	RoleEditFormPage$2  (id=23865)	
aSelection	CompoundPropertyModel  (id=23873)	
	target	EntityDetachableModel  (id=23905)	
		entity	RoleVO  (id=23907)	
			privileges	HashSet  (id=23881)	
				map	HashMap  (id=23930)	
					size	2	
					table	HashMap$Entry[16]  (id=23935)	
						[8]	HashMap$Entry  (id=23942)	
							key	PrivilegeVO  (id=23945)	
								businessObject	BusinessObject  (id=23999)	
									code	"customerorder" (id=24094)	
									systemId	25825393	
								privilegeType	PrivilegeType  (id=24008)	
									code	"view" (id=24096)	
									systemId	9	
								systemId	25825394	
						[14]	HashMap$Entry  (id=23943)	
							key	PrivilegeVO  (id=23949)	
								businessObject	BusinessObject  (id=23999)	
									code	"customerorder" (id=24094)	
									systemId	25825393	
								privilegeType	PrivilegeType  (id=24004)	
									code	"list" (id=24098)	
									systemId	2	
								systemId	26849099	
			systemId	0									/ entity
		systemId	0										/ target



org.springframework.dao.InvalidDataAccessApiUsageException: detached entity passed to persist: com.mpobjects.oms.model.privilegeentity.vo.PrivilegeVO; nested exception is org.hibernate.PersistentObjectException: detached entity passed to persist: com.mpobjects.oms.model.privilegeentity.vo.PrivilegeVO 

/ 7	. 

$ vi Role.standard.hbm.xml

	<class name="com.mpobjects.oms.model.entity.role.RoleVO" table="TMS_ROLE" lazy="false">
		<set name="privileges" inverse="false" table="ROLE_PRIVILEGE" lazy="false" cascade="all">
			<cache usage="read-write" />
			<key>
				<column name="ROLE_SYSTEMID" not-null="true" />
			</key>
			<many-to-many entity-name="com.mpobjects.oms.model.privilegeentity.vo.PrivilegeVO">
				<column name="PRIVILEGE_SYSTEMID" not-null="true" />
			</many-to-many>
		</set>

/ 7	. 

/ we hebben een R_MY create	, maar willen hem ook weer delete	, 
/ als we delelte , is hij marked als deleted	, 
/ we moeten de rows in tms_role en rol_privileges zelf verwijderen met psql	,

pnllogistics3=#  delete from role_privilege rp where rp.role_systemid=(select system_id from tms_role where name='R_MY');
DELETE 2
pnllogistics3=# delete from tms_role where name='R_MY';
DELETE 1
/ Doe reload config	,

/ 7	. 

/ we zijn in 
RoleEditFormPage.updatePrivileges(RoleVO) line: 287	

/ geef in Expressios.
selectedPrivilegeDaoWrapper.getBean().getCurrentSession()
	persistenceContext	StatefulPersistenceContext  (id=19323)	
		entityEntries	IdentityMap  (id=19335)	
			map	LinkedHashMap  (id=19346)	
				accessOrder	false	
				entrySet	HashMap$EntrySet  (id=19348)	
				hashSeed	0	
				header	LinkedHashMap$Entry  (id=19349)	
				keySet	null	
				loadFactor	0.75	
				modCount	755	
				size	0	
				table	HashMap$Entry[1024]  (id=19351)	
				threshold	768	
				values	HashMap$Values  (id=19353)	


		for (PrivilegeVO myPrivilegeVO : myCurrent) {
			mySet.add(selectedPrivilegeDaoWrapper.getBean().getBySystemId(myPrivilegeVO.getSystemId()));

/ we zien nu size 3	,
/ we zien 
/ PrivligeVO 	
systemId	25825394	
/ BusinessObject 
systemId	25825393	
/ PrivilegeType	,
code	"view" (id=19539)	
systemId	9	

/ volgende	,
		for (PrivilegeVO myPrivilegeVO : myCurrent) {
			mySet.add(selectedPrivilegeDaoWrapper.getBean().getBySystemId(myPrivilegeVO.getSystemId()));


/ we zien nu size 5	,
/ PrivligeVO 	
systemId	26849099
/ PrivilegeType	,
code	"view" (id=19539)	
systemId	2	

/ 7	. 

/ bean wrapper	,

/s
RoleEditFormPage.createEditPanel() line: 169	
		if (selectedPrivilegeDaoWrapper == null) {
			selectedPrivilegeDaoWrapper = new BeanWrapper<PrivilegeDAO>(PrivilegeDAO.class);
/ Dit is haast NIETS	,

/ We click 'create role'	,
...
/s
RoleEditFormPage.updatePrivileges(RoleVO) line: 287	
			mySet.add(selectedPrivilegeDaoWrapper.getBean().getBySystemId(myPrivilegeVO.getSystemId()));
/s
BeanWrapper.getBean() line: 40	
/ is er al	, 

/ we beginnen daarom opnieuw	,
configuration, administration, role
...
/s
BeanWrapper.getBean() line: 40	
this=com.mpobjects.view.wicket.util.BeanWrapper@3ce8e39b[type=interface com.mpobjects.oms.model.role.dao.RoleDAO,beanName=<null>]
		if (bean == null) {
			if (beanName == null) {
				bean = MpoBeanFactory.getBean(type);
/ De gewone spring context. getBean	,
/ want	,
/s
MpoBeanFactory.getBean(Class<T>) line: 55	
		return getBean(aClass.getName(), aClass);
/s
MpoBeanFactory.getBean(String, Class<T>) line: 79	
		return aClass.cast(getBeanFactory().getBean(aBeanName, aClass));
aBeanName	"com.mpobjects.oms.model.role.dao.RoleDAO" (id=20455)	
		return getBeanFactoryWithoutGuard();
/s
MpoBeanFactory.getBeanFactoryWithoutGuard() line: 157	
		return applicationContext;
applicationContext	org.springframework.web.context.support.XmlWebApplicationContext  (id=20437)	

/ net zo voor	,
this	BeanWrapper  (id=20522)	
	type	Class (com.mpobjects.oms.model.privilegeentity.dao.PrivilegeDAO) (id=15684)	

/ 7	. 

		for (PrivilegeVO myPrivilegeVO : myCurrent) {
			// mySet.add(selectedPrivilegeDaoWrapper.getBean().getBySystemId(myPrivilegeVO.getSystemId()));
/ OK, van Paul
			// selectedPrivilegeDaoWrapper.getBean().getCurrentSession().merge(myPrivilegeVO);
/ ERR
/ We zien de privileges wel in de H pc	, maar worden toch niet door .persist	, 
			selectedPrivilegeDaoWrapper.getBean().getCurrentSession().update(myPrivilegeVO);
/ ERR
/ We zien de privileges NIET in de H pc	, en worden dus ook niet door .persist	, 
		}

pnllogistics3=#  delete from role_privilege rp where rp.role_systemid=(select system_id from tms_role where name='R_MY');
DELETE 2
pnllogistics3=# delete from tms_role where name='R_MY';
DELETE

/ 7	. 

$ vi BeanWrapper.java

	// spring beans must not be serialized, ever!
	private transient T bean;

/ Dit is WH de reden van deze wrapper	, dat ze niet in de wicket ser komen	,

/ 7	.

$ vi RoleEditFormPage.java 

	protected void updatePrivileges(RoleVO aRole) {
		for (PrivilegeVO myPrivilegeVO : myCurrent) {
			// mySet.add(selectedPrivilegeDaoWrapper.getBean().getBySystemId(myPrivilegeVO.getSystemId()));
/ OK
			selectedPrivilegeDaoWrapper.getBean().getCurrentSession().merge(myPrivilegeVO);
/ PROBEER	,
/s
PrivilegeDAOImpl(BaseHibernateDAO).getCurrentSession() line: 49	
/=
@Transactional
public abstract class BaseHibernateDAO<T> extends HibernateDaoSupport {
	public Session getCurrentSession() {
		return getHibernateTemplate().getSessionFactory().getCurrentSession();
/s
PrivilegeDAOImpl(HibernateDaoSupport).getHibernateTemplate() line: 117	
	  return this.hibernateTemplate;




/ Intermezzo

$ vi /base-framework/core/src/java/core-base.sb.xml

   <bean id="HibernateDAOTemplate" abstract="true">
        <property name="sessionFactory" ref="sessionFactory" />
        <property name="performanceMonitorService" ref="com.mpobjects.core.performance.PerformanceMonitorService" />
        <property name="oldEntityStateCache" ref="com.mpobjects.util.dao.OldEntityStateCache" />
    </bean>

$ vi ./module/oms/src/java/oms-dao.sb.xml

    <bean id="com.mpobjects.oms.model.privilegeentity.dao.PrivilegeDAO" parent="transactionRequiredTemplate">
        <property name="target">
            <bean class="com.mpobjects.oms.model.privilegeentity.dao.PrivilegeDAOImpl" parent="HibernateDAOTemplate" />
        </property>
    </bean>

/ Einde Intermezzo




/ Einde DEBUG ERROR PCT-616

/ JREBEL

/ right click project trunk	,
	roperties
		JRebel
/ click Generate now!

/ we zien file verschijnen	, 
./base-framework/build/generate/java/rebel.xml

/ rebuild (Ant) & start	,

/ we hadden een oude module in project, properties build path staan	, Deze moeten we rm (see Problems)	,
/ Nu werkt JRebel OK	,

/ Als we willen debug, na een verandering, en als jrebel runs, dan moeten we b niet op de method set, maar op de code line	, 
anders duurt het te lang voor dat de method is gevonden (omdat de class is veranderd)	, er zit ook veel voor de call	(TODO)	,





/ Einde JREBEL



